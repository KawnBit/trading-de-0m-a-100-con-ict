<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Curso avanzado sobre Estructura del Precio y Smart Money Concepts. Aprende la arquitectura invisible del mercado.">
    <title>KawnBit | Capítulo 3: Estructura del Precio</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Librerías Externas (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Configuración Tailwind KawnBit -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kawn: {
                            light: '#ccfbf1', // Teal 100
                            base: '#14b8a6',  // Teal 500
                            dark: '#0f766e',  // Teal 700
                            deep: '#134e4a',  // Teal 900
                        },
                        slate: {
                            50: '#f8fafc',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                    },
                    boxShadow: {
                        'glow': '0 0 15px rgba(20, 184, 166, 0.3)',
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos Base */
        body {
            background-color: #f8fafc;
            color: #334155;
            font-family: 'Inter', sans-serif;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #14b8a6; 
        }

        /* Logo KawnBit CSS Puro */
        .kawn-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #14b8a6 0%, #0f766e 100%);
            border-radius: 8px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(20, 184, 166, 0.4);
            flex-shrink: 0;
        }
        .kawn-logo-icon::after {
            content: 'K';
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 24px;
        }

        /* TOC Activo */
        .toc-link.active {
            color: #14b8a6;
            border-left: 3px solid #14b8a6;
            background-color: #ccfbf1;
            padding-left: 0.75rem;
        }
        .toc-link {
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        /* Barra de Progreso */
        #reading-progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 4px;
            background: #14b8a6;
            z-index: 100;
            width: 0%;
            transition: width 0.1s ease-out;
        }

        /* Animaciones */
        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
            opacity: 0;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Chat Bot */
        .chat-message {
            max-width: 85%;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .user-message {
            background-color: #14b8a6;
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        .ai-message {
            background-color: #e2e8f0;
            color: #0f172a;
            align-self: flex-start;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }
        
        /* Quiz */
        .quiz-option {
            cursor: pointer;
            transition: all 0.2s;
        }
        .quiz-option:hover:not(.disabled) {
            background-color: #f1f5f9;
        }
        .quiz-option.selected {
            border-color: #14b8a6;
            background-color: #ccfbf1;
        }
        .quiz-option.correct {
            border-color: #10b981;
            background-color: #d1fae5;
        }
        .quiz-option.incorrect {
            border-color: #ef4444;
            background-color: #fee2e2;
        }

        /* Candle Reader Styles */
        .candle-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .candle-card:hover {
            transform: translateY(-4px);
        }

        /* Markdown Styles within AI responses */
        .markdown-prose ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }
        .markdown-prose ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }
        .markdown-prose p {
            margin-bottom: 0.8em;
        }
        .markdown-prose strong {
            color: #0f766e;
        }
        
        /* Estado deshabilitado para botones */
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        /* Error State for Charts */
        .chart-error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background-color: #fee2e2;
            color: #b91c1c;
            font-size: 0.875rem;
            text-align: center;
            padding: 1rem;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="antialiased text-slate-600">

    <!-- Barra de Progreso -->
    <div id="reading-progress-bar"></div>

    <!-- Navbar Sticky -->
    <nav class="sticky top-0 z-50 w-full bg-white/90 backdrop-blur-md border-b border-slate-200 shadow-sm transition-all duration-300" id="navbar">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo -->
                <div class="flex items-center gap-3">
                    <div class="kawn-logo-icon"></div>
                    <div class="flex flex-col">
                        <span class="text-2xl font-black text-slate-900 tracking-tight leading-none">KAWNBIT</span>
                        <span class="text-[0.6rem] font-bold text-kawn-base uppercase tracking-[0.2em] leading-none mt-1">Quantitative Trading Community</span>
                    </div>
                </div>
                
                <!-- Mobile Menu Button -->
                <button id="mobile-menu-btn" aria-label="Abrir menú" class="md:hidden p-2 rounded-md text-slate-600 hover:text-kawn-base focus:outline-none">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>

                <!-- Desktop Nav -->
                <div class="hidden md:flex space-x-8">
                    <a href="#" class="text-kawn-base font-semibold border-b-2 border-kawn-base pb-1">Capítulo 3</a>
                    <a href="#analizador-ia" class="text-slate-500 hover:text-kawn-base font-medium transition-colors">Analizador IA ✨</a>
                    <a href="#plan-trading" class="text-slate-500 hover:text-kawn-base font-medium transition-colors">Plan IA ✨</a>
                    <a href="#evaluacion" class="text-slate-500 hover:text-kawn-base font-medium transition-colors">Test Final</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Layout Principal -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <div class="flex flex-col md:flex-row gap-12">

            <!-- Sidebar TOC (Sticky) -->
            <aside id="sidebar-toc" class="hidden md:block w-64 flex-shrink-0">
                <div class="sticky top-24">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Tabla de Contenidos</h3>
                    <nav id="toc-container" class="flex flex-col space-y-2 text-sm max-h-[calc(100vh-150px)] overflow-y-auto pr-2 custom-scrollbar">
                        <!-- Generado dinámicamente -->
                    </nav>
                </div>
            </aside>

            <!-- Contenido Principal -->
            <main class="flex-1 max-w-4xl min-w-0">
                
                <!-- Hero Section -->
                <section class="mb-16 fade-in">
                    <span class="inline-block py-1 px-3 rounded-full bg-kawn-light text-kawn-dark text-xs font-bold uppercase tracking-wider mb-4">Capítulo 3</span>
                    <h1 class="text-4xl md:text-5xl font-black text-slate-900 mb-6 leading-tight">
                        Estructura del <span class="text-kawn-base">Precio</span>
                    </h1>
                    <p class="text-xl text-slate-500 leading-relaxed font-light">
                        Descifra la arquitectura invisible del mercado y aprende a distinguir entre movimientos de ruido y verdaderos cambios de tendencia institucional.
                    </p>
                </section>

                <!-- Introducción -->
                <section id="intro-arquitectura" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="layers" class="text-kawn-base mr-3"></i> Introducción: La arquitectura invisible
                    </h2>
                    
                    <p class="mb-4 leading-7 text-lg">
                        Imagina por un momento que el precio en los mercados financieros es como el agua fluyendo por un río. A simple vista, puede parecer caótico y aleatorio, pero si observas con detenimiento descubrirás que sigue patrones predecibles, creando corrientes, remolinos y cambios de dirección que responden a una lógica profunda. La <strong>estructura del precio</strong> es precisamente esa lógica subyacente, el esqueleto invisible que sostiene todos los movimientos del mercado.
                    </p>

                    <div class="bg-white rounded-xl shadow-lg border-l-4 border-kawn-base p-6 mb-8">
                        <h3 class="font-bold text-lg text-slate-900 mb-2">Concepto Clave ICT/SMC</h3>
                        <p class="text-slate-600 italic">
                            "El precio solo hace dos cosas en su comportamiento: <strong>rebalancea</strong> (corrige desequilibrios previos) o <strong>busca liquidez</strong>."
                        </p>
                    </div>

                    <p class="mb-4 leading-7">
                        Para un trader principiante o intermedio, dominar la estructura del precio representa un salto cualitativo enorme. Es la diferencia entre operar basándose solo en indicadores superficiales y comprender verdaderamente por qué el precio se mueve como lo hace.
                    </p>
                </section>

                <!-- Fractalidad -->
                <section id="naturaleza-fractal" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="zoom-in" class="text-kawn-base mr-3"></i> La naturaleza fractal del precio
                    </h2>
                    
                    <p class="mb-6 leading-7">
                        Antes de sumergirnos en tendencias y patrones, es crucial entender que el precio se comporta de manera fractal. Esto significa que los mismos patrones que observas en un gráfico de 5 minutos se replican en gráficos horarios, diarios, semanales e incluso mensuales.
                    </p>

                    <!-- COMPONENTE INTERACTIVO 1: VISUALIZADOR DE FRACTALIDAD -->
                    <div class="bg-slate-900 rounded-xl p-6 shadow-2xl mb-8 border border-slate-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-white font-bold text-lg flex items-center gap-2">
                                <i data-lucide="microscope" class="text-kawn-base"></i> Microscopio Fractal
                            </h3>
                            <button id="toggleFractalBtn" class="bg-kawn-base hover:bg-kawn-dark text-white text-xs px-3 py-1 rounded transition">
                                Hacer Zoom (Diario → 1H)
                            </button>
                        </div>
                        <p class="text-slate-400 text-sm mb-4">
                            Observa cómo una sola vela alcista diaria contiene toda una estructura de tendencia en una temporalidad menor.
                        </p>
                        <div class="relative h-64 w-full bg-slate-800 rounded-lg overflow-hidden" id="fractal-container">
                            <canvas id="fractalChart"></canvas>
                        </div>
                        <div id="fractal-desc" class="mt-3 text-xs text-kawn-light font-mono">
                            Vista: Gráfico Diario (Una sola vela de expansión)
                        </div>
                    </div>
                </section>

                <!-- Tendencias -->
                <section id="tendencias" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="trending-up" class="text-kawn-base mr-3"></i> Tendencias alcistas y bajistas
                    </h2>

                    <div class="grid md:grid-cols-2 gap-6 mb-8">
                        <!-- Alcista -->
                        <div class="bg-white p-6 rounded-xl shadow-md border border-slate-100 hover:border-kawn-light transition">
                            <h3 class="font-bold text-lg text-slate-900 mb-3 text-center border-b pb-2">Tendencia alcista</h3>
                            <p class="text-sm text-slate-600 mb-4">
                                Una escalera ascendente. Se caracteriza por <strong>máximos cada vez más altos (HH)</strong> y <strong>mínimos cada vez más altos (HL)</strong>.
                            </p>
                            <div class="bg-slate-50 p-3 rounded text-xs text-slate-500 italic">
                                "Los escaladores avanzan hasta un nuevo pico, luego retroceden a un campamento base más alto que el anterior."
                            </div>
                        </div>
                        
                        <!-- Bajista -->
                        <div class="bg-white p-6 rounded-xl shadow-md border border-slate-100 hover:border-red-100 transition">
                            <h3 class="font-bold text-lg text-slate-900 mb-3 text-center border-b pb-2">Tendencia bajista</h3>
                            <p class="text-sm text-slate-600 mb-4">
                                Una escalera descendente. Se caracteriza por <strong>máximos decrecientes (LH)</strong> y <strong>mínimos decrecientes (LL)</strong>.
                            </p>
                            <div class="bg-slate-50 p-3 rounded text-xs text-slate-500 italic">
                                "Como avalanchas controladas. El miedo impulsa ventas más rápidas y violentas que las compras."
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Cambio de Estructura -->
                <section id="cambio-estructura" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="git-pull-request" class="text-kawn-base mr-3"></i> El cambio de estructura
                    </h2>
                    
                    <p class="mb-6 leading-7">
                        Este es el punto de inflexión donde el poder cambia de manos. Un cambio de estructura verdadero requiere tres elementos fundamentales que deben ocurrir en secuencia:
                    </p>

                    <div class="space-y-4 mb-8">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-kawn-base text-white flex items-center justify-center font-bold mr-4">1</div>
                            <div>
                                <h4 class="font-bold text-slate-900">Violación clara del patrón previo</h4>
                                <p class="text-sm text-slate-600">En una tendencia alcista, el precio rompe por debajo del último mínimo significativo (HL), invalidando la "escalera".</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-kawn-base text-white flex items-center justify-center font-bold mr-4">2</div>
                            <div>
                                <h4 class="font-bold text-slate-900">Intención del mercado</h4>
                                <p class="text-sm text-slate-600">No basta con perforar. Debe haber <strong>cuerpo de vela</strong> cerrando más allá, alto volumen y velocidad (Desplazamiento).</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-kawn-base text-white flex items-center justify-center font-bold mr-4">3</div>
                            <div>
                                <h4 class="font-bold text-slate-900">Confirmación estructural</h4>
                                <p class="text-sm text-slate-600">Tras la ruptura, el precio hace un retroceso (pullback) que respeta el nivel roto como resistencia y continúa cayendo.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Perforación vs Desplazamiento & Candle Reader -->
                <section id="analizador-velas" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="alert-triangle" class="text-kawn-base mr-3"></i> Perforación vs. Desplazamiento
                    </h2>
                    
                    <p class="mb-4 leading-7">
                        El precio a menudo rompe niveles solo para cazar liquidez (Stops) y revertir. A esto le llamamos "perforación". El "desplazamiento", en cambio, muestra cuerpos sólidos y continuación.
                    </p>

                    <!-- COMPONENTE INTERACTIVO NUEVO: CANDLE READER -->
                    <div class="bg-slate-100 rounded-xl p-6 border border-slate-200 mb-10">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center">
                            <i data-lucide="eye" class="w-5 h-5 mr-2 text-kawn-base"></i> Analizador de Velas Institucional
                        </h3>
                        <p class="text-sm text-slate-500 mb-6">Haz clic en la vela que muestra una verdadera <strong>INTENCIÓN DE RUPTURA</strong> (Desplazamiento) para un movimiento alcista.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="candle-reader-container">
                            <!-- Vela A: Mecha larga (Rechazo/Liquidez) -->
                            <div class="candle-card bg-white p-4 rounded-lg shadow cursor-pointer text-center group" data-candle="A">
                                <div class="h-32 relative mx-auto w-12 flex flex-col items-center justify-end pointer-events-none">
                                    <div class="w-1 h-full bg-slate-800 absolute top-0 left-1/2 -translate-x-1/2"></div> <!-- Mecha -->
                                    <div class="w-6 h-8 bg-green-500 z-10 relative border border-green-600 mb-2"></div> <!-- Cuerpo pequeño abajo -->
                                </div>
                                <span class="block mt-4 font-bold text-slate-400 group-hover:text-kawn-base">Vela A</span>
                            </div>

                            <!-- Vela B: Cuerpo sólido (Desplazamiento) -->
                            <div class="candle-card bg-white p-4 rounded-lg shadow cursor-pointer text-center group" data-candle="B">
                                <div class="h-32 relative mx-auto w-12 flex flex-col items-center justify-center pointer-events-none">
                                    <div class="w-1 h-full bg-slate-800 absolute top-0 left-1/2 -translate-x-1/2"></div> <!-- Mecha pequeña -->
                                    <div class="w-6 h-24 bg-green-500 z-10 relative border border-green-600"></div> <!-- Cuerpo grande -->
                                </div>
                                <span class="block mt-4 font-bold text-slate-400 group-hover:text-kawn-base">Vela B</span>
                            </div>

                            <!-- Vela C: Indecisión (Doji) -->
                            <div class="candle-card bg-white p-4 rounded-lg shadow cursor-pointer text-center group" data-candle="C">
                                <div class="h-32 relative mx-auto w-12 flex flex-col items-center justify-center pointer-events-none">
                                    <div class="w-1 h-full bg-slate-800 absolute top-0 left-1/2 -translate-x-1/2"></div> <!-- Mecha -->
                                    <div class="w-6 h-2 bg-green-500 z-10 relative border border-green-600"></div> <!-- Cuerpo mínimo -->
                                </div>
                                <span class="block mt-4 font-bold text-slate-400 group-hover:text-kawn-base">Vela C</span>
                            </div>
                        </div>
                        <div id="candle-feedback" class="mt-4 hidden p-3 rounded-lg text-sm text-center font-medium"></div>
                    </div>

                    <!-- COMPONENTE: LABORATORIO DE RUPTURAS (Plotly) -->
                    <div id="simulador" class="bg-white p-6 rounded-xl shadow-lg border border-slate-200 mb-8">
                        <div class="flex justify-between items-center mb-4 border-b pb-4">
                            <div>
                                <h3 class="font-bold text-slate-900 text-lg">Laboratorio de Rupturas</h3>
                                <p class="text-xs text-slate-500">¿Es un cambio real (Desplazamiento) o una trampa (Toma de Liquidez)?</p>
                            </div>
                            <div class="text-right">
                                <span class="block text-xs font-bold text-slate-400">ACIERTOS</span>
                                <span id="lab-score" class="text-2xl font-black text-kawn-base">0</span>
                            </div>
                        </div>
                        <div id="breakoutChart" class="w-full h-80 mb-6 bg-slate-50 rounded border border-slate-100"></div>
                        <div class="flex gap-4" id="lab-controls">
                            <button id="btn-fake" class="flex-1 py-3 px-4 bg-white border-2 border-slate-200 hover:border-red-400 hover:bg-red-50 text-slate-700 font-bold rounded-xl transition flex items-center justify-center gap-2">
                                <i data-lucide="x-circle" class="w-5 h-5 text-red-500"></i> Es una Trampa (Liquidez)
                            </button>
                            <button id="btn-real" class="flex-1 py-3 px-4 bg-kawn-base hover:bg-kawn-dark text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2">
                                <i data-lucide="check-circle" class="w-5 h-5"></i> Es un Cambio Real
                            </button>
                        </div>
                        <div id="lab-feedback" class="mt-4 p-4 rounded-lg hidden text-sm font-medium text-center transition-all"></div>
                        <button id="next-scenario-btn" class="w-full mt-4 py-2 bg-slate-800 text-white rounded-lg hidden hover:bg-slate-700 transition">Siguiente Escenario</button>
                    </div>
                </section>

                <!-- NUEVA SECCIÓN: El Factor Tiempo -->
                <section id="factor-tiempo" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="hourglass" class="text-kawn-base mr-3"></i> El Factor Tiempo
                    </h2>
                    
                    <p class="mb-6 leading-7">
                        El tiempo añade contexto a la estructura. No es solo "qué" rompe el precio, sino "cuánto tiempo" le toma hacerlo.
                    </p>

                    <div class="grid gap-4 md:grid-cols-2">
                        <div class="bg-white p-5 rounded-lg border-l-4 border-blue-400 shadow-sm">
                            <h4 class="font-bold text-slate-800 mb-2">Desarrollo Lento vs. Rápido</h4>
                            <p class="text-sm text-slate-600">
                                Una tendencia que construye sus máximos con calma suele ser más sostenible (cimientos sólidos). Un movimiento explosivo ("Parabólico") a menudo es frágil y deja ineficiencias que deben ser rebalanceadas pronto.
                            </p>
                        </div>
                        <div class="bg-white p-5 rounded-lg border-l-4 border-purple-400 shadow-sm">
                            <h4 class="font-bold text-slate-800 mb-2">Madurez de la Tendencia</h4>
                            <p class="text-sm text-slate-600">
                                Las tendencias jóvenes tienen impulsos agresivos. Las maduras pierden momentum (retrocesos profundos). Identifica si estás en el inicio o en el agotamiento antes de entrar.
                            </p>
                        </div>
                    </div>
                </section>

                <!-- NUEVA SECCIÓN: Errores Comunes -->
                <section id="errores-comunes" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="shield-alert" class="text-red-500 mr-3"></i> Errores Comunes
                    </h2>

                    <div class="space-y-4">
                        <div class="flex gap-4 items-start bg-red-50 p-4 rounded-xl border border-red-100">
                            <i data-lucide="search-x" class="w-6 h-6 text-red-500 mt-1 flex-shrink-0"></i>
                            <div>
                                <h4 class="font-bold text-red-900">Perfeccionismo Estructural</h4>
                                <p class="text-sm text-red-800 mt-1">
                                    Los mercados son desordenados. No esperes estructuras de libro de texto. Aprende a tolerar ligeras imperfecciones si la intención del precio es clara.
                                </p>
                            </div>
                        </div>

                        <div class="flex gap-4 items-start bg-orange-50 p-4 rounded-xl border border-orange-100">
                            <i data-lucide="microscope" class="w-6 h-6 text-orange-500 mt-1 flex-shrink-0"></i>
                            <div>
                                <h4 class="font-bold text-orange-900">Sobrevaloración de Temporalidades Menores</h4>
                                <p class="text-sm text-orange-800 mt-1">
                                    "No te preocupes por las pulgas (M1) cuando peleas con elefantes (H4/D1)". Un cambio en M1 no detiene una tendencia diaria. Úsalo solo para afinar, no para decidir la dirección.
                                </p>
                            </div>
                        </div>

                        <div class="flex gap-4 items-start bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                            <i data-lucide="timer-off" class="w-6 h-6 text-yellow-600 mt-1 flex-shrink-0"></i>
                            <div>
                                <h4 class="font-bold text-yellow-900">Impaciencia con las Confirmaciones</h4>
                                <p class="text-sm text-yellow-800 mt-1">
                                    Entrar antes del cierre de vela es apostar, no hacer trading. El mercado siempre da otra oportunidad, pero tu capital no regresa si lo pierdes por prisas.
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- NUEVA SECCIÓN: ANALIZADOR DE ESCENARIOS (IA) -->
                <section id="analizador-ia" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="brain-circuit" class="text-kawn-base mr-3"></i> Analizador de Escenarios & Conceptos (IA)
                    </h2>
                    
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Herramienta 1: Analizador de Escenarios -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-kawn-deep">
                            <h3 class="font-bold text-lg text-slate-800 mb-2">Diagnóstico de Estructura</h3>
                            <p class="text-xs text-slate-500 mb-4">Describe tu situación (ej. "Diario alcista, pero H1 rompió soporte") y la IA evaluará si es un retroceso o una reversión.</p>
                            
                            <textarea id="scenario-input" class="w-full p-3 border border-slate-200 rounded-lg text-sm mb-3 focus:ring-2 focus:ring-kawn-base focus:outline-none" rows="3" placeholder="Describe aquí la acción del precio..."></textarea>
                            
                            <button id="analyze-scenario-btn" class="w-full bg-slate-800 hover:bg-slate-700 text-white text-sm font-bold py-2 rounded-lg transition flex items-center justify-center gap-2">
                                <i data-lucide="search" class="w-4 h-4"></i> Analizar Escenario
                            </button>
                            
                            <div id="scenario-output" class="mt-4 hidden p-3 bg-slate-50 rounded-lg text-sm border border-slate-100"></div>
                        </div>

                        <!-- Herramienta 2: Simplificador de Conceptos -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-kawn-light">
                            <h3 class="font-bold text-lg text-slate-800 mb-2">Simplificador de Conceptos</h3>
                            <p class="text-xs text-slate-500 mb-4">¿Un término confuso? Escríbelo y la IA creará una analogía de la vida cotidiana para explicarlo.</p>
                            
                            <div class="flex gap-2 mb-3">
                                <input type="text" id="concept-input" class="flex-1 p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-kawn-base focus:outline-none" placeholder="Ej: Order Block, Fractalidad...">
                                <button id="explain-concept-btn" class="bg-kawn-base hover:bg-kawn-dark text-white px-4 rounded-lg">
                                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                                </button>
                            </div>
                            
                            <div id="concept-output" class="mt-4 hidden p-3 bg-kawn-light/30 rounded-lg text-sm text-kawn-deep border border-kawn-light"></div>
                        </div>
                    </div>
                </section>

                <!-- Flujo de Trabajo (CHECKLIST INTERACTIVO) -->
                <section id="psicologia-flujo" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6">Flujo de Trabajo</h2>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <h3 class="font-bold text-lg text-kawn-dark mb-4 border-b pb-2">Checklist de Validación Estructural</h3>
                        <p class="text-xs text-slate-400 mb-4">Marca los pasos antes de considerar una operación.</p>
                        
                        <div class="space-y-3">
                            <label class="flex items-center space-x-3 cursor-pointer group">
                                <input type="checkbox" class="checklist-item w-5 h-5 text-kawn-base rounded border-slate-300 focus:ring-kawn-base cursor-pointer">
                                <span class="text-slate-700 group-hover:text-kawn-dark transition">1. Tendencia Mayor (D1/H4) identificada claramente.</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer group">
                                <input type="checkbox" class="checklist-item w-5 h-5 text-kawn-base rounded border-slate-300 focus:ring-kawn-base cursor-pointer">
                                <span class="text-slate-700 group-hover:text-kawn-dark transition">2. Puntos de Liquidez (Highs/Lows previos) ubicados.</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer group">
                                <input type="checkbox" class="checklist-item w-5 h-5 text-kawn-base rounded border-slate-300 focus:ring-kawn-base cursor-pointer">
                                <span class="text-slate-700 group-hover:text-kawn-dark transition">3. Ruptura con <strong>Desplazamiento</strong> (Cuerpo) en H1 confirmada.</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer group">
                                <input type="checkbox" class="checklist-item w-5 h-5 text-kawn-base rounded border-slate-300 focus:ring-kawn-base cursor-pointer">
                                <span class="text-slate-700 group-hover:text-kawn-dark transition">4. Retroceso a zona de descuento (FVG/Block).</span>
                            </label>
                        </div>

                        <div class="mt-4 pt-4 border-t border-slate-100 flex items-center justify-between">
                            <span class="text-xs font-bold text-slate-500 uppercase">Estado:</span>
                            <span id="checklist-status" class="text-sm font-bold text-slate-400">Pendiente (0/4)</span>
                        </div>
                    </div>
                </section>

                <!-- PLAN DE TRADING IA -->
                <section id="plan-trading" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="cpu" class="text-kawn-base mr-3"></i> Constructor de Plan de Trading IA ✨
                    </h2>
                    
                    <div class="bg-gradient-to-br from-slate-900 to-slate-800 p-8 rounded-xl shadow-2xl border border-slate-700">
                        <div class="mb-6">
                            <h3 class="text-xl font-bold text-white mb-2">Generador de Estrategia Estructural</h3>
                            <p class="text-slate-400 text-sm">Define tu perfil y deja que la IA estructure tu enfoque operativo.</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-xs font-bold text-kawn-base mb-2 uppercase tracking-wide">Estilo de Trading</label>
                                <select id="plan-style" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-3 focus:border-kawn-base outline-none">
                                    <option value="Scalping (M1/M5)">Scalping (M1/M5)</option>
                                    <option value="Intraday (M15/H1)">Intraday (M15/H1)</option>
                                    <option value="Swing (H4/D1)">Swing (H4/D1)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-kawn-base mb-2 uppercase tracking-wide">Tolerancia al Riesgo</label>
                                <select id="plan-risk" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-3 focus:border-kawn-base outline-none">
                                    <option value="Conservador">Conservador (Confirmación Doble)</option>
                                    <option value="Agresivo">Agresivo (Entrada en Ruptura)</option>
                                </select>
                            </div>
                        </div>

                        <button id="generate-plan-btn" class="w-full bg-kawn-base hover:bg-kawn-dark text-white font-bold py-4 rounded-xl shadow-lg shadow-kawn-base/20 transition-all transform hover:scale-[1.01] flex items-center justify-center gap-2">
                            <i data-lucide="sparkles" class="w-5 h-5"></i> Generar Plan Estructural Personalizado
                        </button>

                        <div id="plan-output" class="hidden mt-8 bg-slate-800/50 rounded-lg p-6 border border-slate-600 animate-pulse">
                            <div class="flex items-center justify-center text-kawn-light">
                                <i data-lucide="loader-2" class="w-6 h-6 animate-spin mr-3"></i> Diseñando estrategia...
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Evaluación (QUIZ) CON IA Y FEEDBACK -->
                <section id="evaluacion" class="mb-20 scroll-mt-28">
                    <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
                        <h2 class="text-2xl font-bold text-slate-900 flex items-center">
                            <i data-lucide="award" class="text-kawn-base mr-3"></i> Validación del Conocimiento
                        </h2>
                        <button id="generate-quiz-btn" class="text-xs font-bold text-kawn-deep bg-kawn-light px-4 py-2 rounded-full hover:bg-kawn-base hover:text-white transition flex items-center gap-2 border border-kawn-base">
                            <i data-lucide="refresh-cw" class="w-3 h-3"></i> Generar Nuevo Quiz con IA ✨
                        </button>
                    </div>
                    
                    <div class="bg-white p-8 rounded-xl shadow-lg border border-slate-200 relative overflow-hidden">
                        <div id="quiz-loading" class="hidden absolute inset-0 bg-white/90 z-10 flex flex-col items-center justify-center">
                            <i data-lucide="loader-2" class="w-10 h-10 text-kawn-base animate-spin mb-3"></i>
                            <p class="text-slate-600 font-medium">La IA está redactando nuevas preguntas...</p>
                        </div>

                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-slate-800" id="quiz-title">Test: Conceptos Base</h3>
                            <span id="quiz-score" class="text-sm font-bold text-slate-500 bg-slate-100 px-3 py-1 rounded-full">Puntuación: 0/0</span>
                        </div>
                        <div id="quiz-container"></div>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <!-- AI Mentor (Proxy) -->
    <div class="fixed bottom-6 right-6 z-40">
        <button id="ai-toggle" class="bg-slate-900 text-white p-4 rounded-full shadow-2xl hover:bg-slate-800 transition-all hover:scale-105 flex items-center gap-2">
            <i data-lucide="bot" class="w-6 h-6 text-kawn-base"></i>
            <span class="font-bold hidden md:inline">Mentor Estructural IA</span>
        </button>
    </div>

    <!-- AI Modal -->
    <div id="ai-modal" class="hidden fixed bottom-24 right-6 w-96 max-w-[90vw] bg-white rounded-xl shadow-2xl border border-slate-200 z-50 flex flex-col h-[500px]">
        <div class="p-4 bg-slate-900 text-white rounded-t-xl flex justify-between items-center">
            <h3 class="font-bold flex items-center gap-2"><i data-lucide="bot" class="text-kawn-base w-4 h-4"></i> Mentor IA</h3>
            <button id="close-ai" class="hover:text-kawn-light"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div id="chat-history" class="flex-1 overflow-y-auto p-4 bg-slate-50 flex flex-col custom-scrollbar">
            <div class="ai-message chat-message shadow-sm">
                Hola. Soy tu especialista en Estructura de Mercado. Pregúntame sobre "fractalidad", "falsas rupturas" o cómo identificar un "cambio de carácter" (CHoCH).
            </div>
        </div>
        <div class="p-4 border-t border-slate-200 bg-white rounded-b-xl">
            <div class="flex gap-2">
                <input type="text" id="user-input" class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-kawn-base" placeholder="Escribe tu duda...">
                <button id="send-ai" class="bg-kawn-base text-white p-2 rounded-lg hover:bg-kawn-dark transition-colors">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-12 mt-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-3">
                <div class="kawn-logo-icon"></div>
                <div class="flex flex-col">
                    <span class="text-2xl font-black text-white tracking-tight leading-none">KAWNBIT</span>
                    <span class="text-[0.6rem] font-bold text-kawn-base uppercase tracking-[0.2em] leading-none mt-1">Quantitative Trading Community</span>
                </div>
            </div>
            <p class="text-sm text-center md:text-right">
                © <span id="current-year"></span> KawnBit Quantitative Trading Community.<br>
                <span class="text-xs opacity-50">Material educativo. No constituye asesoramiento financiero.</span>
            </p>
        </div>
    </footer>

    <!-- SCRIPTS ENCAPSULADOS PARA ROBUSTEZ -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 0. INICIALIZACIÓN
            // Set Markdown options to handle breaks
            if (typeof marked !== 'undefined') {
                marked.setOptions({ breaks: true });
            }

            if (typeof lucide !== 'undefined') lucide.createIcons();
            document.getElementById('current-year').textContent = new Date().getFullYear();

            // Scroll Progress
            window.onscroll = function() {
                let winScroll = document.body.scrollTop || document.documentElement.scrollTop;
                let height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                let scrolled = (winScroll / height) * 100;
                document.getElementById("reading-progress-bar").style.width = scrolled + "%";
            };

            // 1. TOC DINÁMICO
            const tocContainer = document.getElementById('toc-container');
            const headers = document.querySelectorAll('main h2, main h3');
            
            headers.forEach((header, index) => {
                const id = header.id || `section-${index}`;
                header.id = id;
                const link = document.createElement('a');
                link.href = `#${id}`;
                link.textContent = header.innerText;
                link.className = `toc-link block py-1 text-slate-500 hover:text-slate-800 ${header.tagName === 'H3' ? 'pl-4 text-xs' : 'font-medium'}`;
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
                });
                tocContainer.appendChild(link);
            });

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        document.querySelectorAll('.toc-link').forEach(link => link.classList.remove('active'));
                        const activeLink = document.querySelector(`.toc-link[href="#${entry.target.id}"]`);
                        if (activeLink) {
                            activeLink.classList.add('active');
                            activeLink.scrollIntoView({ block: 'center', behavior: 'smooth' });
                        }
                    }
                });
            }, { rootMargin: '-20% 0px -60% 0px' });
            headers.forEach(header => observer.observe(header));

            // 2. FRACTALIDAD (Chart.js)
            if (typeof Chart !== 'undefined') {
                const fractalCtx = document.getElementById('fractalChart').getContext('2d');
                let isZoomed = false;

                const hourlyData = [100, 100.5, 101, 100.8, 101.5, 102, 101.8, 102.5, 103, 102.8, 103.5, 104, 103.8, 104.5, 105, 104.8, 105.5, 106, 107, 108, 107.5, 108.5, 109, 110];
                const simplifiedData = new Array(24).fill(null).map((_, i) => 100 + (i * (10/23)));
                const labels = Array.from({length: 24}, (_, i) => `${i}:00`);

                const fractalChart = new Chart(fractalCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Acción del Precio',
                            data: simplifiedData,
                            borderColor: '#94a3b8',
                            backgroundColor: 'rgba(20, 184, 166, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { display: false }, y: { display: false, min: 99, max: 111 } },
                        animation: { duration: 1500, easing: 'easeInOutQuart' }
                    }
                });

                document.getElementById('toggleFractalBtn').addEventListener('click', function() {
                    isZoomed = !isZoomed;
                    const desc = document.getElementById('fractal-desc');
                    
                    if (isZoomed) {
                        fractalChart.data.datasets[0].data = hourlyData;
                        fractalChart.data.datasets[0].borderColor = '#14b8a6'; 
                        this.textContent = "Alejar (Ver Diario)";
                        desc.textContent = "Vista: Gráfico 1 Hora (Estructura interna: HH, HL visibles)";
                        desc.classList.add('text-kawn-base');
                    } else {
                        fractalChart.data.datasets[0].data = simplifiedData;
                        fractalChart.data.datasets[0].borderColor = '#ffffff'; 
                        this.textContent = "Hacer Zoom (Diario → 1H)";
                        desc.textContent = "Vista: Gráfico Diario (Una sola vela de expansión)";
                        desc.classList.remove('text-kawn-base');
                    }
                    fractalChart.update();
                });
            } else {
                // Fallback UI if chart fails
                document.getElementById('fractal-container').innerHTML = 
                    `<div class="chart-error"><p>No se pudo cargar el gráfico (Chart.js).</p></div>`;
            }

            // 3. CANDLE READER LOGIC
            const candleCards = document.querySelectorAll('.candle-card');
            candleCards.forEach(card => {
                card.addEventListener('click', function() {
                    const type = this.getAttribute('data-candle');
                    const feedback = document.getElementById('candle-feedback');
                    feedback.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                    
                    if (type === 'B') {
                        feedback.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-200');
                        feedback.innerHTML = `<i data-lucide="check-circle" class="inline w-4 h-4 mr-1"></i> <strong>¡Correcto!</strong> La Vela B tiene un cuerpo grande y sólido. Esto indica que los institucionales compraron con fuerza y mantuvieron el precio alto al cierre.`;
                    } else if (type === 'A') {
                        feedback.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-200');
                        feedback.innerHTML = `<i data-lucide="x-circle" class="inline w-4 h-4 mr-1"></i> <strong>Incorrecto.</strong> La Vela A tiene mucha mecha superior. Esto sugiere que el precio subió pero fue rechazado (ventas). Es probable que sea una toma de liquidez, no un desplazamiento real.`;
                    } else {
                        feedback.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-200');
                        feedback.innerHTML = `<i data-lucide="x-circle" class="inline w-4 h-4 mr-1"></i> <strong>Incorrecto.</strong> La Vela C es un Doji (indecisión). No muestra fuerza ni dirección clara.`;
                    }
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                });
            });

            // 4. CHECKLIST LOGIC
            const checklistItems = document.querySelectorAll('.checklist-item');
            checklistItems.forEach(item => {
                item.addEventListener('change', () => {
                    const checked = Array.from(checklistItems).filter(c => c.checked).length;
                    const total = checklistItems.length;
                    const status = document.getElementById('checklist-status');
                    
                    status.textContent = checked === total ? "¡LISTO PARA OPERAR! (4/4)" : `Pendiente (${checked}/${total})`;
                    status.className = checked === total ? "text-sm font-bold text-kawn-base animate-pulse" : "text-sm font-bold text-slate-400";
                });
            });

            // 5. LABORATORIO DE RUPTURAS (Plotly)
            if (typeof Plotly !== 'undefined') {
                let currentScenarioType = '';
                
                function generateScenario() {
                    const isReal = Math.random() > 0.5;
                    currentScenarioType = isReal ? 'real' : 'fake';
                    
                    const x = Array.from({length: 20}, (_, i) => i + 1);
                    let open = [], high = [], low = [], close = [];
                    let price = 100;
                    
                    for(let i=0; i<15; i++) {
                        let move = (Math.random() - 0.5) * 2;
                        let o = price;
                        let c = price + move;
                        let h = Math.max(o, c) + Math.random();
                        let l = Math.min(o, c) - Math.random();
                        if (h > 104.5) { h = 104.5; c = Math.min(c, 104.5); }
                        open.push(o); close.push(c); high.push(h); low.push(l);
                        price = c;
                    }

                    if (isReal) {
                        let o16 = price; let c16 = 106.5; 
                        open.push(o16); close.push(c16); high.push(106.8); low.push(o16-0.2);
                        open.push(106.5); close.push(107.2); high.push(107.5); low.push(106.2);
                        price = 107.2;
                        for(let i=0; i<3; i++) {
                            open.push(price); close.push(price+0.2); high.push(price+0.5); low.push(price-0.2);
                            price += 0.2;
                        }
                    } else {
                        let o16 = price;
                        let h16 = 106.5; 
                        let c16 = 104.2; 
                        open.push(o16); close.push(c16); high.push(h16); low.push(Math.min(o16, c16)-0.2);
                        open.push(c16); close.push(103.0); high.push(104.5); low.push(102.8);
                        price = 103.0;
                        for(let i=0; i<3; i++) {
                            open.push(price); close.push(price-0.5); high.push(price+0.2); low.push(price-0.8);
                            price -= 0.5;
                        }
                    }

                    const trace = {
                        x: x, open: open, high: high, low: low, close: close,
                        type: 'candlestick',
                        increasing: {line: {color: '#14b8a6'}},
                        decreasing: {line: {color: '#ef4444'}}
                    };

                    const layout = {
                        dragmode: false,
                        margin: {r:10, t:10, b:30, l:30},
                        showlegend: false,
                        xaxis: {rangeslider: {visible: false}},
                        shapes: [{
                            type: 'line', x0: 0, x1: 20, y0: 105, y1: 105,
                            line: {color: 'orange', width: 2, dash: 'dash'}
                        }],
                        annotations: [{
                            x: 10, y: 105.2, xref: 'x', yref: 'y',
                            text: 'Resistencia (Liquidez)', showarrow: false, font: {color: 'orange'}
                        }]
                    };
                    
                    Plotly.newPlot('breakoutChart', [trace], layout, {displayModeBar: false});
                    
                    document.getElementById('lab-feedback').classList.add('hidden');
                    document.getElementById('lab-controls').classList.remove('hidden');
                    document.getElementById('next-scenario-btn').classList.add('hidden');
                }

                function guessBreakout(guess) {
                    const feedback = document.getElementById('lab-feedback');
                    const controls = document.getElementById('lab-controls');
                    const nextBtn = document.getElementById('next-scenario-btn');
                    
                    controls.classList.add('hidden');
                    feedback.classList.remove('hidden');
                    nextBtn.classList.remove('hidden');
                    
                    let labScore = parseInt(document.getElementById('lab-score').innerText);

                    if (guess === currentScenarioType) {
                        labScore++;
                        feedback.className = "mt-4 p-4 rounded-lg text-sm font-medium text-center bg-green-100 text-green-800 border border-green-200";
                        feedback.innerHTML = `<strong>¡CORRECTO!</strong> ${guess === 'real' ? 'Hubo cuerpo cerrando arriba y continuación.' : 'Fue solo un barrido de liquidez (mecha) y cierre abajo.'}`;
                    } else {
                        feedback.className = "mt-4 p-4 rounded-lg text-sm font-medium text-center bg-red-100 text-red-800 border border-red-200";
                        feedback.innerHTML = `<strong>INCORRECTO.</strong> ${guess === 'real' ? 'No hubo cierre real arriba, solo una mecha cazando stops.' : 'El precio cerró con fuerza arriba (cuerpo) indicando intención real.'}`;
                    }
                    document.getElementById('lab-score').innerText = labScore;
                }

                // Initial load
                generateScenario();
                
                // Event Listeners for Breakout Lab
                document.getElementById('btn-fake').addEventListener('click', () => guessBreakout('fake'));
                document.getElementById('btn-real').addEventListener('click', () => guessBreakout('real'));
                document.getElementById('next-scenario-btn').addEventListener('click', generateScenario);

                // Resize observer for Plotly
                new ResizeObserver(() => {
                    Plotly.Plots.resize('breakoutChart');
                }).observe(document.getElementById('simulador'));
            } else {
                // Fallback if Plotly fails
                document.getElementById('breakoutChart').innerHTML = 
                    `<div class="chart-error"><p>No se pudo cargar el simulador (Plotly.js).</p></div>`;
            }

            // 6. QUIZ LOGIC
            let quizQuestions = [
                {
                    q: "1. ¿Qué define una tendencia alcista saludable?",
                    options: ["Máximos decrecientes y mínimos crecientes", "Máximos crecientes y mínimos crecientes", "Máximos iguales y mínimos más bajos"],
                    correct: 1,
                    explanation: "Una tendencia alcista sólida se construye con 'Higher Highs' (Máximos más altos) y 'Higher Lows' (Mínimos más altos)."
                },
                {
                    q: "2. ¿Qué diferencia principal existe entre una 'perforación' y un 'desplazamiento'?",
                    options: ["El desplazamiento tiene continuación y cuerpo; la perforación es temporal y suele ser mecha.", "La perforación ocurre en temporalidades mayores solamente.", "No hay diferencia, son lo mismo."],
                    correct: 0,
                    explanation: "El desplazamiento implica intención real: velas de cuerpo grande cerrando más allá del nivel."
                },
                {
                    q: "3. Si el gráfico Diario es Alcista pero H1 es Bajista, ¿qué es lo más probable?",
                    options: ["Que la tendencia diaria ha terminado.", "Que estamos en un retroceso (corrección) dentro de la tendencia diaria.", "Que el mercado va a colapsar."],
                    correct: 1,
                    explanation: "Las temporalidades menores a menudo muestran la estructura de los retrocesos de las mayores."
                },
                {
                    q: "4. ¿Cuál es la función principal de los 'puntos de estructura' para el Institucional?",
                    options: ["Son zonas bonitas para dibujar líneas.", "Son depósitos de liquidez (Stops) para llenar sus órdenes.", "Indican dónde el precio nunca volverá."],
                    correct: 1,
                    explanation: "Los institucionales ven los máximos y mínimos obvios como piscinas de liquidez (Stop Loss)."
                }
            ];

            // Render function attached to window for click events
            window.handleQuiz = function(qIdx, oIdx, correctIdx) {
                // Prevent multiple clicks via class check instead of global set
                const optsDiv = document.getElementById(`q-opts-${qIdx}`);
                if (optsDiv.classList.contains('answered')) return;
                optsDiv.classList.add('answered');

                const feed = document.getElementById(`q-feed-${qIdx}`);
                const explanation = quizQuestions[qIdx].explanation || "Sin explicación adicional.";
                let score = parseInt(document.getElementById('quiz-score').innerText.split(':')[1].split('/')[0]);
                
                Array.from(optsDiv.children).forEach((el, i) => {
                    el.classList.add('disabled');
                    el.style.cursor = 'default';
                    if (i === correctIdx) el.classList.add('correct');
                    if (i === oIdx && i !== correctIdx) el.classList.add('incorrect');
                });

                if (oIdx === correctIdx) {
                    score++;
                    feed.innerHTML = `
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <p class="font-bold text-green-700 text-sm mb-1">¡Correcto! <i data-lucide="check" class="inline w-4 h-4"></i></p>
                            <p class="text-slate-600 text-sm leading-relaxed">${explanation}</p>
                        </div>`;
                } else {
                    feed.innerHTML = `
                        <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                            <p class="font-bold text-red-600 text-sm mb-1">Incorrecto <i data-lucide="x" class="inline w-4 h-4"></i></p>
                            <p class="text-slate-600 text-sm leading-relaxed">${explanation}</p>
                        </div>`;
                }
                
                feed.classList.remove('hidden');
                if (typeof lucide !== 'undefined') lucide.createIcons();
                document.getElementById('quiz-score').textContent = `Puntuación: ${score}/${quizQuestions.length}`;
            };

            function renderQuiz() {
                const quizContainer = document.getElementById('quiz-container');
                quizContainer.innerHTML = ''; 
                document.getElementById('quiz-score').textContent = `Puntuación: 0/${quizQuestions.length}`;

                quizQuestions.forEach((q, idx) => {
                    let html = `
                        <div class="mb-8 border-b border-slate-100 pb-6 last:border-0">
                            <p class="font-semibold text-slate-900 mb-3">${q.q}</p>
                            <div class="space-y-2" id="q-opts-${idx}">
                    `;
                    q.options.forEach((opt, oIdx) => {
                        html += `<div class="quiz-option border border-slate-300 rounded-lg p-3 text-sm text-slate-700 hover:border-kawn-base" onclick="handleQuiz(${idx}, ${oIdx}, ${q.correct})">${opt}</div>`;
                    });
                    html += `</div><div id="q-feed-${idx}" class="hidden mt-3 transition-all"></div></div>`;
                    quizContainer.innerHTML += html;
                });
            }
            renderQuiz();

            // 7. HELPER: AI FETCHER (ROBUST)
            async function callAI(endpoint, payload, buttonId, loadingContainerId, outputContainerId) {
                const btn = document.getElementById(buttonId);
                const loading = document.getElementById(loadingContainerId); // Optional if using button state
                const output = document.getElementById(outputContainerId);
                
                if (btn) btn.disabled = true;
                if (loading) loading.classList.remove('hidden');
                if (output) output.classList.add('hidden');

                try {
                    const response = await fetch(endpoint, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        if (response.status === 404) throw new Error("Servicio IA no encontrado (Proxy Error).");
                        throw new Error("Error en la respuesta del servidor");
                    }
                    const data = await response.json();
                    return data.text || data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (error) {
                    console.error(error);
                    return null;
                } finally {
                    if (btn) btn.disabled = false;
                    if (loading) loading.classList.add('hidden');
                    if (output) output.classList.remove('hidden');
                }
            }

            // HELPER: EXTRACT JSON ROBUSTLY & VALIDATE
            function extractJSON(text) {
                try {
                    const firstBracket = text.indexOf('[');
                    const lastBracket = text.lastIndexOf(']');
                    if (firstBracket !== -1 && lastBracket !== -1) {
                        return JSON.parse(text.substring(firstBracket, lastBracket + 1));
                    }
                    return JSON.parse(text); 
                } catch (e) {
                    console.warn("Fallo al parsear JSON:", e);
                    return null;
                }
            }

            function validateQuizStructure(data) {
                if (!Array.isArray(data)) return false;
                // Check if all items in array have required structure
                return data.every(item => 
                    item.hasOwnProperty('q') && 
                    item.hasOwnProperty('options') && 
                    Array.isArray(item.options) &&
                    item.hasOwnProperty('correct') &&
                    typeof item.correct === 'number'
                );
            }

            // -- MENTOR CHAT --
            const chatHistory = document.getElementById('chat-history');
            const aiModal = document.getElementById('ai-modal');
            
            document.getElementById('ai-toggle').addEventListener('click', () => aiModal.classList.remove('hidden'));
            document.getElementById('close-ai').addEventListener('click', () => aiModal.classList.add('hidden'));

            async function sendAIMessage() {
                const input = document.getElementById('user-input');
                const text = input.value.trim();
                if (!text) return;

                // Add User Message
                const userMsg = document.createElement('div');
                userMsg.className = "user-message chat-message shadow-sm";
                userMsg.textContent = text;
                chatHistory.appendChild(userMsg);
                input.value = '';
                chatHistory.scrollTop = chatHistory.scrollHeight;

                // Add Loading
                const loadingMsg = document.createElement('div');
                loadingMsg.className = "ai-message chat-message shadow-sm animate-pulse";
                loadingMsg.textContent = "Analizando...";
                chatHistory.appendChild(loadingMsg);

                const responseText = await callAI("/.netlify/functions/gemini-proxy", {
                    prompt: `Eres un experto en Trading Institucional (ICT/SMC). Responde breve y didácticamente a: ${text}`
                }, 'send-ai');

                chatHistory.removeChild(loadingMsg);
                
                const aiMsg = document.createElement('div');
                aiMsg.className = "ai-message chat-message shadow-sm markdown-prose";
                aiMsg.innerHTML = responseText ? marked.parse(responseText) : "<span class='text-red-500'>Error de conexión. Intenta de nuevo.</span>";
                chatHistory.appendChild(aiMsg);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            document.getElementById('send-ai').addEventListener('click', sendAIMessage);
            document.getElementById('user-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendAIMessage() });

            // -- PLAN GENERATOR --
            document.getElementById('generate-plan-btn').addEventListener('click', async () => {
                const style = document.getElementById('plan-style').value;
                const risk = document.getElementById('plan-risk').value;
                const output = document.getElementById('plan-output');
                
                output.innerHTML = `<div class="flex items-center justify-center text-kawn-light"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mr-3"></i> Diseñando estrategia...</div>`;
                output.classList.remove('hidden');
                if (typeof lucide !== 'undefined') lucide.createIcons();

                const prompt = `Genera un "Plan de Trading Estructural" conciso en Markdown para estilo "${style}" y riesgo "${risk}". Incluye checklist de confirmación y stop loss estructural.`;
                
                const responseText = await callAI("/.netlify/functions/gemini-proxy", { prompt: prompt }, 'generate-plan-btn');

                if (responseText) {
                    output.innerHTML = `
                        <div class="flex justify-between items-start mb-4 border-b border-slate-600 pb-2">
                            <h4 class="text-kawn-base font-bold uppercase tracking-widest text-sm">Plan Generado</h4>
                        </div>
                        <div class="text-slate-300 text-sm leading-relaxed markdown-prose">${marked.parse(responseText)}</div>
                    `;
                } else {
                    output.innerHTML = `<p class="text-red-400">Error al contactar con la IA. Verifica tu conexión.</p>`;
                }
            });

            // -- ANALYZER --
            document.getElementById('analyze-scenario-btn').addEventListener('click', async () => {
                const input = document.getElementById('scenario-input').value;
                const output = document.getElementById('scenario-output');
                if (!input.trim()) return;

                output.classList.remove('hidden');
                output.innerHTML = "Analizando...";

                const responseText = await callAI("/.netlify/functions/gemini-proxy", {
                    prompt: `Analiza este escenario de mercado (SMC): "${input}". Diagnóstico breve.`
                }, 'analyze-scenario-btn');

                output.innerHTML = responseText ? marked.parse(responseText) : "Error de conexión.";
            });

            // -- SIMPLIFIER --
            document.getElementById('explain-concept-btn').addEventListener('click', async () => {
                const input = document.getElementById('concept-input').value;
                const output = document.getElementById('concept-output');
                if (!input.trim()) return;

                output.classList.remove('hidden');
                output.innerText = "Simplificando...";

                const responseText = await callAI("/.netlify/functions/gemini-proxy", {
                    prompt: `Explica el concepto de trading "${input}" con una analogía simple de la vida diaria. Máximo 2 frases.`
                }, 'explain-concept-btn');

                output.innerHTML = responseText ? `<p class="italic">"${responseText}"</p>` : "Error.";
            });

            // -- QUIZ GENERATOR --
            document.getElementById('generate-quiz-btn').addEventListener('click', async () => {
                const loading = document.getElementById('quiz-loading');
                loading.classList.remove('hidden');

                const prompt = `Genera un array JSON estricto con 4 preguntas nuevas sobre "Estructura de Mercado SMC". Formato: [{"q": "Pregunta", "options": ["A","B","C"], "correct": 0, "explanation": "Por qué"}]. Solo JSON.`;

                const responseText = await callAI("/.netlify/functions/gemini-proxy", { prompt: prompt }, 'generate-quiz-btn');
                
                loading.classList.add('hidden');

                if (responseText) {
                    const newQuestions = extractJSON(responseText);
                    
                    if (newQuestions && validateQuizStructure(newQuestions)) {
                        quizQuestions = newQuestions;
                        document.getElementById('quiz-title').innerHTML = `Test IA <span class="text-xs font-normal text-kawn-base ml-2">(${new Date().toLocaleTimeString()})</span>`;
                        renderQuiz();
                    } else {
                        alert("La IA generó un formato inválido. Intenta de nuevo.");
                    }
                } else {
                    alert("Error de conexión con la IA.");
                }
            });

            // Mobile Menu (Improved: Close on Click)
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const sidebar = document.querySelector('aside');
            
            function toggleMenu() {
                sidebar.classList.toggle('hidden');
                sidebar.classList.toggle('fixed');
                sidebar.classList.toggle('inset-0');
                sidebar.classList.toggle('bg-white');
                sidebar.classList.toggle('z-40');
                sidebar.classList.toggle('p-6');
            }

            mobileMenuBtn.addEventListener('click', toggleMenu);

            // Close menu when clicking links in mobile view
            document.querySelectorAll('.toc-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 768 && sidebar.classList.contains('fixed')) {
                        toggleMenu();
                    }
                });
            });
        });
    </script>
</body>
</html>