<!DOCTYPE html>
<html lang="es" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Capítulo 6: Bloques de Órdenes (Order Blocks) - Metodología SMC/ICT. Versión robusta con IA y simuladores.">
    <title>KawnBit | Cap 6: Order Blocks (V5 Robust)</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@400;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Librerías Externas (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Configuración Tailwind KawnBit -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kawn: {
                            light: '#ccfbf1', // Teal 100
                            base: '#14b8a6',  // Teal 500
                            dark: '#0f766e',  // Teal 700
                            deep: '#134e4a',  // Teal 900
                        },
                        slate: {
                            50: '#f8fafc',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(20, 184, 166, 0.25)',
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos personalizados */
        body {
            background-color: #f8fafc;
            color: #334155;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Montserrat', sans-serif;
        }

        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #14b8a6;
        }

        /* Logo CSS - Recreación exacta */
        .kawn-logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .kawn-icon {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, #14b8a6 0%, #0f766e 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 10px rgba(20, 184, 166, 0.3);
        }

        .kawn-icon::before {
            content: '';
            position: absolute;
            width: 60%;
            height: 60%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
        }

        .kawn-icon span {
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 24px;
            line-height: 1;
        }

        .kawn-text {
            display: flex;
            flex-direction: column;
        }

        .kawn-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 22px;
            line-height: 1;
            color: #0f172a;
            letter-spacing: -0.5px;
        }

        .kawn-subtitle {
            font-family: 'Inter', sans-serif;
            font-size: 10px;
            font-weight: 700;
            color: #14b8a6;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-top: 4px;
        }

        /* TOC Activo */
        .toc-link {
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .toc-link:hover {
            color: #14b8a6;
            opacity: 1;
        }

        .toc-link.active {
            color: #0f766e;
            border-left: 3px solid #14b8a6;
            background: linear-gradient(90deg, #ccfbf1 0%, transparent 100%);
            opacity: 1;
            padding-left: 1rem;
            font-weight: 600;
        }

        /* Estilos de Contenido */
        .content-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
            position: relative;
        }

        .callout {
            background-color: #ccfbf1;
            border-left: 4px solid #14b8a6;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin: 1.5rem 0;
        }

        blockquote {
            border-left: 4px solid #0f766e;
            padding-left: 1.5rem;
            font-style: italic;
            color: #475569;
            margin: 1.5rem 0;
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 0 0.5rem 0.5rem 0;
        }

        /* Chat Bot */
        .chat-message {
            max-width: 85%;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background-color: #14b8a6;
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }

        .ai-message {
            background-color: #f1f5f9;
            color: #0f172a;
            align-self: flex-start;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
            border: 1px solid #e2e8f0;
        }

        /* Quiz Styles */
        .quiz-option {
            transition: all 0.2s;
        }

        .quiz-option:hover {
            background-color: #f0fdfa;
            border-color: #14b8a6;
        }

        .quiz-option.selected.correct {
            background-color: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }

        .quiz-option.selected.incorrect {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }

        /* Estilos Lupa Fractal */
        .magnifier-glass {
            transition: all 0.1s ease;
            pointer-events: none;
        }

        .fractal-view {
            transition: opacity 0.3s ease;
        }

        /* Animaciones */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        /* Botón AI Sparkle */
        .ai-btn {
            background: linear-gradient(135deg, #14b8a6 0%, #0f766e 100%);
            color: white;
            transition: all 0.3s ease;
        }

        .ai-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(20, 184, 166, 0.4);
        }

        .ai-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>

<body class="antialiased text-slate-600">

    <!-- Progress Bar -->
    <div id="progress-bar" class="fixed top-0 left-0 h-1 bg-kawn-base z-[60] transition-all duration-300"
        style="width: 0%"></div>

    <!-- Navbar Sticky -->
    <nav class="sticky top-0 z-50 w-full bg-white/95 backdrop-blur-md border-b border-slate-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo -->
                <div class="kawn-logo-container">
                    <div class="kawn-icon"><span>K</span></div>
                    <div class="kawn-text">
                        <span class="kawn-title">KAWNBIT</span>
                        <span class="kawn-subtitle">QUANTITATIVE TRADING COMMUNITY</span>
                    </div>
                </div>

                <!-- Mobile Menu Button -->
                <button id="mobile-menu-btn" class="md:hidden p-2 text-slate-600 hover:text-kawn-base"
                    aria-label="Abrir menú">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>

                <!-- Desktop Nav -->
                <div class="hidden md:flex space-x-8 items-center">
                    <span class="text-xs font-bold bg-kawn-light text-kawn-deep px-3 py-1 rounded-full">Capítulo
                        6</span>
                    <a href="#inicio"
                        class="text-slate-500 hover:text-kawn-base font-medium text-sm transition-colors">Teoría</a>
                    <a href="#simulador-ob"
                        class="text-slate-500 hover:text-kawn-base font-medium text-sm transition-colors">Simuladores</a>
                    <a href="#ai-tools"
                        class="px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white text-sm font-bold rounded-lg hover:shadow-lg transition-colors flex items-center gap-2">
                        <i data-lucide="sparkles" class="w-4 h-4"></i> Herramientas IA
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Layout Principal -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <div class="flex flex-col md:flex-row gap-12">

            <!-- Sidebar TOC (Sticky) -->
            <aside class="hidden md:block w-72 flex-shrink-0">
                <div class="sticky top-28 overflow-y-auto max-h-[calc(100vh-150px)] pr-4">
                    <h3
                        class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6 border-b border-slate-200 pb-2">
                        Contenido del Capítulo</h3>
                    <nav id="toc-container" class="flex flex-col space-y-1 text-sm">
                        <!-- Generado dinámicamente por JS -->
                    </nav>
                </div>
            </aside>

            <!-- Contenido Principal -->
            <main class="flex-1 min-w-0">

                <!-- Hero Section -->
                <section id="inicio" class="mb-16 animate-fade-in-up">
                    <div
                        class="inline-flex items-center gap-2 mb-4 px-3 py-1 rounded-full bg-kawn-light border border-kawn-base/20">
                        <i data-lucide="layers" class="w-4 h-4 text-kawn-dark"></i>
                        <span class="text-xs font-bold text-kawn-deep uppercase tracking-wide">Metodología SMC /
                            ICT</span>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-black text-slate-900 mb-6 leading-tight">
                        Bloques de Órdenes <span class="text-kawn-base">(Order Blocks)</span>
                    </h1>
                    <p class="text-xl text-slate-500 leading-relaxed font-light">
                        La piedra angular de las entradas de alta precisión. Descubre las huellas digitales que el
                        dinero inteligente deja en los gráficos y aprende a validarlas como un profesional.
                    </p>
                </section>

                <!-- Introducción -->
                <section id="introduccion" class="mb-20 scroll-mt-28">
                    <h2
                        class="text-2xl font-bold text-slate-900 mb-6 border-l-4 border-kawn-base pl-4 flex justify-between items-center">
                        Comprendiendo la Esencia
                        <button
                            onclick="window.askAI('Explícame la esencia de un Order Block con una analogía sencilla')"
                            class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full hover:bg-indigo-200 transition flex items-center gap-1 ai-trigger-btn">
                            <i data-lucide="sparkles" class="w-3 h-3"></i> ✨ Explicar con IA
                        </button>
                    </h2>
                    <div class="content-card">
                        <p class="mb-4 leading-7">
                            Imagina por un momento que pudieras ver exactamente dónde los grandes inversores
                            institucionales han dejado sus órdenes pendientes en el mercado. Sería como tener un
                            <strong>mapa del tesoro</strong> que te muestra dónde el dinero inteligente está esperando
                            para entrar o salir. Pues bien, eso es precisamente lo que representan los bloques de
                            órdenes (Order Blocks) en la metodología ICT/SMC: son las huellas digitales que el Smart
                            Money deja en los gráficos, marcando áreas donde se ejecutaron grandes volúmenes de compra o
                            venta.
                        </p>
                        <p class="mb-4 leading-7">
                            Aprender a identificarlos y operarlos correctamente puede transformar radicalmente tu
                            precisión como trader, ya que permiten adelantarte a movimientos institucionales y lograr
                            entradas de alta calidad.
                        </p>
                        <div class="callout">
                            <h4 class="font-bold text-kawn-deep mb-2 flex items-center gap-2"><i data-lucide="magnet"
                                    class="w-5 h-5"></i> El Imán de Liquidez</h4>
                            <p class="text-sm text-kawn-deep/90">
                                Cuando el precio vuelve a sus zonas de entrada preferidas, las instituciones tienen
                                interés en defender esas posiciones, generando giros bruscos. Un Order Block marca dónde
                                las "manos fuertes" compraron o vendieron en grande.
                            </p>
                        </div>
                    </div>
                </section>

                <!-- NUEVA SECCIÓN: AI TRADING LAB -->
                <section id="ai-tools" class="mb-20 scroll-mt-28">
                    <div
                        class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-xl p-8 shadow-2xl relative overflow-hidden border border-slate-700">
                        <div class="absolute top-0 right-0 p-8 opacity-5">
                            <i data-lucide="cpu" class="w-64 h-64 text-white"></i>
                        </div>

                        <div class="relative z-10">
                            <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                                <i data-lucide="bot" class="text-kawn-base"></i> Laboratorio de Trading con IA
                            </h2>

                            <div class="grid md:grid-cols-2 gap-8">
                                <!-- Tool 1: Generador de Escenarios -->
                                <div
                                    class="bg-slate-800/50 p-6 rounded-lg border border-slate-600 backdrop-blur-sm flex flex-col">
                                    <h3 class="text-lg font-bold text-white mb-2 flex items-center gap-2">
                                        <i data-lucide="shuffle" class="text-purple-400"></i> Generador de Retos
                                    </h3>
                                    <p class="text-slate-400 text-sm mb-4">¿Aburrido de la teoría? Pide a la IA que
                                        genere un escenario de mercado aleatorio para poner a prueba tu análisis.</p>
                                    <button id="btn-generate-scenario" onclick="window.generateScenario()"
                                        class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold transition flex items-center justify-center gap-2 mt-auto">
                                        <i data-lucide="sparkles" class="w-4 h-4"></i> ✨ Generar Escenario
                                    </button>
                                    <div id="ai-scenario-output"
                                        class="mt-4 p-4 bg-slate-900 rounded border border-slate-700 text-slate-300 text-sm hidden min-h-[100px]">
                                    </div>
                                </div>

                                <!-- Tool 2: Analizador de Sentimiento -->
                                <div class="bg-slate-800/50 p-6 rounded-lg border border-slate-600 backdrop-blur-sm">
                                    <h3 class="text-lg font-bold text-white mb-2 flex items-center gap-2">
                                        <i data-lucide="search" class="text-blue-400"></i> Analizador de Contexto
                                    </h3>
                                    <p class="text-slate-400 text-sm mb-4">Describe lo que ves en tu gráfico y deja que
                                        la IA te diga qué buscaría un trader institucional.</p>
                                    <label for="market-desc" class="sr-only">Descripción del mercado</label>
                                    <textarea id="market-desc"
                                        class="w-full bg-slate-900 border border-slate-700 rounded p-3 text-slate-200 text-sm mb-3 focus:border-kawn-base outline-none"
                                        rows="3"
                                        placeholder="Ej: El precio rompió el máximo de ayer con fuerza y dejó un gap sin llenar..."></textarea>
                                    <button id="btn-analyze-market" onclick="window.analyzeMarket()"
                                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition flex items-center justify-center gap-2">
                                        <i data-lucide="sparkles" class="w-4 h-4"></i> ✨ Analizar con IA
                                    </button>
                                    <div id="ai-analysis-output"
                                        class="mt-4 p-4 bg-slate-900 rounded border border-slate-700 text-slate-300 text-sm hidden min-h-[100px]">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Anatomía -->
                <section id="anatomia" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 border-l-4 border-kawn-base pl-4">Anatomía de un
                        Order Block</h2>

                    <div class="grid md:grid-cols-2 gap-8 mb-8">
                        <div class="content-card mb-0 h-full">
                            <h3 class="font-bold text-slate-800 mb-4">¿Qué ocurre tras bambalinas?</h3>
                            <p class="text-sm leading-6 mb-4">
                                Un OB típicamente aparece tras una fase de equilibrio o consolidación, seguida de un
                                movimiento impulsivo desequilibrado. En esa consolidación, las fuerzas están en
                                equilibrio hasta que un bando toma el control, provocando una ruptura violenta.
                            </p>
                            <p class="text-sm leading-6">
                                <strong>La Analogía de la Esponja:</strong> La vela que forma el OB representa el
                                momento en que el Smart Money "absorbe" toda la liquidez disponible (como una esponja
                                absorbiendo agua) para luego impulsar el precio.
                            </p>
                        </div>

                        <!-- Visualizador Conceptual Chart.js -->
                        <div
                            class="bg-white p-6 rounded-xl shadow-lg border border-slate-200 flex flex-col items-center justify-center">
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Dinámica de
                                Volumen Institucional</h4>
                            <div class="w-full h-64 relative">
                                <canvas id="anatomyChart"></canvas>
                            </div>
                            <p class="text-xs text-center text-slate-400 mt-4 italic">Representación conceptual de la
                                absorción y desplazamiento.</p>
                        </div>
                    </div>

                    <div class="content-card">
                        <h3 class="font-bold text-slate-800 mb-4">¿Por qué regresan?</h3>
                        <p class="leading-7">
                            Las grandes instituciones no pueden colocar todas sus órdenes de golpe. Fragmentan sus
                            órdenes en bloques. El impulso inicial crea un <strong>desequilibrio (Fair Value
                                Gap)</strong>. Inevitablemente, el precio tiende a regresar al OB para reequilibrar
                            oferta y demanda, rellenando parcialmente ese vacío antes de continuar.
                        </p>
                    </div>
                </section>

                <!-- Simulador (Interactivo Crítico) -->
                <section id="simulador-ob" class="mb-20 scroll-mt-28">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-slate-900 border-l-4 border-kawn-base pl-4">Simulador de
                            Mercado: OB de Inicio</h2>
                        <span
                            class="px-3 py-1 bg-kawn-deep text-white text-xs font-bold rounded shadow-lg animate-pulse">Interactivo</span>
                    </div>

                    <div class="bg-slate-900 rounded-xl p-6 shadow-2xl border border-slate-700">
                        <div class="grid lg:grid-cols-3 gap-6">
                            <!-- Controles -->
                            <div class="lg:col-span-1 space-y-4">
                                <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                                    <h3 class="text-white font-bold mb-2 flex items-center gap-2">
                                        <i data-lucide="play-circle" class="text-kawn-base"></i> Control de Simulación
                                    </h3>
                                    <p class="text-slate-400 text-sm mb-4">Observa paso a paso cómo se forma, valida y
                                        opera un Order Block Alcista.</p>

                                    <div class="space-y-2">
                                        <button onclick="window.runSimulationStep(1)"
                                            class="w-full text-left px-4 py-3 bg-slate-700 hover:bg-slate-600 rounded text-sm text-slate-200 transition flex justify-between group">
                                            <span>1. Consolidación</span>
                                            <i data-lucide="activity"
                                                class="w-4 h-4 opacity-0 group-hover:opacity-100 transition"></i>
                                        </button>
                                        <button onclick="window.runSimulationStep(2)"
                                            class="w-full text-left px-4 py-3 bg-slate-700 hover:bg-slate-600 rounded text-sm text-slate-200 transition flex justify-between group">
                                            <span>2. Barrido (Liquidez)</span>
                                            <i data-lucide="arrow-down"
                                                class="w-4 h-4 text-red-400 opacity-0 group-hover:opacity-100 transition"></i>
                                        </button>
                                        <button onclick="window.runSimulationStep(3)"
                                            class="w-full text-left px-4 py-3 bg-slate-700 hover:bg-slate-600 rounded text-sm text-slate-200 transition flex justify-between group">
                                            <span>3. Desplazamiento (OB)</span>
                                            <i data-lucide="arrow-up"
                                                class="w-4 h-4 text-green-400 opacity-0 group-hover:opacity-100 transition"></i>
                                        </button>
                                        <button onclick="window.runSimulationStep(4)"
                                            class="w-full text-left px-4 py-3 bg-slate-700 hover:bg-slate-600 rounded text-sm text-slate-200 transition flex justify-between group">
                                            <span>4. Retest (Entrada)</span>
                                            <i data-lucide="target"
                                                class="w-4 h-4 text-kawn-base opacity-0 group-hover:opacity-100 transition"></i>
                                        </button>
                                        <button onclick="window.runSimulationStep(5)"
                                            class="w-full text-left px-4 py-3 bg-slate-700 hover:bg-slate-600 rounded text-sm text-slate-200 transition flex justify-between group">
                                            <span>5. Expansión</span>
                                            <i data-lucide="rocket"
                                                class="w-4 h-4 text-yellow-400 opacity-0 group-hover:opacity-100 transition"></i>
                                        </button>
                                    </div>
                                    <button onclick="window.resetSimulation()"
                                        class="mt-4 w-full py-2 border border-slate-600 text-slate-400 hover:text-white hover:border-slate-400 rounded text-xs uppercase tracking-wider transition">Resetear</button>
                                </div>
                                <div id="sim-feedback"
                                    class="bg-kawn-deep/20 border border-kawn-base/30 p-4 rounded-lg text-sm text-kawn-light">
                                    Selecciona el paso 1 para comenzar.
                                </div>
                            </div>

                            <!-- Gráfico Plotly -->
                            <div
                                class="lg:col-span-2 bg-slate-800 rounded-lg border border-slate-700 overflow-hidden relative">
                                <div id="obSimulatorChart" class="w-full h-[450px]"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Identificación y Validación -->
                <section id="identificacion" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 border-l-4 border-kawn-base pl-4">Identificación y
                        Validación</h2>

                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="content-card">
                            <h3 class="font-bold text-slate-900 mb-3 flex items-center gap-2">
                                <span
                                    class="bg-kawn-base text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
                                Identificación (OB Alcista)
                            </h3>
                            <ul class="space-y-3 text-sm">
                                <li class="flex items-start gap-2">
                                    <i data-lucide="check-circle-2"
                                        class="w-4 h-4 text-kawn-base mt-1 flex-shrink-0"></i>
                                    <span><strong>Vela bajista previa:</strong> Última vela roja antes de un rally
                                        fuerte.</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i data-lucide="check-circle-2"
                                        class="w-4 h-4 text-kawn-base mt-1 flex-shrink-0"></i>
                                    <span><strong>Barrido de Liquidez:</strong> Debe haber tomado un mínimo previo o
                                        stops.</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i data-lucide="check-circle-2"
                                        class="w-4 h-4 text-kawn-base mt-1 flex-shrink-0"></i>
                                    <span><strong>Desplazamiento:</strong> Movimiento posterior violento que deja
                                        ineficiencias.</span>
                                </li>
                            </ul>
                        </div>

                        <div class="content-card">
                            <h3 class="font-bold text-slate-900 mb-3 flex items-center gap-2">
                                <span
                                    class="bg-kawn-base text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                                Validación (Confirmación)
                            </h3>
                            <ul class="space-y-3 text-sm">
                                <li class="flex items-start gap-2">
                                    <i data-lucide="shield-check" class="w-4 h-4 text-kawn-dark mt-1 flex-shrink-0"></i>
                                    <span><strong>Romper Estructura (BOS):</strong> El precio debe superar el máximo de
                                        la vela OB.</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i data-lucide="shield-check" class="w-4 h-4 text-kawn-dark mt-1 flex-shrink-0"></i>
                                    <span><strong>Fair Value Gap (FVG):</strong> El impulso debe dejar huecos sin
                                        negociar.</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i data-lucide="shield-check" class="w-4 h-4 text-kawn-dark mt-1 flex-shrink-0"></i>
                                    <span><strong>Carácter del movimiento:</strong> Rápido y decidido, no lento y
                                        solapado.</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- Entrada Óptima y Calculadora -->
                <section id="entrada-optima" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 border-l-4 border-kawn-base pl-4">La Entrada
                        Óptima</h2>

                    <div class="content-card mb-8">
                        <p class="mb-4">
                            La entrada suele ocurrir en el cuerpo de la vela, o en su 50%. Pero lo crucial es el
                            contexto de <strong>Descuento vs. Premium</strong>.
                        </p>
                        <blockquote>
                            "La regla general en SMC es comprar solo en descuento y vender solo en premium. Para una
                            compra, el OB debe estar por debajo del 50% del rango del impulso."
                        </blockquote>
                    </div>

                    <!-- Calculadora Interactiva Premium/Discount -->
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                        <div class="bg-slate-900 p-4 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="text-white font-bold flex items-center gap-2"><i data-lucide="percent"
                                    class="text-kawn-base"></i> Calculadora Premium / Discount</h3>
                            <span class="text-xs text-slate-400">HERRAMIENTA INTERACTIVA</span>
                        </div>
                        <div class="p-6 grid md:grid-cols-2 gap-8">
                            <div>
                                <p class="text-sm text-slate-600 mb-4">Ingresa el rango del impulso (Mínimo y Máximo)
                                    para visualizar dónde está tu Order Block y si es válido para operar.</p>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Precio
                                            Máximo (Impulso)</label>
                                        <input type="number" id="highPrice" value="1.1000" step="0.0001"
                                            class="w-full border border-slate-300 rounded p-2 font-mono text-slate-800 focus:ring-2 focus:ring-kawn-base outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Precio
                                            Mínimo (Impulso)</label>
                                        <input type="number" id="lowPrice" value="1.0900" step="0.0001"
                                            class="w-full border border-slate-300 rounded p-2 font-mono text-slate-800 focus:ring-2 focus:ring-kawn-base outline-none">
                                    </div>
                                    <div class="pt-2">
                                        <label class="block text-xs font-bold text-kawn-dark uppercase mb-1">Tu Nivel de
                                            Entrada (OB)</label>
                                        <input type="number" id="entryPrice" value="1.0920" step="0.0001"
                                            class="w-full border-2 border-kawn-base/50 rounded p-2 font-mono text-slate-800 focus:ring-2 focus:ring-kawn-base outline-none bg-kawn-light/20">
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-col justify-center">
                                <div
                                    class="relative h-64 w-16 mx-auto bg-slate-100 rounded-lg border border-slate-300 flex flex-col">
                                    <!-- Premium Zone -->
                                    <div
                                        class="flex-1 bg-red-100/80 border-b border-red-300 flex items-center justify-center relative">
                                        <span class="absolute -right-24 text-xs font-bold text-red-500">Premium
                                            (Ventas)</span>
                                    </div>
                                    <!-- EQ Line -->
                                    <div class="h-0.5 bg-slate-800 w-full relative">
                                        <span class="absolute -left-12 -top-2 text-xs font-bold text-slate-800">EQ
                                            50%</span>
                                        <span id="eqPriceDisplay"
                                            class="absolute -right-20 -top-2 text-xs font-mono text-slate-800">1.0950</span>
                                    </div>
                                    <!-- Discount Zone -->
                                    <div
                                        class="flex-1 bg-green-100/80 border-t border-green-300 flex items-center justify-center relative">
                                        <span class="absolute -right-24 text-xs font-bold text-green-600">Descuento
                                            (Compras)</span>
                                    </div>

                                    <!-- Entry Marker -->
                                    <div id="entryMarker"
                                        class="absolute w-24 h-8 bg-kawn-base text-white text-xs flex items-center justify-center font-bold rounded shadow-lg -left-4 transition-all duration-500"
                                        style="bottom: 20%;">
                                        Tu Entrada
                                    </div>
                                </div>
                                <div id="pd-feedback"
                                    class="text-center mt-4 text-sm font-bold text-slate-700 bg-slate-100 p-2 rounded">
                                    Calculando...
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- NUEVA SECCIÓN: Confirmación en Temporalidades Menores -->
                <section id="temporalidades" class="mb-20 scroll-mt-28">
                    <h2
                        class="text-2xl font-bold text-slate-900 mb-6 border-l-4 border-kawn-base pl-4 flex justify-between items-center">
                        El Secreto del Refinamiento (Fractalidad)
                        <button onclick="window.askAI('Explica la fractalidad en trading de forma simple')"
                            class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full hover:bg-indigo-200 transition flex items-center gap-1 ai-trigger-btn">
                            <i data-lucide="sparkles" class="w-3 h-3"></i> ✨ Explicar con IA
                        </button>
                    </h2>

                    <div class="content-card">
                        <p class="mb-4">
                            Un Order Block en H4 puede ser una zona de 30 o 40 pips. Entrar ciegamente aumenta tu
                            riesgo. La clave profesional es <strong>bajar de temporalidad</strong> (Ltf - Lower
                            Timeframe) cuando el precio toca tu zona de H4, y buscar una confirmación estructural
                            pequeña.
                        </p>
                        <p class="text-sm text-slate-500 mb-4 italic">
                            Esto se conoce como <strong>ChoCH (Change of Character)</strong>: el primer cambio de
                            estructura a favor de tu dirección en M5 o M15.
                        </p>
                    </div>

                    <!-- COMPONENTE INTERACTIVO: Lupa de Fractalidad -->
                    <div class="bg-slate-900 rounded-xl p-8 shadow-2xl relative overflow-hidden group">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-white font-bold text-lg"><i data-lucide="zoom-in"
                                    class="inline w-5 h-5 mr-2 text-kawn-base"></i> Lupa de Estructura Interna</h3>
                            <span class="bg-slate-700 text-xs text-white px-2 py-1 rounded">Mueve el mouse / toca el
                                gráfico</span>
                        </div>

                        <!-- Contenedor del Gráfico Base (H4) -->
                        <div class="relative w-full h-64 bg-slate-800 rounded border border-slate-600 flex items-center justify-center cursor-crosshair overflow-hidden"
                            id="fractal-container">

                            <!-- Representación Abstracta de Vela H4 -->
                            <div
                                class="absolute left-10 top-20 w-8 h-32 bg-red-500 opacity-50 flex items-center justify-center text-xs text-white font-bold">
                                Vela Bajista</div>
                            <div
                                class="absolute left-20 bottom-10 w-full h-40 bg-gradient-to-t from-kawn-base/20 to-transparent border-b-2 border-kawn-base">
                            </div>

                            <!-- Texto HTF -->
                            <div class="absolute top-4 left-4 text-slate-400 font-mono text-xs">H4 Timeframe (Macro)
                            </div>

                            <!-- El Order Block (Zona Activa) -->
                            <div class="absolute left-[30%] top-[40%] w-[40%] h-[20%] bg-kawn-base/30 border border-kawn-base flex items-center justify-center hover:bg-kawn-base/40 transition-colors"
                                id="htf-ob">
                                <span class="text-kawn-light font-bold text-sm tracking-widest">ORDER BLOCK H4</span>
                            </div>

                            <!-- LUPA (Overlay) -->
                            <div id="magnifier"
                                class="absolute w-48 h-48 rounded-full border-4 border-white shadow-2xl bg-slate-900 overflow-hidden hidden transform -translate-x-1/2 -translate-y-1/2 pointer-events-none z-20">
                                <!-- Contenido LTF (M5) dentro de la lupa -->
                                <div
                                    class="relative w-[600px] h-[400px] -ml-[200px] -mt-[100px] bg-slate-900 flex items-center justify-center">
                                    <!-- Dibujo de estructura M5 (SVG) -->
                                    <svg width="100%" height="100%" viewBox="0 0 400 200"
                                        class="stroke-white stroke-2 fill-none">
                                        <!-- Bajada -->
                                        <path d="M50,50 L100,150 L120,130 L150,160" stroke="#ef4444" />
                                        <!-- ChoCH -->
                                        <path d="M150,160 L180,80" stroke="#10b981" stroke-width="3" />
                                        <!-- Retest -->
                                        <path d="M180,80 L200,120" stroke="#fbbf24" />
                                        <!-- Explosion -->
                                        <path d="M200,120 L350,20" stroke="#10b981" stroke-width="4" />

                                        <text x="190" y="70" fill="#10b981" font-size="12" font-weight="bold">ChoCH
                                            (M5)</text>
                                        <text x="210" y="130" fill="#fbbf24" font-size="10">Entrada Refinada</text>
                                    </svg>
                                    <div
                                        class="absolute top-2 right-4 text-kawn-base font-mono text-xs font-bold bg-slate-800 px-2 py-1 rounded">
                                        M5 Timeframe</div>
                                </div>
                            </div>

                        </div>
                        <p class="text-slate-400 text-xs mt-4 text-center">
                            Pasa el cursor sobre la zona del "ORDER BLOCK H4" para ver qué ocurre en M5. ¡Ahí está tu
                            entrada real!
                        </p>
                    </div>
                </section>

                <!-- NUEVA SECCIÓN: Breaker Blocks -->
                <section id="breaker-blocks" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 border-l-4 border-kawn-base pl-4">Breaker Blocks:
                        Cuando el OB Falla</h2>

                    <div class="grid md:grid-cols-2 gap-8 mb-8">
                        <div class="content-card mb-0">
                            <h3 class="font-bold text-slate-800 mb-4">No tires tus OBs rotos a la basura</h3>
                            <p class="text-sm leading-6 mb-4">
                                A veces, el Smart Money no respeta un Order Block y lo atraviesa con fuerza. ¿Significa
                                que tu análisis fue inútil? ¡No!
                            </p>
                            <p class="text-sm leading-6">
                                Un OB violado se convierte en un <strong>Breaker Block</strong>. Funciona bajo el
                                principio de polaridad: lo que era soporte (demanda) ahora actúa como resistencia
                                (oferta), o viceversa.
                            </p>
                            <div class="mt-4 p-3 bg-red-50 border-l-4 border-red-400 text-xs text-red-700">
                                <strong>Regla de Oro:</strong> Solo considera un Breaker si la ruptura fue con fuerza y
                                desplazamiento, no solo con mechas.
                            </div>
                        </div>

                        <!-- Simulador Breaker Block -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 border-b pb-2">
                                Laboratorio de Ruptura</h4>
                            <div id="breakerChart" class="w-full h-48"></div>

                            <div class="flex gap-2 mt-4">
                                <button onclick="window.simulateBreaker('respect')"
                                    class="flex-1 py-2 text-xs font-bold bg-kawn-light text-kawn-deep rounded hover:bg-kawn-base hover:text-white transition">
                                    Respetar OB
                                </button>
                                <button onclick="window.simulateBreaker('break')"
                                    class="flex-1 py-2 text-xs font-bold bg-slate-200 text-slate-700 rounded hover:bg-red-500 hover:text-white transition">
                                    Romper (Crear Breaker)
                                </button>
                            </div>
                            <p id="breaker-status" class="text-center text-xs mt-3 h-4 text-slate-500 font-medium"></p>
                        </div>
                    </div>
                </section>

                <!-- Gestión de Riesgo y Salidas -->
                <section id="riesgo" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 border-l-4 border-kawn-base pl-4">Gestión de
                        Riesgo y Objetivos</h2>

                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-red-50 border border-red-100 rounded-xl p-6">
                            <h3 class="font-bold text-red-800 mb-3 flex items-center gap-2"><i
                                    data-lucide="shield-alert" class="w-5 h-5"></i> Stop Loss</h3>
                            <div class="space-y-4">
                                <div>
                                    <h4 class="font-bold text-red-700 text-sm">Opción A: Ceñido (Agresivo)</h4>
                                    <p class="text-sm text-red-600/80">En el 50% del Order Block. Alto riesgo/beneficio,
                                        pero vulnerable a mechas.</p>
                                </div>
                                <div>
                                    <h4 class="font-bold text-red-700 text-sm">Opción B: Conservador (Seguro)</h4>
                                    <p class="text-sm text-red-600/80">Debajo del mínimo de la vela (o estructura).
                                        Evita barridas comunes.</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-green-50 border border-green-100 rounded-xl p-6">
                            <h3 class="font-bold text-green-800 mb-3 flex items-center gap-2"><i data-lucide="crosshair"
                                    class="w-5 h-5"></i> Take Profit</h3>
                            <p class="text-sm text-green-700/80 mb-3">
                                El objetivo natural es la <strong>liquidez externa opuesta</strong> (el máximo anterior
                                si compramos).
                            </p>
                            <ul class="list-disc pl-5 text-sm text-green-700/80 space-y-1">
                                <li>Máximos/Mínimos del día/semana.</li>
                                <li>Extensiones Fibonacci (100%, 161.8%).</li>
                                <li>Relación R:B fija (1:3 mínimo).</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- Glosario -->
                <section id="glosario" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 border-l-4 border-kawn-base pl-4">Glosario
                        Esencial</h2>
                    <div id="glossary-container" class="space-y-3">
                        <!-- Accordion Items generated by JS -->
                    </div>
                </section>

                <!-- QUIZ -->
                <section id="quiz" class="mb-20 scroll-mt-28">
                    <div class="bg-slate-900 rounded-xl p-8 shadow-2xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-8 opacity-10 pointer-events-none">
                            <i data-lucide="award" class="w-48 h-48 text-white"></i>
                        </div>

                        <div class="relative z-10">
                            <h2 class="text-2xl font-bold text-white mb-2">Validación del Conocimiento</h2>
                            <p class="text-slate-400 mb-8">Demuestra tu dominio sobre los Order Blocks y conceptos
                                avanzados.</p>

                            <div id="quiz-container" class="space-y-6">
                                <!-- Questions generated by JS -->
                            </div>

                            <div id="quiz-result"
                                class="hidden mt-8 p-4 bg-kawn-base/20 border border-kawn-base rounded-lg text-white text-center font-bold">
                            </div>
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-12 mt-20 border-t border-slate-800">
        <div
            class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="kawn-logo-container">
                <div class="kawn-icon" style="transform: scale(0.8);"><span>K</span></div>
                <div class="kawn-text">
                    <span class="kawn-title text-white">KAWNBIT</span>
                    <span class="kawn-subtitle">QUANTITATIVE TRADING COMMUNITY</span>
                </div>
            </div>
            <div class="text-center md:text-right text-xs">
                <p>&copy; <span id="current-year"></span> KawnBit. Todos los derechos reservados.</p>
                <p class="opacity-50 mt-1">Material educativo. El trading conlleva riesgos significativos.</p>
            </div>
        </div>
    </footer>

    <!-- AI Mentor Float -->
    <button id="ai-toggle"
        class="fixed bottom-6 right-6 z-50 bg-slate-900 text-white p-4 rounded-full shadow-glow hover:scale-105 transition-transform flex items-center gap-2 group"
        aria-label="Abrir mentor IA">
        <i data-lucide="bot" class="w-6 h-6 text-kawn-base"></i>
        <span
            class="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-300 whitespace-nowrap text-sm font-bold">Mentor
            IA</span>
    </button>

    <!-- AI Modal -->
    <div id="ai-modal"
        class="hidden fixed bottom-24 right-6 w-80 md:w-96 h-[500px] bg-white rounded-xl shadow-2xl border border-slate-200 z-50 flex flex-col animate-fade-in-up">
        <div class="bg-slate-900 p-4 rounded-t-xl flex justify-between items-center text-white">
            <div class="flex items-center gap-2">
                <i data-lucide="bot" class="text-kawn-base"></i>
                <span class="font-bold text-sm">Mentor KawnBit</span>
            </div>
            <button id="close-ai" class="hover:text-kawn-base" aria-label="Cerrar mentor"><i data-lucide="x"
                    class="w-5 h-5"></i></button>
        </div>
        <div id="chat-history" class="flex-1 overflow-y-auto p-4 bg-slate-50 flex flex-col gap-3">
            <div class="ai-message chat-message">
                Hola. Soy tu especialista en SMC. Pregúntame sobre Order Blocks, validación o riesgos.
            </div>
        </div>
        <div class="p-4 border-t border-slate-200 bg-white rounded-b-xl">
            <form id="ai-form" class="flex gap-2">
                <input type="text" id="user-input" placeholder="Escribe tu duda..."
                    class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-kawn-base"
                    aria-label="Escribe tu pregunta">
                <button type="submit"
                    class="bg-kawn-base hover:bg-kawn-dark text-white p-2 rounded-lg transition-colors"
                    aria-label="Enviar mensaje">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Scripts de Funcionalidad Robustos (V5) -->
    <script>
        // 1. ESPERAR CARGA DEL DOM Y LIBRERÍAS
        window.addEventListener('load', () => {
            console.log("KawnBit App: Librerías cargadas. Iniciando módulos...");

            // Inicializar Iconos Lucide
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Año Footer
            document.getElementById('current-year').textContent = new Date().getFullYear();

            // === A. INICIALIZACIÓN DE GRÁFICAS (Chart.js & Plotly) ===

            // Chart.js: Anatomía
            const ctxAnatomy = document.getElementById('anatomyChart').getContext('2d');
            if (typeof Chart !== 'undefined') {
                new Chart(ctxAnatomy, {
                    type: 'bar',
                    data: {
                        labels: ['Consolidación', 'Trampa', 'OB (Vela)', 'Desplazamiento', 'Re-Test'],
                        datasets: [{
                            label: 'Volumen Institucional',
                            data: [20, 45, 85, 95, 40],
                            backgroundColor: ['#cbd5e1', '#ef4444', '#0f172a', '#14b8a6', '#ccfbf1'],
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 10 } } } }
                    }
                });
            }

            // Plotly: Inicialización
            const initialCandles = {
                x: [1, 2, 3],
                open: [100, 101, 100.5],
                high: [101.5, 101.5, 101],
                low: [99.5, 100, 99.8],
                close: [101, 100.5, 100.2]
            };

            // Definir función de dibujo globalmente para Plotly
            window.drawPlot = function (data) {
                if (typeof Plotly === 'undefined') return;
                const trace = {
                    x: data.x, close: data.close,
                    decreasing: { line: { color: '#ef4444' }, fillcolor: '#ef4444' },
                    increasing: { line: { color: '#10b981' }, fillcolor: '#10b981' },
                    high: data.high, low: data.low, open: data.open, type: 'candlestick'
                };
                const layout = {
                    dragmode: false, margin: { r: 10, t: 25, b: 40, l: 40 }, showlegend: false,
                    xaxis: { showgrid: false, zeroline: false, rangeslider: { visible: false } },
                    yaxis: { showgrid: true, gridcolor: '#334155' },
                    plot_bgcolor: '#1e293b', paper_bgcolor: '#1e293b', font: { color: '#94a3b8' }, shapes: []
                };
                // Rectángulo OB
                if (data.x.length >= 6) {
                    layout.shapes.push({ type: 'rect', x0: 3.5, y0: 98, x1: 15, y1: 99.5, fillcolor: '#14b8a6', opacity: 0.2, line: { width: 0 } });
                    layout.annotations = [{ x: 4, y: 99.5, xref: 'x', yref: 'y', text: 'Order Block', showarrow: false, font: { color: '#14b8a6' } }];
                }

                // Comprobación defensiva antes de llamar a Plotly
                const chartDiv = document.getElementById('obSimulatorChart');
                if (chartDiv) {
                    Plotly.newPlot('obSimulatorChart', [trace], layout, { staticPlot: true, responsive: true });
                }
            }

            // Dibujar inicial
            window.drawPlot(initialCandles);

            // Inicializar Breaker Chart
            const breakerTraceBase = {
                x: [1, 2, 3, 4, 5], close: [100, 102, 101, 104, 102], high: [101, 103, 102, 105, 103], low: [99, 100, 100, 101, 101], open: [99, 100, 102, 101, 104], type: 'candlestick', decreasing: { line: { color: '#ef4444' } }, increasing: { line: { color: '#10b981' } }
            };
            const layoutBreaker = {
                dragmode: false, margin: { r: 10, t: 10, b: 30, l: 30 }, showlegend: false, xaxis: { showgrid: false, rangeslider: { visible: false } }, yaxis: { showgrid: true }, plot_bgcolor: '#fff', paper_bgcolor: '#fff', shapes: [{ type: 'rect', x0: 2.5, y0: 100, x1: 10, y1: 101, fillcolor: '#14b8a6', opacity: 0.2, line: { width: 0 } }]
            };
            if (typeof Plotly !== 'undefined') {
                const breakerDiv = document.getElementById('breakerChart');
                if (breakerDiv) {
                    Plotly.newPlot('breakerChart', [breakerTraceBase], layoutBreaker, { staticPlot: true, responsive: true });
                }
            }

            // === B. LÓGICA DE SIMULACIÓN (Globalizada) ===
            window.runSimulationStep = function (step) {
                const feedback = document.getElementById('sim-feedback');
                let currentData = JSON.parse(JSON.stringify(initialCandles));
                switch (step) {
                    case 1: feedback.innerHTML = "<strong>Fase 1: Consolidación.</strong> Acumulación silenciosa."; feedback.className = "bg-slate-700 p-4 rounded-lg text-sm text-slate-200"; window.drawPlot(currentData); break;
                    case 2: currentData.x.push(4); currentData.open.push(100.2); currentData.high.push(100.5); currentData.low.push(98); currentData.close.push(98.5); feedback.innerHTML = "<strong>Fase 2: Barrido.</strong> Rompe soporte y toma liquidez (Stops)."; feedback.className = "bg-red-900/50 border border-red-500 p-4 rounded-lg text-sm text-red-100"; window.drawPlot(currentData); break;
                    case 3: currentData.x.push(4, 5, 6); currentData.open.push(100.2, 98.5, 102); currentData.high.push(100.5, 102.5, 105); currentData.low.push(98, 98.5, 101.5); currentData.close.push(98.5, 102, 104.5); feedback.innerHTML = "<strong>Fase 3: Desplazamiento.</strong> El precio dispara dejando un OB válido."; feedback.className = "bg-green-900/50 border border-green-500 p-4 rounded-lg text-sm text-green-100"; window.drawPlot(currentData); break;
                    case 4: currentData.x.push(4, 5, 6, 7, 8, 9); currentData.open.push(100.2, 98.5, 102, 104.5, 103, 101.5); currentData.high.push(100.5, 102.5, 105, 105, 103.5, 102); currentData.low.push(98, 98.5, 101.5, 102.8, 101, 99); currentData.close.push(98.5, 102, 104.5, 103, 101.5, 100); feedback.innerHTML = "<strong>Fase 4: Retest.</strong> Entrada en 99.00 (dentro del OB)."; feedback.className = "bg-kawn-deep p-4 rounded-lg text-sm text-white border border-kawn-base"; window.drawPlot(currentData); break;
                    case 5: currentData.x.push(4, 5, 6, 7, 8, 9, 10, 11); currentData.open.push(100.2, 98.5, 102, 104.5, 103, 101.5, 100, 106); currentData.high.push(100.5, 102.5, 105, 105, 103.5, 102, 106.5, 110); currentData.low.push(98, 98.5, 101.5, 102.8, 101, 99, 100, 105); currentData.close.push(98.5, 102, 104.5, 103, 101.5, 100, 106, 109); feedback.innerHTML = "<strong>Fase 5: Expansión.</strong> Take Profit alcanzado."; feedback.className = "bg-yellow-900/50 border border-yellow-500 p-4 rounded-lg text-sm text-yellow-100"; window.drawPlot(currentData); break;
                }
            };

            window.resetSimulation = function () { window.drawPlot(initialCandles); document.getElementById('sim-feedback').innerHTML = "Simulación reiniciada."; document.getElementById('sim-feedback').className = "bg-slate-700 p-4 rounded-lg text-sm text-slate-200"; };

            // === C. SIMULADOR BREAKER ===
            window.simulateBreaker = function (scenario) {
                const status = document.getElementById('breaker-status');
                let newData = JSON.parse(JSON.stringify(breakerTraceBase));
                let newLayout = JSON.parse(JSON.stringify(layoutBreaker));
                if (scenario === 'respect') {
                    newData.x.push(6, 7); newData.open.push(102, 103); newData.high.push(104, 106); newData.low.push(101.5, 102.5); newData.close.push(104, 105.5);
                    status.textContent = "El precio respetó el Order Block (Soporte)."; status.className = "text-center text-xs mt-3 h-4 text-kawn-dark font-bold"; newLayout.shapes[0].fillcolor = '#10b981';
                } else {
                    newData.x.push(6, 7, 8); newData.open.push(102, 99, 99); newData.high.push(102.5, 100, 101); newData.low.push(98, 98, 98); newData.close.push(98.5, 99.5, 98.2);
                    status.textContent = "¡Ruptura! El OB es ahora un Breaker (Resistencia)."; status.className = "text-center text-xs mt-3 h-4 text-red-600 font-bold"; newLayout.shapes[0].fillcolor = '#ef4444';
                }
                Plotly.react('breakerChart', [newData], newLayout);
            }

            // === D. INTERACTIVIDAD LUPA ===
            const fractalContainer = document.getElementById('fractal-container');
            const magnifier = document.getElementById('magnifier');
            fractalContainer.addEventListener('mousemove', function (e) {
                magnifier.classList.remove('hidden');
                const rect = fractalContainer.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                magnifier.style.left = `${x}px`;
                magnifier.style.top = `${y}px`;
                // Detección de área OB (aprox 30-70% ancho, 40-60% alto)
                const isOverOB = (x > rect.width * 0.3 && x < rect.width * 0.7 && y > rect.height * 0.4 && y < rect.height * 0.6);
                if (isOverOB) { magnifier.style.borderColor = '#10b981'; magnifier.style.boxShadow = '0 0 15px rgba(16, 185, 129, 0.5)'; }
                else { magnifier.style.borderColor = 'white'; magnifier.style.boxShadow = '0 0 10px rgba(255,255,255,0.2)'; }
            });
            fractalContainer.addEventListener('mouseleave', function () { magnifier.classList.add('hidden'); });

            // === E. GENERACIÓN DE TOC Y GLOSARIO ===
            // TOC
            const tocContainer = document.getElementById('toc-container');
            document.querySelectorAll('main section[id]').forEach(section => {
                const h2 = section.querySelector('h2');
                if (h2) {
                    const link = document.createElement('a'); link.href = `#${section.id}`; link.textContent = h2.textContent;
                    link.className = 'toc-link block py-2 pl-4 border-l-2 border-transparent text-slate-500 hover:text-slate-900 hover:border-kawn-base transition-all text-xs font-medium';
                    link.onclick = (e) => { e.preventDefault(); document.querySelector(link.getAttribute('href')).scrollIntoView({ behavior: 'smooth' }); };
                    tocContainer.appendChild(link);
                }
            });
            // Glosario
            const glossaryItems = [
                { t: "Order Block (OB)", d: "Huella institucional. Última vela contraria antes de un movimiento impulsivo fuerte." },
                { t: "Breaker Block", d: "Un Order Block que ha sido roto (invalidado) y cambia su polaridad. Soporte se vuelve resistencia." },
                { t: "ChoCH (Change of Character)", d: "El primer cambio de estructura menor (LTF) dentro de una zona mayor, confirmando el giro." },
                { t: "Fair Value Gap (FVG)", d: "Ineficiencia o vacío de liquidez dejado por un movimiento rápido donde no hubo contrapartida." },
                { t: "Mitigación", d: "El proceso por el cual el precio regresa a un OB para cerrar órdenes pendientes o reducir exposición." }
            ];
            const glosContainer = document.getElementById('glossary-container');
            glossaryItems.forEach((item, idx) => {
                const div = document.createElement('div'); div.className = "border border-slate-200 rounded-lg overflow-hidden";
                div.innerHTML = `<button onclick="window.toggleGlos(${idx})" class="w-full text-left px-4 py-3 bg-white hover:bg-slate-50 font-bold text-slate-700 flex justify-between items-center">${item.t}<i data-lucide="chevron-down" id="icon-${idx}" class="w-4 h-4 transition-transform"></i></button><div id="desc-${idx}" class="hidden px-4 py-3 bg-slate-50 text-sm text-slate-600 border-t border-slate-100 leading-relaxed">${item.d}</div>`;
                glosContainer.appendChild(div);
            });
            window.toggleGlos = function (idx) { document.getElementById(`desc-${idx}`).classList.toggle('hidden'); document.getElementById(`icon-${idx}`).classList.toggle('rotate-180'); };

            // === F. GENERACIÓN QUIZ (ACTUALIZADO CON EXPLICACIONES) ===
            const questions = [
                {
                    q: "¿Qué representa la 'anatomía' de un OB alcista?",
                    opts: ["Vela verde grande", "Última vela bajista antes de un impulso fuerte", "Un cruce de medias móviles"],
                    a: 1,
                    expl: "Un Order Block alcista se identifica específicamente como la última vela bajista (acumulación institucional) previa a un movimiento impulsivo al alza que genera un desequilibrio y rompe estructura (BOS)."
                },
                {
                    q: "Si un Order Block Alcista es roto con fuerza, ¿en qué se convierte?",
                    opts: ["En basura", "En un Breaker Block (Resistencia)", "En un FVG"],
                    a: 1,
                    expl: "Cuando un OB es invalidado por un movimiento fuerte, cambia su polaridad por el principio de mitigación. Se convierte en un Breaker Block: lo que era soporte (demanda) pasa a actuar como resistencia (oferta) para atrapar a los traders atrapados."
                },
                {
                    q: "¿Qué buscamos al bajar de temporalidad (H4 -> M15) dentro de un OB?",
                    opts: ["Más ruido", "Un ChoCH (Cambio de Carácter)", "Divergencia MACD"],
                    a: 1,
                    expl: "El refinamiento fractal busca confirmar la intención. Un ChoCH (Change of Character) en una temporalidad menor es la primera señal estructural de que el precio está respetando la zona mayor, permitiendo entradas con stops más ajustados."
                },
                {
                    q: "Si queremos comprar, ¿en qué zona debe estar el OB?",
                    opts: ["Premium (>50%)", "Descuento (<50%)", "No importa"],
                    a: 1,
                    expl: "La regla de oro institucional es: Comprar barato (Discount) y vender caro (Premium). Un OB alcista ubicado por encima del 50% del rango (Premium) tiene bajas probabilidades porque el precio no es atractivo para el Smart Money."
                }
            ];

            const quizContainer = document.getElementById('quiz-container');
            questions.forEach((q, idx) => {
                const qDiv = document.createElement('div'); qDiv.className = "bg-slate-800/50 p-4 rounded-lg border border-slate-700";
                qDiv.innerHTML = `<p class="font-bold text-white mb-3">${idx + 1}. ${q.q}</p><div class="space-y-2">${q.opts.map((opt, oIdx) => `<button onclick="window.checkAnswer(${idx}, ${oIdx}, this)" class="quiz-option w-full text-left px-3 py-2 rounded bg-slate-700 text-slate-300 text-sm hover:bg-slate-600 transition">${String.fromCharCode(65 + oIdx)}. ${opt}</button>`).join('')}</div><div id="fb-${idx}" class="hidden"></div>`;
                quizContainer.appendChild(qDiv);
            });

            let score = 0; let answered = new Set();

            window.checkAnswer = function (qIdx, oIdx, btn) {
                if (answered.has(qIdx)) return; answered.add(qIdx);
                const q = questions[qIdx];
                const correct = q.a;
                const feedback = document.getElementById(`fb-${qIdx}`);
                feedback.classList.remove('hidden');

                const explanationHTML = `<div class="mt-2 pt-2 border-t border-slate-600/50 text-sm font-normal opacity-90 leading-relaxed"><span class="block font-bold mb-1 underline">Por qué:</span>${q.expl}</div>`;

                if (oIdx === correct) {
                    score++;
                    btn.classList.add('selected', 'correct');
                    feedback.innerHTML = `<span class="block font-bold text-kawn-base text-sm mb-1">¡CORRECTO!</span> ${explanationHTML}`;
                    feedback.className = "mt-3 p-3 bg-slate-800 rounded border border-kawn-base text-slate-200 animate-fade-in-up";
                } else {
                    btn.classList.add('selected', 'incorrect');
                    feedback.innerHTML = `<span class="block font-bold text-red-400 text-sm mb-1">INCORRECTO. La opción correcta era la ${String.fromCharCode(65 + correct)}.</span> ${explanationHTML}`;
                    feedback.className = "mt-3 p-3 bg-slate-800 rounded border border-red-500/50 text-slate-200 animate-fade-in-up";
                }

                if (answered.size === questions.length) {
                    const res = document.getElementById('quiz-result');
                    res.textContent = `Puntuación Final: ${score} / ${questions.length}`;
                    res.classList.remove('hidden');
                }
            }

            // === G. FUNCIONES IA (LLM FEATURES - OPTIMIZADO) ===
            const gasEndpoint = "/.netlify/functions/gemini-proxy";

            // Helper para limpiar texto de entrada
            function sanitizeInput(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            // Helper para controlar estado de carga en botones
            function setButtonLoading(btnId, isLoading, originalText = "") {
                const btn = document.getElementById(btnId);
                if (!btn) return;

                if (isLoading) {
                    btn.disabled = true;
                    btn.dataset.originalText = btn.innerHTML; // Guardar texto original
                    btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Procesando...`;
                    lucide.createIcons(); // Re-inicializar iconos dinámicos
                } else {
                    btn.disabled = false;
                    btn.innerHTML = btn.dataset.originalText || originalText;
                    lucide.createIcons();
                }
            }

            async function callGemini(prompt, systemInstruction = "Eres un mentor experto en SMC Trading.") {
                try {
                    const response = await fetch(gasEndpoint, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemInstruction }] }
                        })
                    });

                    if (!response.ok) {
                        console.warn("API Error Status:", response.status);
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || data.result || "No se pudo obtener una respuesta.";

                } catch (e) {
                    console.error("Gemini Error:", e);
                    return null; // Retorna null para activar el fallback
                }
            }

            // 1. Feature: Generar Escenario Aleatorio
            window.generateScenario = async function () {
                const outputDiv = document.getElementById('ai-scenario-output');
                outputDiv.classList.remove('hidden');
                outputDiv.innerHTML = `<span class="animate-pulse">🎲 Generando reto con IA...</span>`;

                // Activar estado loading en botón
                setButtonLoading('btn-generate-scenario', true);

                const prompt = "Genera un escenario de trading corto y desafiante (2-3 frases) sobre Order Blocks y Liquidez para que el estudiante analice. No des la solución, solo el escenario.";

                let text = await callGemini(prompt);

                // Fallback robusto
                if (!text) {
                    text = "<span class='text-yellow-500'>(Modo Demo - Sin Conexión)</span> Estás en M15. El precio acaba de barrer un máximo previo con mecha, pero el cuerpo cerró abajo. Inmediatamente ves una vela envolvente bajista que rompe estructura. ¿Qué harías?";
                }

                outputDiv.innerHTML = `<p class="font-bold text-purple-400 mb-1">Escenario de Reto:</p>${text}`;

                // Restaurar botón
                setButtonLoading('btn-generate-scenario', false);
            };

            // 2. Feature: Analizar Mercado (Sentimiento)
            window.analyzeMarket = async function () {
                const inputElement = document.getElementById('market-desc');
                const rawInput = inputElement.value;
                const outputDiv = document.getElementById('ai-analysis-output');

                if (!rawInput.trim()) return;

                // Sanitizar input antes de usarlo
                const cleanInput = sanitizeInput(rawInput);

                outputDiv.classList.remove('hidden');
                outputDiv.innerHTML = `<span class="animate-pulse">🧠 Analizando estructura...</span>`;

                setButtonLoading('btn-analyze-market', true);

                const prompt = `Analiza este contexto de mercado desde la perspectiva de Smart Money Concepts (SMC) y da un consejo breve: "${cleanInput}"`;

                let text = await callGemini(prompt);

                if (!text) {
                    text = "<span class='text-yellow-500'>(Modo Demo - Sin Conexión)</span> Basado en tu descripción, parece un escenario de posible reversión si el gap no se llena de inmediato. Busca un Order Block en temporalidad menor para confirmar la entrada.";
                }

                outputDiv.innerHTML = `<p class="font-bold text-blue-400 mb-1">Análisis Institucional:</p>${text}`;
                setButtonLoading('btn-analyze-market', false);
            };

            // 3. Feature: Preguntar al Mentor (Contextual)
            window.askAI = async function (query) {
                const aiToggle = document.getElementById('ai-toggle');
                const aiModal = document.getElementById('ai-modal');
                aiModal.classList.remove('hidden');

                // Simular que el usuario escribió la pregunta
                addMessage(query, 'user');
                const loadingId = addMessage('Consultando al mentor...', 'ai', true);

                // Deshabilitar temporalmente los triggers para evitar spam
                document.querySelectorAll('.ai-trigger-btn').forEach(btn => btn.disabled = true);

                let text = await callGemini(query, "Responde brevemente y con una analogía didáctica sobre trading.");

                document.getElementById(loadingId).remove();

                if (!text) {
                    text = "<span class='text-xs text-yellow-600 mb-1 block'>(Modo Demo activado por fallo de red)</span> " + (query.includes("fractalidad") ? "Imagina el mercado como una muñeca rusa (Matrioska). Dentro de una vela grande de H4, hay tendencias enteras ocurriendo en M5. Refinar es abrir la muñeca grande para encontrar el punto exacto en la pequeña." : "Un Order Block es como una huella en la arena. Nos muestra dónde pisó fuerte el 'elefante' (institución) para que podamos seguir su camino antes de que la marea (el precio) borre el rastro.");
                }

                addMessage(text, 'ai');

                // Rehabilitar botones
                document.querySelectorAll('.ai-trigger-btn').forEach(btn => btn.disabled = false);
            };

            // === H. CHATBOT IA ===
            const aiToggle = document.getElementById('ai-toggle');
            const aiModal = document.getElementById('ai-modal');
            const closeAi = document.getElementById('close-ai');
            const aiForm = document.getElementById('ai-form');
            const chatHistory = document.getElementById('chat-history');

            aiToggle.onclick = () => aiModal.classList.remove('hidden');
            closeAi.onclick = () => aiModal.classList.add('hidden');

            function addMessage(text, sender, loading = false) {
                const div = document.createElement('div');
                div.className = `${sender === 'user' ? 'user-message' : 'ai-message'} chat-message ${loading ? 'animate-pulse' : ''}`;
                div.id = loading ? 'loading-msg' : `msg-${Date.now()}`;

                // Permitir HTML seguro en mensajes de IA (para el tag de Demo)
                if (sender === 'ai') {
                    div.innerHTML = text;
                } else {
                    div.textContent = text;
                }

                chatHistory.appendChild(div);
                // Auto-scroll al fondo
                chatHistory.scrollTop = chatHistory.scrollHeight;
                return div.id;
            }

            aiForm.onsubmit = async (e) => {
                e.preventDefault();
                const input = document.getElementById('user-input');
                const rawText = input.value.trim();
                if (!rawText) return;

                // Sanitizar
                const cleanText = sanitizeInput(rawText);

                addMessage(cleanText, 'user');
                input.value = '';
                const loadingId = addMessage('Escribiendo...', 'ai', true);

                let responseText = await callGemini(cleanText);

                document.getElementById(loadingId).remove();

                if (!responseText) {
                    responseText = "<span class='text-xs text-yellow-600 block mb-1'>(Modo Demo - Sin Conexión)</span> Interesante pregunta. En SMC, siempre priorizamos la estructura sobre el indicador. Si tienes dudas, espera a que el precio te muestre su mano (confirmación).";
                }

                addMessage(responseText, 'ai');
            };
        });

        // Calculadora PD Global
        window.calculatePD = function () {
            const high = parseFloat(document.getElementById('highPrice').value);
            const low = parseFloat(document.getElementById('lowPrice').value);
            const entry = parseFloat(document.getElementById('entryPrice').value);
            const feedback = document.getElementById('pd-feedback');
            const marker = document.getElementById('entryMarker');
            if (isNaN(high) || isNaN(low) || isNaN(entry)) return;
            const eq = (high + low) / 2;
            document.getElementById('eqPriceDisplay').textContent = eq.toFixed(4);
            let percentage = ((entry - low) / (high - low)) * 100;
            if (percentage > 100) percentage = 100; if (percentage < 0) percentage = 0;
            marker.style.bottom = `${percentage}%`;
            if (entry < eq) { feedback.textContent = "Zona de DESCUENTO. ✅ Válido para COMPRAS."; feedback.className = "text-center mt-4 text-sm font-bold text-green-700 bg-green-100 p-2 rounded border border-green-200"; marker.classList.remove('bg-red-500'); marker.classList.add('bg-kawn-base'); }
            else { feedback.textContent = "Zona PREMIUM. ❌ Evita COMPRAR aquí."; feedback.className = "text-center mt-4 text-sm font-bold text-red-700 bg-red-100 p-2 rounded border border-red-200"; marker.classList.remove('bg-kawn-base'); marker.classList.add('bg-red-500'); }
        }
        // Listeners Calculadora
        document.querySelectorAll('#highPrice, #lowPrice, #entryPrice').forEach(el => el.addEventListener('input', window.calculatePD));

        // Menú Móvil Global
        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            const aside = document.querySelector('aside');
            aside.classList.toggle('hidden'); aside.classList.toggle('fixed'); aside.classList.toggle('inset-0'); aside.classList.toggle('bg-white'); aside.classList.toggle('z-40'); aside.classList.toggle('p-6');
        });

        // Resize Fix Global
        window.onresize = () => {
            if (typeof Plotly !== 'undefined') {
                const obChart = document.getElementById('obSimulatorChart');
                const brChart = document.getElementById('breakerChart');
                if (obChart) Plotly.Plots.resize(obChart);
                if (brChart) Plotly.Plots.resize(brChart);
            }
        };
    </script>
</body>

</html>