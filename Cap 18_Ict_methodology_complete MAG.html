<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KawnBit Magazine | Capítulo 18: SMT Divergence (Edición Robusta)</title>
    <meta name="description" content="Guía avanzada sobre el Smart Money Tool (SMT) potenciada por Google Gemini.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Dependencies Check Logic could go here, but using CDN for simplicity -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kawn: {
                            light: '#ccfbf1',
                            base: '#2dd4bf', 
                            dark: '#0f766e', 
                            deep: '#115e59', 
                            accent: '#14b8a6'
                        },
                        slate: {
                            850: '#1e293b',
                        },
                        forex: {
                            dxy: '#f59e0b',
                            eur: '#3b82f6',
                            gbp: '#8b5cf6'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'draw': 'draw 2s ease-out forwards',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        draw: {
                            '0%': { strokeDasharray: '1000', strokeDashoffset: '1000' },
                            '100%': { strokeDasharray: '1000', strokeDashoffset: '0' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; color: #334155; }
        h1, h2, h3, h4, h5, h6, th { font-family: 'Montserrat', sans-serif; }
        p, li, td { font-family: 'Inter', sans-serif; line-height: 1.75; }
        
        .hero-gradient { background: linear-gradient(135deg, #0f172a 0%, #115e59 100%); }

        .visual-container {
            background: white; border-radius: 1rem; padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0; margin: 2rem 0; overflow: hidden; position: relative;
        }
        .visual-title {
            font-family: 'Montserrat', sans-serif; font-weight: 700; color: #0f766e;
            margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between;
        }

        .highlight-quote {
            border-left: 4px solid #2dd4bf; background-color: #f0fdfa; padding: 1.5rem;
            font-style: italic; color: #115e59; border-radius: 0 0.5rem 0.5rem 0; margin: 2rem 0;
        }

        .graph-btn {
            background-color: #0f766e; color: white; padding: 0.5rem 1rem;
            border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600;
            transition: all 0.2s; cursor: pointer; border: none;
            display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .graph-btn:hover { background-color: #115e59; transform: translateY(-1px); shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .graph-btn:active { transform: translateY(0); }
        .graph-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .graph-btn.secondary { background-color: white; color: #0f766e; border: 1px solid #0f766e; }
        .graph-btn.secondary:hover { background-color: #f0fdfa; }
        .graph-btn.active { background-color: #0f766e; color: white; border-color: #0f766e; }

        .custom-list li { margin-bottom: 0.75rem; display: flex; align-items: start; }
        .custom-list li i { margin-right: 0.75rem; margin-top: 0.25rem; color: #2dd4bf; min-width: 1.25rem; }

        /* AI & Quiz Styles */
        .ai-message { margin-bottom: 1rem; padding: 1rem; border-radius: 0.75rem; font-size: 0.9rem; max-width: 85%; }
        .ai-message.user { background-color: #f1f5f9; color: #334155; border-bottom-right-radius: 0; margin-left: auto; }
        .ai-message.bot { background-color: #ccfbf1; color: #0f766e; border-bottom-left-radius: 0; margin-right: auto; border: 1px solid #99f6e4; }
        .ai-message p { margin-bottom: 0.5rem; }
        .ai-message p:last-child { margin-bottom: 0; }
        
        .quiz-option { border: 1px solid #e2e8f0; padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; position: relative; }
        .quiz-option:hover { background-color: #f8fafc; border-color: #2dd4bf; }
        .quiz-option.correct { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }
        .quiz-option.wrong { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; }
        /* Keyboard focus styles for accessibility */
        .quiz-option:focus, .clock-segment:focus { outline: 2px solid #2dd4bf; outline-offset: 2px; }

        /* SVG Tooltip Styles */
        .svg-tooltip {
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .svg-point:hover + .svg-tooltip, .svg-point:focus + .svg-tooltip {
            opacity: 1;
        }
        .svg-point { cursor: pointer; transition: r 0.3s; }
        .svg-point:hover { r: 8; }

        /* Runners Animation */
        .runner-track { position: relative; height: 60px; border-bottom: 2px solid #cbd5e1; margin-bottom: 20px; }
        .runner { 
            position: absolute; bottom: 0; width: 32px; height: 32px; 
            background: white; border-radius: 50%; border: 2px solid; 
            display: flex; align-items: center; justify-content: center;
            transition: left 0.1s linear; /* JS driven */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .finish-line { position: absolute; right: 20px; bottom: 0; height: 100%; width: 2px; background: repeating-linear-gradient(to bottom, #334155 0, #334155 5px, transparent 5px, transparent 10px); }

        /* Clock / Killzone Styles */
        .clock-segment { transition: all 0.3s ease; cursor: pointer; }
        .clock-segment:hover { opacity: 0.8; transform: scale(1.02); }
        .clock-center { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

    </style>
</head>
<body class="antialiased">

    <nav class="sticky top-0 z-50 bg-white/95 backdrop-blur-md border-b border-slate-200 shadow-sm transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center flex-shrink-0 mr-6">
                    <div class="h-10 w-10 bg-gradient-to-br from-kawn-base to-kawn-deep rounded-lg flex items-center justify-center text-white font-black text-xl shadow-lg">K</div>
                    <span class="ml-3 font-display font-bold text-slate-800 text-lg tracking-tight">KAWNBIT <span class="text-kawn-base font-light">MAG</span></span>
                </div>
                
                <div class="hidden md:flex space-x-8">
                    <a href="#intro" class="text-slate-500 hover:text-kawn-base font-medium transition-colors text-sm uppercase tracking-wider">Intro</a>
                    <a href="#types" class="text-slate-500 hover:text-kawn-base font-medium transition-colors text-sm uppercase tracking-wider">Tipos</a>
                    <!-- Nuevo Link -->
                    <a href="#killzones" class="text-slate-500 hover:text-kawn-base font-medium transition-colors text-sm uppercase tracking-wider">Tiempo</a>
                    <a href="#forex" class="text-slate-500 hover:text-kawn-base font-medium transition-colors text-sm uppercase tracking-wider">Forex</a>
                    <a href="#ai-lab" class="text-kawn-base hover:text-kawn-dark font-bold transition-colors text-sm uppercase tracking-wider flex items-center bg-kawn-light/30 px-3 py-1 rounded-full"><i data-lucide="sparkles" class="w-4 h-4 mr-1"></i> AI Lab</a>
                </div>
            </div>
        </div>
    </nav>

    <section class="hero-gradient relative text-white py-24 overflow-hidden">
        <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1642543492481-44e81e3914a7?q=80&w=2070&auto=format&fit=crop')] bg-cover bg-center opacity-10 mix-blend-overlay"></div>
        <div class="absolute bottom-0 left-0 right-0 h-24 bg-gradient-to-t from-slate-50 to-transparent"></div>
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10 text-center">
            <span class="inline-block py-1 px-3 rounded-full bg-kawn-light/20 text-kawn-light text-xs font-bold uppercase tracking-wider mb-6 backdrop-blur-sm border border-kawn-light/10">Edición Extendida: Análisis Intermercado</span>
            <h1 class="text-4xl md:text-6xl font-black tracking-tight leading-tight mb-6 drop-shadow-lg">
                Capítulo 18: SMT (Smart Money Tool / Divergencias)
            </h1>
            <p class="text-xl text-slate-200 font-light max-w-2xl mx-auto leading-relaxed drop-shadow-md">
                Descubre las huellas digitales ocultas del dinero institucional observando las discrepancias entre activos correlacionados.
            </p>
        </div>
    </section>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16">

        <section id="intro" class="mb-16 scroll-mt-24">
            <div class="flex items-center mb-8">
                <div class="bg-kawn-light/50 p-3 rounded-xl mr-4">
                    <i data-lucide="brain-circuit" class="w-8 h-8 text-kawn-dark"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-900">Introducción al concepto de SMT</h2>
            </div>
            
            <p class="mb-4 text-lg leading-relaxed font-medium text-slate-700">
                El Smart Money Tool, o SMT como lo conocemos en la metodología ICT, representa uno de los conceptos más refinados y poderosos para identificar las intenciones reales del dinero institucional en los mercados.
            </p>
            <p class="mb-4">
                Mientras que la mayoría de traders minoristas observan un solo instrumento de forma aislada, el dinero inteligente opera con una visión más amplia, utilizando las relaciones entre diferentes índices correlacionados para ejecutar sus estrategias de manera más eficiente.
            </p>

            <div class="highlight-quote">
                <p class="mb-2 font-bold flex items-center"><i data-lucide="quote" class="w-4 h-4 mr-2 opacity-50"></i> Definición Clave:</p>
                <p class="italic">"En términos simples, la divergencia SMT ocurre cuando dos activos normalmente sincronizados dejan de moverse al unísono: es decir, un instrumento alcanza un nuevo máximo o mínimo mientras el otro no lo hace, señal de que algo no cuadra y de que podría avecinarse una corrección o giro de tendencia."</p>
            </div>

            <p class="mb-6">
                Imagina por un momento que eres un gran fondo institucional. No puedes simplemente comprar millones de contratos sin mover dramáticamente el precio en tu contra. Necesitas formas sutiles de posicionarte. Los institucionales utilizan las divergencias entre índices correlacionados para distribuir su riesgo y ocultar sus verdaderas intenciones, creando oportunidades que podemos identificar. Las divergencias SMT nos dejan ver huellas digitales del dinero institucional que no serían visibles observando un solo gráfico.
            </p>

            <!-- IMPROVED INTERACTIVE RUNNERS GRAPHIC -->
            <div class="visual-container bg-slate-50 border-slate-200">
                <div class="visual-title">
                    <div class="flex items-center">
                        <i data-lucide="activity" class="w-5 h-5 mr-2"></i> Analogía Interactiva: Corredores
                    </div>
                    <button onclick="startRace()" id="race-btn" class="graph-btn text-xs">
                        <i data-lucide="play" class="w-3 h-3"></i> Iniciar Carrera
                    </button>
                </div>
                <p class="text-sm text-slate-600 mb-6">Para ilustrarlo: imagina dos corredores que normalmente mantienen el mismo ritmo. Dale al botón "Iniciar Carrera" para ver qué sucede en una divergencia.</p>
                
                <div class="bg-white rounded-lg border border-slate-200 p-6 relative overflow-hidden">
                    <!-- Track 1 -->
                    <div class="runner-track flex items-center">
                        <span class="text-xs font-bold w-16 text-slate-400">Activo A</span>
                        <div class="relative flex-1 h-full border-b-2 border-dashed border-slate-200">
                            <div class="runner" id="runner-1" style="left: 0; border-color: #ef4444; color: #ef4444;">
                                <i data-lucide="trending-up" class="w-4 h-4"></i>
                            </div>
                            <div class="finish-line"></div>
                            <span class="absolute right-0 bottom-[-20px] text-[10px] text-slate-400">Nuevo Máximo</span>
                        </div>
                    </div>
                    
                    <!-- Track 2 -->
                    <div class="runner-track flex items-center" style="border-bottom: none; margin-bottom: 0;">
                        <span class="text-xs font-bold w-16 text-slate-400">Activo B</span>
                        <div class="relative flex-1 h-full border-b-2 border-dashed border-slate-200">
                             <div class="runner" id="runner-2" style="left: 0; border-color: #0f766e; color: #0f766e;">
                                <i data-lucide="trending-up" class="w-4 h-4"></i>
                            </div>
                            <div class="finish-line"></div>
                             <span class="absolute right-0 bottom-[-20px] text-[10px] text-slate-400">Nuevo Máximo</span>
                        </div>
                    </div>

                    <!-- Result Overlay -->
                    <div id="race-result" class="absolute inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-500">
                        <div class="bg-white p-4 rounded-xl shadow-xl border border-slate-200 text-center transform scale-90 transition-transform duration-300" id="race-modal">
                            <div class="flex justify-center items-center gap-4 mb-2">
                                <div class="text-red-500 font-bold text-sm">Activo A rompió<br>(Trampa)</div>
                                <i data-lucide="arrow-right-left" class="text-slate-400"></i>
                                <div class="text-kawn-dark font-bold text-sm">Activo B falló<br>(Verdad)</div>
                            </div>
                            <div class="text-kawn-base font-black text-xl uppercase tracking-widest mb-1">Divergencia SMT</div>
                            <p class="text-xs text-slate-500">Los corredores rompieron la sincronía.</p>
                        </div>
                    </div>
                </div>
            </div>

            <p>En el mercado, esa investigación a través del SMT nos permite detectar la mano oculta del dinero inteligente antes de que sus efectos se hagan evidentes para todos.</p>
        </section>

        <section id="mechanics" class="mb-16 scroll-mt-24">
             <div class="flex items-center mb-8">
                <div class="bg-kawn-light/50 p-3 rounded-xl mr-4">
                    <i data-lucide="cogs" class="w-8 h-8 text-kawn-dark"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-900">La mecánica fundamental del SMT</h2>
            </div>
            <p class="mb-4">
                Para comprender el SMT, debemos entender que los principales índices bursátiles estadounidenses, particularmente el Nasdaq 100 (#NQ) y el S&P 500 (#ES), están intrínsecamente correlacionados. Ambos representan la salud general del mercado, aunque con diferentes ponderaciones.
            </p>
            <p class="mb-4">
                En condiciones normales, se mueven sincronizados. Esta correlación positiva es la norma. Una divergencia SMT ocurre cuando esta correlación natural se rompe temporalmente, creando una discrepancia que el dinero inteligente utiliza.
            </p>
            
            <div class="bg-gradient-to-br from-white to-kawn-light/20 p-6 rounded-xl border border-kawn-base/20 mb-8 shadow-sm">
                <h3 class="text-xl font-bold text-kawn-deep mb-3 flex items-center"><i data-lucide="alert-triangle" class="mr-2 text-orange-500"></i> El Principio de "Trampa vs. Verdad"</h3>
                <p class="mb-4 font-medium text-slate-700">
                    Cuando un índice "se adelanta" marcando un nuevo extremo mientras otro relacionado "se queda atrás", entendemos que esa divergencia es deliberada.
                </p>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-lg border-l-4 border-red-500 shadow-sm">
                        <div class="flex items-center mb-2 text-red-600 font-bold"><i data-lucide="x-circle" class="mr-2 w-4 h-4"></i> La Trampa</div>
                        <p class="text-sm text-slate-600">El mercado que barre un máximo o mínimo significativo suele ser el manipulado para buscar liquidez.</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border-l-4 border-kawn-base shadow-sm">
                        <div class="flex items-center mb-2 text-kawn-dark font-bold"><i data-lucide="check-circle-2" class="mr-2 w-4 h-4"></i> La Verdad</div>
                        <p class="text-sm text-slate-600">El mercado que mantiene la estructura y no rompe ese nivel normalmente refleja la intención real del flujo de órdenes.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="types" class="mb-16 scroll-mt-24">
            <div class="flex items-center mb-8">
                 <div class="bg-kawn-light/50 p-3 rounded-xl mr-4">
                    <i data-lucide="split" class="w-8 h-8 text-kawn-dark"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-900">Tipos de divergencias SMT y su interpretación</h2>
            </div>

            <p class="mb-6">En la práctica, identificamos dos tipos clásicos de divergencias SMT, cada una con su interpretación particular:</p>

            <!-- IMPROVED INTERACTIVE SVG GRAPH -->
            <div class="visual-container">
                <div class="visual-title">
                    <span><i data-lucide="bar-chart-4" class="w-5 h-5 mr-2 inline"></i> Laboratorio Visual SMT</span>
                    <div class="flex bg-slate-100 p-1 rounded-lg">
                        <button onclick="updateGraph('bearish')" class="px-3 py-1 rounded-md text-xs font-bold transition-all active-smt" id="btn-bearish-viz" style="background: white; color: #0f766e; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">Bajista</button>
                        <button onclick="updateGraph('bullish')" class="px-3 py-1 rounded-md text-xs font-bold transition-all text-slate-500 hover:text-slate-700" id="btn-bullish-viz">Alcista</button>
                    </div>
                </div>
                
                <div class="relative w-full bg-slate-50 rounded-lg border border-slate-200 p-4 overflow-hidden group">
                    <!-- Graph Replay Button -->
                    <button onclick="replayGraph()" class="absolute top-4 right-4 z-10 bg-white/80 p-2 rounded-full hover:bg-white border border-slate-200 text-slate-500 hover:text-kawn-base transition-colors" title="Repetir Animación">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    </button>

                    <svg viewBox="0 0 600 280" class="w-full h-auto select-none" id="main-smt-svg">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                            </marker>
                            <linearGradient id="grad-trap" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#ef4444;stop-opacity:0.1" />
                                <stop offset="100%" style="stop-color:#ef4444;stop-opacity:0" />
                            </linearGradient>
                            <linearGradient id="grad-truth" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#0f766e;stop-opacity:0.1" />
                                <stop offset="100%" style="stop-color:#0f766e;stop-opacity:0" />
                            </linearGradient>
                        </defs>
                        
                        <!-- Grid -->
                        <g stroke="#e2e8f0" stroke-width="1">
                            <line x1="50" y1="50" x2="550" y2="50" />
                            <line x1="50" y1="100" x2="550" y2="100" />
                            <line x1="50" y1="150" x2="550" y2="150" />
                            <line x1="50" y1="200" x2="550" y2="200" />
                        </g>

                        <!-- Dynamic Content Group -->
                        <g id="graph-content">
                            <!-- Populated by JS -->
                        </g>

                    </svg>

                    <!-- Overlay Instruction -->
                    <div class="absolute bottom-2 right-4 text-[10px] text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                        Pasa el ratón sobre los círculos para ver detalles
                    </div>
                </div>

                <div id="smt-desc-dynamic" class="mt-4 p-4 bg-slate-100 rounded-lg text-sm text-slate-700 font-medium border-l-4 border-red-500 transition-colors duration-300">
                    <!-- Text injected by JS -->
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-8 mt-8">
                <div>
                    <h3 class="text-xl font-bold text-red-700 mb-3 flex items-center"><i data-lucide="trending-down" class="mr-2"></i> Divergencia Bajista Clásica</h3>
                    <p class="mb-4">
                        Ocurre cuando un índice marca un nuevo máximo mientras que el otro no logra superar su máximo anterior.
                    </p>
                    <p class="text-sm text-slate-600">
                        El índice que hizo el nuevo máximo sería la "trampa" que buscó liquidez arriba, y el que no confirmó el máximo nos estaría indicando la verdad de que el rally no es sostenible. Es una señal de falsa fortaleza.
                    </p>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-kawn-base mb-3 flex items-center"><i data-lucide="trending-up" class="mr-2"></i> Divergencia Alcista Clásica</h3>
                    <p class="mb-4">
                        De manera inversa, se presenta cuando un índice marca un nuevo mínimo mientras el otro se mantiene por encima de su mínimo anterior.
                    </p>
                    <p class="text-sm text-slate-600">
                        Sugiere que el dinero inteligente está acumulando posiciones en el índice relativamente más fuerte, anticipando un giro alcista. La caída del otro índice es la trampa.
                    </p>
                </div>
            </div>
        </section>

        <!-- [NEW SECTION] Killzones / Time Factor -->
        <section id="killzones" class="mb-16 scroll-mt-24">
            <div class="flex items-center mb-8">
                <div class="bg-kawn-light/50 p-3 rounded-xl mr-4">
                    <i data-lucide="clock-4" class="w-8 h-8 text-kawn-dark"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-900">Sincronía Temporal: SMT en las Killzones</h2>
            </div>
            
            <p class="mb-6">
                Una divergencia SMT no tiene valor si ocurre en un horario "muerto" (como el almuerzo de NY). La manipulación institucional (la "Trampa") ocurre predominantemente durante ventanas de tiempo específicas de alta volatilidad conocidas como <strong>Killzones</strong>.
            </p>

            <div class="visual-container bg-slate-850 text-white border-slate-700">
                <div class="visual-title text-kawn-base">
                    <span><i data-lucide="radar" class="w-5 h-5 mr-2 inline"></i> Radar de Killzones Interactivo</span>
                </div>
                
                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    <!-- Added tabindex and onkeydown for a11y -->
                    <div onclick="selectZone('asia')" onkeydown="if(event.key === 'Enter' || event.key === ' ') selectZone('asia')" tabindex="0" role="button" aria-label="Seleccionar sesión asiática" class="clock-segment p-4 rounded-lg bg-slate-800 border border-slate-700 hover:border-kawn-base cursor-pointer group focus:ring-2 focus:ring-kawn-base" id="zone-asia">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-bold text-sm">Sesión Asiática</span>
                            <i data-lucide="moon" class="w-4 h-4 text-slate-400 group-hover:text-kawn-base"></i>
                        </div>
                        <div class="h-1 w-full bg-slate-700 rounded overflow-hidden">
                            <div class="h-full bg-slate-500 w-1/3"></div>
                        </div>
                    </div>
                    <div onclick="selectZone('london')" onkeydown="if(event.key === 'Enter' || event.key === ' ') selectZone('london')" tabindex="0" role="button" aria-label="Seleccionar London Open" class="clock-segment p-4 rounded-lg bg-slate-800 border border-slate-700 hover:border-kawn-base cursor-pointer group focus:ring-2 focus:ring-kawn-base" id="zone-london">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-bold text-sm">London Open</span>
                            <i data-lucide="cloud-rain" class="w-4 h-4 text-slate-400 group-hover:text-kawn-base"></i>
                        </div>
                        <div class="h-1 w-full bg-slate-700 rounded overflow-hidden">
                            <div class="h-full bg-kawn-base w-3/4"></div>
                        </div>
                    </div>
                    <div onclick="selectZone('ny')" onkeydown="if(event.key === 'Enter' || event.key === ' ') selectZone('ny')" tabindex="0" role="button" aria-label="Seleccionar New York Open" class="clock-segment p-4 rounded-lg bg-slate-800 border border-slate-700 hover:border-kawn-base cursor-pointer group ring-2 ring-kawn-base ring-offset-2 ring-offset-slate-900 focus:ring-2 focus:ring-kawn-base" id="zone-ny">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-bold text-sm">New York Open</span>
                            <i data-lucide="sun" class="w-4 h-4 text-kawn-base"></i>
                        </div>
                        <div class="h-1 w-full bg-slate-700 rounded overflow-hidden">
                            <div class="h-full bg-red-500 w-full animate-pulse"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 flex gap-6 items-start transition-all" id="zone-details">
                    <div class="bg-red-500/20 p-3 rounded-full hidden md:block">
                        <i data-lucide="target" class="w-8 h-8 text-red-400"></i>
                    </div>
                    <div>
                        <h4 class="text-xl font-bold text-white mb-2" id="zone-title">New York Open (09:30 - 11:00 EST)</h4>
                        <div class="flex items-center gap-2 mb-3">
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-green-500/20 text-green-400 border border-green-500/30">FIABILIDAD: ALTA</span>
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-600 text-slate-300">ACTIVOS: NQ, ES, YM</span>
                        </div>
                        <p class="text-sm text-slate-300 leading-relaxed" id="zone-desc">
                            Esta es la ventana "Prime" para SMT en índices. La apertura americana suele buscar manipular los máximos o mínimos de Londres o Asia. Si ves una divergencia aquí, es una señal de reversión intradía de altísima probabilidad.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- [NEW SECTION] Inverse SMT / Forex -->
        <section id="forex" class="mb-16 scroll-mt-24">
            <div class="flex items-center mb-8">
                <div class="bg-kawn-light/50 p-3 rounded-xl mr-4">
                    <i data-lucide="globe" class="w-8 h-8 text-kawn-dark"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-900">Correlación Inversa: La Triada del Forex</h2>
            </div>

            <p class="mb-6">
                En Forex, el rey es el <strong>Índice Dólar (DXY)</strong>. Existe una correlación inversa casi perfecta: cuando el DXY sube, EURUSD y GBPUSD deberían bajar. El SMT aquí se manifiesta cuando esta simetría se rompe.
            </p>

            <div class="visual-container bg-slate-50 border border-slate-200">
                <div class="visual-title">
                    <span><i data-lucide="sliders" class="w-5 h-5 mr-2 inline"></i> Simulador de Fuerza Relativa (DXY vs Majors)</span>
                    <button onclick="resetForexSim()" class="text-xs text-kawn-dark hover:underline">Resetear</button>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8 items-center">
                    <!-- Controls -->
                    <div class="space-y-6">
                        <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                            <label class="flex justify-between text-xs font-bold text-slate-500 mb-2">
                                <span>Potencia del Dólar (DXY)</span>
                                <span class="text-forex-dxy">Subiendo...</span>
                            </label>
                            <input type="range" min="0" max="100" value="0" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-amber-500" id="dxy-slider" oninput="updateForexSim(this.value)">
                            <p class="text-[10px] text-slate-400 mt-2">Desliza para simular un rally en el Dólar.</p>
                        </div>
                        
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-100 text-sm text-blue-900">
                            <strong>Escenario:</strong> El DXY está haciendo un <span class="font-bold">Higher High (HH)</span>. Por correlación inversa, EUR y GBP deberían hacer <span class="font-bold">Lower Lows (LL)</span>. Si uno falla... ¡SMT!
                        </div>
                    </div>

                    <!-- Visualizer -->
                    <div class="relative h-64 bg-white rounded-xl border border-slate-200 p-4 flex justify-around items-end overflow-hidden">
                        <!-- Grid lines -->
                        <div class="absolute inset-0 flex flex-col justify-between p-4 pointer-events-none opacity-20">
                            <div class="w-full h-px bg-slate-400 border-t border-dashed"></div>
                            <div class="w-full h-px bg-slate-400 border-t border-dashed"></div>
                            <div class="w-full h-px bg-slate-400 border-t border-dashed"></div>
                        </div>

                        <!-- Bars -->
                        <div class="flex flex-col items-center gap-2 w-1/4 transition-all duration-500 group">
                            <div class="text-xs font-bold text-forex-dxy mb-1">DXY</div>
                            <div id="bar-dxy" class="w-full bg-forex-dxy rounded-t-lg transition-all duration-300 relative" style="height: 30%">
                                <div class="absolute -top-6 left-1/2 -translate-x-1/2 bg-amber-100 text-forex-dxy text-[10px] px-2 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap font-bold">Driver</div>
                            </div>
                        </div>

                        <div class="flex flex-col items-center gap-2 w-1/4 transition-all duration-500 group">
                            <div class="text-xs font-bold text-forex-eur mb-1">EURUSD</div>
                            <div id="bar-eur" class="w-full bg-forex-eur rounded-t-lg transition-all duration-300 relative" style="height: 70%">
                                <div class="absolute -top-6 left-1/2 -translate-x-1/2 bg-blue-100 text-forex-eur text-[10px] px-2 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap font-bold">Obediente</div>
                            </div>
                        </div>

                        <div class="flex flex-col items-center gap-2 w-1/4 transition-all duration-500 relative group">
                            <div class="text-xs font-bold text-forex-gbp mb-1 flex items-center gap-1">
                                GBPUSD <i data-lucide="zap" class="w-3 h-3 text-kawn-base opacity-0" id="gbp-smt-icon"></i>
                            </div>
                            <div id="bar-gbp" class="w-full bg-forex-gbp rounded-t-lg transition-all duration-300 relative" style="height: 70%">
                                <!-- SMT Indicator Overlay -->
                                <div id="gbp-overlay" class="absolute inset-0 bg-kawn-base/80 flex items-center justify-center text-white font-black text-xs opacity-0 transition-opacity">SMT!</div>
                            </div>
                            <div class="absolute -top-10 left-1/2 -translate-x-1/2 bg-kawn-deep text-white text-[10px] px-2 py-1 rounded shadow-lg opacity-0 transition-opacity whitespace-nowrap z-10" id="gbp-tooltip">
                                ¡Fuerza Relativa!<br>Compra aquí.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <p class="mt-4 text-sm text-slate-600">
                En este ejemplo, si GBPUSD se niega a hacer el bajo más bajo a pesar de la fuerza del DXY, está mostrando una acumulación encubierta. Esa es tu señal de compra.
            </p>
        </section>

        <section id="application" class="mb-16 scroll-mt-24">
            <div class="flex items-center mb-8">
                 <div class="bg-kawn-light/50 p-3 rounded-xl mr-4">
                    <i data-lucide="crosshair" class="w-8 h-8 text-kawn-dark"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-900">La aplicación práctica del SMT en tu operativa</h2>
            </div>

            <p class="mb-6">
                Para aplicar efectivamente el SMT, necesitas monitorear simultáneamente ambos índices correlacionados, especialmente en zonas de liquidez importantes.
            </p>

            <div class="highlight-quote bg-slate-100 border-slate-500 text-slate-700 shadow-sm">
                 <p class="mb-2 font-bold"><i data-lucide="alert-octagon" class="inline w-5 h-5 mr-1 text-orange-500"></i> Regla de Oro:</p>
                 <p>La divergencia SMT es principalmente un <strong>indicador de hipótesis</strong>. Nos dice "cuidado, este movimiento podría ser falso", pero <strong>no debe tomarse como señal de entrada por sí sola</strong> hasta que el precio lo corrobore con acción concreta (como un cambio de estructura).</p>
            </div>

            <h3 class="text-2xl font-bold text-slate-900 mb-4 mt-8">Integración con la toma de liquidez</h3>
            <p class="mb-4">
                Cuando tenemos una divergencia SMT, la búsqueda de liquidez se vuelve reveladora. Si el #NQ barre un máximo y toma liquidez, pero el #ES no llega a su máximo equivalente, la divergencia te está gritando que el movimiento en NQ es una trampa.
            </p>
            <p class="mb-6">
                En este punto, confías en operar el <strong>índice rezagado (lagging)</strong> (el que no rompió el máximo), porque allí el movimiento probablemente será más limpio y ofrece mejor punto de entrada y menor riesgo.
            </p>
            
            <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-kawn-dark mb-8">
                <h4 class="font-bold text-lg text-kawn-dark mb-4 flex items-center"><i data-lucide="layers" class="mr-2"></i> Estrategia: Operando el Activo Rezagado</h4>
                <ol class="list-decimal pl-5 space-y-4 text-sm font-medium text-slate-700">
                    <li>Identificar zona de liquidez clave (ej. máximos previos) en ambos índices (NQ y ES).</li>
                    <li>Observar en tiempo real: NQ rompe su máximo y toma liquidez (Trampa).</li>
                    <li>Confirmar SMT: ES falla en romper su máximo equivalente (Verdad/Debilidad).</li>
                    <li>Enfocar la atención en ES (el rezagado).</li>
                    <li>Esperar señal de confirmación en ES (ej. patrón de vela de giro, quiebre de estructura en M5/M15).</li>
                    <li>Entrar en corto en ES. Stop loss por encima del máximo que SÍ alcanzó el NQ (proporcional) o sobre la estructura local de ES.</li>
                </ol>
            </div>
        </section>

        <section id="fvg-smt" class="mb-16 scroll-mt-24">
             <div class="flex items-center mb-8">
                 <div class="bg-kawn-light/50 p-3 rounded-xl mr-4">
                    <i data-lucide="zap" class="w-8 h-8 text-kawn-dark"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-900">SMT y Fair Value Gaps: una combinación letal</h2>
            </div>
            <p class="mb-6">
                Combinar la lectura de divergencias SMT con la localización de Fair Value Gaps (FVGs) puede aportar una confluencia de alta precisión.
            </p>

            <div class="grid md:grid-cols-2 gap-8">
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 hover:shadow-lg transition-shadow">
                    <h3 class="font-bold text-kawn-deep mb-3 flex items-center"><i data-lucide="bar-chart-2" class="mr-2"></i> Divergencias en el Rebalanceo</h3>
                    <p class="text-sm mb-3">
                        Si el #NQ sube y rebalancea completamente un FVG bajista, mientras el #ES apenas logra tocar el suyo antes de caer, el dinero inteligente está más interesado en vender el ES.
                    </p>
                    <p class="text-xs text-slate-500 italic">
                        El índice que deja el FVG incompleto muestra mayor urgencia en la dirección de la tendencia dominante.
                    </p>
                </div>
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 hover:shadow-lg transition-shadow">
                    <h3 class="font-bold text-kawn-deep mb-3 flex items-center"><i data-lucide="bar-chart-3" class="mr-2"></i> Creación Asimétrica de FVGs</h3>
                    <p class="text-sm mb-3">
                        Si el #ES explota al alza dejando un FVG alcista significativo, pero el #NQ sube de forma más pausada sin dejar gap, el dinero inteligente está más agresivamente posicionado en largo en el ES.
                    </p>
                     <p class="text-xs text-slate-500 italic">
                        El FVG en el índice más fuerte se convierte en un punto de entrada de alta probabilidad.
                    </p>
                </div>
            </div>
        </section>

        <section id="risk-time" class="mb-16 scroll-mt-24">
             <div class="flex items-center mb-8">
                 <div class="bg-kawn-light/50 p-3 rounded-xl mr-4">
                    <i data-lucide="clock" class="w-8 h-8 text-kawn-dark"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-900">Temporalidades y Gestión de Riesgo</h2>
            </div>

            <div class="mb-10">
                <h3 class="text-2xl font-bold text-slate-900 mb-4">El factor tiempo</h3>
                <p class="mb-4">No todas las divergencias tienen el mismo peso.</p>
                <ul class="custom-list pl-4 text-sm">
                    <li><i data-lucide="calendar" class="text-kawn-dark"></i> <strong>Temporalidades Mayores (D1, W1):</strong> Menos frecuentes pero extremadamente poderosas. Telegrafían cambios de tendencia mayor que pueden durar semanas.</li>
                    <li><i data-lucide="clock" class="text-kawn-base"></i> <strong>Temporalidades Menores (M1-M15):</strong> Muy frecuentes pero ruidosas. La clave es filtrar: buscar divergencias solo en contextos relevantes (kill zones, niveles clave). Adaptar el radar SMT a la temporalidad que operas es vital.</li>
                </ul>
            </div>

            <div class="bg-slate-850 text-white p-8 rounded-2xl border border-slate-700 shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 p-32 bg-kawn-deep/20 rounded-full blur-3xl -mr-16 -mt-16"></div>
                <h3 class="text-2xl font-bold mb-6 flex items-center relative z-10"><i data-lucide="shield-check" class="mr-3 text-kawn-base"></i> Gestión de Riesgo con SMT</h3>
                <div class="grid md:grid-cols-2 gap-8 relative z-10">
                    <div>
                         <h4 class="font-bold text-kawn-base mb-2">Estableciendo Stops con Confianza</h4>
                         <p class="text-sm text-slate-300">Una gran ventaja del SMT es la claridad para el stop loss: si la divergencia se elimina (el activo rezagado finalmente rompe el nivel), tu tesis es incorrecta y debes salir. La divergencia te da un punto de anclaje claro para el riesgo.</p>
                    </div>
                    <div>
                         <h4 class="font-bold text-kawn-base mb-2">Dimensionamiento de Posición</h4>
                         <p class="text-sm text-slate-300">Ajusta el tamaño según la magnitud de la divergencia. Divergencias más pronunciadas (brechas amplias entre índices) pueden justificar posiciones ligeramente más grandes por implicar mayor convicción institucional, mientras que las tenues requieren cautela.</p>
                    </div>
                </div>
            </div>
        </section>

         <section id="special-cases" class="mb-16 scroll-mt-24">
            <div class="mb-12">
                <h3 class="text-2xl font-bold text-slate-900 mb-4 flex items-center"><i data-lucide="alert-circle" class="mr-2 text-kawn-base"></i> Casos especiales</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-red-400">
                        <h4 class="font-bold text-sm mb-2 text-red-600">Eventos de Noticias (Alta Volatilidad)</h4>
                        <p class="text-xs text-slate-600">Las divergencias durante noticias (NFP, FOMC) pueden ser temporales por velocidad de reacción. Regla práctica: esperar 15-30 mins. Si la divergencia persiste tras el ruido inicial, es válida.</p>
                    </div>
                     <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-400">
                        <h4 class="font-bold text-sm mb-2 text-blue-600">Correlaciones Sectoriales</h4>
                        <p class="text-xs text-slate-600">SMT aplica a otros pares correlacionados (RTY vs ES, YM vs NQ, EURUSD vs GBPUSD). Indica rotación de capital. Asegúrate de que la correlación sea sólida antes de aplicar SMT.</p>
                    </div>
                </div>
            </div>

             <div class="bg-slate-50 p-8 rounded-2xl border border-slate-200">
                <h3 class="text-2xl font-bold text-red-700 mb-6 flex items-center"><i data-lucide="x-octagon" class="mr-2"></i> Errores comunes a evitar</h3>
                 <ul class="custom-list space-y-4 text-sm font-medium">
                    <li><i data-lucide="x-circle" class="text-red-500"></i> <strong>Buscar divergencias en activos no correlacionados:</strong> Comparar NQ con petróleo no tiene sentido. El SMT solo funciona cuando se rompe una correlación establecida.</li>
                    <li><i data-lucide="x-circle" class="text-red-500"></i> <strong>Ignorar el contexto del mercado:</strong> Divergencias en horarios de bajo volumen o días festivos tienen poco peso. El contexto es rey.</li>
                    <li><i data-lucide="x-circle" class="text-red-500"></i> <strong>Sobreoperar las divergencias menores:</strong> No cada pequeña divergencia en M1 es una operación. Enfócate en niveles clave y espera confirmación. Trata la divergencia como una hipótesis, no un gatillo.</li>
                </ul>
            </div>
        </section>

        <section id="ai-lab" class="mb-16 scroll-mt-24">
            <div class="flex items-center mb-8">
                 <div class="bg-kawn-light/50 p-3 rounded-xl mr-4">
                    <i data-lucide="sparkles" class="w-8 h-8 text-kawn-dark"></i>
                </div>
                <div>
                    <h2 class="text-3xl font-bold text-slate-900">Laboratorio de Inteligencia KawnBit (SMT) ✨</h2>
                    <p class="text-sm text-slate-500">Conectado a Gemini API v1.5 (Secure Environment)</p>
                </div>
            </div>
            
            <div class="grid lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden flex flex-col h-[500px]">
                    <div class="bg-slate-900 p-4 flex justify-between items-center">
                        <div class="flex items-center text-white">
                            <div class="bg-kawn-base p-1.5 rounded-lg mr-3">
                                <i data-lucide="bot" class="w-5 h-5 text-slate-900"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-sm">Mentor de SMT IA</h3>
                                <p class="text-[10px] opacity-70">Model: gemini-2.5-flash-preview-09-2025</p>
                            </div>
                        </div>
                        <span class="flex h-3 w-3 relative">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                        </span>
                    </div>

                    <div id="chat-messages" class="flex-1 p-6 overflow-y-auto bg-slate-50">
                        <div class="ai-message bot">
                            Hola. Soy tu mentor especializado en SMT Divergence. Estoy conectado a la API de Gemini para responder cualquier duda técnica en tiempo real. ¡Pruébame! ✨
                        </div>
                    </div>

                    <div class="p-4 bg-white border-t border-slate-200">
                        <form id="chat-form" class="flex gap-2">
                            <input type="text" id="user-input" class="flex-1 border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-kawn-base focus:border-transparent outline-none text-sm transition-shadow" placeholder="Ej: ¿Cómo confirmo una divergencia SMT bajista?">
                            <button type="submit" id="chat-submit-btn" class="bg-kawn-dark text-white p-2.5 rounded-lg hover:bg-kawn-base transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="send" class="w-5 h-5"></i>
                            </button>
                        </form>
                        <p class="text-[10px] text-center text-slate-400 mt-2">Powered by Google Gemini API. Las respuestas pueden variar.</p>
                    </div>
                </div>

                <div class="flex flex-col gap-6">
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex-1 flex flex-col">
                        <h3 class="font-bold text-kawn-deep mb-3 flex items-center"><i data-lucide="microscope" class="mr-2"></i> Analizador de Escenarios SMT</h3>
                        <p class="text-xs text-slate-500 mb-3">Describe la acción de precio y Gemini analizará si existe una divergencia válida.</p>
                        
                        <textarea id="scenario-input" class="w-full h-24 border border-slate-200 rounded-lg p-3 text-sm focus:ring-1 focus:ring-kawn-base outline-none resize-none mb-3 bg-slate-50" placeholder="Ej: El NQ rompió el máximo de ayer a las 10am, pero el ES se quedó por debajo de su máximo equivalente..."></textarea>
                        
                        <button id="scenario-btn" onclick="analyzeScenario()" class="w-full py-2 bg-slate-800 text-white rounded-lg font-bold text-sm hover:bg-slate-700 transition flex justify-center items-center gap-2 mb-3 disabled:opacity-50 disabled:cursor-not-allowed shadow-md">
                            <i data-lucide="sparkles" class="w-4 h-4"></i> Analizar con IA
                        </button>

                        <div id="scenario-result" class="bg-kawn-light/20 p-3 rounded-lg border border-kawn-base/10 text-xs text-slate-700 h-24 overflow-y-auto custom-scrollbar">
                            <span class="opacity-50 italic">Esperando descripción...</span>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-kawn-light/30 to-white p-6 rounded-2xl shadow-sm border border-kawn-base/20 flex-1 flex flex-col justify-center">
                        <h3 class="font-bold text-kawn-deep mb-2 flex items-center"><i data-lucide="award" class="mr-2"></i> Desafío SMT Infinito ✨</h3>
                        <p class="text-xs text-slate-500 mb-4">Genera preguntas únicas creadas por IA al instante.</p>
                        
                        <div id="quiz-container">
                            <button id="quiz-btn" onclick="generateQuiz()" class="w-full py-3 bg-kawn-base text-white rounded-lg font-bold text-sm hover:bg-kawn-dark transition flex justify-center items-center gap-2 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="zap" class="w-4 h-4"></i> Generar Quiz con Gemini
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <section id="conclusion" class="mb-16 scroll-mt-24 bg-kawn-light/10 p-8 rounded-2xl border border-kawn-base/30">
            <div class="flex items-center mb-8">
                 <div class="bg-kawn-light/50 p-3 rounded-xl mr-4">
                    <i data-lucide="flag" class="w-8 h-8 text-kawn-dark"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-900">Conclusión: el SMT como ventaja competitiva</h2>
            </div>
            <p class="mb-6 font-medium text-lg">
                El Smart Money Tool representa una evolución en tu comprensión del mercado. Es una lente nueva a través de la cual puedes ver la verdadera naturaleza del posicionamiento institucional.
            </p>
            <p class="mb-6">
                Cuando combinas el análisis SMT con tu comprensión existente de la liquidez y los FVGs, desarrollas una visión tridimensional del mercado.
            </p>

            <h3 class="text-2xl font-bold text-slate-900 mb-6 text-center">Ejercicios prácticos para dominar el SMT</h3>
            
            <div class="flex flex-col md:flex-row justify-between gap-4 px-4">
                <div class="flex-1 bg-white p-6 rounded-xl shadow-sm border-t-4 border-kawn-accent hover:shadow-md transition-all cursor-pointer hover:-translate-y-1">
                    <div class="w-12 h-12 bg-kawn-light rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="history" class="w-6 h-6 text-kawn-dark"></i>
                    </div>
                    <h4 class="font-bold text-md mb-2 text-center">1. Identificación Histórica</h4>
                    <p class="text-xs text-slate-600 text-center">Revisa gráficos de giros mayores pasados. Marca las divergencias SMT y anota qué ocurrió después.</p>
                </div>
                <div class="flex-1 bg-white p-6 rounded-xl shadow-sm border-t-4 border-kawn-base hover:shadow-md transition-all cursor-pointer hover:-translate-y-1">
                     <div class="w-12 h-12 bg-kawn-light rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="eye" class="w-6 h-6 text-kawn-dark"></i>
                    </div>
                    <h4 class="font-bold text-md mb-2 text-center">2. Seguimiento en Tiempo Real</h4>
                    <p class="text-xs text-slate-600 text-center">Durante una semana, lleva un diario de cada SMT que veas en vivo. Anota hora, magnitud y resultado para entrenar el ojo.</p>
                </div>
                <div class="flex-1 bg-white p-6 rounded-xl shadow-sm border-t-4 border-kawn-dark hover:shadow-md transition-all cursor-pointer hover:-translate-y-1">
                     <div class="w-12 h-12 bg-kawn-light rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="git-merge" class="w-6 h-6 text-kawn-dark"></i>
                    </div>
                    <h4 class="font-bold text-md mb-2 text-center">3. Integración con tu Modelo</h4>
                    <p class="text-xs text-slate-600 text-center">Analiza cómo el SMT podría haber filtrado trades perdedores o confirmado ganadores en tu estrategia actual.</p>
                </div>
            </div>
            
            <p class="text-center mt-10 font-bold text-kawn-deep text-lg italic">
                "El SMT es simplemente otro idioma en el que el dinero inteligente habla, y ahora tú tienes las herramientas para entender esta conversación."
            </p>

        </section>
        
        <!-- Bibliographic references section removed as per user request -->

    </main>

    <footer class="bg-slate-900 text-slate-400 py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-3">
                 <div class="h-10 w-10 bg-gradient-to-br from-slate-700 to-slate-800 rounded-lg flex items-center justify-center text-white font-black text-xl shadow-lg border border-slate-600">K</div>
                <div class="flex flex-col">
                    <span class="text-xl font-black text-white tracking-tight leading-none font-display">KAWNBIT</span>
                    <span class="text-[0.6rem] font-bold text-kawn-base uppercase tracking-[0.2em] leading-none mt-1">Quantitative Trading Community</span>
                </div>
            </div>
            <p class="text-sm text-center md:text-right">
                © <span id="current-year">2024</span> KawnBit Magazine. Todos los derechos reservados.<br>
                <span class="text-xs opacity-50">Material educativo sobre Smart Money Concepts. No constituye asesoramiento financiero.</span>
            </p>
        </div>
    </footer>

    <script>
        // Set Current Year in Footer
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // Init Icons
        lucide.createIcons();

        // -----------------------------------------------------
        // GLOBAL CONSTANTS & CONFIG
        // -----------------------------------------------------
        const COLORS = {
            red: '#ef4444',
            green: '#22c55e',
            teal: '#0f766e',
            blue: '#14b8a6',
            slate: '#64748b'
        };

        // -----------------------------------------------------
        // 0. GEMINI API CONFIGURATION (ROBUST MODE)
        // -----------------------------------------------------
        
        // In this secure preview environment, the key is injected at runtime.
        // We use an empty string as per platform requirements.
        const apiKey = ""; 

        async function callGeminiAPI(prompt, systemInstruction = "Eres un asistente útil.") {
            // ROBUSTNESS: Fallback to simulated mode if API key is missing (for local testing/demos)
            if (!apiKey) {
                console.warn("API Key missing. Switching to Simulation Mode.");
                await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate network latency
                
                // Return varied simulation responses based on prompt keywords
                if (prompt.includes("quiz") || prompt.includes("Pregunta")) {
                    // Simulated JSON response for Quiz
                    return `
                    \`\`\`json
                    [
                        {"q": "¿En qué Killzone es más fiable una divergencia SMT para índices?", "options": ["Asian Session", "London Open", "New York Open", "Lunch Hour"], "a": 2},
                        {"q": "¿Si DXY sube y EURUSD no baja (hace Higher Low), qué indica?", "options": ["Fortaleza del Euro (Posible Compra)", "Debilidad del Euro", "Indecisión", "SMT Bajista"], "a": 0},
                        {"q": "¿Qué activo debes operar idealmente tras confirmar SMT?", "options": ["El que barrió liquidez (Trampa)", "El activo rezagado (Verdad)", "El activo con más volumen", "Cualquiera"], "a": 1}
                    ]
                    \`\`\`
                    `;
                } else if (prompt.includes("analiza") || prompt.includes("El NQ")) {
                    return `**Análisis Simulado (Modo Demo):**\n\nBasado en tu descripción, parece un escenario clásico de **SMT ${prompt.toLowerCase().includes("máximo") ? "Bajista" : "Alcista"}**.\n\n1.  **Trampa:** El activo que rompió el nivel tomó liquidez.\n2.  **Verdad:** El activo que falló muestra la intención real.\n\n*Nota: Configura la API Key para análisis real en tiempo real.*`;
                } else {
                    return "Modo Simulación: Estoy funcionando sin conexión real a Gemini. Configura la API Key para activar mi cerebro completo. Mientras tanto, puedo decirte que el SMT es la herramienta más potente para filtrar falsos rompemientos.";
                }
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Error: No se pudo generar respuesta.";
            } catch (error) {
                console.error("Gemini API Error:", error);
                throw error; // Let the caller handle the error UI
            }
        }


        // -----------------------------------------------------
        // 1. INTERACTIVE RUNNERS VISUALIZATION (ROBUST)
        // -----------------------------------------------------
        let isRacing = false; // State lock to prevent spam clicking

        function startRace() {
            if (isRacing) return; // Prevent multiple clicks
            isRacing = true;

            const runner1 = document.getElementById('runner-1');
            const runner2 = document.getElementById('runner-2');
            const btn = document.getElementById('race-btn');
            const resultModal = document.getElementById('race-modal');
            const resultOverlay = document.getElementById('race-result');

            // Reset UI
            runner1.style.transition = 'none'; runner2.style.transition = 'none';
            runner1.style.left = '0'; runner2.style.left = '0';
            resultOverlay.style.opacity = '0'; resultOverlay.style.pointerEvents = 'none';
            resultModal.classList.remove('scale-100'); resultModal.classList.add('scale-90');
            
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader" class="animate-spin w-3 h-3"></i> Corriendo...';
            lucide.createIcons();

            // Small delay to ensure CSS transition reset applies
            setTimeout(() => {
                runner1.style.transition = 'left 2s ease-in-out';
                runner2.style.transition = 'left 2s ease-in-out';

                // Runner 1 (Trap) goes to 100% (breaks high)
                runner1.style.left = 'calc(100% - 32px)';

                // Runner 2 (Truth) goes to 80% (fails to break)
                runner2.style.left = 'calc(80% - 32px)';

                setTimeout(() => {
                    // Show result
                    resultOverlay.style.opacity = '1'; resultOverlay.style.pointerEvents = 'auto';
                    resultModal.classList.remove('scale-90'); resultModal.classList.add('scale-100');
                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="rotate-ccw" class="w-3 h-3"></i> Reiniciar';
                    lucide.createIcons();
                    isRacing = false; // Unlock
                }, 2000);
            }, 50);
        }


        // -----------------------------------------------------
        // 2. ADVANCED SMT SVG VISUALIZER (ROBUST)
        // -----------------------------------------------------
        const svgContainer = document.getElementById('graph-content');
        const descContainer = document.getElementById('smt-desc-dynamic');
        let currentGraphTimeout = null; // To clear timeouts on rapid switching
        
        // Data for Bearish SMT
        const bearishData = `
            <text x="10" y="30" class="text-sm font-bold fill-red-600 animate-[fadeIn_0.5s_ease-out]">Activo A (Trampa)</text>
            <path d="M50,150 L150,50 L250,100 L350,30 L450,120" fill="none" stroke="#ef4444" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="animate-draw" stroke-dasharray="1000" stroke-dashoffset="1000" />
            
            <g class="opacity-0 animate-[fadeIn_0.5s_ease-out_1.5s_forwards]">
                <circle cx="350" cy="30" r="6" fill="#ef4444" class="svg-point" />
                <rect x="360" y="10" width="100" height="40" rx="4" fill="#1e293b" class="svg-tooltip" />
                <text x="370" y="35" fill="white" font-size="10" class="svg-tooltip">Higher High (HH)</text>
            </g>

            <text x="10" y="190" class="text-sm font-bold fill-kawn-dark animate-[fadeIn_0.5s_ease-out]">Activo B (Verdad)</text>
            <path d="M50,250 L150,150 L250,200 L350,160 L450,220" fill="none" stroke="#0f766e" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="animate-draw" stroke-dasharray="1000" stroke-dashoffset="1000" />
            
            <g class="opacity-0 animate-[fadeIn_0.5s_ease-out_1.5s_forwards]">
                <circle cx="350" cy="160" r="6" fill="#0f766e" class="svg-point" />
                <rect x="360" y="140" width="100" height="40" rx="4" fill="#1e293b" class="svg-tooltip" />
                <text x="370" y="165" fill="white" font-size="10" class="svg-tooltip">Lower High (LH)</text>
            </g>

            <!-- Divergence Line -->
            <line x1="350" y1="30" x2="350" y2="160" stroke="#94a3b8" stroke-width="2" stroke-dasharray="5,5" class="opacity-0 animate-[fadeIn_1s_ease-out_2s_forwards]" />
        `;

        const bearishDesc = `<strong class="text-red-600">Divergencia Bajista:</strong> El Activo A hace un nuevo máximo (trampa de liquidez) mientras el Activo B falla (debilidad real).`;

        // Data for Bullish SMT
        const bullishData = `
             <text x="10" y="30" class="text-sm font-bold fill-red-600 animate-[fadeIn_0.5s_ease-out]">Activo A (Trampa)</text>
            <path d="M50,50 L150,150 L250,100 L350,180 L450,80" fill="none" stroke="#ef4444" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="animate-draw" stroke-dasharray="1000" stroke-dashoffset="1000" />
            
            <g class="opacity-0 animate-[fadeIn_0.5s_ease-out_1.5s_forwards]">
                <circle cx="350" cy="180" r="6" fill="#ef4444" class="svg-point" />
                <text x="365" y="185" fill="#ef4444" font-size="10" font-weight="bold">Lower Low (LL)</text>
            </g>

            <text x="10" y="210" class="text-sm font-bold fill-kawn-base animate-[fadeIn_0.5s_ease-out]">Activo B (Verdad)</text>
            <path d="M50,150 L150,250 L250,200 L350,220 L450,150" fill="none" stroke="#14b8a6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="animate-draw" stroke-dasharray="1000" stroke-dashoffset="1000" />
            
            <g class="opacity-0 animate-[fadeIn_0.5s_ease-out_1.5s_forwards]">
                <circle cx="350" cy="220" r="6" fill="#14b8a6" class="svg-point" />
                <text x="365" y="225" fill="#14b8a6" font-size="10" font-weight="bold">Higher Low (HL)</text>
            </g>

             <!-- Divergence Line -->
            <line x1="350" y1="180" x2="350" y2="220" stroke="#94a3b8" stroke-width="2" stroke-dasharray="5,5" class="opacity-0 animate-[fadeIn_1s_ease-out_2s_forwards]" />
        `;

        const bullishDesc = `<strong class="text-kawn-base">Divergencia Alcista:</strong> El Activo A barre mínimos (trampa) mientras el Activo B se mantiene fuerte por encima de su mínimo anterior.`;

        let currentType = 'bearish';

        function updateGraph(type) {
            // Clear any pending timeout to avoid overlapping animations
            if (currentGraphTimeout) clearTimeout(currentGraphTimeout);

            currentType = type;
            const btnBearish = document.getElementById('btn-bearish-viz');
            const btnBullish = document.getElementById('btn-bullish-viz');
            const desc = document.getElementById('smt-desc-dynamic');

            // Reset Animation by clearing HTML immediately
            svgContainer.innerHTML = '';
            
            currentGraphTimeout = setTimeout(() => {
                if (type === 'bearish') {
                    svgContainer.innerHTML = bearishData;
                    desc.innerHTML = bearishDesc;
                    desc.classList.remove('border-kawn-base'); desc.classList.add('border-red-500');
                    
                    btnBearish.classList.add('active-smt'); 
                    btnBearish.style.background = 'white'; btnBearish.style.color = '#0f766e'; btnBearish.style.boxShadow = '0 1px 2px rgba(0,0,0,0.1)';
                    
                    btnBullish.classList.remove('active-smt');
                    btnBullish.style.background = 'transparent'; btnBullish.style.color = '#64748b'; btnBullish.style.boxShadow = 'none';
                } else {
                    svgContainer.innerHTML = bullishData;
                    desc.innerHTML = bullishDesc;
                    desc.classList.remove('border-red-500'); desc.classList.add('border-kawn-base');

                    btnBullish.classList.add('active-smt');
                    btnBullish.style.background = 'white'; btnBullish.style.color = '#0f766e'; btnBullish.style.boxShadow = '0 1px 2px rgba(0,0,0,0.1)';
                    
                    btnBearish.classList.remove('active-smt');
                    btnBearish.style.background = 'transparent'; btnBearish.style.color = '#64748b'; btnBearish.style.boxShadow = 'none';
                }
            }, 10);
        }

        function replayGraph() {
            updateGraph(currentType);
        }

        // Init Graph
        window.addEventListener('DOMContentLoaded', () => {
            updateGraph('bearish');
        });


        // -----------------------------------------------------
        // 3. KILLZONE RADAR LOGIC
        // -----------------------------------------------------
        const zoneData = {
            'asia': {
                title: 'Sesión Asiática (18:00 - 00:00 EST)',
                fiabilidad: 'BAJA / MEDIA',
                color: 'text-slate-400',
                desc: 'Generalmente es un rango de consolidación. Las divergencias aquí suelen ser "falsos positivos" a menos que estés operando pares como AUD o JPY. Para índices americanos, úsalo solo como referencia de máximos/mínimos a barrer luego.'
            },
            'london': {
                title: 'London Open (02:00 - 05:00 EST)',
                fiabilidad: 'ALTA (Prototypes)',
                color: 'text-kawn-base',
                desc: 'El "Judas Swing" clásico. Londres a menudo manipula el rango asiático creando el máximo o mínimo del día. Un SMT aquí (ej. GBP haciendo bajo más bajo mientras EUR no) es una señal muy potente para el resto de la sesión europea.'
            },
            'ny': {
                title: 'New York Open (09:30 - 11:00 EST)',
                fiabilidad: 'MUY ALTA (Prime)',
                color: 'text-red-500',
                desc: 'Esta es la ventana "Prime" para SMT en índices. La apertura americana suele buscar manipular los máximos o mínimos de Londres o Asia. Si ves una divergencia aquí, es una señal de reversión intradía de altísima probabilidad.'
            }
        };

        function selectZone(zone) {
            // UI Reset
            ['asia', 'london', 'ny'].forEach(z => {
                document.getElementById('zone-'+z).classList.remove('ring-2', 'ring-kawn-base', 'ring-offset-2', 'ring-offset-slate-900');
            });
            document.getElementById('zone-'+zone).classList.add('ring-2', 'ring-kawn-base', 'ring-offset-2', 'ring-offset-slate-900');

            // Update Content
            const data = zoneData[zone];
            const titleEl = document.getElementById('zone-title');
            const descEl = document.getElementById('zone-desc');
            const detailsBox = document.getElementById('zone-details');

            // Animation effect
            detailsBox.classList.add('opacity-50', 'scale-95');
            setTimeout(() => {
                titleEl.textContent = data.title;
                descEl.textContent = data.desc;
                detailsBox.classList.remove('opacity-50', 'scale-95');
            }, 150);
        }

        // -----------------------------------------------------
        // 4. FOREX SIMULATOR LOGIC
        // -----------------------------------------------------
        function updateForexSim(val) {
            const barDxy = document.getElementById('bar-dxy');
            const barEur = document.getElementById('bar-eur');
            const barGbp = document.getElementById('bar-gbp');
            const gbpOverlay = document.getElementById('gbp-overlay');
            const gbpTooltip = document.getElementById('gbp-tooltip');
            const gbpIcon = document.getElementById('gbp-smt-icon');

            // Logic: 
            // DXY goes 30% -> 100% height (input 0-100)
            // EUR goes 70% -> 10% height (inverse)
            // GBP goes 70% -> 10%... BUT stops at 40% (SMT)

            const dxyHeight = 30 + (val * 0.7); // Ends at 100%
            const eurHeight = 70 - (val * 0.6); // Ends at 10%
            
            // GBP follows EUR until DXY slider hits ~70, then it refuses to go lower (SMT)
            let gbpHeight = 70 - (val * 0.6);
            if (val > 65) {
                gbpHeight = 31; // Stuck! SMT condition
                gbpOverlay.style.opacity = '1';
                gbpTooltip.style.opacity = '1';
                gbpTooltip.classList.add('animate-bounce');
                gbpIcon.style.opacity = '1';
            } else {
                gbpOverlay.style.opacity = '0';
                gbpTooltip.style.opacity = '0';
                gbpTooltip.classList.remove('animate-bounce');
                gbpIcon.style.opacity = '0';
            }

            barDxy.style.height = `${dxyHeight}%`;
            barEur.style.height = `${eurHeight}%`;
            barGbp.style.height = `${gbpHeight}%`;
        }

        function resetForexSim() {
            document.getElementById('dxy-slider').value = 0;
            updateForexSim(0);
        }


        // -----------------------------------------------------
        // 5. AI LAB LOGIC (REAL GEMINI IMPLEMENTATION)
        // -----------------------------------------------------
        
        // --- Real Chatbot Class ---
        class GeminiChatService {
            constructor() {
                this.systemPrompt = "Eres un mentor experto en trading institucional (metodología ICT/SMC). Tu especialidad son las divergencias SMT (Smart Money Tool). Responde dudas de forma breve (max 3 oraciones), profesional y educativa. Usa emojis ocasionalmente para ser amigable. Si te preguntan algo fuera de trading, redirige educadamente al tema de SMT.";
            }

            async sendMessage(message) {
                return await callGeminiAPI(message, this.systemPrompt);
            }
        }

        const chatService = new GeminiChatService();
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('user-input');
        const chatMessages = document.getElementById('chat-messages');
        const chatSubmitBtn = document.getElementById('chat-submit-btn');

        if(chatForm) {
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const message = chatInput.value.trim();
                if (!message) return;

                // UI Updates
                chatInput.disabled = true; chatSubmitBtn.disabled = true;
                appendMessage(message, 'user');
                chatInput.value = '';
                const loadingId = appendTypingIndicator();

                // Service Call
                try {
                    const reply = await chatService.sendMessage(message);
                    document.getElementById(loadingId).remove();
                    appendMessage(reply, 'bot');
                } catch (error) {
                    document.getElementById(loadingId).remove();
                    appendMessage("⚠️ Error conectando con Gemini. Verifica tu conexión o API Key.", 'bot');
                }

                chatInput.disabled = false; chatSubmitBtn.disabled = false; chatInput.focus();
            });
        }

        function appendMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `ai-message ${sender} animate-[fadeIn_0.3s_ease-out]`;
            // Simple markdown parsing fallback if marked is not loaded (though it is linked in head)
            div.innerHTML = typeof marked !== 'undefined' ? marked.parse(text) : text;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function appendTypingIndicator() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id; div.className = 'ai-message bot typing-indicator';
            div.innerHTML = '<div class="flex space-x-1"><div class="w-2 h-2 bg-kawn-dark rounded-full animate-bounce"></div><div class="w-2 h-2 bg-kawn-dark rounded-full animate-bounce" style="animation-delay: 0.1s"></div><div class="w-2 h-2 bg-kawn-dark rounded-full animate-bounce" style="animation-delay: 0.2s"></div></div>';
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return id;
        }

        // --- Real Scenario Analyzer ---
        async function analyzeScenario() {
            const input = document.getElementById('scenario-input').value;
            const resultBox = document.getElementById('scenario-result');
            const btn = document.getElementById('scenario-btn');
            
            if(!input.trim()) {
                resultBox.innerHTML = '<span class="text-red-500 font-bold">Por favor describe un escenario primero.</span>'; return;
            }
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader" class="animate-spin w-4 h-4"></i> Analizando con Gemini...';
            lucide.createIcons();
            
            // System Prompt for Analyzer
            const systemPrompt = "Eres un analista de mercado algorítmico experto en ICT. Tu trabajo es detectar divergencias SMT en descripciones de texto. Reglas: 1. Si Activo A hace Higher High y Activo B hace Lower High -> SMT Bajista. 2. Si Activo A hace Lower Low y Activo B hace Higher Low -> SMT Alcista. 3. Si ambos hacen HH/LL -> Sincronizados (Sin SMT). Analiza la entrada del usuario y responde en formato Markdown brevemente. Di si es 'Trampa' o 'Confirmación'.";

            try {
                const analysis = await callGeminiAPI(input, systemPrompt);
                resultBox.innerHTML = marked.parse(analysis);
            } catch (error) {
                resultBox.innerHTML = '<span class="text-red-500">Error al analizar. Intenta de nuevo.</span>';
            }
            
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i> Analizar con IA';
            lucide.createIcons();
        }

        // --- Real Quiz Generator ---
        async function generateQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = `
                <div class="text-center py-6 text-kawn-dark">
                    <i data-lucide="loader-2" class="animate-spin w-8 h-8 mx-auto mb-2"></i>
                    <p class="font-bold">Gemini está creando preguntas únicas...</p>
                </div>`;
            lucide.createIcons();

            const systemPrompt = `Genera un array JSON de 3 preguntas de opción múltiple sobre SMT Divergence (Trading Institucional/ICT).
            Dificultad: Intermedia.
            Idioma: Español.
            Formato de respuesta estrictamente JSON puro (sin bloques de código markdown ni explicaciones adicionales):
            [
              {"q": "Pregunta", "options": ["Opcion A", "Opcion B", "Opcion C", "Opcion D"], "a": indice_correcto_numero_0_a_3}
            ]`;

            try {
                let jsonString = await callGeminiAPI("Generar nuevo quiz", systemPrompt);
                
                // ROBUSTNESS: Clean markdown code blocks if Gemini sends them
                const jsonRegex = /\[\s*\{[\s\S]*\}\s*\]/; // Looks for JSON Array pattern
                const match = jsonString.match(jsonRegex);
                
                if (match) {
                    jsonString = match[0];
                    const questions = JSON.parse(jsonString);
                    renderQuiz(questions);
                } else {
                    throw new Error("Formato JSON inválido recibido de la IA");
                }
                
            } catch (error) {
                console.error(error);
                container.innerHTML = `
                    <div class="text-center py-4 text-red-500">
                        <p>Error generando el quiz. Intenta de nuevo.</p>
                        <button onclick="generateQuiz()" class="mt-2 underline">Reintentar</button>
                    </div>`;
            }
        }

        function renderQuiz(questions) {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            let score = 0; let answered = 0;
            const quizWrapper = document.createElement('div');
            quizWrapper.className = 'space-y-6 animate-[fadeIn_0.5s_ease-out]';

            questions.forEach((q, qIndex) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'border-b border-slate-100 pb-4 last:border-0';
                const qTitle = document.createElement('p');
                qTitle.className = 'font-bold text-sm text-kawn-deep mb-3';
                qTitle.textContent = `${qIndex + 1}. ${q.q}`;
                qDiv.appendChild(qTitle);

                const optionsDiv = document.createElement('div');
                q.options.forEach((opt, optIndex) => {
                    const btn = document.createElement('div');
                    // Added a11y attributes
                    btn.className = 'quiz-option text-xs text-slate-600 select-none';
                    btn.setAttribute('role', 'button');
                    btn.setAttribute('tabindex', '0');
                    btn.textContent = opt;
                    
                    const handleSelect = () => {
                        if(btn.parentElement.classList.contains('answered')) return;
                        btn.parentElement.classList.add('answered');
                        answered++;
                        if(optIndex === q.a) {
                            btn.classList.add('correct'); score++;
                            btn.innerHTML += ' <i data-lucide="check" class="inline w-3 h-3 ml-1"></i>';
                        } else {
                            btn.classList.add('wrong');
                            optionsDiv.children[q.a].classList.add('correct');
                        }
                        lucide.createIcons();
                        if(answered === questions.length) showScore(score, questions.length);
                    };

                    btn.onclick = handleSelect;
                    // Keyboard support
                    btn.onkeydown = (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            handleSelect();
                        }
                    };

                    optionsDiv.appendChild(btn);
                });
                qDiv.appendChild(optionsDiv);
                quizWrapper.appendChild(qDiv);
            });
            container.appendChild(quizWrapper);
            
            const resetBtn = document.createElement('button');
            resetBtn.className = 'w-full mt-4 py-2 text-xs text-slate-400 hover:text-kawn-base underline';
            resetBtn.textContent = 'Generar Nuevas Preguntas';
            resetBtn.onclick = generateQuiz;
            container.appendChild(resetBtn);
        }

        function showScore(score, total) {
            const container = document.getElementById('quiz-container');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'mt-4 p-3 bg-kawn-light/50 border border-kawn-base rounded text-center animate-pulse';
            resultDiv.innerHTML = `<span class="font-bold text-kawn-deep">Resultado: ${score}/${total}</span>`;
            if(score === total) resultDiv.innerHTML += ' ¡Excelente! 🏆';
            const resetBtn = container.querySelector('button');
            container.insertBefore(resultDiv, resetBtn);
        }

        // Add keyframes for fadeIn if not using Tailwind plugin
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        `;
        document.head.appendChild(styleSheet);

    </script>
</body>
</html>