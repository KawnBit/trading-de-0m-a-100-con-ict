<!DOCTYPE html>
<html lang="es" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Capítulo 4: Equilibrio, descuento y premium - Curso avanzado de Smart Money Concepts.">
    <title>KawnBit | Equilibrio, descuento y premium</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@400;700;900&display=swap"
        rel="stylesheet">

    <!-- Librerías Externas (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Configuración Tailwind KawnBit -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kawn: {
                            light: '#ccfbf1', // Teal 100
                            base: '#14b8a6',  // Teal 500
                            dark: '#0f766e',  // Teal 700
                            deep: '#134e4a',  // Teal 900
                        },
                        slate: {
                            50: '#f8fafc',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(20, 184, 166, 0.25)',
                        'card': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos Globales */
        body {
            background-color: #f8fafc;
            color: #334155;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Montserrat', sans-serif;
        }

        /* Scrollbar Personalizado */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #14b8a6;
        }

        /* Recreación Logo CSS KawnBit */
        .kawn-logo-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .kawn-logo-icon {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, #14b8a6 0%, #0f766e 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(20, 184, 166, 0.3);
            position: relative;
            overflow: hidden;
        }

        .kawn-logo-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom right, rgba(255, 255, 255, 0.2), transparent);
        }

        .kawn-logo-icon::after {
            content: 'K';
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 26px;
            z-index: 2;
        }

        .kawn-logo-text {
            display: flex;
            flex-direction: column;
        }

        .kawn-brand-name {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 24px;
            line-height: 1;
            color: #0f172a;
            letter-spacing: -0.5px;
        }

        .kawn-brand-sub {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: #14b8a6;
            margin-top: 4px;
        }

        /* Sidebar TOC Interactiva */
        .toc-link {
            display: block;
            padding: 6px 0;
            color: #64748b;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border-left: 2px solid transparent;
            padding-left: 1rem;
        }

        .toc-link:hover {
            color: #14b8a6;
        }

        .toc-link.active {
            color: #0f766e;
            border-left-color: #14b8a6;
            background: linear-gradient(90deg, #f0fdfa 0%, transparent 100%);
            font-weight: 600;
        }

        .toc-sublink {
            padding-left: 2rem;
            font-size: 0.85rem;
        }

        /* Componentes de Texto */
        .highlight-card {
            background-color: #f0fdfa;
            /* kawn-light muy suave */
            border-left: 4px solid #14b8a6;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin: 2rem 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .quote-block {
            font-family: 'Montserrat', sans-serif;
            font-style: italic;
            color: #334155;
            border-left: 4px solid #0f766e;
            padding-left: 1.5rem;
            margin: 2rem 0;
            font-size: 1.1rem;
        }

        /* Animaciones */
        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
            opacity: 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Interactive Zone Slider Style */
        .zone-slider-container {
            position: relative;
            height: 300px;
            background: linear-gradient(to bottom, #fee2e2 0%, #fee2e2 45%, #e2e8f0 50%, #d1fae5 55%, #d1fae5 100%);
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .zone-marker {
            position: absolute;
            left: 0;
            width: 100%;
            height: 2px;
            background: #64748b;
            z-index: 10;
            pointer-events: none;
        }

        .zone-marker.equilibrium {
            top: 50%;
            border-bottom: 2px dashed #334155;
            height: 0;
        }

        .price-handle {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: white;
            border: 3px solid #0f172a;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 10px;
            color: #0f172a;
            top: 50%;
            /* Inicio */
        }

        .price-handle:active {
            cursor: grabbing;
            border-color: #14b8a6;
        }

        /* Chat Bot */
        .chat-message {
            max-width: 85%;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
            animation: fadeIn 0.3s ease-out;
        }

        .user-message {
            background-color: #14b8a6;
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }

        .ai-message {
            background-color: #f1f5f9;
            color: #0f172a;
            align-self: flex-start;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
            border: 1px solid #e2e8f0;
        }

        /* Quiz Styles */
        .quiz-option {
            transition: all 0.2s;
        }

        .quiz-option:hover:not(.disabled) {
            background-color: #f0fdfa;
            border-color: #14b8a6;
        }

        .quiz-option.correct {
            background-color: #dcfce7;
            border-color: #22c55e;
            color: #166534;
        }

        .quiz-option.incorrect {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }

        /* Reading Progress */
        #reading-progress {
            position: fixed;
            top: 80px;
            /* Debajo del navbar */
            left: 0;
            width: 0%;
            height: 3px;
            background: #14b8a6;
            z-index: 40;
            transition: width 0.1s;
        }

        /* Loader Dots for AI */
        .typing-dots span {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #cbd5e1;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.5);
            }
        }
    </style>
</head>

<body class="antialiased">

    <!-- Navbar Sticky -->
    <nav
        class="sticky top-0 z-50 w-full bg-white/95 backdrop-blur-md border-b border-slate-200 shadow-sm transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo -->
                <div class="kawn-logo-wrapper">
                    <div class="kawn-logo-icon"></div>
                    <div class="kawn-logo-text">
                        <span class="kawn-brand-name">KAWNBIT</span>
                        <span class="kawn-brand-sub">QUANTITATIVE TRADING COMMUNITY</span>
                    </div>
                </div>

                <!-- Desktop Nav -->
                <div class="hidden md:flex space-x-8 items-center">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Capítulo 4</span>
                    <a href="#inicio"
                        class="text-slate-600 hover:text-kawn-base font-semibold transition-colors">Teoría</a>
                    <a href="#simuladores"
                        class="text-slate-600 hover:text-kawn-base font-semibold transition-colors">Práctica</a>
                    <a href="#quiz"
                        class="px-4 py-2 bg-slate-900 text-white text-sm font-bold rounded-lg hover:bg-slate-800 transition-colors shadow-lg shadow-slate-900/20">Validación</a>
                </div>

                <!-- Mobile Menu Button -->
                <button id="mobile-menu-btn" class="md:hidden p-2 text-slate-600">
                    <i data-lucide="menu"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Reading Progress Bar -->
    <div id="reading-progress"></div>

    <!-- Main Layout -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="flex flex-col lg:flex-row gap-12">

            <!-- Sidebar TOC (Sticky) -->
            <aside class="hidden lg:block w-72 flex-shrink-0">
                <div class="sticky top-28 overflow-y-auto max-h-[calc(100vh-150px)] pr-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-6 pl-4">Tabla de contenidos
                    </h3>
                    <nav id="toc-container" class="space-y-1 border-l border-slate-200 ml-2">
                        <!-- Generado dinámicamente -->
                    </nav>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 min-w-0">

                <!-- Hero Section -->
                <section id="inicio" class="mb-16 fade-in">
                    <div
                        class="inline-block px-3 py-1 bg-kawn-light text-kawn-dark text-xs font-bold rounded-full mb-4 uppercase tracking-wide">
                        Trading institucional</div>
                    <h1 class="text-4xl md:text-5xl font-black text-slate-900 mb-6 leading-tight">
                        Equilibrio, descuento y <span class="text-kawn-base">premium</span>
                    </h1>
                    <p class="text-xl text-slate-500 leading-relaxed font-light">
                        Los tres pilares del posicionamiento institucional. Aprende a comprar barato y vender caro con
                        la precisión del Smart Money.
                    </p>
                </section>

                <!-- Introducción -->
                <section id="anatomia-precio" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-3">
                        <div class="p-2 bg-kawn-light rounded-lg text-kawn-deep"><i data-lucide="activity"></i></div>
                        La anatomía del movimiento del precio
                    </h2>
                    <p class="text-slate-600 leading-7 mb-4">
                        Imagina por un momento que el mercado es como un péndulo gigante que oscila entre dos extremos.
                        En cada oscilación, existe un punto central de equilibrio y dos zonas opuestas donde las fuerzas
                        del mercado ejercen su máxima influencia. Este capítulo te revelará cómo el <strong>dinero
                            inteligente</strong> (Smart Money) utiliza estas zonas para posicionarse estratégicamente.
                    </p>
                    <div class="highlight-card">
                        <p class="text-slate-700 italic">
                            "El concepto de equilibrio, descuento y premium no se trata simplemente de líneas en un
                            gráfico, sino de comprender la psicología institucional y cómo el dinero profesional busca
                            constantemente obtener el mejor precio posible."
                        </p>
                    </div>
                </section>

                <!-- El Equilibrio -->
                <section id="equilibrio" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">El equilibrio: centro gravitacional</h2>
                    <p class="text-slate-600 leading-7 mb-4">
                        El <strong>equilibrio</strong> representa el punto medio exacto de cualquier movimiento
                        impulsivo rápido en el mercado. Matemáticamente, es el nivel de <strong>50% de
                            retroceso</strong> de un impulso. Actúa como un imán invisible que atrae al precio cuando
                        éste se ha alejado demasiado.
                    </p>
                    <p class="text-slate-600 leading-7 mb-6">
                        Para identificarlo, debes localizar un <strong>movimiento impulsivo claro</strong> (barras
                        amplias, velocidad). El equilibrio es el punto medio. Funciona como una zona de decisión
                        crítica: ¿continuará la tendencia o habrá reversión?
                    </p>

                    <!-- COMPONENTE INTERACTIVO 1: VISUALIZADOR P-E-D -->
                    <div class="bg-white rounded-xl shadow-card border border-slate-200 p-6 mb-8 overflow-hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2">
                                <i data-lucide="sliders" class="text-kawn-base"></i> Visualizador de zonas
                            </h3>
                            <span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded">Interactivo</span>
                        </div>

                        <div class="flex flex-col md:flex-row gap-8">
                            <!-- El Slider -->
                            <div class="w-full md:w-1/3 relative">
                                <div class="flex justify-between text-xs font-bold text-slate-400 mb-1">
                                    <span>MAX (High)</span>
                                </div>
                                <div class="zone-slider-container" id="zone-slider-bg">
                                    <div class="zone-marker equilibrium"></div>
                                    <div class="absolute top-2 right-2 text-xs font-bold text-red-700 opacity-50">
                                        PREMIUM</div>
                                    <div class="absolute top-1/2 mt-1 right-2 text-xs font-bold text-slate-500">EQ (50%)
                                    </div>
                                    <div class="absolute bottom-2 right-2 text-xs font-bold text-green-700 opacity-50">
                                        DISCOUNT</div>

                                    <!-- Draggable Handle -->
                                    <div id="price-handle" class="price-handle" draggable="false">
                                        Precio
                                    </div>
                                </div>
                                <div class="flex justify-between text-xs font-bold text-slate-400 mt-1">
                                    <span>MIN (Low)</span>
                                </div>
                            </div>

                            <!-- El Panel de Feedback -->
                            <div class="w-full md:w-2/3 flex flex-col justify-center">
                                <div id="zone-feedback-card"
                                    class="bg-slate-50 border-l-4 border-slate-300 p-6 rounded-r-lg transition-colors duration-300">
                                    <h4 id="zone-title" class="text-lg font-bold text-slate-700 mb-2">Mueve el precio...
                                    </h4>
                                    <p id="zone-desc" class="text-sm text-slate-600">
                                        Arrastra el círculo en la barra vertical para simular dónde está el precio
                                        respecto a un impulso. Descubre cómo piensan las instituciones en cada zona.
                                    </p>
                                    <div id="zone-action"
                                        class="mt-4 inline-block px-3 py-1 rounded text-xs font-bold uppercase tracking-wider bg-slate-200 text-slate-500">
                                        Esperar
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Zona de Descuento -->
                <section id="descuento" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Zona de descuento: compras institucionales</h2>
                    <p class="text-slate-600 leading-7 mb-4">
                        La <strong>zona de descuento</strong> es el área por debajo del equilibrio en un movimiento
                        alcista. Es el territorio donde el dinero inteligente busca activamente oportunidades de compra.
                        Piensa en ello como una tienda de lujo en rebajas.
                    </p>
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white p-5 rounded-lg border border-slate-100 shadow-sm">
                            <h4 class="font-bold text-kawn-deep mb-2">Psicología</h4>
                            <p class="text-sm text-slate-600">Las instituciones compran cuando los minoristas venden por
                                miedo. Absorben liquidez a precios bajos.</p>
                        </div>
                        <div class="bg-white p-5 rounded-lg border border-slate-100 shadow-sm">
                            <h4 class="font-bold text-kawn-deep mb-2">Matemática</h4>
                            <p class="text-sm text-slate-600">Mejor ratio riesgo-beneficio. Stop loss ajustado bajo el
                                mínimo, objetivo expansivo hacia nuevos máximos.</p>
                        </div>
                    </div>

                    <h3 class="text-lg font-bold text-slate-800 mt-6 mb-3">Niveles OTE (Optimal Trade Entry)</h3>
                    <p class="text-slate-600 leading-7 mb-4">
                        No todos los descuentos son iguales. Los niveles clave son <strong>62%, 70.5% y 79%</strong>.
                        Aquí la probabilidad de reacción es máxima.
                    </p>

                    <!-- COMPONENTE INTERACTIVO 2: CALCULADORA OTE -->
                    <div class="bg-kawn-deep text-white rounded-xl shadow-card p-6 mb-8">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="calculator" class="text-kawn-light"></i>
                            <h3 class="font-bold">Calculadora de niveles OTE</h3>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-xs text-kawn-light mb-1">Precio bajo (Inicio impulso)</label>
                                <input type="number" id="ote-low" value="1.0000" step="0.0001"
                                    class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-sm focus:border-kawn-base focus:outline-none transition-colors">
                            </div>
                            <div>
                                <label class="block text-xs text-kawn-light mb-1">Precio alto (Fin impulso)</label>
                                <input type="number" id="ote-high" value="1.0500" step="0.0001"
                                    class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-sm focus:border-kawn-base focus:outline-none transition-colors">
                            </div>
                        </div>
                        <button onclick="calculateOTE()"
                            class="w-full bg-kawn-base hover:bg-kawn-light hover:text-kawn-deep text-white font-bold py-2 rounded transition-colors mb-4">
                            Calcular zonas institucionales
                        </button>
                        <div id="ote-results"
                            class="hidden space-y-2 bg-slate-800/50 p-4 rounded border border-slate-700">
                            <!-- Resultados insertados por JS -->
                        </div>
                    </div>
                </section>

                <!-- Zona Premium -->
                <section id="premium" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Zona premium: ventas institucionales</h2>
                    <p class="text-slate-600 leading-7 mb-4">
                        La <strong>zona premium</strong> es el espejo inverso: todo lo que está por encima del
                        equilibrio. Aquí el dinero inteligente distribuye posiciones largas o inicia cortos. Aprovechan
                        la euforia minorista (FOMO) para vender "caro".
                    </p>
                    <div class="quote-block">
                        "En tendencias bajistas fuertes, el precio a veces no llega al premium profundo. Un retroceso al
                        38% puede ser suficiente si la presión vendedora es masiva."
                    </div>
                    <p class="text-slate-600 leading-7">
                        Un premium de alta probabilidad ocurre tras una toma de liquidez de máximos previos y un cambio
                        de estructura (Market Structure Shift).
                    </p>
                </section>

                <!-- Regla de Oro & Disciplina -->
                <section id="regla-oro" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4 text-kawn-deep">La regla de oro</h2>
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-r-lg mb-6">
                        <p class="font-bold text-slate-800 text-lg mb-2">Mandamiento del trader profesional:</p>
                        <ul class="list-disc pl-5 space-y-2 text-slate-700">
                            <li>Comprar <strong>ÚNICAMENTE</strong> en zona de descuento.</li>
                            <li>Vender <strong>ÚNICAMENTE</strong> en zona premium.</li>
                        </ul>
                    </div>
                    <p class="text-slate-600 leading-7">
                        Esta regla exige disciplina de acero. La tentación de perseguir el precio es grande, pero entrar
                        fuera de zona destruye tu ventaja estadística. Es mejor perderse un movimiento ("miss out") que
                        perder dinero en una mala posición.
                    </p>
                </section>

                <!-- Simulador de Trading -->
                <section id="simuladores" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                        <i data-lucide="crosshair" class="text-red-500"></i>
                        Simulador de trading: francotirador institucional
                    </h2>
                    <p class="text-slate-600 mb-4">
                        Analiza el siguiente gráfico generado aleatoriamente. El mercado ha hecho un impulso. Tu misión
                        es esperar el retroceso y ejecutar la orden en el nivel correcto.
                    </p>

                    <!-- COMPONENTE INTERACTIVO 3: SIMULADOR PLOTLY -->
                    <div class="bg-white p-6 rounded-xl shadow-card border border-slate-200 relative">
                        <!-- AI Analysis Button (Absolute Position or in Flex) -->
                        <div class="absolute top-6 right-6 z-10">
                            <button onclick="consultarAnalistaIA()" id="btn-analista-ia"
                                class="hidden md:flex items-center gap-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white text-xs font-bold py-2 px-3 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                                <i data-lucide="sparkles" class="w-3 h-3"></i> Analista IA
                            </button>
                        </div>

                        <div id="trading-chart" class="w-full h-96 bg-slate-50 mb-4 rounded border border-slate-100">
                        </div>

                        <!-- AI Response Area -->
                        <div id="ai-analyst-response"
                            class="hidden mb-4 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                            <div class="flex items-start gap-3">
                                <div class="bg-indigo-100 p-2 rounded-full"><i data-lucide="brain-circuit"
                                        class="text-indigo-600 w-5 h-5"></i></div>
                                <div>
                                    <h4 class="font-bold text-indigo-900 text-sm mb-1">Opinión Institucional (IA)</h4>
                                    <p class="text-slate-700 text-xs leading-relaxed" id="ai-analyst-text">Analizando
                                        estructura de mercado...</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-4 items-center justify-between">
                            <div class="text-sm text-slate-500">
                                Precio actual: <span id="current-sim-price"
                                    class="font-mono font-bold text-slate-800">---</span>
                            </div>
                            <div class="flex flex-wrap gap-2 justify-center">
                                <button onclick="consultarAnalistaIA()"
                                    class="md:hidden flex items-center gap-2 bg-indigo-600 text-white text-xs font-bold py-2 px-3 rounded shadow">
                                    <i data-lucide="sparkles" class="w-3 h-3"></i> Analista IA
                                </button>
                                <button onclick="generateMarketMove()"
                                    class="px-4 py-2 text-sm bg-slate-200 hover:bg-slate-300 text-slate-700 rounded font-semibold transition-colors">
                                    Nuevo escenario
                                </button>
                                <button onclick="executeTrade('buy')"
                                    class="px-4 py-2 text-sm bg-kawn-base hover:bg-kawn-dark text-white rounded font-semibold transition-colors shadow-lg shadow-kawn-base/30">
                                    COMPRAR (Long)
                                </button>
                                <button onclick="executeTrade('sell')"
                                    class="px-4 py-2 text-sm bg-red-500 hover:bg-red-600 text-white rounded font-semibold transition-colors shadow-lg shadow-red-500/30">
                                    VENDER (Short)
                                </button>
                            </div>
                        </div>
                        <div id="trade-feedback" class="mt-4 hidden p-4 rounded-lg text-sm text-center font-bold"></div>
                    </div>
                </section>

                <!-- Casos Prácticos & Gestión -->
                <section id="casos-gestion" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Gestión y casos reales</h2>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-100">
                            <h3 class="font-bold text-kawn-deep mb-2">Gestión dinámica</h3>
                            <ul class="list-disc pl-5 space-y-2 text-slate-600 text-sm">
                                <li><strong>Breakeven:</strong> Mueve el stop a entrada cuando el precio regrese al
                                    equilibrio (50%).</li>
                                <li><strong>Toma de parciales:</strong> Cierra parte de la posición al entrar en la zona
                                    opuesta (premium si compraste).</li>
                            </ul>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-100">
                            <h3 class="font-bold text-kawn-deep mb-2">Conexión con ICT y Elliott</h3>
                            <p class="text-slate-600 text-sm mb-2">
                                <strong>ICT 2022:</strong> El modelo exige que el FVG de entrada esté en
                                descuento/premium.
                            </p>
                            <p class="text-slate-600 text-sm">
                                <strong>Ondas de Elliott:</strong> La onda 2 suele retroceder al descuento óptimo
                                (62-79%). La onda 4 suele ser más superficial (cerca del equilibrio).
                            </p>
                        </div>
                    </div>
                </section>

                <!-- Quiz Validación -->
                <section id="quiz" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                        <i data-lucide="award" class="text-kawn-base"></i> Validación del conocimiento
                    </h2>

                    <div class="bg-white p-8 rounded-xl shadow-card border border-slate-200 relative">
                        <!-- AI Quiz Generator Button -->
                        <div class="flex justify-end mb-4">
                            <button onclick="generarPreguntaIA()" id="btn-quiz-ia"
                                class="flex items-center gap-2 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white text-xs font-bold py-2 px-4 rounded-full shadow-md transition-all">
                                <i data-lucide="sparkles" class="w-4 h-4"></i> Desafío Infinito (IA)
                            </button>
                        </div>

                        <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                            <h3 class="text-lg font-bold text-slate-700">Evaluación capítulo 4</h3>
                            <span id="score-display"
                                class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-xs font-bold">Puntos:
                                0/4</span>
                        </div>

                        <!-- Pregunta IA Container (Hidden by default) -->
                        <div id="ai-question-container"
                            class="hidden mb-8 bg-emerald-50 border border-emerald-200 p-6 rounded-lg relative overflow-hidden">
                            <div
                                class="absolute top-0 right-0 bg-emerald-200 text-emerald-800 text-[10px] font-bold px-2 py-1 rounded-bl">
                                GENERADO POR IA</div>
                            <p class="font-bold text-slate-800 mb-3 flex items-start gap-2">
                                <i data-lucide="brain-circuit" class="w-5 h-5 text-emerald-600 shrink-0 mt-0.5"></i>
                                <span id="ai-q-text">Cargando pregunta...</span>
                            </p>
                            <div class="space-y-2" id="ai-q-options">
                                <!-- Options will be injected here -->
                            </div>
                            <div id="ai-q-feedback"
                                class="hidden mt-3 text-sm font-semibold p-3 bg-white rounded border"></div>
                        </div>

                        <!-- Pregunta 1 -->
                        <div class="mb-8">
                            <p class="font-semibold text-slate-800 mb-3">1. ¿Qué representa el nivel de equilibrio en un
                                impulso?</p>
                            <div class="space-y-2" id="q1-options">
                                <button
                                    class="quiz-option w-full text-left p-3 rounded border border-slate-200 text-sm text-slate-600"
                                    onclick="checkAnswer(1, 'a')">A. El nivel donde los minoristas ponen sus
                                    stops.</button>
                                <button
                                    class="quiz-option w-full text-left p-3 rounded border border-slate-200 text-sm text-slate-600"
                                    onclick="checkAnswer(1, 'b')">B. El punto medio exacto (50%) del rango, donde
                                    fuerzas se balancean.</button>
                                <button
                                    class="quiz-option w-full text-left p-3 rounded border border-slate-200 text-sm text-slate-600"
                                    onclick="checkAnswer(1, 'c')">C. El inicio del movimiento impulsivo.</button>
                            </div>
                            <div id="feedback-1" class="hidden mt-3"></div>
                        </div>

                        <!-- Pregunta 2 -->
                        <div class="mb-8">
                            <p class="font-semibold text-slate-800 mb-3">2. Según la regla de oro, si quieres COMPRAR,
                                ¿dónde debes hacerlo?</p>
                            <div class="space-y-2" id="q2-options">
                                <button
                                    class="quiz-option w-full text-left p-3 rounded border border-slate-200 text-sm text-slate-600"
                                    onclick="checkAnswer(2, 'a')">A. En zona premium, cuando rompe máximos.</button>
                                <button
                                    class="quiz-option w-full text-left p-3 rounded border border-slate-200 text-sm text-slate-600"
                                    onclick="checkAnswer(2, 'b')">B. En el equilibrio exacto siempre.</button>
                                <button
                                    class="quiz-option w-full text-left p-3 rounded border border-slate-200 text-sm text-slate-600"
                                    onclick="checkAnswer(2, 'c')">C. Únicamente en zona de descuento (por debajo del
                                    50%).</button>
                            </div>
                            <div id="feedback-2" class="hidden mt-3"></div>
                        </div>

                        <!-- Pregunta 3 -->
                        <div class="mb-8">
                            <p class="font-semibold text-slate-800 mb-3">3. ¿Cuáles son los niveles de retroceso
                                conocidos como "descuento óptimo" (OTE)?</p>
                            <div class="space-y-2" id="q3-options">
                                <button
                                    class="quiz-option w-full text-left p-3 rounded border border-slate-200 text-sm text-slate-600"
                                    onclick="checkAnswer(3, 'a')">A. 62%, 70.5% y 79%.</button>
                                <button
                                    class="quiz-option w-full text-left p-3 rounded border border-slate-200 text-sm text-slate-600"
                                    onclick="checkAnswer(3, 'b')">B. 38% y 50%.</button>
                                <button
                                    class="quiz-option w-full text-left p-3 rounded border border-slate-200 text-sm text-slate-600"
                                    onclick="checkAnswer(3, 'c')">C. Solo el 61.8% de Fibonacci.</button>
                            </div>
                            <div id="feedback-3" class="hidden mt-3"></div>
                        </div>

                        <!-- Pregunta 4 -->
                        <div class="mb-8">
                            <p class="font-semibold text-slate-800 mb-3">4. En una tendencia bajista muy fuerte, ¿qué
                                sucede a menudo con la zona premium?</p>
                            <div class="space-y-2" id="q4-options">
                                <button
                                    class="quiz-option w-full text-left p-3 rounded border border-slate-200 text-sm text-slate-600"
                                    onclick="checkAnswer(4, 'a')">A. El precio siempre llega al 79% antes de
                                    caer.</button>
                                <button
                                    class="quiz-option w-full text-left p-3 rounded border border-slate-200 text-sm text-slate-600"
                                    onclick="checkAnswer(4, 'b')">B. Puede no alcanzarse; retrocesos superficiales
                                    (20-30%) son comunes.</button>
                                <button
                                    class="quiz-option w-full text-left p-3 rounded border border-slate-200 text-sm text-slate-600"
                                    onclick="checkAnswer(4, 'c')">C. El mercado se invierte y se vuelve
                                    alcista.</button>
                            </div>
                            <div id="feedback-4" class="hidden mt-3"></div>
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <!-- AI Mentor Button & Modal -->
    <div class="fixed bottom-6 right-6 z-50">
        <button id="ai-toggle-btn"
            class="bg-slate-900 hover:bg-slate-800 text-white p-4 rounded-full shadow-2xl transition-all hover:scale-105 flex items-center gap-2 group">
            <i data-lucide="bot" class="text-kawn-base group-hover:text-white transition-colors"></i>
            <span class="font-bold hidden md:inline">Mentor KawnBit</span>
        </button>
    </div>

    <div id="ai-modal"
        class="hidden fixed bottom-24 right-6 w-80 md:w-96 bg-white rounded-xl shadow-2xl border border-slate-200 z-50 flex flex-col max-h-[500px]">
        <div class="p-4 bg-slate-900 text-white rounded-t-xl flex justify-between items-center">
            <h3 class="font-bold flex items-center gap-2 text-sm"><i data-lucide="sparkles"
                    class="text-kawn-base w-4 h-4"></i> Asistente institucional</h3>
            <button id="ai-close-btn" class="hover:text-kawn-base"><i data-lucide="x" class="w-4 h-4"></i></button>
        </div>
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 bg-slate-50 flex flex-col min-h-[300px]">
            <div class="ai-message chat-message">
                Hola. Soy tu mentor de Smart Money. ¿Tienes dudas sobre cómo identificar el equilibrio o dónde colocar
                tu stop en zona de descuento?
            </div>
        </div>
        <div class="p-3 border-t border-slate-200 bg-white rounded-b-xl flex gap-2">
            <input type="text" id="ai-input"
                class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-kawn-base"
                placeholder="Pregunta sobre el Cap. 4...">
            <button id="ai-send-btn"
                class="bg-kawn-base text-white p-2 rounded-lg hover:bg-kawn-dark transition-colors">
                <i data-lucide="send" class="w-4 h-4"></i>
            </button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-10 mt-12 border-t border-slate-800">
        <div
            class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="kawn-logo-wrapper">
                <div class="kawn-logo-icon"></div>
                <div class="kawn-logo-text">
                    <span class="kawn-brand-name text-white">KAWNBIT</span>
                    <span class="kawn-brand-sub text-kawn-base">QUANTITATIVE TRADING COMMUNITY</span>
                </div>
            </div>
            <div class="text-center md:text-right text-xs">
                <p>&copy; <span id="year"></span> KawnBit. Todos los derechos reservados.</p>
                <p class="mt-1 opacity-50">Material educativo. No constituye asesoramiento financiero.</p>
            </div>
        </div>
    </footer>

    <!-- LÓGICA DE LA APLICACIÓN -->
    <script>
        // Inicializar Iconos
        lucide.createIcons();

        // Footer Año Dinámico
        document.getElementById('year').textContent = new Date().getFullYear();
        const proxyUrl = "/.netlify/functions/gemini-proxy";

        // -----------------------------------------------------------------
        // 1. GENERACIÓN DINÁMICA DE TOC
        // -----------------------------------------------------------------
        const headers = document.querySelectorAll('main h2, main h3');
        const tocContainer = document.getElementById('toc-container');

        headers.forEach((header, index) => {
            if (!header.id) header.id = `section-${index}`;
            const link = document.createElement('a');
            link.href = `#${header.id}`;
            link.textContent = header.innerText;
            link.className = `toc-link ${header.tagName === 'H3' ? 'toc-sublink' : ''}`;

            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById(header.id).scrollIntoView({ behavior: 'smooth' });
            });

            tocContainer.appendChild(link);
        });

        // Intersection Observer para TOC Activo
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    document.querySelectorAll('.toc-link').forEach(l => l.classList.remove('active'));
                    const activeLink = document.querySelector(`.toc-link[href="#${entry.target.id}"]`);
                    if (activeLink) activeLink.classList.add('active');
                }
            });
        }, { rootMargin: '-10% 0px -70% 0px' });
        headers.forEach(h => observer.observe(h));

        // Barra de Progreso de Lectura
        window.onscroll = function () {
            let winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            let height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            let scrolled = (winScroll / height) * 100;
            document.getElementById("reading-progress").style.width = scrolled + "%";
        };

        // -----------------------------------------------------------------
        // 2. COMPONENTE INTERACTIVO 1: VISUALIZADOR DE ZONAS (SLIDER)
        // -----------------------------------------------------------------
        const handle = document.getElementById('price-handle');
        const sliderBg = document.getElementById('zone-slider-bg');
        const zoneTitle = document.getElementById('zone-title');
        const zoneDesc = document.getElementById('zone-desc');
        const zoneAction = document.getElementById('zone-action');
        const zoneFeedbackCard = document.getElementById('zone-feedback-card');

        let isDragging = false;

        handle.addEventListener('mousedown', () => isDragging = true);
        window.addEventListener('mouseup', () => isDragging = false);

        sliderBg.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const rect = sliderBg.getBoundingClientRect();
            let y = e.clientY - rect.top;
            if (y < 0) y = 0;
            if (y > rect.height) y = rect.height;

            // Mover handle
            handle.style.top = `${y}px`;

            const percentPrice = 100 - ((y / rect.height) * 100);
            updateZoneFeedback(percentPrice);
        });

        // Soporte Táctil
        handle.addEventListener('touchstart', () => isDragging = true);
        window.addEventListener('touchend', () => isDragging = false);
        sliderBg.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const touch = e.touches[0];
            const rect = sliderBg.getBoundingClientRect();
            let y = touch.clientY - rect.top;
            if (y < 0) y = 0;
            if (y > rect.height) y = rect.height;
            handle.style.top = `${y}px`;
            const percentPrice = 100 - ((y / rect.height) * 100);
            updateZoneFeedback(percentPrice);
            e.preventDefault(); // Prevenir scroll
        }, { passive: false });

        function updateZoneFeedback(price) {
            handle.innerText = `$${Math.round(price)}`;

            zoneFeedbackCard.className = "bg-white border-l-4 p-6 rounded-r-lg shadow-sm transition-colors duration-300";

            if (price > 55) {
                // PREMIUM
                zoneFeedbackCard.classList.add('border-red-500');
                zoneTitle.innerText = "ZONA PREMIUM (>50%)";
                zoneTitle.className = "text-lg font-bold text-red-700 mb-2";
                zoneDesc.innerText = "El precio está caro. Las instituciones buscan VENDER para tomar ganancias o iniciar cortos. Comprar aquí es riesgoso (FOMO).";
                zoneAction.innerText = "ACCIÓN: BUSCAR VENTAS";
                zoneAction.className = "mt-4 inline-block px-3 py-1 rounded text-xs font-bold uppercase tracking-wider bg-red-100 text-red-700";
            } else if (price < 45) {
                // DISCOUNT
                zoneFeedbackCard.classList.add('border-green-500');
                zoneTitle.innerText = "ZONA DE DESCUENTO (<50%)";
                zoneTitle.className = "text-lg font-bold text-green-700 mb-2";
                zoneDesc.innerText = "El precio está barato. Las instituciones aprovechan para ACUMULAR posiciones largas. Aquí obtienes el mejor ratio riesgo/beneficio.";
                zoneAction.innerText = "ACCIÓN: BUSCAR COMPRAS";
                zoneAction.className = "mt-4 inline-block px-3 py-1 rounded text-xs font-bold uppercase tracking-wider bg-green-100 text-green-700";
            } else {
                // EQUILIBRIUM
                zoneFeedbackCard.classList.add('border-slate-500');
                zoneTitle.innerText = "EQUILIBRIO (~50%)";
                zoneTitle.className = "text-lg font-bold text-slate-700 mb-2";
                zoneDesc.innerText = "Punto medio. Zona de indecisión o confirmación. Si el precio rebota aquí, la tendencia es fuerte. Espera confirmación.";
                zoneAction.innerText = "ACCIÓN: OBSERVAR / BREAKEVEN";
                zoneAction.className = "mt-4 inline-block px-3 py-1 rounded text-xs font-bold uppercase tracking-wider bg-slate-200 text-slate-700";
            }
        }

        // -----------------------------------------------------------------
        // 3. COMPONENTE INTERACTIVO 2: CALCULADORA OTE
        // -----------------------------------------------------------------
        function calculateOTE() {
            const low = parseFloat(document.getElementById('ote-low').value);
            const high = parseFloat(document.getElementById('ote-high').value);
            const resultsDiv = document.getElementById('ote-results');

            if (isNaN(low) || isNaN(high) || low >= high) {
                alert("Por favor ingresa un rango válido (Bajo < Alto).");
                return;
            }

            const range = high - low;
            const eq = low + (range * 0.5);
            const fib62 = low + (range * 0.382);
            const fib705 = low + (range * 0.295);
            const fib79 = low + (range * 0.21);

            resultsDiv.innerHTML = `
                <div class="flex justify-between items-center text-sm border-b border-slate-600 pb-2">
                    <span class="text-slate-400">Equilibrio (50%)</span>
                    <span class="font-mono font-bold text-white">${eq.toFixed(4)}</span>
                </div>
                <div class="flex justify-between items-center text-sm">
                    <span class="text-kawn-base font-bold">OTE 62%</span>
                    <span class="font-mono font-bold text-kawn-light">${fib62.toFixed(4)}</span>
                </div>
                <div class="flex justify-between items-center text-sm">
                    <span class="text-kawn-base font-bold">OTE 70.5%</span>
                    <span class="font-mono font-bold text-kawn-light">${fib705.toFixed(4)}</span>
                </div>
                <div class="flex justify-between items-center text-sm">
                    <span class="text-kawn-base font-bold">OTE 79%</span>
                    <span class="font-mono font-bold text-kawn-light">${fib79.toFixed(4)}</span>
                </div>
                <p class="text-xs text-slate-400 mt-2 italic text-center">Busca entradas de compra en estos niveles si el impulso fue alcista.</p>
            `;
            resultsDiv.classList.remove('hidden');
        }

        // -----------------------------------------------------------------
        // 4. COMPONENTE INTERACTIVO 3: SIMULADOR DE TRADING + IA
        // -----------------------------------------------------------------
        let currentMarketState = 'waiting';
        let simHigh, simLow, simCurrent, simEquilibrium;

        function generateMarketMove() {
            // Reset AI box
            document.getElementById('ai-analyst-response').classList.add('hidden');
            document.getElementById('btn-analista-ia').disabled = false;
            document.getElementById('btn-analista-ia').innerHTML = '<i data-lucide="sparkles" class="w-3 h-3"></i> Analista IA';

            const basePrice = 100;
            // Generate basic range
            simLow = basePrice;
            simHigh = basePrice + Math.floor(Math.random() * 40) + 20;
            simEquilibrium = simLow + (simHigh - simLow) * 0.5;

            // Current price somewhere in the retracement
            const retracementLevel = Math.random(); // 0 to 1
            simCurrent = simHigh - (simHigh - simLow) * retracementLevel;

            // Generate Candle Data (Synthetic Random Walk)
            // 1. Impulse Phase (Up)
            let candlesOpen = [];
            let candlesHigh = [];
            let candlesLow = [];
            let candlesClose = [];
            let times = [];

            let price = simLow;
            let steps = 25; // More steps
            // We want to reach roughly simHigh in 'steps'
            // Base drift per step
            let drift = (simHigh - simLow) / steps;
            let volatility = 0.8; // Daily volatility

            for (let i = 0; i < steps; i++) {
                times.push(i);
                let open = price;
                // Random walk step
                let change = drift + (Math.random() - 0.5) * volatility * 2;
                let close = open + change;

                // Add wicks
                let high = Math.max(open, close) + Math.random() * volatility * 0.5;
                let low = Math.min(open, close) - Math.random() * volatility * 0.5;

                candlesOpen.push(open);
                candlesClose.push(close);
                candlesHigh.push(high);
                candlesLow.push(low);
                price = close;
            }

            // Adjust the peak to ensure it hits simHigh mostly
            let peakIndex = steps - 1;
            candlesHigh[peakIndex] = Math.max(candlesHigh[peakIndex], simHigh);

            // 2. Retracement Phase (Down) to simCurrent
            let retracementSteps = 15;
            let priceDown = candlesClose[peakIndex];
            let driftDown = (simCurrent - priceDown) / retracementSteps;

            for (let i = 0; i < retracementSteps; i++) {
                times.push(steps + i);
                let open = priceDown;
                let change = driftDown + (Math.random() - 0.5) * volatility * 2;
                let close = open + change;

                let high = Math.max(open, close) + Math.random() * volatility * 0.5;
                let low = Math.min(open, close) - Math.random() * volatility * 0.5;

                candlesOpen.push(open);
                candlesClose.push(close);
                candlesHigh.push(high);
                candlesLow.push(low);
                priceDown = close;
            }

            const trace = {
                x: times,
                open: candlesOpen,
                high: candlesHigh,
                low: candlesLow,
                close: candlesClose,
                type: 'candlestick',
                increasing: { line: { color: '#10b981' } }, // Emerald
                decreasing: { line: { color: '#ef4444' } }, // Red
                name: 'Precio'
            };

            const layout = {
                title: 'Escenario de mercado',
                dragmode: false,
                showlegend: false,
                xaxis: { visible: false, rangeslider: { visible: false } },
                yaxis: { title: 'Precio ($)', gridcolor: '#e2e8f0' },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                shapes: [
                    // Premium Zone (Red tint)
                    {
                        type: 'rect', x0: 0, x1: 1, xref: 'paper',
                        y0: simEquilibrium, y1: simHigh + 5, yref: 'y',
                        fillcolor: 'rgba(239, 68, 68, 0.1)', line: { width: 0 }
                    },
                    // Discount Zone (Green tint)
                    {
                        type: 'rect', x0: 0, x1: 1, xref: 'paper',
                        y0: simLow - 5, y1: simEquilibrium, yref: 'y',
                        fillcolor: 'rgba(16, 185, 129, 0.1)', line: { width: 0 }
                    },
                    // Equilibrium Line
                    {
                        type: 'line', x0: 0, x1: 1, xref: 'paper',
                        y0: simEquilibrium, y1: simEquilibrium, yref: 'y',
                        line: { color: '#334155', width: 2, dash: 'dot' }
                    }
                ],
                annotations: [
                    { x: 0.05, y: simHigh, xref: 'paper', yref: 'y', text: 'Premium', showarrow: false, font: { color: '#ef4444', size: 10 }, xanchor: 'left' },
                    { x: 0.05, y: simLow, xref: 'paper', yref: 'y', text: 'Discount', showarrow: false, font: { color: '#10b981', size: 10 }, xanchor: 'left' },
                    { x: 0.95, y: simEquilibrium, xref: 'paper', yref: 'y', text: 'EQ (50%)', showarrow: false, font: { color: '#334155', size: 10 }, xanchor: 'right' }
                ]
            };

            Plotly.newPlot('trading-chart', [trace], layout, { staticPlot: true, responsive: true });

            document.getElementById('current-sim-price').innerText = simCurrent.toFixed(2);
            document.getElementById('trade-feedback').className = "mt-4 hidden p-4 rounded-lg text-sm text-center font-bold";
            currentMarketState = 'active';
        }

        async function consultarAnalistaIA() {
            if (currentMarketState !== 'active') {
                alert("Primero genera un escenario de mercado.");
                return;
            }

            const btn = document.getElementById('btn-analista-ia');
            const outputBox = document.getElementById('ai-analyst-response');
            const outputText = document.getElementById('ai-analyst-text');

            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Analizando...`;

            outputBox.classList.remove('hidden');
            outputText.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';

            const prompt = `Actúa como un trader institucional senior cínico. El mercado hizo un impulso de ${simLow.toFixed(2)} a ${simHigh.toFixed(2)} y ahora está en ${simCurrent.toFixed(2)}. 
            El equilibrio está en ${simEquilibrium.toFixed(2)}.
            Evalúa si estamos en DESCUENTO o PREMIUM. Dame un consejo táctico breve (máximo 2 frases) sobre qué esperar (barrida de liquidez, entrada, trampa).`;

            try {
                const response = await fetch(proxyUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                const data = await response.json();
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || data.result || "Error en la respuesta.";
                outputText.innerText = reply;
                lucide.createIcons();
            } catch (e) {
                outputText.innerText = "Error de conexión con el analista.";
            } finally {
                btn.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i> Analizado`;
                lucide.createIcons();
            }
        }

        function executeTrade(type) {
            if (currentMarketState !== 'active') {
                alert("Genera un nuevo escenario primero.");
                return;
            }

            const feedback = document.getElementById('trade-feedback');
            feedback.classList.remove('hidden');

            const isDiscount = simCurrent < simEquilibrium;
            const isPremium = simCurrent > simEquilibrium;

            if (type === 'buy') {
                if (isDiscount) {
                    feedback.className = "mt-4 p-4 rounded-lg text-sm text-center font-bold bg-green-100 text-green-800 border border-green-300";
                    feedback.innerHTML = "¡EXCELENTE! Compraste en DESCUENTO. Estás alineado con las instituciones. Tu probabilidad de éxito es alta.";
                } else {
                    feedback.className = "mt-4 p-4 rounded-lg text-sm text-center font-bold bg-red-100 text-red-800 border border-red-300";
                    feedback.innerHTML = "¡ERROR! Compraste en PREMIUM (Caro). Estás persiguiendo el precio. Las instituciones probablemente venderán aquí.";
                }
            } else if (type === 'sell') {
                if (isPremium) {
                    feedback.className = "mt-4 p-4 rounded-lg text-sm text-center font-bold bg-yellow-100 text-yellow-800 border border-yellow-300";
                    feedback.innerHTML = "BIEN... PERO CUIDADO. Vendiste en premium, lo cual es correcto para venta, pero recuerda que la tendencia es alcista (Onda 4?). Trade de corrección válido.";
                } else {
                    feedback.className = "mt-4 p-4 rounded-lg text-sm text-center font-bold bg-red-100 text-red-800 border border-red-300";
                    feedback.innerHTML = "¡ERROR FATAL! Vendiste en DESCUENTO. Estás vendiendo barato justo donde las instituciones compran para subir el precio.";
                }
            }
        }

        document.addEventListener('DOMContentLoaded', generateMarketMove);

        // -----------------------------------------------------------------
        // 5. QUIZ DE VALIDACIÓN + IA GENERATOR
        // -----------------------------------------------------------------
        const answers = { 1: 'b', 2: 'c', 3: 'a', 4: 'b' };

        // Explicaciones detalladas para cada pregunta
        const explanations = {
            1: "<strong>Solución:</strong> El equilibrio es matemáticamente el retroceso del 50% de un rango impulsivo. Conceptualmente, es el punto donde las fuerzas de oferta y demanda encuentran un balance temporal antes de decidir la siguiente dirección. No es donde se ponen los stops (liquidez) ni el inicio del movimiento.",
            2: "<strong>Solución:</strong> La regla fundamental del Smart Money es 'Comprar barato y Vender caro'. La zona 'barata' es el Descuento (por debajo del 50%). Comprar en Premium es perseguir el precio (caro) y comprar en el equilibrio es indecisión.",
            3: "<strong>Solución:</strong> Los niveles OTE (Optimal Trade Entry) definidos en la metodología son el 62%, 70.5% y 79%. El 61.8% es un nivel de Fibonacci clásico, pero OTE incluye específicamente la zona profunda hasta el 79% donde las instituciones acumulan con mayor probabilidad.",
            4: "<strong>Solución:</strong> Cuando el momentum bajista es extremadamente fuerte, el mercado no da 'respiro'. Las instituciones venden agresivamente en cualquier pequeño rebote, por lo que a menudo el precio solo retrocede un 20% o 30% (Premium superficial) antes de continuar cayendo."
        };

        let score = 0;
        let answered = new Set();
        let aiQuestionCorrectAnswer = "";

        function checkAnswer(q, opt) {
            if (answered.has(q)) return;
            answered.add(q);

            const feedback = document.getElementById(`feedback-${q}`);
            const buttons = document.querySelectorAll(`#q${q}-options button`);

            buttons.forEach(btn => {
                btn.classList.add('disabled', 'cursor-not-allowed', 'opacity-70');
                if (btn.getAttribute('onclick').includes(`'${answers[q]}'`)) {
                    btn.classList.add('correct', 'font-bold');
                } else if (btn.getAttribute('onclick').includes(`'${opt}'`) && opt !== answers[q]) {
                    btn.classList.add('incorrect');
                }
            });

            feedback.classList.remove('hidden');

            if (opt === answers[q]) {
                score++;
                feedback.innerHTML = `<div class="p-3 bg-green-50 border border-green-200 rounded text-green-800 text-sm"><span class="font-bold block mb-1">¡Correcto!</span>${explanations[q]}</div>`;
            } else {
                feedback.innerHTML = `<div class="p-3 bg-red-50 border border-red-200 rounded text-red-800 text-sm"><span class="font-bold block mb-1">Incorrecto.</span>${explanations[q]}</div>`;
            }
            document.getElementById('score-display').innerText = `Puntos: ${score}/4`;
        }

        async function generarPreguntaIA() {
            const container = document.getElementById('ai-question-container');
            const qText = document.getElementById('ai-q-text');
            const qOptions = document.getElementById('ai-q-options');
            const btn = document.getElementById('btn-quiz-ia');
            const feedback = document.getElementById('ai-q-feedback');

            container.classList.remove('hidden');
            feedback.classList.add('hidden');
            qText.innerHTML = '<span class="typing-dots"><span></span><span></span><span></span></span> Generando desafío único...';
            qOptions.innerHTML = '';
            btn.disabled = true;

            const prompt = `Genera un objeto JSON válido con una pregunta de opción múltiple difícil sobre 'Smart Money Concepts: Equilibrio, Premium y Descuento'. 
            Formato exacto: {"pregunta": "texto", "opciones": ["Opción A", "Opción B", "Opción C"], "respuesta_correcta": "índice 0, 1 o 2", "explicacion": "breve explicación"}. 
            Devuelve SOLO el JSON sin markdown.`;

            try {
                const response = await fetch(proxyUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();
                let rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || data.result;
                // Clean markdown if present
                rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();

                const questionData = JSON.parse(rawText);

                qText.innerText = questionData.pregunta;
                aiQuestionCorrectAnswer = questionData.respuesta_correcta; // Index 0, 1, 2

                questionData.opciones.forEach((opt, index) => {
                    const btnOpt = document.createElement('button');
                    btnOpt.className = "quiz-option w-full text-left p-3 rounded border border-emerald-200 text-sm text-slate-700 bg-white mb-2 hover:bg-emerald-50";
                    btnOpt.innerText = opt;
                    btnOpt.onclick = () => checkAIAnswer(index, questionData.respuesta_correcta, questionData.explicacion, btnOpt);
                    qOptions.appendChild(btnOpt);
                });

            } catch (e) {
                console.error(e);
                qText.innerText = "Error generando la pregunta. Inténtalo de nuevo.";
            } finally {
                btn.disabled = false;
            }
        }

        function checkAIAnswer(selectedIndex, correctIndex, explanation, btnElement) {
            const feedback = document.getElementById('ai-q-feedback');
            const allBtns = document.getElementById('ai-q-options').children;

            // Convert strings to int if needed
            const correct = parseInt(correctIndex);

            for (let btn of allBtns) {
                btn.disabled = true;
                btn.classList.add('cursor-not-allowed', 'opacity-70');
            }

            feedback.classList.remove('hidden');

            if (selectedIndex === correct) {
                btnElement.classList.add('bg-emerald-100', 'border-emerald-500', 'text-emerald-800');
                feedback.className = "mt-3 text-sm font-semibold p-3 bg-emerald-100 text-emerald-800 rounded border border-emerald-300";
                feedback.innerHTML = `<strong>¡Correcto!</strong> ${explanation}`;
            } else {
                btnElement.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                // Highlight correct one
                allBtns[correct].classList.add('bg-emerald-100', 'border-emerald-500', 'text-emerald-800');
                feedback.className = "mt-3 text-sm font-semibold p-3 bg-red-100 text-red-800 rounded border border-red-300";
                feedback.innerHTML = `<strong>Incorrecto.</strong> ${explanation}`;
            }
        }


        // -----------------------------------------------------------------
        // 6. INTEGRACIÓN IA (Chat General)
        // -----------------------------------------------------------------
        const aiModal = document.getElementById('ai-modal');
        const aiToggle = document.getElementById('ai-toggle-btn');
        const aiClose = document.getElementById('ai-close-btn');
        const aiSend = document.getElementById('ai-send-btn');
        const aiInput = document.getElementById('ai-input');
        const chatContainer = document.getElementById('chat-container');

        aiToggle.addEventListener('click', () => aiModal.classList.remove('hidden'));
        aiClose.addEventListener('click', () => aiModal.classList.add('hidden'));

        async function sendMessage() {
            const text = aiInput.value.trim();
            if (!text) return;

            const userDiv = document.createElement('div');
            userDiv.className = 'user-message chat-message';
            userDiv.innerText = text;
            chatContainer.appendChild(userDiv);
            aiInput.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'ai-message chat-message animate-pulse';
            loadingDiv.innerText = 'Pensando...';
            chatContainer.appendChild(loadingDiv);

            try {
                const response = await fetch(proxyUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Eres un experto mentor en Trading Institucional (SMC). El usuario está estudiando el capítulo 4 "Equilibrio, descuento y premium". Responde de forma breve y profesional a: ${text}`
                            }]
                        }]
                    })
                });

                const data = await response.json();
                chatContainer.removeChild(loadingDiv);

                const aiDiv = document.createElement('div');
                aiDiv.className = 'ai-message chat-message';
                aiDiv.innerText = data.candidates?.[0]?.content?.parts?.[0]?.text || data.result || "Error al conectar con el servidor.";
                chatContainer.appendChild(aiDiv);

            } catch (error) {
                chatContainer.removeChild(loadingDiv);
                const errDiv = document.createElement('div');
                errDiv.className = 'ai-message chat-message text-red-600';
                errDiv.innerText = "Error de conexión.";
                chatContainer.appendChild(errDiv);
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        aiSend.addEventListener('click', sendMessage);
        aiInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            const sidebar = document.querySelector('aside');
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('fixed');
            sidebar.classList.toggle('inset-0');
            sidebar.classList.toggle('bg-white');
            sidebar.classList.toggle('z-40');
            sidebar.classList.toggle('p-8');
            sidebar.classList.toggle('pt-24');
        });

    </script>
</body>

</html>