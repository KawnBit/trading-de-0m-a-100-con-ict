<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KawnBit Magazine: Bloques de Órdenes (Order Blocks)</title>
    <!-- Fuentes y Estilos -->
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* KawnBit Palette */
            --primary-teal: #4db6ac;
            --secondary-teal: #00897b;
            --dark-teal: #004d40;
            --accent-dark: #263238;
            --text-grey: #455a64;
            --light-bg: #f4f7f6;
            --white: #ffffff;
            --danger: #e57373;
            --danger-dark: #c62828;
            --success: #66bb6a;
            --gradient-teal: linear-gradient(135deg, var(--primary-teal), var(--secondary-teal));
            --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            color: var(--text-grey);
            background-color: var(--light-bg);
            margin: 0;
            padding: 0;
            line-height: 1.8;
        }

        /* Tipografía */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Montserrat', sans-serif;
            color: var(--accent-dark);
            font-weight: 700;
        }

        h1 {
            font-size: 2.5rem;
            text-transform: uppercase;
            letter-spacing: -1px;
            color: var(--secondary-teal);
            margin-bottom: 0.5em;
            line-height: 1.2;
        }

        h2 {
            font-size: 1.8rem;
            border-bottom: 3px solid var(--primary-teal);
            padding-bottom: 15px;
            margin-top: 60px;
            color: var(--dark-teal);
            position: relative;
        }

        h2::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 50px;
            height: 3px;
            background: var(--accent-dark);
        }

        h3 {
            font-size: 1.4rem;
            color: var(--secondary-teal);
            margin-top: 40px;
        }

        strong {
            color: var(--secondary-teal);
            font-weight: 700;
        }

        /* Layout */
        .container {
            max-width: 900px;
            margin: 40px auto;
            background-color: var(--white);
            padding: 60px;
            box-shadow: var(--shadow-soft);
            border-radius: 8px;
        }

        /* Header */
        .magazine-header {
            text-align: center;
            padding-bottom: 40px;
            border-bottom: 1px solid #eee;
            margin-bottom: 50px;
        }

        .logo-placeholder {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 3.5rem;
            background: var(--gradient-teal);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
            margin-bottom: 10px;
        }

        .logo-tagline {
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--secondary-teal);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .chapter-title {
            text-align: center;
            margin-bottom: 60px;
            padding: 40px;
            background: radial-gradient(circle at center, #e0f2f1 0%, #ffffff 70%);
            border-radius: 16px;
        }

        .intro-lead {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-dark);
            border-left: 5px solid var(--primary-teal);
            padding-left: 25px;
            margin-bottom: 40px;
            line-height: 1.8;
        }

        /* --- COMPONENTES INTERACTIVOS MODERNIZADOS --- */

        .infographic-box {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            margin: 50px 0;
            border: 1px solid #eef2f3;
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .infographic-box:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .infographic-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: var(--gradient-teal);
        }

        .infographic-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--dark-teal);
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            background: #e0f2f1;
            padding: 12px 25px;
            border-radius: 50px;
            width: fit-content;
        }

        .infographic-title i {
            margin-right: 12px;
            font-size: 1.2rem;
            color: var(--secondary-teal);
        }

        .btn-interact {
            background: var(--gradient-teal);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            box-shadow: 0 4px 15px rgba(0, 137, 123, 0.3);
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            margin-top: 20px;
        }

        .btn-interact:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 137, 123, 0.4);
        }

        .btn-interact:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-interact:active {
            transform: translateY(0);
        }

        .btn-loading {
            opacity: 0.7;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn-loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                -webkit-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }

        /* 1. CHART SVG ANIMATION */
        .chart-container {
            width: 100%;
            height: 300px;
            background: #fcfcfc;
            border: 1px solid #eee;
            border-radius: 12px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .candle-rect {
            stroke-width: 1.5;
        }

        .candle-wick {
            stroke-width: 1.5;
            stroke: #555;
        }

        .bull-fill {
            fill: #fff;
            stroke: #00c853;
        }

        /* Estilo Hollow para Bull */
        .bull-fill-solid {
            fill: #00c853;
            stroke: #00a042;
        }

        .bear-fill {
            fill: #ff5252;
            stroke: #d32f2f;
        }

        /* 2. SPONGE SVG */
        .sponge-scene {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
        }

        .sponge-visual {
            width: 120px;
            height: 120px;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* 3. PREMIUM/DISCOUNT SLIDER */
        .pd-tool {
            padding: 20px 0;
            text-align: center;
        }

        .range-slider-container {
            position: relative;
            width: 100%;
            height: 60px;
            margin: 30px 0;
            background: linear-gradient(to right, #e8f5e9 50%, #ffebee 50%);
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        .range-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 100%;
            background: transparent;
            outline: none;
            position: absolute;
            top: 0;
            left: 0;
            margin: 0;
            z-index: 2;
            cursor: pointer;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--dark-teal);
            border: 4px solid white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: transform 0.1s;
        }

        .range-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .mid-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #999;
            border-left: 1px dashed #555;
            z-index: 1;
        }

        .pd-feedback {
            font-weight: 800;
            font-size: 1.2rem;
            min-height: 1.5em;
            transition: color 0.3s;
        }

        /* 4. BREAKER ANIMATION */
        .breaker-svg-container {
            width: 100%;
            height: 250px;
            background: #fff;
            position: relative;
        }

        .path-line {
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .path-history {
            stroke: #cfd8dc;
            stroke-width: 2;
            stroke-dasharray: 4;
        }

        .path-active {
            stroke: var(--secondary-teal);
        }

        .breaker-zone {
            fill: rgba(229, 115, 115, 0.2);
            stroke: var(--danger);
            stroke-dasharray: 4;
        }

        /* 5. AMD CYCLE STYLES */
        .amd-container {
            width: 100%;
            height: 280px;
            background: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .amd-label {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 4px;
            position: absolute;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .amd-acc {
            background: #fff3e0;
            color: #e65100;
            border: 1px solid #ffe0b2;
        }

        .amd-man {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .amd-dist {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        /* 6. MEAN THRESHOLD STYLES */
        .mt-visualizer {
            background: #263238;
            /* Dark background for contrast */
            color: white;
            padding: 30px;
            border-radius: 16px;
            position: relative;
            text-align: center;
        }

        .mt-candle-container {
            width: 120px;
            height: 200px;
            margin: 0 auto;
            position: relative;
        }

        .mt-candle-body {
            width: 60px;
            height: 140px;
            background: #00e676;
            /* Bullish green */
            margin: 0 auto;
            position: relative;
            top: 30px;
            /* Space for wick */
            transition: background 0.3s;
        }

        .mt-candle-wick {
            width: 2px;
            height: 200px;
            background: white;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 0;
            z-index: 0;
        }

        .mt-threshold-line {
            position: absolute;
            top: 50%;
            /* Center of body */
            left: -20%;
            width: 140%;
            border-top: 2px dashed rgba(255, 255, 255, 0.7);
            z-index: 10;
        }

        .mt-dragger {
            position: absolute;
            right: -60px;
            top: 0;
            height: 100%;
            width: 40px;
            z-index: 20;
            /* Ensure touch catches it */
        }

        .mt-cursor {
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: 15px solid #ff9800;
            /* Arrow */
            position: absolute;
            right: 0;
            cursor: ns-resize;
            transition: top 0.1s;
        }

        .mt-price-line {
            position: absolute;
            left: -100px;
            /* Stretch into candle */
            right: 0;
            height: 2px;
            background: #ff9800;
            top: 10px;
            /* Relative to cursor */
        }

        .mt-status {
            margin-top: 15px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        /* 7. SCENARIO SIMULATOR */
        .scenario-box {
            background: #f3e5f5;
            border: 2px solid #ce93d8;
            border-radius: 16px;
            padding: 30px;
            margin: 50px 0;
        }

        .scenario-header {
            color: #7b1fa2;
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .scenario-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #ab47bc;
            font-style: italic;
            margin-bottom: 20px;
            min-height: 80px;
        }

        .scenario-solution {
            display: none;
            background: #e8f5e9;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #66bb6a;
        }


        /* AI Chat Modernizado */
        .ai-section-wrapper {
            background: linear-gradient(135deg, #e0f7fa 0%, #e0f2f1 100%);
            border-radius: 20px;
            padding: 40px;
            margin-top: 80px;
            border: 1px solid #b2dfdb;
        }

        .chat-interface {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 450px;
        }

        .chat-header {
            background: var(--dark-teal);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            justify-content: space-between;
        }

        .chat-messages-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-bubble {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 0.95rem;
            position: relative;
            animation: fadeIn 0.3s ease;
            line-height: 1.5;
            word-wrap: break-word;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bubble-user {
            align-self: flex-end;
            background: var(--secondary-teal);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .bubble-ai {
            align-self: flex-start;
            background: white;
            color: var(--text-grey);
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
        }

        .chat-input-wrapper {
            padding: 20px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

        .chat-input-field {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 30px;
            font-family: inherit;
            transition: border-color 0.3s;
            outline: none;
        }

        .chat-input-field:focus {
            border-color: var(--primary-teal);
        }

        .send-btn {
            background: var(--dark-teal);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            transform: scale(1.1);
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            font-size: 0.8rem;
            color: #999;
            margin-left: 20px;
            margin-bottom: 10px;
            display: none;
            font-style: italic;
        }

        /* Key config modal (simple inline) */
        .key-config-link {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            text-decoration: underline;
        }

        .key-config-link:hover {
            color: white;
        }

        /* Footer */
        .main-footer {
            margin-top: 80px;
            padding: 60px 20px;
            border-top: 1px solid #eee;
            text-align: center;
            background-color: #fafafa;
            color: #888;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
                margin: 0;
                border-radius: 0;
            }

            h1 {
                font-size: 1.8rem;
            }

            .chart-container {
                height: 220px;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="magazine-header">
            <div class="logo-placeholder">KawnBit</div>
            <div class="logo-tagline">Quantitative Trading Community</div>
        </header>

        <div class="chapter-title">
            <h1>Capítulo 6: Bloques de Órdenes (Order Blocks - OB)</h1>
            <p style="font-size: 1.2rem; color: var(--secondary-teal); font-weight: 600;">La piedra angular de las
                entradas de alta precisión</p>
        </div>

        <section>
            <h2>Introducción: comprendiendo la esencia de los Order Blocks</h2>
            <p class="intro-lead">Imagina por un momento que pudieras ver exactamente dónde los grandes inversores
                institucionales han dejado sus órdenes pendientes en el mercado. Sería como tener un mapa del tesoro que
                te muestra dónde el dinero inteligente está esperando para entrar o salir.</p>
            <p>Pues bien, eso es precisamente lo que representan los <strong>bloques de órdenes (Order Blocks)</strong>
                en la metodología ICT/SMC: son las huellas digitales que el <em>smart money</em> deja en los gráficos,
                marcando áreas donde se ejecutaron grandes volúmenes de compra o venta. Aprender a identificarlos y
                operarlos correctamente puede transformar radicalmente tu precisión como trader, ya que permiten
                adelantarte a movimientos institucionales y lograr entradas de alta calidad.</p>

            <p>Los bloques de órdenes son mucho más que simples velas en un gráfico; representan <strong>zonas de
                    consolidación donde ha habido una acumulación significativa de órdenes institucionales</strong>,
                generalmente antes de un movimiento fuerte de precio. Estas zonas actúan a menudo como niveles sólidos
                de soporte o resistencia posteriormente, porque cuando el precio regresa a un bloque de órdenes,
                frecuentemente observamos reacciones explosivas.</p>

            <div class="infographic-box">
                <div class="infographic-title"><i class="fas fa-shield-alt"></i> La Defensa Institucional</div>
                <div
                    style="display: flex; gap: 20px; align-items: center; justify-content: space-between; flex-wrap: wrap;">
                    <div style="flex: 2;">
                        <p style="margin-top: 0;">La razón es simple pero poderosa: el dinero inteligente protege sus
                            inversiones. Cuando el precio vuelve a sus zonas de entrada preferidas, las instituciones
                            tienen interés en <strong>defender esas posiciones o añadir más volumen</strong> a sus
                            operaciones existentes, generando giros bruscos del mercado. En términos sencillos, un
                            <em>Order Block</em> marca dónde las “manos fuertes” compraron o vendieron en grande, y por
                            eso al volver el precio allí suele reaccionar de forma notable, ofreciéndonos puntos de
                            entrada o salida muy precisos.
                        </p>
                    </div>
                    <div style="flex: 1; text-align: center; color: var(--secondary-teal);">
                        <i class="fas fa-chess-rook fa-4x"></i>
                        <p><small>Zona Protegida</small></p>
                    </div>
                </div>
            </div>

            <p><strong>¿Por qué son importantes los Order Blocks?</strong> A diferencia de los soportes y resistencias
                tradicionales (basados solo en máximos o mínimos anteriores visibles), los OB proporcionan información
                sobre liquidez oculta e intención institucional detrás del movimiento de precios. Son relevantes porque:
            </p>
            <ul>
                <li>Reflejan las posiciones de los grandes participantes (bancos, fondos) en niveles clave.</li>
                <li>A menudo marcan el origen de cambios de tendencia o rupturas significativas.</li>
                <li>Ayudan al trader a alinearse con la dirección del flujo institucional en vez de ir contra ella.</li>
            </ul>
            <p>En un mercado dominado por algoritmos de instituciones, identificar estas zonas ocultas de oferta y
                demanda institucional le da al trader minorista una ventaja considerable para anticipar movimientos
                futuros.</p>
        </section>

        <section>
            <h2>La anatomía de un Order Block: más allá de la superficie</h2>
            <p>Para comprender verdaderamente qué hace especial a un Order Block, necesitamos entender qué ocurre detrás
                de escena cuando se forma. Un OB típicamente aparece tras una fase de equilibrio o consolidación en el
                precio, seguida de un <strong>movimiento impulsivo desequilibrado</strong>.</p>
            <p>En esa consolidación previa, las fuerzas de compra y venta estuvieron momentáneamente en equilibrio (un
                rango estrecho donde el precio “respira”). Sin embargo, llega un punto en que un bando toma el control –
                ya sean compradores o vendedores institucionales – provocando una ruptura violenta del rango. Esa
                ruptura indica que las instituciones inyectaron órdenes masivas para impulsar el precio en una
                dirección, dejando tras de sí la zona de consolidación como un bloque de órdenes identificable.</p>

            <div class="infographic-box">
                <div class="infographic-title"><i class="fas fa-soap"></i> Analogía: La Esponja de Liquidez</div>
                <p>Pensemos en esto con una analogía: es como si fuera una esponja absorbiendo agua. La vela o conjunto
                    de velas que forman el Order Block representan el momento en que el <em>smart money</em> está
                    “absorbiendo” toda la liquidez disponible en una dirección.</p>

                <div class="sponge-scene">
                    <!-- SVG Sponge Representation -->
                    <svg class="sponge-visual" id="sponge-svg" viewBox="0 0 100 100">
                        <defs>
                            <radialGradient id="spongeGrad" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                                <stop offset="0%" style="stop-color:#ffecb3;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#ffb74d;stop-opacity:1" />
                            </radialGradient>
                        </defs>
                        <!-- Pores -->
                        <circle cx="50" cy="50" r="45" fill="url(#spongeGrad)" stroke="#f57c00" stroke-width="2" />
                        <circle cx="30" cy="40" r="5" fill="#f57c00" opacity="0.5" />
                        <circle cx="70" cy="60" r="6" fill="#f57c00" opacity="0.5" />
                        <circle cx="50" cy="20" r="4" fill="#f57c00" opacity="0.5" />
                        <circle cx="40" cy="70" r="5" fill="#f57c00" opacity="0.5" />
                        <text x="50" y="55" text-anchor="middle" fill="#e65100" font-weight="bold"
                            font-size="14">OB</text>
                    </svg>

                    <div id="sponge-status" style="font-weight: bold; color: var(--secondary-teal); height: 20px;">
                        Estado: Acumulando...</div>

                    <button class="btn-interact" aria-label="Simular absorción"
                        onclick="KawnBitApp.triggerSpongeAnimation()">
                        <i class="fas fa-play"></i> Simular Absorción y Expansión
                    </button>
                </div>
            </div>

            <p>Por ejemplo, en un OB alcista, las instituciones están absorbiendo todas las órdenes de venta (oferta)
                disponibles en ese nivel – a menudo tomando los <em>stop-loss</em> de traders minoristas ubicados justo
                debajo de un soporte – con el fin de acumular una gran posición de compra barata. Una vez que han
                absorbido suficiente liquidez (toda el agua en la esponja), <strong>el precio se mueve violentamente en
                    dirección contraria</strong>, dejando atrás esa zona como un punto de referencia crucial para el
                futuro.</p>
            <p>En un OB bajista sucede lo inverso: el <em>smart money</em> acumula ventas absorbiendo la demanda, a
                menudo barriendo máximos previos para tomar liquidez, antes de desplomar el precio.</p>
            <p>Detrás de esta dinámica está el hecho de que <strong>las grandes instituciones no pueden colocar todas
                    sus órdenes de golpe sin mover el mercado en su contra</strong>. Si un banco o fondo quiere comprar
                una enorme cantidad de un activo, no lo hará en un solo nivel porque empujaría el precio al alza
                demasiado rápido, encareciendo sus propias compras. En su lugar, fragmentan sus órdenes en bloques y las
                ejecutan gradualmente en una zona, generando esa aparente consolidación en el gráfico.</p>
            <p>Una vez tienen la posición deseada, disparan el movimiento impulsivo (muchas veces apoyado en alguna
                noticia o catalizador fundamental) para llevar el precio a su favor. Ese impulso suele crear un
                desequilibrio – evidenciado por <em>gaps</em> o velas sin solapamiento conocido como <strong>Fair Value
                    Gaps (FVG)</strong> – porque el precio se movió tan rápido que no dejó negociaciones equilibradas en
                el medio.</p>
            <p>Inevitablemente, el precio tenderá a regresar a la zona del Order Block para reequilibrar oferta y
                demanda, rellenando parcialmente ese vacío de precio antes de continuar con el movimiento original. Por
                eso decimos que los OB actúan como <strong>imanes de liquidez</strong>: tras un gran desplazamiento, el
                mercado frecuentemente vuelve a “mitigar” el OB (llenar órdenes pendientes que quedaron) y luego retoma
                la tendencia impulsada por las instituciones.</p>
            <p>En resumen, un Order Block es efectivamente una zona institucional de oferta/demanda: un bloque de
                órdenes limitadas colocadas por operadores grandes, causando un gran desequilibrio cuando se ejecutan.
                Algunos traders de SMC describen los OB como una versión refinada de los clásicos niveles de oferta y
                demanda del análisis técnico, poniendo énfasis en la última vela significativa antes de un movimiento
                impulsivo. Entender su anatomía nos permite “leer la historia” que cuenta el precio: cada OB nos narra
                cómo el dinero inteligente realizó su jugada.</p>
        </section>

        <!-- NEW CONTENT: AMD CYCLE -->
        <section>
            <h2>El Contexto Institucional: Acumulación, Manipulación y Distribución (AMD)</h2>
            <p>Para identificar los Order Blocks de mayor probabilidad, es fundamental entender el contexto en el que se
                forman. Los OBs no aparecen aleatoriamente; suelen ser la pieza clave dentro de un ciclo de mercado
                conocido como <strong>AMD (Accumulation, Manipulation, Distribution)</strong>.</p>
            <p>Este modelo explica cómo el algoritmo interbancario mueve el precio para generar liquidez:</p>
            <ul>
                <li><strong>Acumulación (A):</strong> El precio se mueve en un rango lateral. Aquí se acumulan órdenes
                    de ambos lados.</li>
                <li><strong>Manipulación (M):</strong> El precio hace un movimiento falso agresivo en contra de la
                    dirección real pretendida (conocido como <em>Judas Swing</em>). <strong>Aquí es donde se forma el
                        Order Block</strong>. Este movimiento induce a traders minoristas al error y activa sus
                    stop-loss.</li>
                <li><strong>Distribución (D):</strong> El precio revierte y se mueve con fuerza en la dirección real,
                    dejando atrás el Order Block creado durante la manipulación.</li>
            </ul>

            <div class="infographic-box">
                <div class="infographic-title"><i class="fas fa-sync-alt"></i> El Ciclo AMD y la Formación del OB</div>
                <p>El Order Block de alta probabilidad es, en esencia, la huella de la <strong>Manipulación</strong>.
                    Observa cómo el movimiento falso crea la zona.</p>

                <div class="amd-container" id="amd-container">
                    <!-- SVG rendered by JS -->
                </div>

                <button class="btn-interact" aria-label="Simular ciclo AMD" onclick="KawnBitApp.animateAMD()">
                    <i class="fas fa-play"></i> Simular Ciclo AMD
                </button>
            </div>

            <p>Entender esto cambia tu perspectiva: cuando veas un movimiento brusco que rompe un rango y luego se
                devuelve rápidamente, no es solo "volatilidad"; es la creación de un Order Block listo para ser operado
                en el futuro.</p>
        </section>

        <section>
            <h2>Order Blocks de inicio de tendencia: el nacimiento de un nuevo movimiento</h2>
            <p>Uno de los usos más poderosos de los bloques de órdenes es para identificar puntos de giro de alta
                probabilidad: los OB de inicio de tendencia. Estos marcan el nacimiento de un nuevo movimiento
                importante en el mercado, ya sea un giro alcista tras una fase bajista o viceversa.</p>

            <h3>Identificación de un Order Block inicial (alcista)</h3>
            <p>Cuando buscamos un Order Block alcista de inicio de tendencia, típicamente estaremos buscando la
                <strong>última vela bajista antes de un movimiento alcista significativo</strong>. Pero no cualquier
                vela bajista sirve; debe cumplir criterios específicos que la distinguen del ruido del mercado:
            </p>

            <div class="infographic-box">
                <div class="infographic-title"><i class="fas fa-search-dollar"></i> Criterios de Identificación</div>
                <ul style="list-style: none; padding: 0;">
                    <li style="margin-bottom: 15px; padding-left: 20px; border-left: 3px solid var(--secondary-teal);">
                        <strong>1. Vela bajista amplia en zona de soporte:</strong> Ubica la última vela bajista
                        importante antes de un fuerte rally. Idealmente, estará cerca de un soporte relevante e incluso
                        habrá perforado ligeramente ese soporte, indicando una cacería de liquidez bajo el nivel.
                    </li>
                    <li style="margin-bottom: 15px; padding-left: 20px; border-left: 3px solid var(--secondary-teal);">
                        <strong>2. Barrido de mínimos (toma de liquidez):</strong> Comprueba que dicha vela bajista haya
                        barrido un mínimo previo o stops de traders minoristas. Es decir, que haya hecho un nuevo mínimo
                        (rompiendo momentáneamente el soporte) antes de revertir al alza. Esto evidencia que el
                        <em>smart money</em> recogió liquidez (stop-loss activados) justo antes del giro.
                    </li>
                    <li style="margin-bottom: 15px; padding-left: 20px; border-left: 3px solid var(--secondary-teal);">
                        <strong>3. Desplazamiento alcista subsecuente:</strong> Tras esa vela bajista candidata, el
                        precio debe moverse con fuerza hacia arriba, señal inequívoca de que las compras institucionales
                        tomaron el control. Idealmente, el impulso alcista resultante supera el máximo de la vela
                        bajista y ocurre con velas grandes que dejan huecos (ineficiencias).
                    </li>
                </ul>
            </div>

            <p>Como ejemplo práctico, imagina que observas el par EUR/USD respetando un soporte en 1.0800 durante varios
                días. De repente, ves una vela bajista de ~30 pips que perfora el soporte hasta 1.0785, arrastrando
                consigo los stop-loss que estaban justo debajo. Inmediatamente después, el precio se dispara al alza con
                fuerza. Esa vela bajista que rompió temporalmente el soporte es un firme candidato a Order Block de
                inicio de tendencia alcista. Ha absorbido liquidez por debajo de 1.0800 y dio paso a un desplazamiento
                agresivo al alza – justo el patrón que buscaríamos para marcar un OB alcista.</p>

            <h3>Validación del Order Block: confirmando la autenticidad</h3>
            <p>Identificar un posible OB es solo el primer paso. La validación es donde separamos los Order Blocks
                genuinos de las señales falsas. En la metodología ICT, se suele decir que un OB se confirma con un
                “cambio en el estado de entrega” del mercado: esto significa que el precio debe superar completamente el
                punto más alto de la vela candidata (en un OB alcista) o el más bajo (en un OB bajista).</p>
            <p>En otras palabras, tiene que haber un <strong>cambio claro de estructura de mercado</strong> indicando
                que la tendencia previa ha finalizado. Si estamos evaluando un OB alcista, queremos ver que tras
                formarse, el precio rompe un máximo relevante (idealmente el máximo de la propia vela bajista del OB o
                de alguna estructura cercana), señal de un cambio de tendencia al alza.</p>

            <div class="infographic-box">
                <div class="infographic-title"><i class="fas fa-chart-line"></i> Gráfico de Validación: Estructura +
                    Impulso</div>
                <p>Observa la animación a continuación. La vela roja es el OB. Su validación ocurre con el
                    desplazamiento fuerte (velas verdes grandes) y la creación de un FVG (hueco).</p>

                <div class="chart-container" id="chart-container">
                    <!-- SVG Chart Generated by JS -->
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <p style="font-size: 0.85rem; color: #666; margin: 0;"><em>El rectángulo sombreado marca el
                            FVG.</em></p>
                    <button class="btn-interact" style="margin-top: 0; font-size: 0.8rem; padding: 8px 15px;"
                        onclick="KawnBitApp.replayChart()">
                        <i class="fas fa-redo"></i> Replay
                    </button>
                </div>
            </div>

            <p>Además de romper ese nivel, es crítico observar el carácter del movimiento: la validación viene
                acompañada de un <strong>desplazamiento pronunciado</strong>. No basta con que el precio apenas cruce el
                nivel; queremos ver un movimiento decidido y rápido, evidencia de que las órdenes institucionales
                impulsaron el precio sin mucha oposición. Este desplazamiento urgente con frecuencia deja un Fair Value
                Gap (FVG) en el camino – una zona de velas que no se solapan, mostrando un vacío de liquidez. La
                presencia de un FVG justo después de un OB es otra confirmación importante de que el movimiento fue
                impulsado por el <em>smart money</em> y no fue un amago cualquiera.</p>
            <p>Por el contrario, si el precio no rompe ningún nivel de liquidez previo o el movimiento posterior es
                débil y lleno de retrocesos solapados, probablemente no era un OB válido sino un nivel manipulado o
                menor. En resumen, validaremos el OB cuando veamos <strong>estructura + impulso</strong>: primero, la
                toma de un nivel clave (ej., un máximo anterior barrido) y segundo, un rally rápido lejos de la zona.
            </p>
        </section>

        <section>
            <h2>La entrada óptima en el Order Block</h2>
            <p>Una vez identificado y validado el Order Block, llega el momento más importante: planificar la entrada.
                Aquí es donde muchos traders cometen errores por impaciencia o por no comprender bien la naturaleza del
                OB. La clave está en recordar que, tras el impulso inicial, el precio eventualmente retrocederá hacia el
                Order Block (porque quedan órdenes pendientes por llenar, o simplemente por toma de ganancias parcial
                institucional).</p>
            <p>Ese retroceso es la segunda oportunidad que el <em>smart money</em> “regala” para entrar al mercado
                alineado con ellos. La entrada óptima ocurre típicamente cuando el precio regresa y toca el cuerpo del
                Order Block, no necesariamente la mecha extrema.</p>
            <p>¿Por qué el cuerpo? Porque el cuerpo de la vela (el rango entre apertura y cierre) representa la zona
                donde ocurrió la mayor parte del volumen de transacciones institucionales. Por ello, muchos traders
                trazan la zona del OB abarcando toda la vela, pero ponen especial atención en la parte interna (por
                ejemplo, algunos fijan su entrada justo en la apertura del OB o en el <strong>50% del rango de la vela
                    OB</strong>). Esa mitad de la vela suele considerarse un nivel de equilibrio interno del OB donde,
                si el precio llega, ofrece una entrada ventajosa con menor riesgo.</p>

            <h3>Concepto de Equilibrio, Descuento y Premium</h3>
            <p>Ahora bien, no solo importa que el precio toque el OB, sino dónde ocurre eso en relación al impulso que
                validó el OB. Recordemos que el equilibrio de un movimiento impulsivo rápido se sitúa en el 50% de su
                rango. En un impulso alcista, la zona por debajo del 50% es zona de <strong>descuento</strong> (precio
                “barato” relativo a ese movimiento), y por encima es zona <strong>premium</strong> (precio “caro”). La
                regla general en SMC es comprar solo en descuento y vender solo en premium.</p>

            <div class="infographic-box pd-tool">
                <div class="infographic-title" style="margin: 0 auto 20px auto;"><i class="fas fa-ruler-vertical"></i>
                    Calculadora de Valor</div>
                <p>Mueve el punto en la barra para ver si estás en zona de compra o venta.</p>

                <div class="range-slider-container">
                    <div class="mid-line"></div>
                    <input type="range" min="0" max="100" value="50" class="range-slider" id="pd-slider"
                        aria-label="Deslizador de precio">
                    <div
                        style="position: absolute; width: 100%; top: 50%; transform: translateY(-50%); display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; pointer-events: none; font-size: 0.8rem; font-weight: bold; opacity: 0.6;">
                        <span>DESCUENTO</span>
                        <span>PREMIUM</span>
                    </div>
                </div>

                <div class="pd-feedback" id="pd-feedback">50% (Equilibrio) - ESPERAR</div>
                <p style="font-size: 0.9rem; margin-top: 10px;">Para comprar con alta probabilidad, espera a que el
                    precio entre en <strong>Descuento (<50%)< /strong>.</p>
            </div>

            <p>Así que la paciencia es vital: esperar a que el precio retroceda suficientemente (al menos al 50% del
                impulso, idealmente hasta el cuerpo del OB en descuento) antes de entrar. Cuando el precio toque la zona
                del OB, observa si muestra señales de rechazo: por ejemplo, una vela de giro evidente como un <em>pin
                    bar</em>, un doji de indecisión, o una vela envolvente alcista en esa zona, indicando que la demanda
                está regresando.</p>
            <p>También es útil fijarse en el volumen: un aumento de volumen en el giro del OB sugiere participación
                institucional defendiéndolo. Finalmente, evita la tentación de adelantarte. Muchos traders ven que el
                precio se aproxima al OB y entran antes de tiempo. Esto a la larga es un error. Si definiste tu zona de
                entrada, respétala. Si el precio no alcanza a tocar el OB por poco y luego despega, no persigas la
                operación; simplemente acepta que “esa no era para ti”.</p>
        </section>

        <!-- NEW CONTENT: MEAN THRESHOLD -->
        <section>
            <h2>Refinamiento de Entradas: El concepto de "Mean Threshold"</h2>
            <p>Una pregunta común es: <em>¿Cuánto retroceso dentro del OB es demasiado?</em> Si el precio penetra
                demasiado profundo en el Order Block, la probabilidad de éxito disminuye drásticamente. Aquí entra el
                concepto de <strong>Mean Threshold (Umbral Medio)</strong>.</p>
            <p>El Mean Threshold es exactamente el <strong>50% del cuerpo de la vela</strong> que forma el Order Block.
                Institucionalmente, un OB válido no debería permitir que el precio cierre por debajo de este nivel (en
                un escenario alcista). Las mechas pueden perforarlo momentáneamente para tomar liquidez, pero el cuerpo
                de las velas de retroceso debe respetar este límite.</p>

            <div class="infographic-box" style="background: #e0f2f1; border-color: var(--primary-teal);">
                <div class="infographic-title" style="background: white;"><i class="fas fa-vial"></i> Stress Test: Mean
                    Threshold</div>
                <p>Usa el deslizador naranja a la derecha para simular un retroceso profundo. Observa cómo la "salud"
                    del Order Block cambia si el precio cruza el 50% del cuerpo.</p>

                <div class="mt-visualizer">
                    <div class="mt-candle-container">
                        <div class="mt-candle-wick"></div>
                        <div class="mt-candle-body" id="mt-body"></div>

                        <!-- Threshold Line -->
                        <div class="mt-threshold-line">
                            <span
                                style="position: absolute; right: -40px; top: -10px; font-size: 0.7rem; color: white;">50%</span>
                        </div>

                        <!-- Draggable Interaction -->
                        <div class="mt-dragger">
                            <input type="range" min="0" max="100" value="0"
                                style="width: 200px; transform: rotate(90deg); position: absolute; top: 80px; left: -80px; opacity: 0; cursor: ns-resize;"
                                oninput="KawnBitApp.updateMeanThreshold(this.value)" aria-label="Nivel de retroceso">
                            <div class="mt-cursor" id="mt-cursor" style="top: 0%;">
                                <div class="mt-price-line"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-status" id="mt-status" style="color: #00e676;">OB SALUDABLE</div>
                </div>
            </div>

            <p>Si observas que el precio cierra consistentemente más allá del Mean Threshold, es una señal temprana de
                que el Order Block podría fallar y convertirse en un Breaker. Esta regla te ayuda a salir de operaciones
                malas antes de que toquen tu Stop Loss completo.</p>
        </section>

        <section>
            <h2>Gestión del riesgo en operaciones con OB</h2>
            <p>La gestión del riesgo al operar Order Blocks es relativamente directa, pero requiere disciplina. Un OB
                bien identificado suele permitir stops muy ajustados, pero siempre hay riesgo. A la hora de colocar el
                stop-loss, existen dos enfoques principales:</p>
            <ul>
                <li><strong>Stop ceñido (agresivo):</strong> Colocarlo aproximadamente en el 50% del Order Block. Esta
                    opción reduce mucho el tamaño del stop (mejorando el ratio riesgo/beneficio), pero tiene mayor
                    riesgo de ser alcanzado por la volatilidad normal.</li>
                <li><strong>Stop conservador (seguro):</strong> Colocarlo un poco más allá del extremo del OB – es
                    decir, debajo de todo el bloque de órdenes en operaciones alcistas. De este modo, si el precio llega
                    a invalidar completamente el OB, saldrás de la posición.</li>
            </ul>
            <p>La elección depende de tu tolerancia al riesgo y del contexto. Si el mercado está volátil, es mejor un
                stop más holgado que te mantenga en una buena operación, que uno demasiado ajustado que te saque antes
                de tiempo. Y por supuesto, nunca operes sin stop-loss; un OB invalida su premisa si el precio lo
                atraviesa del todo.</p>
            <p>Un detalle adicional es el tamaño de posición: arriesga solo un pequeño porcentaje de tu capital en cada
                operación (1% o 2% típicamente). El trading es un juego de probabilidades, y aunque un OB ofrezca
                ventaja, nada es 100% seguro.</p>

            <h3>Definiendo objetivos de ganancia</h3>
            <p>El objetivo principal al operar un Order Block de inicio de tendencia suele ser el extremo opuesto del
                rango de liquidez externo. Si estás operando un OB alcista que se formó cerca de un mínimo
                significativo, tu objetivo natural sería el máximo opuesto de ese rango. La lógica es que, dado que el
                OB marca el inicio de un nuevo impulso patrocinado por el dinero inteligente, ese impulso probablemente
                buscará liquidez en el extremo opuesto.</p>
            <p>Para evitar errores emocionales, define tus salidas objetivamente. Puedes usar los máximos/mínimos
                previos significativos, niveles de extensión de Fibonacci, o apuntar a una relación Riesgo/Beneficio
                fija (ej. 1:3). Muchos operadores ajustan sus posiciones a medida que el precio se mueve a su favor,
                cerrando una parte en el primer alto significativo y dejando el resto correr. Sobre todo, evita el error
                de interferir emocionalmente con tus objetivos una vez fijados. Si has identificado correctamente un OB
                de inicio, deja que el mercado haga su trabajo.</p>
        </section>

        <section>
            <h2>Confirmación en temporalidades menores: el detalle que marca la diferencia</h2>
            <p>Un aspecto crucial que separa a los traders profesionales de los principiantes es la confirmación en
                <em>timeframes</em> menores. Identificar un OB en el gráfico de 1 hora nos da una zona de interés, pero
                no significa que debamos entrar a ciegas apenas el precio toque esa zona. La paciencia sugiere esperar
                una confirmación adicional en una temporalidad más baja (ej. 15 minutos, 5 minutos).
            </p>
            <p>¿Qué buscamos? Principalmente, un <strong>cambio de estructura local</strong> (Change of Character o
                ChoCH). Por ejemplo, si el precio llega a tu OB de H1, baja a 5 minutos y espera a que el precio rompa
                un máximo menor previo, creando un nuevo máximo más alto en esa microestructura. Esa ruptura sería
                indicativo de que la presión de compra está retornando.</p>
            <p>En lugar de poner una orden límite ciega, estás añadiendo una capa de seguridad: solo entras cuando ves
                al precio reaccionar positivamente en tu zona. Este enfoque, llamado <em>refinement</em>, mejora la tasa
                de aciertos. Es mejor perder una entrada buena por esperar confirmación, que apresurarse y tomar muchas
                entradas malas.</p>

            <h3>Reacción explosiva: la “prueba de fuego”</h3>
            <p>Si realmente estamos en presencia de un OB patrocinado por dinero institucional, cuando el precio regrese
                a esa zona veremos una “expulsión” rápida. El precio apenas tocará el OB y saldrá disparado en dirección
                contraria. Este rechazo agresivo es la confirmación más fuerte de que estás operando en sintonía con el
                dinero inteligente. Si al tocar tu OB el precio no muestra casi reacción o lo traspasa lentamente, es
                señal de alerta. Un verdadero OB debería provocar un movimiento notable al menos inicialmente.</p>
        </section>

        <section>
            <h2>Order Blocks de continuación y Breakers</h2>
            <p>No todos los Order Blocks marcan grandes giros. También existen OB formados dentro de tendencias ya
                establecidas: los <strong>Order Blocks de continuación</strong> o bloques mitigadores. Estos se forman
                cuando el precio hace una corrección temporal dentro de una tendencia activa, como si el <em>smart
                    money</em> hiciera una pausa para respirar. Operarlos permite "reengancharse" en una tendencia sin
                tener que perseguir el precio.</p>
            <p>En estos bloques, las instituciones tienden a ser más agresivas, por lo que no siempre habrá un retroceso
                profundo hasta el 50%. Muchos traders optan por entrar en cuanto el precio toca el extremo del bloque
                mitigador.</p>

            <div class="infographic-box">
                <div class="infographic-title"><i class="fas fa-random"></i> Breaker Blocks (Animado)</div>
                <p>Los Breakers son la contracara de un Order Block fallido. Si un OB no logra sostener el precio y este
                    lo atraviesa completamente, ese OB roto cambia de rol y se convierte en un Breaker Block.</p>

                <div class="breaker-svg-container" id="breaker-container">
                    <!-- SVG added by JS -->
                </div>

                <button class="btn-interact" aria-label="Ver animación Breaker" onclick="KawnBitApp.animateBreaker()">
                    <i class="fas fa-play-circle"></i> Ver Ruptura y Retest
                </button>
                <p style="margin-top: 15px;">Imagina un OB alcista que falla y es atravesado a la baja; ese nivel pasa a
                    ser resistencia futura. Operar el retest de un Breaker nos permite capitalizar incluso cuando
                    nuestro plan inicial estaba errado, volteándonos con el mercado.</p>
            </div>
        </section>

        <section>
            <h2>Criterios de excelencia y consideraciones psicológicas</h2>
            <p>No todos los Order Blocks son iguales. Prioriza los de <strong>alta probabilidad</strong> buscando
                confluencias: que coincidan con niveles de interés previos (soportes/resistencias históricos), que
                tengan Fair Value Gaps asociados, y que estén alineados con la tendencia en temporalidades superiores.
                También, evita operar OB formados durante eventos de noticias de alto impacto, ya que la volatilidad
                puede barrer niveles técnicos.</p>

            <h3>La mentalidad del trader de Order Blocks</h3>
            <p>Operar OBs requiere fortaleza psicológica. La paciencia es clave: espera la configuración correcta y no
                caigas en el FOMO (miedo a perderse la oportunidad). Si tu plan dice comprar en cierto nivel, no compres
                antes por miedo. Aceptar que no puedes atrapar todos los movimientos es parte del juego.</p>
            <p>Afronta la duda confiando en tu análisis. Si validaste el OB y pusiste tu stop, deja que el trade se
                desarrolle. Evita la sobreoperación; calidad sobre cantidad siempre. Y gestiona el miedo y la codicia
                manteniendo reglas claras de salida.</p>

            <h3>Conclusión: maestría a través de la práctica deliberada</h3>
            <p>Dominar los Order Blocks no es cuestión de memorizar reglas, sino de desarrollar una comprensión
                intuitiva de la intención institucional. Te recomendamos un enfoque gradual: identifica OBs en gráficos
                históricos sin operar, observa cómo reacciona el precio y anota los resultados. Con el tiempo,
                desarrollarás un “ojo clínico” para detectar OB de alta calidad. Recuerda: menos es más. Es preferible
                esperar días por ese Order Block perfecto, con todas las confluencias alineadas, que malgastar capital
                en entradas mediocres.</p>
            <p>Al final del día, ser capaz de identificar dónde compran y venden los que mueven el mercado es quizás una
                de las ventajas más poderosas que un trader puede tener.</p>
        </section>

        <!-- NEW: SCENARIO SIMULATOR -->
        <section>
            <div class="scenario-box">
                <div class="scenario-header">
                    <i class="fas fa-chalkboard-teacher fa-lg" style="margin-right: 15px;"></i>
                    Simulador de Escenarios de Práctica (AI)
                </div>
                <p>Pon a prueba tus conocimientos. La IA generará un escenario de mercado aleatorio. Intenta identificar
                    dónde está la oportunidad antes de revelar la respuesta.</p>

                <button class="btn-interact" id="btn-generate-scenario" onclick="KawnBitApp.generateScenario()">
                    <i class="fas fa-magic"></i> Generar Nuevo Escenario ✨
                </button>

                <div id="scenario-display" style="display: none; margin-top: 20px;">
                    <div class="scenario-content" id="scenario-text">
                        Cargando escenario...
                    </div>

                    <button class="btn-interact" id="btn-solve-scenario"
                        style="background: var(--dark-teal); font-size: 0.9rem;" onclick="KawnBitApp.solveScenario()"
                        disabled>
                        <i class="fas fa-eye"></i> Revelar Análisis del Experto
                    </button>

                    <div class="scenario-solution" id="scenario-solution">
                        <p id="solution-text">Analizando...</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="ai-section-wrapper">
            <div style="display: flex; align-items: center; margin-bottom: 25px;">
                <div
                    style="background: white; padding: 10px; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-right: 15px;">
                    <i class="fas fa-robot fa-2x" style="color: var(--secondary-teal);"></i>
                </div>
                <div>
                    <h3 style="margin: 0; color: var(--dark-teal); font-size: 1.5rem;">Mentor Virtual KawnBit AI</h3>
                    <small style="color: var(--text-grey);">Potenciado por Gemini 2.5 ✨</small>
                </div>
            </div>
            <p>Pregunta cualquier duda específica sobre Order Blocks, ICT o SMC. El mentor analizará tu pregunta en
                tiempo real.</p>

            <div class="chat-interface">
                <div class="chat-header">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span><i class="fas fa-circle" style="color: #00e676; font-size: 0.6rem;"></i> En línea</span>
                        <span style="font-size: 0.8rem; opacity: 0.8;">Modo: Experto SMC</span>
                    </div>
                    <!-- Robustez: Botón de Configuración de API Key -->
                    <span class="key-config-link" onclick="KawnBitApp.promptForApiKey()">Configurar API Key</span>
                </div>
                <div class="chat-messages-area" id="chat-messages">
                    <div class="chat-bubble bubble-ai">
                        Hola. Soy tu mentor de trading institucional. Pregúntame sobre validación de OBs, entradas en
                        temporalidades menores o gestión de riesgo.
                    </div>
                </div>
                <div class="typing-indicator" id="typing-indicator">KawnBit AI está escribiendo...</div>
                <div class="chat-input-wrapper">
                    <input type="text" id="chat-input" class="chat-input-field"
                        placeholder="Ej: ¿Cómo confirmo una entrada en 5min?" onkeypress="KawnBitApp.handleEnter(event)"
                        aria-label="Escribe tu pregunta">
                    <button class="send-btn" id="send-btn" onclick="KawnBitApp.sendMessage()"
                        aria-label="Enviar mensaje"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </section>

        <footer class="main-footer">
            <div class="footer-logo">
                <div class="logo-placeholder" style="font-size: 2rem;">KawnBit</div>
            </div>
            <p class="copyright">&copy; <span id="current-year"></span> KawnBit Magazine. Todos los derechos reservados.
            </p>
        </footer>

    </div>

    <!-- Interactive Scripts (Robust & Namespaced) -->
    <script>
        // --- KAWNBIT APP NAMESPACE ---
        const KawnBitApp = (function () {
            // Estado y Configuración Privada
            let isAnimatingAMD = false;
            let isReplayingChart = false;
            let isGeneratingScenario = false;
            let currentScenarioText = "";

            // --- UTILIDADES ---
            function debounce(func, wait) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            function escapeHTML(str) {
                if (!str) return "";
                return str.replace(/[&<>'"]/g,
                    tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag]));
            }

            const proxyUrl = "/.netlify/functions/gemini-proxy";

            async function callGeminiAPI(prompt, systemInstruction = "") {
                try {
                    const response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemInstruction }] }
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 429) return "Error: Demasiadas solicitudes. Espera un momento.";
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    // Extraemos la respuesta de la estructura de Gemini
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || data.result || "La IA no devolvió respuesta.";

                } catch (error) {
                    console.error("API Error", error);
                    return "⚠️ Error de conexión: Asegúrate de haber configurado la variable GEMINI_API_KEY en Netlify.";
                }
            }

            // --- ANIMACIONES & GRÁFICOS ---

            // 1. Chart
            const chartData = [
                { open: 100, close: 90, high: 105, low: 85, type: 'bear' },
                { open: 90, close: 85, high: 95, low: 80, type: 'bear' },
                { open: 85, close: 80, high: 88, low: 78, type: 'bear' },
                { open: 80, close: 110, high: 115, low: 78, type: 'bull' },
                { open: 110, close: 130, high: 135, low: 108, type: 'bull' },
                { open: 130, close: 140, high: 145, low: 128, type: 'bull' }
            ];

            function renderChart(step = 6) {
                const container = document.getElementById('chart-container');
                if (!container) return;
                const width = container.offsetWidth || 300;
                const height = container.offsetHeight || 200;
                const padding = 20;

                const maxPrice = 150; const minPrice = 70;
                const priceRange = maxPrice - minPrice;
                const candleWidth = (width - padding * 2) / 8;
                const spacing = candleWidth * 0.4;
                const barWidth = candleWidth - spacing;
                const getY = (price) => height - ((price - minPrice) / priceRange) * height - padding;

                let svg = `<svg width="100%" height="100%" viewBox="0 0 ${width} ${height}">`;

                if (step >= 3) {
                    const obTop = getY(88); const obBottom = getY(78);
                    const obX = padding + (2 * candleWidth);
                    svg += `<rect x="${obX}" y="${obTop}" width="${width - obX}" height="${obBottom - obTop}" fill="rgba(0, 137, 123, 0.15)" stroke="var(--secondary-teal)" stroke-dasharray="4" rx="4" />
                        <text x="${obX + 10}" y="${obTop - 10}" fill="var(--secondary-teal)" font-size="12" font-weight="bold">Order Block (H1)</text>`;
                    if (step >= 5) {
                        const fvgTop = getY(108); const fvgBottom = getY(88);
                        const fvgX = padding + (3.5 * candleWidth);
                        svg += `<rect x="${fvgX}" y="${fvgTop}" width="${barWidth * 1.5}" height="${fvgBottom - fvgTop}" fill="rgba(255, 200, 0, 0.2)" />
                            <text x="${fvgX}" y="${fvgTop + 10}" font-size="10" fill="#fbc02d" font-weight="bold">FVG</text>`;
                    }
                }
                for (let i = 0; i < step; i++) {
                    const d = chartData[i];
                    const x = padding + (i * candleWidth);
                    const colorClass = d.type === 'bull' ? 'bull-fill-solid' : 'bear-fill';
                    svg += `<line x1="${x + barWidth / 2}" y1="${getY(d.high)}" x2="${x + barWidth / 2}" y2="${getY(d.low)}" class="candle-wick" />
                        <rect x="${x}" y="${Math.min(getY(d.open), getY(d.close))}" width="${barWidth}" height="${Math.max(1, Math.abs(getY(d.close) - getY(d.open)))}" class="candle-rect ${colorClass}" />`;
                }
                svg += `</svg>`;
                container.innerHTML = svg;
            }

            function replayChart() {
                if (isReplayingChart) return; // Guard
                isReplayingChart = true;
                let currentStep = 0;
                const interval = setInterval(() => {
                    currentStep++;
                    renderChart(currentStep);
                    if (currentStep >= 6) {
                        clearInterval(interval);
                        isReplayingChart = false;
                    }
                }, 500);
            }

            // 2. Sponge
            function triggerSpongeAnimation() {
                const svg = document.getElementById('sponge-svg');
                const status = document.getElementById('sponge-status');
                if (!svg || !status) return;

                status.textContent = "Absorbiendo Ventas...";
                status.style.color = "var(--danger)";
                svg.style.transform = "scale(0.7)";
                setTimeout(() => {
                    status.textContent = "¡Desplazamiento!";
                    status.style.color = "var(--success)";
                    svg.style.transform = "scale(1.3) translateX(20px)";
                }, 1000);
                setTimeout(() => {
                    status.textContent = "Estado: Acumulando...";
                    status.style.color = "var(--secondary-teal)";
                    svg.style.transform = "scale(1)";
                }, 2500);
            }

            // 3. AMD
            function drawAMD(step = 0) {
                const container = document.getElementById('amd-container');
                if (!container) return;
                const w = container.offsetWidth || 300; const h = container.offsetHeight || 200;
                const pathData = [{ x: 0, y: h * 0.5 }, { x: w * 0.1, y: h * 0.45 }, { x: w * 0.2, y: h * 0.55 }, { x: w * 0.3, y: h * 0.5 },
                { x: w * 0.35, y: h * 0.5 }, { x: w * 0.45, y: h * 0.8 }, { x: w * 0.5, y: h * 0.75 },
                { x: w * 0.55, y: h * 0.3 }, { x: w * 0.7, y: h * 0.2 }, { x: w * 0.9, y: h * 0.1 }];

                let svg = `<svg width="100%" height="100%" viewBox="0 0 ${w} ${h}">`;
                if (step >= 1) svg += `<rect x="0" y="${h * 0.4}" width="${w * 0.35}" height="${h * 0.2}" fill="rgba(255, 167, 38, 0.1)" />`;
                if (step >= 2) svg += `<rect x="${w * 0.35}" y="${h * 0.6}" width="${w * 0.2}" height="${h * 0.3}" fill="rgba(229, 57, 53, 0.1)" />`;
                if (step >= 3) svg += `<rect x="${w * 0.55}" y="0" width="${w * 0.45}" height="${h * 0.6}" fill="rgba(67, 160, 71, 0.1)" />`;

                let points = step >= 3 ? pathData : (step >= 2 ? pathData.slice(0, 7) : (step >= 1 ? pathData.slice(0, 4) : []));
                if (points.length) {
                    let d = `M ${points[0].x} ${points[0].y}`;
                    points.slice(1).forEach(p => d += ` L ${p.x} ${p.y}`);
                    svg += `<path d="${d}" fill="none" stroke="#333" stroke-width="2" />`;
                }
                if (step >= 2) svg += `<circle cx="${w * 0.45}" cy="${h * 0.8}" r="8" fill="var(--danger)" />`;
                svg += `</svg>`;

                let labels = '';
                if (step >= 1) labels += `<div class="amd-label amd-acc" style="top:20px; left:10%; opacity:1;">ACUMULACIÓN</div>`;
                if (step >= 2) labels += `<div class="amd-label amd-man" style="bottom:20px; left:40%; opacity:1;">MANIPULACIÓN</div>`;
                if (step >= 3) labels += `<div class="amd-label amd-dist" style="top:20px; right:10%; opacity:1;">DISTRIBUCIÓN</div>`;
                container.innerHTML = svg + labels;
            }

            function animateAMD() {
                if (isAnimatingAMD) return; // Guard
                isAnimatingAMD = true;
                let s = 0;
                const i = setInterval(() => {
                    s++;
                    drawAMD(s);
                    if (s >= 3) { clearInterval(i); isAnimatingAMD = false; }
                }, 1000);
            }

            // 4. Breaker
            function drawBreaker(animate = false) {
                const container = document.getElementById('breaker-container');
                if (!container) return;
                const w = container.offsetWidth || 300; const h = container.offsetHeight || 200;

                const pts = { s: { x: 0, y: h * 0.2 }, l1: { x: w * 0.2, y: h * 0.6 }, ob: { x: w * 0.3, y: h * 0.5 }, br: { x: w * 0.5, y: h * 0.9 }, rt: { x: w * 0.7, y: h * 0.5 }, f: { x: w, y: h * 0.8 } };
                let svg = `<svg width="100%" height="100%" viewBox="0 0 ${w} ${h}">
                <rect x="0" y="${pts.ob.y - 10}" width="${w}" height="20" class="breaker-zone" />
                <text x="10" y="${pts.ob.y - 5}" font-size="12" fill="#e57373">Breaker Block</text>`;

                const d = `M ${pts.s.x} ${pts.s.y} L ${pts.l1.x} ${pts.l1.y} L ${pts.ob.x} ${pts.ob.y} L ${pts.br.x} ${pts.br.y} L ${pts.rt.x} ${pts.rt.y} L ${pts.f.x} ${pts.f.y}`;
                if (animate) {
                    svg += `<path d="${d}" class="path-line path-active" stroke="var(--dark-teal)">
                            <animate attributeName="stroke-dasharray" from="0, 1000" to="1000, 0" dur="2s" fill="freeze" />
                        </path>`;
                } else {
                    svg += `<path d="${d}" class="path-line path-history" />`;
                }
                svg += `<circle cx="${pts.rt.x}" cy="${pts.rt.y}" r="6" fill="var(--secondary-teal)" stroke="white" stroke-width="2" />
                    <text x="${pts.rt.x + 10}" y="${pts.rt.y}" font-size="12" font-weight="bold" fill="var(--secondary-teal)">Entrada</text>
                    </svg>`;
                container.innerHTML = svg;
            }
            function animateBreaker() { drawBreaker(true); }

            // 5. Mean Threshold
            function updateMeanThreshold(val) {
                const cursor = document.getElementById('mt-cursor');
                const status = document.getElementById('mt-status');
                const body = document.getElementById('mt-body');
                if (!cursor || !status) return;

                cursor.style.top = val + "%";
                if (val > 50) {
                    status.innerText = "PELIGRO: >50% (Inválido)";
                    status.style.color = "var(--danger)";
                    body.style.background = "#ef5350";
                } else if (val > 20) {
                    status.innerText = "OB SALUDABLE (Retest Profundo)";
                    status.style.color = "#ffa726";
                    body.style.background = "#00e676";
                } else {
                    status.innerText = "OB MUY FUERTE (Toque Ligero)";
                    status.style.color = "#00e676";
                    body.style.background = "#00e676";
                }
            }

            // --- CHAT & SCENARIO ---

            // Persistencia Chat
            function loadChatHistory() {
                const hist = localStorage.getItem('kawnbit_chat_history');
                if (hist) {
                    try {
                        const messages = JSON.parse(hist);
                        messages.forEach(m => addBubble(m.text, m.type, false)); // false = no save again
                    } catch (e) { }
                }
            }
            function saveChatHistory(text, type) {
                let hist = JSON.parse(localStorage.getItem('kawnbit_chat_history') || "[]");
                hist.push({ text, type });
                if (hist.length > 20) hist.shift(); // Guardar solo últimos 20
                localStorage.setItem('kawnbit_chat_history', JSON.stringify(hist));
            }

            function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

            async function sendMessage() {
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                if (!text) return;

                addBubble(text, 'user', true);
                input.value = '';
                input.disabled = true;
                document.getElementById('typing-indicator').style.display = 'block';

                const sys = "Eres un mentor experto en Order Blocks y SMC. Responde conciso y en español.";
                const response = await callGeminiAPI(text, sys);

                addBubble(response, 'ai', true);
                input.disabled = false;
                document.getElementById('typing-indicator').style.display = 'none';
                input.focus();
            }

            function addBubble(text, type, save = false) {
                const container = document.getElementById('chat-messages');
                const div = document.createElement('div');
                div.className = `chat-bubble bubble-${type}`;
                let safe = escapeHTML(text);
                div.innerHTML = safe.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
                if (save) saveChatHistory(text, type);
            }

            async function generateScenario() {
                if (isGeneratingScenario) return;
                isGeneratingScenario = true;

                const btnGen = document.getElementById('btn-generate-scenario');
                const btnSolve = document.getElementById('btn-solve-scenario');

                document.getElementById('scenario-display').style.display = 'block';
                document.getElementById('scenario-solution').style.display = 'none';
                document.getElementById('scenario-text').innerHTML = '<em>Generando... <i class="fas fa-spinner fa-spin"></i></em>';

                btnGen.classList.add('btn-loading');
                btnSolve.disabled = true;

                const prompt = "Genera un escenario hipotético de trading corto (máximo 3 frases) describiendo la acción del precio. Termina preguntando '¿Dónde identificarías el OB?'. No des la solución.";

                currentScenarioText = await callGeminiAPI(prompt);
                document.getElementById('scenario-text').innerHTML = escapeHTML(currentScenarioText).replace(/\n/g, '<br>');

                btnGen.classList.remove('btn-loading');
                isGeneratingScenario = false;
                if (currentScenarioText.length > 20) btnSolve.disabled = false;
            }

            async function solveScenario() {
                const btnSolve = document.getElementById('btn-solve-scenario');
                const solBox = document.getElementById('scenario-solution');
                const solText = document.getElementById('solution-text');

                btnSolve.disabled = true;
                solBox.style.display = 'block';
                solText.innerHTML = '<em>Analizando... <i class="fas fa-spinner fa-spin"></i></em>';

                const prompt = `Analista experto: Explica la solución de este escenario: "${currentScenarioText}".`;
                const solution = await callGeminiAPI(prompt);

                solText.innerHTML = escapeHTML(solution).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                btnSolve.disabled = false;
            }

            // --- INIT ---
            function init() {
                document.getElementById('current-year').textContent = new Date().getFullYear();

                // Slider Logic
                const slider = document.getElementById('pd-slider');
                const feedback = document.getElementById('pd-feedback');
                if (slider && feedback) {
                    slider.addEventListener('input', (e) => {
                        const val = parseInt(e.target.value);
                        if (val < 45) feedback.innerHTML = `<span style="color: var(--secondary-teal)"><i class="fas fa-check-circle"></i> ZONA DE DESCUENTO (${val}%)</span>`;
                        else if (val > 55) feedback.innerHTML = `<span style="color: var(--danger-dark)"><i class="fas fa-times-circle"></i> ZONA PREMIUM (${val}%)</span>`;
                        else feedback.innerHTML = `<span style="color: var(--text-grey)">50% (Equilibrio)</span>`;
                    });
                }

                // Initial Renders
                renderChart(6);
                drawAMD(3);
                drawBreaker(false);
                loadChatHistory();

                // Window Resize (Debounced)
                window.addEventListener('resize', debounce(() => {
                    renderChart(6);
                    drawAMD(3);
                    drawBreaker(false);
                }, 250));
            }

            return {
                init,
                promptForApiKey,
                sendMessage,
                handleEnter,
                generateScenario,
                solveScenario,
                triggerSpongeAnimation,
                animateAMD,
                animateBreaker,
                replayChart,
                updateMeanThreshold
            };
        })();

        // Iniciar al cargar
        document.addEventListener('DOMContentLoaded', KawnBitApp.init);
    </script>

</body>

</html>