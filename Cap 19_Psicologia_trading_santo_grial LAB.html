<!DOCTYPE html>
<html lang="es" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Capítulo 19: Psicología del Trading – El Santo Grial. Herramientas avanzadas de entrenamiento mental.">
    <title>KawnBit | Cap 19: Psicología del Trading (Mental Gym Edition)</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@400;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Librerías Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Configuración Tailwind KawnBit -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kawn: {
                            light: '#ccfbf1', // Teal 100
                            base: '#14b8a6',  // Teal 500
                            dark: '#0f766e',  // Teal 700
                            deep: '#134e4a',  // Teal 900
                        },
                        slate: {
                            50: '#f8fafc',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(20, 184, 166, 0.1), 0 2px 4px -1px rgba(20, 184, 166, 0.06)',
                        'glow': '0 0 15px rgba(20, 184, 166, 0.3)',
                    },
                    animation: {
                        'breathe-cycle': 'breathe 16s infinite linear',
                        'spin-slow': 'spin 3s linear infinite',
                    },
                    keyframes: {
                        breathe: {
                            '0%': { transform: 'scale(1)', opacity: '0.8' },     /* Inicio */
                            '25%': { transform: 'scale(1.5)', opacity: '1' },    /* Inhalar (4s) */
                            '50%': { transform: 'scale(1.5)', opacity: '1' },    /* Retener (4s) */
                            '75%': { transform: 'scale(1)', opacity: '0.8' },    /* Exhalar (4s) */
                            '100%': { transform: 'scale(1)', opacity: '0.8' }    /* Retener (4s) */
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos Base */
        body {
            background-color: #f8fafc;
            color: #334155;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Montserrat', sans-serif;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #14b8a6;
        }

        /* Logo */
        .kawn-logo-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .kawn-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #14b8a6 0%, #0f766e 100%);
            border-radius: 8px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(20, 184, 166, 0.4);
        }

        .kawn-logo-icon::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-top: 3px solid white;
            border-right: 3px solid white;
            transform: rotate(-15deg);
            top: 10px;
            left: 10px;
        }

        .kawn-logo-icon::after {
            content: 'K';
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 22px;
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* UI Components */
        .card-concept {
            background: white;
            border-radius: 0.75rem;
            border-left: 4px solid #14b8a6;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            transition: transform 0.2s;
        }

        .card-concept:hover {
            transform: translateY(-2px);
        }

        .blockquote-custom {
            border-left: 4px solid #0f766e;
            padding-left: 1.5rem;
            font-style: italic;
            color: #475569;
            margin: 2rem 0;
            font-size: 1.1rem;
            background: linear-gradient(to right, #f1f5f9, transparent);
            padding-top: 1rem;
            padding-bottom: 1rem;
            border-radius: 0 0.5rem 0.5rem 0;
        }

        .btn-primary {
            background-color: #14b8a6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .btn-primary:hover {
            background-color: #0f766e;
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #94a3b8;
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Chat & AI */
        .message-bubble {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .user-msg {
            background-color: #14b8a6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .ai-msg {
            background-color: #f1f5f9;
            color: #334155;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            border: 1px solid #e2e8f0;
        }

        .ai-msg p {
            margin-bottom: 0.5rem;
        }

        /* Breathing Circle */
        .breathing-core {
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, #14b8a6 0%, #ccfbf1 70%);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(20, 184, 166, 0.5);
        }

        /* Fallbacks */
        .error-box {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #b91c1c;
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-top: 1rem;
        }
    </style>
</head>

<body class="antialiased">

    <!-- Navbar -->
    <nav
        class="sticky top-0 z-50 w-full bg-white/90 backdrop-blur-md border-b border-slate-200 shadow-sm transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="kawn-logo-wrapper select-none">
                    <div class="kawn-logo-icon"></div>
                    <div class="flex flex-col">
                        <span class="text-2xl font-black text-slate-900 tracking-tight leading-none">KAWNBIT</span>
                        <span
                            class="text-[0.6rem] font-bold text-kawn-base uppercase tracking-[0.2em] leading-none mt-1">Quantitative
                            Trading Community</span>
                    </div>
                </div>
                <button id="mobile-menu-btn" class="md:hidden p-2 text-slate-600 hover:text-kawn-base"
                    aria-label="Abrir menú"><i data-lucide="menu" class="w-6 h-6"></i></button>
                <div class="hidden md:flex space-x-8 items-center">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">SMC Mastery Series</span>
                    <div class="h-6 w-px bg-slate-200"></div>
                    <a href="#" class="text-kawn-base font-bold border-b-2 border-kawn-base pb-1">Capítulo 19</a>
                    <a href="#gimnasio-mental"
                        class="text-slate-500 hover:text-kawn-base font-medium transition-colors">Gimnasio Mental</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Layout -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <div class="flex flex-col md:flex-row gap-12">

            <!-- Sidebar TOC -->
            <aside id="sidebar-toc" class="hidden md:block w-64 flex-shrink-0 transition-transform duration-300">
                <div class="sticky top-28">
                    <h3
                        class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 border-b border-slate-200 pb-2">
                        Contenido</h3>
                    <nav id="toc-container"
                        class="flex flex-col space-y-1 text-sm max-h-[80vh] overflow-y-auto pr-2 custom-scrollbar">
                    </nav>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 max-w-4xl min-w-0">

                <!-- Hero -->
                <section class="mb-16 fade-in-up">
                    <span
                        class="inline-block py-1 px-3 rounded-full bg-kawn-light text-kawn-deep text-xs font-bold uppercase tracking-wider mb-4 border border-kawn-base/20">Capítulo
                        19</span>
                    <h1 class="text-4xl md:text-5xl font-black text-slate-900 mb-6 leading-tight">Psicología del
                        Trading: <br><span class="text-kawn-base">El Santo Grial</span></h1>
                    <p class="text-xl text-slate-600 leading-relaxed border-l-4 border-slate-300 pl-6">Descubre la clave
                        oculta del éxito. Dominar tu mente es el factor definitivo que separa a los traders rentables de
                        los que abandonan.</p>
                </section>

                <!-- Introducción -->
                <section id="introduccion" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center"><i data-lucide="key"
                            class="text-kawn-base mr-3"></i> Introducción: La clave oculta</h2>
                    <div class="prose max-w-none text-slate-600 leading-7">
                        <p class="mb-4">El 90% de los traders fracasan por razones psicológicas, no técnicas.</p>
                        <div class="card-concept">
                            <h4 class="font-bold text-slate-800 mb-2">La brecha de ejecución</h4>
                            <p class="text-sm">Saber qué hacer no es lo mismo que hacerlo. El miedo y la codicia
                                interfieren en la ejecución.</p>
                        </div>
                    </div>
                </section>

                <!-- El Ego -->
                <section id="el-ego" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center"><i data-lucide="shield-alert"
                            class="text-kawn-base mr-3"></i> El ego: enemigo interno</h2>
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-slate-50 p-5 rounded-lg border border-slate-200">
                            <h4 class="font-bold text-slate-900 mb-2 flex items-center gap-2"><i data-lucide="x-circle"
                                    class="text-red-500 w-4 h-4"></i> Señales de Ego</h4>
                            <ul class="text-sm space-y-2 text-slate-600 list-disc pl-4">
                                <li>No aceptar pérdidas.</li>
                                <li>Trading vengativo.</li>
                            </ul>
                        </div>
                        <div class="bg-kawn-light/30 p-5 rounded-lg border border-kawn-light">
                            <h4 class="font-bold text-slate-900 mb-2 flex items-center gap-2"><i
                                    data-lucide="check-circle" class="text-kawn-base w-4 h-4"></i> Antídoto: Humildad
                            </h4>
                            <ul class="text-sm space-y-2 text-slate-600 list-disc pl-4">
                                <li>El mercado siempre tiene la razón.</li>
                                <li>Proteger capital sobre tener razón.</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- Autocontrol -->
                <section id="autocontrol" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center"><i data-lucide="activity"
                            class="text-kawn-base mr-3"></i> Autocontrol emocional</h2>
                    <div class="bg-white rounded-xl shadow-card border border-slate-100 p-6 mb-8">
                        <h3 class="font-bold text-slate-800 text-lg mb-4">Simulador: Emoción vs. Desempeño</h3>
                        <div class="flex gap-4 mb-4">
                            <button onclick="updateChart('novice')"
                                class="btn-primary bg-slate-200 text-slate-700 hover:bg-slate-300">Modo Novato</button>
                            <button onclick="updateChart('pro')" class="btn-primary">Modo Profesional</button>
                        </div>
                        <div class="relative h-64 w-full" id="chartContainer">
                            <canvas id="emotionChart"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Miedo & Prospect Theory -->
                <section id="prospect-theory" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center"><i data-lucide="scale"
                            class="text-kawn-base mr-3"></i> Aversión a la Pérdida</h2>
                    <div class="bg-white rounded-xl shadow-card border border-slate-100 p-6 mb-8">
                        <h3 class="font-bold text-slate-800 text-lg mb-2">Visualización: Asimetría del Dolor</h3>
                        <p class="text-sm text-slate-500 mb-4">El dolor de perder es 2x más intenso que el placer de
                            ganar (Kahneman).</p>
                        <div id="prospectChart" class="w-full h-80"></div>
                    </div>
                </section>

                <!-- R-Multiples -->
                <section id="r-multiples" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center"><i data-lucide="calculator"
                            class="text-kawn-base mr-3"></i> Neutralización Monetaria ("R")</h2>
                    <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 shadow-sm">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Riesgo
                                    ($)</label><input type="number" id="calc-risk" value="100"
                                    class="w-full p-2 border border-slate-300 rounded"></div>
                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Resultado
                                    ($)</label><input type="number" id="calc-pnl" value="250"
                                    class="w-full p-2 border border-slate-300 rounded"></div>
                            <div class="flex items-end"><button onclick="calculateR()"
                                    class="w-full btn-primary">Calcular</button></div>
                        </div>
                        <div id="result-r" class="hidden bg-slate-800 text-white p-4 rounded text-center">
                            <p class="text-3xl font-black text-kawn-light mt-1"><span id="r-output">0</span>R</p>
                        </div>
                    </div>
                </section>

                <!-- NUEVO: GIMNASIO MENTAL -->
                <section id="gimnasio-mental" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="dumbbell" class="text-kawn-base mr-3"></i> Gimnasio Mental
                    </h2>
                    <p class="mb-6 text-slate-600">Herramientas prácticas para calibrar tu mente antes y durante la
                        sesión.</p>

                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- 1. Box Breathing -->
                        <div
                            class="bg-white border-2 border-kawn-light rounded-xl p-6 shadow-sm flex flex-col items-center justify-center text-center relative overflow-hidden">
                            <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2"><i data-lucide="wind"
                                    class="w-4 h-4 text-kawn-base"></i> Respiración Táctica (Box)</h3>
                            <p class="text-xs text-slate-500 mb-6">Sigue el ritmo para reducir cortisol. 4s Inhalar - 4s
                                Retener - 4s Exhalar - 4s Retener.</p>

                            <div class="relative w-40 h-40 flex items-center justify-center mb-6">
                                <div id="breath-circle" class="breathing-core transform scale-100 opacity-80"></div>
                                <div id="breath-text" class="absolute font-bold text-slate-700 text-lg">Inhala</div>
                            </div>

                            <button id="btn-breath-toggle" class="btn-primary w-full max-w-xs"
                                onclick="toggleBreathing()">Iniciar Sesión</button>
                        </div>

                        <!-- 2. Cognitive Reframing -->
                        <div class="bg-white border-2 border-kawn-light rounded-xl p-6 shadow-sm flex flex-col">
                            <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2"><i
                                    data-lucide="refresh-cw" class="w-4 h-4 text-kawn-base"></i> Re-programador
                                Cognitivo (IA)</h3>
                            <p class="text-xs text-slate-500 mb-4">Transforma pensamientos limitantes en creencias de
                                trader profesional.</p>

                            <textarea id="reframe-input"
                                class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-slate-50 mb-3 focus:ring-1 focus:ring-kawn-base outline-none"
                                rows="2" placeholder="Ej: Soy un inútil por perder este trade..."></textarea>
                            <button id="btn-reframe" class="btn-primary text-sm mb-4">Re-encuadrar Pensamiento</button>

                            <div id="reframe-output"
                                class="hidden bg-kawn-light/20 border-l-4 border-kawn-base p-3 rounded text-sm text-slate-700">
                            </div>
                        </div>
                    </div>

                    <!-- 3. Habit Tracker -->
                    <div
                        class="mt-8 bg-slate-900 rounded-xl p-6 text-white flex flex-col md:flex-row items-center justify-between gap-6 shadow-2xl">
                        <div class="flex items-center gap-4">
                            <div class="bg-kawn-base/20 p-3 rounded-full"><i data-lucide="calendar-check"
                                    class="w-8 h-8 text-kawn-base"></i></div>
                            <div>
                                <h3 class="font-bold text-lg">Racha de Disciplina</h3>
                                <p class="text-slate-400 text-xs">Días consecutivos siguiendo tu plan al 100%.</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-6">
                            <div class="text-center">
                                <span id="streak-count" class="block text-4xl font-black text-kawn-light">0</span>
                                <span class="text-xs uppercase tracking-widest text-slate-500">Días</span>
                            </div>
                            <div class="flex flex-col gap-2">
                                <button onclick="updateStreak(1)"
                                    class="bg-kawn-base hover:bg-kawn-dark text-white px-4 py-1 rounded text-sm font-bold transition-colors">+1
                                    Día Perfecto</button>
                                <button onclick="updateStreak(0)"
                                    class="bg-red-500/20 hover:bg-red-500/40 text-red-200 px-4 py-1 rounded text-xs transition-colors">Rompí
                                    reglas (Reset)</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Estado de Flujo + TTS -->
                <section id="the-zone" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center"><i data-lucide="zap"
                            class="text-kawn-base mr-3"></i> El Estado de Flujo</h2>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-white border-2 border-kawn-base rounded-xl p-6">
                            <h3 class="font-bold text-slate-900 mb-4">Checklist de Estado</h3>
                            <div class="space-y-3">
                                <label class="flex items-center space-x-3 cursor-pointer"><input type="checkbox"
                                        class="form-checkbox h-5 w-5 text-kawn-base rounded zone-check"><span
                                        class="text-sm">Tranquilo y sin urgencia.</span></label>
                                <label class="flex items-center space-x-3 cursor-pointer"><input type="checkbox"
                                        class="form-checkbox h-5 w-5 text-kawn-base rounded zone-check"><span
                                        class="text-sm">Acepto el riesgo.</span></label>
                                <div id="zone-status" class="mt-4 text-center font-bold text-slate-400 text-sm">...
                                </div>
                            </div>
                        </div>
                        <div
                            class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-6 text-white flex flex-col justify-between">
                            <h3 class="font-bold text-kawn-light mb-2 flex items-center gap-2"><i
                                    data-lucide="headphones" class="w-4 h-4"></i> Coach de Voz IA</h3>
                            <div class="mt-auto">
                                <button id="btn-tts-start"
                                    class="w-full bg-white text-slate-900 font-bold py-2 rounded hover:bg-kawn-light flex items-center justify-center gap-2"><i
                                        data-lucide="play-circle" class="w-4 h-4"></i> Generar & Escuchar</button>
                                <div id="audio-player-container"
                                    class="mt-4 hidden text-center text-xs text-kawn-base animate-pulse">
                                    Reproduciendo...</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Simulador IA -->
                <section id="simulacion-ia" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center"><i data-lucide="gamepad-2"
                            class="text-kawn-base mr-3"></i> Simulador de Crisis (IA)</h2>
                    <div
                        class="bg-slate-900 rounded-xl p-8 border border-slate-700 shadow-2xl relative overflow-hidden">
                        <div id="sim-start-view" class="text-center">
                            <p class="text-slate-400 mb-6 text-sm">Genera un evento aleatorio y decide bajo presión.</p>
                            <button id="btn-gen-scenario"
                                class="bg-kawn-base text-white px-6 py-3 rounded-lg font-bold hover:bg-kawn-dark flex items-center justify-center mx-auto gap-2"><i
                                    data-lucide="sparkles" class="w-4 h-4"></i> Generar Escenario</button>
                        </div>
                        <div id="sim-loading" class="hidden text-center py-10">
                            <div class="loader mx-auto mb-4"></div>
                            <p class="text-slate-400 text-sm animate-pulse">Analizando...</p>
                        </div>
                        <div id="sim-scenario-view" class="hidden fade-in-up">
                            <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-600 mb-6">
                                <p id="scenario-text" class="text-white font-medium text-lg leading-relaxed"></p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3"><button
                                    onclick="handleSimAction('Vender todo')"
                                    class="p-3 bg-red-900/30 text-red-200 rounded text-sm hover:bg-red-900/50">Pánico</button><button
                                    onclick="handleSimAction('Mantener Plan')"
                                    class="p-3 bg-blue-900/30 text-blue-200 rounded text-sm hover:bg-blue-900/50">Disciplina</button><button
                                    onclick="handleSimAction('Doblar')"
                                    class="p-3 bg-green-900/30 text-green-200 rounded text-sm hover:bg-green-900/50">Codicia</button>
                            </div>
                        </div>
                        <div id="sim-result-view"
                            class="hidden fade-in-up mt-4 bg-slate-800 p-4 rounded-lg border-l-4 border-kawn-base">
                            <div id="sim-analysis-text" class="text-sm text-slate-300"></div><button
                                onclick="resetSim()"
                                class="mt-4 text-xs text-slate-500 hover:text-white underline">Reiniciar</button>
                        </div>
                    </div>
                </section>

                <!-- Ejercicios y Validación -->
                <section id="ejercicios" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center"><i data-lucide="brain-circuit"
                            class="text-kawn-base mr-3"></i> Validación y Diario</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200 mb-8 relative">
                        <h3 class="font-bold text-slate-800 mb-2">Analizador de Diario IA</h3>
                        <textarea id="journal-input" class="w-full p-3 border border-slate-300 rounded-lg text-sm mb-3"
                            rows="3" placeholder="Ej: Me sentí frustrado..."></textarea>
                        <div class="flex justify-end"><button id="btn-analyze-journal"
                                class="btn-primary text-sm flex gap-2"><i data-lucide="scan-face" class="w-4 h-4"></i>
                                Analizar</button></div>
                        <div id="journal-result"
                            class="hidden mt-4 bg-slate-50 p-4 rounded-lg border-l-4 border-kawn-base text-sm text-slate-700">
                        </div>
                    </div>

                    <div class="bg-slate-900 p-8 rounded-xl shadow-2xl text-white">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold">Quiz Maestro</h3><span id="quiz-score"
                                class="bg-white/20 px-3 py-1 rounded-full text-sm font-mono">0/0</span>
                        </div>
                        <div id="quiz-container" class="space-y-6"></div>
                        <div id="quiz-complete" class="hidden text-center mt-6">
                            <p class="text-2xl font-bold mb-2 text-kawn-base">¡Completado!</p><button
                                onclick="window.resetQuiz()"
                                class="bg-white text-slate-900 px-6 py-2 rounded-lg font-bold text-sm hover:bg-gray-100 transition-colors">Reiniciar</button>
                        </div>
                    </div>
                </section>

                <!-- NUEVA SECCIÓN: ESCUDO COGNITIVO IA -->
                <section id="escudo-cognitivo" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="shield-check" class="text-kawn-base mr-3"></i> Escudo Cognitivo IA ✨
                    </h2>
                    <p class="mb-6 text-slate-600">Herramientas avanzadas para neutralizar el ruido externo y tus
                        propios sesgos.</p>

                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Module 1: FUD Buster -->
                        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-slate-600">
                            <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                <i data-lucide="volume-x" class="w-5 h-5 text-slate-500"></i> FUD Buster
                            </h3>
                            <p class="text-xs text-slate-500 mb-4">Pega un titular de noticias alarmista. La IA lo
                                reescribirá en un lenguaje neutral y aburrido para eliminar el miedo.</p>
                            <input type="text" id="fud-input"
                                class="w-full p-2 border border-slate-300 rounded mb-3 text-sm"
                                placeholder="Ej: ¡CRASH INMINENTE! ¡TODO SE HUNDE!">
                            <button id="btn-fud-buster" class="btn-primary w-full text-sm">Neutralizar Pánico</button>
                            <div id="fud-result"
                                class="hidden mt-3 p-3 bg-slate-50 text-slate-700 text-sm italic border-l-2 border-slate-300">
                            </div>
                        </div>

                        <!-- Module 2: The Devil's Advocate -->
                        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-red-500">
                            <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                <i data-lucide="gavel" class="w-5 h-5 text-red-500"></i> El Abogado del Diablo
                            </h3>
                            <p class="text-xs text-slate-500 mb-4">Cuéntale tu idea de trade. La IA buscará
                                despiadadamente tus sesgos cognitivos antes de que operes.</p>
                            <textarea id="reality-input"
                                class="w-full p-2 border border-slate-300 rounded mb-3 text-sm h-20"
                                placeholder="Ej: Quiero comprar porque ha bajado mucho y tiene que subir..."></textarea>
                            <button id="btn-reality-check"
                                class="btn-primary w-full text-sm bg-red-600 hover:bg-red-700">Detectar Sesgos</button>
                            <div id="reality-result"
                                class="hidden mt-3 p-3 bg-red-50 text-red-800 text-sm border-l-2 border-red-400"></div>
                        </div>
                    </div>
                </section>

                <!-- Glosario -->
                <section id="glosario" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6">Glosario</h2>
                    <div class="space-y-3" id="glossary-container"></div>
                </section>
            </main>
        </div>
    </div>

    <!-- AI Mentor -->
    <button id="ai-toggle"
        class="fixed bottom-6 right-6 z-40 bg-slate-900 text-white p-4 rounded-full shadow-glow hover:scale-105 transition-transform flex items-center gap-2"><i
            data-lucide="bot" class="w-6 h-6 text-kawn-base"></i><span class="font-bold hidden md:inline">Mentor
            IA</span></button>
    <div id="ai-modal"
        class="hidden fixed bottom-24 right-6 w-96 max-w-[90vw] bg-white rounded-xl shadow-2xl border border-slate-200 z-50 flex flex-col h-[500px]">
        <div class="p-4 bg-slate-900 text-white rounded-t-xl flex justify-between items-center">
            <h3 class="font-bold flex gap-2"><i data-lucide="bot" class="text-kawn-base w-4 h-4"></i> Coach</h3><button
                id="close-ai"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div id="chat-history" class="flex-1 overflow-y-auto p-4 bg-slate-50 flex flex-col chat-container">
            <div class="ai-msg message-bubble shadow-sm">Hola. ¿En qué puedo ayudarte hoy?</div>
        </div>
        <div class="p-4 border-t border-slate-200 bg-white rounded-b-xl flex gap-2"><input type="text" id="user-input"
                class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm outline-none"
                placeholder="Escribe..."><button id="send-ai" class="bg-kawn-base text-white p-2 rounded-lg"><i
                    data-lucide="send" class="w-4 h-4"></i></button></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') lucide.createIcons();
            async function callGemini(prompt, sys = "") {
                try {
                    const response = await fetch('/.netlify/functions/gemini-proxy', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: sys }] }
                        })
                    });

                    if (!response.ok) throw new Error("API Error: " + response.status);

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || data.result || "No pude generar una respuesta.";

                } catch (error) {
                    console.error("AI Error:", error);
                    return "Error de conexión. Intenta más tarde.";
                }
            }

            // --- 1. BOX BREATHING ---
            let breathInterval;
            let isBreathing = false;
            const breathCircle = document.getElementById('breath-circle');
            const breathText = document.getElementById('breath-text');
            const btnBreath = document.getElementById('btn-breath-toggle');

            window.toggleBreathing = () => {
                if (isBreathing) {
                    clearInterval(breathInterval);
                    if (breathCircle) {
                        breathCircle.classList.remove('animate-breathe-cycle');
                        breathCircle.style.transform = 'scale(1)';
                    }
                    if (breathText) breathText.innerText = 'Inhala';
                    if (btnBreath) {
                        btnBreath.innerText = 'Iniciar Sesión';
                        btnBreath.classList.remove('bg-red-500', 'hover:bg-red-600');
                        btnBreath.classList.add('bg-kawn-base', 'hover:bg-kawn-dark');
                    }
                    isBreathing = false;
                } else {
                    if (breathCircle) breathCircle.classList.add('animate-breathe-cycle');
                    if (btnBreath) {
                        btnBreath.innerText = 'Detener';
                        btnBreath.classList.remove('bg-kawn-base', 'hover:bg-kawn-dark');
                        btnBreath.classList.add('bg-red-500', 'hover:bg-red-600');
                    }
                    isBreathing = true;

                    let phase = 0;
                    const phases = ['Inhala (4s)', 'Retén (4s)', 'Exhala (4s)', 'Retén (4s)'];
                    if (breathText) breathText.innerText = phases[0];

                    breathInterval = setInterval(() => {
                        phase = (phase + 1) % 4;
                        if (breathText) breathText.innerText = phases[phase];
                    }, 4000);
                }
            };

            // --- 2. COGNITIVE REFRAMING ---
            const btnReframe = document.getElementById('btn-reframe');
            if (btnReframe) {
                btnReframe.onclick = async function () {
                    const txtEl = document.getElementById('reframe-input');
                    const out = document.getElementById('reframe-output');
                    if (!txtEl || !out) return;

                    const txt = txtEl.value.trim();
                    if (!txt) return;

                    this.disabled = true;
                    this.innerText = "Re-programando...";
                    out.classList.remove('hidden');
                    out.innerHTML = "Consultando a la IA...";

                    const prompt = `El usuario tiene este pensamiento limitante de trading: "${txt}". Re-encuádralo a un pensamiento estoico, probabilístico y profesional. Sé breve y directo.`;
                    const ans = await callGemini(prompt, "Eres un psicólogo de trading experto.");

                    out.innerHTML = typeof marked !== 'undefined' ? `<strong>Re-encuadre:</strong> ${marked.parse(ans)}` : `<strong>Re-encuadre:</strong> ${ans}`;

                    this.disabled = false;
                    this.innerText = "Re-encuadrar Pensamiento";
                };
            }

            // --- 3. DISCIPLINE STREAK (Safe LocalStorage) ---
            const streakCount = document.getElementById('streak-count');
            let streak = 0;

            try {
                streak = parseInt(localStorage.getItem('kawn-streak') || '0');
            } catch (e) { console.warn("LocalStorage access denied"); }

            if (streakCount) streakCount.innerText = streak;

            window.updateStreak = (val) => {
                if (val === 0) streak = 0;
                else streak += val;

                try {
                    localStorage.setItem('kawn-streak', streak);
                } catch (e) { }

                if (streakCount) {
                    streakCount.innerText = streak;
                    streakCount.classList.add('scale-150', 'text-green-400');
                    setTimeout(() => streakCount.classList.remove('scale-150', 'text-green-400'), 200);
                }
            };

            // --- 4. CHARTS (Safe Load) ---
            const ctxE = document.getElementById('emotionChart');
            if (typeof Chart !== 'undefined' && ctxE) {
                const emoChart = new Chart(ctxE.getContext('2d'), {
                    type: 'line',
                    data: { labels: ['1', '2', '3', '4', '5', '6'], datasets: [{ label: 'Capital', data: [100, 110, 90, 80, 120, 70], borderColor: '#ef4444' }] },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                window.updateChart = (m) => {
                    emoChart.data.datasets[0].data = m === 'pro' ? [100, 102, 104, 103, 105, 106] : [100, 120, 90, 80, 130, 60];
                    emoChart.data.datasets[0].borderColor = m === 'pro' ? '#14b8a6' : '#ef4444';
                    emoChart.update();
                };
            } else if (ctxE) {
                ctxE.parentElement.innerHTML = '<div class="error-box">Gráfico no disponible (Chart.js no cargó).</div>';
            }

            if (typeof Plotly !== 'undefined' && document.getElementById('prospectChart')) {
                const pX = [], pY = []; for (let i = -100; i <= 100; i += 5) { pX.push(i); pY.push(i >= 0 ? Math.pow(i, 0.8) : -2.5 * Math.pow(-i, 0.8)); }
                Plotly.newPlot('prospectChart', [{ x: pX, y: pY, mode: 'lines', line: { color: '#14b8a6' }, fill: 'tozeroy' }], { margin: { t: 20, b: 20, l: 30, r: 20 } }, { displayModeBar: false });
            }

            // --- 5. R-CALC ---
            window.calculateR = () => {
                const rEl = document.getElementById('calc-risk');
                const pEl = document.getElementById('calc-pnl');
                if (!rEl || !pEl) return;

                const r = parseFloat(rEl.value);
                const p = parseFloat(pEl.value);
                if (r && r !== 0) {
                    const res = (p / r).toFixed(2);
                    const resDiv = document.getElementById('result-r');
                    const outDiv = document.getElementById('r-output');
                    if (resDiv) resDiv.classList.remove('hidden');
                    if (outDiv) outDiv.innerText = res;
                }
            };

            // --- 6. QUIZ LOGIC (Robust) ---
            const qData = [
                { q: "¿Causa #1 fracaso?", o: ["Técnica", "Psicología"], a: 1, e: "80% es mental." },
                { q: "Prospect Theory?", o: ["Perder duele x2", "Ganar duele"], a: 0, e: "Asimetría del dolor." },
                { q: "Antídoto Ego?", o: ["Humildad", "Codicia"], a: 0, e: "Aceptar el error." }
            ];
            // (Keeping short for brevity, logic handles N questions)

            const qCont = document.getElementById('quiz-container');
            let qS = 0;

            window.renderQuiz = () => {
                if (!qCont) return;
                qCont.innerHTML = ''; qS = 0;
                if (document.getElementById('quiz-score')) document.getElementById('quiz-score').innerText = `0/${qData.length}`;

                qData.forEach((it, i) => {
                    const d = document.createElement('div');
                    d.className = "bg-white/10 p-4 rounded mb-2";
                    d.innerHTML = `<p class="font-bold mb-2">${i + 1}. ${it.q}</p>${it.o.map((o, oi) => `<button onclick="chkQ(${i},${oi},this)" data-ok="${oi === it.a}" class="block w-full text-left p-2 bg-slate-800 mb-1 rounded hover:bg-slate-700">${o}</button>`).join('')}<div id="fb-${i}" class="hidden mt-2 text-sm text-gray-300 bg-slate-800 p-2 border-l-2 border-kawn-base">${it.e}</div>`;
                    qCont.appendChild(d);
                });
            };

            window.chkQ = (qi, oi, b) => {
                b.parentElement.querySelectorAll('button').forEach(btn => {
                    btn.disabled = true;
                    if (btn.dataset.ok === "true") btn.classList.add('bg-green-600');
                });
                if (b.dataset.ok === "true") qS++; else b.classList.add('bg-red-600');

                const fb = document.getElementById(`fb-${qi}`);
                if (fb) fb.classList.remove('hidden');

                if (document.getElementById('quiz-score')) document.getElementById('quiz-score').innerText = `${qS}/${qData.length}`;

                const disabledBtns = document.querySelectorAll('#quiz-container button[disabled]').length;
                // Rough check for completion
                const totalOptions = document.querySelectorAll('#quiz-container button').length;
                if (disabledBtns === totalOptions && document.getElementById('quiz-complete')) {
                    document.getElementById('quiz-complete').classList.remove('hidden');
                }
            };
            if (qCont) window.renderQuiz();

            // --- 7. AI FEATURES (Safe Listeners) ---
            const btnAnalyze = document.getElementById('btn-analyze-journal');
            if (btnAnalyze) {
                btnAnalyze.onclick = async function () {
                    const inp = document.getElementById('journal-input');
                    const res = document.getElementById('journal-result');
                    if (!inp || !res) return;

                    const t = inp.value.trim();
                    if (!t) return;

                    this.disabled = true;
                    res.classList.remove('hidden');
                    res.innerText = "Analizando...";

                    try {
                        const aiRes = await callGemini(`Analiza: ${t}`, "Psicólogo trading.");
                        res.innerHTML = typeof marked !== 'undefined' ? marked.parse(aiRes) : aiRes;
                    } finally {
                        this.disabled = false;
                    }
                };
            }

            const btnGenScen = document.getElementById('btn-gen-scenario');
            if (btnGenScen) {
                btnGenScen.onclick = async () => {
                    const startV = document.getElementById('sim-start-view');
                    const loadV = document.getElementById('sim-loading');
                    const scenV = document.getElementById('sim-scenario-view');
                    const txtV = document.getElementById('scenario-text');

                    if (startV) startV.classList.add('hidden');
                    if (loadV) loadV.classList.remove('hidden');

                    try {
                        window.curScen = await callGemini("Escenario crisis trading breve.", "Realista.");
                        if (loadV) loadV.classList.add('hidden');
                        if (scenV) scenV.classList.remove('hidden');
                        if (txtV) txtV.innerText = window.curScen;
                    } catch (e) {
                        if (loadV) loadV.classList.add('hidden');
                        if (startV) startV.classList.remove('hidden');
                        alert("Error generando escenario.");
                    }
                };
            }

            window.handleSimAction = async (a) => {
                const scenV = document.getElementById('sim-scenario-view');
                const loadV = document.getElementById('sim-loading');
                const resV = document.getElementById('sim-result-view');
                const anaTxt = document.getElementById('sim-analysis-text');

                if (scenV) scenV.classList.add('hidden');
                if (loadV) loadV.classList.remove('hidden');

                try {
                    const res = await callGemini(`Escenario: ${window.curScen}. Acción: ${a}.`, "Mentor estricto. Evalúa.");
                    if (loadV) loadV.classList.add('hidden');
                    if (resV) resV.classList.remove('hidden');
                    if (anaTxt) anaTxt.innerHTML = typeof marked !== 'undefined' ? marked.parse(res) : res;
                } catch (e) {
                    if (loadV) loadV.classList.add('hidden');
                    if (scenV) scenV.classList.remove('hidden');
                }
            };

            window.resetSim = () => {
                const resV = document.getElementById('sim-result-view');
                const startV = document.getElementById('sim-start-view');
                if (resV) resV.classList.add('hidden');
                if (startV) startV.classList.remove('hidden');
            };

            // --- 8. ESCUDO COGNITIVO ---
            const btnFud = document.getElementById('btn-fud-buster');
            if (btnFud) {
                btnFud.onclick = async function () {
                    const inp = document.getElementById('fud-input');
                    const res = document.getElementById('fud-result');
                    if (!inp || !res) return;

                    const h = inp.value.trim();
                    if (!h) return;

                    this.disabled = true;
                    res.classList.remove('hidden');
                    res.innerText = "Neutralizando...";

                    try {
                        const prompt = `Rewrite this sensationalist trading headline into extremely boring, neutral, dry facts: "${h}"`;
                        const ans = await callGemini(prompt, "You are a stoic fact-checker.");
                        res.innerHTML = typeof marked !== 'undefined' ? marked.parse(ans) : ans;
                    } finally {
                        this.disabled = false;
                    }
                };
            }

            const btnReality = document.getElementById('btn-reality-check');
            if (btnReality) {
                btnReality.onclick = async function () {
                    const inp = document.getElementById('reality-input');
                    const res = document.getElementById('reality-result');
                    if (!inp || !res) return;

                    const i = inp.value.trim();
                    if (!i) return;

                    this.disabled = true;
                    res.classList.remove('hidden');
                    res.innerText = "Auditando...";

                    try {
                        const prompt = `Audit this trade idea for cognitive biases: "${i}"`;
                        const ans = await callGemini(prompt, "Strict Risk Manager.");
                        res.innerHTML = typeof marked !== 'undefined' ? marked.parse(ans) : ans;
                    } finally {
                        this.disabled = false;
                    }
                };
            }

            // --- TTS (Robust Audio) ---
            const btnTTS = document.getElementById('btn-tts-start');
            if (btnTTS) {
                btnTTS.onclick = async function () {
                    if (!apiKey) { alert("API Key requerida"); return; }

                    this.disabled = true;
                    this.innerText = "Generando...";

                    try {
                        const script = await callGemini("Guion meditación trading corto (2 frases).", "Mindfulness.");
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                        const r = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: script }] }],
                                generationConfig: {
                                    responseModalities: ["AUDIO"],
                                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Fenrir" } } }
                                }
                            })
                        });

                        const d = await r.json();
                        const audioData = d.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;

                        if (audioData) {
                            const bin = atob(audioData);
                            const len = bin.length;
                            const bytes = new Uint8Array(len);
                            for (let i = 0; i < len; i++) bytes[i] = bin.charCodeAt(i);

                            const AudioContext = window.AudioContext || window.webkitAudioContext;
                            const actx = new AudioContext();

                            // Important: Resume context if suspended (common in browsers)
                            if (actx.state === 'suspended') await actx.resume();

                            const i16 = new Int16Array(bytes.buffer);
                            const buf = actx.createBuffer(1, i16.length, 24000);
                            const chan = buf.getChannelData(0);
                            for (let i = 0; i < i16.length; i++) chan[i] = i16[i] / 32768.0;

                            const src = actx.createBufferSource();
                            src.buffer = buf;
                            src.connect(actx.destination);
                            src.start(0);

                            const player = document.getElementById('audio-player-container');
                            if (player) player.classList.remove('hidden');
                        }
                    } catch (e) {
                        console.error(e);
                        alert("Error de audio TTS.");
                    } finally {
                        this.disabled = false;
                        this.innerHTML = '<i data-lucide="play-circle" class="w-4 h-4 mr-2"></i> Generar & Escuchar';
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                };
            }

            // --- Chatbot ---
            const chatH = document.getElementById('chat-history');
            const sendBtn = document.getElementById('send-ai');
            const uIn = document.getElementById('user-input');
            const aiMod = document.getElementById('ai-modal');

            if (document.getElementById('ai-toggle')) document.getElementById('ai-toggle').onclick = () => aiMod.classList.remove('hidden');
            if (document.getElementById('close-ai')) document.getElementById('close-ai').onclick = () => aiMod.classList.add('hidden');

            if (sendBtn && uIn && chatH) {
                sendBtn.onclick = async () => {
                    const txt = uIn.value.trim();
                    if (!txt) return;

                    chatH.innerHTML += `<div class="message-bubble user-msg">${txt}</div>`;
                    uIn.value = '';
                    chatH.scrollTop = chatH.scrollHeight;

                    sendBtn.disabled = true;
                    try {
                        const ans = await callGemini(txt, "Coach trading.");
                        chatH.innerHTML += `<div class="message-bubble ai-msg">${typeof marked !== 'undefined' ? marked.parse(ans) : ans}</div>`;
                    } finally {
                        sendBtn.disabled = false;
                        chatH.scrollTop = chatH.scrollHeight;
                    }
                };
            }

            // --- TOC Generator ---
            const toc = document.getElementById('toc-container');
            if (toc) {
                document.querySelectorAll('section[id]').forEach(s => {
                    const h = s.querySelector('h2');
                    if (!h) return;
                    const a = document.createElement('a');
                    a.innerText = h.innerText.replace('✨', '').trim();
                    a.className = "block py-1 pl-2 text-slate-500 hover:text-kawn-base text-xs cursor-pointer";
                    a.onclick = (e) => {
                        e.preventDefault();
                        document.getElementById(s.id).scrollIntoView({ behavior: 'smooth' });
                    };
                    toc.appendChild(a);
                });
            }
        });
    </script>
</body>

</html>