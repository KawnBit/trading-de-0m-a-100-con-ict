<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KawnBit | Cap 2: La liquidez (ICT Core)</title>
    
    <!-- Fuentes Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Librer√≠as Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.27.1/plotly.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Configuraci√≥n Tailwind KawnBit -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kawn: {
                            light: '#ccfbf1', // Teal 100
                            base: '#14b8a6',  // Teal 500
                            dark: '#0f766e',  // Teal 700
                            deep: '#134e4a',  // Teal 900
                        },
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                    },
                    boxShadow: {
                        'glow': '0 0 15px rgba(20, 184, 166, 0.3)',
                    },
                    keyframes: {
                        pulseSlow: {
                            '0%, 100%': { opacity: 1 },
                            '50%': { opacity: 0.5 },
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulseSlow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos base */
        body { background-color: #f8fafc; color: #334155; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #14b8a6; }

        /* Logo KawnBit (CSS Puro) */
        .kawn-logo-icon {
            width: 40px; height: 30px; position: relative; overflow: hidden;
            display: flex; align-items: flex-end; justify-content: center;
        }
        .arc { position: absolute; border-radius: 50% 50% 0 0; border: 3px solid transparent; }
        .arc-1 { width: 100%; height: 100%; top: 0; border-top-color: #0f766e; }
        .arc-2 { width: 70%; height: 70%; top: 30%; border-top-color: #14b8a6; }
        .arc-3 { width: 40%; height: 40%; top: 60%; border-top-color: #ccfbf1; }

        /* Tipograf√≠a y Utilidades */
        h1, h2, h3, h4 { font-family: 'Montserrat', sans-serif; color: #0f172a; }
        p { line-height: 1.8; margin-bottom: 1.5rem; font-size: 1.05rem; }
        
        .highlight-text {
            background: linear-gradient(120deg, transparent 60%, #ccfbf1 60%);
            font-weight: 600; color: #0f766e;
        }

        /* Sidebar TOC */
        .toc-link.active {
            color: #14b8a6; border-left: 3px solid #14b8a6; background-color: #f0fdfa; font-weight: 600;
        }

        /* SVG Interactivo */
        .svg-interactive .hover-trigger { cursor: pointer; transition: all 0.3s; }
        .svg-interactive .hover-trigger:hover { filter: drop-shadow(0 0 5px rgba(20, 184, 166, 0.6)); stroke: #0f766e; }
        .svg-pulse { animation: pulseSlow 2s infinite; }

        /* Animaciones */
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in-up 0.6s ease-out forwards; }
        
        /* Markdown Styles */
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.5em; }
        .markdown-body strong { color: #0f766e; font-weight: 700; }
        
        /* Resource Card Style */
        .resource-card {
            background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1.5rem;
            transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .resource-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #14b8a6; }
    </style>
</head>
<body class="antialiased">

    <!-- Progress Bar -->
    <div class="fixed top-0 left-0 w-full h-1 z-50 bg-slate-200">
        <div id="progressBar" class="h-full bg-kawn-base w-0 transition-all duration-300"></div>
    </div>

    <!-- Navbar Sticky -->
    <nav class="sticky top-0 z-40 w-full backdrop-blur-md bg-white/90 border-b border-slate-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <!-- Logo -->
                <div class="flex items-center gap-3 cursor-pointer" onclick="window.scrollTo(0,0)">
                    <div class="kawn-logo-icon">
                        <div class="arc arc-1"></div>
                        <div class="arc arc-2"></div>
                        <div class="arc arc-3"></div>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-2xl font-black text-kawn-base tracking-tight leading-none">KAWNBIT</span>
                        <span class="text-[0.6rem] font-bold text-slate-500 tracking-[0.2em] leading-none mt-1">QUANTITATIVE TRADING COMMUNITY</span>
                    </div>
                </div>
                
                <!-- Menu Principal (Desktop) -->
                <div class="hidden md:flex items-center gap-6">
                    <a href="#laboratorio" class="text-sm font-medium text-slate-600 hover:text-kawn-base transition-colors">Pr√°ctica</a>
                    <a href="#recursos" class="text-sm font-medium text-slate-600 hover:text-kawn-base transition-colors">Resumen Te√≥rico</a>
                    
                    <div class="h-6 w-px bg-slate-300 mx-2"></div>
                    
                    <button onclick="generateQuiz()" id="btnGenQuizNav" class="bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white text-xs px-4 py-2 rounded-full font-bold shadow-lg transition-all transform hover:scale-105 flex items-center gap-2">
                        <i class="fas fa-magic"></i> Quiz Express AI
                    </button>
                </div>

                <!-- Bot√≥n Men√∫ M√≥vil -->
                <div class="md:hidden flex items-center">
                    <button onclick="toggleMobileMenu()" class="text-slate-600 hover:text-kawn-base focus:outline-none">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Men√∫ M√≥vil (Oculto por defecto) -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-slate-200 absolute w-full left-0 top-20 shadow-lg p-4 flex-col gap-4 animate-fade-in z-50">
            <a href="#laboratorio" class="block text-sm font-medium text-slate-600 hover:text-kawn-base py-2 border-b border-slate-100" onclick="toggleMobileMenu()">Pr√°ctica</a>
            <a href="#recursos" class="block text-sm font-medium text-slate-600 hover:text-kawn-base py-2 border-b border-slate-100" onclick="toggleMobileMenu()">Resumen Te√≥rico</a>
            <button onclick="generateQuiz(); toggleMobileMenu();" class="w-full text-left bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg font-bold text-xs mt-2">
                <i class="fas fa-magic mr-2"></i> Quiz Express AI
            </button>
        </div>
    </nav>

    <!-- Layout Principal -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <div class="grid grid-cols-1 lg:grid-cols-[280px_1fr] gap-12">
            
            <!-- Sidebar (TOC) -->
            <aside class="hidden lg:block relative">
                <div class="sticky top-28 max-h-[calc(100vh-8rem)] overflow-y-auto pr-4">
                    <h5 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Tabla de contenidos</h5>
                    <nav id="toc" class="space-y-1 text-sm border-l border-slate-200">
                        <!-- Generado din√°micamente -->
                    </nav>
                </div>
            </aside>

            <!-- Contenido Principal -->
            <main class="w-full min-w-0" id="main-content">
                
                <!-- Hero Section -->
                <section class="mb-16 animate-fade-in">
                    <span class="inline-block px-3 py-1 rounded-full bg-kawn-light text-kawn-dark text-xs font-bold tracking-wide mb-4">ICT CORE CONCEPTS</span>
                    <h1 class="text-4xl md:text-5xl font-black text-slate-900 mb-6 leading-tight">
                        La liquidez: <br> <span class="text-kawn-base">El motor invisible del mercado</span>
                    </h1>
                    <p class="text-xl text-slate-600 leading-relaxed max-w-3xl">
                        Deja de ver el mercado como un caos aleatorio. Descubre por qu√© el precio se mueve, qu√© buscan realmente las instituciones y c√≥mo dejar de ser la "gasolina" para convertirte en el cazador.
                    </p>
                </section>

                <!-- Contenido Te√≥rico y Componentes -->
                <div class="prose prose-lg prose-slate max-w-none prose-headings:font-display prose-headings:text-slate-900 prose-a:text-kawn-base">

                    <!-- SECCI√ìN 1 -->
                    <section id="intro" class="scroll-mt-28 mb-20">
                        <h2>Introducci√≥n: Comprendiendo el motor</h2>
                        <p>Imagina que el mercado financiero es como un oc√©ano vasto. En la superficie vemos las olas: esos movimientos de precio que suben y bajan. Pero lo que realmente mueve esas olas, la corriente profunda, es la <span class="highlight-text">liquidez</span>. Este concepto es la piedra angular de toda la metodolog√≠a ICT.</p>
                        
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-kawn-base my-8">
                            <h4 class="text-kawn-dark font-bold mt-0 mb-2"><i class="fas fa-bolt mr-2"></i>La frustraci√≥n com√∫n</h4>
                            <p class="mb-0 text-sm">Colocas una compra en un soporte "perfecto". El precio lo rompe apenas, activa tu stop loss, y luego se dispara en tu direcci√≥n. ¬øTe suena? No es mala suerte. Es el mecanismo de la liquidez funcionando.</p>
                        </div>
                    </section>

                    <!-- SECCI√ìN 2 -->
                    <section id="que-es-liquidez" class="scroll-mt-28 mb-20">
                        <h2>¬øQu√© es la liquidez institucional?</h2>
                        <p>En ICT, <strong>liquidez</strong> se refiere a las <strong>√≥rdenes pendientes</strong> (buy/sell stops) esperando en niveles clave. Es el "combustible" de las instituciones.</p>
                        
                        <blockquote class="italic border-l-4 border-slate-300 pl-4 py-2 text-slate-600 bg-slate-50 rounded-r-lg">
                            "Cuando un banco necesita comprar masivamente, no puede usar una orden de mercado sin arruinar su precio. Necesita encontrar a alguien que venda. Necesita liquidez."
                        </blockquote>

                        <!-- INTERACCI√ìN 1: CHART.JS PRECIO VS VOLUMEN -->
                        <div class="my-10 p-6 bg-white rounded-xl shadow-lg ring-1 ring-slate-200">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-kawn-dark m-0">Visualizador: Precio vs. liquidez</h3>
                                <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">Concepto clave</span>
                            </div>
                            <p class="text-sm text-slate-500 mb-4">Este gr√°fico muestra c√≥mo el <strong>volumen</strong> (barras) aumenta dr√°sticamente cuando el precio toca los "pools" de liquidez (l√≠neas punteadas).</p>
                            <div class="relative h-80 w-full bg-white rounded border border-slate-100 p-2">
                                <canvas id="liquidityChart"></canvas>
                            </div>
                            <div class="mt-4 flex gap-4 text-xs font-semibold text-slate-600 justify-center">
                                <div class="flex items-center"><span class="w-3 h-3 bg-kawn-base rounded-full mr-2 shadow-sm"></span>Precio</div>
                                <div class="flex items-center"><span class="w-3 h-1 border-t-2 border-dashed border-red-500 mr-2"></span>Buy-side</div>
                                <div class="flex items-center"><span class="w-3 h-1 border-t-2 border-dashed border-green-500 mr-2"></span>Sell-side</div>
                            </div>
                        </div>

                        <h3>Buy-side vs. Sell-side</h3>
                        <div class="grid md:grid-cols-2 gap-6 my-6">
                            <div class="bg-red-50 p-5 rounded-lg border border-red-100">
                                <h4 class="text-red-800 font-bold mt-0">Buy-side liquidity (BSL)</h4>
                                <ul class="text-sm list-disc pl-5 text-red-700">
                                    <li>Situada <strong>encima</strong> de m√°ximos.</li>
                                    <li>Contiene <strong>buy stops</strong> (stops de vendedores).</li>
                                    <li>Objetivo para vender posiciones largas.</li>
                                </ul>
                            </div>
                            <div class="bg-green-50 p-5 rounded-lg border border-green-100">
                                <h4 class="text-green-800 font-bold mt-0">Sell-side liquidity (SSL)</h4>
                                <ul class="text-sm list-disc pl-5 text-green-700">
                                    <li>Situada <strong>debajo</strong> de m√≠nimos.</li>
                                    <li>Contiene <strong>sell stops</strong> (stops de compradores).</li>
                                    <li>Objetivo para acumular compras baratas.</li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <!-- SECCI√ìN 3: LA TRAMPA T√âCNICA -->
                    <section id="trampa-tecnica" class="scroll-mt-28 mb-20">
                        <h2>El an√°lisis t√©cnico tradicional como trampa</h2>
                        <p>Patrones como el "doble techo" son imanes. Si todos ven el mismo soporte en 1.2000 y ponen sus stops debajo, crean un bot√≠n irresistible.</p>

                        <!-- INTERACCI√ìN 2: PLOTLY STOP HUNT -->
                        <div class="my-10 p-1 bg-gradient-to-br from-kawn-light to-white rounded-xl shadow-lg border border-kawn-base/20">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-bold text-kawn-dark m-0">Simulador: La anatom√≠a de un stop hunt</h3>
                                    <button onclick="runSimulation()" id="btnSimulate" class="bg-kawn-base hover:bg-kawn-dark text-white px-4 py-2 rounded-lg font-bold text-sm transition shadow-lg flex items-center gap-2">
                                        <i class="fas fa-play"></i> Simular cacer√≠a
                                    </button>
                                </div>
                                <div id="plotlyChart" class="w-full h-[350px] bg-white rounded-lg border border-slate-100"></div>
                                <div id="simFeedback" class="mt-2 text-sm font-bold text-center h-6 text-red-500"></div>
                            </div>
                        </div>

                        <h3>Jerarqu√≠a de liquidez</h3>
                        <ol class="list-decimal pl-5 space-y-2 marker:text-kawn-base marker:font-bold font-medium">
                            <li><strong>M√°ximos/M√≠nimos mensuales/semanales:</strong> Los imanes m√°s fuertes.</li>
                            <li><strong>M√°ximos/M√≠nimos diarios:</strong> Objetivos clave de la sesi√≥n.</li>
                            <li><strong>Equal highs/lows (EQH/EQL):</strong> La "fruta madura". Zonas de doble techo/suelo.</li>
                        </ol>
                    </section>

                    <!-- AI FEATURE: ANALIZADOR ESCENARIOS -->
                    <section id="ai-scenario" class="my-16 bg-gradient-to-br from-slate-50 to-indigo-50 rounded-2xl p-8 border border-indigo-100 shadow-xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fas fa-brain text-9xl text-indigo-500"></i></div>
                        <h2 class="text-indigo-900 mt-0"><i class="fas fa-microscope mr-2 text-indigo-600"></i>Analizador de escenarios IA</h2>
                        <p class="text-sm text-slate-600">Describe una configuraci√≥n de mercado (ej: "Doble techo en EURUSD M15 cerca del m√°ximo de ayer"). La IA analizar√° la liquidez.</p>
                        
                        <textarea id="scenarioInput" rows="3" class="w-full p-4 rounded-xl border border-indigo-200 focus:ring-2 focus:ring-indigo-500 shadow-inner bg-white text-sm" placeholder="Ej: El precio ha rebotado 3 veces en 1.0950, dejando mechas largas..."></textarea>
                        <div class="flex justify-end mt-3">
                            <button onclick="analyzeScenario()" id="btnAnalyze" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold shadow-lg transition flex items-center gap-2">
                                <span>‚ú® Analizar</span>
                            </button>
                        </div>
                        <div id="scenarioResult" class="hidden mt-6 bg-white rounded-xl p-6 border-l-4 border-indigo-500 shadow-sm animate-fade-in text-sm text-slate-700 markdown-body"></div>
                    </section>

                    <!-- SECCI√ìN: EL FACTOR TIEMPO -->
                    <section id="factor-tiempo" class="scroll-mt-28 mb-20">
                        <h2>El factor tiempo: Kill Zones</h2>
                        <p>La liquidez no es solo un "d√≥nde", tambi√©n es un "cu√°ndo". Los algoritmos institucionales se activan en horarios espec√≠ficos del d√≠a para inyectar volumen y manipular el precio.</p>
                        
                        <div class="grid md:grid-cols-3 gap-4 my-6">
                            <div class="bg-white p-5 rounded-lg border-t-4 border-slate-400 shadow-sm">
                                <h4 class="font-bold text-slate-700">Asian Range</h4>
                                <span class="text-xs text-slate-500 block mb-2">20:00 - 00:00 NY</span>
                                <p class="text-sm">Acumulaci√≥n. Rango estrecho que crea liquidez por encima y por debajo para ser barrida m√°s tarde.</p>
                            </div>
                            <div class="bg-white p-5 rounded-lg border-t-4 border-indigo-500 shadow-sm">
                                <h4 class="font-bold text-indigo-700">London Killzone</h4>
                                <span class="text-xs text-indigo-400 block mb-2">02:00 - 05:00 NY</span>
                                <p class="text-sm">La manipulaci√≥n. Suele crear el m√≠nimo o m√°ximo del d√≠a (Judas Swing) al barrer el rango asi√°tico.</p>
                            </div>
                            <div class="bg-white p-5 rounded-lg border-t-4 border-kawn-base shadow-sm">
                                <h4 class="font-bold text-kawn-deep">NY Killzone</h4>
                                <span class="text-xs text-kawn-base block mb-2">07:00 - 10:00 NY</span>
                                <p class="text-sm">La expansi√≥n o reversi√≥n. Continuaci√≥n de Londres o giro completo al tomar liquidez matutina.</p>
                            </div>
                        </div>
                    </section>
                    
                    <!-- NEW: GENERADOR DE NARRATIVA DIARIA -->
                    <section id="daily-bias" class="mb-20 scroll-mt-28 bg-white rounded-xl p-8 shadow-lg border border-slate-200">
                        <h2 class="text-2xl font-bold text-slate-900 mb-4 flex items-center"><i class="fas fa-compass text-kawn-base mr-3"></i> Generador de Narrativa Diaria</h2>
                        <p class="text-slate-600 mb-6 text-sm">Introduce el contexto actual del mercado y la IA generar√° una proyecci√≥n de liquidez para la sesi√≥n.</p>
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <input type="text" id="biasContext" class="p-3 border rounded text-sm w-full focus:ring-2 focus:ring-kawn-base focus:outline-none" placeholder="Ej: Rango asi√°tico roto al alza, Londres bajista...">
                            <button onclick="generateDailyBias()" id="btnBias" class="bg-slate-800 text-white px-4 rounded text-sm hover:bg-slate-700 font-bold transition-all shadow">‚ú® Generar Plan</button>
                        </div>
                        <div id="biasOutput" class="hidden p-4 bg-slate-50 rounded border border-slate-100 text-sm text-slate-700 markdown-body"></div>
                    </section>

                    <!-- SECCI√ìN: INTERNA VS EXTERNA -->
                    <section id="dinamica-rangos" class="scroll-mt-28 mb-20">
                        <h2>Din√°mica de rangos: Interna vs. Externa</h2>
                        <p>El mercado respira en un ciclo infinito de dos fases. Entender en qu√© fase est√°s es vital para no operar a contratendencia.</p>
                        
                        <div class="flex flex-col gap-4 my-6">
                            <div class="flex items-center p-4 bg-slate-50 rounded-lg border border-slate-200">
                                <div class="bg-kawn-base text-white p-2 rounded-full mr-4 text-xs font-bold">1</div>
                                <div>
                                    <h4 class="font-bold text-slate-800 m-0">Liquidez externa (ERL)</h4>
                                    <p class="text-sm text-slate-600 m-0">M√°ximos y m√≠nimos viejos. El precio va aqu√≠ para <strong>expandirse</strong>.</p>
                                </div>
                            </div>
                            <div class="flex justify-center"><i class="fas fa-arrow-down text-slate-300"></i></div>
                            <div class="flex items-center p-4 bg-indigo-50 rounded-lg border border-indigo-100">
                                <div class="bg-indigo-500 text-white p-2 rounded-full mr-4 text-xs font-bold">2</div>
                                <div>
                                    <h4 class="font-bold text-indigo-900 m-0">Liquidez interna (IRL)</h4>
                                    <p class="text-sm text-slate-600 m-0">Fair Value Gaps (FVG) dentro del rango actual. El precio vuelve aqu√≠ para <strong>rebalancear</strong>.</p>
                                </div>
                            </div>
                        </div>
                        <p class="text-sm italic text-center text-slate-500">Regla: Si toma liquidez externa, buscar√° interna. Si rebalancea interna, buscar√° externa.</p>
                    </section>

                    <!-- SECCI√ìN 4: REBALANCEO -->
                    <section id="principio-rebalanceo" class="scroll-mt-28 mb-20">
                        <h2>El principio fundamental</h2>
                        <div class="flex flex-col md:flex-row gap-4 my-6">
                            <div class="flex-1 bg-white p-6 rounded-xl shadow-sm border-t-4 border-blue-500">
                                <h4 class="text-blue-900 mt-0">1. Rebalancear ineficiencias</h4>
                                <p class="text-sm m-0">Rellenar "fair value gaps" dejados por movimientos r√°pidos.</p>
                            </div>
                            <div class="flex-1 bg-white p-6 rounded-xl shadow-sm border-t-4 border-kawn-base">
                                <h4 class="text-kawn-deep mt-0">2. Buscar liquidez</h4>
                                <p class="text-sm m-0">Ir a cazar stops por encima/debajo de niveles para obtener combustible.</p>
                            </div>
                        </div>
                    </section>

                    <!-- INFOGRAF√çA INTERACTIVA (SVG + IA) -->
                    <section id="infografia-viva" class="scroll-mt-28 mb-20">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="bg-indigo-600 text-white p-3 rounded-full"><i class="fas fa-project-diagram text-xl"></i></div>
                            <div>
                                <h2 class="mt-0 mb-1 text-2xl text-indigo-900">Infograf√≠a viva: Anatom√≠a de una trampa</h2>
                                <p class="text-sm text-slate-500 m-0">Haz clic en los elementos del gr√°fico para que la IA explique la psicolog√≠a oculta.</p>
                            </div>
                        </div>

                        <div class="bg-slate-900 rounded-xl p-8 relative overflow-hidden shadow-2xl border border-slate-700">
                            <div class="flex flex-col md:flex-row gap-8">
                                <div class="w-full md:w-2/3 relative z-10">
                                    <svg viewBox="0 0 400 200" class="w-full h-auto svg-interactive" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M 20 150 L 50 100 L 80 120 L 120 50 L 160 80 L 200 50 L 220 90 L 250 30 L 280 160 L 320 140 L 380 180" fill="none" stroke="#64748b" stroke-width="2" opacity="0.5" />
                                        <path d="M 120 50 L 160 80 L 200 50" fill="none" stroke="#14b8a6" stroke-width="3" />
                                        <path d="M 200 50 L 220 90 L 250 30" fill="none" stroke="#ef4444" stroke-width="3" />
                                        
                                        <!-- Hotspots -->
                                        <g class="hover-trigger" onclick="handleInfographicClick('equal_highs')">
                                            <circle cx="120" cy="50" r="8" fill="#14b8a6" fill-opacity="0.3" stroke="#14b8a6" stroke-width="1" class="svg-pulse" />
                                            <circle cx="200" cy="50" r="8" fill="#14b8a6" fill-opacity="0.3" stroke="#14b8a6" stroke-width="1" class="svg-pulse" />
                                            <text x="160" y="40" text-anchor="middle" fill="#14b8a6" font-size="10" font-weight="bold">Equal highs (Trampa)</text>
                                        </g>
                                        <g class="hover-trigger" onclick="handleInfographicClick('liquidity_pool')">
                                            <rect x="100" y="10" width="120" height="30" fill="rgba(239, 68, 68, 0.1)" stroke="#ef4444" stroke-dasharray="4" />
                                            <text x="160" y="28" text-anchor="middle" fill="#ef4444" font-size="10">$$Buy-side liquidity$$</text>
                                        </g>
                                        <g class="hover-trigger" onclick="handleInfographicClick('the_sweep')">
                                            <circle cx="250" cy="30" r="10" fill="rgba(255, 255, 255, 0.1)" stroke="white" stroke-width="2" />
                                            <text x="280" y="30" fill="white" font-size="10" font-weight="bold">‚Üê Barrida (Sweep)</text>
                                        </g>
                                    </svg>
                                </div>
                                <div class="w-full md:w-1/3 bg-slate-800/80 backdrop-blur rounded-lg p-4 border border-slate-600 flex flex-col">
                                    <h4 class="text-white font-bold mb-2 text-sm"><i class="fas fa-brain text-kawn-base mr-2"></i> An√°lisis institucional</h4>
                                    <div id="infographic-output" class="text-slate-300 text-sm flex-grow overflow-y-auto max-h-[200px] text-xs">
                                        <p class="italic opacity-70">Haz clic en un elemento (C√≠rculos, Caja, Barrida) para revelar la verdad.</p>
                                    </div>
                                    <div id="infographic-loading" class="hidden mt-2 text-kawn-base text-xs animate-pulse">Consultando a Gemini...</div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- ORDER BOOK SIMULATOR -->
                    <section id="orderbook-sim" class="scroll-mt-28 mb-20">
                        <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                            <h3 class="mt-0 text-slate-800">Esc√°ner de profundidad</h3>
                            <div class="flex flex-col md:flex-row gap-8">
                                <div class="w-full md:w-1/3 space-y-4">
                                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                        <label class="block text-xs font-bold text-slate-700 mb-2">Buy stops (Resistencia)</label>
                                        <input type="range" id="buyStopsRange" min="10" max="100" value="20" class="w-full h-2 bg-red-200 rounded-lg appearance-none cursor-pointer accent-red-500">
                                        <label class="block text-xs font-bold text-slate-700 mt-4 mb-2">Sell stops (Soporte)</label>
                                        <input type="range" id="sellStopsRange" min="10" max="100" value="20" class="w-full h-2 bg-green-200 rounded-lg appearance-none cursor-pointer accent-green-500">
                                    </div>
                                    <button onclick="analyzeOrderBook()" id="btnAnalyzeOB" class="w-full bg-slate-900 text-white py-3 rounded-lg font-bold hover:bg-slate-700 transition shadow-lg flex justify-center items-center gap-2 text-sm">
                                        <span>‚ö° Analizar flujo</span>
                                    </button>
                                </div>
                                <div class="w-full md:w-2/3 h-56 relative">
                                    <canvas id="orderBookChart"></canvas>
                                </div>
                            </div>
                            <div id="ob-result" class="hidden mt-6 bg-indigo-50 border border-indigo-100 rounded-lg p-4 animate-fade-in text-sm text-slate-700"></div>
                        </div>
                    </section>

                    <!-- SECCI√ìN 5: INTEGRACI√ìN Y MENTALIDAD -->
                    <section id="integracion" class="scroll-mt-28 mb-20">
                        <h2>Integrando la liquidez en tu trading</h2>
                        <ul class="space-y-4 mb-8">
                            <li class="flex items-start">
                                <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-kawn-light text-kawn-dark font-bold mr-3">1</span>
                                <div class="text-sm"><strong>Mapa diario:</strong> Marca m√°ximos/m√≠nimos previos. Ah√≠ est√° el dinero.</div>
                            </li>
                            <li class="flex items-start">
                                <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-kawn-light text-kawn-dark font-bold mr-3">2</span>
                                <div class="text-sm"><strong>Evita stops obvios:</strong> Nunca pegues tu stop a un soporte evidente.</div>
                            </li>
                            <li class="flex items-start">
                                <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-kawn-light text-kawn-dark font-bold mr-3">3</span>
                                <div class="text-sm"><strong>Espera el sweep:</strong> No compres el soporte. Espera la barrida y la recuperaci√≥n.</div>
                            </li>
                        </ul>

                        <!-- INTERACCI√ìN 3: MINDSET COMPARATOR -->
                        <div class="bg-slate-900 text-white rounded-xl p-8 shadow-2xl my-10 relative overflow-hidden">
                            <h3 class="text-white mt-0 mb-6 text-center">Cambio de paradigma</h3>
                            <div class="flex justify-center mb-8 gap-2">
                                <button onclick="setMindset('retail')" id="btnRetail" class="px-6 py-2 rounded-full text-sm font-bold transition bg-white text-slate-900">Visi√≥n retail</button>
                                <button onclick="setMindset('smart')" id="btnSmart" class="px-6 py-2 rounded-full text-sm font-bold transition text-slate-400 hover:text-white">Visi√≥n smart money</button>
                            </div>
                            <div id="mindsetContainer" class="grid md:grid-cols-2 gap-8 items-center transition-all duration-500">
                                <!-- JS llenar√° esto -->
                            </div>
                        </div>
                    </section>

                    <!-- NEW: ROAST MY TRADE -->
                    <section id="roast-trade" class="mb-20 scroll-mt-28 bg-gradient-to-br from-red-900 to-red-950 text-red-50 rounded-xl p-8 relative overflow-hidden shadow-2xl border border-red-800">
                        <!-- decoration -->
                        <div class="absolute top-0 right-0 p-6 opacity-10"><i class="fas fa-fire text-9xl"></i></div>
                        
                        <h2 class="text-2xl font-bold text-white mb-4 flex items-center relative z-10"><i class="fas fa-skull-crossbones mr-3"></i> El Cr√≠tico Institucional</h2>
                        <p class="text-red-200 mb-6 relative z-10 text-sm">¬øTuviste un mal trade? Cu√©ntaselo al Algoritmo. Recibe una cr√≠tica despiadada pero educativa sobre por qu√© fuiste la liquidez.</p>
                        
                        <textarea id="roastInput" rows="3" class="w-full p-4 rounded-lg bg-black/40 border border-red-700 text-white placeholder-red-400 focus:outline-none focus:border-red-500 text-sm backdrop-blur-sm" placeholder="Ej: Compr√© en el soporte de 1.0900 porque el RSI estaba sobrevendido, pero el precio sigui√≥ bajando..."></textarea>
                        
                        <button onclick="roastMyTrade()" id="btnRoast" class="mt-4 bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg flex items-center gap-2 text-sm transform hover:scale-105">
                            <i class="fas fa-biohazard"></i> üî• Destruye mi L√≥gica
                        </button>
                        
                        <div id="roastOutput" class="hidden mt-6 p-4 bg-black/30 rounded-lg text-sm border-l-4 border-red-500 italic text-red-100 markdown-body"></div>
                    </section>

                    <!-- SECCI√ìN DE EJERCICIOS AI -->
                    <section id="laboratorio" class="scroll-mt-28 mb-16 bg-slate-50 border border-slate-200 rounded-2xl p-8">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="bg-kawn-base text-white p-3 rounded-full"><i class="fas fa-flask text-xl"></i></div>
                            <div>
                                <h2 class="mt-0 mb-1 text-2xl">Laboratorio de liquidez</h2>
                                <p class="text-sm text-slate-500 m-0">Ejercicios corregidos por inteligencia artificial.</p>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6">
                            <h3 class="text-kawn-dark mt-0 text-lg">Ejercicio: El detective de stops</h3>
                            <p class="text-sm text-slate-600 mb-4">Describe una zona en un gr√°fico real donde creas que hay liquidez acumulada.</p>
                            <textarea id="ex1-input" rows="2" class="w-full p-3 rounded-lg border border-slate-300 text-sm" placeholder="Ej: Tres m√°ximos iguales en 1.2000..."></textarea>
                            <button onclick="runExercise1()" id="btnEx1" class="mt-3 bg-slate-800 text-white px-5 py-2 rounded-lg text-xs font-bold hover:bg-slate-700 transition float-right">Evaluar</button>
                            <div id="ex1-result" class="hidden mt-12 p-4 bg-kawn-light/30 border-l-4 border-kawn-base rounded text-sm text-slate-700 markdown-body clear-both"></div>
                        </div>
                    </section>

                    <!-- CHECKLIST INTERACTIVO -->
                    <section id="checklist-tool" class="mb-20 scroll-mt-28">
                        <div class="bg-gradient-to-br from-white to-slate-50 rounded-xl p-8 shadow-lg border border-slate-200">
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                        <i class="fas fa-tasks text-kawn-base"></i> Checklist de Confirmaci√≥n
                                    </h3>
                                    <p class="text-sm text-slate-500">Usa esta herramienta antes de entrar al mercado.</p>
                                </div>
                                <button onclick="resetChecklist()" class="text-xs text-indigo-600 hover:underline">Resetear</button>
                            </div>
                            
                            <div class="space-y-3">
                                <label class="flex items-center p-3 bg-white rounded-lg border border-slate-200 cursor-pointer hover:border-kawn-base transition-colors">
                                    <input type="checkbox" id="check1" class="trade-check w-5 h-5 text-kawn-base rounded focus:ring-kawn-base" onchange="updateChecklistStatus()">
                                    <span class="ml-3 text-sm text-slate-700">1. ¬øHe identificado el Pool de Liquidez (BSL/SSL) objetivo?</span>
                                </label>
                                <label class="flex items-center p-3 bg-white rounded-lg border border-slate-200 cursor-pointer hover:border-kawn-base transition-colors">
                                    <input type="checkbox" id="check2" class="trade-check w-5 h-5 text-kawn-base rounded focus:ring-kawn-base" onchange="updateChecklistStatus()">
                                    <span class="ml-3 text-sm text-slate-700">2. ¬øEstamos en una Kill Zone (Londres/NY)?</span>
                                </label>
                                <label class="flex items-center p-3 bg-white rounded-lg border border-slate-200 cursor-pointer hover:border-kawn-base transition-colors">
                                    <input type="checkbox" id="check3" class="trade-check w-5 h-5 text-kawn-base rounded focus:ring-kawn-base" onchange="updateChecklistStatus()">
                                    <span class="ml-3 text-sm text-slate-700">3. ¬øHubo una barrida (Sweep) clara de un nivel previo?</span>
                                </label>
                                <label class="flex items-center p-3 bg-white rounded-lg border border-slate-200 cursor-pointer hover:border-kawn-base transition-colors">
                                    <input type="checkbox" id="check4" class="trade-check w-5 h-5 text-kawn-base rounded focus:ring-kawn-base" onchange="updateChecklistStatus()">
                                    <span class="ml-3 text-sm text-slate-700">4. ¬øHubo desplazamiento fuerte en direcci√≥n contraria tras la barrida?</span>
                                </label>
                            </div>

                            <div id="checklist-status" class="mt-6 p-4 rounded-lg text-center font-bold text-sm bg-slate-200 text-slate-500 transition-all">
                                Completa la lista para validar el setup.
                            </div>
                        </div>
                    </section>

                    <!-- Traductor de Conceptos -->
                    <section id="traductor" class="mb-20 scroll-mt-28">
                        <div class="bg-gradient-to-r from-slate-900 to-slate-800 rounded-xl p-8 shadow-2xl border border-slate-700 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-6 opacity-20">
                                <i class="fas fa-language text-9xl text-kawn-base"></i>
                            </div>
                            
                            <h2 class="text-2xl font-bold text-white mb-4 flex items-center relative z-10">
                                <i class="fas fa-random text-kawn-base mr-3"></i> Traductor Retail ‚û° Institucional
                            </h2>
                            
                            <p class="text-slate-300 mb-6 relative z-10 max-w-2xl">
                                Escribe un pensamiento o concepto de trading "com√∫n" y la IA lo reescribir√° utilizando la terminolog√≠a y mentalidad del Smart Money. 
                                <br><span class="text-xs text-slate-500 italic">Ejemplo: "El precio rompi√≥ el soporte y baj√≥."</span>
                            </p>

                            <div class="grid md:grid-cols-2 gap-6 relative z-10">
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase">Lenguaje Retail (T√∫)</label>
                                    <textarea id="retailInput" rows="4" class="w-full p-4 rounded-lg bg-slate-800 border border-slate-600 text-white focus:ring-2 focus:ring-kawn-base focus:outline-none placeholder-slate-600 text-sm" placeholder="Escribe aqu√≠... (Ej: ¬°Se form√≥ un doble techo, voy a vender!)"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-bold text-kawn-base mb-2 uppercase">Lenguaje Smart Money (IA)</label>
                                    <div id="smcOutput" class="w-full h-full p-4 rounded-lg bg-slate-900/50 border border-slate-600 text-slate-300 text-sm flex items-center justify-center italic">
                                        La traducci√≥n aparecer√° aqu√≠...
                                    </div>
                                </div>
                            </div>

                            <div class="mt-6 flex justify-center relative z-10">
                                <button onclick="translateToSMC()" id="btnTranslate" class="bg-kawn-base hover:bg-kawn-light hover:text-kawn-deep text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all transform hover:scale-105 flex items-center gap-2">
                                    <i class="fas fa-magic"></i> Traducir Concepto
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- Nueva Secci√≥n: Decodificador de Noticias Institucional -->
                    <section id="news-decoder" class="mb-20 scroll-mt-28">
                        <div class="bg-white rounded-xl p-8 shadow-xl border-l-4 border-slate-800 relative overflow-hidden">
                            <h2 class="text-2xl font-bold text-slate-900 mb-4 flex items-center">
                                <i class="fas fa-newspaper text-kawn-dark mr-3"></i> Decodificador de Noticias Institucional
                            </h2>
                            <p class="text-slate-600 mb-6 text-sm">
                                Las noticias suelen ser el catalizador que el Smart Money utiliza para buscar liquidez. Introduce un titular financiero y la IA analizar√° la reacci√≥n de la masa vs. la intenci√≥n institucional.
                            </p>

                            <div class="relative mb-6">
                                <input type="text" id="newsInput" class="w-full p-4 pl-12 rounded-lg border border-slate-300 bg-slate-50 focus:ring-2 focus:ring-kawn-base outline-none text-sm font-medium text-slate-800" placeholder="Ej: 'IPC de EE.UU. sube m√°s de lo esperado, mercados caen'">
                                <i class="fas fa-rss absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                                <button onclick="decodeNews()" id="btnDecodeNews" class="absolute right-2 top-2 bottom-2 bg-slate-800 hover:bg-slate-700 text-white px-4 rounded-md text-xs font-bold transition-all">
                                    Decodificar
                                </button>
                            </div>

                            <div id="newsOutput" class="hidden grid md:grid-cols-2 gap-6 animate-fade-in">
                                <!-- Reacci√≥n Retail -->
                                <div class="bg-red-50 p-5 rounded-lg border border-red-100">
                                    <h4 class="text-red-800 font-bold mb-2 flex items-center"><i class="fas fa-users mr-2"></i> Reacci√≥n Retail (Masa)</h4>
                                    <div id="retailReaction" class="text-sm text-red-700"></div>
                                </div>
                                <!-- Intenci√≥n Institucional -->
                                <div class="bg-green-50 p-5 rounded-lg border border-green-100">
                                    <h4 class="text-green-800 font-bold mb-2 flex items-center"><i class="fas fa-chess-king mr-2"></i> Intenci√≥n Institucional (Smart Money)</h4>
                                    <div id="institutionalIntent" class="text-sm text-green-700"></div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- NUEVA SECCI√ìN: RECURSOS Y S√çNTESIS TE√ìRICA -->
                    <section id="recursos" class="scroll-mt-28 mb-20 border-t border-slate-200 pt-16">
                        <div class="flex items-center gap-3 mb-8">
                            <div class="bg-kawn-dark text-white p-3 rounded-full"><i class="fas fa-book-open text-xl"></i></div>
                            <div>
                                <h2 class="mt-0 mb-1 text-2xl text-slate-900">Recursos y S√≠ntesis Te√≥rica</h2>
                                <p class="text-sm text-slate-500 m-0">Resumen clave del cap√≠tulo para repaso r√°pido.</p>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6">
                            <!-- Card 1 -->
                            <div class="resource-card border-l-4 border-l-kawn-base">
                                <h4 class="text-kawn-dark font-bold mt-0 mb-2">1. Definici√≥n de Liquidez</h4>
                                <p class="text-sm text-slate-600 mb-0">No es solo "facilidad de venta". En trading institucional, son las <strong>√≥rdenes pendientes</strong> (stops) esperando ser ejecutadas. Es el combustible que necesitan los grandes para entrar al mercado sin deslizamiento.</p>
                            </div>

                            <!-- Card 2 -->
                            <div class="resource-card border-l-4 border-l-red-500">
                                <h4 class="text-red-700 font-bold mt-0 mb-2">2. Buy-Side vs Sell-Side</h4>
                                <p class="text-sm text-slate-600 mb-0"><strong>BSL (Arriba):</strong> Stops de vendedores. Las instituciones la usan para vender sus largos. <br><strong>SSL (Abajo):</strong> Stops de compradores. Las instituciones la usan para comprar barato.</p>
                            </div>

                            <!-- Card 3 -->
                            <div class="resource-card border-l-4 border-l-indigo-500">
                                <h4 class="text-indigo-800 font-bold mt-0 mb-2">3. La Paradoja Retail</h4>
                                <p class="text-sm text-slate-600 mb-0">"Si no sabes d√≥nde est√° la liquidez, t√∫ eres la liquidez". Tu stop loss es una orden de mercado que alguien m√°s quiere. Los stops se acumulan en niveles obvios.</p>
                            </div>

                            <!-- Card 4 -->
                            <div class="resource-card border-l-4 border-l-yellow-500">
                                <h4 class="text-yellow-700 font-bold mt-0 mb-2">4. La Trampa del Doble Techo</h4>
                                <p class="text-sm text-slate-600 mb-0">Los patrones de libro (Doble suelo/techo) son imanes. Se crean para inducir a las masas a entrar y colocar stops cerca, creando un "pool" de liquidez f√°cil de barrer.</p>
                            </div>

                            <!-- Card 5 -->
                            <div class="resource-card border-l-4 border-l-slate-700">
                                <h4 class="text-slate-800 font-bold mt-0 mb-2">5. Jerarqu√≠a de Niveles</h4>
                                <p class="text-sm text-slate-600 mb-0">El precio busca primero la liquidez de marcos mayores (Mensual > Semanal > Diario). Los m√°ximos/m√≠nimos intradiarios son objetivos menores en el camino.</p>
                            </div>

                            <!-- Card 6 -->
                            <div class="resource-card border-l-4 border-l-green-600">
                                <h4 class="text-green-800 font-bold mt-0 mb-2">6. El Ciclo de Precio</h4>
                                <p class="text-sm text-slate-600 mb-0">El mercado solo hace dos cosas: <strong>Rebalancear</strong> una ineficiencia (FVG) o <strong>Buscar Liquidez</strong> (cazar stops). Si no hace uno, hace lo otro.</p>
                            </div>
                        </div>

                        <!-- AI Deep Dive Button -->
                        <div class="mt-8 bg-slate-900 rounded-xl p-6 shadow-xl border border-slate-700 text-center">
                            <h3 class="text-white text-lg font-bold mb-2"><i class="fas fa-graduation-cap text-kawn-base mr-2"></i> Profundiza en tu aprendizaje</h3>
                            <p class="text-slate-400 text-sm mb-4">¬øQuieres una explicaci√≥n m√°s detallada o una analog√≠a sobre alguno de estos puntos?</p>
                            <button onclick="deepDiveConcept()" id="btnDeepDive" class="bg-white text-slate-900 hover:bg-kawn-light font-bold py-2 px-6 rounded-lg transition-colors shadow-md">
                                ‚ú® Generar Explicaci√≥n Profunda con IA
                            </button>
                            <div id="deepDiveResult" class="hidden mt-4 text-left bg-slate-800/50 p-4 rounded-lg border border-slate-600 text-slate-300 text-sm markdown-body"></div>
                        </div>
                    </section>

                </div>
            </main>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-300 py-12 mt-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <div class="flex justify-center mb-6">
                <div class="kawn-logo-icon scale-75">
                    <div class="arc arc-1"></div>
                    <div class="arc arc-2"></div>
                    <div class="arc arc-3"></div>
                </div>
            </div>
            <p class="text-sm mb-4">¬© <span id="year"></span> KawnBit Quantitative Trading Community.</p>
            <p class="text-xs text-slate-500 max-w-2xl mx-auto">Material educativo. No constituye asesoramiento financiero.</p>
        </div>
    </footer>

    <!-- Bot√≥n Mentor AI -->
    <button onclick="toggleAIModal()" class="fixed bottom-6 right-6 bg-kawn-deep hover:bg-kawn-dark text-white p-4 rounded-full shadow-lg shadow-kawn-base/40 transition-all transform hover:scale-110 z-50 group">
        <i class="fas fa-robot text-xl"></i>
        <span class="absolute right-full mr-3 top-1/2 -translate-y-1/2 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap">Mentor IA ‚ú®</span>
    </button>

    <!-- Modal AI -->
    <div id="aiModal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="toggleAIModal()"></div>
        <div class="absolute bottom-20 right-6 w-96 max-w-[90vw] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-fade-in">
            <div class="bg-kawn-deep p-4 flex justify-between items-center text-white">
                <h4 class="font-bold m-0 text-sm"><i class="fas fa-brain mr-2"></i>KawnBit AI Mentor</h4>
                <button onclick="toggleAIModal()"><i class="fas fa-times"></i></button>
            </div>
            <div id="chatHistory" class="h-64 overflow-y-auto p-4 bg-slate-50 space-y-3 text-sm">
                <div class="bg-white p-3 rounded-lg border border-slate-200 shadow-sm text-slate-700">Hola. Soy tu mentor ICT. Preg√∫ntame sobre liquidez o stop hunts.</div>
            </div>
            <div class="p-4 bg-white border-t border-slate-100">
                <form onsubmit="handleAIChat(event)" class="flex gap-2">
                    <input type="text" id="aiInput" placeholder="Escribe tu duda..." class="flex-1 bg-slate-100 border-0 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-kawn-base outline-none">
                    <button type="submit" id="btnSendChat" class="bg-kawn-base text-white px-3 py-2 rounded-lg hover:bg-kawn-dark transition"><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Quiz -->
    <div id="quizModal" class="fixed inset-0 z-[65] hidden flex items-center justify-center bg-slate-900/80 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg animate-fade-in overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-indigo-600 p-4 flex justify-between items-center text-white">
                <h4 class="font-bold m-0 text-sm"><i class="fas fa-graduation-cap mr-2"></i>Quiz IA</h4>
                <button onclick="closeQuiz()"><i class="fas fa-times"></i></button>
            </div>
            <div id="quizContent" class="p-6 overflow-y-auto min-h-[200px]">
                <div class="flex flex-col items-center justify-center py-10 text-slate-400">
                    <i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-indigo-500"></i>
                    <p>Generando preguntas...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS L√ìGICOS -->
    <script>
        // CONFIGURACI√ìN API (Netlify Proxy - Producci√≥n)
        const gasEndpoint = "/.netlify/functions/gemini-proxy";
        document.getElementById('year').textContent = new Date().getFullYear();

        // UTILS
        const parseMarkdown = (text) => typeof marked !== 'undefined' ? marked.parse(text) : text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            if (menu) menu.classList.toggle('hidden');
        }

        // --- MANEJO ROBUSTO DE LOCALSTORAGE ---
        const safeStorage = {
            setItem: (key, value) => {
                try { localStorage.setItem(key, value); } catch (e) { console.warn("LocalStorage no disponible"); }
            },
            getItem: (key) => {
                try { return localStorage.getItem(key); } catch (e) { return null; }
            }
        };

        // --- PARSER JSON TOLERANTE A FALLOS ---
        function extractAndParseJSON(text) {
            try {
                // Intento 1: Parse directo
                return JSON.parse(text);
            } catch (e) {
                // Intento 2: Limpieza de Markdown
                let clean = text.replace(/^```json\s*/, '').replace(/^```\s*/, '').replace(/\s*```$/, '');
                try { return JSON.parse(clean); } catch (e2) {}

                // Intento 3: Extracci√≥n por corchetes (Arrays)
                const firstBracket = clean.indexOf('[');
                const lastBracket = clean.lastIndexOf(']');
                if (firstBracket !== -1 && lastBracket !== -1) {
                    try { return JSON.parse(clean.substring(firstBracket, lastBracket + 1)); } catch (e3) {}
                }

                // Intento 4: Extracci√≥n por llaves (Objetos)
                const firstBrace = clean.indexOf('{');
                const lastBrace = clean.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace !== -1) {
                    try { return JSON.parse(clean.substring(firstBrace, lastBrace + 1)); } catch (e4) {}
                }
                
                throw new Error("Formato JSON inv√°lido");
            }
        }

        // --- LLAMADA API ---
        async function callGemini(prompt, systemInstruction = "") {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); 

            const body = {
                prompt: prompt,
                systemInstruction: systemInstruction
            };

            const delays = [1000, 2000];
            for (let i = 0; i <= delays.length; i++) {
                try {
                    const response = await fetch(gasEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        // Error espec√≠fico para el entorno de preview donde no existe el proxy
                        if (response.status === 404) throw new Error("PROXY_404"); 
                        throw new Error(`HTTP_${response.status}`);
                    }

                    const data = await response.json();
                    return data.text || JSON.stringify(data);

                } catch (error) {
                    if (error.message === "PROXY_404") throw error; // No reintentar 404
                    if (error.name === 'AbortError') throw new Error("TIMEOUT");
                    if (i === delays.length) throw error; 
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }

        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', () => {
            // TOC
            const tocContainer = document.getElementById('toc');
            const headings = document.querySelectorAll('main h2, main h3');
            headings.forEach((heading, index) => {
                const id = heading.id || `h-${index}`;
                heading.id = id;
                const link = document.createElement('a');
                link.href = `#${id}`;
                link.textContent = heading.innerText;
                const isH3 = heading.tagName === 'H3';
                link.className = `toc-link block py-1 pl-4 text-sm hover:text-kawn-base transition-colors border-l-2 border-transparent ${isH3 ? 'ml-4 text-slate-400 font-normal text-xs' : 'text-slate-600 font-bold mt-2'}`;
                link.dataset.target = id;
                tocContainer.appendChild(link);
            });

            // Observer
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        document.querySelectorAll('.toc-link').forEach(l => l.classList.remove('active'));
                        const activeLink = document.querySelector(`.toc-link[data-target="${entry.target.id}"]`);
                        if(activeLink) activeLink.classList.add('active');
                    }
                });
            }, { rootMargin: '-20% 0px -60% 0px' });
            headings.forEach(h => observer.observe(h));

            // Scroll Bar
            window.addEventListener('scroll', () => {
                const scrolled = (document.documentElement.scrollTop / (document.documentElement.scrollHeight - document.documentElement.clientHeight)) * 100;
                document.getElementById("progressBar").style.width = scrolled + "%";
            });

            // Checklist
            loadChecklistState();

            // Gr√°ficos
            if (typeof Chart !== 'undefined') {
                initLiquidityChart();
                initOrderBookChart();
            }
            if (typeof Plotly !== 'undefined') {
                initPlotlySim();
            }
            
            setMindset('retail');

            // Listeners
            const buyRange = document.getElementById('buyStopsRange');
            if(buyRange) buyRange.addEventListener('input', updateOrderBook);
            
            const sellRange = document.getElementById('sellStopsRange');
            if(sellRange) sellRange.addEventListener('input', updateOrderBook);
        });

        // --- GR√ÅFICOS ---
        
        let liquidityChartInstance = null;
        function initLiquidityChart() {
            const ctxElem = document.getElementById('liquidityChart');
            if (!ctxElem) return;
            const ctx = ctxElem.getContext('2d');

            if(liquidityChartInstance) liquidityChartInstance.destroy(); // Limpieza previa

            const gradientPrice = ctx.createLinearGradient(0, 0, 0, 400);
            gradientPrice.addColorStop(0, 'rgba(20, 184, 166, 0.6)'); 
            gradientPrice.addColorStop(1, 'rgba(20, 184, 166, 0.05)'); 

            liquidityChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['10:00','10:05','10:10','10:15','10:20','10:25','10:30','10:35','10:40','10:45'],
                    datasets: [
                        { label: 'Precio', data: [1.09, 1.091, 1.089, 1.092, 1.094, 1.0948, 1.0955, 1.093, 1.088, 1.086], borderColor: '#14b8a6', backgroundColor: gradientPrice, borderWidth: 3, tension: 0.4, fill: true, pointRadius: 0, order: 1 },
                        { label: 'Buy-Side', data: Array(10).fill(1.0950), borderColor: '#ef4444', borderWidth: 2, borderDash: [6,4], pointRadius: 0, fill: false, order: 2 },
                        { label: 'Sell-Side', data: Array(10).fill(1.0850), borderColor: '#22c55e', borderWidth: 2, borderDash: [6,4], pointRadius: 0, fill: false, order: 3 },
                        { label: 'Volumen', data: [15,20,12,25,40,60,95,50,30,80], type: 'bar', backgroundColor: (c) => c.raw > 50 ? '#64748b' : '#cbd5e1', yAxisID: 'y1', barThickness: 12, borderRadius: 4, order: 4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false }, ticks: { display: false } }, y: { type: 'linear', display: true, position: 'left', min: 1.084, max: 1.097, border: { display: false } }, y1: { type: 'linear', display: false, min: 0, max: 300 } }
                }
            });
        }

        function initPlotlySim() {
            const container = document.getElementById('plotlyChart');
            if (!container) return;

            const trace = { x: [1, 2, 3, 4, 5], close: [1.087, 1.086, 1.0855, 1.0865, 1.086], decreasing: {line: {color: '#ef4444'}}, high: [1.088, 1.087, 1.0865, 1.0875, 1.087], increasing: {line: {color: '#14b8a6'}}, low: [1.086, 1.0855, 1.085, 1.0855, 1.085], open: [1.0865, 1.087, 1.086, 1.0855, 1.0865], type: 'candlestick' };
            const layout = { font: { family: 'Inter, sans-serif', size: 12, color: '#334155' }, dragmode: false, showlegend: false, xaxis: { showgrid: false, showticklabels: false, range: [0.5, 7.5] }, yaxis: { range: [1.083, 1.09], gridcolor: '#f1f5f9', tickfont: { family: 'Inter, sans-serif', size: 10 } }, margin: {r:10,l:40,t:10,b:20}, shapes: [{ type: 'line', x0: 0.5, y0: 1.085, x1: 5.5, y1: 1.085, line: {color: '#333', width: 2, dash: 'dot'} }] };
            
            window.requestAnimationFrame(() => { Plotly.newPlot('plotlyChart', [trace], layout, {displayModeBar: false}); });
        }

        function runSimulation() {
            const btn = document.getElementById('btnSimulate');
            if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Simulando...'; }
            setTimeout(() => {
                const update = { x: [[1, 2, 3, 4, 5, 6, 7]], open: [[1.0865, 1.087, 1.086, 1.0855, 1.0865, 1.086, 1.087]], high: [[1.088, 1.087, 1.0865, 1.0875, 1.087, 1.0875, 1.092]], low:  [[1.086, 1.0855, 1.085, 1.0855, 1.085, 1.0835, 1.0865]], close:[[1.087, 1.086, 1.0855, 1.0865, 1.086, 1.087, 1.091]] };
                Plotly.update('plotlyChart', update, { annotations: [{ x: 6, y: 1.0835, text: '<b>üí• SWEEP</b>', font: { color: 'red' }, showarrow: true, ax: 0, ay: 40 }] });
                const fb = document.getElementById('simFeedback');
                if(fb) fb.innerHTML = '¬°Stops cazados! Las instituciones compraron barato en 1.0835.';
                if(btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-play"></i> Reiniciar'; }
            }, 1000);
        }

        const mindsetData = { retail: { title: 'Visi√≥n retail (V√≠ctima)', desc: 'Ve niveles s√≥lidos. Siente miedo cuando el precio cae r√°pido.', visual: '<div class="text-4xl">üõë</div>' }, smart: { title: 'Visi√≥n smart money', desc: 'Ve piscinas de dinero. Sabe que el soporte se romper√°.', visual: '<div class="text-4xl">üí∞</div>' } };
        function setMindset(type) {
            const container = document.getElementById('mindsetContainer');
            if(!container) return;
            // Botones visual
            const bR = document.getElementById('btnRetail'); const bS = document.getElementById('btnSmart');
            if(type === 'retail') { bR.className="px-6 py-2 rounded-full text-sm font-bold bg-white text-slate-900 shadow"; bS.className="px-6 py-2 rounded-full text-sm font-bold text-slate-400"; } 
            else { bS.className="px-6 py-2 rounded-full text-sm font-bold bg-kawn-base text-white shadow"; bR.className="px-6 py-2 rounded-full text-sm font-bold text-slate-400"; }
            container.innerHTML = `<div><h4 class="text-2xl font-bold mb-4 ${type==='smart'?'text-kawn-base':'text-red-400'}">${mindsetData[type].title}</h4><p>${mindsetData[type].desc}</p></div><div class="bg-slate-800/50 p-6 rounded-lg flex justify-center items-center h-32 border border-slate-700">${mindsetData[type].visual}</div>`;
        }

        let obChartInstance = null;
        function initOrderBookChart() {
            const ctxElem = document.getElementById('orderBookChart');
            if(!ctxElem) return;
            if(obChartInstance) obChartInstance.destroy();
            obChartInstance = new Chart(ctxElem.getContext('2d'), {
                type: 'bar',
                data: { labels: ['Buy Stops', 'Sell Stops'], datasets: [{ data: [20, 20], backgroundColor: ['#ef4444', '#22c55e'], borderRadius: 5, barThickness: 40 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 120 } } }
            });
        }
        function updateOrderBook() {
            if(obChartInstance) {
                obChartInstance.data.datasets[0].data = [document.getElementById('buyStopsRange').value, document.getElementById('sellStopsRange').value];
                obChartInstance.update();
            }
        }

        function updateChecklistStatus() {
            const checks = document.querySelectorAll('.trade-check');
            const state = Array.from(checks).map(c => c.checked);
            safeStorage.setItem('kawnbit_ch2_checklist', JSON.stringify(state));
            const count = state.filter(Boolean).length;
            const statusBox = document.getElementById('checklist-status');
            if (count === 4) { statusBox.className = "mt-6 p-4 rounded-lg text-center font-bold text-sm bg-green-100 text-green-700"; statusBox.innerHTML = "¬°Setup Confirmado!"; }
            else { statusBox.className = "mt-6 p-4 rounded-lg text-center font-bold text-sm bg-slate-200 text-slate-500"; statusBox.innerHTML = `Progreso: ${count}/4`; }
        }
        function loadChecklistState() {
            const saved = safeStorage.getItem('kawnbit_ch2_checklist');
            if(saved) JSON.parse(saved).forEach((v, i) => { if(v) document.querySelectorAll('.trade-check')[i].checked = true; });
            updateChecklistStatus();
        }
        function resetChecklist() { document.querySelectorAll('.trade-check').forEach(c => c.checked = false); updateChecklistStatus(); }

        // --- MANEJO DE ERRORES DE UI PARA IA ---
        function renderAIError(containerId, isProxyError) {
            const el = document.getElementById(containerId);
            if(!el) return;
            const msg = isProxyError ? "‚ö†Ô∏è Error de conexi√≥n: Backend no detectado (404)." : "‚ö†Ô∏è La IA no respondi√≥ correctamente.";
            const sub = isProxyError ? "Esta funci√≥n requiere el servidor Netlify activo." : "Int√©ntalo de nuevo m√°s tarde.";
            el.innerHTML = `<div class="p-4 bg-red-50 border-l-4 border-red-500 text-red-700 text-sm"><p class="font-bold">${msg}</p><p class="text-xs mt-1">${sub}</p></div>`;
            el.classList.remove('hidden');
        }

        // --- INTERACCIONES IA ---
        async function handleAIChat(e) {
            e.preventDefault();
            const input = document.getElementById('aiInput');
            const history = document.getElementById('chatHistory');
            if(!input.value.trim()) return;
            history.innerHTML += `<div class="bg-kawn-light/30 p-3 rounded-lg border border-kawn-light self-end text-right ml-8 mb-2">${input.value}</div>`;
            input.value = ''; history.scrollTop = history.scrollHeight;
            try {
                const res = await callGemini("Responde brevemente: " + input.value, "Mentor ICT.");
                history.innerHTML += `<div class="bg-white p-3 rounded-lg border border-slate-200 shadow-sm mr-8 mb-2 markdown-body text-slate-700">${parseMarkdown(res)}</div>`;
            } catch(e) { history.innerHTML += `<div class="bg-red-50 p-2 text-red-600 text-xs rounded">Error de conexi√≥n.</div>`; }
            history.scrollTop = history.scrollHeight;
        }

        async function analyzeScenario() {
            const btn = document.getElementById('btnAnalyze');
            btn.disabled = true; btn.innerHTML = '...';
            try {
                const res = await callGemini(document.getElementById('scenarioInput').value, "Analista ICT.");
                document.getElementById('scenarioResult').classList.remove('hidden');
                document.getElementById('scenarioResult').innerHTML = parseMarkdown(res);
            } catch(e) { renderAIError('scenarioResult', e.message === "PROXY_404"); }
            finally { btn.disabled = false; btn.innerHTML = '‚ú® Analizar'; }
        }

        async function analyzeOrderBook() {
            const btn = document.getElementById('btnAnalyzeOB');
            btn.disabled = true; btn.innerHTML = '...';
            try {
                const res = await callGemini("Analiza Order Book.", "Algoritmo HFT.");
                document.getElementById('ob-result').classList.remove('hidden');
                document.getElementById('ob-result').innerHTML = parseMarkdown(res);
            } catch(e) { renderAIError('ob-result', e.message === "PROXY_404"); }
            finally { btn.disabled = false; btn.innerHTML = '‚ö° Analizar'; }
        }

        async function handleInfographicClick(type) {
            const out = document.getElementById('infographic-output');
            const load = document.getElementById('infographic-loading');
            load.classList.remove('hidden');
            try {
                const res = await callGemini(`Explica ${type} en trading.`, "Experto ICT.");
                out.innerHTML = `<strong>${type.toUpperCase()}</strong><br>${parseMarkdown(res)}`;
            } catch(e) { out.innerHTML = '<span class="text-red-500">Error de conexi√≥n.</span>'; }
            finally { load.classList.add('hidden'); }
        }

        async function runExercise1() {
            const btn = document.getElementById('btnEx1');
            btn.disabled = true; btn.innerHTML = '...';
            try {
                const res = await callGemini(document.getElementById('ex1-input').value, "Instructor.");
                document.getElementById('ex1-result').classList.remove('hidden');
                document.getElementById('ex1-result').innerHTML = parseMarkdown(res);
            } catch(e) { renderAIError('ex1-result', e.message === "PROXY_404"); }
            finally { btn.disabled = false; btn.innerHTML = 'Evaluar'; }
        }

        async function roastMyTrade() {
            const btn = document.getElementById('btnRoast');
            btn.disabled = true; btn.innerHTML = '...';
            try {
                const res = await callGemini(document.getElementById('roastInput').value, "Algoritmo sarc√°stico.");
                document.getElementById('roastOutput').classList.remove('hidden');
                document.getElementById('roastOutput').innerHTML = parseMarkdown(res);
            } catch(e) { renderAIError('roastOutput', e.message === "PROXY_404"); }
            finally { btn.disabled = false; btn.innerHTML = 'üî• Destruye mi L√≥gica'; }
        }

        async function generateDailyBias() {
            const btn = document.getElementById('btnBias');
            btn.disabled = true; btn.innerHTML = '...';
            try {
                const res = await callGemini(document.getElementById('biasContext').value, "Estratega ICT.");
                document.getElementById('biasOutput').classList.remove('hidden');
                document.getElementById('biasOutput').innerHTML = parseMarkdown(res);
            } catch(e) { renderAIError('biasOutput', e.message === "PROXY_404"); }
            finally { btn.disabled = false; btn.innerHTML = 'Generar Plan'; }
        }

        async function translateToSMC() {
            const out = document.getElementById('smcOutput');
            const btn = document.getElementById('btnTranslate');
            btn.disabled = true;
            try {
                const res = await callGemini(document.getElementById('retailInput').value, "Traductor a SMC.");
                out.innerHTML = parseMarkdown(res);
            } catch(e) { out.innerHTML = '<span class="text-red-400">Error.</span>'; }
            finally { btn.disabled = false; }
        }

        async function decodeNews() {
            const rOut = document.getElementById('retailReaction');
            const iOut = document.getElementById('institutionalIntent');
            const btn = document.getElementById('btnDecodeNews');
            btn.disabled = true;
            document.getElementById('newsOutput').classList.remove('hidden');
            try {
                const res = await callGemini(`Analiza noticia: "${document.getElementById('newsInput').value}". JSON: {"retail":"...", "institutional":"..."}`, "JSON mode only.");
                const data = extractAndParseJSON(res);
                rOut.innerHTML = data.retail; iOut.innerHTML = data.institutional;
            } catch(e) { 
                rOut.innerHTML = "Error."; iOut.innerHTML = "Error."; 
            } finally { btn.disabled = false; btn.innerHTML = 'Decodificar'; }
        }

        async function deepDiveConcept() {
            const out = document.getElementById('deepDiveResult');
            const btn = document.getElementById('btnDeepDive');
            btn.disabled = true; btn.innerHTML = '...';
            out.classList.remove('hidden');
            try {
                const res = await callGemini("Genera analog√≠a liquidez.", "Instructor.");
                out.innerHTML = parseMarkdown(res);
            } catch(e) { renderAIError('deepDiveResult', e.message === "PROXY_404"); }
            finally { btn.disabled = false; btn.innerHTML = '‚ú® Generar'; }
        }

        async function generateQuiz() {
            const modal = document.getElementById('quizModal');
            const content = document.getElementById('quizContent');
            modal.classList.remove('hidden');
            content.innerHTML = '<div class="text-center py-10"><i class="fas fa-spinner fa-spin"></i> Generando...</div>';
            try {
                const res = await callGemini("Genera 3 preguntas JSON array: [{pregunta, opciones:[], correctaIndex, explicacion}]", "JSON only.");
                const json = extractAndParseJSON(res);
                content.innerHTML = `<div class="space-y-4">${json.map((q,i) => `
                    <div class="bg-slate-50 p-4 rounded">
                        <p class="font-bold">${i+1}. ${q.pregunta}</p>
                        <div class="space-y-2 mt-2">${q.opciones.map((o,x) => `<button onclick="checkQuiz(this, ${x===q.correctaIndex})" class="w-full text-left p-2 bg-white border rounded text-sm">${o}</button>`).join('')}</div>
                        <div class="hidden mt-2 text-xs text-indigo-700 bg-indigo-50 p-2 rounded explanation">${q.explicacion}</div>
                    </div>`).join('')}</div>`;
            } catch(e) { 
                content.innerHTML = `<div class="text-center text-red-500 py-10"><p>Error generando quiz (${e.message === "PROXY_404" ? "Backend no encontrado" : "Error IA"}).</p><button onclick="closeQuiz()" class="underline mt-2">Cerrar</button></div>`; 
            }
        }
        function checkQuiz(btn, isCorrect) {
            btn.classList.add(isCorrect ? 'bg-green-100' : 'bg-red-100', isCorrect ? 'border-green-500' : 'border-red-500');
            btn.parentElement.parentElement.querySelector('.explanation').classList.remove('hidden');
        }
        function closeQuiz() { document.getElementById('quizModal').classList.add('hidden'); }
    </script>
</body>
</html>