<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KawnBit Magazine: Equilibrio, Descuento y Premium (Robusto)</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* KawnBit Palette */
            --primary-teal: #4db6ac;
            --secondary-teal: #00897b;
            --dark-teal: #005b4f;
            --accent-dark: #263238;
            --text-grey: #455a64;
            --light-bg: #f4f7f6;
            --white: #ffffff;
            --danger: #e57373;
            /* Premium/Expensive Color */
            --success: #66bb6a;
            /* Discount/Cheap Color */
            --gradient-teal: linear-gradient(135deg, var(--primary-teal), var(--secondary-teal));
            --gradient-zone: linear-gradient(to bottom, #ffebee 0%, #ffffff 50%, #e8f5e9 100%);
        }

        body {
            font-family: 'Open Sans', sans-serif;
            color: var(--text-grey);
            background-color: var(--light-bg);
            margin: 0;
            padding: 0;
            line-height: 1.7;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Montserrat', sans-serif;
            color: var(--accent-dark);
            font-weight: 700;
        }

        h1 {
            font-size: 2.2rem;
            text-transform: uppercase;
            letter-spacing: -1px;
            color: var(--secondary-teal);
            margin-bottom: 0.5em;
            line-height: 1.2;
        }

        h2 {
            font-size: 1.6rem;
            border-bottom: 3px solid var(--primary-teal);
            padding-bottom: 10px;
            margin-top: 50px;
            color: var(--dark-teal);
        }

        h3 {
            font-size: 1.3rem;
            color: var(--secondary-teal);
            margin-top: 30px;
            margin-bottom: 15px;
        }

        strong {
            color: var(--secondary-teal);
            font-weight: 700;
        }

        p {
            margin-bottom: 1.5em;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--white);
            padding: 50px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        }

        /* Header Section */
        .magazine-header {
            text-align: center;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--light-bg);
            margin-bottom: 40px;
        }

        .logo-placeholder {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 3.5rem;
            background: var(--gradient-teal);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
            margin-bottom: 5px;
        }

        .logo-tagline {
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--secondary-teal);
            font-size: 0.85rem;
            font-weight: 600;
        }

        .chapter-label {
            background: var(--accent-dark);
            color: white;
            padding: 5px 15px;
            text-transform: uppercase;
            font-size: 0.8rem;
            font-weight: 700;
            display: inline-block;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .intro-lead {
            font-size: 1.15rem;
            font-weight: 500;
            color: var(--accent-dark);
            border-left: 5px solid var(--primary-teal);
            padding-left: 25px;
            margin-bottom: 35px;
            font-style: italic;
        }

        /* --- INTERACTIVE COMPONENTS --- */

        .infographic-box {
            background: var(--white);
            border-radius: 12px;
            padding: 30px;
            margin: 40px 0;
            border: 1px solid #e0e0e0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .infographic-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .infographic-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--gradient-teal);
        }

        .infographic-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            color: var(--dark-teal);
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            background: #e0f2f1;
            padding: 8px 20px;
            border-radius: 50px;
            width: fit-content;
        }

        .infographic-title i {
            margin-right: 10px;
            color: var(--secondary-teal);
        }

        /* Interactive Graphic 1: Equilibrium Slider */
        .eq-slider-container {
            position: relative;
            height: 80px;
            background: #eee;
            border-radius: 40px;
            margin: 40px 0;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            padding: 0 10px;
            overflow: hidden;
        }

        .eq-slider-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to right, var(--success) 0%, #f4f7f6 50%, var(--danger) 100%);
            opacity: 0.6;
        }

        .eq-slider-input {
            width: 100%;
            -webkit-appearance: none;
            background: transparent;
            z-index: 10;
            position: relative;
        }

        .eq-slider-input:focus {
            outline: none;
        }

        .eq-slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 40px;
            width: 40px;
            border-radius: 50%;
            background: var(--accent-dark);
            cursor: pointer;
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.5);
            transition: transform 0.1s;
        }

        .eq-slider-input::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .eq-labels {
            display: flex;
            justify-content: space-between;
            margin-top: -30px;
            margin-bottom: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            padding: 0 20px;
            position: relative;
            z-index: 5;
        }

        .eq-status {
            text-align: center;
            font-weight: 800;
            font-size: 1.2rem;
            margin-top: 10px;
            height: 30px;
            transition: color 0.3s;
        }

        /* Interactive Graphic 2: OTE Visualizer */
        .ote-visualizer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .ote-canvas-container {
            width: 100%;
            height: 300px;
            border: 1px solid #ddd;
            border-radius: 8px;
            position: relative;
            background: #fafafa;
        }

        .ote-control-panel {
            display: flex;
            gap: 10px;
            justify-content: center;
            width: 100%;
        }

        .ote-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid var(--secondary-teal);
            color: var(--secondary-teal);
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .ote-btn.active {
            background: var(--secondary-teal);
            color: white;
        }

        /* Interactive Graphic 3: Calculator */
        .calc-panel {
            background: #263238;
            color: white;
            padding: 25px;
            border-radius: 10px;
            display: grid;
            gap: 15px;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .calc-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px;
            border-radius: 4px;
            width: 100%;
        }

        .btn-calc {
            background: var(--secondary-teal);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: background 0.2s;
        }

        .btn-calc:hover {
            background: var(--primary-teal);
        }

        .result-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            min-height: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .calc-bar-container {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
            position: relative;
        }

        .calc-bar-fill {
            height: 100%;
            width: 0%;
            background: var(--success);
            transition: width 0.5s ease, background-color 0.5s ease;
        }

        .calc-marker-50 {
            position: absolute;
            left: 50%;
            top: 0;
            height: 100%;
            width: 2px;
            background: white;
            opacity: 0.5;
        }

        /* Interactive Graphic 4: Elliott Wave SVG */
        .wave-interactive-container {
            width: 100%;
            height: 300px;
            background: white;
            border: 1px dashed #ccc;
            border-radius: 8px;
            position: relative;
            cursor: crosshair;
        }

        .wave-point {
            cursor: pointer;
            transition: r 0.3s, fill 0.3s;
        }

        .wave-point:hover {
            r: 8;
            fill: var(--accent-dark);
        }

        .wave-tooltip {
            position: absolute;
            background: rgba(38, 50, 56, 0.95);
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 200px;
            z-index: 100;
        }

        /* Interactive Graphic 5: Market Regime & Timing */
        .regime-selector {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .regime-btn {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            background: white;
            flex: 1;
            text-align: center;
            font-weight: 600;
            min-width: 120px;
        }

        .regime-btn.active {
            border-color: var(--secondary-teal);
            background: #e0f2f1;
            color: var(--dark-teal);
        }

        .timing-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .time-slot {
            display: flex;
            align-items: center;
            background: #fafafa;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #ccc;
            transition: transform 0.2s;
        }

        .time-slot:hover {
            transform: translateX(5px);
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .time-slot.silver-bullet {
            border-left-color: gold;
        }

        .time-slot.london {
            border-left-color: #3f51b5;
        }

        .time-slot.ny {
            border-left-color: #f44336;
        }

        .time-icon {
            font-size: 1.5rem;
            width: 50px;
            text-align: center;
            margin-right: 15px;
        }

        /* Bullet Points & Lists */
        ul.custom-list {
            list-style: none;
            padding-left: 0;
        }

        ul.custom-list li {
            position: relative;
            padding-left: 30px;
            margin-bottom: 12px;
        }

        ul.custom-list li::before {
            content: '\f058';
            /* FontAwesome check-circle */
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            left: 0;
            color: var(--secondary-teal);
        }

        .quote-block {
            background: #e0f2f1;
            border-left: 4px solid var(--secondary-teal);
            padding: 20px;
            margin: 20px 0;
            font-style: italic;
            color: var(--dark-teal);
            border-radius: 0 8px 8px 0;
        }

        /* AI & Footer Styles */
        .ai-section-wrapper {
            background: #e0f7fa;
            border-radius: 16px;
            padding: 30px;
            margin-top: 60px;
            border: 2px solid var(--primary-teal);
            position: relative;
        }

        .chat-container {
            background: white;
            border-radius: 12px;
            height: 350px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .chat-header {
            background: var(--dark-teal);
            color: white;
            padding: 10px 20px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #fafafa;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
            font-size: 0.9rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: var(--secondary-teal);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 2px;
        }

        .message.ai {
            background: white;
            border: 1px solid #ddd;
            margin-right: auto;
            border-bottom-left-radius: 2px;
        }

        .quiz-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            border: 1px solid #eee;
        }

        .quiz-option {
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .quiz-option:hover {
            background: #f0f0f0;
            transform: scale(1.01);
        }

        .quiz-option.correct {
            background: #c8e6c9;
            border-color: #4caf50;
            color: #1b5e20;
        }

        .quiz-option.incorrect {
            background: #ffcdd2;
            border-color: #ef5350;
            color: #b71c1c;
        }

        .btn-ai {
            background: linear-gradient(135deg, #673ab7, #512da8);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .btn-ai:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.3);
        }

        .btn-ai:disabled {
            background: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .scenario-analyzer {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid #eee;
        }

        .scenario-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 10px;
        }

        .scenario-result {
            margin-top: 15px;
            padding: 15px;
            background: #f3e5f5;
            border-radius: 8px;
            border-left: 4px solid #9c27b0;
            display: none;
            font-size: 0.9rem;
        }

        .main-footer {
            margin-top: 60px;
            padding: 40px 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            background-color: #fcfcfc;
        }

        .config-btn {
            background: transparent;
            border: 1px solid #ddd;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            color: #888;
            cursor: pointer;
            margin-top: 10px;
        }

        .config-btn:hover {
            background: #eee;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8rem;
            }
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60% {
                content: '...';
            }

            80%,
            100% {
                content: '';
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="magazine-header">
            <div class="logo-placeholder">KawnBit</div>
            <div class="logo-tagline">Quantitative Trading Community</div>
        </header>

        <div style="text-align: center;">
            <span class="chapter-label">Capítulo 4</span>
            <h1>Equilibrio, Descuento y Premium</h1>
            <h4 style="color: #666; margin-top: 0;">Los Tres Pilares del Posicionamiento Institucional</h4>
        </div>

        <section>
            <h2>Introducción: La anatomía del movimiento del precio</h2>
            <p class="intro-lead">Imagina por un momento que el mercado es como un péndulo gigante que oscila entre dos
                extremos. En cada oscilación, existe un punto central de equilibrio y dos zonas opuestas donde las
                fuerzas del mercado ejercen su máxima influencia.</p>

            <p>Este capítulo te revelará cómo el <strong>Dinero Inteligente (Smart Money)</strong> utiliza estas zonas
                para posicionarse estratégicamente, y cómo tú, como trader informado, puedes identificar y aprovechar
                esos mismos puntos de entrada que utilizan las instituciones.</p>

            <p>El concepto de <strong>equilibrio, descuento y premium</strong> representa uno de los fundamentos más
                poderosos y a la vez más incomprendidos en la metodología ICT. No se trata simplemente de líneas en un
                gráfico, sino de comprender la psicología institucional y cómo el dinero profesional busca
                constantemente obtener el mejor precio posible para sus operaciones.</p>

            <p>A lo largo de este capítulo descubrirás que estos conceptos no son arbitrarios, sino que reflejan la
                realidad operativa de cómo las grandes instituciones mueven miles de millones de dólares en los mercados
                financieros.</p>
        </section>

        <section>
            <h2>El Equilibrio: el centro gravitacional del precio</h2>

            <h3>Definición y concepto fundamental</h3>
            <p>El <strong>equilibrio</strong> representa el punto medio exacto de cualquier movimiento impulsivo rápido
                en el mercado. Matemáticamente, es el nivel de <strong>50% de retroceso</strong> de un impulso, pero
                conceptualmente es mucho más profundo.</p>

            <div class="infographic-box" style="text-align: center; background: #fafafa;">
                <div class="infographic-title"><i class="fas fa-balance-scale"></i> Simulador de Equilibrio</div>
                <p>Mueve el control deslizante para entender visualmente dónde se encuentra el equilibrio en relación a
                    las zonas de compra y venta. Nota cómo cambia la "temperatura" del precio.</p>

                <div class="eq-slider-container">
                    <div class="eq-slider-bg"></div>
                    <input type="range" min="0" max="100" value="50" class="eq-slider-input" id="equilibriumSlider"
                        oninput="updateEquilibriumVisual(this.value)">
                </div>
                <div class="eq-labels">
                    <span style="color: var(--success)">ZONA DE COMPRA (Barato)</span>
                    <span style="color: var(--danger)">ZONA DE VENTA (Caro)</span>
                </div>
                <div id="eqStatusText" class="eq-status" style="color: var(--text-grey);">50% - EQUILIBRIO PERFECTO
                </div>
            </div>

            <p>Cuando observamos un movimiento impulsivo fuerte, ya sea alcista o bajista, el equilibrio se establece en
                el punto medio entre el inicio y el final de ese impulso. Este nivel no es simplemente una línea
                matemática; representa el <strong>consenso temporal entre compradores y vendedores</strong>, el punto
                donde ambas fuerzas están temporalmente balanceadas antes de que una tome el control nuevamente.</p>

            <h3>Identificación práctica del equilibrio</h3>
            <p>Para identificar correctamente el equilibrio, primero debes localizar un movimiento impulsivo claro. Un
                <strong>movimiento impulsivo</strong> se caracteriza por barras con cuerpos amplios, con poca o ninguna
                mecha en la dirección del impulso, y una velocidad notablemente mayor que el movimiento previo.
            </p>
            <p>Una vez identificado este impulso, el equilibrio se encuentra <strong>exactamente en el punto
                    medio</strong> del recorrido. Puedes calcularlo fácilmente tomando el rango total (en puntos o pips)
                del impulso y dividiéndolo en dos; ese es el nivel 50%.</p>
            <p>Es crucial entender que no todos los movimientos generan un equilibrio relevante. Los movimientos lentos,
                graduales o erráticos no establecen equilibrios significativos para nuestra operativa. Buscamos
                específicamente aquellos impulsos que demuestran <strong>intención institucional clara</strong> (por
                ejemplo, velas de rango amplio seguidas de rompimiento de niveles de liquidez).</p>

            <h3>El equilibrio como zona de decisión</h3>
            <p>El equilibrio funciona como una zona de decisión crítica. Cuando el precio retrocede hacia el equilibrio
                después de un impulso, se encuentra en un momento de verdad: ¿continuará la tendencia original o habrá
                un cambio de dirección?</p>
            <ul class="custom-list">
                <li>Las instituciones observan cuidadosamente cómo reacciona el precio en esta zona.</li>
                <li>Si el precio muestra rechazo fuerte en el equilibrio, puede indicar defensa institucional del nivel.
                </li>
                <li>Atravesar el equilibrio con decisión puede sugerir una búsqueda del lado opuesto del rango.</li>
            </ul>
            <p>Un aspecto fascinante es su naturaleza <strong>fractal</strong>. Existe en todas las temporalidades. Un
                equilibrio en temporalidad diaria puede coincidir con equilibrios en temporalidades menores, creando
                confluencias poderosas.</p>
        </section>

        <section>
            <h2>Zona de Descuento: el paraíso de las compras institucionales</h2>

            <h3>Comprensión profunda del descuento</h3>
            <p>La <strong>zona de descuento</strong> se define como toda el área que se encuentra por debajo del
                equilibrio en un movimiento alcista. Es la mitad inferior del rango de un impulso alcista rápido.</p>
            <p>Pero esta definición técnica apenas rasca la superficie. La zona de descuento representa el
                <strong>territorio donde el Dinero Inteligente busca activamente oportunidades de compra</strong>, donde
                las instituciones pueden acumular posiciones largas a precios que consideran ventajosos.
            </p>

            <div class="quote-block">
                "Piensa en la zona de descuento como una tienda de lujo durante las rebajas. Los compradores
                sofisticados esperan pacientemente a que los precios lleguen a estos niveles antes de realizar sus
                compras masivas."
            </div>

            <h3>Psicología detrás del descuento</h3>
            <p>La razón por la cual las instituciones prefieren comprar en descuento va más allá del simple deseo de
                obtener un mejor precio. Cuando el precio retrocede hacia la zona de descuento después de un impulso
                alcista, típicamente ocurre porque los traders minoristas están vendiendo por miedo. Este es el momento
                que las instituciones aprovechan para <strong>absorber esa liquidez</strong>.</p>
            <p>Además, ofrece una ventaja matemática en <strong>relación riesgo-beneficio</strong>. Al entrar en
                descuento, el stop loss puede colocarse ajustado (bajo el mínimo del impulso), mientras que el objetivo
                potencial ofrece un ratio recompensa/riesgo muy favorable.</p>

            <div class="infographic-box">
                <div class="infographic-title"><i class="fas fa-layer-group"></i> Visualizador OTE (Optimal Trade Entry)
                </div>

                <p style="margin-bottom: 20px;">Interactúa con el gráfico para ver cómo se calculan las zonas OTE en
                    diferentes rangos.</p>

                <div class="ote-control-panel">
                    <button class="ote-btn active" onclick="setOteMode('bullish')">Impulso Alcista (Buscar
                        Compras)</button>
                    <button class="ote-btn" onclick="setOteMode('bearish')">Impulso Bajista (Buscar Ventas)</button>
                </div>

                <div class="ote-canvas-container" id="oteContainer">
                    <!-- SVG injected via JS -->
                </div>

                <div style="margin-top: 15px; font-size: 0.9rem; color: #555; text-align: center;">
                    <i class="fas fa-info-circle"></i> Los niveles 62%, 70.5% y 79% son el "Sweet Spot" institucional.
                </div>
            </div>

            <p>Estos niveles óptimos suelen coincidir con <strong>confluencias adicionales</strong> como un Order Block
                alcista o un Fair Value Gap (FVG) pendiente de rellenar. Cuando varios elementos convergen en la zona de
                descuento óptima, tenemos combustible altamente inflamable para un movimiento explosivo.</p>
        </section>

        <section>
            <h2>Zona Premium: el territorio de las ventas institucionales</h2>

            <h3>Naturaleza y características</h3>
            <p>La <strong>zona premium</strong> comprende toda el área por encima del equilibrio en un contexto bajista.
                Es el espejo inverso de la zona de descuento. En esta zona superior, el Dinero Inteligente busca
                <strong>distribuir sus posiciones cortas</strong> (abrir ventas) o vender tenencias largas a precios
                "caros".
            </p>
            <p>Es donde la <strong>euforia del mercado</strong> suele alcanzar su pico. Los minoristas, impulsados por
                el FOMO, compran pensando que el precio subirá indefinidamente. Las instituciones aprovechan esta
                demanda irracional para descargar sus posiciones.</p>

            <h3>Mecánica operativa del premium</h3>
            <p>Cuando el precio entra en premium durante un retroceso en una tendencia bajista, las instituciones ven
                una <strong>oportunidad dorada</strong>. Saben que están vendiendo a compradores emocionales que entran
                tarde, proporcionándoles la <strong>liquidez perfecta</strong>.</p>
            <p>Un aspecto crucial es que <strong>no siempre es alcanzado</strong> en tendencias bajistas muy fuertes. A
                diferencia del descuento, el premium puede ser esquivo si el momentum bajista es dominante. En caídas
                violentas, un retroceso al 38-50% puede ser todo lo que el mercado ofrezca.</p>

            <div class="infographic-box" style="border-top: 5px solid var(--danger);">
                <div class="infographic-title" style="color: var(--danger);"><i class="fas fa-arrow-down"></i> Niveles
                    Premium</div>
                <p>En impulsos bajistas, los retrocesos menos profundos corresponden a porcentajes como <strong>38%,
                        29.5% y 21%</strong>.</p>
                <p>Cuando un retroceso apenas alcanza el 20-38% del impulso previo, indica que la <strong>presión
                        vendedora es inmensa</strong> y las instituciones están ansiosas por vender sin dar "respiro" al
                    mercado.</p>
            </div>
        </section>

        <section>
            <h2>La Regla de Oro: Disciplina en el Posicionamiento</h2>
            <div
                style="background: var(--accent-dark); color: white; padding: 25px; border-radius: 8px; text-align: center; margin-bottom: 30px;">
                <h3
                    style="color: white; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; display: inline-block;">
                    EL MANTRA DEL PROFESIONAL</h3>
                <p style="font-size: 1.2rem; margin: 20px 0;">"Comprar <strong>SÓLO</strong> en Descuento y Vender
                    <strong>SÓLO</strong> en Premium"
                </p>
            </div>

            <p>De todos los principios discutidos, ésta es la regla que separa a los profesionales de los amateurs.
                Exige una gran disciplina. La tentación de perseguir el precio es enorme, pero operar fuera de zona
                (comprar en premium o vender en descuento) es la receta para el desastre.</p>
            <p><strong>Recuerda:</strong> Si el precio se va sin ti porque no alcanzó tu zona, hay que aceptarlo. Es
                mejor perderse una oportunidad que entrar mal y sufrir una pérdida.</p>

            <div class="infographic-box" style="background: #eceff1;">
                <div class="infographic-title"><i class="fas fa-calculator"></i> Calculadora de Zonas SMC (Visual)</div>
                <p>Introduce el rango de tu impulso actual para ver tu posición gráfica en tiempo real.</p>

                <div class="calc-panel">
                    <div class="input-group">
                        <div><small>Máximo (High)</small><input type="number" id="calc-high" class="calc-input"
                                placeholder="Ej: 1.0500" step="0.0001"></div>
                        <div><small>Mínimo (Low)</small><input type="number" id="calc-low" class="calc-input"
                                placeholder="Ej: 1.0000" step="0.0001"></div>
                    </div>
                    <div><small>Precio Actual</small><input type="number" id="calc-current" class="calc-input"
                            placeholder="Ej: 1.0200" step="0.0001" oninput="calculateZone()"></div>

                    <div class="calc-bar-container">
                        <div class="calc-marker-50"></div>
                        <div id="calc-bar-fill" class="calc-bar-fill"></div>
                    </div>

                    <div id="calc-result" class="result-box">Introduce datos para visualizar</div>
                </div>
                <p style="text-align: center; font-size: 0.8rem; margin-top: 10px;">*Tip: Puedes escribir valores para
                    probar la calculadora.</p>
            </div>
        </section>

        <section>
            <h2>Conexión con modelos operativos (ICT & Elliott)</h2>

            <h3>Modelo ICT 2022 y Power of 3 (PO3)</h3>
            <p>Los conceptos de equilibrio, descuento y premium son integrales en modelos como el <strong>ICT
                    2022</strong>. Este patrón de reversión (toma de liquidez + cambio de estructura + FVG) sólo
                considera la entrada válida si el FVG está en <strong>zona de descuento</strong> (para largos) o
                <strong>premium</strong> (para cortos).
            </p>
            <p>En el <strong>Power of 3 (Acumulación, Manipulación, Distribución)</strong>, nuestros conceptos encajan
                en la fase de <strong>Manipulación</strong>. La manipulación busca llevar el precio a una zona de
                premium/descuento óptima para cazar liquidez antes de la distribución real.</p>

            <h3>Conexión con las Ondas de Elliott</h3>
            <p>La teoría de Elliott casa sorprendentemente bien con SMC. Las ondas correctivas tienen personalidades
                distintas:</p>

            <div class="comparison-grid"
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div style="background: #e8f5e9; padding: 20px; border-radius: 8px;">
                    <h4 style="color: var(--dark-teal);">Onda 2: El Descuento Perfecto</h4>
                    <p>Es la primera corrección tras el impulso inicial. Suele ser <strong>profunda</strong> (61.8% -
                        79%). Las instituciones esperan aquí para cargar posiciones antes de la gran Onda 3.</p>
                </div>
                <div style="background: #fff3e0; padding: 20px; border-radius: 8px;">
                    <h4 style="color: #ef6c00;">Onda 4: Descuento en Tendencia Madura</h4>
                    <p>Ocurre tras la fuerte Onda 3. Suele ser <strong>superficial</strong> (38% - 50%). En una
                        tendencia establecida, el mercado no suele dar descuentos profundos.</p>
                </div>
            </div>

            <div class="infographic-box" style="text-align: center;">
                <div class="infographic-title"><i class="fas fa-wave-square"></i> Esquema Elliott Interactivo</div>
                <p style="font-size:0.9rem; margin-bottom:15px;">Pasa el cursor sobre los puntos numerados (1-5) para
                    entender la psicología institucional de cada fase.</p>

                <div class="wave-interactive-container" id="wave-container">
                    <div id="wave-tooltip" class="wave-tooltip"></div>
                    <svg id="elliottSvg" viewBox="0 0 400 200" style="width:100%; height:100%;">
                        <!-- Paths and circles will be injected by JS for animation -->
                    </svg>
                </div>
                <p style="font-size: 0.9rem; margin-top: 10px;">La Onda 2 busca el OTE (70-79%). La Onda 4 suele rebotar
                    en Equilibrio o Premium ligero.</p>
            </div>
        </section>

        <section>
            <h2>Casos de Estudio: Aplicación Real</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div style="border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                    <h4 style="color: var(--secondary-teal);"><i class="fas fa-euro-sign"></i> EUR/USD (Largo)</h4>
                    <p style="font-size: 0.9rem;">Impulso 1.0000 a 1.0500. Retroceso a 1.0130 (zona OTE). Confluencia
                        con Order Block alcista. Resultado: Expansión a nuevos máximos.</p>
                </div>
                <div style="border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                    <h4 style="color: var(--secondary-teal);"><i class="fas fa-pound-sign"></i> GBP/USD (Corto)</h4>
                    <p style="font-size: 0.9rem;">Tendencia bajista fuerte. Retroceso superficial al 20% (1.1940)
                        tocando un Breaker Block. Señal de venta en Premium "barato" por fuerza de tendencia.</p>
                </div>
                <div style="border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                    <h4 style="color: var(--secondary-teal);"><i class="fab fa-bitcoin"></i> Bitcoin 2023</h4>
                    <p style="font-size: 0.9rem;">Rally a $31k. Retroceso profundo a $25k (62% + OB diario). Compra
                        institucional clara en descuento profundo.</p>
                </div>
            </div>
        </section>

        <!-- NEW SECTION: Refinamientos Avanzados -->
        <section>
            <h2>Refinamientos Avanzados y Contexto</h2>
            <p>Dominar lo básico es solo el comienzo. Para operar como un profesional, debes aprender a adaptar estos
                conceptos a las condiciones cambiantes del mercado y al tiempo.</p>

            <h3>1. Adaptación al Régimen de Mercado</h3>
            <p>Los mercados no son estáticos. En tendencias eufóricas, los retrocesos apenas llegan al equilibrio. En
                mercados volátiles, barren profundamente. Un trader rígido pierde oportunidades o es "sacado" por stops.
            </p>

            <div class="infographic-box">
                <div class="infographic-title"><i class="fas fa-sliders-h"></i> Simulador de Régimen de Mercado</div>
                <p>Selecciona el tipo de mercado actual para ver cómo cambia la zona de reversión esperada:</p>

                <div class="regime-selector">
                    <div class="regime-btn active" onclick="updateRegime('normal')">Tendencia Normal</div>
                    <div class="regime-btn" onclick="updateRegime('strong')">Tendencia Fuerte</div>
                    <div class="regime-btn" onclick="updateRegime('volatile')">Rango/Volátil</div>
                </div>

                <div id="regime-visual"
                    style="height: 150px; background: #fafafa; border: 1px solid #ddd; border-radius: 8px; position: relative; overflow: hidden;">
                    <!-- SVG injected via JS -->
                </div>
                <p id="regime-desc"
                    style="font-size: 0.9rem; margin-top: 15px; font-style: italic; text-align: center;">
                    El mercado estándar ofrece retrocesos al OTE (62-79%).
                </p>
            </div>

            <h3>2. Integración con Timing (Kill Zones & Silver Bullet)</h3>
            <p>El precio y el tiempo son inseparables. Las zonas de descuento funcionan mejor cuando coinciden con
                ventanas de alta liquidez institucional.</p>
            <ul class="custom-list">
                <li><strong>London Open:</strong> A menudo crea el mínimo o máximo del día.</li>
                <li><strong>Silver Bullet (10-11 AM NY):</strong> Una ventana específica donde el precio suele
                    retroceder a descuento para luego expandir antes del mediodía.</li>
            </ul>

            <div class="infographic-box" style="background: #e8f5e9;">
                <div class="infographic-title"><i class="far fa-clock"></i> Reloj de Sesiones (Trading Clock)</div>
                <div class="timing-container">
                    <div class="time-slot london">
                        <div class="time-icon"><i class="fas fa-landmark"></i></div>
                        <div>
                            <strong>London Open (02:00 - 05:00 NY)</strong><br>
                            <small>Ideal para establecer el rango del día. Busca manipulaciones (Judas Swing) hacia
                                Premium/Descuento.</small>
                        </div>
                    </div>
                    <div class="time-slot ny">
                        <div class="time-icon"><i class="fas fa-building"></i></div>
                        <div>
                            <strong>NY Open (07:00 - 10:00 NY)</strong><br>
                            <small>Alta volatilidad. A menudo revierte la tendencia de Londres o continúa con
                                fuerza.</small>
                        </div>
                    </div>
                    <div class="time-slot silver-bullet">
                        <div class="time-icon"><i class="fas fa-bullseye" style="color: goldenrod;"></i></div>
                        <div>
                            <strong>Silver Bullet (10:00 - 11:00 AM NY)</strong><br>
                            <small>Ventana de alta precisión. Espera un retroceso a FVG en Descuento para una expansión
                                rápida.</small>
                        </div>
                    </div>
                </div>
            </div>

            <h3>3. Gestión Dinámica: Breakeven y Parciales</h3>
            <p>Una vez dentro del trade, usa las zonas para gestionar el riesgo:</p>
            <ul class="custom-list">
                <li><strong>Breakeven en Equilibrio:</strong> Si compraste en descuento y el precio recupera el 50%
                    (Equilibrio), mueve tu Stop Loss a entrada. Si el precio vuelve a caer, la premisa alcista podría
                    estar fallando.</li>
                <li><strong>Parciales en Premium:</strong> Al entrar en zona Premium (zona cara), asegura ganancias. No
                    esperes a que llegue al último pip del objetivo final.</li>
            </ul>
        </section>

        <section class="ai-section-wrapper">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-robot fa-2x" style="color: var(--secondary-teal);"></i>
                    <h3 style="margin: 0 0 0 10px;">Mentor KawnBit AI</h3>
                </div>
                <div
                    style="font-size:0.8rem; background: #fff; padding:5px 10px; border-radius:15px; border:1px solid #ddd;">
                    <i class="fas fa-sparkles" style="color: goldenrod;"></i> Powered by Gemini
                </div>
            </div>
            <p>Pon a prueba lo aprendido sobre Premium y Descuento con nuestra IA.</p>

            <div class="quiz-container">
                <h4 id="quiz-question-text" style="color: var(--dark-teal);">¿Cuál es la zona ideal para buscar COMPRAS
                    en un impulso alcista?</h4>
                <div id="quiz-options">
                    <div class="quiz-option" onclick="checkQuiz(this, false)">Por encima del 50% (Premium)</div>
                    <div class="quiz-option" onclick="checkQuiz(this, true)">Por debajo del 50% (Descuento), idealmente
                        62-79%</div>
                    <div class="quiz-option" onclick="checkQuiz(this, false)">Exactamente en el 50% siempre</div>
                </div>
                <div id="quiz-feedback" style="margin-top: 15px; font-weight: bold; display: none;"></div>

                <button id="btn-quiz" class="btn-ai" onclick="generateQuizQuestion()">
                    <i class="fas fa-sync-alt"></i> ✨ Nueva Pregunta (IA)
                </button>
            </div>

            <!-- NEW FEATURE: Scenario Analyzer -->
            <div class="scenario-analyzer">
                <h4 style="margin-top:0; color:var(--dark-teal); display:flex; align-items:center;">
                    <i class="fas fa-chart-line" style="margin-right:10px;"></i> Analista de Escenarios de Trading ✨
                </h4>
                <p style="font-size:0.9rem;">Describe tu setup actual (ej: "El precio rompió el máximo en H4 y está
                    retrocediendo al nivel 70% en sesión de Nueva York") y la IA evaluará las probabilidades.</p>
                <textarea id="scenario-input" class="scenario-input"
                    placeholder="Describe el escenario aquí..."></textarea>
                <button id="btn-analyze" class="btn-ai" onclick="analyzeScenario()">
                    <i class="fas fa-microchip"></i> Analizar con Gemini
                </button>
                <div id="scenario-result" class="scenario-result"></div>
            </div>

            <div class="chat-container" style="margin-top: 20px;">
                <div class="chat-header">
                    <span>Asistente de Estructura de Mercado</span>
                    <span><i class="fas fa-wifi"></i> Online</span>
                </div>
                <div class="chat-messages" id="chat-box">
                    <div class="message ai">Hola, soy tu asistente de SMC potenciado por Gemini. Analizo estructuras de
                        mercado y conceptos de liquidez. ¿Tienes dudas sobre el Equilibrio o los niveles OTE?</div>
                </div>
                <div style="padding: 10px; display: flex; border-top: 1px solid #eee;">
                    <input type="text" id="chat-input" placeholder="Pregunta sobre OTE, Premium, Descuento..."
                        style="flex:1; padding: 10px; border: 1px solid #ddd; border-radius: 20px;"
                        onkeypress="handleEnter(event)">
                    <button id="btn-chat" onclick="sendChat()"
                        style="background: var(--secondary-teal); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; margin-left: 10px; cursor: pointer; transition: transform 0.2s;"><i
                            class="fas fa-paper-plane"></i></button>
                </div>
            </div>
            <p style="font-size: 0.75rem; color: #888; text-align: center; margin-top: 10px;">
                Nota: Este módulo utiliza Google Gemini API para generar respuestas. Asegúrate de configurar tu API Key.
            </p>
        </section>

        <footer class="main-footer">
            <div class="logo-placeholder" style="font-size: 2rem;">KawnBit</div>
            <p>&copy; 2025 KawnBit Quantitative Trading Community. Todos los derechos reservados.</p>
        </footer>
    </div>

    <script>
        const proxyUrl = "/.netlify/functions/gemini-proxy";

        async function callGemini(prompt, systemInstruction = "Eres un asistente útil.", isJson = false) {
            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: systemInstruction }] }
                };

                if (isJson) {
                    payload.generationConfig = { responseMimeType: "application/json" };
                }

                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();

                if (!data.candidates || data.candidates.length === 0 || !data.candidates[0].content) {
                    throw new Error("Respuesta inválida de la IA");
                }

                const text = data.candidates[0].content.parts[0].text;

                if (isJson) {
                    return cleanAndParseJSON(text);
                }
                return text;
            } catch (e) {
                console.error("Gemini Proxy Error:", e);
                throw e;
            }
        }

        // Helper to robustly clean JSON from Markdown blocks
        function cleanAndParseJSON(text) {
            try {
                // Remove markdown code blocks if present (```json ... ``` or just ``` ... ```)
                let cleanText = text.replace(/```json\n?|```\n?/g, "").replace(/```/g, "").trim();
                return JSON.parse(cleanText);
            } catch (e) {
                console.error("Error parsing JSON:", e);
                console.log("Raw text was:", text);
                throw new Error("La IA generó una respuesta que no pudimos procesar. Intenta de nuevo.");
            }
        }

        // --- CONTEXT FOR AI ---
        const articleContext = `
        Eres KawnBit AI, un mentor experto en Trading Institucional y Smart Money Concepts (SMC).
        Basa tus respuestas en los siguientes conceptos clave:
        1. Equilibrio (50%): Punto medio de un impulso. Zona de decisión.
        2. Descuento (Discount): Zona por debajo del 50% en impulsos alcistas. Ideal para COMPRAR. Niveles clave: 62%, 70.5%, 79% (OTE).
        3. Premium: Zona por encima del 50% en impulsos bajistas. Ideal para VENDER.
        4. Regla de Oro: Solo comprar en Descuento, solo vender en Premium.
        5. Modelos: ICT 2022, Power of 3 (PO3), Ondas de Elliott (Onda 2 retroceso profundo, Onda 4 superficial).
        6. Timing: Kill Zones (London/NY Open), Silver Bullet (10-11 AM NY).
        Responde de forma concisa, profesional y educativa en Español.
    `;

        /* =========================================
           1. CHAT LOGIC (GEMINI POWERED)
           ========================================= */
        async function sendChat() {
            const input = document.getElementById('chat-input');
            const box = document.getElementById('chat-box');
            const btn = document.getElementById('btn-chat');
            const text = input.value.trim();

            if (!text) return;

            // User msg - SECURE: Use textContent/createTextNode instead of innerHTML for user input
            const userDiv = document.createElement('div');
            userDiv.className = 'message user';
            userDiv.textContent = text;
            box.appendChild(userDiv);

            input.value = '';
            box.scrollTop = box.scrollHeight;

            // Disable UI
            input.disabled = true;
            btn.disabled = true;

            // Typing indicator
            const typingId = 'typing-' + Date.now();
            box.innerHTML += `<div id="${typingId}" class="message ai loading-dots" style="color:#666">Analizando</div>`;
            box.scrollTop = box.scrollHeight;

            try {
                const response = await callGemini(text, articleContext);
                document.getElementById(typingId).remove();

                // AI Msg - Can contain HTML (formatting) from trusted source, but sanitize newlines
                const aiDiv = document.createElement('div');
                aiDiv.className = 'message ai';
                aiDiv.innerHTML = (response || "No se recibió respuesta.").replace(/\n/g, '<br>');
                box.appendChild(aiDiv);
            } catch (err) {
                if (document.getElementById(typingId)) document.getElementById(typingId).remove();
                box.innerHTML += `<div class="message ai" style="color:red">Error: No se pudo conectar con la IA. Verifica tu API Key.</div>`;
            }

            // Re-enable UI
            input.disabled = false;
            btn.disabled = false;
            input.focus();
            box.scrollTop = box.scrollHeight;
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendChat();
        }

        /* =========================================
           2. SCENARIO ANALYZER (NEW FEATURE)
           ========================================= */
        async function analyzeScenario() {
            const input = document.getElementById('scenario-input');
            const resultBox = document.getElementById('scenario-result');
            const btn = document.getElementById('btn-analyze');

            if (!input.value.trim()) return;

            // UI Loading State
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analizando...';
            resultBox.style.display = 'block';
            resultBox.innerHTML = '<span class="loading-dots">Analizando escenario institucional</span>';

            const prompt = `Analiza este escenario de trading basado en SMC (Equilibrio, Premium, Descuento): "${input.value}".
        Devuelve un análisis corto con 3 puntos: 
        1. Zona Identificada (Premium/Descuento/Tierra de Nadie).
        2. Probabilidad Estimada (Alta/Media/Baja).
        3. Recomendación Táctica.`;

            try {
                const response = await callGemini(prompt, articleContext);
                resultBox.innerHTML = `<strong>Análisis KawnBit AI:</strong><br><br>${(response || "").replace(/\n/g, '<br>')}`;
            } catch (e) {
                resultBox.innerHTML = `<span style="color:red">Error al analizar. Verifica tu API Key.</span>`;
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-microchip"></i> Analizar con Gemini';
        }

        /* =========================================
           3. DYNAMIC QUIZ GENERATOR (NEW FEATURE)
           ========================================= */
        async function generateQuizQuestion() {
            const btn = document.getElementById('btn-quiz');
            const originalBtnText = btn.innerHTML;

            // UI Loading State
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando...';
            btn.disabled = true;

            const prompt = `Genera UNA pregunta de opción múltiple sobre trading (SMC, Premium, Descuento, OTE, Elliott) en formato JSON estricto.
        Formato: {"question": "texto", "options": ["op1", "op2", "op3"], "correctIndex": 0, "explanation": "breve explicación"}
        Que sea desafiante pero educativa.`;

            try {
                const data = await callGemini(prompt, "You are a JSON generator. Output only valid JSON.", true);

                if (data && data.options) {
                    // Render new question
                    document.getElementById('quiz-question-text').innerText = data.question;
                    const optionsDiv = document.getElementById('quiz-options');
                    optionsDiv.innerHTML = '';

                    data.options.forEach((opt, index) => {
                        const isCorrect = index === data.correctIndex;
                        const div = document.createElement('div');
                        div.className = 'quiz-option';
                        div.innerText = opt;
                        div.onclick = function () { checkQuizNew(this, isCorrect, data.explanation) };
                        optionsDiv.appendChild(div);
                    });

                    document.getElementById('quiz-feedback').style.display = 'none';
                }
            } catch (e) {
                alert("Error al generar pregunta. Verifica la consola o tu API Key.");
            }

            btn.innerHTML = originalBtnText;
            btn.disabled = false;
        }

        function checkQuizNew(element, isCorrect, explanation) {
            const feedback = document.getElementById('quiz-feedback');
            const opts = document.querySelectorAll('.quiz-option');

            opts.forEach(o => o.style.pointerEvents = 'none');

            if (isCorrect) {
                element.classList.add('correct');
                feedback.style.display = 'block';
                feedback.style.color = 'green';
                feedback.innerHTML = `<i class="fas fa-check-circle"></i> ¡Correcto! <br><small>${explanation}</small>`;
            } else {
                element.classList.add('incorrect');
                feedback.style.display = 'block';
                feedback.style.color = 'red';
                feedback.innerHTML = `<i class="fas fa-times-circle"></i> Incorrecto. <br><small>${explanation}</small>`;
            }
        }

        /* =========================================
           EXISTING LOGIC (Visuals, etc)
           ========================================= */
        function updateEquilibriumVisual(val) {
            const text = document.getElementById('eqStatusText');
            const value = parseInt(val);
            if (value === 50) {
                text.innerHTML = "50% - EQUILIBRIO PERFECTO"; text.style.color = "var(--text-grey)";
            } else if (value < 50) {
                text.innerHTML = `PRECIO BAJO (${value}%) - <span style="color:var(--success)">ZONA DESCUENTO</span>`; text.style.color = "var(--success)";
            } else {
                text.innerHTML = `PRECIO ALTO (${value}%) - <span style="color:var(--danger)">ZONA PREMIUM</span>`; text.style.color = "var(--danger)";
            }
        }

        let currentOteMode = 'bullish';
        function setOteMode(mode) {
            currentOteMode = mode;
            document.querySelectorAll('.ote-btn').forEach(b => b.classList.remove('active'));
            const btns = document.querySelectorAll('.ote-btn');
            if (mode === 'bullish') btns[0].classList.add('active'); else btns[1].classList.add('active');
            drawOteChart();
        }

        function drawOteChart() {
            const container = document.getElementById('oteContainer');
            if (!container) return;

            const width = container.clientWidth || 300;
            const height = container.clientHeight || 300;
            // Don't draw if 0 dimension
            if (width === 0 || height === 0) return;

            const colorMain = currentOteMode === 'bullish' ? '#4db6ac' : '#e57373';
            const topY = 40; const botY = height - 40; const range = botY - topY;
            let fibs = [];
            if (currentOteMode === 'bullish') {
                fibs = [
                    { lvl: 0, label: '0.0 (High)', color: '#333', stroke: 2 },
                    { lvl: 0.5, label: '0.50 (Eq)', color: '#333', stroke: 1, dash: '5,5' },
                    { lvl: 0.618, label: '0.618', color: '#66bb6a', stroke: 1 },
                    { lvl: 0.705, label: '0.705 (OTE)', color: '#66bb6a', stroke: 2 },
                    { lvl: 0.79, label: '0.790', color: '#66bb6a', stroke: 1 },
                    { lvl: 1, label: '1.0 (Low)', color: '#333', stroke: 2 }
                ];
            } else {
                fibs = [
                    { lvl: 1, label: '1.0 (High)', color: '#333', stroke: 2 },
                    { lvl: 0.21, label: '0.210', color: '#e57373', stroke: 1 },
                    { lvl: 0.295, label: '0.295 (OTE)', color: '#e57373', stroke: 2 },
                    { lvl: 0.382, label: '0.382', color: '#e57373', stroke: 1 },
                    { lvl: 0.5, label: '0.50 (Eq)', color: '#333', stroke: 1, dash: '5,5' },
                    { lvl: 0, label: '0.0 (Low)', color: '#333', stroke: 2 }
                ];
            }

            let svgHTML = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">`;
            fibs.forEach(f => {
                const y = topY + (range * f.lvl);
                svgHTML += `<line x1="50" y1="${y}" x2="${width - 20}" y2="${y}" stroke="${f.color}" stroke-width="${f.stroke}" stroke-dasharray="${f.dash || ''}" /><text x="45" y="${y + 4}" font-family="Arial" font-size="12" text-anchor="end" fill="#555">${f.label}</text>`;
                if (currentOteMode === 'bullish' && f.lvl === 0.618) {
                    const hStart = topY + (range * 0.618); const hEnd = topY + (range * 0.79);
                    svgHTML += `<rect x="50" y="${hStart}" width="${width - 70}" height="${hEnd - hStart}" fill="rgba(76, 175, 80, 0.1)" /><text x="${width / 2}" y="${hStart + (hEnd - hStart) / 2 + 5}" text-anchor="middle" fill="#2e7d32" font-weight="bold" font-size="14">ZONA DE COMPRA OTE</text>`;
                }
                if (currentOteMode === 'bearish' && f.lvl === 0.21) {
                    const hStart = topY + (range * 0.21); const hEnd = topY + (range * 0.382);
                    svgHTML += `<rect x="50" y="${hStart}" width="${width - 70}" height="${hEnd - hStart}" fill="rgba(229, 115, 115, 0.1)" /><text x="${width / 2}" y="${hStart + (hEnd - hStart) / 2 + 5}" text-anchor="middle" fill="#c62828" font-weight="bold" font-size="14">ZONA DE VENTA OTE</text>`;
                }
            });
            let polyPoints = "";
            if (currentOteMode === 'bullish') polyPoints = `60,${botY} ${width * 0.3},${topY} ${width * 0.6},${topY + range * 0.705} ${width * 0.8},${topY - 20}`;
            else polyPoints = `60,${topY} ${width * 0.3},${botY} ${width * 0.6},${topY + range * 0.295} ${width * 0.8},${botY + 20}`;
            svgHTML += `<polyline points="${polyPoints}" fill="none" stroke="${colorMain}" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" /></svg>`;
            container.innerHTML = svgHTML;
        }

        function calculateZone() {
            // Robust input parsing
            const highInput = document.getElementById('calc-high').value;
            const lowInput = document.getElementById('calc-low').value;
            const currentInput = document.getElementById('calc-current').value;

            // If any is empty, reset visual
            if (highInput === '' || lowInput === '' || currentInput === '') {
                document.getElementById('calc-result').innerHTML = "Introduce datos para visualizar";
                document.getElementById('calc-bar-fill').style.width = "0%";
                return;
            }

            const high = parseFloat(highInput);
            const low = parseFloat(lowInput);
            const current = parseFloat(currentInput);

            const resBox = document.getElementById('calc-result');
            const barFill = document.getElementById('calc-bar-fill');

            if (isNaN(high) || isNaN(low) || isNaN(current)) { return; }

            const range = high - low;
            const equilibrium = low + (range * 0.5);
            let posPercent = ((current - low) / range) * 100;
            let visualPercent = Math.max(0, Math.min(100, posPercent));
            barFill.style.width = visualPercent + "%";

            if (current > high || current < low) { resBox.innerHTML = "PRECIO FUERA DEL RANGO"; resBox.style.background = "#555"; barFill.style.background = "#555"; }
            else if (current > equilibrium) { resBox.innerHTML = `ZONA PREMIUM <br><small>Estás en el 50% superior. Busca VENTAS.</small>`; resBox.style.background = "var(--danger)"; barFill.style.background = "var(--danger)"; }
            else if (current < equilibrium) { resBox.innerHTML = `ZONA DESCUENTO <br><small>Estás en el 50% inferior. Busca COMPRAS.</small>`; resBox.style.background = "var(--success)"; barFill.style.background = "var(--success)"; }
            else { resBox.innerHTML = "EQUILIBRIO EXACTO (50%)"; resBox.style.background = "var(--secondary-teal)"; barFill.style.background = "var(--secondary-teal)"; }
        }

        function initElliott() {
            const svg = document.getElementById('elliottSvg');
            if (!svg) return;
            const width = 400; const height = 200;
            const p0 = { x: 10, y: height - 10, label: '0' };
            const p1 = { x: width * 0.2, y: height * 0.5, label: '1', desc: 'Impulso Inicial.' };
            const p2 = { x: width * 0.3, y: height * 0.8, label: '2', desc: 'Retroceso Profundo (OTE).' };
            const p3 = { x: width * 0.55, y: height * 0.2, label: '3', desc: 'La gran expansión.' };
            const p4 = { x: width * 0.7, y: height * 0.5, label: '4', desc: 'Retroceso Superficial.' };
            const p5 = { x: width * 0.9, y: height * 0.05, label: '5', desc: 'Euforia minorista.' };
            const points = [p0, p1, p2, p3, p4, p5];
            let pathD = `M ${p0.x} ${p0.y}`; points.slice(1).forEach(p => pathD += ` L ${p.x} ${p.y}`);
            let content = `<path d="${pathD}" fill="none" stroke="#00897b" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />`;
            points.slice(1).forEach(p => { content += `<circle cx="${p.x}" cy="${p.y}" r="6" fill="#005b4f" class="wave-point" onmouseover="showTooltip(evt, '${p.desc}')" onmouseout="hideTooltip()" /><text x="${p.x}" y="${p.y - 15}" font-weight="bold" text-anchor="middle" fill="#333">${p.label}</text>`; });
            content += `<line x1="${p1.x}" y1="${p1.y}" x2="${p2.x}" y2="${p2.y}" stroke="green" stroke-width="1" stroke-dasharray="4,4" opacity="0.5" />`;
            svg.innerHTML = content;
        }
        function showTooltip(evt, text) { const t = document.getElementById('wave-tooltip'); t.style.display = 'block'; t.innerHTML = text; t.style.opacity = 1; let left = evt.clientX - t.parentElement.getBoundingClientRect().left; let top = evt.clientY - t.parentElement.getBoundingClientRect().top - 50; if (left < 0) left = 10; if (top < 0) top = 10; t.style.left = left + 'px'; t.style.top = top + 'px'; }
        function hideTooltip() { const t = document.getElementById('wave-tooltip'); t.style.opacity = 0; setTimeout(() => t.style.display = 'none', 200); }

        function updateRegime(type) {
            const container = document.getElementById('regime-visual');
            const desc = document.getElementById('regime-desc');
            document.querySelectorAll('.regime-btn').forEach(b => b.classList.remove('active'));
            if (type === 'normal') document.querySelectorAll('.regime-btn')[0].classList.add('active');
            if (type === 'strong') document.querySelectorAll('.regime-btn')[1].classList.add('active');
            if (type === 'volatile') document.querySelectorAll('.regime-btn')[2].classList.add('active');
            const w = container.clientWidth || 400; const h = container.clientHeight || 150;
            let path = '', color = '', zoneLine = 0, txt = '';
            if (type === 'normal') { zoneLine = h * 0.7; path = `M 10,${h - 10} L ${w * 0.3},20 L ${w * 0.6},${zoneLine} L ${w * 0.9},10`; txt = `<strong>Tendencia Normal:</strong> Retroceso a OTE (62-79%).`; color = '#4caf50'; }
            else if (type === 'strong') { zoneLine = h * 0.35 + 20; path = `M 10,${h - 10} L ${w * 0.3},20 L ${w * 0.5},${zoneLine} L ${w * 0.9},0`; txt = `<strong>Tendencia Fuerte:</strong> Retroceso superficial (20-38%).`; color = '#ff9800'; }
            else { zoneLine = h * 0.85; path = `M 10,${h - 10} L ${w * 0.2},20 L ${w * 0.5},${zoneLine} L ${w * 0.8},30`; txt = `<strong>Rango/Volátil:</strong> Barridos profundos (>80%).`; color = '#9c27b0'; }
            desc.innerHTML = txt;
            container.innerHTML = `<svg width="100%" height="100%" viewBox="0 0 ${w} ${h}"><path d="${path}" fill="none" stroke="${color}" stroke-width="3" stroke-linejoin="round" /><circle cx="${w * 0.6}" cy="${zoneLine}" r="5" fill="${color}" /><line x1="0" y1="${zoneLine}" x2="${w}" y2="${zoneLine}" stroke="#ccc" stroke-dasharray="4,4" /></svg>`;
        }

        function checkQuiz(element, isCorrect) {
            const feedback = document.getElementById('quiz-feedback');
            document.querySelectorAll('.quiz-option').forEach(o => o.style.pointerEvents = 'none');
            feedback.style.display = 'block';
            if (isCorrect) { element.classList.add('correct'); feedback.style.color = 'green'; feedback.innerHTML = '<i class="fas fa-check-circle"></i> Correcto.'; }
            else { element.classList.add('incorrect'); feedback.style.color = 'red'; feedback.innerHTML = '<i class="fas fa-times-circle"></i> Incorrecto.'; }
        }

        // Debounce Resize
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                drawOteChart();
                initElliott();
                updateRegime('normal');
            }, 100);
        });

        // Init
        window.addEventListener('load', () => { drawOteChart(); initElliott(); updateRegime('normal'); });
    </script>

</body>

</html>