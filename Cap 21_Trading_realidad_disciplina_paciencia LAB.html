<!DOCTYPE html>
<html lang="es" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Capítulo 21: Disciplina, Paciencia y Aprendizaje Continuo. Entrenamiento psicológico avanzado para traders institucionales SMC.">
    <title>KawnBit | Cap 21: Psicología del Trading Pro</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@400;700;900&display=swap"
        rel="stylesheet">

    <!-- Librerías Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Configuración Tailwind KawnBit -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kawn: {
                            light: '#ccfbf1', // Teal 100
                            base: '#14b8a6',  // Teal 500
                            dark: '#0f766e',  // Teal 700
                            deep: '#134e4a',  // Teal 900
                        },
                        slate: {
                            50: '#f8fafc',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(20, 184, 166, 0.1), 0 2px 4px -1px rgba(20, 184, 166, 0.06)',
                        'glow': '0 0 15px rgba(20, 184, 166, 0.3)',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in-up': 'fadeInUp 0.6s ease-out forwards',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos Base y Utilidades */
        body {
            background-color: #f8fafc;
            color: #334155;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Montserrat', sans-serif;
        }

        /* Scrollbar Personalizado */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #14b8a6;
        }

        /* Logo Recreation CSS */
        .kawn-logo-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .kawn-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #14b8a6 0%, #0f766e 100%);
            border-radius: 8px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(20, 184, 166, 0.4);
        }

        .kawn-logo-icon::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-top: 3px solid white;
            border-right: 3px solid white;
            transform: rotate(-15deg);
            top: 10px;
            left: 10px;
        }

        .kawn-logo-icon::after {
            content: 'K';
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 22px;
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* TOC Activo */
        .toc-link.active {
            color: #14b8a6;
            border-left: 3px solid #14b8a6;
            background-color: #ccfbf1;
            padding-left: 0.75rem;
            font-weight: 600;
        }

        .toc-link {
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        /* Callouts y Tarjetas */
        .card-concept {
            background: white;
            border-radius: 0.75rem;
            border-left: 4px solid #14b8a6;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            transition: transform 0.3s ease;
        }

        .card-concept:hover {
            transform: translateY(-2px);
        }

        .blockquote-custom {
            border-left: 4px solid #0f766e;
            padding-left: 1.5rem;
            font-style: italic;
            color: #475569;
            margin: 2rem 0;
            font-size: 1.1rem;
            background: #f0fdfa;
            padding: 1.5rem;
            border-radius: 0 1rem 1rem 0;
        }

        /* Chat Styles */
        .chat-container {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            scroll-behavior: smooth;
        }

        .message-bubble {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .user-msg {
            background-color: #14b8a6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .ai-msg {
            background-color: #f1f5f9;
            color: #334155;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            border: 1px solid #e2e8f0;
        }

        .ai-msg strong {
            color: #0f766e;
            font-weight: 700;
        }

        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #14b8a6;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 2px;
        }

        /* Flip Card Styles */
        .perspective-1000 {
            perspective: 1000px;
        }

        .transform-style-3d {
            transform-style: preserve-3d;
        }

        .backface-hidden {
            backface-visibility: hidden;
        }

        .rotate-y-180 {
            transform: rotateY(180deg);
        }

        /* Loading Spinner */
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #fff;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="antialiased selection:bg-kawn-light selection:text-kawn-deep">

    <!-- Navbar Sticky -->
    <nav
        class="sticky top-0 z-50 w-full bg-white/90 backdrop-blur-md border-b border-slate-200 shadow-sm transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo -->
                <div class="kawn-logo-wrapper select-none cursor-pointer" onclick="window.scrollTo(0,0)">
                    <div class="kawn-logo-icon"></div>
                    <div class="flex flex-col">
                        <span class="text-2xl font-black text-slate-900 tracking-tight leading-none">KAWNBIT</span>
                        <span
                            class="text-[0.6rem] font-bold text-kawn-base uppercase tracking-[0.2em] leading-none mt-1">Quantitative
                            Trading Community</span>
                    </div>
                </div>

                <!-- Mobile Menu Button -->
                <button id="mobile-menu-btn" class="md:hidden p-2 text-slate-600 hover:text-kawn-base"
                    aria-label="Abrir menú">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>

                <!-- Desktop Nav -->
                <div class="hidden md:flex space-x-8 items-center">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Mastery Series</span>
                    <div class="h-6 w-px bg-slate-200"></div>
                    <a href="#viaje-profesional"
                        class="text-kawn-base font-bold border-b-2 border-kawn-base pb-1">Capítulo 21</a>
                    <a href="#ia-tools"
                        class="text-slate-500 hover:text-kawn-base font-medium transition-colors flex items-center gap-1"><i
                            data-lucide="sparkles" class="w-3 h-3"></i> Lab IA</a>
                    <a href="#plan-accion"
                        class="text-slate-500 hover:text-kawn-base font-medium transition-colors">Plan de Acción</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Layout Principal -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <div class="flex flex-col md:flex-row gap-12">

            <!-- Sidebar TOC (Sticky) -->
            <aside id="sidebar-toc" class="hidden md:block w-64 flex-shrink-0 transition-transform duration-300">
                <div class="sticky top-28">
                    <h3
                        class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 border-b border-slate-200 pb-2">
                        Contenido</h3>
                    <nav id="toc-container"
                        class="flex flex-col space-y-1 text-sm max-h-[80vh] overflow-y-auto pr-2 custom-scrollbar">
                        <!-- Generado dinámicamente -->
                    </nav>
                </div>
            </aside>

            <!-- Contenido Principal -->
            <main class="flex-1 max-w-4xl min-w-0">

                <!-- Hero Section -->
                <section class="mb-16 animate-fade-in-up">
                    <span
                        class="inline-block py-1 px-3 rounded-full bg-kawn-light text-kawn-deep text-xs font-bold uppercase tracking-wider mb-4 border border-kawn-base/20">Capítulo
                        21</span>
                    <h1 class="text-3xl md:text-5xl font-black text-slate-900 mb-6 leading-tight">
                        La importancia de la <span class="text-kawn-base">disciplina</span>, la paciencia y el
                        aprendizaje continuo
                    </h1>
                    <p class="text-xl text-slate-600 leading-relaxed border-l-4 border-slate-300 pl-6">
                        Hemos llegado al final de este recorrido por los Smart Money Concepts (SMC), pero en realidad
                        este capítulo marca el verdadero comienzo de tu travesía como trader profesional.
                    </p>
                </section>

                <!-- Sección 1: Introducción -->
                <section id="viaje-profesional" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="map-pin" class="text-kawn-base mr-3"></i> El viaje del trader profesional
                    </h2>
                    <div class="prose max-w-none text-slate-600 leading-7">
                        <p class="mb-4">Si has absorbido todos los conceptos técnicos –desde cómo la liquidez es
                            manipulada hasta sofisticados modelos operativos– ya cuentas con un arsenal de conocimiento
                            teórico. Sin embargo, el trading no es solo aplicar patrones en una pantalla; es un proceso
                            de transformación personal profundo.</p>

                        <div class="card-concept bg-slate-50 border-l-4 border-slate-800">
                            <h4 class="font-bold text-slate-800 mb-2 flex items-center gap-2"><i
                                    data-lucide="alert-triangle" class="w-5 h-5 text-red-500"></i> Estadísticas de
                                Realidad</h4>
                            <p class="text-sm text-slate-600">
                                Solo alrededor del <strong>13%</strong> de los day traders logra mantenerse
                                consistentemente rentable por al menos seis meses, y apenas el <strong>1%</strong> tiene
                                éxito tras cinco años. Aproximadamente tres de cada cuatro terminan sus años operativos
                                en números rojos.
                            </p>
                        </div>
                    </div>
                </section>

                <!-- Sección 2: Disciplina -->
                <section id="disciplina" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="shield" class="text-kawn-base mr-3"></i> Disciplina: La columna vertebral
                    </h2>
                    <div class="card-concept">
                        <h4 class="font-bold text-kawn-dark mb-4">El protocolo del cirujano (Rutina diaria)</h4>
                        <ul class="space-y-3 text-sm text-slate-700">
                            <li class="flex items-start gap-3"><i data-lucide="check-circle"
                                    class="w-5 h-5 text-kawn-base shrink-0"></i> <strong>Horario fijo:</strong>
                                Despertarte cada día a la misma hora para control emocional.</li>
                            <li class="flex items-start gap-3"><i data-lucide="check-circle"
                                    class="w-5 h-5 text-kawn-base shrink-0"></i> <strong>Chequeo de contexto:</strong>
                                Revisar el calendario económico diariamente.</li>
                            <li class="flex items-start gap-3"><i data-lucide="check-circle"
                                    class="w-5 h-5 text-kawn-base shrink-0"></i> <strong>Top-down analysis:</strong>
                                Entender el "gran panorama" antes de buscar en marcos menores.</li>
                            <li class="flex items-start gap-3"><i data-lucide="check-circle"
                                    class="w-5 h-5 text-kawn-base shrink-0"></i> <strong>Checklist estricto:</strong> No
                                entrar hasta que todos los puntos se cumplan.</li>
                        </ul>
                    </div>

                    <h3 class="text-xl font-bold text-slate-800 mt-8 mb-4">Gestión del riesgo: La diferencia matemática
                    </h3>
                    <!-- COMPONENTE INTERACTIVO 1: SIMULADOR DE ESPERANZA MATEMÁTICA -->
                    <div class="bg-slate-900 rounded-xl p-6 shadow-2xl mb-8 border border-slate-700">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-white font-bold text-lg flex items-center gap-2"><i data-lucide="calculator"
                                    class="text-kawn-base"></i> Simulador de Esperanza</h3>
                            <span class="text-xs text-slate-400">¿Por qué fallan los rentables?</span>
                        </div>

                        <div class="grid md:grid-cols-2 gap-8">
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-slate-300 text-xs font-bold mb-2 uppercase">Ratio
                                        Riesgo:Beneficio (R:R)</label>
                                    <input type="range" id="rr-slider" min="0.5" max="5" step="0.1" value="1.5"
                                        aria-label="Ratio Riesgo Beneficio">
                                    <div class="flex justify-between text-xs text-slate-400 mt-1">
                                        <span>0.5:1</span>
                                        <span id="rr-val" class="text-kawn-base font-bold">1.5:1</span>
                                        <span>5:1</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-slate-300 text-xs font-bold mb-2 uppercase">Win Rate (Tasa
                                        de Acierto)</label>
                                    <input type="range" id="wr-slider" min="10" max="90" step="5" value="40"
                                        aria-label="Tasa de Acierto">
                                    <div class="flex justify-between text-xs text-slate-400 mt-1">
                                        <span>10%</span>
                                        <span id="wr-val" class="text-kawn-base font-bold">40%</span>
                                        <span>90%</span>
                                    </div>
                                </div>
                                <div class="bg-slate-800 p-4 rounded-lg border border-slate-600">
                                    <p class="text-slate-400 text-xs uppercase font-bold mb-1">Resultado Esperado (100
                                        trades)</p>
                                    <p id="expectancy-result" class="text-2xl font-black text-white">Calculando...</p>
                                </div>
                            </div>
                            <div class="h-64 relative">
                                <canvas id="equityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SECCIÓN: TRAMPA DEL DRAWDOWN -->
                <section id="trampa-drawdown" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="trending-down" class="text-red-500 mr-3"></i> La trampa del drawdown
                    </h2>
                    <p class="mb-4 text-slate-600 leading-7">
                        A menudo, los traders subestiman el impacto matemático de una pérdida. Existe una
                        <strong>asimetría</strong> cruel: el porcentaje necesario para recuperarse de una pérdida
                        aumenta exponencialmente a medida que la pérdida se profundiza.
                    </p>

                    <div
                        class="bg-white rounded-xl shadow-card border border-slate-200 p-6 flex flex-col md:flex-row gap-8 items-center">
                        <div class="w-full md:w-1/2">
                            <label class="block text-slate-700 text-sm font-bold mb-3">Pérdida de Capital (%
                                Drawdown)</label>
                            <input type="range" id="drawdown-slider" min="1" max="90" value="10" class="w-full mb-2"
                                aria-label="Drawdown slider">
                            <div class="flex justify-between text-xs text-slate-500 font-mono">
                                <span>1%</span>
                                <span id="drawdown-display" class="font-bold text-red-500 text-lg">10%</span>
                                <span>90%</span>
                            </div>
                        </div>
                        <div
                            class="w-full md:w-1/2 bg-slate-50 p-6 rounded-xl border border-slate-100 text-center relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-green-400 to-red-500">
                            </div>
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Ganancia
                                Necesaria</span>
                            <div id="recovery-display" class="text-4xl font-black text-slate-800 my-2">11.1%</div>
                            <p id="recovery-msg" class="text-xs text-kawn-base font-medium">Recuperación manejable.</p>
                        </div>
                    </div>
                </section>

                <!-- SECCIÓN: CICLO EMOCIONAL -->
                <section id="ciclo-emocional" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="activity" class="text-kawn-base mr-3"></i> El ciclo emocional
                    </h2>
                    <p class="mb-6 text-slate-600">
                        Los mercados financieros son una representación gráfica de la psicología humana en masa. Como
                        trader, atravesarás un ciclo predecible.
                    </p>

                    <div class="bg-slate-900 rounded-xl p-6 shadow-2xl border border-slate-700 relative">
                        <h3 class="text-white font-bold text-lg mb-2">Mapa de Calor Emocional</h3>
                        <div class="h-64 w-full relative">
                            <canvas id="emotionalChart"></canvas>
                        </div>
                        <div id="emotion-detail"
                            class="mt-4 p-4 bg-slate-800 rounded-lg border-l-4 border-kawn-base text-slate-300 text-sm hidden animate-fade-in-up">
                            <strong id="emotion-title" class="block text-white text-lg mb-1"></strong>
                            <span id="emotion-desc"></span>
                        </div>
                    </div>
                </section>

                <!-- Sección: Paciencia -->
                <section id="paciencia" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="hourglass" class="text-kawn-base mr-3"></i> Paciencia: El Santo Grial
                    </h2>
                    <blockquote class="blockquote-custom">
                        "El mercado de valores es un mecanismo para transferir dinero de los impacientes a los
                        pacientes." — Warren Buffett
                    </blockquote>

                    <!-- COMPONENTE INTERACTIVO 2: SIMULADOR DE PACIENCIA -->
                    <div
                        class="bg-white rounded-xl shadow-card border border-slate-100 p-6 mb-8 relative overflow-hidden">
                        <h3 class="font-bold text-slate-800 text-lg mb-2">Entrenamiento: Francotirador vs Metralleta
                        </h3>
                        <p class="text-sm text-slate-500 mb-6">El gráfico generará ruido. Solo dispara (Click en
                            "Ejecutar") cuando el precio toque la <span class="text-kawn-base font-bold">Zona Premium
                                (Línea Verde)</span>.</p>
                        <div id="patiencePlot" class="w-full h-64 bg-slate-50 rounded-lg mb-4 border border-slate-200">
                        </div>
                        <div class="flex justify-between items-center">
                            <div id="patience-feedback" class="text-sm font-bold text-slate-400">Esperando señal...
                            </div>
                            <button id="fire-btn"
                                class="bg-kawn-deep hover:bg-slate-900 text-white px-6 py-2 rounded-lg font-bold transition-all transform active:scale-95 shadow-lg flex items-center gap-2">
                                <i data-lucide="crosshair" class="w-4 h-4"></i> EJECUTAR ORDEN
                            </button>
                        </div>
                    </div>
                </section>

                <!-- SECCIÓN: PENSAMIENTO PROBABILÍSTICO -->
                <section id="pensamiento-probabilistico" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="dices" class="text-kawn-base mr-3"></i> Pensamiento probabilístico
                    </h2>
                    <p class="mb-6 text-slate-600">
                        Mark Douglas, en su obra seminal <em>Trading in the Zone</em>, nos enseña que el mayor obstáculo
                        es nuestra necesidad de certeza. Reprograma tus creencias.
                    </p>

                    <div class="grid md:grid-cols-3 gap-6 mb-8">
                        <!-- Card 1 -->
                        <div class="group h-48 w-full perspective-1000 cursor-pointer"
                            onclick="this.querySelector('.flipper').classList.toggle('rotate-y-180')">
                            <div
                                class="flipper relative w-full h-full transition-transform duration-700 transform-style-3d shadow-lg rounded-xl">
                                <div
                                    class="absolute w-full h-full bg-white border-2 border-slate-100 rounded-xl p-6 flex flex-col items-center justify-center text-center backface-hidden">
                                    <i data-lucide="lock" class="text-red-400 w-8 h-8 mb-3"></i>
                                    <h4 class="font-bold text-slate-700 text-sm">Creencia Limitante</h4>
                                    <p class="text-slate-500 text-xs mt-2">"Necesito saber qué va a pasar para ganar."
                                    </p>
                                </div>
                                <div
                                    class="absolute w-full h-full bg-kawn-deep rounded-xl p-6 flex flex-col items-center justify-center text-center backface-hidden rotate-y-180">
                                    <i data-lucide="unlock" class="text-kawn-light w-8 h-8 mb-3"></i>
                                    <h4 class="font-bold text-white text-sm">Verdad Probabilística</h4>
                                    <p class="text-kawn-light text-xs mt-2">"No necesito saber el futuro para hacer
                                        dinero."</p>
                                </div>
                            </div>
                        </div>
                        <!-- Card 2 -->
                        <div class="group h-48 w-full perspective-1000 cursor-pointer"
                            onclick="this.querySelector('.flipper').classList.toggle('rotate-y-180')">
                            <div
                                class="flipper relative w-full h-full transition-transform duration-700 transform-style-3d shadow-lg rounded-xl">
                                <div
                                    class="absolute w-full h-full bg-white border-2 border-slate-100 rounded-xl p-6 flex flex-col items-center justify-center text-center backface-hidden">
                                    <i data-lucide="frown" class="text-red-400 w-8 h-8 mb-3"></i>
                                    <h4 class="font-bold text-slate-700 text-sm">Creencia Limitante</h4>
                                    <p class="text-slate-500 text-xs mt-2">"Si pierdo este trade, mi análisis estaba
                                        mal."</p>
                                </div>
                                <div
                                    class="absolute w-full h-full bg-kawn-deep rounded-xl p-6 flex flex-col items-center justify-center text-center backface-hidden rotate-y-180">
                                    <i data-lucide="bar-chart-2" class="text-kawn-light w-8 h-8 mb-3"></i>
                                    <h4 class="font-bold text-white text-sm">Verdad Probabilística</h4>
                                    <p class="text-kawn-light text-xs mt-2">"Una pérdida es solo un costo de hacer
                                        negocios."</p>
                                </div>
                            </div>
                        </div>
                        <!-- Card 3 -->
                        <div class="group h-48 w-full perspective-1000 cursor-pointer"
                            onclick="this.querySelector('.flipper').classList.toggle('rotate-y-180')">
                            <div
                                class="flipper relative w-full h-full transition-transform duration-700 transform-style-3d shadow-lg rounded-xl">
                                <div
                                    class="absolute w-full h-full bg-white border-2 border-slate-100 rounded-xl p-6 flex flex-col items-center justify-center text-center backface-hidden">
                                    <i data-lucide="target" class="text-red-400 w-8 h-8 mb-3"></i>
                                    <h4 class="font-bold text-slate-700 text-sm">Creencia Limitante</h4>
                                    <p class="text-slate-500 text-xs mt-2">"Cada trade debe ser perfecto."</p>
                                </div>
                                <div
                                    class="absolute w-full h-full bg-kawn-deep rounded-xl p-6 flex flex-col items-center justify-center text-center backface-hidden rotate-y-180">
                                    <i data-lucide="check-circle" class="text-kawn-light w-8 h-8 mb-3"></i>
                                    <h4 class="font-bold text-white text-sm">Verdad Probabilística</h4>
                                    <p class="text-kawn-light text-xs mt-2">"Defino mi riesgo antes de entrar y acepto
                                        el resultado."</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SECCIÓN: HERRAMIENTAS IA -->
                <section id="ia-tools" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="sparkles" class="text-kawn-base mr-3"></i> Laboratorio de Psicología con IA
                    </h2>
                    <p class="mb-6 text-slate-600">
                        La inteligencia artificial no es solo para algoritmos; puede ser tu espejo psicológico. Utiliza
                        estas herramientas potenciadas por <strong>Gemini</strong>.
                    </p>

                    <div class="grid md:grid-cols-2 gap-8">

                        <!-- TOOL 1: ANALIZADOR DE DIARIO -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500">
                            <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                <i data-lucide="book" class="text-indigo-500"></i> Espejo de la Verdad
                            </h3>
                            <p class="text-xs text-slate-500 mb-4">La IA detectará sesgos cognitivos ocultos (FOMO,
                                venganza, euforia) en tu reflexión.</p>

                            <textarea id="journal-input"
                                class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none mb-3 resize-none"
                                rows="4"
                                placeholder="Ej: Hoy entré antes de tiempo porque sentí que el precio se escapaba..."></textarea>

                            <button id="analyze-journal-btn"
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <i data-lucide="search" class="w-4 h-4"></i> Detectar Sesgos con IA
                            </button>

                            <div id="journal-result"
                                class="hidden mt-4 p-4 bg-indigo-50 text-indigo-900 text-sm rounded-lg border border-indigo-100 animate-fade-in-up">
                            </div>
                        </div>

                        <!-- TOOL 2: SIMULADOR DE RESILIENCIA -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-pink-500">
                            <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                <i data-lucide="zap" class="text-pink-500"></i> Simulador de Resiliencia
                            </h3>
                            <p class="text-xs text-slate-500 mb-4">Genera una situación de alta presión y pon a prueba
                                tu respuesta.</p>

                            <div id="scenario-box"
                                class="bg-slate-100 p-4 rounded-lg mb-4 text-sm text-slate-700 min-h-[80px] flex items-center justify-center italic text-center">
                                "Presiona el botón para generar un desafío psicológico..."
                            </div>

                            <textarea id="scenario-response"
                                class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-pink-500 outline-none mb-3 resize-none hidden"
                                rows="2" placeholder="¿Qué harías? Escribe tu reacción..."></textarea>

                            <div class="flex gap-2">
                                <button id="gen-scenario-btn"
                                    class="flex-1 bg-pink-600 hover:bg-pink-700 text-white text-xs font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                    <i data-lucide="shuffle" class="w-4 h-4"></i> Generar Desafío
                                </button>
                                <button id="eval-scenario-btn"
                                    class="hidden flex-1 bg-slate-800 hover:bg-slate-900 text-white text-xs font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                    <i data-lucide="check" class="w-4 h-4"></i> Evaluar
                                </button>
                            </div>

                            <div id="scenario-feedback"
                                class="hidden mt-4 p-4 bg-pink-50 text-pink-900 text-sm rounded-lg border border-pink-100 animate-fade-in-up">
                            </div>
                        </div>

                    </div>
                </section>

                <!-- Sección: Integración -->
                <section id="integracion" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="git-merge" class="text-kawn-base mr-3"></i> La integración: Técnica y Psicología
                    </h2>
                    <!-- COMPONENTE INTERACTIVO 3: RADAR DE EVOLUCIÓN -->
                    <div
                        class="bg-slate-50 p-6 rounded-xl border border-slate-200 flex flex-col md:flex-row gap-8 items-center">
                        <div class="flex-1 w-full relative h-64">
                            <canvas id="radarChart"></canvas>
                        </div>
                        <div class="md:w-1/3 space-y-4">
                            <div class="text-xs font-bold text-slate-400 uppercase">Autoevaluación</div>
                            <div>
                                <label class="text-xs font-bold text-slate-700">Disciplina Técnica</label>
                                <input type="range" class="profile-slider" data-idx="0" min="1" max="10" value="5"
                                    aria-label="Disciplina Técnica">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700">Paciencia (Esperar)</label>
                                <input type="range" class="profile-slider" data-idx="1" min="1" max="10" value="4"
                                    aria-label="Paciencia">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700">Gestión de Riesgo</label>
                                <input type="range" class="profile-slider" data-idx="2" min="1" max="10" value="6"
                                    aria-label="Gestión de Riesgo">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-700">Gestión Emocional</label>
                                <input type="range" class="profile-slider" data-idx="3" min="1" max="10" value="3"
                                    aria-label="Gestión Emocional">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Sección: Plan de Acción -->
                <section id="plan-accion" class="mb-16 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 text-kawn-deep">Plan de acción inmediato</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="p-5 border border-slate-200 rounded-xl bg-white hover:shadow-md transition-shadow">
                            <div
                                class="w-8 h-8 bg-kawn-light text-kawn-deep rounded-full flex items-center justify-center font-bold mb-3">
                                1</div>
                            <h4 class="font-bold text-slate-800">Elige 1 Modelo</h4>
                            <p class="text-sm text-slate-600 mt-2">Comprométete 3 meses a un solo setup (ej. ICT 2022).
                                Ignora todo lo demás.</p>
                        </div>
                        <div class="p-5 border border-slate-200 rounded-xl bg-white hover:shadow-md transition-shadow">
                            <div
                                class="w-8 h-8 bg-kawn-light text-kawn-deep rounded-full flex items-center justify-center font-bold mb-3">
                                2</div>
                            <h4 class="font-bold text-slate-800">Escribe tus reglas</h4>
                            <p class="text-sm text-slate-600 mt-2">Imprime tu gestión de riesgo y pégala frente a tu
                                monitor. Es tu constitución.</p>
                        </div>
                        <div class="p-5 border border-slate-200 rounded-xl bg-white hover:shadow-md transition-shadow">
                            <div
                                class="w-8 h-8 bg-kawn-light text-kawn-deep rounded-full flex items-center justify-center font-bold mb-3">
                                3</div>
                            <h4 class="font-bold text-slate-800">Journaling Obligatorio</h4>
                            <p class="text-sm text-slate-600 mt-2">Desde el próximo trade. Registra no solo precios,
                                sino emociones y pensamientos.</p>
                        </div>
                        <div class="p-5 border border-slate-200 rounded-xl bg-white hover:shadow-md transition-shadow">
                            <div
                                class="w-8 h-8 bg-kawn-light text-kawn-deep rounded-full flex items-center justify-center font-bold mb-3">
                                4</div>
                            <h4 class="font-bold text-slate-800">Vida fuera del gráfico</h4>
                            <p class="text-sm text-slate-600 mt-2">Cultiva hobbies. Si tu felicidad depende 100% del
                                trading, operarás con miedo.</p>
                        </div>
                    </div>
                </section>

                <!-- Sección 7: Ejercicios -->
                <section id="ejercicios" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="clipboard-check" class="text-kawn-base mr-3"></i> Validación del conocimiento
                    </h2>

                    <!-- Área de Reflexión -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200 mb-8">
                        <h3 class="font-bold text-slate-800 mb-2">Compromiso Personal</h3>
                        <p class="text-sm text-slate-600 mb-4">Define tu regla de oro para la próxima semana (ej: "No
                            moveré el Stop Loss bajo ninguna circunstancia").</p>
                        <textarea
                            class="w-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-kawn-base focus:border-transparent outline-none transition-all resize-none bg-slate-50"
                            rows="3" placeholder="Mi regla inquebrantable será..."></textarea>
                    </div>

                    <!-- QUIZ -->
                    <div class="bg-kawn-deep p-8 rounded-xl shadow-2xl text-white">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold">Test de Psicología y Gestión</h3>
                            <span id="quiz-score" class="bg-white/20 px-3 py-1 rounded-full text-sm font-mono">Score:
                                0/10</span>
                        </div>
                        <div id="quiz-container" class="space-y-6">
                            <!-- Inyectado por JS -->
                        </div>
                        <div id="quiz-complete" class="hidden text-center mt-6">
                            <p class="text-2xl font-bold mb-2">¡Evaluación Finalizada!</p>
                            <p class="text-sm opacity-80 mb-4" id="final-msg"></p>
                            <button onclick="window.resetQuiz()"
                                class="bg-white text-kawn-deep px-6 py-2 rounded-lg font-bold text-sm hover:bg-gray-100 transition-colors">Reiniciar</button>
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <!-- AI Mentor Float -->
    <button id="ai-toggle"
        class="fixed bottom-6 right-6 z-40 bg-slate-900 text-white p-4 rounded-full shadow-glow hover:scale-105 transition-transform flex items-center gap-2 animate-pulse-slow group"
        aria-label="Abrir mentor virtual">
        <i data-lucide="bot" class="w-6 h-6 text-kawn-base group-hover:text-white transition-colors"></i>
        <span class="font-bold hidden md:inline text-kawn-light">Mentor Psicología IA ✨</span>
    </button>

    <!-- AI Modal -->
    <div id="ai-modal"
        class="hidden fixed bottom-24 right-6 w-96 max-w-[90vw] bg-white rounded-xl shadow-2xl border border-slate-200 z-50 flex flex-col h-[500px]">
        <div class="p-4 bg-slate-900 text-white rounded-t-xl flex justify-between items-center">
            <h3 class="font-bold flex items-center gap-2"><i data-lucide="brain-circuit"
                    class="text-kawn-base w-4 h-4"></i> Coach KawnBit</h3>
            <div class="flex gap-2">
                <button id="settings-ai" class="hover:text-kawn-light" aria-label="Configurar API"><i
                        data-lucide="settings" class="w-5 h-5"></i></button>
                <button id="close-ai" class="hover:text-kawn-light" aria-label="Cerrar chat"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
        </div>

        <!-- API KEY INPUT OVERLAY (Hidden by default) -->
        <div id="api-key-overlay"
            class="hidden absolute inset-0 bg-slate-900/95 z-10 flex flex-col items-center justify-center p-6 text-center rounded-xl">
            <i data-lucide="key" class="text-kawn-base w-10 h-10 mb-4"></i>
            <h4 class="text-white font-bold mb-2">Configuración de Acceso</h4>
            <p class="text-slate-400 text-xs mb-4">Introduce tu clave de Google Gemini para activar el Modo Demo.</p>
            <input type="password" id="user-api-key"
                class="w-full p-2 rounded bg-slate-800 border border-slate-600 text-white text-sm mb-4 focus:border-kawn-base outline-none"
                placeholder="Pegar API Key aquí...">
            <button id="save-api-key"
                class="bg-kawn-base text-white px-4 py-2 rounded font-bold text-sm w-full hover:bg-kawn-dark">Guardar
                Clave</button>
            <button id="cancel-api-key" class="text-slate-500 text-xs mt-3 hover:text-white">Cancelar</button>
        </div>

        <div id="chat-history" class="flex-1 overflow-y-auto p-4 bg-slate-50 flex flex-col chat-container">
            <div class="ai-msg message-bubble shadow-sm">
                Hola. Soy tu coach de psicología y gestión. Analizo el mercado y tu mente. ¿En qué te puedo ayudar hoy?
            </div>
        </div>
        <div class="p-4 border-t border-slate-200 bg-white rounded-b-xl relative">
            <div class="flex gap-2">
                <input type="text" id="user-input"
                    class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-kawn-base focus:ring-1 focus:ring-kawn-base transition-all"
                    placeholder="Ej: Me cuesta aceptar pérdidas...">
                <button id="send-ai"
                    class="bg-kawn-base text-white p-2 rounded-lg hover:bg-kawn-dark transition-colors disabled:opacity-50"
                    aria-label="Enviar mensaje">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
            <div id="ai-loading"
                class="hidden absolute top-[-30px] left-1/2 transform -translate-x-1/2 bg-slate-800 text-white text-xs px-3 py-1 rounded-full shadow-lg flex items-center gap-2">
                <div class="spinner"></div> Procesando...
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-12 mt-20 border-t border-slate-800">
        <div
            class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="kawn-logo-wrapper">
                <div class="kawn-logo-icon"></div>
                <div class="flex flex-col">
                    <span class="text-2xl font-black text-white tracking-tight leading-none">KAWNBIT</span>
                    <span
                        class="text-[0.6rem] font-bold text-kawn-base uppercase tracking-[0.2em] leading-none mt-1">Quantitative
                        Trading Community</span>
                </div>
            </div>
            <div class="text-center md:text-right">
                <p class="text-sm">© <span id="current-year"></span> KawnBit Community.</p>
                <p class="text-xs opacity-50 mt-1">Material educativo sobre Psicología del Trading.<br>No constituye
                    asesoramiento financiero.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts Lógica -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar Iconos
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // Año actual
            const currentYearEl = document.getElementById('current-year');
            if (currentYearEl) currentYearEl.textContent = new Date().getFullYear();

            // ==========================================
            // GESTIÓN ROBUSTA DE API (PROXY)
            // ==========================================

            async function callGemini(prompt, systemInstruction = "") {
                const proxyUrl = '/.netlify/functions/gemini-proxy';

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: systemInstruction }] }
                };

                try {
                    const response = await fetch(proxyUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`Proxy Error: ${response.status}`);

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || data.result || "No pude procesar la solicitud.";

                } catch (e) {
                    console.error("Gemini Error:", e);
                    return "Error de conexión. Intenta más tarde.";
                }
            }

            // CHAT MENTOR LOGIC
            const aiModal = document.getElementById('ai-modal');
            const aiToggle = document.getElementById('ai-toggle');
            const closeAi = document.getElementById('close-ai');
            const sendAi = document.getElementById('send-ai');
            const userInput = document.getElementById('user-input');
            const chatHistory = document.getElementById('chat-history');
            const aiLoading = document.getElementById('ai-loading');

            if (aiToggle) aiToggle.addEventListener('click', () => aiModal.classList.remove('hidden'));
            if (closeAi) closeAi.addEventListener('click', () => aiModal.classList.add('hidden'));

            async function sendMessage() {
                const text = userInput.value.trim();
                if (!text) return;

                const userDiv = document.createElement('div');
                userDiv.className = 'message-bubble user-msg animate-fade-in-up';
                userDiv.innerText = text;
                chatHistory.appendChild(userDiv);
                userInput.value = '';
                chatHistory.scrollTop = chatHistory.scrollHeight;

                aiLoading.classList.remove('hidden');
                sendAi.disabled = true;

                try {
                    const systemPrompt = "Eres un mentor experto en psicología de trading institucional (SMC). Eres empático pero firme con la disciplina. Tus respuestas son breves, directas y en español. Usa Markdown para formatear (negritas, listas).";
                    const reply = await callGemini(text, systemPrompt);

                    const aiDiv = document.createElement('div');
                    aiDiv.className = 'message-bubble ai-msg animate-fade-in-up';
                    aiDiv.innerHTML = typeof marked !== 'undefined' ? marked.parse(reply) : reply;
                    chatHistory.appendChild(aiDiv);
                } finally {
                    aiLoading.classList.add('hidden');
                    sendAi.disabled = false;
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                }
            }

            if (sendAi) sendAi.addEventListener('click', sendMessage);
            if (userInput) userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

            // 2. HERRAMIENTAS IA (Journal & Simulator)
            const journalBtn = document.getElementById('analyze-journal-btn');
            const journalInput = document.getElementById('journal-input');
            const journalResult = document.getElementById('journal-result');

            if (journalBtn) {
                journalBtn.addEventListener('click', async () => {
                    const entry = journalInput.value.trim();
                    if (!entry) return alert("Escribe algo primero.");

                    journalBtn.disabled = true;
                    journalBtn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Analizando...`;

                    try {
                        const prompt = `Analiza esta entrada de diario de trading: "${entry}". Detecta: 1) Estado emocional. 2) Sesgos cognitivos probables. 3) Consejo correctivo breve.`;
                        const analysis = await callGemini(prompt, "Eres un analista de conducta financiera experto.");
                        journalResult.innerHTML = `<h4 class="font-bold mb-2 flex items-center gap-2"><i data-lucide="brain"></i> Análisis IA:</h4><div class="prose prose-sm text-indigo-900">${typeof marked !== 'undefined' ? marked.parse(analysis) : analysis}</div>`;
                        journalResult.classList.remove('hidden');
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    } finally {
                        journalBtn.disabled = false;
                        journalBtn.innerHTML = `<i data-lucide="search" class="w-4 h-4"></i> Detectar Sesgos con IA`;
                    }
                });
            }

            // Simulador Resiliencia
            const genScenarioBtn = document.getElementById('gen-scenario-btn');
            const evalScenarioBtn = document.getElementById('eval-scenario-btn');
            const scenarioBox = document.getElementById('scenario-box');
            const scenarioResponse = document.getElementById('scenario-response');
            const scenarioFeedback = document.getElementById('scenario-feedback');
            let currentScenario = "";

            if (genScenarioBtn) {
                genScenarioBtn.addEventListener('click', async () => {
                    genScenarioBtn.disabled = true;
                    genScenarioBtn.innerHTML = `<div class="spinner border-pink-200 border-t-pink-600 w-4 h-4"></div> Generando...`;
                    scenarioFeedback.classList.add('hidden');
                    scenarioResponse.classList.add('hidden');
                    evalScenarioBtn.classList.add('hidden');

                    try {
                        const prompt = "Genera una situación de trading difícil y breve (máx 30 palabras) que ponga a prueba la disciplina. Termina con '¿Qué haces?'.";
                        currentScenario = await callGemini(prompt);
                        scenarioBox.innerHTML = marked.parse(currentScenario);
                        scenarioBox.classList.remove('italic', 'text-center');
                        scenarioResponse.value = "";
                        scenarioResponse.classList.remove('hidden');
                        evalScenarioBtn.classList.remove('hidden');
                        genScenarioBtn.classList.add('hidden');
                    } catch (e) {
                        scenarioBox.innerHTML = "Error: Configura la API Key.";
                    } finally {
                        genScenarioBtn.disabled = false;
                        genScenarioBtn.innerHTML = `<i data-lucide="shuffle" class="w-4 h-4"></i> Generar Desafío`;
                    }
                });
            }

            if (evalScenarioBtn) {
                evalScenarioBtn.addEventListener('click', async () => {
                    const userRes = scenarioResponse.value.trim();
                    if (!userRes) return alert("Escribe tu reacción.");

                    evalScenarioBtn.disabled = true;
                    evalScenarioBtn.innerHTML = `<div class="spinner border-slate-400 border-t-white w-4 h-4"></div> Evaluando...`;

                    try {
                        const prompt = `Escenario: "${currentScenario}". Respuesta: "${userRes}". Evalúa del 1 al 10 en Disciplina. Explica por qué.`;
                        const evaluation = await callGemini(prompt, "Eres un evaluador estricto de trading.");
                        scenarioFeedback.innerHTML = `<h4 class="font-bold mb-2 text-pink-700">Evaluación:</h4><div class="prose prose-sm text-pink-900">${marked.parse(evaluation)}</div>`;
                        scenarioFeedback.classList.remove('hidden');
                        genScenarioBtn.classList.remove('hidden');
                        evalScenarioBtn.classList.add('hidden');
                    } finally {
                        evalScenarioBtn.disabled = false;
                        evalScenarioBtn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Evaluar`;
                    }
                });
            }

            // ==========================================
            // GESTIÓN DE MEMORIA GRÁFICOS (FIX)
            // ==========================================

            // 1. Chart.js (Equity & Emotional)
            let equityChartInst = null;
            let emoChartInst = null;

            function initEquityChart() {
                const ctx = document.getElementById('equityChart');
                if (!ctx) return;

                if (equityChartInst) equityChartInst.destroy(); // CLEANUP

                const rr = parseFloat(document.getElementById('rr-slider').value);
                const wr = parseInt(document.getElementById('wr-slider').value);

                // Update Labels
                document.getElementById('rr-val').textContent = `${rr}:1`;
                document.getElementById('wr-val').textContent = `${wr}%`;

                // Calc Expectancy
                const winAmt = 1 * rr;
                const lossAmt = 1;
                const expectedValue = (winAmt * (wr / 100)) - (lossAmt * ((100 - wr) / 100));
                const resEl = document.getElementById('expectancy-result');
                resEl.textContent = `${(expectedValue * 100).toFixed(2)}%`;
                resEl.className = expectedValue > 0 ? "text-2xl font-black text-kawn-base" : "text-2xl font-black text-red-500";

                // Gen Data
                let balance = 10000;
                const dataPoints = [balance];
                for (let i = 0; i < 20; i++) {
                    const isWin = Math.random() * 100 < wr;
                    if (isWin) balance += balance * (0.01 * rr); else balance -= balance * 0.01;
                    dataPoints.push(balance);
                }

                equityChartInst = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({ length: 21 }, (_, i) => i),
                        datasets: [{
                            label: 'Proyección (20 Trades)', data: dataPoints,
                            borderColor: '#14b8a6', backgroundColor: 'rgba(20, 184, 166, 0.1)',
                            fill: true, tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { display: false }, y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } } }
                    }
                });
            }

            // Listeners for Equity Chart
            const rrSlider = document.getElementById('rr-slider');
            const wrSlider = document.getElementById('wr-slider');
            if (rrSlider && wrSlider) {
                rrSlider.addEventListener('input', initEquityChart);
                wrSlider.addEventListener('input', initEquityChart);
                initEquityChart();
            }

            // Emotional Chart (Static data, but robust init)
            const ctxEmo = document.getElementById('emotionalChart');
            if (ctxEmo) {
                const emotionalData = [
                    { x: 'Inicio', y: 50, emotion: 'Optimismo', desc: 'Análisis racional inicial.' },
                    { x: 'Subida', y: 80, emotion: 'Entusiasmo', desc: 'Confirmación del sesgo.' },
                    { x: 'Tope', y: 100, emotion: 'Euforia', desc: 'Peligro máximo: Exceso de confianza.' },
                    { x: 'Caída 1', y: 70, emotion: 'Negación', desc: 'Ignorando señales de salida.' },
                    { x: 'Caída 2', y: 40, emotion: 'Miedo', desc: 'Parálisis por análisis.' },
                    { x: 'Fondo', y: 10, emotion: 'Pánico', desc: 'Capitulación irracional.' },
                    { x: 'Recup', y: 30, emotion: 'Esperanza', desc: 'Reinicio del ciclo.' }
                ];

                if (emoChartInst) emoChartInst.destroy();

                emoChartInst = new Chart(ctxEmo, {
                    type: 'line',
                    data: {
                        labels: emotionalData.map(d => d.x),
                        datasets: [{
                            label: 'Nivel Emocional', data: emotionalData.map(d => d.y),
                            borderColor: '#ccfbf1', borderWidth: 2, pointBackgroundColor: '#14b8a6',
                            pointRadius: 6, pointHoverRadius: 10, tension: 0.4, fill: true,
                            backgroundColor: 'rgba(20, 184, 166, 0.2)'
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { display: false }, x: { grid: { color: '#334155' } } },
                        onClick: (e, activeEls) => {
                            if (activeEls.length > 0) {
                                const idx = activeEls[0].index;
                                const data = emotionalData[idx];
                                const detail = document.getElementById('emotion-detail');
                                document.getElementById('emotion-title').textContent = data.emotion;
                                document.getElementById('emotion-desc').textContent = data.desc;
                                detail.classList.remove('hidden');
                            }
                        }
                    }
                });
            }

            // Radar Chart (Robust Update)
            const ctxRadar = document.getElementById('radarChart');
            let radarInst = null;

            function updateRadar() {
                const values = Array.from(document.querySelectorAll('.profile-slider')).map(i => parseInt(i.value));
                if (radarInst) {
                    radarInst.data.datasets[1].data = values;
                    radarInst.update();
                } else {
                    radarInst = new Chart(ctxRadar, {
                        type: 'radar',
                        data: {
                            labels: ['Disciplina', 'Paciencia', 'Riesgo', 'Emociones'],
                            datasets: [{
                                label: 'Meta Pro', data: [10, 10, 10, 10], borderColor: '#14b8a6', backgroundColor: 'rgba(20, 184, 166, 0.1)', borderWidth: 2
                            }, {
                                label: 'Tu Nivel', data: values, borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.2)', borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: { r: { angleLines: { color: '#e2e8f0' }, grid: { color: '#e2e8f0' }, suggestedMin: 0, suggestedMax: 10 } }
                        }
                    });
                }
            }
            if (ctxRadar) {
                document.querySelectorAll('.profile-slider').forEach(input => input.addEventListener('input', updateRadar));
                updateRadar();
            }

            // ==========================================
            // OTROS INTERACTIVOS
            // ==========================================

            // Drawdown Slider
            const ddSlider = document.getElementById('drawdown-slider');
            const ddDisplay = document.getElementById('drawdown-display');
            const recDisplay = document.getElementById('recovery-display');
            const recMsg = document.getElementById('recovery-msg');

            if (ddSlider) {
                ddSlider.addEventListener('input', (e) => {
                    const loss = parseInt(e.target.value);
                    ddDisplay.textContent = `${loss}%`;
                    const recovery = (1 / (1 - (loss / 100))) - 1;
                    const recoveryPct = (recovery * 100).toFixed(1);
                    recDisplay.textContent = `${recoveryPct}%`;
                    if (loss < 15) { recMsg.textContent = "Recuperación manejable."; recMsg.className = "text-xs font-bold text-green-500"; }
                    else if (loss < 30) { recMsg.textContent = "Zona de peligro."; recMsg.className = "text-xs font-bold text-yellow-500"; }
                    else if (loss < 50) { recMsg.textContent = "Difícil."; recMsg.className = "text-xs font-bold text-orange-500"; }
                    else { recMsg.textContent = "Devastador."; recMsg.className = "text-xs font-bold text-red-600"; }
                });
            }

            // Mobile Menu
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', () => {
                    const sidebar = document.getElementById('sidebar-toc');
                    sidebar.classList.toggle('hidden');
                    sidebar.classList.toggle('fixed'); sidebar.classList.toggle('inset-0'); sidebar.classList.toggle('z-40'); sidebar.classList.toggle('bg-white'); sidebar.classList.toggle('p-6');

                    if (!sidebar.classList.contains('hidden') && !sidebar.querySelector('.close-mobile')) {
                        const closeBtn = document.createElement('button');
                        closeBtn.className = 'close-mobile absolute top-4 right-4 text-slate-500 p-2 font-bold';
                        closeBtn.innerHTML = '✕';
                        closeBtn.onclick = () => {
                            sidebar.classList.add('hidden');
                            sidebar.classList.remove('fixed', 'inset-0', 'z-40', 'bg-white', 'p-6');
                        };
                        sidebar.appendChild(closeBtn);
                    }
                });
            }

            // TOC Generation
            const tocContainer = document.getElementById('toc-container');
            const sections = document.querySelectorAll('main section[id]');
            if (tocContainer) {
                sections.forEach(section => {
                    const h2 = section.querySelector('h2');
                    if (h2) {
                        const link = document.createElement('a');
                        link.href = `#${section.id}`;
                        link.textContent = h2.innerText.replace(/^[^\w]*\s*/, '');
                        link.className = `toc-link block py-2 pl-3 border-l-2 border-transparent text-slate-500 hover:text-slate-900 hover:bg-slate-50 rounded-r-md transition-all truncate`;
                        link.addEventListener('click', (e) => { e.preventDefault(); document.getElementById(section.id).scrollIntoView({ behavior: 'smooth' }); });
                        tocContainer.appendChild(link);
                    }
                });
            }

            // Quiz (Optimized)
            const quizData = [
                { q: "¿Qué % de traders es rentable a 5 años?", opts: ["50%", "13%", "1%", "25%"], correct: 2, expl: "Solo el 1% sobrevive a largo plazo." },
                { q: "Definición de Disciplina:", opts: ["Horario rígido.", "Gestión de la tentación.", "Sin emociones.", "Mismo indicador."], correct: 1, expl: "Gestionar impulsos según el plan." },
                { q: "¿Qué hace el 'piloto automático'?", opts: ["Ejecuta solo.", "Frena errores emocionales.", "Analiza.", "Calcula lotaje."], correct: 1, expl: "Hábito protector automático." },
                { q: "Transferencia de dinero según Buffett:", opts: ["Pobres a ricos.", "Impacientes a pacientes.", "Osos a toros.", "Novatos a pros."], correct: 1, expl: "La paciencia paga." },
                { q: "¿Qué es 'Trading en flujo'?", opts: ["Ganar rápido.", "Integración técnica/mental.", "Sin stop.", "Señales."], correct: 1, expl: "Ejecución sin fricción." }
            ];
            let qScore = 0;
            const qContainer = document.getElementById('quiz-container');
            const qScoreDisplay = document.getElementById('quiz-score');

            window.renderQuiz = function () {
                if (!qContainer) return;
                qContainer.innerHTML = '';
                quizData.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = `quiz-item bg-white/10 p-5 rounded-lg border border-white/10 ${idx === 0 ? 'fade-in-up' : 'hidden'}`;
                    div.id = `q-${idx}`;
                    div.innerHTML = `
                        <p class="font-bold text-lg mb-4 text-kawn-light">${idx + 1}. ${item.q}</p>
                        <div class="space-y-2">${item.opts.map((opt, i) => `<button onclick="checkAnswer(${idx}, ${i}, ${item.correct}, this)" class="w-full text-left p-3 rounded bg-slate-800 hover:bg-slate-700 transition-colors text-sm quiz-opt text-slate-300">${opt}</button>`).join('')}</div>
                        <div id="feedback-${idx}" class="hidden mt-4 p-3 bg-slate-900 border-l-4 border-kawn-base text-sm text-slate-300"><strong>Explicación:</strong> ${item.expl}<div class="mt-2"><button onclick="nextQ(${idx})" class="bg-kawn-base text-white px-4 py-1 rounded text-xs font-bold hover:bg-kawn-dark">Siguiente</button></div></div>
                    `;
                    qContainer.appendChild(div);
                });
                qScore = 0; if (qScoreDisplay) qScoreDisplay.textContent = `Score: 0/${quizData.length}`;
            }

            window.checkAnswer = function (idx, optIdx, correct, btn) {
                const parent = document.getElementById(`q-${idx}`);
                const opts = parent.querySelectorAll('.quiz-opt');
                opts.forEach(o => o.disabled = true);
                if (optIdx === correct) { btn.classList.add('bg-green-600', 'text-white'); qScore++; }
                else { btn.classList.add('bg-red-600', 'text-white'); opts[correct].classList.add('bg-green-600', 'text-white'); }
                document.getElementById(`feedback-${idx}`).classList.remove('hidden');
                if (qScoreDisplay) qScoreDisplay.textContent = `Score: ${qScore}/${quizData.length}`;
            }

            window.nextQ = function (curr) {
                document.getElementById(`q-${curr}`).classList.add('hidden');
                const next = document.getElementById(`q-${curr + 1}`);
                if (next) { next.classList.remove('hidden'); next.classList.add('fade-in-up'); }
                else { document.getElementById('quiz-complete').classList.remove('hidden'); }
            }

            window.resetQuiz = function () { document.getElementById('quiz-complete').classList.add('hidden'); window.renderQuiz(); }
            window.renderQuiz();
        });
    </script>
</body>

</html>