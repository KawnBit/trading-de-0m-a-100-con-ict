<!DOCTYPE html>
<html lang="es" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Capítulo 5: Patrocinio Institucional - Detectando las huellas del Smart Money en los mercados financieros.">
    <title>KawnBit | Cap 5: Patrocinio institucional</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@400;700;900&display=swap"
        rel="stylesheet">

    <!-- Librerías Externas (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Configuración Tailwind KawnBit -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kawn: {
                            light: '#ccfbf1', // Teal 100
                            base: '#14b8a6',  // Teal 500
                            dark: '#0f766e',  // Teal 700
                            deep: '#134e4a',  // Teal 900
                        },
                        slate: {
                            50: '#f8fafc',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                    },
                    boxShadow: {
                        'glow': '0 0 15px rgba(20, 184, 166, 0.3)',
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos personalizados */
        body {
            background-color: #f8fafc;
            color: #334155;
            font-family: 'Inter', sans-serif;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Montserrat', sans-serif;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #14b8a6;
        }

        /* Logo CSS Puro */
        .kawn-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #14b8a6 0%, #0f766e 100%);
            border-radius: 8px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(20, 184, 166, 0.4);
        }

        .kawn-logo-icon::after {
            content: 'K';
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 24px;
        }

        /* TOC Activo */
        .toc-link.active {
            color: #14b8a6;
            border-left: 3px solid #14b8a6;
            background-color: #ccfbf1;
            padding-left: 0.75rem;
            font-weight: 600;
        }

        .toc-link {
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        /* Barra de Progreso */
        #reading-progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 4px;
            background: #14b8a6;
            z-index: 100;
            width: 0%;
            transition: width 0.1s ease-out;
        }

        /* Animaciones */
        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
            opacity: 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Estilos de Chat IA */
        .chat-message {
            max-width: 85%;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .user-message {
            background-color: #14b8a6;
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }

        .ai-message {
            background-color: #e2e8f0;
            color: #0f172a;
            align-self: flex-start;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }

        /* Callouts y Blockquotes */
        .callout {
            background-color: #ccfbf1;
            border-left: 4px solid #14b8a6;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
        }

        blockquote {
            border-left: 4px solid #0f172a;
            padding-left: 1rem;
            font-style: italic;
            color: #475569;
            margin: 1.5rem 0;
        }

        /* Loading Spinner */
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #ffffff;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="antialiased text-slate-600">

    <!-- Barra de Progreso -->
    <div id="reading-progress-bar"></div>

    <!-- Navbar Sticky -->
    <nav
        class="sticky top-0 z-50 w-full bg-white/95 backdrop-blur-md border-b border-slate-200 shadow-sm transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo KawnBit -->
                <div class="flex items-center gap-3">
                    <div class="kawn-logo-icon"></div>
                    <div class="flex flex-col">
                        <span class="text-2xl font-black text-slate-900 tracking-tight leading-none">KAWNBIT</span>
                        <span
                            class="text-[0.6rem] font-bold text-kawn-base uppercase tracking-[0.2em] leading-none mt-1">Quantitative
                            Trading Community</span>
                    </div>
                </div>

                <!-- Mobile Menu Button -->
                <button id="mobile-menu-btn" aria-label="Menu"
                    class="md:hidden p-2 text-slate-600 hover:text-kawn-base">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>

                <!-- Desktop Nav -->
                <div class="hidden md:flex space-x-8">
                    <a href="#" class="text-kawn-base font-semibold border-b-2 border-kawn-base pb-1">Capítulo 5</a>
                    <a href="#ai-lab"
                        class="text-slate-500 hover:text-kawn-base font-medium transition-colors flex items-center gap-1"><i
                            data-lucide="sparkles" class="w-3 h-3"></i> Lab IA</a>
                    <a href="#quiz-section"
                        class="text-slate-500 hover:text-kawn-base font-medium transition-colors">Quiz</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Layout Principal -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <div class="flex flex-col md:flex-row gap-12">

            <!-- Sidebar TOC (Sticky) -->
            <aside class="hidden md:block w-64 flex-shrink-0">
                <div class="sticky top-24">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Tabla de contenidos</h3>
                    <nav id="toc-container"
                        class="flex flex-col space-y-1 text-sm max-h-[calc(100vh-150px)] overflow-y-auto pr-2 custom-scrollbar">
                        <!-- Generado dinámicamente por JS -->
                    </nav>
                </div>
            </aside>

            <!-- Contenido Principal -->
            <main class="flex-1 max-w-4xl min-w-0">

                <!-- Hero Section -->
                <section class="mb-16 fade-in">
                    <span
                        class="inline-block py-1 px-3 rounded-full bg-kawn-light text-kawn-dark text-xs font-bold uppercase tracking-wider mb-4">Capítulo
                        5</span>
                    <h1 class="text-4xl md:text-5xl font-black text-slate-900 mb-6 leading-tight">
                        Patrocinio institucional: <span class="text-kawn-base">Las huellas del dinero inteligente</span>
                    </h1>
                    <p class="text-xl text-slate-500 leading-relaxed mb-6">
                        Aprende a leer el lenguaje oculto del mercado. Identifica cuándo los grandes jugadores respaldan
                        una dirección y alinéate con la fuerza real del precio.
                    </p>

                    <div class="flex gap-4">
                        <a href="#introduccion"
                            class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-kawn-base hover:bg-kawn-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-kawn-base transition-all">
                            Comenzar Lectura
                        </a>
                        <a href="#ai-lab"
                            class="inline-flex items-center px-6 py-3 border border-kawn-base text-base font-medium rounded-md text-kawn-deep bg-kawn-light hover:bg-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-kawn-base transition-all">
                            <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Herramientas IA
                        </a>
                    </div>
                </section>

                <!-- Introducción -->
                <section id="introduccion" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="footprints" class="text-kawn-base mr-3"></i> Introducción: El lenguaje oculto
                    </h2>
                    <p class="mb-6 leading-7">
                        Imagina por un momento que estás caminando por un bosque nevado. Aunque no puedas ver al oso que
                        pasó hace unas horas, sus huellas en la nieve te cuentan toda la historia: hacia dónde iba, qué
                        tan rápido se movía, si estaba cazando o simplemente paseando. El <strong>patrocinio
                            institucional</strong> funciona de la misma manera en los mercados financieros. El dinero
                        inteligente, aunque opera desde las sombras, deja rastros inconfundibles en los gráficos que
                        –una vez que aprendes a identificarlos– te revelan sus verdaderas intenciones.
                    </p>
                    <p class="mb-6 leading-7">
                        El concepto de patrocinio institucional es uno de los pilares más poderosos dentro de la
                        metodología ICT, porque nos permite identificar cuándo los grandes jugadores del mercado están
                        respaldando activamente una dirección específica. No hablamos de señales ambiguas; hablamos de
                        evidencia clara y contundente de que el dinero profesional ha tomado una decisión y está
                        comprometido con ella.
                    </p>
                </section>

                <!-- Naturaleza del Patrocinio -->
                <section id="naturaleza-patrocinio" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6">La naturaleza del patrocinio</h2>
                    <p class="mb-6 leading-7">
                        ¿Por qué el dinero inteligente deja estas pistas? Las instituciones no pueden simplemente entrar
                        al mercado con órdenes masivas de una sola vez, porque moverían el precio en su contra de manera
                        dramática. En su lugar, <strong>necesitan construir sus posiciones gradualmente</strong>.
                    </p>

                    <!-- Tarjeta Destacada: Analogía -->
                    <div class="callout shadow-lg transform hover:-translate-y-1 transition-transform duration-300">
                        <h3 class="text-lg font-bold text-kawn-deep mb-2 flex items-center">
                            <i data-lucide="apple" class="w-5 h-5 mr-2"></i> La analogía de las manzanas
                        </h3>
                        <p class="text-kawn-deep/90">
                            Piensa en ello como si intentaras comprar todas las manzanas de un mercado local. Si entras
                            gritando que quieres comprar <em>todas</em> las manzanas disponibles, los vendedores
                            inmediatamente subirán sus precios. En cambio, si compras gradualmente, mezclando tus
                            compras con periodos en los que incluso vendes algunas manzanas para confundir a otros
                            compradores, podrías acumular tu inventario a mejores precios. Esta analogía captura la
                            esencia de cómo opera el dinero inteligente.
                        </p>
                    </div>
                </section>

                <!-- Reglas Multi-temporal -->
                <section id="reglas-multitemporal" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="layers" class="text-kawn-base mr-3"></i> Reglas del patrocinio: Sistema
                        multi-temporal
                    </h2>
                    <p class="mb-8 text-slate-600">
                        El patrocinio no es una única señal, sino un conjunto de evidencias a través de marcos
                        temporales. Explora las características en cada nivel:
                    </p>

                    <!-- Componente Interactivo 1: Explorador de Temporalidades -->
                    <div class="bg-white rounded-xl shadow-xl border border-slate-200 overflow-hidden">
                        <div class="flex border-b border-slate-200 bg-slate-50" id="tf-tabs-container">
                            <button data-tab="tf-high"
                                class="tf-tab flex-1 py-4 text-sm font-bold text-kawn-base border-b-2 border-kawn-base focus:outline-none bg-white">Temporalidades
                                altas</button>
                            <button data-tab="tf-mid"
                                class="tf-tab flex-1 py-4 text-sm font-bold text-slate-500 hover:text-slate-700 focus:outline-none">Intermedias</button>
                            <button data-tab="tf-low"
                                class="tf-tab flex-1 py-4 text-sm font-bold text-slate-500 hover:text-slate-700 focus:outline-none">Bajas</button>
                        </div>

                        <div class="p-8 min-h-[300px]">
                            <!-- High TF Content -->
                            <div id="tf-high" class="tf-content block fade-in">
                                <h3 class="text-xl font-bold text-slate-900 mb-4">El mapa general (Diario/Semanal)</h3>
                                <p class="mb-4">Se manifiesta a través de <strong>desplazamientos
                                        significativos</strong>:</p>
                                <ul class="space-y-4">
                                    <li class="flex items-start">
                                        <div class="bg-kawn-light p-2 rounded-lg mr-3"><i data-lucide="zap"
                                                class="w-5 h-5 text-kawn-deep"></i></div>
                                        <div>
                                            <strong class="text-slate-900">Desplazamiento de impulso:</strong>
                                            <p class="text-sm text-slate-600">Ruptura violenta de estructura. Velas de
                                                gran rango con cierres fuertes cerca de sus extremos. Indica convicción
                                                y control total de la sesión.</p>
                                        </div>
                                    </li>
                                    <li class="flex items-start">
                                        <div class="bg-kawn-light p-2 rounded-lg mr-3"><i
                                                data-lucide="corner-down-right" class="w-5 h-5 text-kawn-deep"></i>
                                        </div>
                                        <div>
                                            <strong class="text-slate-900">Desplazamiento de retroceso:</strong>
                                            <p class="text-sm text-slate-600">Reacción agresiva al tocar una zona de
                                                interés (antiguo soporte/resistencia). El precio "salta" inmediatamente,
                                                indicando defensa de posiciones.</p>
                                        </div>
                                    </li>
                                </ul>
                            </div>

                            <!-- Mid TF Content -->
                            <div id="tf-mid" class="tf-content hidden fade-in">
                                <h3 class="text-xl font-bold text-slate-900 mb-4">El campo de batalla (4H / 1H)</h3>
                                <p class="mb-4">Aquí vemos la táctica en tiempo real:</p>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div class="border p-4 rounded-lg bg-slate-50">
                                        <strong class="block text-kawn-dark mb-2">Reacción en descuento/premium</strong>
                                        <p class="text-sm text-slate-600">El precio no se queda mucho tiempo en zonas de
                                            oferta/demanda. Salidas explosivas y patrones de vuelta en V con aumento de
                                            volumen.</p>
                                    </div>
                                    <div class="border p-4 rounded-lg bg-slate-50">
                                        <strong class="block text-red-600 mb-2">Liquidación de stops (Stop
                                            hunt)</strong>
                                        <p class="text-sm text-slate-600">El precio perfora un nivel obvio activando
                                            stops minoristas, e inmediatamente revierte con agresividad. Busca la
                                            liquidez para alimentar sus órdenes.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Low TF Content -->
                            <div id="tf-low" class="tf-content hidden fade-in">
                                <h3 class="text-xl font-bold text-slate-900 mb-4">Ejecución quirúrgica (15m / 5m)</h3>
                                <p class="mb-4">Las zonas de liquidez son objetivos magnéticos:</p>
                                <ul class="list-disc pl-5 space-y-2 text-slate-700">
                                    <li>El precio toma sistemáticamente mínimos recientes (stops intradía).</li>
                                    <li>Cada toma de liquidez es seguida de una <strong>expansión inmediata</strong>.
                                    </li>
                                    <li>Los retrocesos en contra son superficiales.</li>
                                    <li>Los máximos previos se superan con facilidad y velocidad.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- La Confirmación -->
                <section id="confirmacion" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6">La confirmación: protegiendo la inversión</h2>
                    <p class="mb-6">
                        El dinero inteligente defiende sus posiciones. Dos patrones clave de defensa institucional:
                    </p>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-kawn-base">
                            <h3 class="font-bold text-lg mb-3">Patrón de rechazo múltiple</h3>
                            <p class="text-sm text-slate-600">El precio prueba un nivel clave varias veces, pero cada
                                rebote es más fuerte. Mechas largas inferiores repetidas en el mismo nivel indican
                                absorción de ventas.</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-slate-700">
                            <h3 class="font-bold text-lg mb-3">Compresión de volatilidad</h3>
                            <p class="text-sm text-slate-600">Rangos o triángulos cada vez más pequeños antes de un
                                movimiento. Es la calma antes de la tormenta patrocinada. Energía acumulada.</p>
                        </div>
                    </div>
                </section>

                <!-- Secuencia Maestra (Interactivo Chart.js) -->
                <section id="secuencia-maestra" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="activity" class="text-kawn-base mr-3"></i> El proceso clásico: La secuencia
                        maestra
                    </h2>
                    <p class="mb-6">Una sinfonía de 4 pasos. Haz clic en los botones para visualizar cada fase del
                        proceso de patrocinio.</p>

                    <div class="bg-white p-6 rounded-xl shadow-2xl border border-slate-200">
                        <div class="relative h-72 w-full mb-6">
                            <canvas id="sequenceChart"></canvas>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4" id="sequence-buttons">
                            <button data-step="1"
                                class="seq-btn px-3 py-2 bg-slate-100 hover:bg-red-100 text-slate-700 text-xs font-bold rounded-lg transition-colors border border-slate-300">1.
                                Toma de liquidez</button>
                            <button data-step="2"
                                class="seq-btn px-3 py-2 bg-slate-100 hover:bg-kawn-light text-slate-700 text-xs font-bold rounded-lg transition-colors border border-slate-300">2.
                                Cambio de estructura</button>
                            <button data-step="3"
                                class="seq-btn px-3 py-2 bg-slate-100 hover:bg-blue-100 text-slate-700 text-xs font-bold rounded-lg transition-colors border border-slate-300">3.
                                Vuelta al order block</button>
                            <button data-step="4"
                                class="seq-btn px-3 py-2 bg-slate-100 hover:bg-green-100 text-slate-700 text-xs font-bold rounded-lg transition-colors border border-slate-300">4.
                                Expulsión violenta</button>
                        </div>

                        <div id="sequence-description"
                            class="p-4 bg-slate-50 rounded-lg border-l-4 border-kawn-base text-sm text-slate-700 min-h-[80px]">
                            Selecciona una fase para ver la explicación detallada.
                        </div>
                    </div>
                </section>

                <!-- Errores Comunes -->
                <section id="errores-comunes" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6">Errores comunes</h2>
                    <div class="space-y-4">
                        <div class="flex items-start bg-red-50 p-4 rounded-lg">
                            <i data-lucide="alert-triangle" class="text-red-500 w-6 h-6 mr-3 flex-shrink-0 mt-1"></i>
                            <div>
                                <strong class="text-red-800">1. Confundir volatilidad con patrocinio</strong>
                                <p class="text-sm text-red-700">Noticias pueden mover el precio sin patrocinio real. La
                                    clave es la sostenibilidad.</p>
                            </div>
                        </div>
                        <div class="flex items-start bg-red-50 p-4 rounded-lg">
                            <i data-lucide="alert-triangle" class="text-red-500 w-6 h-6 mr-3 flex-shrink-0 mt-1"></i>
                            <div>
                                <strong class="text-red-800">2. Ignorar el contexto</strong>
                                <p class="text-sm text-red-700">El patrocinio no ocurre en el vacío. Considera la fase
                                    del mercado, eventos económicos y correlaciones.</p>
                            </div>
                        </div>
                        <div class="flex items-start bg-red-50 p-4 rounded-lg">
                            <i data-lucide="alert-triangle" class="text-red-500 w-6 h-6 mr-3 flex-shrink-0 mt-1"></i>
                            <div>
                                <strong class="text-red-800">3. Forzar la identificación</strong>
                                <p class="text-sm text-red-700">Si no hay señal clara, no operes. Evita ver fantasmas.
                                    La paciencia paga.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- LABORATORIO IA (NUEVA SECCIÓN) -->
                <section id="ai-lab"
                    class="mb-20 scroll-mt-28 bg-gradient-to-br from-slate-900 to-kawn-deep p-8 rounded-2xl shadow-2xl border border-slate-700 text-white">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="p-2 bg-kawn-base rounded-lg shadow-glow">
                            <i data-lucide="sparkles" class="text-white w-6 h-6"></i>
                        </div>
                        <h2 class="text-2xl font-black tracking-tight text-white">Laboratorio de Análisis IA</h2>
                    </div>
                    <p class="mb-8 text-slate-300">Utiliza el poder de Gemini para analizar el contexto del mercado en
                        tiempo real o practicar con simulaciones avanzadas.</p>

                    <div class="grid lg:grid-cols-2 gap-8">
                        <!-- Herramienta 1: Analizador de Sentimiento -->
                        <div
                            class="bg-slate-800/50 p-6 rounded-xl border border-slate-600 hover:border-kawn-base transition-colors">
                            <h3 class="font-bold text-lg mb-3 flex items-center gap-2 text-kawn-light">
                                <i data-lucide="newspaper" class="w-5 h-5"></i> Analizador de Noticias
                            </h3>
                            <p class="text-xs text-slate-400 mb-4">Pega un titular o describe una situación de mercado.
                                La IA te dirá si huele a "Trampa de Liquidez" o "Patrocinio Real".</p>

                            <textarea id="news-input" rows="3"
                                class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm text-white focus:ring-1 focus:ring-kawn-base focus:outline-none mb-3"
                                placeholder="Ej: 'El EURUSD rompió mínimos asiáticos antes de la apertura de Londres con una vela fuerte...'"></textarea>

                            <button id="btn-analyze-news"
                                class="w-full bg-kawn-base hover:bg-kawn-dark text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2 shadow-lg">
                                <span>Analizar Probabilidad ✨</span>
                            </button>

                            <div id="news-output"
                                class="hidden mt-4 p-4 bg-slate-900 rounded-lg border-l-4 border-kawn-base text-sm text-slate-200 animate-pulse">
                            </div>
                        </div>

                        <!-- Herramienta 2: Simulador Roleplay -->
                        <div
                            class="bg-slate-800/50 p-6 rounded-xl border border-slate-600 hover:border-kawn-base transition-colors">
                            <h3 class="font-bold text-lg mb-3 flex items-center gap-2 text-kawn-light">
                                <i data-lucide="gamepad-2" class="w-5 h-5"></i> Simulador de Escenarios
                            </h3>
                            <p class="text-xs text-slate-400 mb-4">Genera un escenario aleatorio de trading
                                institucional. Tú decides qué hacer y la IA te evalúa.</p>

                            <div id="sim-scenario-box"
                                class="hidden mb-4 p-3 bg-slate-700 rounded border border-slate-500 text-sm text-white italic">
                                <!-- Scenario goes here -->
                            </div>

                            <div id="sim-controls" class="hidden space-y-3">
                                <textarea id="sim-user-decision" rows="2"
                                    class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm text-white focus:ring-1 focus:ring-kawn-base focus:outline-none"
                                    placeholder="Tu decisión (Ej: Compro en el retest del OB...)"></textarea>
                                <button id="btn-eval-sim"
                                    class="w-full bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg transition-all">
                                    Evaluar mi decisión
                                </button>
                            </div>

                            <button id="btn-gen-sim"
                                class="w-full bg-white text-kawn-deep font-bold py-2 px-4 rounded-lg hover:bg-slate-200 transition-all flex items-center justify-center gap-2 shadow-lg">
                                <span>Generar Escenario ✨</span>
                            </button>

                            <div id="sim-feedback"
                                class="hidden mt-4 p-4 bg-slate-900 rounded-lg border-l-4 border-yellow-500 text-sm text-slate-200">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Integración y Gestión -->
                <section id="integracion-gestion" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6">Integración y gestión de riesgo</h2>

                    <div class="mb-8">
                        <h3 class="font-bold text-lg mb-4 text-kawn-deep">Integración con ICT</h3>
                        <ul class="grid md:grid-cols-2 gap-4">
                            <li class="bg-white p-4 shadow rounded border-l-4 border-kawn-light">
                                <strong>Fair value gaps (FVG):</strong> Creados en la expulsión violenta (Paso 4) son
                                zonas de re-entrada muy fiables.
                            </li>
                            <li class="bg-white p-4 shadow rounded border-l-4 border-kawn-light">
                                <strong>Order blocks:</strong> Adquieren poder real cuando coinciden con el patrocinio
                                (origen del quiebre).
                            </li>
                            <li class="bg-white p-4 shadow rounded border-l-4 border-kawn-light">
                                <strong>Liquidez:</strong> El patrocinio siempre busca la siguiente zona de liquidez
                                significativa.
                            </li>
                            <li class="bg-white p-4 shadow rounded border-l-4 border-kawn-light">
                                <strong>Kill zones:</strong> La mayoría de los patrocinios intradía ocurren en Londres y
                                Nueva York.
                            </li>
                        </ul>
                    </div>

                    <div class="bg-slate-900 text-white p-6 rounded-xl shadow-xl">
                        <h3 class="font-bold text-xl mb-4 text-kawn-base">Gestión de riesgo escalonada</h3>
                        <div class="flex flex-col md:flex-row justify-between gap-4 text-sm">
                            <div class="flex-1 bg-slate-800 p-3 rounded border border-slate-700">
                                <span class="text-kawn-light font-bold block mb-1">Entrada 1 (33%)</span>
                                Retroceso al order block (Paso 3). Mejor precio, mayor riesgo.
                            </div>
                            <div class="flex-1 bg-slate-800 p-3 rounded border border-slate-700">
                                <span class="text-kawn-light font-bold block mb-1">Entrada 2 (33%)</span>
                                Inicio de la expulsión (Confirmación).
                            </div>
                            <div class="flex-1 bg-slate-800 p-3 rounded border border-slate-700">
                                <span class="text-kawn-light font-bold block mb-1">Entrada 3 (34%)</span>
                                Momentum establecido. Asegura participación.
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Casos de Estudio (Plotly Simulation) -->
                <section id="casos-estudio" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="microscope" class="text-kawn-base mr-3"></i> Caso de estudio: Defensa de nivel
                    </h2>

                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-2">Simulador: Defensa institucional (S&P 500)</h3>
                        <p class="text-sm text-slate-600 mb-4">
                            El precio llega a 4400 (Soporte + OB). Observa cómo reacciona en 3 pruebas sucesivas. El
                            Smart Money absorbe ventas y defiende el nivel.
                        </p>

                        <div id="defenseChart" class="w-full h-96 mb-4 border bg-slate-50 rounded"></div>

                        <div class="flex gap-4">
                            <button id="runSimBtn"
                                class="bg-kawn-base hover:bg-kawn-dark text-white px-4 py-2 rounded shadow font-bold transition-colors">Ejecutar
                                simulación</button>
                            <button id="resetSimBtn"
                                class="bg-slate-200 hover:bg-slate-300 text-slate-800 px-4 py-2 rounded shadow font-bold transition-colors"
                                disabled>Reset</button>
                        </div>
                        <div id="sim-status" class="mt-3 text-sm italic text-slate-500">Estado: Esperando inicio...
                        </div>
                    </div>
                </section>

                <!-- Camino a la Maestría -->
                <section id="maestria" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6">El camino hacia la maestría</h2>
                    <div class="relative border-l-4 border-kawn-light ml-4 space-y-8 pl-8 py-4">
                        <div class="relative">
                            <div
                                class="absolute -left-[42px] bg-kawn-base text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                                1</div>
                            <h4 class="font-bold text-slate-800">Mes 1-2: Observación pura</h4>
                            <p class="text-sm text-slate-600">No operes. Identifica 3 ejemplos diarios. Documenta sin
                                riesgo.</p>
                        </div>
                        <div class="relative">
                            <div
                                class="absolute -left-[42px] bg-kawn-base text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                                2</div>
                            <h4 class="font-bold text-slate-800">Mes 3-4: Operaciones en demo</h4>
                            <p class="text-sm text-slate-600">Opera señales en simulador. Enfócate en un solo par.
                                Mantén un diario detallado.</p>
                        </div>
                        <div class="relative">
                            <div
                                class="absolute -left-[42px] bg-kawn-base text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                                3</div>
                            <h4 class="font-bold text-slate-800">Mes 5-6: Transición a real (25%)</h4>
                            <p class="text-sm text-slate-600">Opera con tamaño reducido. Solo las señales más claras
                                (Calidad > Cantidad).</p>
                        </div>
                        <div class="relative">
                            <div
                                class="absolute -left-[42px] bg-kawn-base text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                                4</div>
                            <h4 class="font-bold text-slate-800">Mes 7+: Implementación completa</h4>
                            <p class="text-sm text-slate-600">Aumenta tamaño gradualmente. Desarrolla tu propio estilo y
                                expande a otros instrumentos.</p>
                        </div>
                    </div>
                </section>

                <!-- Ejercicios Inputs -->
                <section id="ejercicios" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6">Diario de patrocinio interactivo</h2>
                    <div class="bg-white p-6 rounded-xl shadow border border-slate-200">
                        <p class="mb-4 text-sm">Utiliza este espacio para practicar el "Ejercicio 2". Tus notas no se
                            guardan permanentemente (demo).</p>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Instrumento y
                                    temporalidad</label>
                                <input type="text"
                                    class="w-full border-slate-300 rounded-md shadow-sm focus:ring-kawn-base focus:border-kawn-base p-2 border"
                                    placeholder="Ej: EUR/USD 1H">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Señales específicas
                                    observadas</label>
                                <textarea rows="3"
                                    class="w-full border-slate-300 rounded-md shadow-sm focus:ring-kawn-base focus:border-kawn-base p-2 border"
                                    placeholder="Ej: Rompimiento violento con volumen tras barrer mínimos..."></textarea>
                            </div>
                            <button
                                class="bg-kawn-deep text-white px-4 py-2 rounded hover:bg-slate-800 transition">Registrar
                                entrada (Simulado)</button>
                        </div>
                    </div>
                </section>

                <!-- Quiz -->
                <section id="quiz-section" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="award" class="text-kawn-base mr-3"></i> Validación del conocimiento
                    </h2>

                    <div class="bg-white p-8 rounded-xl shadow-lg border border-slate-200">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-lg text-slate-800">Test de Patrocinio institucional</h3>
                            <span id="score-display"
                                class="bg-kawn-light text-kawn-deep px-3 py-1 rounded-full text-sm font-bold">0/5</span>
                        </div>

                        <!-- Contenedor Dinámico de Preguntas -->
                        <div id="quiz-container" class="space-y-8">
                            <!-- Se renderiza vía JS -->
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <!-- AI Mentor Float -->
    <div class="fixed bottom-6 right-6 z-40">
        <button id="ai-toggle" aria-label="Abrir mentor"
            class="bg-slate-900 text-white p-4 rounded-full shadow-2xl hover:bg-slate-800 transition-all hover:scale-105 flex items-center gap-2 group">
            <i data-lucide="bot" class="w-6 h-6 text-kawn-base group-hover:animate-bounce"></i>
            <span class="font-bold hidden md:inline">Mentor KawnBit IA</span>
        </button>
    </div>

    <!-- AI Modal -->
    <div id="ai-modal"
        class="hidden fixed bottom-24 right-6 w-96 max-w-[90vw] bg-white rounded-xl shadow-2xl border border-slate-200 z-50 flex flex-col h-[500px]">
        <div class="p-4 bg-slate-900 text-white rounded-t-xl flex justify-between items-center">
            <h3 class="font-bold flex items-center gap-2"><i data-lucide="bot" class="text-kawn-base w-4 h-4"></i>
                Mentor IA</h3>
            <button id="close-ai" class="hover:text-kawn-light"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div id="chat-history" class="flex-1 overflow-y-auto p-4 bg-slate-50 flex flex-col custom-scrollbar">
            <div class="ai-message chat-message shadow-sm">
                Hola. Soy tu especialista en Patrocinio institucional. Pregúntame sobre la "Secuencia maestra" o cómo
                identificar la "Defensa de niveles".
            </div>
        </div>
        <div class="p-4 border-t border-slate-200 bg-white rounded-b-xl">
            <div class="flex gap-2">
                <input type="text" id="user-input"
                    class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-kawn-base"
                    placeholder="Escribe tu duda...">
                <button id="send-ai"
                    class="bg-kawn-base text-white p-2 rounded-lg hover:bg-kawn-dark transition-colors">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-12 mt-20">
        <div
            class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-3">
                <div class="kawn-logo-icon"></div>
                <div class="flex flex-col">
                    <span class="text-2xl font-black text-white tracking-tight leading-none">KAWNBIT</span>
                    <span
                        class="text-[0.6rem] font-bold text-kawn-base uppercase tracking-[0.2em] leading-none mt-1">Quantitative
                        Trading Community</span>
                </div>
            </div>
            <p class="text-sm text-center md:text-right">
                © <span id="current-year"></span> KawnBit. Material educativo sobre metodología ICT. <br>
                <span class="text-xs opacity-50">No constituye asesoramiento financiero.</span>
            </p>
        </div>
    </footer>

    <!-- SCRIPTS LÓGICOS (ENCAPSULADOS) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar Iconos de forma segura
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Año Footer
            const yearEl = document.getElementById('current-year');
            if (yearEl) yearEl.textContent = new Date().getFullYear();

            // Barra de Progreso (Optimizado con requestAnimationFrame)
            let ticking = false;
            window.addEventListener('scroll', function () {
                if (!ticking) {
                    window.requestAnimationFrame(function () {
                        const progressBar = document.getElementById("reading-progress-bar");
                        if (progressBar) {
                            let winScroll = document.body.scrollTop || document.documentElement.scrollTop;
                            let height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                            let scrolled = (winScroll / height) * 100;
                            progressBar.style.width = scrolled + "%";
                        }
                        ticking = false;
                    });
                    ticking = true;
                }
            });

            // ----------------------------------------------
            // 1. TOC Dinámico
            // ----------------------------------------------
            const tocContainer = document.getElementById('toc-container');
            const headers = document.querySelectorAll('main h2, main h3');

            if (tocContainer && headers.length > 0) {
                headers.forEach((header, index) => {
                    const id = header.id || `sec-${index}`;
                    header.id = id;

                    const link = document.createElement('a');
                    link.href = `#${id}`;
                    link.textContent = header.innerText;
                    link.className = `toc-link block py-2 text-slate-500 hover:text-slate-800 ${header.tagName === 'H3' ? 'pl-4 text-xs' : 'font-medium'}`;

                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const target = document.getElementById(id);
                        if (target) target.scrollIntoView({ behavior: 'smooth' });
                    });

                    tocContainer.appendChild(link);
                });

                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            document.querySelectorAll('.toc-link').forEach(l => l.classList.remove('active'));
                            const activeLink = document.querySelector(`.toc-link[href="#${entry.target.id}"]`);
                            if (activeLink) activeLink.classList.add('active');
                        }
                    });
                }, { rootMargin: '-20% 0px -50% 0px' });

                headers.forEach(h => observer.observe(h));
            }

            // ----------------------------------------------
            // 2. Tab Switcher (Multi-temporal) - Sin onclicks
            // ----------------------------------------------
            const tabContainer = document.getElementById('tf-tabs-container');
            if (tabContainer) {
                tabContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tf-tab')) {
                        const tabId = e.target.getAttribute('data-tab');
                        if (!tabId) return;

                        // Hide all content
                        document.querySelectorAll('.tf-content').forEach(c => c.classList.add('hidden'));
                        const targetContent = document.getElementById(tabId);
                        if (targetContent) targetContent.classList.remove('hidden');

                        // Update buttons
                        document.querySelectorAll('.tf-tab').forEach(b => {
                            b.classList.remove('text-kawn-base', 'border-b-2', 'border-kawn-base', 'bg-white');
                            b.classList.add('text-slate-500');
                        });
                        e.target.classList.remove('text-slate-500');
                        e.target.classList.add('text-kawn-base', 'border-b-2', 'border-kawn-base', 'bg-white');
                    }
                });
            }

            // ----------------------------------------------
            // 3. Chart.js: Secuencia Maestra - Sin onclicks
            // ----------------------------------------------
            let sequenceChart = null;
            const seqLabels = ['Inicio', 'Toma liquidez', 'Reversión', 'Rompimiento (MSS)', 'Retroceso (OTE)', 'Expulsión'];

            function updateSequence(step) {
                if (!sequenceChart) return;

                const desc = document.getElementById('sequence-description');
                let data = [];
                let color = '';
                let text = '';

                // UI Update
                document.querySelectorAll('.seq-btn').forEach(b => b.classList.remove('ring-2', 'ring-kawn-base'));
                const btn = document.querySelector(`.seq-btn[data-step="${step}"]`);
                if (btn) btn.classList.add('ring-2', 'ring-kawn-base');

                switch (parseInt(step)) {
                    case 1:
                        data = [105, 98, 98, null, null, null]; // Caída brusca (Fake)
                        color = '#ef4444'; // Red
                        text = "<strong>Paso 1: Toma de liquidez.</strong> El precio rompe un mínimo (98) activando stops. Parece bajista, pero es un engaño para captar liquidez.";
                        break;
                    case 2:
                        data = [105, 98, 102, 108, null, null]; // MSS
                        color = '#f59e0b'; // Orange
                        text = "<strong>Paso 2: Cambio de estructura (MSS).</strong> Reacción violenta al alza. Rompe el máximo anterior (105 -> 108) con volumen. Confirma intención.";
                        break;
                    case 3:
                        data = [105, 98, 102, 108, 104, null]; // Retroceso OTE
                        color = '#3b82f6'; // Blue
                        text = "<strong>Paso 3: Vuelta al order block.</strong> El precio retrocede controladamente a la zona de origen (104). No consolida, solo 'besa' el nivel.";
                        break;
                    case 4:
                        data = [105, 98, 102, 108, 104, 115]; // Expansión
                        color = '#10b981'; // Green
                        text = "<strong>Paso 4: Expulsión violenta.</strong> Desde el OB, el precio despega acelerando. Crea nuevos máximos y deja atrás a quienes dudaron.";
                        break;
                }

                sequenceChart.data.datasets[0].data = data;
                sequenceChart.data.datasets[0].borderColor = color;
                sequenceChart.data.datasets[0].backgroundColor = color + '20';
                sequenceChart.update();
                if (desc) desc.innerHTML = text;
            }

            function initSequenceChart() {
                if (typeof Chart === 'undefined') return;
                const ctxSequence = document.getElementById('sequenceChart');
                if (!ctxSequence) return;

                if (sequenceChart) sequenceChart.destroy();

                sequenceChart = new Chart(ctxSequence.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: seqLabels,
                        datasets: [{
                            label: 'Precio',
                            data: [100, 100, 100, 100, 100, 100],
                            borderColor: '#94a3b8',
                            borderWidth: 2,
                            tension: 0.3,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { display: false }, x: { grid: { display: false } } }
                    }
                });
                updateSequence(1);
            }

            // Event Listeners para Secuencia
            const seqContainer = document.getElementById('sequence-buttons');
            if (seqContainer) {
                seqContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('seq-btn')) {
                        const step = e.target.getAttribute('data-step');
                        if (step) updateSequence(step);
                    }
                });
            }

            // Inicializar Chart si librería cargada
            if (typeof Chart !== 'undefined') setTimeout(initSequenceChart, 100);

            // ----------------------------------------------
            // 4. Plotly: Defensa de Nivel Simulator
            // ----------------------------------------------
            let simulationTimeouts = [];

            function clearSimulation() {
                simulationTimeouts.forEach(timeout => clearTimeout(timeout));
                simulationTimeouts = [];
            }

            function runDefenseSimulation() {
                if (typeof Plotly === 'undefined') return;

                const btn = document.getElementById('runSimBtn');
                const reset = document.getElementById('resetSimBtn');
                const status = document.getElementById('sim-status');
                const container = 'defenseChart';

                if (!btn || !reset || !status || !document.getElementById(container)) return;

                clearSimulation();

                btn.disabled = true;
                reset.disabled = false;
                status.textContent = "Simulando llegada al nivel 4400...";

                // Datos base
                let x = [1, 2, 3];
                let open = [4450, 4420, 4410];
                let high = [4460, 4430, 4415];
                let low = [4415, 4390, 4402];
                let close = [4420, 4410, 4412];

                const trace = {
                    x: x, open: open, high: high, low: low, close: close,
                    type: 'candlestick',
                    increasing: { line: { color: '#14b8a6' } },
                    decreasing: { line: { color: '#ef4444' } }
                };

                const layout = {
                    title: 'S&P 500 (4H) - Zona 4400',
                    dragmode: false, showlegend: false,
                    xaxis: { fixedrange: true, title: 'Tiempo' },
                    yaxis: { fixedrange: true, title: 'Precio', range: [4380, 4470] },
                    shapes: [{
                        type: 'line', x0: 0, x1: 1, xref: 'paper', y0: 4400, y1: 4400,
                        line: { color: 'blue', width: 2, dash: 'dot' }
                    }]
                };

                Plotly.newPlot(container, [trace], layout, { staticPlot: true });

                const t1 = setTimeout(() => {
                    let newX = [...x, 4];
                    let newOpen = [...open, 4412];
                    let newHigh = [...high, 4440];
                    let newLow = [...low, 4410];
                    let newClose = [...close, 4435];
                    Plotly.restyle(container, { x: [newX], open: [newOpen], high: [newHigh], low: [newLow], close: [newClose] });
                    status.textContent = "Estado: 3ra Prueba en 4410 (Mínimo Creciente). Absorción confirmada.";
                    status.className = "mt-3 text-sm font-bold text-kawn-deep";
                }, 1500);
                simulationTimeouts.push(t1);

                const t2 = setTimeout(() => {
                    let newX = [...x, 4, 5];
                    let newOpen = [...open, 4412, 4435];
                    let newHigh = [...high, 4440, 4465];
                    let newLow = [...low, 4410, 4430];
                    let newClose = [...close, 4435, 4460];
                    Plotly.restyle(container, { x: [newX], open: [newOpen], high: [newHigh], low: [newLow], close: [newClose] });
                    status.textContent = "Estado: EXPULSIÓN. El Smart Money ha defendido el nivel y empuja el precio.";
                }, 3000);
                simulationTimeouts.push(t2);
            }

            const runSimBtn = document.getElementById('runSimBtn');
            if (runSimBtn) runSimBtn.addEventListener('click', runDefenseSimulation);

            const resetSimBtn = document.getElementById('resetSimBtn');
            if (resetSimBtn) resetSimBtn.addEventListener('click', () => {
                clearSimulation();
                const chartContainer = document.getElementById('defenseChart');
                if (chartContainer) chartContainer.innerHTML = '';

                document.getElementById('runSimBtn').disabled = false;
                document.getElementById('resetSimBtn').disabled = true;

                const status = document.getElementById('sim-status');
                if (status) {
                    status.textContent = "Estado: Esperando inicio...";
                    status.className = "mt-3 text-sm italic text-slate-500";
                }
            });

            // ----------------------------------------------
            // 5. Quiz Logic (Completamente Reescrita sin globales)
            // ----------------------------------------------
            const quizData = [
                {
                    id: 1,
                    question: "¿Qué indica un 'Desplazamiento de Impulso' en temporalidades altas?",
                    options: [
                        "Velas de gran rango con cierres fuertes, indicando convicción institucional.",
                        "Un movimiento lento y gradual con muchas mechas.",
                        "Una consolidación lateral prolongada."
                    ],
                    correct: 0,
                    explanation: "<strong>Solución:</strong> El desplazamiento de impulso se caracteriza por cuerpos grandes y mechas pequeñas. Es la huella de que el dinero inteligente está comprando o vendiendo agresivamente."
                },
                {
                    id: 2,
                    question: "En el 'Paso 3: Vuelta al Order Block', ¿qué comportamiento se considera una MALA señal?",
                    options: [
                        "Que el precio apenas toque la zona y reaccione rápido.",
                        "Que el precio consolide mucho tiempo dentro del bloque o lo penetre profundamente.",
                        "Que se formen gaps alcistas de salida."
                    ],
                    correct: 1,
                    explanation: "<strong>Solución:</strong> Si el precio pasa mucho tiempo dentro del Order Block o lo atraviesa profundamente, sugiere que las instituciones no tienen urgencia ni interés real en defender ese nivel."
                },
                {
                    id: 3,
                    question: "¿Cuál es el objetivo principal de una 'Caza de Stops' (Stop Hunt)?",
                    options: [
                        "Obtener liquidez (contrapartida) para ejecutar grandes órdenes.",
                        "Hacer perder dinero a los minoristas por diversión.",
                        "Probar la resistencia técnica de los servidores del broker."
                    ],
                    correct: 0,
                    explanation: "<strong>Solución:</strong> Las instituciones mueven millones. Para comprar barato, necesitan que muchos vendan (stops de venta). Empujan el precio a zonas obvias para activar esa liquidez."
                },
                {
                    id: 4,
                    question: "Según la gestión de riesgo escalonada, ¿dónde se sugiere colocar la primera parte (33%) de la posición?",
                    options: [
                        "Cuando el precio ya ha subido un 10% para estar seguros.",
                        "En el retroceso al Order Block (Paso 3).",
                        "Justo antes de la noticia económica fundamental."
                    ],
                    correct: 1,
                    explanation: "<strong>Solución:</strong> La entrada inicial se hace en el retroceso al Order Block. Aquí se obtiene el mejor precio posible (ratio riesgo/beneficio óptimo)."
                },
                {
                    id: 5,
                    question: "¿Qué nos dice una 'Compresión de Volatilidad' antes de un movimiento?",
                    options: [
                        "Que el mercado está muerto y no hay interés.",
                        "Que el Smart Money está acumulando posiciones silenciosamente.",
                        "Que debemos dejar de operar ese par."
                    ],
                    correct: 1,
                    explanation: "<strong>Solución:</strong> Los rangos estrechos o triángulos pequeños actúan como un resorte. El dinero inteligente mantiene el precio contenido mientras acumula órdenes."
                }
            ];

            let quizScore = 0;
            let answeredState = new Array(quizData.length).fill(false);

            function initQuiz() {
                const container = document.getElementById('quiz-container');
                if (!container) return;

                container.innerHTML = '';

                quizData.forEach((item, index) => {
                    const qDiv = document.createElement('div');
                    qDiv.className = 'border-b border-slate-100 pb-6 last:border-0';

                    const questionTitle = document.createElement('p');
                    questionTitle.className = 'font-semibold text-slate-800 mb-3';
                    questionTitle.textContent = `${index + 1}. ${item.question}`;
                    qDiv.appendChild(questionTitle);

                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'space-y-1';

                    item.options.forEach((opt, optIndex) => {
                        const btn = document.createElement('button');
                        btn.className = 'quiz-btn w-full text-left p-3 border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors mb-2 text-sm';
                        btn.textContent = opt;

                        // Event Listener directo (Closure)
                        btn.addEventListener('click', function () {
                            handleAnswer(this, index, optIndex, optionsDiv);
                        });

                        optionsDiv.appendChild(btn);
                    });
                    qDiv.appendChild(optionsDiv);

                    const feedbackDiv = document.createElement('div');
                    feedbackDiv.id = `feedback-${index}`;
                    feedbackDiv.className = 'hidden mt-3 text-sm p-4 rounded bg-slate-50 border-l-4 transition-all';
                    qDiv.appendChild(feedbackDiv);

                    container.appendChild(qDiv);
                });
            }

            function handleAnswer(btn, qIndex, optIndex, parentDiv) {
                if (answeredState[qIndex]) return;
                answeredState[qIndex] = true;

                const item = quizData[qIndex];
                const isCorrect = (optIndex === item.correct);
                const feedbackEl = document.getElementById(`feedback-${qIndex}`);
                const allBtns = parentDiv.querySelectorAll('button');

                if (isCorrect) {
                    btn.classList.add('bg-kawn-light', 'border-kawn-base', 'text-kawn-deep', 'font-medium');
                    if (typeof lucide !== 'undefined') {
                        const icon = document.createElement('i');
                        icon.setAttribute('data-lucide', 'check');
                        icon.className = 'inline w-4 h-4 ml-2';
                        btn.appendChild(icon);
                    }
                    quizScore++;

                    feedbackEl.classList.add('border-kawn-base', 'bg-kawn-light/30');
                    feedbackEl.innerHTML = `<span class="text-kawn-deep font-bold block mb-1">¡Correcto!</span> ${item.explanation}`;
                } else {
                    btn.classList.add('bg-red-50', 'border-red-400', 'text-red-800');
                    if (typeof lucide !== 'undefined') {
                        const icon = document.createElement('i');
                        icon.setAttribute('data-lucide', 'x');
                        icon.className = 'inline w-4 h-4 ml-2';
                        btn.appendChild(icon);
                    }

                    // Highlight correct answer
                    allBtns[item.correct].classList.add('bg-green-50', 'border-green-400', 'text-green-800');

                    feedbackEl.classList.add('border-red-400', 'bg-red-50');
                    feedbackEl.innerHTML = `<span class="text-red-700 font-bold block mb-1">Incorrecto.</span> ${item.explanation}`;
                }

                feedbackEl.classList.remove('hidden');
                if (typeof lucide !== 'undefined') lucide.createIcons();

                const scoreDisplay = document.getElementById('score-display');
                if (scoreDisplay) scoreDisplay.textContent = `${quizScore}/${quizData.length}`;
            }

            initQuiz();

            // ----------------------------------------------
            // 6. AI Integration Logic
            // ----------------------------------------------
            const gasEndpoint = "/.netlify/functions/gemini-proxy";

            async function callGemini(prompt) {
                try {
                    const response = await fetch(gasEndpoint, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });

                    if (!response.ok) throw new Error("Error en la respuesta de la IA (Proxy)");

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || data.result || "No se pudo obtener una respuesta.";
                } catch (error) {
                    console.error(error);
                    return "Error de conexión con la IA. Inténtalo de nuevo más tarde.";
                }
            }

            // Feature 1: Analizador de Noticias
            const btnAnalyzeNews = document.getElementById('btn-analyze-news');
            if (btnAnalyzeNews) {
                btnAnalyzeNews.addEventListener('click', async function () {
                    const input = document.getElementById('news-input').value.trim();
                    const output = document.getElementById('news-output');

                    if (!input) return;

                    output.classList.remove('hidden');
                    output.innerHTML = '<span class="spinner"></span> Analizando con la metodología ICT...';
                    this.disabled = true;

                    const prompt = `Actúa como un trader institucional experto en ICT (Smart Money Concepts). Analiza el siguiente contexto de mercado/noticia: "${input}". Determina si es una "Trampa de Liquidez" o "Patrocinio Real". Sé breve.`;

                    const response = await callGemini(prompt);
                    const formatted = response.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

                    output.innerHTML = formatted;
                    output.classList.remove('animate-pulse');
                    this.disabled = false;
                });
            }

            // Feature 2: Simulador Roleplay
            let currentScenario = "";
            const btnGenSim = document.getElementById('btn-gen-sim');
            if (btnGenSim) {
                btnGenSim.addEventListener('click', async function () {
                    const scenarioBox = document.getElementById('sim-scenario-box');
                    const controls = document.getElementById('sim-controls');

                    scenarioBox.classList.remove('hidden');
                    scenarioBox.innerHTML = '<span class="spinner"></span> Creando escenario institucional...';
                    controls.classList.add('hidden');
                    document.getElementById('sim-feedback').classList.add('hidden');
                    this.disabled = true;

                    const prompt = `Genera un escenario de trading hipotético breve y difícil basado en el Capítulo 5 de Patrocinio Institucional. NO des la solución.`;

                    const response = await callGemini(prompt);
                    currentScenario = response;

                    scenarioBox.innerHTML = response.replace(/\n/g, '<br>');
                    controls.classList.remove('hidden');
                    this.disabled = false;
                    this.innerHTML = '<span>Generar Otro Escenario ✨</span>';
                });
            }

            const btnEvalSim = document.getElementById('btn-eval-sim');
            if (btnEvalSim) {
                btnEvalSim.addEventListener('click', async function () {
                    const decision = document.getElementById('sim-user-decision').value.trim();
                    const feedback = document.getElementById('sim-feedback');

                    if (!decision || !currentScenario) return;

                    feedback.classList.remove('hidden');
                    feedback.innerHTML = '<span class="spinner"></span> Evaluando tu decisión...';
                    this.disabled = true;

                    const prompt = `Escenario: "${currentScenario}". El estudiante respondió: "${decision}". Evalúa su respuesta basándote estrictamente en Patrocinio Institucional.`;

                    const response = await callGemini(prompt);
                    feedback.innerHTML = response.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                    this.disabled = false;
                });
            }

            // Chat Mentor
            const aiModal = document.getElementById('ai-modal');
            const aiToggle = document.getElementById('ai-toggle');
            const closeAi = document.getElementById('close-ai');
            const sendAi = document.getElementById('send-ai');
            const userInput = document.getElementById('user-input');
            const chatHistory = document.getElementById('chat-history');

            if (aiToggle && aiModal) {
                aiToggle.addEventListener('click', () => aiModal.classList.remove('hidden'));
                closeAi.addEventListener('click', () => aiModal.classList.add('hidden'));

                async function sendMessage() {
                    const text = userInput.value.trim();
                    if (!text) return;

                    addMessage(text, 'user');
                    userInput.value = '';
                    const loadingId = addMessage('Analizando...', 'ai', true);

                    try {
                        const prompt = `Eres un experto en Trading Institucional (SMC). Responde breve y conciso a: ${text}`;
                        const response = await callGemini(prompt);

                        const loader = document.getElementById(loadingId);
                        if (loader) loader.remove();
                        addMessage(response, 'ai');
                    } catch (error) {
                        console.error(error);
                        const loader = document.getElementById(loadingId);
                        if (loader) loader.remove();
                        addMessage("Error de conexión.", 'ai');
                    }
                }

                function addMessage(text, sender, isLoading = false) {
                    const div = document.createElement('div');
                    div.className = `${sender === 'user' ? 'user-message' : 'ai-message'} chat-message shadow-sm ${isLoading ? 'animate-pulse' : ''}`;
                    div.id = isLoading ? 'ai-loading' : `msg-${Date.now()}`;
                    div.innerText = text;
                    chatHistory.appendChild(div);
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                    return div.id;
                }

                if (sendAi) sendAi.addEventListener('click', sendMessage);
                if (userInput) userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage() });
            }

            // Mobile Menu
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', () => {
                    const aside = document.querySelector('aside');
                    if (aside) {
                        aside.classList.toggle('hidden');
                        aside.classList.toggle('fixed');
                        aside.classList.toggle('inset-0');
                        aside.classList.toggle('bg-white');
                        aside.classList.toggle('z-50');
                        aside.classList.toggle('p-6');
                    }
                });
            }
        });
    </script>
</body>

</html>