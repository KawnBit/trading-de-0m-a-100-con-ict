<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KawnBit Magazine: Bloques de Ruptura (Breaker Block)</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Palette based on KawnBit Logo & Reference */
            --primary-teal: #4db6ac;
            --secondary-teal: #00897b;
            --dark-teal: #005b4f;
            --accent-dark: #263238;
            --text-grey: #455a64;
            --light-bg: #f4f7f6;
            --white: #ffffff;
            --danger: #ef5350;
            --danger-dark: #c62828;
            --success: #66bb6a;
            --success-dark: #2e7d32;
            --candle-green: #26a69a;
            --candle-red: #ef5350;
            --gradient-teal: linear-gradient(135deg, var(--primary-teal), var(--secondary-teal));
            --purple-accent: #7e57c2;
            /* New accent for Unicorn Model */
            --ai-accent: #651fff;
            /* Accent for AI features */
            --ai-gradient: linear-gradient(135deg, #651fff, #b388ff);
        }

        body {
            font-family: 'Open Sans', sans-serif;
            color: var(--text-grey);
            background-color: var(--light-bg);
            margin: 0;
            padding: 0;
            line-height: 1.8;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Montserrat', sans-serif;
            color: var(--accent-dark);
            font-weight: 700;
        }

        h1 {
            font-size: 2.5rem;
            text-transform: uppercase;
            letter-spacing: -1px;
            color: var(--secondary-teal);
            margin-bottom: 0.5em;
            text-align: center;
        }

        h2 {
            font-size: 1.8rem;
            border-bottom: 3px solid var(--primary-teal);
            padding-bottom: 10px;
            margin-top: 50px;
            color: var(--dark-teal);
        }

        h3 {
            font-size: 1.4rem;
            color: var(--secondary-teal);
            margin-top: 30px;
            margin-bottom: 15px;
        }

        strong {
            color: var(--secondary-teal);
            font-weight: 700;
        }

        em {
            font-style: italic;
            color: var(--dark-teal);
        }

        p {
            margin-bottom: 1.5em;
            text-align: justify;
        }

        ul {
            list-style-type: none;
            padding-left: 0;
        }

        ul li {
            position: relative;
            padding-left: 25px;
            margin-bottom: 10px;
        }

        ul li::before {
            content: '\f054';
            /* FontAwesome chevron right */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            left: 0;
            color: var(--primary-teal);
            font-size: 0.8rem;
            top: 5px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: var(--white);
            padding: 50px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        /* Header Section */
        .magazine-header {
            text-align: center;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--light-bg);
            margin-bottom: 40px;
        }

        .logo-placeholder {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 3rem;
            background: var(--gradient-teal);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
            margin-bottom: 10px;
        }

        .logo-tagline {
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--secondary-teal);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .chapter-badge {
            background: var(--dark-teal);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: inline-block;
            margin-bottom: 15px;
        }

        /* AI Button Style */
        .ai-btn-sm {
            background: var(--ai-gradient);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(101, 31, 255, 0.2);
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .ai-btn-sm:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(101, 31, 255, 0.3);
        }

        .ai-btn-sm:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .intro-lead {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-dark);
            border-left: 5px solid var(--primary-teal);
            padding-left: 25px;
            margin-bottom: 30px;
            font-style: italic;
        }

        /* --- VISUAL ELEMENTS & INFOGRAPHICS --- */

        .infographic-box {
            background: var(--white);
            border-radius: 16px;
            padding: 30px;
            margin: 40px 0;
            border: 1px solid #e0e0e0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .infographic-box.interactive {
            border: 2px solid var(--primary-teal);
        }

        .infographic-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: var(--gradient-teal);
        }

        .infographic-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--dark-teal);
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            background: #e0f2f1;
            padding: 10px 20px;
            border-radius: 50px;
            width: fit-content;
        }

        .infographic-title i {
            margin-right: 10px;
            font-size: 1.2rem;
            color: var(--secondary-teal);
        }

        /* CHART & SVG STYLES */
        .chart-container {
            width: 100%;
            height: 350px;
            background: #1e222d;
            /* Dark TradingView style background */
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.2);
        }

        .svg-chart {
            width: 100%;
            height: 100%;
        }

        /* Candle Styles */
        .candle-body {
            shape-rendering: crispEdges;
        }

        .candle-wick {
            stroke-width: 1.5;
        }

        .candle-green {
            fill: var(--candle-green);
            stroke: var(--candle-green);
        }

        .candle-red {
            fill: var(--candle-red);
            stroke: var(--candle-red);
        }

        /* Annotations */
        .annotation-box {
            fill: rgba(255, 255, 255, 0.1);
            stroke-dasharray: 4;
            stroke-width: 1;
        }

        .annotation-text {
            font-family: 'Open Sans', sans-serif;
            font-size: 12px;
            fill: #cfd8dc;
        }

        .annotation-line {
            stroke-width: 2;
        }

        /* Interactive Controls */
        .controls-area {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 12px;
        }

        .btn-interact {
            background: var(--gradient-teal);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-interact:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            filter: brightness(110%);
        }

        .btn-interact:disabled {
            background: #cfd8dc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-interact.active-btn {
            background: var(--dark-teal);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--secondary-teal);
            border: 2px solid var(--secondary-teal);
        }

        .btn-purple {
            background: linear-gradient(135deg, #7e57c2, #512da8);
        }

        .step-indicator {
            font-family: 'Montserrat', sans-serif;
            font-weight: bold;
            color: var(--dark-teal);
            background: #e0f2f1;
            padding: 5px 15px;
            border-radius: 20px;
            min-width: 150px;
            text-align: center;
        }

        /* Tabs for Case Studies */
        .tabs-header {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            overflow-x: auto;
        }

        .tab-btn {
            background: none;
            border: none;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-grey);
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: #f0f0f0;
        }

        .tab-btn.active {
            background: var(--secondary-teal);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 137, 123, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Risk Management Tool */
        .risk-calculator {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: center;
        }

        .risk-controls {
            padding: 20px;
            background: #fff8e1;
            border-radius: 12px;
            border: 1px solid #ffecb3;
        }

        .risk-visual {
            height: 250px;
            background: #1e222d;
            border-radius: 12px;
            position: relative;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-card {
            background: #ffffff;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 25px;
            transition: transform 0.3s;
            border-top: 4px solid var(--secondary-teal);
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
        }

        .info-card h4 {
            color: var(--dark-teal);
            margin-top: 0;
            display: flex;
            align-items: center;
        }

        .info-card h4 i {
            margin-right: 10px;
            color: var(--primary-teal);
        }

        /* Quote Box */
        .pull-quote {
            font-size: 1.4rem;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: var(--secondary-teal);
            text-align: center;
            margin: 40px 0;
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
        }

        .pull-quote::after {
            content: '‚Äù';
            position: absolute;
            font-size: 6rem;
            color: rgba(0, 137, 123, 0.1);
            right: 20px;
            bottom: -40px;
            font-family: serif;
        }

        /* Refinements for reading */
        .glossary-item {
            background: #e0f7fa;
            border-left: 4px solid var(--dark-teal);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }

        /* --- FOOTER & AI SECTION STYLES --- */
        .ai-section-wrapper {
            background: #f3e5f5;
            /* Light Purple for AI */
            border-radius: 16px;
            padding: 30px;
            margin-top: 60px;
            border: 2px solid var(--ai-accent);
            position: relative;
            overflow: hidden;
        }

        .main-footer {
            margin-top: 50px;
            padding: 40px 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            background-color: #f8f9fa;
            border-radius: 12px;
        }

        /* Animation for Chess Piece */
        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .floating-icon {
            animation: float 3s ease-in-out infinite;
        }

        /* --- CHAT AI STYLES --- */
        .ai-chat-interface {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 1px solid #d1c4e9;
        }

        .ai-chat-box {
            height: 250px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .chat-message.ai {
            background: #ede7f6;
            color: #4527a0;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        .chat-message.user {
            background: var(--gradient-teal);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 25px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--ai-accent);
        }

        .chat-send-btn {
            background: var(--ai-accent);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .chat-send-btn:hover {
            transform: scale(1.1);
        }

        .chat-send-btn:disabled {
            background: #b0bec5;
            cursor: not-allowed;
            transform: none;
        }

        .loading-dots:after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                color: rgba(0, 0, 0, 0);
                text-shadow: .25em 0 0 rgba(0, 0, 0, 0), .5em 0 0 rgba(0, 0, 0, 0);
            }

            40% {
                color: #4527a0;
                text-shadow: .25em 0 0 rgba(0, 0, 0, 0), .5em 0 0 rgba(0, 0, 0, 0);
            }

            60% {
                text-shadow: .25em 0 0 #4527a0, .5em 0 0 rgba(0, 0, 0, 0);
            }

            80%,
            100% {
                text-shadow: .25em 0 0 #4527a0, .5em 0 0 #4527a0;
            }
        }

        /* Summary Modal */
        .summary-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .summary-card {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 16px;
            padding: 30px;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease-out;
        }

        .summary-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        /* Scenario Analyzer Styles */
        .scenario-box {
            background: #fff;
            border: 1px solid #d1c4e9;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .scenario-textarea {
            width: 100%;
            height: 100px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .scenario-feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background: #f3e5f5;
            display: none;
            border-left: 4px solid var(--ai-accent);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8rem;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .risk-calculator {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="magazine-header">
            <div class="logo-placeholder">KawnBit</div>
            <div class="logo-tagline">Quantitative Trading Community</div>
            <button id="summary-btn" class="ai-btn-sm" onclick="generateSummary()">
                <i class="fas fa-sparkles"></i> Generar Resumen IA
            </button>
        </header>

        <div style="text-align: center;">
            <span class="chapter-badge">Smart Money Concepts</span>
            <h1>Cap√≠tulo 8: Bloques de Ruptura (Breaker Block - BB)</h1>
        </div>

        <section>
            <h2>Introducci√≥n: La naturaleza enga√±osa del Breaker Block</h2>
            <p class="intro-lead">Imagina por un momento que est√°s observando un partido de ajedrez entre dos maestros.
                Uno de ellos sacrifica deliberadamente una pieza importante, lo que parece un error garrafal para el
                observador novato. Sin embargo, unos movimientos despu√©s, esa aparente debilidad se convierte en la
                trampa perfecta que garantiza el jaque mate.</p>

            <div class="infographic-box" style="text-align: center;">
                <div class="infographic-title"><i class="fas fa-chess"></i> Estrategia Maestra</div>
                <div class="floating-icon">
                    <i class="fas fa-chess-queen fa-4x"
                        style="color: var(--secondary-teal); margin-bottom: 15px; text-shadow: 0 10px 10px rgba(0,0,0,0.1);"></i>
                </div>
                <p>El mercado no se mueve al azar. Al igual que en el ajedrez, un movimiento que parece un error (la
                    ruptura de un nivel) es a menudo una estrategia calculada de sacrificio para ganar posici√≥n.</p>
            </div>

            <p>En los mercados financieros, los <strong>Bloques de ruptura</strong> operan bajo este mismo principio de
                enga√±o calculado. Un <em>Breaker Block</em> representa una de las herramientas m√°s sofisticadas y
                potentes dentro del arsenal de conceptos <em>Smart Money</em> (ICT). Su poder radica en su capacidad
                para revelar las verdaderas intenciones del <strong>dinero inteligente</strong> cuando ejecuta maniobras
                de manipulaci√≥n dise√±adas para atrapar a traders minoristas.</p>
            <p>En esencia, un Breaker Block es un <strong>Order Block</strong> que ha fallado en sostener el precio y
                que, al ser quebrado, marca un cambio <strong>pivotal</strong> en la estructura y liquidez del mercado.
                Dicho de otro modo, es un Order Block invalidado que pasa a funcionar como nivel de soporte o
                resistencia inverso al original. Este fen√≥meno es similar al concepto cl√°sico de "nivel espejo" en
                an√°lisis t√©cnico, donde un soporte roto se convierte en resistencia (y viceversa).</p>
            <p>¬øPor qu√© es importante este concepto? Porque los mercados no se mueven al azar: detr√°s de bastidores, los
                grandes participantes manipulan precios para <strong>atrapar al p√∫blico</strong>. Los Breaker Blocks
                dejan al descubierto esas trampas, ofreciendo una ventana a la pr√≥xima jugada de las instituciones.
                Identificarlos es, en cierto sentido, como <strong>descifrar un lenguaje secreto</strong> del gr√°fico:
                nos permite posicionarnos del lado correcto de la narrativa institucional, evitando caer en las trampas
                de la codicia y el miedo que el dinero inteligente tiende para el trader desprevenido.</p>
        </section>

        <section>
            <h2>La anatom√≠a de un Breaker Block: Estructura y fases</h2>
            <p>Entender un Breaker Block a profundidad requiere desglosar su <strong>secuencia de formaci√≥n</strong>.
                Podemos dividir el proceso en cuatro fases claras, desde su origen como Order Block inicial hasta su
                transformaci√≥n final en Breaker Block confirmado. Cada etapa revela pistas sobre la intenci√≥n
                institucional y brinda al trader oportunidades espec√≠ficas de actuaci√≥n.</p>

            <!-- IMPROVED INTERACTIVE ANATOMY -->
            <div class="infographic-box interactive" id="anatomy-section">
                <div class="infographic-title"><i class="fas fa-layer-group"></i> Simulador de Mercado: De OB a BB</div>
                <p>Utiliza los controles para avanzar vela a vela y ver la formaci√≥n org√°nica de la trampa.</p>

                <div class="chart-container" id="anatomy-chart">
                    <!-- SVG rendered by JS -->
                </div>

                <div class="controls-area">
                    <button class="btn-interact btn-secondary" onclick="anatomySim.reset()"><i class="fas fa-undo"></i>
                        Reiniciar</button>
                    <div class="step-indicator" id="anatomy-step-text">Fase 1: Formaci√≥n</div>
                    <button class="btn-interact" onclick="anatomySim.nextStep()" id="anatomy-next-btn">Siguiente Fase <i
                            class="fas fa-arrow-right"></i></button>
                </div>
            </div>

            <h3>Fase 1: Formaci√≥n del Order Block inicial</h3>
            <p>Todo Breaker Block comienza su vida como un <strong>Order Block</strong> com√∫n y corriente. Imaginemos
                que el precio est√° subiendo hacia una zona de resistencia claramente definida. Durante este ascenso se
                forma lo que inicialmente parece un Order Block alcista <strong>perfectamente v√°lido</strong>:
                t√≠picamente, una vela bajista de amplio rango ubicada estrat√©gicamente antes de que el precio contin√∫e
                su movimiento ascendente.</p>
            <p>En este punto, muchos traders de metodolog√≠a <em>Smart Money</em> identificar√≠an esa vela como una zona
                de compra. Mentalmente marcan ese nivel: ‚ÄúSi el precio regresa aqu√≠, ser√° una excelente oportunidad de
                compra‚Äù. Esta percepci√≥n es lo que el dinero institucional quiere fomentar. Est√°n <strong>plantando una
                    semilla</strong> que m√°s tarde florecer√° en una trampa.</p>

            <h3>Fase 2: La toma de liquidez ‚Äì El cebo perfecto</h3>
            <p>Aqu√≠ es donde la trama se complica. Tras formarse nuestro Order Block inicial, el precio contin√∫a su
                camino y eventualmente <strong>perfora la resistencia</strong>. Esta ruptura genera una explosi√≥n de
                actividad: stop-loss de vendedores activados y compradores de ruptura entrando. Se produce un verdadero
                <strong>banquete de liquidez</strong>.</p>
            <p>Es crucial comprender que este movimiento no es genuino, sino una maniobra calculada. Puede ser un
                peque√±o <em>pull-up</em> o un rally sustancial que genere FOMO (<em>fear of missing out</em>).</p>

            <h3>Fase 3: El desplazamiento ‚Äì Revelaci√≥n de intenciones</h3>
            <p>Este es el <strong>momento de la verdad</strong>. Tras la toma de liquidez, el precio sufre un
                <strong>desplazamiento violento</strong> en direcci√≥n opuesta. No es un retroceso suave; es r√°pido,
                decisivo y con volumen. El precio atraviesa por completo aquel Order Block alcista de la Fase 1. La zona
                que parec√≠a segura es <strong>violentamente invalidada</strong>.</p>
            <p>Estructuralmente, esto marca un cambio de car√°cter (<em>market structure shift</em>). Hemos tenido una
                <em>liquidity grab</em> seguida de un quiebre de estructura.</p>

            <h3>Fase 4: La transformaci√≥n ‚Äì De Order Block a Breaker Block</h3>
            <p>Al romperse el OB original, ocurre la transformaci√≥n. Lo que era soporte potencial ahora es resistencia.
                El Order Block ha mutado en un <strong>Breaker Block</strong>. Los traders que compraron est√°n atrapados
                en p√©rdidas. La antigua zona de demanda es ahora un im√°n de oferta.</p>
            <div class="glossary-item">
                <strong>Definici√≥n T√©cnica:</strong> Un Breaker Block es el √°rea de un Order Block que, al ser rota sin
                producir el rebote esperado, invierte su rol de soporte/resistencia.
            </div>
        </section>

        <!-- NEW SECTION: BREAKER VS MITIGATION -->
        <section>
            <h2>Distinci√≥n Cr√≠tica: Breaker Block vs. Mitigation Block</h2>
            <p>Uno de los errores m√°s comunes en el trading institucional es confundir el Breaker Block con su "primo
                hermano", el <strong>Mitigation Block</strong>. Aunque ambos implican Order Blocks fallidos que
                invierten su polaridad, la estructura de precios que los precede es fundamentalmente distinta.</p>
            <p>La diferencia radica en la <strong>toma de liquidez</strong> (Liquidity Sweep). Un Breaker Block
                <em>siempre</em> rompe el m√°ximo anterior (en una estructura bajista) antes de caer, "cazando" los
                stops. Un Mitigation Block, por el contrario, falla en hacer un nuevo alto (hace un alto m√°s bajo) antes
                de romper la estructura. El Mitigation Block ocurre en una estructura de fallo, mientras que el Breaker
                ocurre en una estructura de manipulaci√≥n.</p>

            <div class="infographic-box interactive">
                <div class="infographic-title"><i class="fas fa-balance-scale"></i> Comparador Estructural</div>
                <p>Alterna entre ambos modelos para visualizar la diferencia clave en los m√°ximos (Swing Highs).</p>

                <div class="controls-area" style="margin-bottom: 20px;">
                    <button class="btn-interact active-btn" id="btn-breaker"
                        onclick="toggleMitigationVsBreaker('breaker')">Breaker Block</button>
                    <button class="btn-interact btn-secondary" id="btn-mitigation"
                        onclick="toggleMitigationVsBreaker('mitigation')">Mitigation Block</button>
                </div>

                <div class="chart-container" id="mitigation-chart">
                    <!-- SVG rendered by JS -->
                </div>

                <div class="glossary-item" id="mitigation-text">
                    <strong>Breaker Block:</strong> Nota c√≥mo el precio supera el m√°ximo anterior (Liquidity Grab) antes
                    de romper el soporte. Es una trampa de compradores.
                </div>
            </div>
        </section>

        <section>
            <h2>La psicolog√≠a detr√°s del Breaker Block: Entendiendo la manipulaci√≥n</h2>
            <div class="cards-grid">
                <div class="info-card">
                    <h4><i class="fas fa-user-tie"></i> El Institucional</h4>
                    <p>Necesita vender millones. No puede hacerlo de golpe sin mover el precio en su contra. Soluci√≥n:
                        Crear una ilusi√≥n alcista (cebo), romper resistencia (atraer compradores) y vender agresivamente
                        contra esa euforia.</p>
                </div>
                <div class="info-card">
                    <h4><i class="fas fa-users"></i> El Minorista</h4>
                    <p>Sufre un vaiv√©n emocional. Primero <strong>Codicia</strong> (compra la ruptura falsa) y luego
                        <strong>Miedo</strong> (p√°nico cuando el precio se desploma). El Breaker Block es el monumento a
                        estas emociones.</p>
                </div>
            </div>
            <p style="margin-top: 20px;">Donde la mayor√≠a ve un fallo inesperado del nivel, el trader informado ve una
                <strong>maniobra deliberada</strong>. Donde otros ven caos, nosotros vemos el <strong>orden
                    oculto</strong> dise√±ado por las ‚Äúmanos fuertes‚Äù.</p>
        </section>

        <section>
            <h2>El retorno al Breaker Block: La oportunidad de oro</h2>
            <p>Una de las caracter√≠sticas m√°s fascinantes es la alta probabilidad de que el precio regrese a testear el
                Breaker Block. ¬øPor qu√©? Porque el dinero inteligente a menudo necesita <strong>cerrar posiciones de
                    enga√±o</strong> y mitigar p√©rdidas de la maniobra inicial. Adem√°s, los traders atrapados ruegan por
                un retorno a <em>breakeven</em> para salir, generando liquidez.</p>

            <div class="pull-quote">
                ‚ÄúEl Breaker Block realmente cobra vida en el retesteo.‚Äù
            </div>

            <h3>Identificando un retorno v√°lido</h3>
            <ul>
                <li><strong>Debilidad en el acercamiento:</strong> El precio debe llegar mostrando agotamiento, no con
                    impulso explosivo.</li>
                <li><strong>Se√±ales de rechazo:</strong> En temporalidades menores, buscar mechas, <em>pin bars</em> o
                    cambios de car√°cter al tocar la zona.</li>
                <li><strong>Volumen an√≥malo:</strong> Un incremento de volumen al tocar la zona confirma que las
                    instituciones est√°n defendiendo el nivel.</li>
            </ul>

            <h3>El momento de la entrada</h3>
            <p>Entrar requiere <strong>precisi√≥n quir√∫rgica</strong>. La forma m√°s com√∫n es colocar √≥rdenes l√≠mite en el
                borde del Breaker Block (el cuerpo de la vela original).
                <br><em>Ejemplo:</em> Si es un BB bajista, orden de venta en la parte superior del cuerpo de la vela que
                formaba el OB original.
            </p>
        </section>

        <section>
            <h2>Gesti√≥n del riesgo en operaciones con Breaker Blocks</h2>
            <p>Dada la agresividad de estos movimientos, la gesti√≥n de riesgo es vital.</p>

            <div class="infographic-box interactive" style="background: #fff8e1; border-color: #ffc107;">
                <div class="infographic-title" style="background: #ffecb3; color: #ff6f00;"><i
                        class="fas fa-shield-alt"></i> Calculadora Visual de Riesgo</div>

                <div class="risk-calculator">
                    <!-- Controls Side -->
                    <div class="risk-controls">
                        <h5 style="margin-top:0;">Selecciona tu perfil de riesgo:</h5>
                        <label style="display: flex; align-items: center; margin-bottom: 15px; cursor: pointer;">
                            <input type="radio" name="riskProfile" value="conservative" checked
                                onchange="updateRiskVisual('conservative')">
                            <div style="margin-left: 10px;">
                                <strong>üõ°Ô∏è Conservador</strong><br>
                                <small>Stop Loss amplio por encima del m√°ximo. Menor riesgo de barrido, menor retorno
                                    potencial.</small>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="riskProfile" value="aggressive"
                                onchange="updateRiskVisual('aggressive')">
                            <div style="margin-left: 10px;">
                                <strong>‚öîÔ∏è Agresivo</strong><br>
                                <small>Stop Loss ajustado al 50% del bloque. Alto retorno potencial, mayor riesgo de
                                    stop-out.</small>
                            </div>
                        </label>
                    </div>

                    <!-- Visual Side -->
                    <div class="risk-visual" id="risk-chart-container">
                        <!-- SVG rendered by JS -->
                    </div>
                </div>

                <p style="text-align: center; margin-top: 15px; font-size: 0.9rem;"><strong>Tip Pro:</strong> Muchos
                    traders SMC buscan un ratio m√≠nimo de 3:1 en estas configuraciones.</p>
            </div>
        </section>

        <section>
            <h2>Tipos de Breaker Blocks y Confluencias</h2>
            <p>No todos los contextos son iguales. Distinguimos entre:</p>
            <ul>
                <li><strong>BB de Inicio de Tendencia:</strong> Se forman en giros mayores (semanales/mensuales) tras
                    barrer liquidez hist√≥rica. Son los m√°s potentes.</li>
                <li><strong>BB de Continuaci√≥n:</strong> Aparecen dentro de una tendencia establecida. Ofrecen
                    re-entradas frecuentes pero recorridos m√°s cortos.</li>
            </ul>

            <h3>Confluencias que fortalecen el setup</h3>
            <p>Un BB gana fuerza exponencial cuando se alinea con:</p>
            <ol>
                <li><strong>Temporalidades superiores:</strong> Un BB de M15 coincidiendo con un nivel clave H4.</li>
                <li><strong>Fair Value Gaps (FVG):</strong> Si el BB contiene o est√° junto a un FVG, act√∫a como doble
                    im√°n.</li>
                <li><strong>Fibonacci:</strong> Coincidencia con niveles 61.8% o 78.6% (OTE).</li>
                <li><strong>Volumen:</strong> Respaldo de actividad institucional visible.</li>
            </ol>
        </section>

        <!-- NEW SECTION: THE UNICORN MODEL -->
        <section>
            <h2>Estrategia Avanzada: El "Modelo Unicornio"</h2>
            <p>Dentro de la comunidad SMC, existe un setup espec√≠fico que es reverenciado por su alt√≠sima probabilidad
                de √©xito: la confluencia perfecta entre un <strong>Breaker Block</strong> y un <strong>Fair Value Gap
                    (FVG)</strong>. A esta configuraci√≥n se la conoce cari√±osamente como el "Modelo Unicornio".</p>
            <p>¬øPor qu√© es tan potente? Porque combina dos l√≥gicas institucionales: la mitigaci√≥n de √≥rdenes atrapadas
                (Breaker) y el rebalanceo de ineficiencias de precio (FVG). Cuando estas dos zonas se solapan, crean un
                "muro" de resistencia o soporte extremadamente dif√≠cil de atravesar.</p>

            <div class="infographic-box interactive" style="border-color: var(--purple-accent);">
                <div class="infographic-title" style="background: #ede7f6; color: var(--purple-accent);"><i
                        class="fas fa-magic"></i> Anatom√≠a del Unicornio</div>
                <p>Observa c√≥mo el Fair Value Gap (zona sombreada) se alinea perfectamente con el nivel del Breaker
                    Block.</p>

                <div class="chart-container" id="unicorn-chart">
                    <!-- SVG rendered by JS -->
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <span class="chapter-badge" style="background: var(--purple-accent);">Breaker Block + FVG = Unicorn
                        Setup</span>
                </div>
            </div>
        </section>

        <section>
            <h2>Casos de Estudio y Ejemplos Pr√°cticos</h2>

            <div class="infographic-box interactive">
                <div class="infographic-title"><i class="fas fa-chart-line"></i> Galer√≠a de Setups Reales</div>
                <p>Explora tres escenarios cl√°sicos de mercado donde los Breaker Blocks fueron protagonistas.</p>

                <div class="tabs-header">
                    <button class="tab-btn active" onclick="openCase(event, 'case1')">EUR/USD (Bajista)</button>
                    <button class="tab-btn" onclick="openCase(event, 'case2')">XAU/USD (Giro)</button>
                    <button class="tab-btn" onclick="openCase(event, 'case3')">QQQ (Alcista)</button>
                </div>

                <!-- Case 1 -->
                <div id="case1" class="tab-content active">
                    <div class="chart-container" id="chart-eurusd"></div>
                    <div class="glossary-item">
                        <strong>An√°lisis:</strong> El precio crea un OB, rompe falsamente al alza (trampa de compradores
                        en 1.0975), se desploma rompiendo el OB (creando el BB en 1.0920) y al regresar es rechazado
                        violentamente.
                    </div>
                </div>

                <!-- Case 2 -->
                <div id="case2" class="tab-content">
                    <div class="chart-container" id="chart-xauusd"></div>
                    <div class="glossary-item">
                        <strong>An√°lisis:</strong> Oro en m√°ximos hist√≥ricos ($2,150). Hace un <em>double top raid</em>
                        a $2,165. La vela bajista masiva rompe el OB de H4. Entrada en $2,135 (confluencia con FVG).
                    </div>
                </div>

                <!-- Case 3 -->
                <div id="case3" class="tab-content">
                    <div class="chart-container" id="chart-qqq"></div>
                    <div class="glossary-item">
                        <strong>An√°lisis:</strong> Un OB bajista en $375 falla y es roto al alza con volumen. Semanas
                        despu√©s, el precio regresa a $375 y lo usa como trampol√≠n para nuevos m√°ximos.
                    </div>
                </div>
            </div>
        </section>

        <section>
            <h2>Errores comunes y refinamiento</h2>
            <div class="glossary-item" style="background: #fff3e0; border-color: #ff9800;">
                <strong>‚ö†Ô∏è Identificaci√≥n Prematura:</strong> Marcar el BB antes de que el precio haya roto con
                decisi√≥n. Debes esperar la secuencia completa.
            </div>
            <div class="glossary-item" style="background: #fff3e0; border-color: #ff9800;">
                <strong>‚ö†Ô∏è Ignorar Contexto:</strong> Operar contra una tendencia fuerte sin apoyo de temporalidades
                mayores es "pararse frente a un tren".
            </div>
            <div class="glossary-item" style="background: #fff3e0; border-color: #ff9800;">
                <strong>‚ö†Ô∏è FOMO:</strong> Entrar antes de que el precio toque la zona por miedo a perder el trade.
                Espera el toque y el rechazo.
            </div>

            <h3>Refinamiento avanzado: BB Anidados y Fallidos</h3>
            <p>En mercados complejos, puedes encontrar <strong>Breaker Blocks Anidados</strong> (un BB de H4 dentro de
                un BB Diario). Ofrecen precisi√≥n milim√©trica. Por otro lado, un <strong>BB Fallido</strong> (uno que es
                atravesado sin respeto) es una se√±al poderosa de que la tendencia es abrumadora en esa direcci√≥n,
                invit√°ndonos a invertir nuestro sesgo.</p>
        </section>

        <section>
            <h2>Conclusi√≥n: Dominando el arte</h2>
            <p>Los Breaker Blocks no son simplemente niveles t√©cnicos; son mapas de ruta de la l√≥gica institucional.
                Dominarlos implica desarrollar una <strong>comprensi√≥n intuitiva</strong> del sacrificio de ajedrez
                financiero. Requiere paciencia, humildad para aceptar cuando fallan, y disciplina.</p>
            <p>A medida que avances, dejar√°s de ver "invalidaciones" y empezar√°s a ver oportunidades. Donde la mayor√≠a
                ve confusi√≥n, t√∫ ver√°s claridad. Esa es tu verdadera ventaja.</p>
        </section>

        <section class="ai-section-wrapper">
            <div class="infographic-title" style="background: none; padding: 0;">
                <i class="fas fa-robot fa-2x" style="color: var(--ai-accent);"></i>
                <h3 style="margin: 0; margin-left: 10px; color: #4527a0;">Mentor Virtual SMC (Powered by Gemini)</h3>
            </div>
            <p>Pon a prueba tu conocimiento con el <strong>Generador de Quizzes Infinitos</strong> o utiliza el
                <strong>Analizador de Escenarios</strong> para validar tus ideas de trading.</p>

            <div class="infographic-box" style="margin-top: 20px;">

                <!-- DYNAMIC QUIZ SECTION -->
                <div id="quiz-container">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 id="quiz-header" style="color: var(--dark-teal); margin: 0;">Quiz de Entrenamiento SMC</h4>
                        <button class="ai-btn-sm" id="generate-quiz-btn" onclick="generateDynamicQuiz()">
                            <i class="fas fa-random"></i> Generar Nueva Pregunta
                        </button>
                    </div>

                    <div id="quiz-content">
                        <p style="font-size: 1.1rem; font-weight: 600;" id="quiz-question-text">
                            Haz clic en "Generar Nueva Pregunta" para que la IA cree un desaf√≠o √∫nico basado en el
                            contenido de este cap√≠tulo.
                        </p>
                        <div id="quiz-options" class="btn-group"
                            style="flex-direction: column; align-items: flex-start; gap: 10px;">
                            <!-- Options will be injected here -->
                        </div>
                    </div>

                    <div id="quiz-feedback"
                        style="margin-top: 20px; display: none; padding: 20px; border-radius: 8px; animation: fadeIn 0.5s;">
                    </div>
                </div>

                <hr style="border: 0; border-top: 1px solid #d1c4e9; margin: 30px 0;">

                <!-- SCENARIO ANALYZER SECTION -->
                <div id="scenario-analyzer">
                    <h4 style="color: var(--dark-teal); margin-bottom: 10px;">
                        <i class="fas fa-search-dollar"></i> Analizador de Escenarios
                    </h4>
                    <p style="font-size: 0.9rem;">Describe con tus propias palabras lo que ves en el gr√°fico y la IA te
                        dir√° si cumple las reglas de un Breaker Block.</p>

                    <div class="scenario-box">
                        <textarea id="scenario-input" class="scenario-textarea"
                            placeholder="Ejemplo: El precio ven√≠a bajando, hizo un m√≠nimo en 1.0500, luego subi√≥ rompiendo el √∫ltimo alto en 1.0550, y ahora est√° cayendo fuerte rompiendo el m√≠nimo de 1.0500..."></textarea>
                        <button class="ai-btn-sm" onclick="analyzeScenario()" id="analyze-btn">
                            <i class="fas fa-microscope"></i> Analizar Setup
                        </button>
                        <div id="scenario-feedback" class="scenario-feedback"></div>
                    </div>
                </div>

                <hr style="border: 0; border-top: 1px solid #d1c4e9; margin: 30px 0;">

                <!-- CHAT INTERFACE -->
                <div class="ai-chat-interface">
                    <h4 style="margin:0; color: #512da8;"><i class="fas fa-comments"></i> Chat con el Analista</h4>
                    <div class="ai-chat-box" id="ai-chat-box">
                        <div class="chat-message ai">
                            Hola, soy tu mentor de trading IA. Preg√∫ntame sobre Breaker Blocks, Estructura de Mercado o
                            Gesti√≥n de Riesgo.
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="user-input" class="chat-input"
                            placeholder="Ej: ¬øCu√°l es la diferencia entre BB alcista y bajista?..."
                            onkeypress="handleKeyPress(event)">
                        <button id="send-btn" class="chat-send-btn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <footer class="main-footer">
            <div class="footer-logo">
                <div class="logo-placeholder" style="font-size: 2rem;">KawnBit</div>
            </div>
            <p>&copy; <span id="current-year"></span> KawnBit Magazine. Todos los derechos reservados.</p>
        </footer>

        <!-- Summary Modal Structure -->
        <div class="summary-overlay" id="summary-overlay">
            <div class="summary-card">
                <button class="summary-close" onclick="closeSummary()">&times;</button>
                <h3 style="color: var(--ai-accent); display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-sparkles"></i> Resumen Ejecutivo IA
                </h3>
                <div id="summary-content">
                    <p>Generando resumen inteligente de los puntos clave...</p>
                    <div class="loading-dots" style="font-size: 2rem; color: var(--ai-accent); text-align: center;">
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPT SECTION -->
    <script>
        const proxyUrl = "/.netlify/functions/gemini-proxy";

        async function callGemini(prompt, systemInstruction = "", useJson = false) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: useJson ? { responseMimeType: "application/json" } : {}
            };

            // Exponential Backoff Implementation
            let retries = 5;
            let delay = 1000;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const data = await response.json();

                        // Extraemos la respuesta de la estructura de Gemini o del campo result del proxy
                        if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                            return data.candidates[0].content.parts[0].text;
                        }
                        return data.result || "La IA no devolvi√≥ una respuesta v√°lida.";

                    } else if (response.status === 429 || response.status >= 500) {
                        // Retryable error
                        console.warn(`Proxy call failed with status ${response.status}. Retrying in ${delay}ms...`);
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        console.error("Gemini Proxy Error:", errorData);
                        throw new Error(`Error en el Proxy: ${response.status}`);
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) throw error;
                }

                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
            }

            return null;
        }

        // --- SUMMARY FEATURE ---
        async function generateSummary() {
            const overlay = document.getElementById('summary-overlay');
            const contentDiv = document.getElementById('summary-content');
            const btn = document.getElementById('summary-btn');

            if (btn) btn.disabled = true;

            overlay.style.display = 'flex';
            contentDiv.innerHTML = '<p>Analizando el cap√≠tulo y extrayendo conceptos clave...</p><div class="loading-dots" style="font-size: 2rem; color: var(--ai-accent); text-align: center;"></div>';

            const pageText = document.body.innerText.replace(/\s+/g, ' ').substring(0, 15000);
            const prompt = `Analiza el siguiente texto sobre "Breaker Blocks" y genera 3 puntos clave (bullet points) que resuman lo m√°s importante para un trader. S√© conciso y usa formato HTML (<ul><li>...). Texto: ${pageText}`;

            try {
                const summary = await callGemini(prompt, "Eres un experto en res√∫menes financieros. Responde en espa√±ol y ve directo al grano.");
                if (summary) {
                    contentDiv.innerHTML = summary;
                } else {
                    contentDiv.innerHTML = `<div style="color: var(--danger-dark); text-align: center;">Error al generar el resumen. Intente nuevamente.</div>`;
                }
            } catch (e) {
                contentDiv.innerHTML = `<div style="color: var(--danger-dark); text-align: center;">Error de conexi√≥n.</div>`;
            }

            if (btn) btn.disabled = false;
        }

        function closeSummary() {
            document.getElementById('summary-overlay').style.display = 'none';
        }

        // --- DYNAMIC QUIZ FEATURE ---
        async function generateDynamicQuiz() {
            const btn = document.getElementById('generate-quiz-btn');
            const questionText = document.getElementById('quiz-question-text');
            const optionsContainer = document.getElementById('quiz-options');
            const feedbackDiv = document.getElementById('quiz-feedback');

            // UI Loading State
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando...';
            feedbackDiv.style.display = 'none';
            optionsContainer.innerHTML = '';
            questionText.innerHTML = '<span class="loading-dots" style="color: var(--ai-accent)">Creando desaf√≠o √∫nico</span>';

            // Context
            const pageText = document.body.innerText.replace(/\s+/g, ' ').substring(0, 10000);

            const prompt = `Genera una pregunta de opci√≥n m√∫ltiple (quiz) sobre "Breaker Blocks" basada en el texto proporcionado. 
        Nivel: Intermedio/Avanzado. 
        Formato JSON requerido: { "question": "string", "options": ["string", "string", "string"], "correctIndex": number (0-2), "explanation": "string" }.
        Texto: ${pageText}`;

            try {
                const rawResponse = await callGemini(prompt, "Eres un profesor de trading estricto. Genera solo JSON v√°lido.", true);

                if (rawResponse) {
                    // Clean markdown code blocks if present
                    const cleanJson = rawResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                    const quizData = JSON.parse(cleanJson);
                    renderQuiz(quizData);
                } else {
                    questionText.innerText = "Error de conexi√≥n con la IA.";
                }
            } catch (e) {
                console.error("Quiz Error", e);
                questionText.innerText = "Error al procesar el quiz. Por favor intenta de nuevo.";
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-random"></i> Generar Nueva Pregunta';
        }

        function renderQuiz(data) {
            document.getElementById('quiz-question-text').innerText = data.question;
            const optionsContainer = document.getElementById('quiz-options');

            data.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn-interact btn-secondary';
                btn.style.width = '100%';
                btn.style.textAlign = 'left';
                btn.style.justifyContent = 'flex-start';
                btn.innerHTML = `<span style="background: #eee; padding: 2px 8px; border-radius: 4px; margin-right: 10px;">${String.fromCharCode(65 + index)}</span> ${opt}`;

                btn.onclick = () => handleQuizAnswer(index, data.correctIndex, data.explanation, btn);
                optionsContainer.appendChild(btn);
            });
        }

        function handleQuizAnswer(selectedIndex, correctIndex, explanation, btnElement) {
            const feedback = document.getElementById('quiz-feedback');
            const allBtns = btnElement.parentElement.querySelectorAll('button');

            allBtns.forEach(b => b.disabled = true);

            feedback.style.display = 'block';

            if (selectedIndex === correctIndex) {
                btnElement.style.background = '#e8f5e9';
                btnElement.style.border = '2px solid #2e7d32';
                feedback.style.background = '#e8f5e9';
                feedback.style.color = '#2e7d32';
                feedback.innerHTML = `<strong>¬°Correcto!</strong><br>${explanation}`;
            } else {
                btnElement.style.background = '#ffebee';
                btnElement.style.border = '2px solid #c62828';
                // Highlight correct one
                allBtns[correctIndex].style.background = '#e8f5e9';
                allBtns[correctIndex].style.border = '2px solid #2e7d32';

                feedback.style.background = '#ffebee';
                feedback.style.color = '#c62828';
                feedback.innerHTML = `<strong>Incorrecto.</strong><br>${explanation}`;
            }
        }

        // --- SCENARIO ANALYZER FEATURE ---
        async function analyzeScenario() {
            const input = document.getElementById('scenario-input');
            const btn = document.getElementById('analyze-btn');
            const feedback = document.getElementById('scenario-feedback');
            const text = input.value.trim();

            if (!text) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analizando...';
            feedback.style.display = 'block';
            feedback.innerHTML = '<span class="loading-dots">Consultando al Mentor Virtual</span>';

            const prompt = `Analiza esta descripci√≥n de un escenario de mercado: "${text}".
        Act√∫a como un mentor de Smart Money Concepts. Eval√∫a si describe correctamente un Breaker Block (alcista o bajista).
        Requisitos para BB v√°lido: 1. Toma de liquidez (Sweep), 2. Desplazamiento fuerte (Break of Structure), 3. Retorno a la zona rota.
        S√© directo y educativo.`;

            try {
                const response = await callGemini(prompt, "Eres un analista t√©cnico experto. Responde en espa√±ol.");
                if (response) {
                    feedback.innerHTML = formatText(response);
                } else {
                    feedback.innerHTML = "Error al analizar el escenario.";
                }
            } catch (e) {
                feedback.innerHTML = "Error de conexi√≥n.";
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-microscope"></i> Analizar Setup';
        }

        // --- CHAT FEATURE ---
        const chatSystemPrompt = "Eres un mentor experto en trading institucional y Smart Money Concepts (SMC). Tu objetivo es explicar conceptos complejos como Breaker Blocks, Order Blocks y Liquidez de forma clara, profesional y educativa. Usa analog√≠as cuando sea posible. Responde siempre en Espa√±ol. S√© conciso.";

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        // Improved text formatter
        function formatText(str) {
            if (!str) return '';
            // 1. Escape HTML to prevent XSS
            let safeStr = str.replace(/[&<>'"]/g, tag => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
            }[tag]));

            // 2. Bold (**text**)
            safeStr = safeStr.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // 3. Lists (- item)
            safeStr = safeStr.replace(/^- (.*)/gm, '<li>$1</li>');
            safeStr = safeStr.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>'); // Simple list wrapper attempt

            // 4. Newlines to <br>
            safeStr = safeStr.replace(/\n/g, '<br>');

            return safeStr;
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const chatBox = document.getElementById('ai-chat-box');
            const sendBtn = document.getElementById('send-btn');
            const message = input.value.trim();

            if (!message) return;

            input.disabled = true;
            sendBtn.disabled = true;

            const userDiv = document.createElement('div');
            userDiv.className = 'chat-message user';
            userDiv.textContent = message;
            chatBox.appendChild(userDiv);
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message ai loading-dots';
            chatBox.appendChild(loadingDiv);
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await callGemini(message, chatSystemPrompt);

                if (chatBox.contains(loadingDiv)) chatBox.removeChild(loadingDiv);

                const aiDiv = document.createElement('div');
                aiDiv.className = 'chat-message ai';

                if (response) {
                    aiDiv.innerHTML = formatText(response);
                } else {
                    aiDiv.innerHTML = '<span style="color: #d32f2f;">Error de conexi√≥n.</span>';
                }
                chatBox.appendChild(aiDiv);
            } catch (e) {
                if (chatBox.contains(loadingDiv)) chatBox.removeChild(loadingDiv);
            }

            chatBox.scrollTop = chatBox.scrollHeight;
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }

        // --- CHART DRAWING UTILITIES ---
        // Helper to draw candle sticks on SVG
        function createSVGElement(tag, attrs) {
            const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
            for (const [key, value] of Object.entries(attrs)) {
                el.setAttribute(key, value);
            }
            return el;
        }

        function drawCandle(svg, x, open, high, low, close, width = 10, id = null) {
            const isGreen = close >= open;
            const colorClass = isGreen ? 'candle-green' : 'candle-red';
            const group = createSVGElement('g', { class: 'candle-group' });
            if (id) group.id = id;

            // Wick
            const wick = createSVGElement('line', {
                x1: x + width / 2, y1: high,
                x2: x + width / 2, y2: low,
                class: `candle-wick ${colorClass}`
            });

            // Body
            const bodyY = isGreen ? close : open;
            const bodyHeight = Math.abs(close - open) || 1; // min height 1px
            const body = createSVGElement('rect', {
                x: x, y: Math.min(open, close),
                width: width, height: bodyHeight,
                class: `candle-body ${colorClass}`
            });

            group.appendChild(wick);
            group.appendChild(body);
            svg.appendChild(group);
            return group;
        }

        // --- ANATOMY SIMULATOR LOGIC ---
        const anatomySim = {
            step: 0,
            svg: null,
            data: [
                // Setup phase (uptrend)
                { o: 150, c: 140, h: 135, l: 155 }, { o: 140, c: 130, h: 125, l: 145 },
                { o: 130, c: 140, h: 125, l: 145 }, // Small pullback
                { o: 140, c: 120, h: 115, l: 145 }, // Expansion
                // THE OB (Down candle before up)
                { o: 120, c: 135, h: 118, l: 138, isOB: true },
                // Rally (Liquidity grab)
                { o: 135, c: 100, h: 95, l: 138 }, { o: 100, c: 80, h: 75, l: 105 },
                { o: 80, c: 50, h: 40, l: 85 }, // Top wick grab
                // Displacement (Break down)
                { o: 50, c: 90, h: 45, l: 95 }, // Start reversal
                { o: 90, c: 160, h: 85, l: 165, isBreak: true }, // BIG DROP breaking OB
                // Retest
                { o: 160, c: 150, h: 145, l: 165 }, { o: 150, c: 140, h: 135, l: 155 }, // Slow up
                { o: 140, c: 125, h: 120, l: 145, isEntry: true }, // Tap into OB area
                // Expansion down
                { o: 125, c: 180, h: 120, l: 185 }, { o: 180, c: 220, h: 175, l: 230 }
            ],

            init: function () {
                const container = document.getElementById('anatomy-chart');
                if (!container) return; // Safety check

                container.innerHTML = '';
                this.svg = createSVGElement('svg', { viewBox: "0 0 600 300", class: "svg-chart" });

                // Draw grid lines
                for (let i = 0; i < 300; i += 50) {
                    this.svg.appendChild(createSVGElement('line', {
                        x1: 0, y1: i, x2: 600, y2: i, stroke: '#2a2e39', 'stroke-width': 1
                    }));
                }

                container.appendChild(this.svg);
                this.reset();
            },

            reset: function () {
                this.step = 0;
                this.updateView();
            },

            nextStep: function () {
                if (this.step < 4) {
                    this.step++;
                    this.updateView();
                }
            },

            updateView: function () {
                if (!this.svg) return;

                // Clear candles but keep grid
                const candles = this.svg.querySelectorAll('.candle-group, .annotation');
                candles.forEach(c => c.remove());

                const btn = document.getElementById('anatomy-next-btn');
                const txt = document.getElementById('anatomy-step-text');

                let limit = 0;
                // Define how many candles to show per step
                if (this.step === 0) { // Start
                    limit = 5;
                    if (txt) txt.textContent = "Inicio: Estructura Alcista";
                    if (btn) { btn.disabled = false; btn.innerHTML = 'Siguiente Fase <i class="fas fa-arrow-right"></i>'; }
                } else if (this.step === 1) { // OB Formed
                    limit = 5;
                    this.drawZone(120, 138, 'OB (Soporte)');
                    if (txt) txt.textContent = "Fase 1: Formaci√≥n del OB";
                } else if (this.step === 2) { // Liq Grab
                    limit = 8;
                    this.drawZone(120, 138, 'OB (Soporte)');
                    this.drawLine(40, "Liquidity Pool", "red");
                    if (txt) txt.textContent = "Fase 2: Toma de Liquidez";
                } else if (this.step === 3) { // Break
                    limit = 10;
                    this.drawZone(120, 138, 'Breaker Block (Resistencia)');
                    if (txt) txt.textContent = "Fase 3: Desplazamiento (Rotura)";
                } else if (this.step === 4) { // Retest
                    limit = this.data.length;
                    this.drawZone(120, 138, 'Breaker Block (Resistencia)');
                    this.drawEntry(125);
                    if (txt) txt.textContent = "Fase 4: Retest y Entrada";
                    if (btn) { btn.disabled = true; btn.innerHTML = 'Completado <i class="fas fa-check"></i>'; }
                }

                // Render loop
                let x = 20;
                const spacing = 40;
                for (let i = 0; i < limit; i++) {
                    drawCandle(this.svg, x, this.data[i].o, this.data[i].h, this.data[i].l, this.data[i].c, 20);
                    x += spacing;
                }
            },

            drawZone: function (y1, y2, text) {
                const rect = createSVGElement('rect', {
                    x: 0, y: y1, width: 600, height: y2 - y1,
                    fill: 'var(--primary-teal)', 'fill-opacity': 0.2,
                    class: 'annotation'
                });
                const label = createSVGElement('text', {
                    x: 10, y: y1 - 5, fill: 'var(--primary-teal)', 'font-size': 12, 'font-weight': 'bold',
                    class: 'annotation'
                });
                label.textContent = text;
                this.svg.appendChild(rect);
                this.svg.appendChild(label);
            },

            drawLine: function (y, text, color) {
                const line = createSVGElement('line', {
                    x1: 0, y1: y, x2: 600, y2: y,
                    stroke: color, 'stroke-dasharray': '5,5', 'stroke-width': 2,
                    class: 'annotation'
                });
                const label = createSVGElement('text', {
                    x: 400, y: y - 5, fill: color, 'font-size': 12,
                    class: 'annotation'
                });
                label.textContent = text;
                this.svg.appendChild(line);
                this.svg.appendChild(label);
            },

            drawEntry: function (y) {
                const circle = createSVGElement('circle', {
                    cx: 430, cy: y, r: 6, fill: '#ef5350', stroke: 'white', 'stroke-width': 2,
                    class: 'annotation'
                });
                const label = createSVGElement('text', {
                    x: 440, y: y + 4, fill: '#ef5350', 'font-size': 12, 'font-weight': 'bold',
                    class: 'annotation'
                });
                label.textContent = "SELL ENTRY";
                this.svg.appendChild(circle);
                this.svg.appendChild(label);
            }
        };

        // --- MITIGATION VS BREAKER LOGIC ---
        function toggleMitigationVsBreaker(type) {
            const container = document.getElementById('mitigation-chart');
            const textDiv = document.getElementById('mitigation-text');
            const btnBreaker = document.getElementById('btn-breaker');
            const btnMitigation = document.getElementById('btn-mitigation');

            if (!container) return; // Safety check

            container.innerHTML = '';
            const svg = createSVGElement('svg', { viewBox: "0 0 600 250", class: "svg-chart" });

            // Buttons State
            if (type === 'breaker') {
                btnBreaker.classList.add('active-btn');
                btnBreaker.classList.remove('btn-secondary');
                btnMitigation.classList.remove('active-btn');
                btnMitigation.classList.add('btn-secondary');
                textDiv.innerHTML = '<strong>Breaker Block:</strong> El precio hace un <strong>Alto M√°s Alto (HH)</strong> cazando liquidez antes de romper. Es una trampa institucional.';
            } else {
                btnMitigation.classList.add('active-btn');
                btnMitigation.classList.remove('btn-secondary');
                btnBreaker.classList.remove('active-btn');
                btnBreaker.classList.add('btn-secondary');
                textDiv.innerHTML = '<strong>Mitigation Block:</strong> El precio hace un <strong>Alto M√°s Bajo (LH)</strong> (fallo de estructura) antes de romper. No hay toma de liquidez del m√°ximo anterior.';
            }

            // Draw Candles
            // Base Setup (Common)
            let candles = [
                { o: 200, c: 180, h: 170, l: 205 }, { o: 180, c: 160, h: 155, l: 185 }, // Down Trend
                { o: 160, c: 190, h: 155, l: 195 }, { o: 190, c: 210, h: 185, l: 215 }, // Pullback
                { o: 210, c: 180, h: 175, l: 215 }, // THE OB (Down candle)
            ];

            if (type === 'breaker') {
                // Breaker Logic: Rally to Higher High (HH) > 200 (Previous high start)
                candles.push({ o: 180, c: 120, h: 110, l: 185 }); // Rally UP aggressive
                candles.push({ o: 120, c: 100, h: 90, l: 125 });  // Peak HH (Sweep)
                // Crash
                candles.push({ o: 100, c: 230, h: 95, l: 235 }); // Break Structure
            } else {
                // Mitigation Logic: Rally to Lower High (LH) < 200
                candles.push({ o: 180, c: 140, h: 135, l: 185 }); // Rally UP weaker
                candles.push({ o: 140, c: 130, h: 125, l: 145 }); // Peak LH (No Sweep)
                // Crash
                candles.push({ o: 130, c: 230, h: 125, l: 235 }); // Break Structure
            }

            // Retest (Common)
            candles.push({ o: 230, c: 200, h: 195, l: 235 });
            candles.push({ o: 200, c: 180, h: 175, l: 205 }); // Retest OB area

            let x = 30;
            candles.forEach(c => {
                drawCandle(svg, x, c.o, c.h, c.l, c.c, 30);
                x += 50;
            });

            // Annotations
            // Draw Line at Swing High of Start
            const startHigh = 170;
            const line = createSVGElement('line', {
                x1: 0, y1: startHigh, x2: 600, y2: startHigh, stroke: '#ccc', 'stroke-dasharray': '4'
            });
            svg.appendChild(line);

            if (type === 'breaker') {
                // Mark the Sweep
                const circle = createSVGElement('circle', { cx: 280, cy: 90, r: 15, fill: 'none', stroke: 'var(--danger)', 'stroke-width': 2 });
                const txt = createSVGElement('text', { x: 300, y: 90, fill: 'var(--danger)', 'font-weight': 'bold' });
                txt.textContent = "Liquidity Sweep (HH)";
                svg.appendChild(circle);
                svg.appendChild(txt);
            } else {
                // Mark the Failure
                const circle = createSVGElement('circle', { cx: 280, cy: 125, r: 15, fill: 'none', stroke: 'var(--text-grey)', 'stroke-width': 2 });
                const txt = createSVGElement('text', { x: 300, y: 125, fill: 'var(--text-grey)', 'font-weight': 'bold' });
                txt.textContent = "Failure Swing (LH)";
                svg.appendChild(circle);
                svg.appendChild(txt);
            }

            container.appendChild(svg);
        }

        // --- UNICORN MODEL RENDERER ---
        function renderUnicorn() {
            const container = document.getElementById('unicorn-chart');
            if (!container) return; // Safety check

            container.innerHTML = '';
            const svg = createSVGElement('svg', { viewBox: "0 0 600 250", class: "svg-chart" });

            // Data for Unicorn: OB -> Sweep -> Aggressive Break (Leaving FVG) -> Retest into FVG+OB
            const candles = [
                { o: 150, c: 160, h: 145, l: 165 }, // 1
                { o: 160, c: 130, h: 125, l: 165 }, // 2 OB Down
                { o: 130, c: 80, h: 70, l: 135 },   // 3 Rally Up (Sweep)
                { o: 80, c: 120, h: 75, l: 125 },   // 4 Start Drop
                { o: 120, c: 200, h: 115, l: 205 }, // 5 DISPLACEMENT (Big Red Candle) - Creates FVG
                { o: 200, c: 220, h: 195, l: 225 }, // 6 Continuation
                { o: 220, c: 180, h: 175, l: 225 }, // 7 Retest Start
                { o: 180, c: 140, h: 135, l: 185 }, // 8 RETEST INTO FVG + OB
                { o: 140, c: 240, h: 135, l: 250 }, // 9 Drop
            ];

            // Draw FVG Zone (Gap between Candle 4 Low and Candle 6 High)
            // Candle 4 Low = 125. Candle 6 High = 195. Gap is 125-195 area.
            const fvgRect = createSVGElement('rect', {
                x: 200, y: 125, width: 400, height: 70, // 195 - 125
                fill: 'var(--purple-accent)', 'fill-opacity': 0.2
            });
            const fvgText = createSVGElement('text', {
                x: 500, y: 180, fill: 'var(--purple-accent)', 'font-size': 14, 'font-weight': 'bold'
            });
            fvgText.textContent = "FVG";

            // Draw Breaker Line (Candle 2 OB)
            // OB Body area approx 130-160
            const bbLine = createSVGElement('line', {
                x1: 0, y1: 130, x2: 600, y2: 130, stroke: 'var(--secondary-teal)', 'stroke-width': 2, 'stroke-dasharray': '4'
            });
            const bbText = createSVGElement('text', {
                x: 10, y: 125, fill: 'var(--secondary-teal)', 'font-size': 12, 'font-weight': 'bold'
            });
            bbText.textContent = "Breaker Level";

            svg.appendChild(fvgRect);
            svg.appendChild(bbLine);
            svg.appendChild(fvgText);
            svg.appendChild(bbText);

            let x = 30;
            candles.forEach((c, index) => {
                drawCandle(svg, x, c.o, c.h, c.l, c.c, 30);

                // Highlight the entry
                if (index === 7) {
                    const circle = createSVGElement('circle', {
                        cx: x + 15, cy: 140, r: 8, fill: 'none', stroke: '#ffeb3b', 'stroke-width': 3
                    });
                    svg.appendChild(circle);
                    const label = createSVGElement('text', {
                        x: x - 20, y: 100, fill: '#ffeb3b', 'font-size': 12, 'font-weight': 'bold'
                    });
                    label.textContent = "UNICORN ENTRY";
                    svg.appendChild(label);
                }
                x += 60;
            });

            container.appendChild(svg);
        }

        // --- RISK CALCULATOR LOGIC ---
        function updateRiskVisual(mode) {
            const container = document.getElementById('risk-chart-container');
            if (!container) return; // Safety check

            container.innerHTML = '';
            const svg = createSVGElement('svg', { viewBox: "0 0 400 250", class: "svg-chart" });

            // Draw Schematic Candles (Bearish Breaker setup)
            // OB Candle
            drawCandle(svg, 100, 100, 90, 140, 130, 30);
            // Drop
            drawCandle(svg, 140, 130, 125, 180, 170, 30);
            // Return
            drawCandle(svg, 180, 170, 130, 175, 135, 30); // Wicked up to 130

            // Entry Line (Bottom of OB Body)
            const entryPrice = 130;
            const entryLine = createSVGElement('line', {
                x1: 0, y1: entryPrice, x2: 400, y2: entryPrice, stroke: '#2196f3', 'stroke-width': 2
            });
            const entryText = createSVGElement('text', { x: 220, y: entryPrice + 15, fill: '#2196f3', 'font-size': 12 });
            entryText.textContent = "ENTRADA";

            let stopPrice = 0;
            let rrText = "";

            if (mode === 'conservative') {
                stopPrice = 85; // Above the wick
                rrText = "R:R Estimado: 1:2";
            } else {
                stopPrice = 115; // Middle of OB body (50%)
                rrText = "R:R Estimado: 1:5";
            }

            // Stop Area Box
            const stopBox = createSVGElement('rect', {
                x: 0, y: stopPrice, width: 400, height: entryPrice - stopPrice,
                fill: '#ffcdd2', 'fill-opacity': 0.3
            });

            // Profit Area Box (Theoretical)
            const targetPrice = 240;
            const profitBox = createSVGElement('rect', {
                x: 0, y: entryPrice, width: 400, height: targetPrice - entryPrice,
                fill: '#c8e6c9', 'fill-opacity': 0.3
            });

            // SL Line
            const slLine = createSVGElement('line', {
                x1: 0, y1: stopPrice, x2: 400, y2: stopPrice, stroke: '#e53935', 'stroke-width': 2, 'stroke-dasharray': '4'
            });
            const slText = createSVGElement('text', { x: 10, y: stopPrice - 5, fill: '#e53935', 'font-size': 12, 'font-weight': 'bold' });
            slText.textContent = mode === 'conservative' ? "STOP LOSS (Por encima del Swing)" : "STOP LOSS (50% Fair Value)";

            // RR Label
            const infoText = createSVGElement('text', { x: 250, y: 30, fill: 'white', 'font-size': 14 });
            infoText.textContent = rrText;

            svg.appendChild(stopBox);
            svg.appendChild(profitBox);
            svg.appendChild(entryLine);
            svg.appendChild(slLine);
            svg.appendChild(entryText);
            svg.appendChild(slText);
            svg.appendChild(infoText);

            container.appendChild(svg);
        }

        // --- CASE STUDIES LOGIC ---
        const casesData = {
            'case1': [ // EURUSD
                { o: 50, c: 40, h: 35, l: 55 }, { o: 40, c: 30, h: 25, l: 45 }, { o: 30, c: 45, h: 25, l: 50 }, // OB up
                { o: 45, c: 20, h: 15, l: 50 }, // Wick high (trap)
                { o: 20, c: 80, h: 15, l: 85 }, // Crash down
                { o: 80, c: 60, h: 55, l: 85 }, // Retest up
                { o: 60, c: 120, h: 55, l: 125 } // Sell off
            ],
            'case2': [ // XAUUSD
                { o: 120, c: 100, h: 90, l: 125 }, { o: 100, c: 80, h: 75, l: 105 },
                { o: 80, c: 75, h: 70, l: 85 }, // Double top area
                { o: 75, c: 150, h: 70, l: 155 }, // HUGE DROP
                { o: 150, c: 110, h: 105, l: 155 }, // Retest FVG
                { o: 110, c: 200, h: 105, l: 210 } // Melting
            ],
            'case3': [ // QQQ (Bullish)
                { o: 150, c: 160, h: 145, l: 165 }, // Down OB
                { o: 160, c: 180, h: 155, l: 185 }, // Fake drop
                { o: 180, c: 120, h: 115, l: 185 }, // Break UP (Green giant)
                { o: 120, c: 150, h: 115, l: 155 }, // Retest down
                { o: 150, c: 80, h: 75, l: 155 } // Moon
            ]
        };

        function openCase(evt, caseName) {
            // Tab UI
            const tabcontent = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            const tablinks = document.getElementsByClassName("tab-btn");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(caseName).style.display = "block";
            document.getElementById(caseName).classList.add("active");
            if (evt) evt.currentTarget.className += " active";

            // Draw Chart
            const container = document.querySelector(`#${caseName} .chart-container`);
            if (!container) return; // Safety check

            container.innerHTML = '';
            const svg = createSVGElement('svg', { viewBox: "0 0 400 250", class: "svg-chart" });

            const data = casesData[caseName];
            let x = 30;
            data.forEach(c => {
                drawCandle(svg, x, c.o, c.h, c.l, c.c, 30);
                x += 50;
            });

            // Add specific markers based on case
            if (caseName === 'case1') {
                // Mark OB
                const rect = createSVGElement('rect', { x: 110, y: 30, width: 300, height: 20, fill: 'red', opacity: 0.1 });
                svg.prepend(rect); // Put behind
            }

            container.appendChild(svg);
        }

        // INITIALIZATION (Using addEventListener for robustness)
        window.addEventListener('load', function () {
            document.getElementById('current-year').textContent = new Date().getFullYear();

            // Init Components with Error Handling
            try { anatomySim.init(); } catch (e) { console.error("Anatomy Init Error", e); }
            try { updateRiskVisual('conservative'); } catch (e) { console.error("Risk Init Error", e); }
            try { toggleMitigationVsBreaker('breaker'); } catch (e) { console.error("Comparator Init Error", e); }
            try { renderUnicorn(); } catch (e) { console.error("Unicorn Init Error", e); }

            // Trigger first tab manually
            try {
                // Don't pass 'event' here, handle null in function
                openCase(null, 'case1');
                // Set active class manually since we didn't pass event
                const firstTab = document.querySelector('.tab-btn');
                if (firstTab) firstTab.classList.add('active');
            } catch (e) { console.error("Tabs Init Error", e); }
        });

    </script>

</body>

</html>