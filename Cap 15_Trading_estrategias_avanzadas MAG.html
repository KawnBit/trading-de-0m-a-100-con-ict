<!DOCTYPE html>
<html lang="es" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KawnBit Magazine | Cap. 15: Estrategias Avanzadas de Trading</title>
    <meta name="description"
        content="Gu√≠a avanzada sobre operativa en noticias, lectura de liquidez, order flow, gesti√≥n de riesgo profesional y psicolog√≠a del trader.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@400;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kawn: {
                            light: '#ccfbf1', // Teal 100
                            base: '#14b8a6',  // Teal 500
                            dark: '#0f766e',  // Teal 700
                            deep: '#134e4a',  // Teal 900
                            accent: '#0d9488' // Teal 600
                        },
                        slate: {
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'dash': 'dash 2s linear forwards',
                        'float': 'float 3s ease-in-out infinite',
                        'fill-gap': 'fillGap 1.5s ease-out forwards',
                    },
                    keyframes: {
                        dash: {
                            '0%': { strokeDasharray: '1000', strokeDashoffset: '1000' },
                            '100%': { strokeDasharray: '1000', strokeDashoffset: '0' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        fillGap: {
                            '0%': { height: '0%' },
                            '100%': { height: '100%' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Styles for Magazine Feel */
        body {
            background-color: #f8fafc;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        th {
            font-family: 'Montserrat', sans-serif;
        }

        p,
        li,
        td,
        input,
        select,
        textarea {
            font-family: 'Inter', sans-serif;
            line-height: 1.75;
        }

        .hero-gradient {
            background: linear-gradient(135deg, #0f172a 0%, #134e4a 100%);
        }

        .visual-container {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            margin: 2rem 0;
            overflow: hidden;
            position: relative;
        }

        .visual-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: #0f766e;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

        .custom-list li {
            margin-bottom: 0.75rem;
            display: flex;
            align-items: start;
        }

        .custom-list li i {
            margin-right: 0.75rem;
            margin-top: 0.25rem;
            color: #14b8a6;
        }

        .highlight-quote {
            border-left: 4px solid #14b8a6;
            background-color: #f0fdfa;
            padding: 1.5rem;
            font-style: italic;
            color: #134e4a;
            border-radius: 0 0.5rem 0.5rem 0;
            margin: 2rem 0;
        }

        .chart-tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 100;
            max-width: 250px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transform: translateY(10px);
        }

        .chart-tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Interactive Elements Styles */
        .interactive-btn {
            transition: all 0.2s ease;
        }

        .interactive-btn:active {
            transform: scale(0.95);
        }

        /* Order Flow Grid */
        .order-flow-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
        }

        .of-cell {
            padding: 4px;
            border-radius: 2px;
            cursor: crosshair;
            transition: background 0.1s;
            display: flex;
            justify-content: space-between;
        }

        .of-cell:hover {
            filter: brightness(1.1);
            outline: 1px solid white;
        }

        /* Volume Profile Bars */
        .vp-bar {
            transition: width 1s ease-out, fill 0.3s;
        }

        .vp-bar:hover {
            fill: #0d9488 !important;
            cursor: help;
        }

        /* FVG Styles */
        .fvg-zone {
            fill: rgba(251, 191, 36, 0.15);
            stroke: rgba(251, 191, 36, 0.5);
            stroke-dasharray: 4;
        }

        .candle-wick {
            stroke: #64748b;
            stroke-width: 1;
        }

        .candle-body-green {
            fill: #10b981;
            stroke: #047857;
            stroke-width: 1;
        }

        .candle-body-red {
            fill: #ef4444;
            stroke: #b91c1c;
            stroke-width: 1;
        }

        /* AI Chat & Quiz Styles */
        .ai-message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 0.75rem;
            font-size: 0.9rem;
            max-width: 85%;
            word-wrap: break-word;
        }

        .ai-message.user {
            background-color: #f1f5f9;
            color: #334155;
            border-bottom-right-radius: 0;
            margin-left: auto;
        }

        .ai-message.bot {
            background-color: #ccfbf1;
            color: #0f766e;
            border-bottom-left-radius: 0;
            margin-right: auto;
            border: 1px solid #99f6e4;
        }

        .ai-message p {
            margin-bottom: 0.5rem;
        }

        .ai-message p:last-child {
            margin-bottom: 0;
        }

        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #0f766e;
            border-radius: 50%;
            animation: typing 1s infinite;
            margin: 0 2px;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .quiz-option {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quiz-option:hover {
            background-color: #f8fafc;
            border-color: #14b8a6;
        }

        .quiz-option.correct {
            background-color: #dcfce7;
            border-color: #22c55e;
            color: #15803d;
        }

        .quiz-option.wrong {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #b91c1c;
        }

        .quiz-option.answered {
            cursor: default;
        }

        /* Tabs */
        .tab-btn {
            cursor: pointer;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            font-weight: 600;
            font-size: 0.875rem;
            color: #64748b;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-bottom: none;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: #e2e8f0;
        }

        .tab-btn.active {
            background: white;
            color: #0f766e;
            border-top: 3px solid #14b8a6;
            padding-top: calc(0.75rem - 2px);
        }

        .tab-content {
            display: none;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0 0.5rem 0.5rem 0.5rem;
            background: white;
            animation: fadeIn 0.3s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Card Hover Effects */
        .pillar-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .pillar-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="text-slate-600 antialiased">

    <nav class="sticky top-0 z-50 bg-white/95 backdrop-blur-md border-b border-slate-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center flex-shrink-0 mr-6">
                    <div class="flex flex-col items-start">
                        <span
                            class="font-display font-black text-kawn-base text-2xl tracking-tight leading-none">KawnBit</span>
                        <span
                            class="text-[0.6rem] font-bold text-kawn-deep uppercase tracking-[0.15em] leading-none mt-0.5">Quantitative
                            Trading Community</span>
                    </div>
                </div>

                <div class="hidden md:flex space-x-6">
                    <a href="#intro"
                        class="text-slate-500 hover:text-kawn-base font-medium transition-colors text-xs uppercase tracking-wider">Intro</a>
                    <a href="#noticias"
                        class="text-slate-500 hover:text-kawn-base font-medium transition-colors text-xs uppercase tracking-wider">Noticias</a>
                    <a href="#liquidez"
                        class="text-slate-500 hover:text-kawn-base font-medium transition-colors text-xs uppercase tracking-wider">Liquidez</a>
                    <a href="#tecnico-avanzado"
                        class="text-slate-500 hover:text-kawn-base font-medium transition-colors text-xs uppercase tracking-wider">Order
                        Flow</a>
                    <a href="#volume-profile"
                        class="text-slate-500 hover:text-kawn-base font-medium transition-colors text-xs uppercase tracking-wider">Volumen</a>
                    <a href="#gestion-riesgo"
                        class="text-slate-500 hover:text-kawn-base font-medium transition-colors text-xs uppercase tracking-wider font-bold text-kawn-deep">Riesgo</a>
                    <a href="#ai-lab-adv"
                        class="text-kawn-base hover:text-kawn-dark font-bold transition-colors text-xs uppercase tracking-wider flex items-center"><i
                            data-lucide="sparkles" class="w-4 h-4 mr-1"></i> AI Lab</a>
                </div>
            </div>
        </div>
    </nav>

    <section class="hero-gradient relative text-white py-24 overflow-hidden">
        <div
            class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1642543492481-44e81e3914a7?q=80&w=2070&auto=format&fit=crop')] bg-cover bg-center opacity-10 mix-blend-overlay">
        </div>
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10 text-center">
            <span
                class="inline-block py-1 px-3 rounded-full bg-kawn-light/20 text-kawn-light text-xs font-bold uppercase tracking-wider mb-6 backdrop-blur-sm">Gu√≠a
                Profesional de Operativa Institucional</span>
            <h1 class="text-4xl md:text-5xl font-black tracking-tight leading-tight mb-6">
                Cap√≠tulo 15: Estrategias Avanzadas de Trading
            </h1>
            <p class="text-xl text-slate-200 font-light max-w-3xl mx-auto leading-relaxed">
                Domina la operativa en noticias, la lectura del flujo de √≥rdenes institucional y la gesti√≥n de riesgo
                profesional para navegar los mercados financieros con una ventaja estad√≠stica.
            </p>
        </div>
    </section>

    <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-16">

        <section id="intro" class="mb-16 scroll-mt-24">
            <div class="flex items-center mb-8">
                <i data-lucide="book-open-check" class="w-8 h-8 text-kawn-base mr-4"></i>
                <h2 class="text-3xl font-bold text-slate-900">Introducci√≥n a la Operativa Avanzada</h2>
            </div>

            <p class="mb-4 text-lg leading-relaxed font-medium text-slate-700">
                En este cap√≠tulo abordamos las estrategias avanzadas de trading, un conjunto de enfoques sofisticados
                que van m√°s all√° de las t√©cnicas b√°sicas.
            </p>
            <p class="mb-6">
                Estas estrategias permiten a los traders experimentados identificar oportunidades √∫nicas y gestionar el
                riesgo de manera √≥ptima en diversos escenarios de mercado. El √©xito en este nivel requiere una visi√≥n
                multidimensional, adaptabilidad al contexto y, sobre todo, una mentalidad profesional y disciplinada.
            </p>

            <div class="visual-container bg-slate-50">
                <div class="visual-title"><i data-lucide="layers" class="w-5 h-5 mr-2"></i> Infograf√≠a: Pilares de la
                    Estrategia Avanzada</div>
                <div class="grid md:grid-cols-3 gap-6 text-center">
                    <div
                        class="pillar-card bg-white p-6 rounded-lg shadow-sm border-t-4 border-kawn-base cursor-default">
                        <div
                            class="bg-kawn-light/30 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 transition-transform group-hover:scale-110">
                            <i data-lucide="eye" class="w-8 h-8 text-kawn-dark"></i>
                        </div>
                        <h4 class="font-bold text-kawn-deep mb-2">Visi√≥n Multidimensional</h4>
                        <p class="text-xs text-slate-500">Combina an√°lisis t√©cnico, fundamental y de sentimiento del
                            mercado.</p>
                    </div>
                    <div
                        class="pillar-card bg-white p-6 rounded-lg shadow-sm border-t-4 border-kawn-accent cursor-default">
                        <div
                            class="bg-kawn-light/30 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="crosshair" class="w-8 h-8 text-kawn-dark"></i>
                        </div>
                        <h4 class="font-bold text-kawn-deep mb-2">Lectura de Liquidez</h4>
                        <p class="text-xs text-slate-500">Detecta zonas de acumulaci√≥n de √≥rdenes y trampas
                            institucionales.</p>
                    </div>
                    <div
                        class="pillar-card bg-white p-6 rounded-lg shadow-sm border-t-4 border-kawn-dark cursor-default">
                        <div
                            class="bg-kawn-light/30 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="shield-alert" class="w-8 h-8 text-kawn-dark"></i>
                        </div>
                        <h4 class="font-bold text-kawn-deep mb-2">Gesti√≥n Superior del Riesgo</h4>
                        <p class="text-xs text-slate-500">Control preciso de la exposici√≥n y tama√±o de posici√≥n
                            din√°mico.</p>
                    </div>
                </div>
                <div class="highlight-quote mb-0 mt-6">
                    <p class="mb-2">"Las estrategias avanzadas no consisten en la complejidad, sino en comprender
                        profundamente la psicolog√≠a del mercado y las fuerzas que impulsan los movimientos de precios."
                    </p>
                    <footer class="text-sm font-bold text-kawn-deep">‚Äî Ray Dalio</footer>
                </div>
            </div>
        </section>

        <section id="noticias" class="mb-16 scroll-mt-24">
            <div class="flex items-center mb-8">
                <i data-lucide="radio-tower" class="w-8 h-8 text-kawn-base mr-4"></i>
                <h2 class="text-3xl font-bold text-slate-900">Operativa en Noticias: Navegando la Alta Volatilidad</h2>
            </div>

            <p class="mb-4">
                Operar durante anuncios noticiosos importantes (como NFP, IPC o decisiones de bancos centrales) es una
                de las facetas m√°s desafiantes y riesgosas. Estos eventos suelen generar la mayor volatilidad, y sin una
                estrategia adecuada, pueden llevar a p√©rdidas severas r√°pidamente.
            </p>

            <div class="bg-red-50 p-6 rounded-lg border-l-4 border-red-500 mb-8">
                <h4 class="font-bold text-red-700 mb-3 flex items-center"><i data-lucide="alert-triangle"
                        class="mr-2"></i> Peligros de Operar Noticias</h4>
                <ul class="custom-list text-sm text-red-800">
                    <li><i data-lucide="x" class="text-red-500"></i> <strong>Volatilidad extrema inmediata:</strong>
                        Movimientos violentos en segundos.</li>
                    <li><i data-lucide="x" class="text-red-500"></i> <strong>Barridas de liquidez (Stop hunts):</strong>
                        Movimientos iniciales enga√±osos para cazar stops antes de la direcci√≥n real.</li>
                    <li><i data-lucide="x" class="text-red-500"></i> <strong>Spreads amplios y deslizamiento
                            (slippage):</strong> Ejecuciones a precios mucho peores de lo esperado.</li>
                    <li><i data-lucide="x" class="text-red-500"></i> <strong>Manipulaci√≥n de precios:</strong>
                        Movimientos contraintuitivos dise√±ados para enga√±ar a traders de reacci√≥n r√°pida.</li>
                </ul>
            </div>

            <h3 class="text-2xl font-bold text-slate-900 mb-6">Estrategia Avanzada para Noticias de Alto Impacto (NFP,
                IPC)</h3>
            <p class="mb-6">
                La estrategia recomendada para traders avanzados no es adivinar la direcci√≥n en el instante del anuncio,
                sino aprovechar el patr√≥n t√≠pico de manipulaci√≥n y reversi√≥n que ocurre tras los primeros minutos. El
                objetivo es esperar una toma de liquidez clara, conocida como patr√≥n "sopa de tortuga".
            </p>

            <div class="visual-container">
                <div class="visual-title flex justify-between items-center mb-4">
                    <span><i data-lucide="activity" class="w-5 h-5 mr-2 inline"></i> Simulador: Patr√≥n "Sopa de
                        Tortuga"</span>
                    <div class="flex gap-2">
                        <button onclick="setTurtleStep(0)"
                            class="text-xs bg-slate-200 hover:bg-slate-300 px-3 py-1 rounded font-bold transition">Reset</button>
                        <button onclick="nextTurtleStep()"
                            class="text-xs bg-kawn-base text-white hover:bg-kawn-dark px-3 py-1 rounded font-bold transition flex items-center shadow-lg hover:shadow-xl"><i
                                data-lucide="play" class="w-3 h-3 mr-1"></i> Siguiente Fase</button>
                    </div>
                </div>

                <div
                    class="relative h-80 w-full bg-slate-50 rounded-lg border border-slate-200 overflow-hidden select-none">
                    <svg viewBox="0 0 600 300" class="w-full h-full p-4" id="turtle-svg" role="img"
                        aria-label="Gr√°fico interactivo del patr√≥n Sopa de Tortuga">
                        <defs>
                            <marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto"
                                markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L9,3 z" fill="#fbbf24" />
                            </marker>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="2.5" result="coloredBlur" />
                                <feMerge>
                                    <feMergeNode in="coloredBlur" />
                                    <feMergeNode in="SourceGraphic" />
                                </feMerge>
                            </filter>
                        </defs>

                        <!-- Static Background -->
                        <rect x="50" y="50" width="500" height="200" fill="white" stroke="#e2e8f0" rx="4" />

                        <!-- Resistance -->
                        <line x1="50" y1="100" x2="550" y2="100" stroke="#ef4444" stroke-dasharray="4,4" opacity="0.6"
                            stroke-width="1.5" />
                        <rect x="55" y="85" width="130" height="14" rx="2" fill="#fee2e2" stroke="#ef4444"
                            stroke-width="0.5" />
                        <text x="60" y="95" class="text-[10px] fill-red-700 font-bold">Resistencia (Stops Venta)</text>

                        <!-- Support -->
                        <line x1="50" y1="200" x2="550" y2="200" stroke="#10b981" stroke-dasharray="4,4" opacity="0.6"
                            stroke-width="1.5" />
                        <rect x="55" y="205" width="130" height="14" rx="2" fill="#d1fae5" stroke="#10b981"
                            stroke-width="0.5" />
                        <text x="60" y="215" class="text-[10px] fill-green-800 font-bold">Soporte (Stops Compra)</text>

                        <!-- Dynamic Path Group -->
                        <g id="turtle-path-group" fill="none" stroke="#64748b" stroke-width="2.5" stroke-linecap="round"
                            stroke-linejoin="round">
                            <!-- Paths will be drawn by JS -->
                        </g>

                        <!-- Interactive Markers -->
                        <g id="turtle-markers">
                            <!-- Markers added by JS -->
                        </g>

                        <!-- Step Info Box -->
                        <g transform="translate(380, 230)">
                            <rect width="160" height="60" rx="4" fill="white" stroke="#cbd5e1" stroke-width="1"
                                filter="drop-shadow(0 4px 3px rgb(0 0 0 / 0.07))" />
                            <text x="10" y="20" class="text-[10px] font-bold fill-slate-400">FASE ACTUAL:</text>
                            <text x="10" y="40" id="turtle-phase-text" class="text-sm font-bold fill-kawn-deep">1. Rango
                                Inicial</text>
                        </g>
                    </svg>
                </div>

                <div class="mt-4 bg-slate-100 p-4 rounded text-sm text-slate-700">
                    <ol class="list-decimal pl-5 space-y-2">
                        <li id="desc-step-0" class="transition-colors font-bold text-kawn-deep"><strong>Definir puntos
                                de liquidez:</strong> Identificar soportes y resistencias previos al anuncio.</li>
                        <li id="desc-step-1" class="transition-colors opacity-50"><strong>Manipulaci√≥n 1 (Caza
                                Stops):</strong> El precio barre un lado enga√±ando al trader impaciente.</li>
                        <li id="desc-step-2" class="transition-colors opacity-50"><strong>Manipulaci√≥n 2 (Sopa de
                                Tortuga):</strong> Barre el lado opuesto, capturando la liquidez final.</li>
                        <li id="desc-step-3" class="transition-colors opacity-50"><strong>Entrada Real:</strong> Tras la
                            segunda barrida, entramos en la reversi√≥n confirmada.</li>
                    </ol>
                </div>
            </div>

            <h3 class="text-2xl font-bold text-slate-900 mb-6">Operar Decisiones de la Fed (FOMC): Estructura de Dos
                Fases</h3>
            <p class="mb-6">
                Los d√≠as de anuncio del FOMC presentan una din√°mica particular en dos fases. Entender esto es vital:
                muchas veces el movimiento m√°s fuerte no ocurre con la decisi√≥n inicial, sino durante o justo despu√©s de
                la conferencia de prensa.
            </p>

            <div class="visual-container mt-8">
                <div class="visual-title mb-4"><i data-lucide="mic" class="w-5 h-5 mr-2"></i> Estructura de Trading en
                    FOMC</div>
                <div class="flex">
                    <button class="tab-btn active" onclick="openTab(event, 'fomc-fase1')">Fase 1: Comunicado
                        (Decisi√≥n)</button>
                    <button class="tab-btn" onclick="openTab(event, 'fomc-fase2')">Fase 2: Rueda de Prensa</button>
                </div>

                <div id="fomc-fase1" class="tab-content active border-t-0 rounded-t-none">
                    <div class="flex items-start gap-4">
                        <div class="bg-red-100 p-3 rounded-full hidden sm:block">
                            <i data-lucide="file-warning" class="w-6 h-6 text-red-600"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg text-slate-800 mb-2">La Primera Manipulaci√≥n (14:00 EST)</h4>
                            <p class="mb-4 text-sm leading-relaxed">Tras la publicaci√≥n del comunicado con la decisi√≥n
                                de tasas, el mercado suele tener un primer latigazo de volatilidad. Los algoritmos
                                reaccionan a los titulares ("headlines") de forma instant√°nea.</p>
                            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg">
                                <p class="text-sm font-bold text-red-700 flex items-center mb-1"><i
                                        data-lucide="x-circle" class="w-4 h-4 mr-2"></i> Acci√≥n Recomendada: NO OPERAR.
                                </p>
                                <p class="text-xs text-red-600">Evita entrar durante esta primera manipulaci√≥n. El
                                    movimiento inicial a menudo se revierte durante la conferencia.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="fomc-fase2" class="tab-content border-t-0 rounded-t-none">
                    <div class="flex items-start gap-4">
                        <div class="bg-green-100 p-3 rounded-full hidden sm:block">
                            <i data-lucide="mic-2" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg text-slate-800 mb-2">La Conferencia y el Movimiento Real (14:30
                                EST)</h4>
                            <p class="mb-4 text-sm leading-relaxed">30 minutos despu√©s, Powell habla. Aqu√≠ es donde el
                                mercado digiere los matices y a menudo ocurre una segunda manipulaci√≥n o el inicio de la
                                tendencia real.</p>
                            <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg">
                                <p class="text-sm font-bold text-green-700 flex items-center mb-1"><i
                                        data-lucide="check-circle" class="w-4 h-4 mr-2"></i> Acci√≥n Recomendada: ESPERAR
                                    Y CONFIRMAR.</p>
                                <p class="text-xs text-green-600">Espera a que se desarrolle la conferencia. Busca una
                                    segunda barrida de liquidez y luego una confirmaci√≥n de cambio de estructura para
                                    entrar.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <h3 class="text-2xl font-bold text-slate-900 mb-4 mt-12">Estrategia para D√≠as sin Noticias: "Seek & Destroy"
            </h3>
            <p class="mb-4">
                En jornadas sin catalizadores fundamentales, los mercados a menudo se consolidan en rangos. La
                estrategia "Seek & Destroy" busca aprovechar estas oscilaciones operando exclusivamente los extremos del
                rango.
            </p>
            <ul class="custom-list pl-4 mb-6">
                <li><i data-lucide="check"></i> Identificar l√≠mites claros de soporte y resistencia (rangos duraderos
                    son mejores).</li>
                <li><i data-lucide="check"></i> Esperar pacientemente al toque en un extremo; nunca operar en la "zona
                    muerta" del medio.</li>
                <li><i data-lucide="check"></i> Confirmar rechazo del nivel (ej. vela con mecha larga) y entrar en
                    direcci√≥n opuesta con stop ajustado fuera del rango.</li>
            </ul>
        </section>

        <section id="liquidez" class="mb-16 scroll-mt-24">
            <div class="flex items-center mb-8">
                <i data-lucide="droplets" class="w-8 h-8 text-kawn-base mr-4"></i>
                <h2 class="text-3xl font-bold text-slate-900">Liquidez y Manipulaci√≥n Institucional</h2>
            </div>

            <p class="mb-6">
                Entender la liquidez es entender d√≥nde se concentra el dinero. Las zonas donde se acumulan stop-loss u
                √≥rdenes pendientes son puntos de liquidez atractivos para el "smart money", que dirige el precio hacia
                all√≠ para ejecutar sus grandes posiciones con el menor impacto.
            </p>

            <div class="visual-container bg-slate-50">
                <div class="visual-title flex justify-between items-center">
                    <span><i data-lucide="magnet" class="w-5 h-5 mr-2"></i> Visualizaci√≥n: Piscinas de Liquidez
                        (Stops)</span>
                    <button id="liquidity-btn" onclick="animateLiquidity()"
                        class="text-xs bg-red-500 text-white hover:bg-red-600 px-4 py-2 rounded font-bold transition shadow flex items-center">
                        <i data-lucide="skull" class="w-4 h-4 mr-2"></i> Ejecutar Barrida (Stop Hunt)
                    </button>
                </div>
                <div class="relative h-64 w-full bg-white rounded-lg border border-slate-200 overflow-hidden">
                    <svg viewBox="0 0 600 250" class="w-full h-full" id="liquidity-svg" role="img"
                        aria-label="Animaci√≥n de caza de stops y liquidez">
                        <!-- Buy Stops Pool (Top) -->
                        <rect x="50" y="20" width="500" height="50" fill="#ef4444" opacity="0.05" />
                        <line x1="50" y1="70" x2="550" y2="70" stroke="#ef4444" stroke-width="2"
                            stroke-dasharray="5,5" />
                        <text x="500" y="45" text-anchor="end" class="text-xs fill-red-600 font-bold opacity-70">BUY
                            STOPS ($$$)</text>
                        <text x="60" y="85" class="text-[10px] fill-slate-500">Resistencia (Highs)</text>

                        <!-- Money Bags Top (Hidden initially) -->
                        <g id="money-top" class="opacity-0 transition-opacity duration-500">
                            <text x="350" y="50" font-size="14">üí∞</text> <text x="370" y="40" font-size="14">üí∞</text>
                            <text x="390" y="55" font-size="14">üí∞</text>
                        </g>

                        <!-- Sell Stops Pool (Bottom) -->
                        <rect x="50" y="180" width="500" height="50" fill="#10b981" opacity="0.05" />
                        <line x1="50" y1="180" x2="550" y2="180" stroke="#10b981" stroke-width="2"
                            stroke-dasharray="5,5" />
                        <text x="500" y="205" text-anchor="end" class="text-xs fill-green-600 font-bold opacity-70">SELL
                            STOPS ($$$)</text>
                        <text x="60" y="170" class="text-[10px] fill-slate-500">Soporte (Lows)</text>

                        <!-- Money Bags Bottom (Visible initially) -->
                        <g id="money-bottom">
                            <text x="200" y="200" font-size="14">üí∞</text> <text x="220" y="210"
                                font-size="14">üí∞</text> <text x="240" y="195" font-size="14">üí∞</text>
                        </g>

                        <!-- Price Path -->
                        <path id="liq-price-path" d="M50,125 L150,130 L200,175" fill="none" stroke="#0f766e"
                            stroke-width="2" stroke-linejoin="round" />

                        <!-- Dynamic Elements -->
                        <circle id="price-head" cx="200" cy="175" r="4" fill="#0f766e" />

                        <!-- Annotations -->
                        <g id="liq-annotation" class="opacity-0">
                            <circle cx="220" cy="195" r="20" fill="none" stroke="#ef4444" stroke-width="2"
                                class="animate-pulse" />
                            <text x="250" y="235" class="text-[10px] fill-red-600 font-bold">¬°ZONA DE LIQUIDEZ
                                TOMADA!</text>
                        </g>
                    </svg>
                </div>
                <div class="mt-4 text-sm text-slate-600 flex gap-4 items-start">
                    <div class="bg-blue-50 p-2 rounded text-blue-800"><i data-lucide="info" class="w-4 h-4"></i></div>
                    <p><strong>Concepto Clave:</strong> Las instituciones "empujan" el precio para activar clusters de
                        stops (liquidez) y as√≠ obtener la contrapartida necesaria para sus propias operaciones gigantes.
                        La estrategia avanzada consiste en esperar esta manipulaci√≥n, identificar la liquidez tomada y
                        entrar con confirmaci√≥n tras el giro.</p>
                </div>
            </div>
        </section>

        <section id="tecnico-avanzado" class="mb-16 scroll-mt-24">
            <div class="flex items-center mb-8">
                <i data-lucide="microscope" class="w-8 h-8 text-kawn-base mr-4"></i>
                <h2 class="text-3xl font-bold text-slate-900">An√°lisis T√©cnico Avanzado: Order Flow y Estructura</h2>
            </div>

            <h3 class="text-2xl font-bold text-slate-900 mb-6">Lectura de Order Flow: Viendo Dentro de la Vela</h3>
            <p class="mb-6">
                El Order Flow permite una visi√≥n "microestructural" del mercado, mostrando c√≥mo se realizan las
                transacciones dentro de cada vela en tiempo real. Esto proporciona una transparencia mucho mayor sobre
                la actividad institucional.
            </p>

            <div class="visual-container grid lg:grid-cols-2 gap-8 items-start">
                <div>
                    <h4 class="font-bold text-kawn-deep mb-4">Indicadores Institucionales en el Flujo:</h4>
                    <ul class="custom-list text-sm mb-6">
                        <li><i data-lucide="bar-chart-2"></i> <strong>Clusters de liquidez:</strong> Zonas con volumen
                            inusualmente alto a un precio concreto, actuando como soporte/resistencia.</li>
                        <li><i data-lucide="arrow-down-circle"></i> <strong>Absorci√≥n:</strong> Gran volumen negociado
                            en un nivel sin que el precio avance, indicando defensa institucional.</li>
                        <li><i data-lucide="zap"></i> <strong>Stop runs:</strong> Picos repentinos de volumen en zonas
                            de stop obvias seguidos de reversi√≥n.</li>
                    </ul>
                    <div class="bg-slate-100 p-4 rounded-lg text-xs text-slate-600">
                        <strong>Instrucciones:</strong> Pasa el mouse sobre las celdas del gr√°fico de la derecha para
                        ver el desglose de Compras vs Ventas y el Delta (Diferencia neta).
                    </div>
                </div>

                <!-- Interactive Footprint Chart -->
                <div
                    class="bg-slate-900 p-4 rounded-lg shadow-2xl relative overflow-hidden group border border-slate-700">
                    <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
                        <span class="text-xs text-slate-400 font-bold uppercase tracking-wider">Footprint (Bid x
                            Ask)</span>
                        <div class="text-xs text-right">
                            <span class="block text-green-400 font-bold">Delta Total: +450</span>
                            <span class="block text-slate-500">Volumen: 3.2K</span>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <!-- Price Axis -->
                        <div class="flex flex-col text-[10px] text-slate-500 justify-between py-1 font-mono text-right">
                            <span>1.0855</span><span>1.0854</span><span>1.0853</span><span>1.0852</span><span>1.0851</span><span>1.0850</span><span>1.0849</span><span>1.0848</span>
                        </div>

                        <!-- The Grid -->
                        <div class="flex-1 relative">
                            <!-- Candle Body Background -->
                            <div
                                class="absolute top-4 bottom-4 left-0 right-0 bg-green-900/20 border border-green-500/30">
                            </div>
                            <div class="absolute left-1/2 top-0 bottom-0 w-px bg-slate-700"></div>

                            <!-- Interactive Cells -->
                            <div class="flex flex-col gap-1" id="footprint-rows">
                                <!-- Row 1 (High) -->
                                <div class="order-flow-grid"
                                    onmouseover="showOfTooltip(event, 'Agresi√≥n Compradora', '10 x 50', 'Delta: +40')"
                                    onmouseout="hideChartTooltip()">
                                    <div class="of-cell text-slate-400">10</div>
                                    <div class="of-cell text-red-400 font-bold bg-red-900/30">50</div>
                                </div>
                                <!-- Row 2 -->
                                <div class="order-flow-grid"
                                    onmouseover="showOfTooltip(event, 'Consolidaci√≥n', '25 x 30', 'Delta: +5')"
                                    onmouseout="hideChartTooltip()">
                                    <div class="of-cell text-slate-400">25</div>
                                    <div class="of-cell text-slate-300">30</div>
                                </div>
                                <!-- Row 3 (POC) -->
                                <div class="order-flow-grid border border-yellow-500/50 bg-yellow-900/10"
                                    onmouseover="showOfTooltip(event, 'POC (Punto de Control)', '1200 x 1500', 'Delta: +300 (Fuerte)')"
                                    onmouseout="hideChartTooltip()">
                                    <div class="of-cell text-slate-300 font-bold">1200</div>
                                    <div class="of-cell text-green-400 font-bold bg-green-900/30">1500</div>
                                </div>
                                <!-- Row 4 -->
                                <div class="order-flow-grid"
                                    onmouseover="showOfTooltip(event, 'Balanceado', '80 x 100', 'Delta: +20')"
                                    onmouseout="hideChartTooltip()">
                                    <div class="of-cell text-slate-400">80</div>
                                    <div class="of-cell text-green-400">100</div>
                                </div>
                                <!-- Row 5 -->
                                <div class="order-flow-grid"
                                    onmouseover="showOfTooltip(event, 'Impulso', '50 x 200', 'Delta: +150')"
                                    onmouseout="hideChartTooltip()">
                                    <div class="of-cell text-slate-400">50</div>
                                    <div class="of-cell text-green-400 font-bold">200</div>
                                </div>
                                <!-- Row 6 -->
                                <div class="order-flow-grid"
                                    onmouseover="showOfTooltip(event, 'Impulso', '40 x 250', 'Delta: +210')"
                                    onmouseout="hideChartTooltip()">
                                    <div class="of-cell text-slate-400">40</div>
                                    <div class="of-cell text-green-400 font-bold">250</div>
                                </div>
                                <!-- Row 7 (Absorption) -->
                                <div class="order-flow-grid bg-green-900/20"
                                    onmouseover="showOfTooltip(event, 'ABSORCI√ìN', '20 x 600', 'Delta: +580 (Soporte Pasivo)')"
                                    onmouseout="hideChartTooltip()">
                                    <div class="of-cell text-slate-400">20</div>
                                    <div class="of-cell text-white font-black bg-green-600/40">600</div>
                                </div>
                                <!-- Row 8 (Low) -->
                                <div class="order-flow-grid"
                                    onmouseover="showOfTooltip(event, 'M√≠nimo', '5 x 10', 'Delta: +5')"
                                    onmouseout="hideChartTooltip()">
                                    <div class="of-cell text-slate-400">5</div>
                                    <div class="of-cell text-slate-400">10</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="chart-tooltip-container" class="chart-tooltip"></div>
                </div>
            </div>

            <h3 class="text-2xl font-bold text-slate-900 mb-4 mt-8">An√°lisis Multi-Temporal y Correlaciones</h3>
            <p class="mb-6">
                El trader avanzado nunca opera en aislamiento. Alinea m√∫ltiples marcos temporales (Regla 10:1 ej. D1 ->
                H4 -> M15) para asegurar que la operaci√≥n t√°ctica coincida con la tendencia estrat√©gica. Adem√°s, utiliza
                las correlaciones entre instrumentos (positivas o negativas) para confirmar la fortaleza de un
                movimiento o diversificar el riesgo.
            </p>
        </section>

        <!-- NEW SECTION: VOLUME PROFILE & AUCTION THEORY -->
        <section id="volume-profile" class="mb-16 scroll-mt-24">
            <div class="flex items-center mb-8">
                <i data-lucide="bar-chart-horizontal" class="w-8 h-8 text-kawn-base mr-4"></i>
                <h2 class="text-3xl font-bold text-slate-900">Perfil de Volumen y Teor√≠a de Subasta</h2>
            </div>
            <p class="mb-4">
                A diferencia del volumen tradicional (basado en tiempo), el <strong>Perfil de Volumen (Volume
                    Profile)</strong> muestra la cantidad de transacciones por nivel de precio. Esto revela d√≥nde el
                mercado encuentra "valor" y aceptaci√≥n.
            </p>
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-8 text-sm text-blue-900">
                <strong>Concepto Clave:</strong> El mercado es una subasta continua buscando el "precio justo". El 70%
                del volumen ocurre en el <strong>√Årea de Valor (Value Area)</strong>. El precio tiende a rechazar los
                extremos y gravitar hacia el POC (Punto de Control).
            </div>

            <div class="visual-container flex flex-col md:flex-row gap-8 items-center">
                <div class="flex-1">
                    <h4 class="font-bold text-kawn-deep mb-2">Simulador de Estructura de Volumen</h4>
                    <p class="text-xs text-slate-500 mb-4">Haz clic para revelar el √Årea de Valor (VA) y el POC.</p>
                    <button onclick="toggleVolumeProfile()"
                        class="interactive-btn px-4 py-2 bg-slate-800 text-white text-xs font-bold rounded shadow mb-4 flex items-center">
                        <i data-lucide="eye" class="w-3 h-3 mr-2"></i> Mostrar/Ocultar An√°lisis
                    </button>
                    <ul class="text-xs space-y-2 text-slate-700">
                        <li class="flex items-center"><span
                                class="w-3 h-3 bg-red-500 rounded-full mr-2 inline-block"></span> <strong>POC (Point of
                                Control):</strong> Precio con m√°s volumen. Act√∫a como im√°n.</li>
                        <li class="flex items-center"><span
                                class="w-3 h-3 bg-blue-200 rounded-full mr-2 inline-block"></span> <strong>VA (Value
                                Area):</strong> El 70% central. Zona de aceptaci√≥n.</li>
                        <li class="flex items-center"><span
                                class="w-3 h-3 bg-slate-300 rounded-full mr-2 inline-block"></span>
                            <strong>Extremos:</strong> Zonas de rechazo o precios "injustos".</li>
                    </ul>
                </div>

                <div class="flex-1 w-full relative h-64 border border-slate-200 rounded bg-white">
                    <svg class="w-full h-full" viewBox="0 0 300 200" role="img"
                        aria-label="Gr√°fico de Perfil de Volumen">
                        <!-- Grid lines -->
                        <line x1="0" y1="20" x2="300" y2="20" stroke="#f1f5f9" />
                        <line x1="0" y1="60" x2="300" y2="60" stroke="#f1f5f9" />
                        <line x1="0" y1="100" x2="300" y2="100" stroke="#f1f5f9" />
                        <line x1="0" y1="140" x2="300" y2="140" stroke="#f1f5f9" />
                        <line x1="0" y1="180" x2="300" y2="180" stroke="#f1f5f9" />

                        <!-- Volume Bars (Right Side) -->
                        <g id="vp-bars" transform="translate(300, 0) scale(-1, 1)">
                            <!-- Low Volume Top -->
                            <rect y="10" height="8" width="20" fill="#cbd5e1" class="vp-bar" />
                            <rect y="20" height="8" width="35" fill="#cbd5e1" class="vp-bar" />
                            <rect y="30" height="8" width="50" fill="#cbd5e1" class="vp-bar" />
                            <!-- Value Area High starts approx here -->
                            <rect y="40" height="8" width="80" fill="#cbd5e1" class="vp-bar va-bar" />
                            <rect y="50" height="8" width="110" fill="#cbd5e1" class="vp-bar va-bar" />
                            <rect y="60" height="8" width="140" fill="#cbd5e1" class="vp-bar va-bar" />
                            <rect y="70" height="8" width="160" fill="#cbd5e1" class="vp-bar va-bar" />
                            <rect y="80" height="8" width="180" fill="#cbd5e1" class="vp-bar va-bar" />
                            <!-- POC -->
                            <rect y="90" height="8" width="220" fill="#cbd5e1" class="vp-bar poc-bar" />
                            <rect y="100" height="8" width="200" fill="#cbd5e1" class="vp-bar va-bar" />
                            <rect y="110" height="8" width="170" fill="#cbd5e1" class="vp-bar va-bar" />
                            <rect y="120" height="8" width="140" fill="#cbd5e1" class="vp-bar va-bar" />
                            <rect y="130" height="8" width="100" fill="#cbd5e1" class="vp-bar va-bar" />
                            <!-- Value Area Low ends approx here -->
                            <rect y="140" height="8" width="60" fill="#cbd5e1" class="vp-bar" />
                            <rect y="150" height="8" width="40" fill="#cbd5e1" class="vp-bar" />
                            <rect y="160" height="8" width="25" fill="#cbd5e1" class="vp-bar" />
                        </g>

                        <!-- Price Line (Simulated) -->
                        <path d="M10,160 Q50,150 80,100 T150,90 T220,95 T290,140" fill="none" stroke="#0f766e"
                            stroke-width="2" opacity="0.5" />

                        <!-- Labels (Hidden initially) -->
                        <g id="vp-labels"
                            class="opacity-0 transition-opacity duration-500 font-bold text-[10px] fill-slate-500">
                            <text x="250" y="45" text-anchor="end">VAH (High)</text>
                            <text x="250" y="145" text-anchor="end">VAL (Low)</text>
                            <text x="250" y="95" text-anchor="end" fill="#ef4444" font-weight="900">POC</text>
                            <line x1="50" y1="38" x2="300" y2="38" stroke="#94a3b8" stroke-dasharray="2,2" />
                            <line x1="50" y1="138" x2="300" y2="138" stroke="#94a3b8" stroke-dasharray="2,2" />
                            <line x1="10" y1="94" x2="300" y2="94" stroke="#ef4444" stroke-width="1" />
                        </g>
                    </svg>
                </div>
            </div>
        </section>

        <!-- NEW SECTION: SMART MONEY CONCEPTS (FVG) -->
        <section id="smart-money" class="mb-16 scroll-mt-24">
            <div class="flex items-center mb-8">
                <i data-lucide="zap" class="w-8 h-8 text-kawn-base mr-4"></i>
                <h2 class="text-3xl font-bold text-slate-900">Ineficiencias de Mercado: Fair Value Gaps (FVG)</h2>
            </div>
            <p class="mb-4">
                Un <strong>Fair Value Gap (FVG)</strong> o desequilibrio ocurre cuando el precio se mueve tan
                agresivamente en una direcci√≥n que deja zonas de liquidez "vac√≠as" (sin contrapartida inmediata).
            </p>
            <p class="mb-6">
                El "Smart Money" o algoritmo interbancario a menudo regresa a estas zonas para rebalancear el precio
                antes de continuar la tendencia. Es una de las entradas de mayor probabilidad.
            </p>

            <div class="visual-container">
                <div class="visual-title flex justify-between items-center">
                    <span><i data-lucide="play-circle" class="w-5 h-5 mr-2 inline"></i> Simulador de Rebalanceo
                        Institucional</span>
                    <button id="fvg-btn" onclick="animateFVG()"
                        class="text-xs bg-kawn-deep text-white hover:bg-kawn-base px-4 py-2 rounded font-bold transition shadow">
                        Simular Testeo del Gap
                    </button>
                </div>

                <div
                    class="relative h-64 w-full bg-slate-900 rounded-lg border border-slate-700 overflow-hidden flex justify-center items-center">
                    <svg viewBox="0 0 400 200" class="w-full h-full" id="fvg-svg" role="img"
                        aria-label="Simulaci√≥n de rebalanceo de Fair Value Gap">
                        <!-- Grid -->
                        <defs>
                            <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                                <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#1e293b" stroke-width="1" />
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#grid)" />

                        <!-- Candle 1: Big Bullish -->
                        <line x1="100" y1="160" x2="100" y2="80" class="candle-wick" />
                        <rect x="90" y="90" width="20" height="60" class="candle-body-green" />

                        <!-- Candle 2: The Aggressive Move (Creating Gap) -->
                        <line x1="140" y1="100" x2="140" y2="30" class="candle-wick" />
                        <rect x="130" y="40" width="20" height="50" class="candle-body-green" />

                        <!-- Candle 3: Continuation -->
                        <line x1="180" y1="50" x2="180" y2="20" class="candle-wick" />
                        <rect x="170" y="25" width="20" height="20" class="candle-body-green" />

                        <!-- THE FVG BOX (Between Candle 1 High and Candle 3 Low) -->

                        <!-- Fixed Candles for clear Gap -->
                        <!-- C1 -->
                        <line x1="100" y1="180" x2="100" y2="120" class="candle-wick" /> <!-- High 120 -->
                        <rect x="90" y="130" width="20" height="40" class="candle-body-green" />

                        <!-- C2 (Big Expansion) -->
                        <line x1="140" y1="130" x2="140" y2="50" class="candle-wick" />
                        <rect x="130" y="60" width="20" height="70" class="candle-body-green" />

                        <!-- C3 -->
                        <line x1="180" y1="60" x2="180" y2="30" class="candle-wick" /> <!-- Low 60 -->
                        <rect x="170" y="30" width="20" height="20" class="candle-body-green" />

                        <!-- GAP ZONE (120 to 60) -->
                        <rect id="fvg-zone" x="80" y="60" width="300" height="60" class="fvg-zone opacity-0" />
                        <text id="fvg-text" x="250" y="95" text-anchor="middle"
                            class="text-xs fill-amber-400 font-bold opacity-0">FVG (Ineficiencia)</text>

                        <!-- Rebalancing Candle (Animated) -->
                        <g id="rebalance-candle" class="opacity-0">
                            <!-- Starts at C3 close -->
                            <rect id="rb-body" x="210" y="30" width="20" height="0" class="candle-body-red" />
                            <line id="rb-wick" x1="220" y1="30" x2="220" y2="30" class="candle-wick" />
                        </g>
                    </svg>
                </div>
                <div class="mt-4 text-xs text-slate-500">
                    Definici√≥n: Espacio entre el m√°ximo de la vela 1 y el m√≠nimo de la vela 3. El precio regresa para
                    ofrecer una oportunidad de entrada "justa".
                </div>
            </div>
        </section>

        <section id="gestion-riesgo" class="mb-16 scroll-mt-24 bg-slate-50 p-8 rounded-2xl border border-slate-200">
            <div class="flex items-center mb-8">
                <i data-lucide="shield-check" class="w-8 h-8 text-kawn-base mr-4"></i>
                <h2 class="text-3xl font-bold text-slate-900">Gesti√≥n Avanzada del Riesgo: El Pilar Fundamental</h2>
            </div>

            <p class="mb-6 font-medium text-lg">
                La gesti√≥n del riesgo es el factor decisivo que separa a los traders rentables de los que no lo son. El
                primer objetivo es siempre preservar el capital.
            </p>

            <div class="grid md:grid-cols-2 gap-12">
                <div>
                    <h3 class="font-bold text-kawn-deep mb-4">Principios Clave de Preservaci√≥n:</h3>
                    <ul class="custom-list text-sm space-y-3">
                        <li><i data-lucide="check-circle-2"></i> <strong>Regla del 1-2%:</strong> Nunca arriesgar m√°s
                            del 1-2% del capital por operaci√≥n para sobrevivir a rachas perdedoras.</li>
                        <li><i data-lucide="check-circle-2"></i> <strong>Consistencia:</strong> Mantener el porcentaje
                            de riesgo fijo, evitando "subir la apuesta" por confianza excesiva.</li>
                        <li><i data-lucide="check-circle-2"></i> <strong>Ratio Riesgo/Beneficio (R:B):</strong> Buscar
                            operaciones con un m√≠nimo de 1:2, idealmente 1:3, para tener esperanza matem√°tica positiva
                            incluso con bajo win rate.</li>
                        <li><i data-lucide="x-circle" class="text-red-500"></i> <strong>Disciplina de Stop:</strong>
                            Jam√°s mover un stop-loss para ampliar la p√©rdida potencial una vez iniciada la operaci√≥n.
                        </li>
                    </ul>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-kawn-base/20">
                    <h4 class="font-bold text-kawn-dark mb-4 flex items-center"><i data-lucide="calculator"
                            class="mr-2 w-5 h-5"></i> Calculadora de Posici√≥n R√°pida</h4>
                    <div class="space-y-4 text-sm">
                        <div>
                            <label class="block text-slate-700 font-bold mb-1">Capital de la Cuenta ($)</label>
                            <input type="number" id="calc-capital"
                                class="w-full border border-slate-300 rounded px-3 py-2 focus:ring-kawn-base outline-none"
                                value="10000" min="0">
                        </div>
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <label class="block text-slate-700 font-bold mb-1">Riesgo (%)</label>
                                <input type="number" id="calc-risk"
                                    class="w-full border border-slate-300 rounded px-3 py-2 focus:ring-kawn-base outline-none"
                                    value="1.0" step="0.1" max="100" min="0">
                            </div>
                            <div class="flex-1">
                                <label class="block text-slate-700 font-bold mb-1">Stop Loss (Pips)</label>
                                <input type="number" id="calc-stop"
                                    class="w-full border border-slate-300 rounded px-3 py-2 focus:ring-kawn-base outline-none"
                                    value="20" min="0">
                            </div>
                        </div>
                        <div>
                            <label class="block text-slate-700 font-bold mb-1">Valor por Pip ($/lote)</label>
                            <input type="number" id="calc-pipval"
                                class="w-full border border-slate-300 rounded px-3 py-2 focus:ring-kawn-base outline-none"
                                value="10" placeholder="Ej: 10 para EURUSD" min="0">
                        </div>
                        <button onclick="calculatePosition()"
                            class="w-full bg-kawn-base text-white font-bold py-2 rounded hover:bg-kawn-dark transition-colors shadow">Calcular
                            Tama√±o</button>

                        <!-- Visual Bar for Risk -->
                        <div id="risk-bar-container"
                            class="mt-4 h-4 w-full bg-slate-100 rounded-full overflow-hidden hidden">
                            <div id="risk-bar-fill" class="h-full bg-kawn-base transition-all duration-1000"
                                style="width: 0%"></div>
                        </div>

                        <div id="calc-result" class="mt-2 p-4 bg-slate-100 rounded-lg hidden animate-in fade-in">
                            <div class="flex justify-between items-end border-b border-slate-200 pb-2 mb-2">
                                <span class="text-sm text-slate-500">Riesgo Monetario:</span>
                                <span class="font-bold text-red-600 text-lg" id="res-risk-usd">$100.00</span>
                            </div>
                            <div class="flex justify-between items-end">
                                <span class="text-sm text-slate-500">Tama√±o (Lotes):</span>
                                <span class="font-black text-kawn-deep text-2xl" id="res-lots">0.50</span>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2 text-center">F√≥rmula: (Capital √ó %Riesgo) / (Stop
                                √ó ValorPip)</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="psicologia" class="mb-16 scroll-mt-24">
            <div class="flex items-center mb-8">
                <i data-lucide="brain" class="w-8 h-8 text-kawn-base mr-4"></i>
                <h2 class="text-3xl font-bold text-slate-900">Psicolog√≠a y Disciplina del Trader Avanzado</h2>
            </div>
            <p class="mb-6">
                En niveles avanzados, la diferencia entre el √©xito y el fracaso reside en la gesti√≥n de las emociones y
                la consistencia. Una mentalidad ganadora es estad√≠stica y sistem√°tica, no emocional.
            </p>

            <div class="grid md:grid-cols-2 gap-8 mb-8">
                <div class="bg-red-50 p-6 rounded-xl border-t-4 border-red-500">
                    <h3 class="font-bold text-red-800 mb-4 flex items-center"><i data-lucide="x-octagon"
                            class="mr-2"></i> Trampas Psicol√≥gicas Comunes</h3>
                    <ul class="custom-list text-sm text-red-900">
                        <li><i data-lucide="x" class="text-red-500"></i> <strong>Revenge Trading:</strong> Intentar
                            recuperar una p√©rdida inmediatamente con ira, aumentando el riesgo.</li>
                        <li><i data-lucide="x" class="text-red-500"></i> <strong>FOMO (Miedo a perderse algo):</strong>
                            Entrar tarde o sin se√±al por temor a perder una oportunidad.</li>
                        <li><i data-lucide="x" class="text-red-500"></i> <strong>An√°lisis-Par√°lisis:</strong> Sobrecarga
                            de informaci√≥n que impide tomar decisiones.</li>
                        <li><i data-lucide="x" class="text-red-500"></i> <strong>Overtrading:</strong> Operar en exceso
                            por aburrimiento o codicia, bajando la calidad de los trades.</li>
                    </ul>
                </div>
                <div class="bg-kawn-light/30 p-6 rounded-xl border-t-4 border-kawn-base">
                    <h3 class="font-bold text-kawn-deep mb-4 flex items-center"><i data-lucide="check-circle"
                            class="mr-2"></i> Mentalidad Ganadora</h3>
                    <ul class="custom-list text-sm">
                        <li><i data-lucide="check" class="text-kawn-base"></i> <strong>Paciencia:</strong> Saber esperar
                            las condiciones correctas; "no hacer nada es una posici√≥n v√°lida".</li>
                        <li><i data-lucide="check" class="text-kawn-base"></i> <strong>Disciplina F√©rrea:</strong>
                            Adherirse al plan de trading bajo todas las circunstancias.</li>
                        <li><i data-lucide="check" class="text-kawn-base"></i> <strong>Objetividad:</strong> Evaluar el
                            mercado por lo que es, admitiendo errores r√°pidamente.</li>
                        <li><i data-lucide="check" class="text-kawn-base"></i> <strong>Perspectiva a Largo
                                Plazo:</strong> Pensar en series de operaciones, no en el resultado de un solo trade.
                        </li>
                    </ul>
                </div>
            </div>

            <div class="highlight-quote">
                <p class="mb-2 font-bold">"S√© temerario con tu disciplina, no con tus trades."</p>
                <p class="text-sm">S√© obstinado en cumplir tus reglas y humilde para admitir cuando tu trade no va bien.
                </p>
            </div>
        </section>

        <section class="mb-16 scroll-mt-24">
            <div class="flex items-center mb-8">
                <i data-lucide="clipboard-check" class="w-8 h-8 text-kawn-base mr-4"></i>
                <h2 class="text-3xl font-bold text-slate-900">Casos Pr√°cticos y Reflexi√≥n Final</h2>
            </div>

            <div class="grid md:grid-cols-2 gap-6 mb-10">
                <div
                    class="bg-white p-6 rounded-lg shadow-md border-l-4 border-green-500 overflow-hidden relative group">
                    <div
                        class="absolute top-0 right-0 -mt-4 -mr-4 bg-green-100 text-green-800 w-16 h-16 rounded-full flex items-center justify-center font-bold rotate-12 shadow-sm transition-transform group-hover:rotate-45">
                        √âXITO</div>
                    <h4 class="font-bold text-lg text-green-800 mb-2">Caso: Toma de Liquidez en NFP</h4>
                    <p class="text-xs text-slate-500 mb-3">Estrategia "Sopa de Tortuga" aplicada correctamente.</p>
                    <ul class="text-sm space-y-2 mb-4">
                        <li class="flex items-start"><i data-lucide="check"
                                class="w-4 h-4 text-green-500 mr-2 mt-1"></i> Esper√≥ la manipulaci√≥n inicial (caza de
                            stops) sin entrar.</li>
                        <li class="flex items-start"><i data-lucide="check"
                                class="w-4 h-4 text-green-500 mr-2 mt-1"></i> Entr√≥ tras confirmar reversi√≥n y cambio de
                            estructura.</li>
                        <li class="flex items-start"><i data-lucide="check"
                                class="w-4 h-4 text-green-500 mr-2 mt-1"></i> Mantuvo riesgo bajo (0.5%) y un R:R alto
                            (1:3.5).</li>
                    </ul>
                    <p class="text-xs font-bold text-green-700">Resultado: +1.75% Ganancia. Clave: Paciencia y
                        disciplina.</p>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-500 overflow-hidden relative group">
                    <div
                        class="absolute top-0 right-0 -mt-4 -mr-4 bg-red-100 text-red-800 w-16 h-16 rounded-full flex items-center justify-center font-bold rotate-12 shadow-sm transition-transform group-hover:rotate-45">
                        ERROR</div>
                    <h4 class="font-bold text-lg text-red-800 mb-2">Caso: Operativa Prematura en FOMC</h4>
                    <p class="text-xs text-slate-500 mb-3">Violaci√≥n del plan y gesti√≥n de riesgo deficiente.</p>
                    <ul class="text-sm space-y-2 mb-4">
                        <li class="flex items-start"><i data-lucide="x" class="w-4 h-4 text-red-500 mr-2 mt-1"></i>
                            Entr√≥ impulsivamente en la primera fase sin esperar la conferencia.</li>
                        <li class="flex items-start"><i data-lucide="x" class="w-4 h-4 text-red-500 mr-2 mt-1"></i>
                            Ignor√≥ la estructura de doble manipulaci√≥n del evento.</li>
                        <li class="flex items-start"><i data-lucide="x" class="w-4 h-4 text-red-500 mr-2 mt-1"></i>
                            Ampli√≥ el stop arbitrariamente, excediendo el riesgo m√°ximo.</li>
                    </ul>
                    <p class="text-xs font-bold text-red-700">Resultado: -1.2% P√©rdida. Lecci√≥n: Ninguna estrategia
                        salva a un trader indisciplinado.</p>
                </div>
            </div>

            <p class="text-lg font-medium text-slate-700 mb-6">
                No hay atajos m√°gicos. El √©xito sostenible en trading proviene de alinear una estrategia con ventaja
                estad√≠stica, una impecable gesti√≥n del riesgo y la disciplina para ejecutarlas consistentemente.
            </p>
            <p class="text-center font-bold text-kawn-deep text-xl mt-8">
                Trading avanzado significa hacer con excelencia lo ordinario: planificar, proteger y aprender.
            </p>

        </section>

        <section id="ai-lab-adv"
            class="mb-16 scroll-mt-24 bg-gradient-to-br from-slate-50 to-kawn-light/20 p-8 rounded-3xl border border-kawn-base/20">
            <div class="flex items-center mb-8">
                <i data-lucide="sparkles" class="w-8 h-8 text-kawn-base mr-4"></i>
                <h2 class="text-3xl font-bold text-slate-900">Laboratorio de Inteligencia KawnBit (Cap. 15) ‚ú®</h2>
            </div>

            <div class="grid lg:grid-cols-3 gap-8">

                <div
                    class="lg:col-span-2 bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden flex flex-col h-[500px]">
                    <div class="bg-gradient-to-r from-kawn-deep to-kawn-dark p-4 flex justify-between items-center">
                        <div class="flex items-center text-white">
                            <i data-lucide="bot" class="w-6 h-6 mr-2"></i>
                            <div>
                                <h3 class="font-bold text-sm">Mentor Avanzado IA</h3>
                                <p class="text-[10px] opacity-80">Especialista en Noticias, Order Flow y Riesgo</p>
                            </div>
                        </div>
                        <!-- API Key Input for Demo (Usually handled via Proxy) -->
                        <div class="flex items-center gap-2">
                            <input type="password" id="api-key-input" placeholder="Clave API (Opcional)"
                                class="bg-white/10 border-none text-white text-xs px-2 py-1 rounded placeholder-white/50 focus:ring-1 focus:ring-white"
                                title="Ingresa tu clave de Gemini si no usas Proxy">
                            <span class="bg-green-400 w-2 h-2 rounded-full animate-pulse"></span>
                        </div>
                    </div>

                    <div id="chat-messages-adv" class="flex-1 p-6 overflow-y-auto bg-slate-50">
                        <div class="ai-message bot">
                            Hola. Soy tu mentor especializado en el Cap√≠tulo 15. Preg√∫ntame sobre la operativa en
                            NFP/FOMC, c√≥mo interpretar la absorci√≥n en el order flow, o c√≥mo calcular tu riesgo
                            institucionalmente. ¬°Adelante! ‚ú®
                        </div>
                    </div>

                    <div class="p-4 bg-white border-t border-slate-200">
                        <form id="chat-form-adv" class="flex gap-2">
                            <input type="text" id="user-input-adv"
                                class="flex-1 border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-kawn-base focus:border-transparent outline-none"
                                placeholder="Ej: ¬øC√≥mo identifico una 'sopa de tortuga' en el NFP?" autocomplete="off"
                                aria-label="Escribe tu pregunta para el mentor">
                            <button type="submit" id="chat-submit-btn-adv"
                                class="bg-kawn-dark text-white p-2 rounded-lg hover:bg-kawn-base transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                aria-label="Enviar mensaje">
                                <i data-lucide="send" class="w-5 h-5"></i>
                            </button>
                        </form>
                        <p class="text-[10px] text-center text-slate-400 mt-2">Powered by Gemini. Tus respuestas se
                            generan en tiempo real.</p>
                    </div>
                </div>

                <div class="flex flex-col gap-6">

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex-1 flex flex-col">
                        <h3 class="font-bold text-kawn-deep mb-3 flex items-center"><i data-lucide="radar"
                                class="mr-2"></i> Analizador de Eventos/Flujo</h3>
                        <p class="text-xs text-slate-500 mb-3">Describe una reacci√≥n a una noticia o una lectura de
                            order flow. La IA buscar√° manipulaciones.</p>

                        <textarea id="scenario-input-adv"
                            class="w-full h-20 border border-slate-200 rounded p-3 text-sm focus:ring-1 focus:ring-kawn-base outline-none resize-none mb-3"
                            placeholder="Ej: Sali√≥ el IPC positivo, el precio barri√≥ el m√≠nimo de ayer con mucho delta vendedor pero revirti√≥ r√°pido..."
                            aria-label="Descripci√≥n del escenario"></textarea>

                        <button id="scenario-btn-adv" onclick="analyzeScenarioAdv()"
                            class="w-full py-2 bg-slate-800 text-white rounded font-bold text-sm hover:bg-slate-700 transition flex justify-center items-center gap-2 mb-3 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="sparkles" class="w-4 h-4"></i> Analizar Escenario Avanzado
                        </button>

                        <div id="scenario-result-adv"
                            class="bg-slate-50 p-3 rounded border border-slate-100 text-xs text-slate-700 h-24 overflow-y-auto custom-scrollbar"
                            aria-live="polite">
                            <span class="opacity-50 italic">Esperando descripci√≥n del evento...</span>
                        </div>
                    </div>

                    <!-- NEW PSYCHOLOGY COACH TOOL -->
                    <div
                        class="bg-white p-6 rounded-2xl shadow-sm border border-l-4 border-l-purple-500 border-slate-200 flex-1 flex flex-col relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-16 h-16 bg-purple-100 rounded-bl-full -mr-8 -mt-8 z-0">
                        </div>
                        <h3 class="font-bold text-purple-900 mb-2 flex items-center relative z-10"><i
                                data-lucide="brain-circuit" class="mr-2 w-5 h-5"></i> Coach de Psicolog√≠a</h3>
                        <p class="text-xs text-slate-500 mb-3 relative z-10">¬øTilt? ¬øEuforia? Describe tu estado
                            emocional actual.</p>

                        <textarea id="psych-input"
                            class="w-full h-16 border border-slate-200 rounded p-2 text-sm focus:ring-1 focus:ring-purple-500 outline-none resize-none mb-2 z-10 relative"
                            placeholder="Ej: Acabo de perder 3 operaciones seguidas..."
                            aria-label="Descripci√≥n de estado emocional"></textarea>

                        <button id="psych-btn" onclick="analyzePsychology()"
                            class="w-full py-2 bg-purple-600 text-white rounded font-bold text-sm hover:bg-purple-700 transition flex justify-center items-center gap-2 mb-3 z-10 relative disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="heart-pulse" class="w-4 h-4"></i> Obtener Consejo
                        </button>

                        <div id="psych-result"
                            class="hidden bg-purple-50 p-3 rounded border border-purple-100 text-xs text-purple-900 max-h-24 overflow-y-auto z-10 relative"
                            aria-live="polite"></div>
                    </div>

                    <div
                        class="bg-white p-6 rounded-2xl shadow-sm border border-kawn-base/20 flex-1 flex flex-col justify-center relative overflow-hidden">
                        <div
                            class="absolute top-0 right-0 w-24 h-24 bg-kawn-light/50 rounded-bl-full -mr-10 -mt-10 z-0">
                        </div>
                        <h3 class="font-bold text-kawn-deep mb-2 flex items-center relative z-10"><i data-lucide="award"
                                class="mr-2"></i> Desaf√≠o Cap. 15 ‚ú®</h3>
                        <p class="text-xs text-slate-500 mb-4 relative z-10">Pon a prueba tu conocimiento sobre
                            estrategias avanzadas, riesgo y psicolog√≠a.</p>

                        <div id="quiz-container-adv" class="relative z-10">
                            <button id="quiz-btn-adv" onclick="generateQuizAdv()"
                                class="w-full py-3 bg-kawn-base text-white rounded-lg font-bold text-sm hover:bg-kawn-dark transition flex justify-center items-center gap-2 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="zap" class="w-4 h-4"></i> Generar Quiz Avanzado
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </section>

    </main>

    <footer class="bg-slate-900 text-slate-400 py-12">
        <div
            class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-3">
                <div class="flex flex-col items-start opacity-80">
                    <span class="font-display font-black text-white text-xl tracking-tight leading-none">KawnBit</span>
                    <span
                        class="text-[0.5rem] font-bold text-kawn-base uppercase tracking-[0.15em] leading-none mt-0.5">Quantitative
                        Trading Community</span>
                </div>
            </div>
            <p class="text-sm text-center md:text-right">
                ¬© <span id="current-year">2024</span> KawnBit Magazine. Todos los derechos reservados.<br>
                <span class="text-xs opacity-50">Material educativo basado en fuentes proporcionadas. No constituye
                    asesoramiento financiero.</span>
            </p>
        </div>
    </footer>

    <script>
        // GLOBAL SCOPE - API Key Definition to ensure access by functions defined later
        const apiKey = "";

        document.addEventListener('DOMContentLoaded', () => {
            // Init Global Utils
            document.getElementById('current-year').textContent = new Date().getFullYear();
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // -----------------------------------------------------
            // 1. TURTLE SOUP CHART LOGIC (Interactive)
            // -----------------------------------------------------
            updateTurtleChart();

            // Chat Logic Initialization
            const chatFormAdv = document.getElementById('chat-form-adv');
            const chatInputAdv = document.getElementById('user-input-adv');
            const chatMessagesAdv = document.getElementById('chat-messages-adv');
            const chatSubmitBtnAdv = document.getElementById('chat-submit-btn-adv');

            const MENTOR_SYSTEM_PROMPT = `
                Eres KawnBit Mentor Avanzado, experto en trading institucional (Cap√≠tulo 15).
                Temas: Noticias (NFP/FOMC), Sopa de Tortuga, Order Flow, Riesgo 1%, Psicolog√≠a.
                Tono: Profesional, conciso y motivador en Espa√±ol.
                Objetivo: Ayudar al alumno a entender los conceptos avanzados del art√≠culo.
            `;

            if (chatFormAdv) {
                chatFormAdv.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const message = chatInputAdv.value.trim();
                    if (!message) return;

                    chatInputAdv.disabled = true; chatSubmitBtnAdv.disabled = true;
                    appendMessage(chatMessagesAdv, message, 'user');
                    chatInputAdv.value = '';

                    const loadingId = appendTypingIndicator(chatMessagesAdv);
                    const reply = await callGeminiAPI(MENTOR_SYSTEM_PROMPT, message);

                    // Safely remove loader if it exists
                    const loaderEl = document.getElementById(loadingId);
                    if (loaderEl) loaderEl.remove();

                    if (reply) appendMessage(chatMessagesAdv, reply, 'bot');
                    else appendMessage(chatMessagesAdv, "Error: Verifica tu conexi√≥n o clave API.", 'bot error text-red-500');

                    chatInputAdv.disabled = false; chatSubmitBtnAdv.disabled = false; chatInputAdv.focus();
                });
            }
        });

        // -----------------------------------------------------
        // GLOBAL FUNCTIONS (Defined outside for cleaner scope access if needed)
        // -----------------------------------------------------

        let currentStep = 0;
        const stepsData = [
            { path: "M50,150 L150,150", desc: "Rango inicial previo a la noticia." },
            { path: "M50,150 L150,150 L170,80", desc: "Barrida de RESISTENCIA (Stops Venta)." },
            { path: "M50,150 L150,150 L170,80 L190,220", desc: "Reverso Violento -> Barrida SOPORTE." },
            { path: "M50,150 L150,150 L170,80 L190,220 L250,180 L350,120", desc: "Reversi√≥n Real y Entrada." }
        ];

        function setTurtleStep(step) { currentStep = step; updateTurtleChart(); }
        function nextTurtleStep() { currentStep = (currentStep < stepsData.length - 1) ? currentStep + 1 : 0; updateTurtleChart(); }

        function updateTurtleChart() {
            const pathGroup = document.getElementById('turtle-path-group');
            const markersGroup = document.getElementById('turtle-markers');
            const phaseText = document.getElementById('turtle-phase-text');
            if (!pathGroup) return;

            pathGroup.innerHTML = ''; markersGroup.innerHTML = '';

            for (let i = 0; i < 4; i++) {
                const el = document.getElementById(`desc-step-${i}`);
                if (el) {
                    if (i === currentStep) { el.classList.remove('opacity-50'); el.classList.add('font-bold', 'text-kawn-deep'); }
                    else { el.classList.add('opacity-50'); el.classList.remove('font-bold', 'text-kawn-deep'); }
                }
            }

            const d = stepsData[currentStep].path;
            const pathElement = document.createElementNS("http://www.w3.org/2000/svg", "path");
            pathElement.setAttribute("d", d);
            pathElement.style.strokeDasharray = "1000"; pathElement.style.strokeDashoffset = "1000"; pathElement.style.animation = "dash 2s forwards";
            pathGroup.appendChild(pathElement);

            phaseText.textContent = `${currentStep + 1}. ${stepsData[currentStep].desc}`;

            if (currentStep >= 1) addMarker(170, 80, "red");
            if (currentStep >= 2) addMarker(190, 220, "green");
            if (currentStep >= 3) {
                addMarker(250, 180, "orange");
                const arrowLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                arrowLine.setAttribute("x1", "250"); arrowLine.setAttribute("y1", "180");
                arrowLine.setAttribute("x2", "300"); arrowLine.setAttribute("y2", "140");
                arrowLine.setAttribute("stroke", "#fbbf24"); arrowLine.setAttribute("stroke-width", "2");
                arrowLine.setAttribute("marker-end", "url(#arrow)"); arrowLine.setAttribute("stroke-dasharray", "4,4");
                markersGroup.appendChild(arrowLine);
            }
        }

        function addMarker(cx, cy, color) {
            const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.setAttribute("cx", cx); circle.setAttribute("cy", cy); circle.setAttribute("r", "6");
            circle.setAttribute("fill", color === "orange" ? "#fbbf24" : (color === "red" ? "#ef4444" : "#10b981"));
            circle.classList.add("animate-pulse");
            document.getElementById('turtle-markers').appendChild(circle);
        }

        let liquidityState = 'reset';
        function animateLiquidity() {
            const btn = document.getElementById('liquidity-btn');
            const path = document.getElementById('liq-price-path');
            const head = document.getElementById('price-head');
            const annotation = document.getElementById('liq-annotation');
            const moneyBottom = document.getElementById('money-bottom');

            if (liquidityState === 'reset') {
                btn.disabled = true;
                path.setAttribute("d", "M50,125 L150,130 L200,175 L220,195");
                head.setAttribute("cx", 220); head.setAttribute("cy", 195);
                setTimeout(() => {
                    annotation.classList.remove('opacity-0'); moneyBottom.style.opacity = '0';
                    setTimeout(() => {
                        path.setAttribute("d", "M50,125 L150,130 L200,175 L220,195 L250,170 L350,90");
                        head.setAttribute("cx", 350); head.setAttribute("cy", 90);
                        liquidityState = 'swept';
                        btn.innerHTML = '<i data-lucide="rotate-ccw" class="w-4 h-4 mr-2"></i> Resetear';
                        btn.disabled = false;
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }, 1000);
                }, 500);
            } else {
                path.setAttribute("d", "M50,125 L150,130 L200,175");
                head.setAttribute("cx", 200); head.setAttribute("cy", 175);
                annotation.classList.add('opacity-0'); moneyBottom.style.opacity = '1';
                liquidityState = 'reset';
                btn.innerHTML = '<i data-lucide="skull" class="w-4 h-4 mr-2"></i> Ejecutar Barrida (Stop Hunt)';
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        }

        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontent.length; i++) { tabcontent[i].classList.remove("active"); }
            const tablinks = document.getElementsByClassName("tab-btn");
            for (let i = 0; i < tablinks.length; i++) { tablinks[i].classList.remove("active"); }
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        function showOfTooltip(evt, type, volume, delta) {
            const tooltip = document.getElementById('chart-tooltip-container');
            tooltip.innerHTML = `<div class="font-bold border-b border-slate-600 mb-1 pb-1">${type}</div><div class="flex justify-between gap-4"><span>Bid x Ask:</span> <span class="font-mono">${volume}</span></div><div class="flex justify-between gap-4 text-green-300"><span>${delta}</span></div>`;
            tooltip.classList.add('visible');
            const container = evt.currentTarget.closest('.bg-slate-900').getBoundingClientRect();
            tooltip.style.left = (evt.clientX - container.left + 15) + 'px';
            tooltip.style.top = (evt.clientY - container.top - 10) + 'px';
        }

        function hideChartTooltip() {
            document.getElementById('chart-tooltip-container').classList.remove('visible');
        }

        let vpVisible = false;
        function toggleVolumeProfile() {
            const labels = document.getElementById('vp-labels');
            const vaBars = document.querySelectorAll('.va-bar');
            const pocBar = document.querySelector('.poc-bar');
            vpVisible = !vpVisible;
            if (vpVisible) {
                labels.classList.remove('opacity-0');
                vaBars.forEach(b => b.style.fill = "#bae6fd");
                pocBar.style.fill = "#f87171";
            } else {
                labels.classList.add('opacity-0');
                vaBars.forEach(b => b.style.fill = "#cbd5e1");
                pocBar.style.fill = "#cbd5e1";
            }
        }

        let fvgState = 'ready';
        let fvgInterval = null;
        function animateFVG() {
            const btn = document.getElementById('fvg-btn');
            const candle = document.getElementById('rebalance-candle');
            const body = document.getElementById('rb-body');
            const wick = document.getElementById('rb-wick');
            const zone = document.getElementById('fvg-zone');
            const text = document.getElementById('fvg-text');

            if (fvgState === 'ready') {
                btn.disabled = true;
                zone.classList.remove('opacity-0'); text.classList.remove('opacity-0');
                setTimeout(() => {
                    candle.classList.remove('opacity-0');
                    let h = 0;
                    if (fvgInterval) clearInterval(fvgInterval);
                    fvgInterval = setInterval(() => {
                        h += 1;
                        body.setAttribute('height', h);
                        wick.setAttribute('y2', 30 + h + 10);
                        if (h >= 60) {
                            clearInterval(fvgInterval);
                            setTimeout(() => {
                                body.setAttribute('height', 20); body.setAttribute('y', 30);
                                body.classList.remove('candle-body-red'); body.classList.add('candle-body-green');
                                btn.innerHTML = "Resetear Simulaci√≥n"; btn.disabled = false; fvgState = 'done';
                            }, 500);
                        }
                    }, 10);
                }, 500);
            } else {
                zone.classList.add('opacity-0'); text.classList.add('opacity-0'); candle.classList.add('opacity-0');
                body.setAttribute('height', 0); body.setAttribute('y', 30);
                body.classList.add('candle-body-red'); body.classList.remove('candle-body-green');
                btn.innerHTML = "Simular Testeo del Gap"; fvgState = 'ready';
            }
        }

        function calculatePosition() {
            const capital = parseFloat(document.getElementById('calc-capital').value);
            const riskPercent = parseFloat(document.getElementById('calc-risk').value);
            const stopPips = parseFloat(document.getElementById('calc-stop').value);
            const pipValue = parseFloat(document.getElementById('calc-pipval').value);

            if (isNaN(capital) || isNaN(riskPercent) || isNaN(stopPips) || isNaN(pipValue) || stopPips <= 0 || pipValue <= 0) {
                alert("Por favor ingresa valores v√°lidos mayores a cero."); return;
            }

            const riskUSD = capital * (riskPercent / 100);
            const positionSize = riskUSD / (stopPips * pipValue);

            document.getElementById('res-risk-usd').textContent = '$' + riskUSD.toFixed(2);
            document.getElementById('res-lots').textContent = positionSize.toFixed(2);
            document.getElementById('calc-result').classList.remove('hidden');
            document.getElementById('risk-bar-container').classList.remove('hidden');

            const barFill = document.getElementById('risk-bar-fill');
            setTimeout(() => {
                let visualPct = (riskPercent / 5) * 100; if (visualPct > 100) visualPct = 100;
                barFill.style.width = visualPct + '%';
                if (riskPercent > 2) { barFill.classList.remove('bg-kawn-base'); barFill.classList.add('bg-red-500'); }
                else { barFill.classList.add('bg-kawn-base'); barFill.classList.remove('bg-red-500'); }
            }, 100);
        }

        const proxyUrl = "/.netlify/functions/gemini-proxy";

        // --- API UTILS ---
        async function callGeminiAPI(systemInstruction, userPrompt) {
            try {
                const response = await fetch(proxyUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userPrompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Proxy Error: ${response.status}`);
                }

                const data = await response.json();

                // Extraemos la respuesta de la estructura de Gemini o del campo result del proxy
                if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                    return data.candidates[0].content.parts[0].text;
                }
                return data.result || null;

            } catch (error) {
                console.error("Gemini Proxy Error:", error);
                return null;
            }
        }

        function appendMessage(container, text, sender) {
            const div = document.createElement('div'); div.className = `ai-message ${sender}`;
            if (typeof marked !== 'undefined') {
                try { div.innerHTML = marked.parse(text); } catch (e) { div.innerText = text; }
            } else { div.innerText = text; }
            container.appendChild(div); container.scrollTop = container.scrollHeight;
        }

        function appendTypingIndicator(container) {
            const id = 'loading-' + Date.now(); const div = document.createElement('div');
            div.id = id; div.className = 'ai-message bot typing-indicator';
            div.innerHTML = '<span></span><span></span><span></span>';
            container.appendChild(div); container.scrollTop = container.scrollHeight;
            return id;
        }

        async function analyzeScenarioAdv() {
            const input = document.getElementById('scenario-input-adv').value;
            const resultBox = document.getElementById('scenario-result-adv');
            const btn = document.getElementById('scenario-btn-adv');

            if (!input.trim()) { resultBox.innerHTML = '<span class="text-red-500">Por favor describe un escenario.</span>'; return; }
            btn.disabled = true; btn.innerHTML = '<i data-lucide="loader" class="animate-spin w-4 h-4"></i> Analizando...'; if (typeof lucide !== 'undefined') lucide.createIcons();

            const PROMPT = "Analista Senior: Analiza este escenario de mercado (Trading Cap 15). S√© breve y t√©cnico.";
            const analysis = await callGeminiAPI(PROMPT, input);
            btn.disabled = false; btn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i> Analizar Escenario Avanzado'; if (typeof lucide !== 'undefined') lucide.createIcons();

            if (analysis) {
                try { resultBox.innerHTML = marked.parse(analysis); } catch (e) { resultBox.innerText = analysis; }
            } else {
                resultBox.innerHTML = '<span class="text-red-500 font-bold">‚ö†Ô∏è Clave API requerida. Ingresa tu clave en el panel superior.</span>';
            }
        }

        async function analyzePsychology() {
            const input = document.getElementById('psych-input').value;
            const resultBox = document.getElementById('psych-result');
            const btn = document.getElementById('psych-btn');

            if (!input.trim()) { alert("Describe tu estado primero."); return; }
            btn.disabled = true; btn.innerHTML = '<i data-lucide="loader" class="animate-spin w-4 h-4"></i> Analizando...'; if (typeof lucide !== 'undefined') lucide.createIcons();

            const advice = await callGeminiAPI("Coach Trading Psicolog√≠a: Consejo breve y directo sobre: " + input, input);

            btn.disabled = false; btn.innerHTML = '<i data-lucide="heart-pulse" class="w-4 h-4"></i> Obtener Consejo'; if (typeof lucide !== 'undefined') lucide.createIcons();
            resultBox.classList.remove('hidden');

            if (advice) {
                try { resultBox.innerHTML = marked.parse(advice); } catch (e) { resultBox.innerText = advice; }
            } else {
                resultBox.innerHTML = '<span class="text-red-500 font-bold">‚ö†Ô∏è Clave API requerida.</span>';
            }
        }

        async function generateQuizAdv() {
            const container = document.getElementById('quiz-container-adv');
            container.innerHTML = `<div class="text-center py-6 text-kawn-dark"><i data-lucide="loader-2" class="animate-spin w-8 h-8 mx-auto mb-2"></i><p class="font-bold">Generando desaf√≠o...</p></div>`; if (typeof lucide !== 'undefined') lucide.createIcons();

            const QUIZ_PROMPT = `Genera 3 preguntas selecci√≥n m√∫ltiple Trading Avanzado. JSON: [{"q": "...", "options": ["A", "B"], "a": 0}]. Espa√±ol.`;

            try {
                let text = await callGeminiAPI("JSON Only", QUIZ_PROMPT);
                if (!text) throw new Error("No Auth");

                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                renderQuizAdv(JSON.parse(text));
            } catch (e) {
                renderQuizAdv([
                    { q: "¬øQu√© es la 'Sopa de Tortuga'?", options: ["Un indicador de volumen", "Un patr√≥n de manipulaci√≥n de stops", "Una estrategia de medias m√≥viles"], a: 1 },
                    { q: "¬øCu√°ndo se recomienda operar en FOMC?", options: ["Justo al salir el dato", "Nunca", "Tras la conferencia y confirmaci√≥n"], a: 2 },
                    { q: "¬øCu√°l es el riesgo m√°ximo recomendado por operaci√≥n?", options: ["5-10%", "1-2%", "Lo que sientas correcto"], a: 1 }
                ]);
            }
        }

        function renderQuizAdv(questions) {
            const container = document.getElementById('quiz-container-adv'); container.innerHTML = '';
            let score = 0; let answered = 0;
            const quizWrapper = document.createElement('div'); quizWrapper.className = 'space-y-4 animate-in fade-in relative z-10';

            questions.forEach((q, qIndex) => {
                const qDiv = document.createElement('div'); qDiv.className = 'border-b border-slate-100 pb-3 last:border-0';
                qDiv.innerHTML = `<p class="font-bold text-xs text-kawn-deep mb-2">${qIndex + 1}. ${q.q}</p>`;
                const optionsDiv = document.createElement('div');
                q.options.forEach((opt, optIndex) => {
                    const btn = document.createElement('div'); btn.className = 'quiz-option text-xs p-2 mb-1'; btn.textContent = opt;
                    btn.onclick = () => {
                        if (btn.parentElement.classList.contains('answered')) return;
                        btn.parentElement.classList.add('answered'); answered++;
                        if (optIndex === q.a) { btn.classList.add('correct'); score++; }
                        else { btn.classList.add('wrong'); optionsDiv.children[q.a].classList.add('correct'); }
                        if (answered === questions.length) showScoreAdv(score, questions.length);
                    };
                    optionsDiv.appendChild(btn);
                });
                qDiv.appendChild(optionsDiv); quizWrapper.appendChild(qDiv);
            });
            container.appendChild(quizWrapper);

            const resetBtn = document.createElement('button');
            resetBtn.className = 'w-full mt-2 text-xs text-slate-400 hover:text-kawn-base underline';
            resetBtn.textContent = 'Generar Nuevas Preguntas'; resetBtn.onclick = generateQuizAdv;
            container.appendChild(resetBtn);
        }

        function showScoreAdv(score, total) {
            const container = document.getElementById('quiz-container-adv');
            const result = document.createElement('div');
            result.className = 'mt-2 p-2 bg-kawn-light/50 border border-kawn-base rounded text-center text-sm font-bold text-kawn-deep animate-pulse';
            result.textContent = `Resultado: ${score}/${total}`;
            container.insertBefore(result, container.lastChild);
        }
    </script>
</body>

</html>