<!DOCTYPE html>
<html lang="es" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KawnBit Magazine | Cap 17: SMT - Smart Money Tool (Ultimate Edition)</title>
    <meta name="description"
        content="Guía definitiva sobre la herramienta SMT (Smart Money Tool), divergencias institucionales y análisis de correlación en trading.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Montserrat:wght@400;600;700;800;900&display=swap"
        rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kawn: {
                            light: '#ccfbf1', // Teal 100
                            base: '#14b8a6',  // Teal 500
                            dark: '#0f766e',  // Teal 700
                            deep: '#134e4a',  // Teal 900
                            accent: '#0d9488' // Teal 600
                        },
                        slate: {
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'slide-up': 'slideUp 0.5s ease-out',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos personalizados Magazine */
        body {
            background-color: #f8fafc;
            color: #334155;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        th {
            font-family: 'Montserrat', sans-serif;
        }

        p,
        li,
        td {
            font-family: 'Inter', sans-serif;
            line-height: 1.75;
        }

        .hero-gradient {
            background: linear-gradient(135deg, #0f172a 0%, #115e59 100%);
            position: relative;
        }

        .hero-pattern {
            background-image: radial-gradient(#ffffff 1px, transparent 1px);
            background-size: 30px 30px;
            opacity: 0.05;
            position: absolute;
            inset: 0;
        }

        /* Contenedores Visuales Mejorados */
        .visual-container {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            margin: 3rem 0;
            position: relative;
            overflow: hidden;
        }

        .visual-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #14b8a6, #0f766e);
        }

        /* Tablas Estilizadas */
        .table-container {
            overflow: hidden;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            margin: 2rem 0;
        }

        .magazine-table {
            width: 100%;
            border-collapse: collapse;
        }

        .magazine-table th {
            background-color: #f1f5f9;
            color: #0f172a;
            padding: 1.25rem;
            text-align: left;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        .magazine-table td {
            background-color: white;
            padding: 1.25rem;
            border-bottom: 1px solid #f1f5f9;
            color: #475569;
            transition: background-color 0.2s;
        }

        .magazine-table tr:last-child td {
            border-bottom: none;
        }

        .magazine-table tr:hover td {
            background-color: #f8fafc;
        }

        /* Quotes */
        .highlight-quote {
            position: relative;
            background: linear-gradient(to right, #f0fdfa, white);
            padding: 2rem;
            border-left: 5px solid #14b8a6;
            border-radius: 0 1rem 1rem 0;
            margin: 2.5rem 0;
            font-style: italic;
            color: #134e4a;
        }

        .highlight-quote::before {
            content: '"';
            position: absolute;
            top: 0.5rem;
            left: 1rem;
            font-size: 4rem;
            color: #ccfbf1;
            font-family: serif;
            line-height: 1;
            z-index: 0;
        }

        .highlight-quote p {
            position: relative;
            z-index: 1;
        }

        /* Botones Gráficos */
        .graph-btn {
            background-color: white;
            color: #475569;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid #cbd5e1;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .graph-btn:hover {
            border-color: #14b8a6;
            color: #0f766e;
            transform: translateY(-1px);
        }

        .graph-btn.active {
            background-color: #0f766e;
            color: white;
            border-color: #0f766e;
        }

        /* Chat AI Modernizado */
        .ai-chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            background: white;
            border-radius: 1.5rem;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .ai-header {
            background: linear-gradient(to right, #0f766e, #14b8a6);
            padding: 1rem 1.5rem;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .ai-input-area {
            padding: 1rem;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .ai-message {
            max-width: 80%;
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 1rem;
            font-size: 0.9rem;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .ai-message.user {
            background-color: #334155;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }

        .ai-message.bot {
            background-color: white;
            color: #334155;
            border: 1px solid #e2e8f0;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }

        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #94a3b8;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* Quiz Styles Enhanced */
        .quiz-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            transition: transform 0.2s;
        }

        .quiz-option {
            border: 2px solid #f1f5f9;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .quiz-option:hover {
            background-color: #f0fdfa;
            border-color: #ccfbf1;
        }

        .quiz-option.selected {
            border-color: #14b8a6;
            background-color: #f0fdfa;
        }

        .quiz-option.correct {
            background-color: #dcfce7;
            border-color: #22c55e;
            color: #15803d;
        }

        .quiz-option.wrong {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #b91c1c;
        }

        /* NUEVOS ESTILOS PARA SECCIONES EXTRA */
        .correlation-bar-container {
            position: relative;
            height: 40px;
            background: #e2e8f0;
            border-radius: 20px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .correlation-fill {
            height: 100%;
            transition: width 1s ease-in-out, background-color 0.5s;
        }

        .marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .triad-bar {
            transition: height 0.5s ease;
            border-radius: 8px 8px 0 0;
            position: relative;
        }

        .triad-bar:hover {
            filter: brightness(1.1);
        }

        .killzone-timeline {
            display: flex;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }

        .kz-segment {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
            transition: all 0.3s;
            cursor: help;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .kz-segment:hover {
            flex: 1.5;
        }

        /* AMD STYLES */
        .amd-stage {
            transition: all 0.5s ease;
            opacity: 0.3;
            transform: scale(0.95);
        }

        .amd-stage.active {
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-color: #14b8a6;
        }

        /* Premium Discount Styles */
        .pd-slider-container {
            position: relative;
            height: 300px;
            width: 60px;
            background: #e2e8f0;
            border-radius: 30px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            touch-action: none;
            /* Crucial for mobile */
        }

        .pd-zone {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            transition: all 0.3s;
            user-select: none;
        }

        .pd-premium {
            background: rgba(239, 68, 68, 0.1);
            border-radius: 30px 30px 0 0;
            color: #ef4444;
        }

        .pd-discount {
            background: rgba(16, 185, 129, 0.1);
            border-radius: 0 0 30px 30px;
            color: #10b981;
        }

        .pd-handle {
            position: absolute;
            left: -10px;
            right: -10px;
            height: 30px;
            background: white;
            border: 2px solid #334155;
            border-radius: 8px;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 20;
            top: 50%;
            transform: translateY(-50%);
            transition: top 0.1s;
        }

        .pd-handle:active {
            cursor: grabbing;
        }

        .pd-zone.active {
            opacity: 1;
            font-size: 0.8rem;
        }

        .pd-premium.active {
            background: rgba(239, 68, 68, 0.2);
        }

        .pd-discount.active {
            background: rgba(16, 185, 129, 0.2);
        }
    </style>
</head>

<body class="antialiased selection:bg-kawn-light selection:text-kawn-deep">

    <nav
        class="sticky top-0 z-50 bg-white/90 backdrop-blur-lg border-b border-slate-200 supports-[backdrop-filter]:bg-white/60">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center flex-shrink-0 cursor-pointer group">
                    <div
                        class="h-10 w-10 bg-gradient-to-br from-kawn-deep to-kawn-base rounded-xl shadow-lg flex items-center justify-center text-white font-black text-xl transform group-hover:rotate-6 transition-transform">
                        K</div>
                    <span
                        class="ml-3 font-display font-bold text-slate-800 text-xl tracking-tight hidden md:block">KAWNBIT
                        <span
                            class="text-kawn-base text-xs uppercase tracking-widest font-medium">Magazine</span></span>
                </div>

                <div class="hidden md:flex space-x-1">
                    <a href="#intro"
                        class="px-3 py-2 rounded-full text-slate-600 hover:text-kawn-deep hover:bg-slate-50 font-medium transition-all text-[0.65rem] uppercase tracking-wider">Concepto</a>
                    <a href="#divergencia"
                        class="px-3 py-2 rounded-full text-slate-600 hover:text-kawn-deep hover:bg-slate-50 font-medium transition-all text-[0.65rem] uppercase tracking-wider">SMT</a>
                    <a href="#amd"
                        class="px-3 py-2 rounded-full text-slate-600 hover:text-kawn-deep hover:bg-slate-50 font-medium transition-all text-[0.65rem] uppercase tracking-wider font-bold text-kawn-deep">AMD
                        & Ciclos</a>
                    <a href="#timing"
                        class="px-3 py-2 rounded-full text-slate-600 hover:text-kawn-deep hover:bg-slate-50 font-medium transition-all text-[0.65rem] uppercase tracking-wider">Timing</a>
                    <a href="#ai-lab"
                        class="ml-2 px-4 py-2 rounded-full bg-slate-900 text-white hover:bg-slate-800 font-bold transition-all text-[0.65rem] uppercase tracking-wider flex items-center shadow-md transform hover:-translate-y-0.5"><i
                            data-lucide="sparkles" class="w-3 h-3 mr-2 text-yellow-400"></i> AI Lab</a>
                </div>
            </div>
        </div>
    </nav>

    <section class="hero-gradient text-white py-32 overflow-hidden">
        <div class="hero-pattern"></div>
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10 text-center">
            <div
                class="inline-flex items-center py-1 px-4 rounded-full bg-white/10 border border-white/20 text-kawn-light text-xs font-bold uppercase tracking-widest mb-8 backdrop-blur-md shadow-xl animate-float">
                <span class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></span>
                Análisis Institucional Avanzado
            </div>
            <h1 class="text-5xl md:text-7xl font-black tracking-tighter leading-tight mb-8 drop-shadow-sm">
                Capítulo 17: SMT <br> <span
                    class="text-transparent bg-clip-text bg-gradient-to-r from-kawn-light to-white">Smart Money
                    Tool</span>
            </h1>
            <p class="text-xl md:text-2xl text-slate-200 font-light max-w-2xl mx-auto leading-relaxed opacity-90">
                Descubre cómo leer las huellas del dinero inteligente mediante la correlación de activos. Deja de ser la
                víctima del mercado y conviértete en el aliado de las grandes instituciones.
            </p>
        </div>
    </section>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-20">

        <!-- RESUMEN -->
        <div
            class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 mb-16 relative overflow-hidden group hover:shadow-md transition-shadow">
            <div
                class="absolute top-0 right-0 p-8 opacity-5 transform group-hover:scale-110 transition-transform duration-700">
                <i data-lucide="book-open" class="w-32 h-32 text-slate-900"></i>
            </div>
            <h3 class="font-bold text-kawn-deep mb-4 flex items-center text-lg"><span
                    class="bg-kawn-light p-2 rounded-lg mr-3 text-kawn-deep"><i data-lucide="bookmark"
                        class="w-5 h-5"></i></span> Resumen del Capítulo</h3>
            <p class="text-slate-600 mb-4 leading-relaxed">
                En este capítulo abordaremos en profundidad la herramienta <strong>SMT (Smart Money Tool)</strong>, un
                concepto avanzado del análisis institucional que permite interpretar el movimiento del “dinero
                inteligente” en los mercados financieros.
            </p>
            <p class="text-slate-600 leading-relaxed">
                Aprenderemos qué son las divergencias SMT, por qué ocurren y cómo utilizarlas paso a paso para anticipar
                cambios de tendencia. Incorporaremos ejemplos reales (índices, divisas, criptomonedas) y explicaremos
                cómo combinarlas con liquidez y Fair Value Gaps para obtener ventaja competitiva.
            </p>
        </div>

        <!-- INTRODUCCION -->
        <section id="intro" class="mb-20 scroll-mt-28">
            <div class="flex items-center mb-8 pb-4 border-b border-slate-200">
                <div class="p-3 bg-slate-900 rounded-xl mr-4 text-white shadow-lg">
                    <i data-lucide="brain-circuit" class="w-6 h-6"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-900 tracking-tight">Introducción: entendiendo el Smart Money
                </h2>
            </div>

            <p class="mb-6 text-lg font-medium text-slate-700 leading-relaxed">
                Antes de entrar de lleno en la herramienta SMT, es crucial comprender qué es el <strong>“Smart
                    Money”</strong> (dinero inteligente) y por qué sus movimientos importan.
            </p>
            <p class="mb-6 text-slate-600">
                El término se refiere al capital controlado por grandes instituciones financieras – bancos de inversión,
                hedge funds, gestoras de activos, traders algorítmicos – cuyo poder de fuego es tan grande que pueden
                influir en los precios del mercado con sus operaciones. A diferencia del inversor minorista que suele
                reaccionar, el Smart Money <em>crea</em> los movimientos, aprovechando su conocimiento y recursos para
                operar estratégicamente.
            </p>

            <div class="grid md:grid-cols-2 gap-6 my-10">
                <div
                    class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:border-kawn-base/50 transition-colors">
                    <h4 class="font-bold text-slate-900 mb-3 flex items-center text-lg"><i data-lucide="zap"
                            class="mr-2 w-5 h-5 text-yellow-500 fill-yellow-500"></i> Velocidad y Poder</h4>
                    <p class="text-sm text-slate-600">Se estima que más de un tercio del volumen negociado en EE.UU. es
                        ejecutado por algoritmos institucionales en microsegundos. Su proceso de análisis-decisión puede
                        ser hasta 1.000.000 veces más rápido que el humano.</p>
                </div>
                <div
                    class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:border-kawn-base/50 transition-colors">
                    <h4 class="font-bold text-slate-900 mb-3 flex items-center text-lg"><i data-lucide="target"
                            class="mr-2 w-5 h-5 text-red-500 fill-red-500"></i> Búsqueda de Liquidez</h4>
                    <p class="text-sm text-slate-600">Las instituciones buscan "depósitos de gasolina": los puntos donde
                        los minoristas colocan sus stop loss (soportes, resistencias). Manipulan el precio para romper
                        esos niveles, activar los stops y obtener la liquidez necesaria para sus grandes órdenes.</p>
                </div>
            </div>

            <div class="highlight-quote">
                <p class="mb-2 text-lg font-medium">
                    "Como decía Wyckoff hace un siglo, el mercado es como un <strong>Composite Man</strong> (Hombre
                    Compuesto) – un gran operador ficticio que manipula los precios a su favor. Si aprendemos a pensar
                    como él, veremos dónde engaña a la multitud."
                </p>
            </div>
        </section>

        <!-- DIVERGENCIA SMT -->
        <section id="divergencia" class="mb-20 scroll-mt-28">
            <div class="flex items-center mb-8 pb-4 border-b border-slate-200">
                <div class="p-3 bg-slate-900 rounded-xl mr-4 text-white shadow-lg">
                    <i data-lucide="split" class="w-6 h-6"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-900 tracking-tight">¿Qué es la divergencia SMT?</h2>
            </div>

            <p class="mb-6 text-slate-600">
                <strong>SMT</strong> son las siglas de <em>Smart Money Technique</em>. En esencia, una divergencia SMT
                es una discrepancia en la acción del precio entre dos mercados normalmente correlacionados, que sugiere
                que los grandes operadores están interviniendo.
            </p>
            <p class="mb-8 text-slate-600">
                Si dos activos que habitualmente se mueven al unísono de pronto dejan de hacerlo, mostrando estructuras
                contradictorias, “alguien está mintiendo” – y ese alguien suele ser el dinero inteligente intentando
                despistar.
            </p>

            <!-- CANVAS INTERACTIVO -->
            <div class="visual-container group">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h3 class="font-bold text-slate-800 flex items-center text-lg">
                        <i data-lucide="activity" class="w-5 h-5 mr-2 text-kawn-base"></i>
                        Simulador de Divergencia SMT
                    </h3>
                    <div class="flex bg-slate-100 p-1 rounded-full gap-1">
                        <button id="btn-bearish" onclick="updateChart('bearish')" class="graph-btn active">Divergencia
                            Bajista (Techo)</button>
                        <button id="btn-bullish" onclick="updateChart('bullish')" class="graph-btn">Divergencia Alcista
                            (Suelo)</button>
                    </div>
                </div>

                <div class="relative bg-slate-50 rounded-xl border border-slate-200 overflow-hidden h-[400px]">
                    <!-- Canvas (No width/height attrs to allow responsive sizing) -->
                    <canvas id="smtCanvas" class="w-full h-full"></canvas>

                    <!-- Overlay Info -->
                    <div
                        class="absolute bottom-4 left-4 right-4 bg-white/90 backdrop-blur border border-slate-200 p-4 rounded-lg shadow-sm flex items-start gap-3">
                        <i data-lucide="info" class="w-5 h-5 text-kawn-base flex-shrink-0 mt-0.5"></i>
                        <p id="chart-desc" class="text-sm text-slate-600">
                            <strong>Divergencia Bajista (Techo):</strong> El Activo 1 marca un nuevo máximo (HH)
                            manipulando stops, mientras que el Activo 2 falla en confirmarlo mostrando un máximo menor
                            (LH). Esto indica debilidad subyacente y distribución institucional.
                        </p>
                    </div>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-8 mb-12">
                <div class="p-6 bg-red-50 rounded-2xl border border-red-100">
                    <h3 class="font-bold text-red-700 mb-3 flex items-center"><i data-lucide="trending-down"
                            class="mr-2"></i> Divergencia Bajista (Techo)</h3>
                    <p class="text-sm text-red-900/70 leading-relaxed">Ocurre en tendencia alcista. El Activo A hace un
                        <strong>Higher High (HH)</strong>, pero el Activo B hace un <strong>Lower High (LH)</strong>.
                        Indica debilidad; el Smart Money está vendiendo posiciones en el activo fuerte para atraer
                        compradores minoristas antes del giro.</p>
                </div>
                <div class="p-6 bg-green-50 rounded-2xl border border-green-100">
                    <h3 class="font-bold text-green-700 mb-3 flex items-center"><i data-lucide="trending-up"
                            class="mr-2"></i> Divergencia Alcista (Suelo)</h3>
                    <p class="text-sm text-green-900/70 leading-relaxed">Ocurre en tendencia bajista. El Activo A hace
                        un <strong>Lower Low (LL)</strong> (rompe soporte), pero el Activo B hace un <strong>Higher Low
                            (HL)</strong> (aguanta soporte). El Smart Money manipula el activo A para barrer stops,
                        mientras acumula en el B.</p>
                </div>
            </div>

            <h3 class="text-2xl font-bold text-slate-900 mt-12 mb-6">Correlaciones en Mercados Clave</h3>
            <div class="table-container">
                <table class="magazine-table">
                    <thead>
                        <tr>
                            <th class="w-1/4">Mercado</th>
                            <th class="w-1/3">Pares Correlacionados</th>
                            <th>Ejemplo de Señal Institucional</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="font-bold text-kawn-dark"><i data-lucide="banknote"
                                    class="inline w-4 h-4 mr-2"></i> Forex</td>
                            <td class="font-medium">EUR/USD vs GBP/USD</td>
                            <td class="text-sm">Si EUR/USD hace un nuevo mínimo y GBP/USD no, es señal alcista para
                                ambos (indica debilidad del Índice Dólar DXY).</td>
                        </tr>
                        <tr>
                            <td class="font-bold text-kawn-dark"><i data-lucide="bar-chart-2"
                                    class="inline w-4 h-4 mr-2"></i> Índices</td>
                            <td class="font-medium">Nasdaq (US100) vs S&P 500</td>
                            <td class="text-sm">El clásico para detectar techos. Si uno rompe ATH (All Time High) y el
                                otro no, prepárate para un retroceso.</td>
                        </tr>
                        <tr>
                            <td class="font-bold text-kawn-dark"><i data-lucide="bitcoin"
                                    class="inline w-4 h-4 mr-2"></i> Cripto</td>
                            <td class="font-medium">Bitcoin (BTC) vs Ethereum</td>
                            <td class="text-sm">Si BTC rompe máximo histórico y ETH se rezaga significativamente, el
                                impulso de mercado podría estar agotado.</td>
                        </tr>
                        <tr>
                            <td class="font-bold text-kawn-dark"><i data-lucide="gem" class="inline w-4 h-4 mr-2"></i>
                                Commodities</td>
                            <td class="font-medium">Oro (XAU) vs Plata (XAG)</td>
                            <td class="text-sm">Divergencias en metales preciosos suelen anticipar movimientos de
                                refugio o rotación de capital antes de noticias macro.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- TEORÍA DE CORRELACIÓN -->
            <div class="mt-16 pt-12 border-t border-slate-200">
                <h3 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                    <span class="bg-indigo-100 text-indigo-600 p-2 rounded-lg mr-3"><i data-lucide="calculator"
                            class="w-5 h-5"></i></span>
                    Teoría de Correlación: La Matemática detrás de SMT
                </h3>
                <p class="text-slate-600 mb-6">
                    Para entender SMT, debemos comprender el <strong>coeficiente de correlación</strong>. Este valor
                    oscila entre <strong>-1</strong> y <strong>+1</strong>.
                </p>
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <div>
                        <ul class="space-y-4 text-sm text-slate-600">
                            <li><strong>+1 (Correlación Positiva Perfecta):</strong> Dos activos se mueven idénticos
                                (ej. US500 y US100 casi siempre). Cuando divergen, es señal SMT.</li>
                            <li><strong>-1 (Correlación Negativa Perfecta):</strong> Dos activos se mueven en espejo
                                (ej. EURUSD vs DXY). Si uno sube, el otro baja. Si ambos suben, algo está mal (SMT).
                            </li>
                            <li><strong>0 (Sin Correlación):</strong> Movimientos aleatorios sin relación.</li>
                        </ul>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h4 class="font-bold text-slate-800 text-sm mb-4">Medidor de Correlación Interactivo</h4>
                        <div class="flex gap-2 mb-4 text-xs">
                            <button onclick="setCorrelation('EURUSD_DXY')"
                                class="px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded text-slate-700 font-medium">EUR/USD
                                vs DXY</button>
                            <button onclick="setCorrelation('NAS_SPX')"
                                class="px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded text-slate-700 font-medium">Nasdaq
                                vs S&P</button>
                        </div>

                        <div class="correlation-bar-container shadow-inner">
                            <div class="marker" style="left: 50%"></div>
                            <div id="corr-fill"
                                class="correlation-fill bg-indigo-500 absolute top-0 bottom-0 left-1/2 w-0"></div>
                            <div
                                class="absolute inset-0 flex justify-between px-4 items-center text-[10px] font-bold text-slate-400">
                                <span>-1 (Inversa)</span>
                                <span>0</span>
                                <span>+1 (Directa)</span>
                            </div>
                        </div>
                        <p id="corr-text" class="text-center text-xs font-bold text-slate-600 mt-2">Selecciona un par
                            para ver su correlación.</p>
                    </div>
                </div>
            </div>

            <!-- LA TRÍADA DE ÍNDICES -->
            <div class="mt-12 bg-slate-900 text-white p-8 rounded-3xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-64 h-64 bg-kawn-base/20 rounded-full blur-3xl -mr-16 -mt-16"></div>
                <div class="relative z-10">
                    <h3 class="text-2xl font-bold mb-4 flex items-center"><i data-lucide="triangle"
                            class="mr-3 text-kawn-base"></i> La Tríada de Índices (The Triad)</h3>
                    <p class="text-slate-300 mb-8 max-w-2xl">
                        En el análisis institucional avanzado, no solo comparamos dos activos. Observamos la
                        <strong>Tríada Americana</strong>: US30 (Dow), US500 (S&P) y US100 (Nasdaq). Si dos de ellos
                        rompen un nivel y el tercero falla, ese tercero es la clave del SMT.
                    </p>

                    <div class="bg-white/5 p-6 rounded-2xl border border-white/10">
                        <div class="flex justify-between items-end h-32 gap-4 mb-4" id="triad-container">
                            <!-- Barras generadas dinámicamente -->
                            <div class="flex-1 flex flex-col justify-end items-center group cursor-pointer"
                                onclick="updateTriad(0)">
                                <div
                                    class="w-full bg-blue-500/80 triad-bar h-24 group-hover:bg-blue-400 transition-all relative">
                                    <span
                                        class="absolute -top-6 left-1/2 -translate-x-1/2 text-xs font-bold text-blue-300">HH</span>
                                </div>
                                <span class="text-xs mt-2 font-bold text-slate-400">US30 (Dow)</span>
                            </div>
                            <div class="flex-1 flex flex-col justify-end items-center group cursor-pointer"
                                onclick="updateTriad(1)">
                                <div
                                    class="w-full bg-purple-500/80 triad-bar h-28 group-hover:bg-purple-400 transition-all relative">
                                    <span
                                        class="absolute -top-6 left-1/2 -translate-x-1/2 text-xs font-bold text-purple-300">HH</span>
                                </div>
                                <span class="text-xs mt-2 font-bold text-slate-400">US500 (S&P)</span>
                            </div>
                            <div class="flex-1 flex flex-col justify-end items-center group cursor-pointer"
                                onclick="updateTriad(2)">
                                <div
                                    class="w-full bg-red-500/80 triad-bar h-20 border-2 border-red-400 group-hover:bg-red-400 transition-all relative">
                                    <span
                                        class="absolute -top-6 left-1/2 -translate-x-1/2 text-xs font-bold text-red-300">LH
                                        (SMT!)</span>
                                </div>
                                <span class="text-xs mt-2 font-bold text-red-400">US100 (Nas)</span>
                            </div>
                        </div>
                        <p class="text-xs text-center text-slate-400 bg-black/20 p-2 rounded">
                            Haz clic en las barras para simular diferentes escenarios de mercado. El activo que diverge
                            (LH en tendencia alcista) suele liderar la reversión.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- IMPORTANCIA -->
        <section class="mb-20">
            <h2 class="text-2xl font-bold text-slate-900 mb-8 text-center">¿Por qué son importantes las divergencias
                SMT?</h2>
            <div class="grid md:grid-cols-3 gap-6">
                <div
                    class="bg-white p-8 rounded-2xl border border-slate-100 shadow-lg shadow-slate-200/50 hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                    <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center mb-6"><i
                            data-lucide="search" class="w-6 h-6"></i></div>
                    <h4 class="font-bold text-slate-900 mb-3">Anticipan cambios</h4>
                    <p class="text-sm text-slate-500 leading-relaxed">Señalan giros antes de que sean obvios en el
                        gráfico tradicional, permitiendo posicionarse antes que la masa reaccione.</p>
                </div>
                <div
                    class="bg-white p-8 rounded-2xl border border-slate-100 shadow-lg shadow-slate-200/50 hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                    <div class="w-12 h-12 bg-red-50 text-red-600 rounded-xl flex items-center justify-center mb-6"><i
                            data-lucide="shield-alert" class="w-6 h-6"></i></div>
                    <h4 class="font-bold text-slate-900 mb-3">Detectan Trampas</h4>
                    <p class="text-sm text-slate-500 leading-relaxed">Sirven para distinguir movimientos genuinos de
                        maniobras de manipulación. Si un activo rompe y el otro no, sospecha inmediatamente.</p>
                </div>
                <div
                    class="bg-white p-8 rounded-2xl border border-slate-100 shadow-lg shadow-slate-200/50 hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                    <div class="w-12 h-12 bg-green-50 text-green-600 rounded-xl flex items-center justify-center mb-6">
                        <i data-lucide="crosshair" class="w-6 h-6"></i></div>
                    <h4 class="font-bold text-slate-900 mb-3">Entradas "Sniper"</h4>
                    <p class="text-sm text-slate-500 leading-relaxed">Mejoran la precisión y el ratio riesgo/beneficio
                        al permitir stops ajustados en el punto exacto de invalidación de la divergencia.</p>
                </div>
            </div>
        </section>

        <!-- TIMING & KILLZONES -->
        <section id="timing" class="mb-20 scroll-mt-28">
            <div class="flex items-center mb-8 pb-4 border-b border-slate-200">
                <div class="p-3 bg-slate-900 rounded-xl mr-4 text-white shadow-lg">
                    <i data-lucide="clock" class="w-6 h-6"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-900 tracking-tight">Timing Institucional: ¿Cuándo buscar SMT?
                </h2>
            </div>

            <p class="text-slate-600 mb-6">
                Una divergencia SMT no tiene valor si ocurre a las 18:00 (hora de cierre). Las instituciones operan en
                ventanas de tiempo específicas conocidas como <strong>Killzones</strong>.
            </p>

            <div class="bg-slate-800 p-6 rounded-2xl shadow-xl border border-slate-700">
                <div class="flex justify-between items-center mb-4 text-white">
                    <h4 class="font-bold text-sm">Reloj de Probabilidades (Hora NY EST)</h4>
                    <span class="text-xs bg-kawn-base px-2 py-1 rounded text-white font-bold">Probabilidad Alta</span>
                </div>

                <div class="killzone-timeline bg-slate-700/50 relative">
                    <!-- Asian Session -->
                    <div class="kz-segment bg-slate-600/30 text-slate-400" title="Asia: Acumulación">ASIA<br>20-00</div>
                    <!-- London Open -->
                    <div class="kz-segment bg-yellow-500/80 hover:bg-yellow-400 text-slate-900"
                        title="London Open: Manipulación (Judas Swing)">LONDON<br>02-05</div>
                    <!-- Lunch Gap -->
                    <div class="kz-segment bg-slate-600/30 text-slate-400">GAP</div>
                    <!-- NY Open -->
                    <div class="kz-segment bg-green-500/80 hover:bg-green-400 text-white"
                        title="NY Open: Expansión / Reversión">NY<br>07-10</div>
                    <!-- London Close -->
                    <div class="kz-segment bg-blue-500/80 hover:bg-blue-400 text-white"
                        title="London Close: Continuación">LC<br>10-12</div>
                    <!-- PM Session -->
                    <div class="kz-segment bg-slate-600/30 text-slate-400">PM</div>
                </div>
                <p class="text-xs text-slate-400 mt-4 text-center">
                    <i data-lucide="alert-circle" class="w-3 h-3 inline mr-1"></i>
                    Las divergencias SMT más potentes ocurren en la apertura de Londres (formando el máximo/mínimo del
                    día) o en la apertura de NY (reversiones).
                </p>
            </div>
        </section>

        <!-- [NUEVO] SECCIÓN AMD (POWER OF 3) -->
        <section id="amd" class="mb-20 scroll-mt-28">
            <div class="flex items-center mb-8 pb-4 border-b border-slate-200">
                <div class="p-3 bg-slate-900 rounded-xl mr-4 text-white shadow-lg">
                    <i data-lucide="activity-square" class="w-6 h-6"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-900 tracking-tight">El Ciclo AMD: Donde nace la SMT</h2>
            </div>

            <p class="mb-6 text-slate-600">
                La SMT no ocurre en el vacío. Casi siempre es el "detonante" que ocurre dentro de la fase de
                <strong>Manipulación</strong> del ciclo diario. Este concepto se conoce como <em>Power of 3</em>:
            </p>

            <div class="grid md:grid-cols-2 gap-8 items-center">
                <div class="space-y-4">
                    <div id="phase-a"
                        class="amd-stage p-4 border border-slate-200 rounded-xl bg-white cursor-pointer hover:border-kawn-base"
                        onclick="setAMD('a')">
                        <h4 class="font-bold text-slate-800 text-sm">1. Acumulación (Asia)</h4>
                        <p class="text-xs text-slate-500">El mercado se mueve lateralmente creando liquidez (stops) por
                            encima y por debajo.</p>
                    </div>
                    <div id="phase-m"
                        class="amd-stage p-4 border border-slate-200 rounded-xl bg-white cursor-pointer hover:border-kawn-base"
                        onclick="setAMD('m')">
                        <h4 class="font-bold text-red-600 text-sm flex items-center justify-between">2. Manipulación
                            (London/NY Open) <i data-lucide="alert-triangle" class="w-4 h-4"></i></h4>
                        <p class="text-xs text-slate-500">El movimiento falso. Rompen la Acumulación para activar stops.
                            <strong>¡AQUÍ OCURRE LA SMT!</strong> Mientras un activo hace este movimiento falso, el otro
                            NO lo hace.</p>
                    </div>
                    <div id="phase-d"
                        class="amd-stage p-4 border border-slate-200 rounded-xl bg-white cursor-pointer hover:border-kawn-base"
                        onclick="setAMD('d')">
                        <h4 class="font-bold text-green-600 text-sm">3. Distribución (Tendencia Real)</h4>
                        <p class="text-xs text-slate-500">El movimiento verdadero hacia el objetivo contrario, una vez
                            que la liquidez ha sido tomada.</p>
                    </div>
                </div>

                <!-- Visual AMD -->
                <div
                    class="bg-slate-50 rounded-2xl p-6 border border-slate-200 h-64 flex items-end justify-center relative overflow-hidden">
                    <div
                        class="absolute top-4 right-4 bg-white px-2 py-1 rounded text-[10px] font-bold text-slate-400 border border-slate-100 shadow-sm">
                        Simulador de Mercado</div>
                    <svg id="amd-svg" viewBox="0 0 200 100" class="w-full h-full text-slate-400">
                        <!-- Initial Accumulation -->
                        <path d="M10,50 L30,45 L50,55 L70,50" fill="none" stroke="currentColor" stroke-width="2"
                            class="opacity-50" />
                        <!-- Manipulation (Hidden initially) -->
                        <path id="path-manipulation" d="M70,50 L80,80 L100,20" fill="none" stroke="#ef4444"
                            stroke-width="3" stroke-dasharray="100" stroke-dashoffset="100"
                            class="transition-all duration-1000" />
                        <!-- Distribution (Hidden) -->
                        <path id="path-distribution" d="M100,20 L120,40 L150,10 L190,15" fill="none" stroke="#10b981"
                            stroke-width="3" stroke-dasharray="100" stroke-dashoffset="100"
                            class="transition-all duration-1000" />
                    </svg>
                    <div id="amd-label" class="absolute bottom-4 text-xs font-bold text-slate-500 transition-opacity">
                        Esperando apertura...</div>
                </div>
            </div>
        </section>

        <!-- PASO A PASO -->
        <section id="pasos" class="mb-20 scroll-mt-28">
            <div class="flex items-center mb-8 pb-4 border-b border-slate-200">
                <div class="p-3 bg-slate-900 rounded-xl mr-4 text-white shadow-lg">
                    <i data-lucide="list-ordered" class="w-6 h-6"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-900 tracking-tight">Cómo utilizar las divergencias SMT paso a
                    paso</h2>
            </div>

            <div class="space-y-6 relative">
                <!-- Línea conectora vertical -->
                <div class="absolute left-6 top-6 bottom-6 w-0.5 bg-slate-200 hidden md:block"></div>

                <div class="flex gap-6 relative group">
                    <div
                        class="flex-shrink-0 w-12 h-12 bg-white border-2 border-kawn-base text-kawn-deep rounded-full flex items-center justify-center font-black font-display text-lg z-10 shadow-sm group-hover:bg-kawn-base group-hover:text-white transition-colors">
                        1</div>
                    <div
                        class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex-1 hover:shadow-md transition-shadow">
                        <h3 class="text-lg font-bold text-slate-800 mb-2">Seleccionar un par de activos correlacionados
                        </h3>
                        <p class="text-sm text-slate-600">Elige instrumentos que normalmente se muevan similar (ej.
                            EUR/USD y GBP/USD). <span class="text-kawn-deep font-semibold">Tip Pro:</span> Muchos
                            traders profesionales usan el Índice Dólar (DXY) vs un par mayor para ver si el DXY hace un
                            nuevo alto y el par falla en hacer un nuevo bajo.</p>
                    </div>
                </div>

                <div class="flex gap-6 relative group">
                    <div
                        class="flex-shrink-0 w-12 h-12 bg-white border-2 border-kawn-base text-kawn-deep rounded-full flex items-center justify-center font-black font-display text-lg z-10 shadow-sm group-hover:bg-kawn-base group-hover:text-white transition-colors">
                        2</div>
                    <div
                        class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex-1 hover:shadow-md transition-shadow">
                        <h3 class="text-lg font-bold text-slate-800 mb-2">Observar niveles clave y estructura</h3>
                        <p class="text-sm text-slate-600">Marca máximos y mínimos recientes (Swing Highs/Lows) en ambos
                            gráficos. Identifica dónde están los <em>pools</em> de liquidez (stops de masas). Define
                            claramente si el mercado está en tendencia o rango.</p>
                    </div>
                </div>

                <div class="flex gap-6 relative group">
                    <div
                        class="flex-shrink-0 w-12 h-12 bg-white border-2 border-kawn-base text-kawn-deep rounded-full flex items-center justify-center font-black font-display text-lg z-10 shadow-sm group-hover:bg-kawn-base group-hover:text-white transition-colors">
                        3</div>
                    <div
                        class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex-1 hover:shadow-md transition-shadow">
                        <h3 class="text-lg font-bold text-slate-800 mb-2">Identificar la divergencia SMT</h3>
                        <p class="text-sm text-slate-600">Busca el "desacuerdo" visual. ¿Un activo rompió un nivel clave
                            y el otro no? Esa es tu señal de intervención institucional. Puede ocurrir en extremos
                            (reversión) o en zonas intermedias (continuación).</p>
                    </div>
                </div>

                <div class="flex gap-6 relative group">
                    <div
                        class="flex-shrink-0 w-12 h-12 bg-white border-2 border-kawn-base text-kawn-deep rounded-full flex items-center justify-center font-black font-display text-lg z-10 shadow-sm group-hover:bg-kawn-base group-hover:text-white transition-colors">
                        4</div>
                    <div
                        class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex-1 hover:shadow-md transition-shadow">
                        <h3 class="text-lg font-bold text-slate-800 mb-2">Confirmar con evidencia adicional</h3>
                        <p class="text-sm text-slate-600">No operes solo por la divergencia; es una pieza del puzzle.
                            Busca volumen inusual (clímax), patrones de velas de reversión (Price Action) o que el
                            precio regrese rápidamente al rango tras la falsa ruptura.</p>
                    </div>
                </div>

                <div class="flex gap-6 relative group">
                    <div
                        class="flex-shrink-0 w-12 h-12 bg-white border-2 border-kawn-base text-kawn-deep rounded-full flex items-center justify-center font-black font-display text-lg z-10 shadow-sm group-hover:bg-kawn-base group-hover:text-white transition-colors">
                        5</div>
                    <div
                        class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex-1 hover:shadow-md transition-shadow">
                        <h3 class="text-lg font-bold text-slate-800 mb-2">Planificar y ejecutar (Gestión de Riesgo)</h3>
                        <p class="text-sm text-slate-600">Decide qué activo operar (generalmente el que muestra la
                            dirección "verdadera" o el más débil/fuerte según corresponda). Entra cuando el precio
                            confirme el giro. Coloca el Stop Loss justo por encima/debajo del punto de manipulación.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- INTEGRACION & PD ARRAYS -->
        <section id="integracion" class="mb-20 scroll-mt-28">
            <div class="flex items-center mb-8 pb-4 border-b border-slate-200">
                <div class="p-3 bg-slate-900 rounded-xl mr-4 text-white shadow-lg">
                    <i data-lucide="layers" class="w-6 h-6"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-900 tracking-tight">Integración con otras herramientas</h2>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <div
                    class="bg-gradient-to-br from-white to-slate-50 p-8 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-all">
                    <div
                        class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center mb-4">
                        <i data-lucide="box-select" class="w-5 h-5"></i></div>
                    <h3 class="font-bold text-slate-900 mb-4 text-lg">SMT + Fair Value Gaps (FVG)</h3>
                    <p class="text-sm text-slate-600 mb-4">Los FVG son vacíos de precio que actúan como imanes. La
                        integración con SMT es poderosa:</p>
                    <ul class="space-y-3 text-sm text-slate-600">
                        <li class="flex items-start"><i data-lucide="check-circle-2"
                                class="w-4 h-4 mr-2 text-indigo-500 mt-1"></i> <span><strong>Confirmación:</strong> Si
                                un activo no da entrada clara, pero su par correlacionado deja un FVG claro, usa el FVG
                                del segundo para validar la operación en ambos.</span></li>
                        <li class="flex items-start"><i data-lucide="check-circle-2"
                                class="w-4 h-4 mr-2 text-indigo-500 mt-1"></i> <span><strong>Rebalanceo:</strong> Si un
                                activo rellena su FVG y el otro no (se queda corto), el que no rellena muestra mayor
                                fuerza/debilidad relativa, indicando continuidad.</span></li>
                    </ul>
                </div>

                <div
                    class="bg-gradient-to-br from-white to-slate-50 p-8 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-all">
                    <div
                        class="w-10 h-10 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center mb-4">
                        <i data-lucide="clock" class="w-5 h-5"></i></div>
                    <h3 class="font-bold text-slate-900 mb-4 text-lg">SMT + Temporalidades (Multi-Timeframe)</h3>
                    <p class="text-sm text-slate-600 mb-4">Usa SMT para alinear la dirección macro con la entrada micro:
                    </p>
                    <ul class="space-y-3 text-sm text-slate-600">
                        <li class="flex items-start"><i data-lucide="check-circle-2"
                                class="w-4 h-4 mr-2 text-purple-500 mt-1"></i> <span><strong>Sesgo Macro:</strong> Si en
                                Diario hay dudas, mira si hay divergencia semanal entre índices para confirmar la
                                tendencia principal.</span></li>
                        <li class="flex items-start"><i data-lucide="check-circle-2"
                                class="w-4 h-4 mr-2 text-purple-500 mt-1"></i> <span><strong>Entrada Micro:</strong> En
                                tu gráfico de 15m, si ves una ruptura de soporte, verifica si el activo correlacionado
                                la confirma. Si no, es una trampa (Stop Hunt).</span></li>
                    </ul>
                </div>
            </div>

            <!-- [NUEVO] SECCIÓN PREMIUM VS DISCOUNT -->
            <div
                class="mt-12 bg-white p-8 rounded-2xl border border-slate-200 shadow-sm flex flex-col md:flex-row gap-8 items-center">
                <div class="flex-1">
                    <h3 class="font-bold text-slate-900 mb-4 text-lg flex items-center"><i data-lucide="percent"
                            class="mr-2 text-kawn-base"></i> Filtro de Oro: Premium vs Discount</h3>
                    <p class="text-sm text-slate-600 mb-4">
                        Una SMT <strong>NO sirve</strong> si ocurre en "tierra de nadie". Solo opera Divergencias
                        Bajistas (Ventas) en zona <strong>Premium</strong> (caro) y Divergencias Alcistas (Compras) en
                        zona <strong>Discount</strong> (barato).
                    </p>
                    <p class="text-xs text-slate-400 italic">Mueve el slider a la derecha para ver cómo cambia la zona.
                    </p>
                </div>

                <div class="w-full md:w-auto flex flex-col items-center">
                    <div class="pd-slider-container" id="pd-container">
                        <div id="zone-premium" class="pd-zone pd-premium">PREMIUM<br>(VENDER)</div>
                        <div id="zone-discount" class="pd-zone pd-discount">DISCOUNT<br>(COMPRAR)</div>
                        <div id="pd-handle" class="pd-handle w-full text-xs font-bold text-slate-600 shadow-sm">
                            <span class="mx-auto">50%</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="mb-20">
            <h2 class="text-2xl font-bold text-slate-900 mb-6">Casos de estudio reales</h2>
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500 flex items-start gap-4">
                    <div class="bg-red-50 p-3 rounded-full text-red-500"><i data-lucide="trending-down"
                            class="w-5 h-5"></i></div>
                    <div>
                        <h4 class="font-bold text-slate-900 text-base">Fondo de Cobertura (Feb 2020)</h4>
                        <p class="text-sm text-slate-600 mt-1">El S&P 500 marcaba nuevos máximos históricos, pero el
                            Nasdaq 100 dejó de acompañar (divergencia bajista SMT clásica). Un conocido fondo macro
                            detectó esto, redujo drásticamente su exposición a riesgo y compró coberturas semanas antes
                            del colapso global por COVID-19.</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500 flex items-start gap-4">
                    <div class="bg-green-50 p-3 rounded-full text-green-500"><i data-lucide="trending-up"
                            class="w-5 h-5"></i></div>
                    <div>
                        <h4 class="font-bold text-slate-900 text-base">Mercado Cripto (Feb-Abr 2024)</h4>
                        <p class="text-sm text-slate-600 mt-1">Bitcoin hacía nuevos máximos, Ethereum no (señal de
                            alerta inicial). Posteriormente, durante la corrección, Ethereum aguantó sus mínimos
                            estructurales mucho mejor que BTC (señal de fortaleza relativa). Esto permitió a los traders
                            institucionales rotar capital de BTC a ETH justo antes de que ETH recuperara terreno con
                            fuerza.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI LAB -->
        <section id="ai-lab" class="mb-24 scroll-mt-28">
            <div class="flex items-center mb-8">
                <div
                    class="bg-gradient-to-r from-kawn-deep to-kawn-base text-white px-4 py-2 rounded-lg shadow-lg flex items-center">
                    <i data-lucide="sparkles" class="w-5 h-5 mr-2 text-yellow-300"></i>
                    <h2 class="text-xl font-bold tracking-wide">KAWN AI LAB</h2>
                </div>
                <div class="h-px bg-slate-200 flex-1 ml-4"></div>
            </div>

            <div class="grid lg:grid-cols-3 gap-8 h-[600px] lg:h-[500px]">

                <!-- CHATBOT -->
                <div class="lg:col-span-2 ai-chat-container">
                    <div class="ai-header">
                        <div class="flex items-center">
                            <div
                                class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-3 backdrop-blur-sm">
                                <i data-lucide="bot" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-sm">Mentor SMT Virtual</h3>
                                <p class="text-[10px] opacity-80 font-medium">Especialista en Smart Money &
                                    Correlaciones</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] bg-white/10 px-2 py-0.5 rounded text-white/90">Gemini Pro</span>
                            <span class="bg-green-400 w-2 h-2 rounded-full animate-pulse"></span>
                        </div>
                    </div>

                    <div id="chat-messages" class="ai-messages-area">
                        <div class="ai-message bot">
                            Hola, soy tu especialista en Smart Money Concepts. ¿Tienes dudas sobre cómo identificar una
                            divergencia SMT entre el Nasdaq y el S&P, o cómo integrarlo en tu estrategia de Forex?
                            ¡Estoy aquí para ayudarte! ✨
                        </div>
                    </div>

                    <div class="ai-input-area">
                        <form id="chat-form" class="flex gap-3">
                            <input type="text" id="user-input"
                                class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-kawn-base focus:border-transparent outline-none transition-all text-sm"
                                placeholder="Pregunta sobre divergencias, gestión de riesgo...">
                            <button type="submit" id="chat-submit-btn"
                                class="bg-slate-900 text-white p-3 rounded-xl hover:bg-kawn-base transition-all disabled:opacity-50 shadow-md">
                                <i data-lucide="send" class="w-5 h-5"></i>
                            </button>
                        </form>
                        <p class="text-[10px] text-center text-slate-400 mt-2 flex items-center justify-center gap-1">
                            <i data-lucide="lock" class="w-3 h-3"></i> Conexión segura vía Proxy
                        </p>
                    </div>
                </div>

                <!-- QUIZ -->
                <div
                    class="bg-white p-6 rounded-3xl shadow-lg border border-slate-100 flex flex-col relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-16 bg-kawn-light/30 rounded-full blur-3xl -mr-10 -mt-10"></div>

                    <div class="relative z-10 flex-1 flex flex-col">
                        <h3 class="font-bold text-slate-900 mb-2 flex items-center text-lg"><i data-lucide="award"
                                class="mr-2 text-kawn-base"></i> Desafío SMT</h3>
                        <p class="text-xs text-slate-500 mb-6">Pon a prueba tu capacidad para detectar manipulación
                            institucional.</p>

                        <div id="quiz-container" class="flex-1 overflow-y-auto pr-1 custom-scrollbar">
                            <div
                                class="h-full flex flex-col justify-center items-center text-center p-4 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50">
                                <i data-lucide="brain-circuit" class="w-10 h-10 text-slate-300 mb-3"></i>
                                <p class="text-xs text-slate-400 mb-4">Genera un test único con IA basado en el
                                    contenido de este capítulo.</p>
                                <button onclick="generateQuiz()"
                                    class="w-full py-3 bg-kawn-base hover:bg-kawn-dark text-white rounded-xl font-bold text-sm transition-all shadow-lg shadow-kawn-base/30 flex justify-center items-center gap-2 transform hover:-translate-y-1">
                                    <i data-lucide="zap" class="w-4 h-4"></i> Generar Quiz
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-slate-900 text-slate-400 py-16 border-t border-slate-800">
        <div
            class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-8">
            <div class="flex items-center gap-4">
                <div
                    class="h-12 w-12 bg-gradient-to-br from-kawn-dark to-kawn-base rounded-xl flex items-center justify-center text-white font-black text-xl shadow-lg shadow-kawn-base/20">
                    K</div>
                <div class="flex flex-col">
                    <span
                        class="text-2xl font-black text-white tracking-tighter leading-none font-display">KAWNBIT</span>
                    <span
                        class="text-[0.65rem] font-bold text-kawn-base uppercase tracking-[0.3em] leading-none mt-1.5">Quantitative
                        Trading</span>
                </div>
            </div>
            <p class="text-sm text-center md:text-right text-slate-500">
                &copy; <span id="current-year">2025</span> KawnBit Magazine.<br>
                <span class="text-xs opacity-60">Material educativo. No constituye asesoramiento financiero.</span>
            </p>
        </div>
    </footer>

    <script>
        // Init Icons
        lucide.createIcons();
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // -----------------------------------------------------
        // 1. ADVANCED CANVAS CHART (SMT VISUALIZER)
        // -----------------------------------------------------
        const canvas = document.getElementById('smtCanvas');
        const ctx = canvas.getContext('2d');
        let animationId;
        let progress = 0;
        let chartData = {}; // defined below
        let currentScenario = 'bearish';

        // Configuración de datos para las curvas
        chartData = {
            bearish: {
                asset1: { points: [{ x: 50, y: 300 }, { x: 200, y: 150 }, { x: 350, y: 220 }, { x: 500, y: 100 }, { x: 700, y: 200 }], label: "Activo 1 (HH)", color: "#ef4444" },
                asset2: { points: [{ x: 50, y: 300 }, { x: 200, y: 150 }, { x: 350, y: 220 }, { x: 500, y: 180 }, { x: 700, y: 320 }], label: "Activo 2 (LH - SMT)", color: "#334155" },
                desc: "Divergencia Bajista (Techo): El Activo 1 marca un nuevo máximo (HH) manipulando stops, mientras que el Activo 2 falla en confirmarlo mostrando un máximo menor (LH).",
                markerIdx: 3
            },
            bullish: {
                asset1: { points: [{ x: 50, y: 100 }, { x: 200, y: 250 }, { x: 350, y: 180 }, { x: 500, y: 350 }, { x: 700, y: 200 }], label: "Activo 1 (LL)", color: "#10b981" },
                asset2: { points: [{ x: 50, y: 100 }, { x: 200, y: 250 }, { x: 350, y: 180 }, { x: 500, y: 220 }, { x: 700, y: 50 }], label: "Activo 2 (HL - SMT)", color: "#334155" },
                desc: "Divergencia Alcista (Suelo): El Activo 1 rompe mínimos (LL) para barrer liquidez, pero el Activo 2 muestra fortaleza creando un mínimo más alto (HL).",
                markerIdx: 3
            }
        };

        // --- NEW: High DPI & Responsive Canvas Logic ---
        function resizeCanvas() {
            const container = canvas.parentElement;
            const dpr = window.devicePixelRatio || 1;

            // Get size from CSS
            const rect = container.getBoundingClientRect();

            // Set actual size in memory (scaled to account for extra pixel density)
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;

            // Normalize coordinate system to use CSS pixels
            ctx.scale(dpr, dpr);

            // Reset state if resizing happens during anim
            // but for simplicity, we just restart loop or let next frame fix it.
            // Need to scale points data to match new width? 
            // For this demo, we assume fixed coordinate space relative to 800x400 for simplicity,
            // so we scale the context to match 800x400 "logical" units to actual width.
            const scaleX = rect.width / 800;
            const scaleY = rect.height / 400;
            ctx.scale(scaleX, scaleY);

            // Re-render immediately if idle
            if (progress >= 1) animate();
        }

        window.addEventListener('resize', () => {
            // Debounce slightly or just call
            resizeCanvas();
        });

        // Initial sizing
        resizeCanvas();

        function easeOutCubic(x) {
            return 1 - Math.pow(1 - x, 3);
        }

        function drawLine(points, color, label, progressVal, isDashed = false) {
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            if (isDashed) ctx.setLineDash([5, 5]);
            else ctx.setLineDash([]);

            if (points.length < 2) return;

            ctx.moveTo(points[0].x, points[0].y);

            const totalSegments = points.length - 1;
            const currentSegmentExact = progressVal * totalSegments;
            const currentSegmentIndex = Math.floor(currentSegmentExact);
            const segmentProgress = currentSegmentExact - currentSegmentIndex;

            for (let i = 0; i < currentSegmentIndex; i++) {
                const xc = (points[i].x + points[i + 1].x) / 2;
                const yc = (points[i].y + points[i + 1].y) / 2;
                ctx.quadraticCurveTo(points[i].x, points[i].y, xc, yc);
            }

            if (currentSegmentIndex < totalSegments) {
                const p1 = points[currentSegmentIndex];
                const p2 = points[currentSegmentIndex + 1];
                const midX = p1.x + (p2.x - p1.x) * segmentProgress;
                const midY = p1.y + (p2.y - p1.y) * segmentProgress;
                ctx.lineTo(midX, midY);
            } else {
                const last = points[points.length - 1];
                const prev = points[points.length - 2];
                ctx.quadraticCurveTo(prev.x, prev.y, last.x, last.y);
            }

            ctx.stroke();

            ctx.fillStyle = color;
            ctx.font = "bold 12px Inter";
            ctx.fillText(label, points[0].x + 10, points[0].y - 10);
        }

        function drawMarkers(scenario) {
            const data = chartData[scenario];
            const p1 = data.asset1.points[data.markerIdx];
            const p2 = data.asset2.points[data.markerIdx];

            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y);
            ctx.lineTo(p2.x, p2.y);
            ctx.strokeStyle = "rgba(0,0,0,0.2)";
            ctx.setLineDash([4, 4]);
            ctx.lineWidth = 1;
            ctx.stroke();
            ctx.setLineDash([]);

            [p1, p2].forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 6, 0, Math.PI * 2);
                ctx.fillStyle = "white";
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = "#0f766e";
                ctx.stroke();
            });

            ctx.fillStyle = "#ef4444";
            ctx.fillText(scenario === 'bearish' ? "HH" : "LL", p1.x - 10, p1.y - 15);
            ctx.fillStyle = "#334155";
            ctx.fillText(scenario === 'bearish' ? "LH" : "HL", p2.x - 10, p2.y + 25);
        }

        function animate() {
            // Need to clear the full scaled area. 
            // Since we applied scale transforms, 0,0 to 800,400 clears logical area.
            ctx.clearRect(0, 0, 800, 400);

            // Grid
            ctx.strokeStyle = "#e2e8f0";
            ctx.lineWidth = 1;
            ctx.setLineDash([]);
            ctx.beginPath();
            for (let i = 0; i < 800; i += 50) { ctx.moveTo(i, 0); ctx.lineTo(i, 400); }
            for (let i = 0; i < 400; i += 50) { ctx.moveTo(0, i); ctx.lineTo(800, i); }
            ctx.stroke();

            const data = chartData[currentScenario];
            const easedProgress = easeOutCubic(progress);

            drawLine(data.asset2.points, data.asset2.color, data.asset2.label, easedProgress, true);
            drawLine(data.asset1.points, data.asset1.color, data.asset1.label, easedProgress);

            if (progress >= 1) {
                drawMarkers(currentScenario);
            }

            if (progress < 1) {
                progress += 0.015; // slightly faster for responsiveness
                animationId = requestAnimationFrame(animate);
            }
        }

        function updateChart(type) {
            currentScenario = type;
            progress = 0;
            cancelAnimationFrame(animationId);

            document.getElementById('btn-bearish').classList.toggle('active', type === 'bearish');
            document.getElementById('btn-bullish').classList.toggle('active', type === 'bullish');

            const descEl = document.getElementById('chart-desc');
            descEl.style.opacity = '0';
            setTimeout(() => {
                descEl.innerHTML = `<strong>${type === 'bearish' ? 'Divergencia Bajista' : 'Divergencia Alcista'}:</strong> ${chartData[type].desc}`;
                descEl.style.opacity = '1';
            }, 200);

            animate();
        }

        // Start
        setTimeout(() => updateChart('bearish'), 100); // slight delay to ensuring sizing


        // -----------------------------------------------------
        // 2. INTERACTIVE FUNCTIONS (AMD, PD, CORRELATION, TRIAD)
        // -----------------------------------------------------

        function setCorrelation(pair) {
            const fill = document.getElementById('corr-fill');
            const text = document.getElementById('corr-text');

            if (pair === 'EURUSD_DXY') {
                fill.style.left = '0'; fill.style.width = '50%';
                fill.className = 'correlation-fill bg-red-500 absolute top-0 bottom-0';
                text.innerHTML = "Correlación: <span class='text-red-500'>-0.95 (Inversa Muy Fuerte)</span>. Se mueven como espejo.";
            } else {
                fill.style.left = '50%'; fill.style.width = '48%';
                fill.className = 'correlation-fill bg-green-500 absolute top-0 bottom-0';
                text.innerHTML = "Correlación: <span class='text-green-500'>+0.92 (Positiva Fuerte)</span>. Se mueven juntos.";
            }
        }

        function updateTriad(index) {
            const bars = document.querySelectorAll('.triad-bar');
            bars.forEach(b => {
                b.style.height = '6rem';
                b.querySelector('span').innerText = 'HH';
                b.querySelector('span').className = 'absolute -top-6 left-1/2 -translate-x-1/2 text-xs font-bold text-slate-300';
                b.classList.remove('border-2', 'border-red-400');
            });
            const target = bars[index];
            target.style.height = '4rem';
            target.classList.add('border-2', 'border-red-400');
            const span = target.querySelector('span');
            span.innerText = 'LH (SMT!)';
            span.className = 'absolute -top-6 left-1/2 -translate-x-1/2 text-xs font-bold text-red-300 animate-bounce';
        }

        function setAMD(phase) {
            document.querySelectorAll('.amd-stage').forEach(el => el.classList.remove('active'));
            document.getElementById('phase-' + phase).classList.add('active');

            const label = document.getElementById('amd-label');
            const mPath = document.getElementById('path-manipulation');
            const dPath = document.getElementById('path-distribution');

            if (phase === 'a') {
                label.innerText = "Fase 1: Acumulación - Creando Liquidez...";
                mPath.style.strokeDashoffset = '100';
                dPath.style.strokeDashoffset = '100';
            } else if (phase === 'm') {
                label.innerHTML = "Fase 2: <span class='text-red-500 font-bold'>Manipulación (Stop Hunt)</span> - ¡Busca SMT aquí!";
                mPath.style.strokeDashoffset = '0';
                dPath.style.strokeDashoffset = '100';
            } else if (phase === 'd') {
                label.innerHTML = "Fase 3: <span class='text-green-500 font-bold'>Distribución</span> - Entrada confirmada.";
                mPath.style.strokeDashoffset = '0';
                dPath.style.strokeDashoffset = '0';
            }
        }
        setAMD('a');

        // --- NEW: Robust Premium/Discount Slider (Touch & Mouse) ---
        const pdHandle = document.getElementById('pd-handle');
        const pdContainer = document.getElementById('pd-container');
        const zPrem = document.getElementById('zone-premium');
        const zDisc = document.getElementById('zone-discount');
        let isDragging = false;

        function updateSliderPosition(clientY) {
            const rect = pdContainer.getBoundingClientRect();
            let y = clientY - rect.top;

            // Constrain
            if (y < 0) y = 0;
            if (y > rect.height) y = rect.height;

            const pct = Math.round((y / rect.height) * 100);
            pdHandle.style.top = y + 'px';
            pdHandle.querySelector('span').innerText = pct + '%';

            if (pct < 50) {
                zPrem.classList.add('active'); zDisc.classList.remove('active');
                zPrem.innerText = "PREMIUM\n(VENDER)\n✅"; zDisc.innerText = "DISCOUNT\n(COMPRAR)";
            } else {
                zPrem.classList.remove('active'); zDisc.classList.add('active');
                zPrem.innerText = "PREMIUM\n(VENDER)"; zDisc.innerText = "DISCOUNT\n(COMPRAR)\n✅";
            }
        }

        if (pdHandle && pdContainer) {
            // Mouse Events
            pdHandle.addEventListener('mousedown', (e) => {
                isDragging = true;
                e.preventDefault();
            });

            // Move on WINDOW to catch fast drags outside container
            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                updateSliderPosition(e.clientY);
            });

            window.addEventListener('mouseup', () => isDragging = false);

            // Touch Events (Mobile)
            pdHandle.addEventListener('touchstart', (e) => {
                isDragging = true;
                e.preventDefault();
            }, { passive: false });

            window.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                // e.touches[0] is the first finger
                updateSliderPosition(e.touches[0].clientY);
            }, { passive: false });

            window.addEventListener('touchend', () => isDragging = false);
        }

        // -----------------------------------------------------
        // 3. PROXY-BASED AI INTEGRATION (ROBUST)
        // -----------------------------------------------------
        const proxyUrl = "/.netlify/functions/gemini-proxy";

        async function callAIProxy(systemPrompt, userPrompt) {
            try {
                const response = await fetch(proxyUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userPrompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                if (!response.ok) throw new Error("Error en Proxy");

                const data = await response.json();

                // Extraemos la respuesta de la estructura de Gemini o del campo result del proxy
                if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                    return data.candidates[0].content.parts[0].text;
                }
                return data.result || "La IA no devolvió una respuesta válida.";

            } catch (error) {
                console.error("Fallo en conexión segura:", error);
                return "Error de conexión con el Proxy de IA. Verifica tu configuración.";
            }
        }

        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('user-input');
        const chatMessages = document.getElementById('chat-messages');

        if (chatForm) {
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const msg = chatInput.value.trim();
                if (!msg) return;

                chatInput.disabled = true;
                appendMessage(msg, 'user');
                chatInput.value = '';

                const loadingId = appendTypingIndicator();
                const reply = await callAIProxy("Eres un experto en Trading Institucional y SMT.", msg);

                document.getElementById(loadingId).remove();
                appendMessage(reply, 'bot');

                chatInput.disabled = false;
                chatInput.focus();
            });
        }

        function appendMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `ai-message ${sender} animate-[pulse_0.2s_ease-in-out]`;
            const htmlText = typeof marked !== 'undefined' ? marked.parse(text) : text;
            div.innerHTML = htmlText;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function appendTypingIndicator() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'ai-message bot typing-indicator';
            div.innerHTML = '<span></span><span></span><span></span>';
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return id;
        }

        async function generateQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = `<div class="h-full flex flex-col justify-center items-center"><i data-lucide="loader-2" class="animate-spin w-10 h-10 text-kawn-base mb-4"></i><p class="text-sm text-slate-500">Analizando el mercado...</p></div>`;
            lucide.createIcons();

            const prompt = `Genera un JSON con 3 preguntas sobre SMT Divergence. Formato: [{"q": "pregunta", "options": ["a","b","c"], "a": index_correcto}].`;

            try {
                let text = await callAIProxy("Genera solo JSON válido.", prompt);

                // --- ROBUST JSON EXTRACTION ---
                // Sometimes AI adds text before/after JSON. We extract the array block.
                const firstBracket = text.indexOf('[');
                const lastBracket = text.lastIndexOf(']');

                if (firstBracket !== -1 && lastBracket !== -1) {
                    text = text.substring(firstBracket, lastBracket + 1);
                    const questions = JSON.parse(text);
                    renderQuiz(questions);
                } else {
                    throw new Error("Formato inválido");
                }

            } catch (e) {
                console.error(e);
                container.innerHTML = `<div class="text-center p-4 text-red-500 text-sm">Error generando quiz. La IA puede estar saturada.<br><button onclick="generateQuiz()" class="underline mt-2">Reintentar</button></div>`;
            }
        }

        function renderQuiz(questions) {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            let score = 0;
            let answered = 0;

            const wrap = document.createElement('div');
            wrap.className = 'space-y-6 p-2';

            questions.forEach((q, idx) => {
                const qCard = document.createElement('div');
                qCard.className = 'quiz-card';
                qCard.innerHTML = `<p class="font-bold text-slate-800 mb-4 flex gap-2"><span class="bg-kawn-light text-kawn-deep w-6 h-6 rounded-full flex items-center justify-center text-xs flex-shrink-0">${idx + 1}</span> ${q.q}</p>`;

                const optsDiv = document.createElement('div');
                q.options.forEach((opt, oIdx) => {
                    const btn = document.createElement('div');
                    btn.className = 'quiz-option text-sm text-slate-600';
                    btn.textContent = opt;
                    btn.onclick = () => {
                        if (btn.parentElement.classList.contains('answered')) return;
                        const siblings = optsDiv.querySelectorAll('.quiz-option');
                        siblings.forEach(s => s.parentElement.classList.add('answered'));
                        answered++;
                        if (oIdx === q.a) {
                            btn.classList.add('correct');
                            btn.innerHTML = `<span>${opt}</span> <i data-lucide="check-circle" class="w-4 h-4"></i>`;
                            score++;
                        } else {
                            btn.classList.add('wrong');
                            btn.innerHTML = `<span>${opt}</span> <i data-lucide="x-circle" class="w-4 h-4"></i>`;
                            siblings[q.a].classList.add('correct');
                        }
                        lucide.createIcons();
                        if (answered === questions.length) showScore(score, questions.length);
                    };
                    optsDiv.appendChild(btn);
                });
                qCard.appendChild(optsDiv);
                wrap.appendChild(qCard);
            });
            container.appendChild(wrap);
        }

        function showScore(s, t) {
            const container = document.getElementById('quiz-container');
            const d = document.createElement('div');
            d.className = 'mt-6 p-6 bg-slate-900 text-white rounded-2xl text-center animate-pulse-slow shadow-xl';
            d.innerHTML = `
                <h4 class="text-xl font-bold mb-2">Resultados</h4>
                <p class="text-3xl font-black text-kawn-base mb-2">${s} / ${t}</p>
                <p class="text-xs text-slate-400">Dominio del Smart Money</p>
                <button onclick="generateQuiz()" class="mt-4 text-xs underline hover:text-white text-slate-400">Nuevo Intento</button>
            `;
            container.appendChild(d);
            d.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>

</html>