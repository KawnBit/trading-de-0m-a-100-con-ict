<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Curso interactivo sobre Smart Money Concepts y Trading Institucional. Aprende cómo operan las manos fuertes.">
    <title>KawnBit | El Mercado y el Dinero Inteligente</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Librerías Externas (CDN) con atributos defer para no bloquear renderizado -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Configuración Tailwind KawnBit -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kawn: {
                            light: '#ccfbf1', // Teal 100
                            base: '#14b8a6',  // Teal 500
                            dark: '#0f766e',  // Teal 700
                            deep: '#134e4a',  // Teal 900
                        },
                        slate: {
                            50: '#f8fafc',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                    },
                    boxShadow: {
                        'glow': '0 0 15px rgba(20, 184, 166, 0.3)',
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos personalizados y utilidades */
        body {
            background-color: #f8fafc;
            color: #334155;
            font-family: 'Inter', sans-serif;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif;
        }

        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #14b8a6; 
        }

        /* Logo CSS */
        .kawn-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #14b8a6 0%, #0f766e 100%);
            border-radius: 8px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(20, 184, 166, 0.4);
        }
        .kawn-logo-icon::after {
            content: 'K';
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 24px;
        }

        /* TOC Activo */
        .toc-link.active {
            color: #14b8a6;
            border-left: 3px solid #14b8a6;
            background-color: #ccfbf1;
            padding-left: 0.75rem; /* Ajuste visual al activarse */
        }
        .toc-link {
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        /* Barra de Progreso de Lectura */
        #reading-progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 4px;
            background: #14b8a6;
            z-index: 100;
            width: 0%;
            transition: width 0.1s ease-out;
        }

        /* Utilidades de animación */
        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
            opacity: 0;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Chat Bot */
        .chat-message {
            max-width: 80%;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .user-message {
            background-color: #14b8a6;
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        .ai-message {
            background-color: #e2e8f0;
            color: #0f172a;
            align-self: flex-start;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }
        /* Estilos específicos para la sección de Recursos */
        .resource-card {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }
        .resource-card:hover {
            border-color: #14b8a6;
            box-shadow: 0 4px 6px -1px rgba(20, 184, 166, 0.1);
        }
        
        /* Quiz Styles */
        .quiz-option {
            cursor: pointer;
            transition: all 0.2s;
        }
        .quiz-option:hover {
            background-color: #f1f5f9;
        }
        .quiz-option.selected {
            border-color: #14b8a6;
            background-color: #ccfbf1;
        }
        .quiz-option.correct {
            border-color: #10b981; /* Green-500 */
            background-color: #d1fae5; /* Green-100 */
        }
        .quiz-option.incorrect {
            border-color: #ef4444; /* Red-500 */
            background-color: #fee2e2; /* Red-100 */
        }
    </style>
</head>
<body class="antialiased text-slate-600">

    <!-- Barra de Progreso -->
    <div id="reading-progress-bar"></div>

    <!-- Navbar Sticky -->
    <nav class="sticky top-0 z-50 w-full bg-white/90 backdrop-blur-md border-b border-slate-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo Construct Header -->
                <div class="flex items-center gap-3">
                    <div class="kawn-logo-icon"></div>
                    <div class="flex flex-col">
                        <span class="text-2xl font-black text-slate-900 tracking-tight leading-none">KAWNBIT</span>
                        <span class="text-[0.6rem] font-bold text-kawn-base uppercase tracking-[0.2em] leading-none mt-1">Quantitative Trading Community</span>
                    </div>
                </div>
                
                <!-- Mobile Menu Button -->
                <button id="mobile-menu-btn" aria-label="Abrir menú" class="md:hidden p-2 rounded-md text-slate-600 hover:text-kawn-base focus:outline-none focus:ring-2 focus:ring-kawn-base">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>

                <!-- Desktop Nav -->
                <div class="hidden md:flex space-x-8">
                    <a href="#" class="text-kawn-base font-semibold border-b-2 border-kawn-base pb-1">Capítulo 1</a>
                    <a href="#evaluacion" class="text-slate-500 hover:text-kawn-base font-medium transition-colors">Test Final</a>
                    <a href="#recursos" class="text-slate-500 hover:text-kawn-base font-medium transition-colors">Recursos</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Layout Principal -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <div class="flex flex-col md:flex-row gap-12">

            <!-- Sidebar TOC (Sticky) -->
            <aside class="hidden md:block w-64 flex-shrink-0">
                <div class="sticky top-24">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Tabla de Contenidos</h3>
                    <nav id="toc-container" class="flex flex-col space-y-2 text-sm max-h-[calc(100vh-150px)] overflow-y-auto pr-2">
                        <!-- Generado dinámicamente por JS -->
                    </nav>
                </div>
            </aside>

            <!-- Contenido Principal -->
            <main class="flex-1 max-w-4xl min-w-0">
                
                <!-- Hero Section -->
                <section class="mb-16 fade-in">
                    <span class="inline-block py-1 px-3 rounded-full bg-kawn-light text-kawn-dark text-xs font-bold uppercase tracking-wider mb-4">Capítulo 1</span>
                    <h1 class="text-4xl md:text-5xl font-black text-slate-900 mb-6 leading-tight">
                        El Mercado y el <span class="text-kawn-base">Dinero Inteligente</span>
                    </h1>
                    <p class="text-xl text-slate-500 leading-relaxed">
                        Bienvenido a la realidad del trading institucional. Descubre quién mueve realmente los hilos y cómo dejar de ser la presa para convertirte en el depredador silencioso.
                    </p>
                </section>

                <!-- Introducción: Perspectiva -->
                <section id="intro-perspectiva" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="eye" class="text-kawn-base mr-3"></i> Cambiando tu perspectiva
                    </h2>
                    
                    <div class="bg-white rounded-xl shadow-lg border-l-4 border-kawn-base p-8 mb-8">
                        <h3 class="font-bold text-lg text-slate-900 mb-2">La Analogía del Póker</h3>
                        <p class="italic text-slate-600">
                            "Si después de media hora no identificaste quién es el pez en la mesa, entonces el pez eres tú".
                        </p>
                        <div class="mt-4 text-sm text-slate-500">
                            Esta analogía captura perfectamente la realidad del trading moderno. Muchos creen que los mercados financieros son un campo de juego nivelado, pero la verdad es otra.
                        </div>
                    </div>

                    <p class="mb-4 leading-7">
                        En este capítulo exploraremos una perspectiva totalmente nueva del mercado, una que puede resultar incómoda al principio –especialmente si llevas tiempo operando con métodos tradicionales–, pero que es esencial para tu evolución como trader.
                    </p>
                </section>

                <!-- La Nueva Realidad: HFT -->
                <section id="nueva-realidad-hft" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="cpu" class="text-kawn-base mr-3"></i> La nueva realidad: Las máquinas mandan
                    </h2>
                    
                    <p class="mb-6 leading-7">
                        Bienvenido al siglo XXI de los mercados. El mercado "clásico" donde humanos miran gráficos representa menos del 30% del volumen. La mayor parte proviene de algoritmos y <strong>trading de alta frecuencia (HFT)</strong>. Estos sistemas no duermen, no sufren emociones y procesan información a velocidades que el cerebro humano no puede igualar.
                    </p>

                    <!-- COMPONENTE INTERACTIVO 1: Comparador de Velocidad -->
                    <div class="bg-slate-900 rounded-xl p-6 shadow-2xl mb-10 border border-slate-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-white font-bold text-lg">Simulador de Latencia: Humano vs. Máquina</h3>
                            <span class="text-xs text-kawn-light bg-kawn-deep px-2 py-1 rounded">Interactivo</span>
                        </div>
                        <p class="text-slate-400 text-sm mb-6">Haz clic en el botón "REACCIONAR" tan pronto como cambie a color VERDE para medir tu velocidad frente a un HFT.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                            <div class="flex flex-col items-center">
                                <div id="reaction-box" class="w-full h-32 rounded-lg bg-red-500 flex items-center justify-center cursor-pointer transition-colors shadow-glow mb-4">
                                    <span id="reaction-text" class="text-white font-bold text-xl">ESPERA...</span>
                                </div>
                                <button id="start-reaction-btn" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">Iniciar Test</button>
                            </div>
                            
                            <div class="bg-slate-800 p-4 rounded-lg w-full">
                                <div class="mb-4">
                                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                                        <span>Tu tiempo:</span>
                                        <span id="user-time" class="text-white font-mono">-- ms</span>
                                    </div>
                                    <div class="w-full bg-slate-700 rounded-full h-2.5">
                                        <div id="user-bar" class="bg-kawn-base h-2.5 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                                        <span>HFT (Algo):</span>
                                        <span class="text-kawn-light font-mono">0.001 ms</span>
                                    </div>
                                    <div class="w-full bg-slate-700 rounded-full h-2.5">
                                        <div class="bg-purple-500 h-2.5 rounded-full" style="width: 0.1%"></div>
                                    </div>
                                </div>
                                <p id="reaction-result" class="mt-4 text-xs text-slate-300 italic hidden">
                                    ¡Lento! Mientras parpadeabas, el algoritmo ejecutó 5,000 operaciones.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-100">
                            <h4 class="font-bold text-slate-800 mb-2">Ventaja de Velocidad</h4>
                            <p class="text-sm text-slate-600">Mientras tu ojo parpadea en 300ms, un algoritmo HFT lanza 10,000 operaciones. Usan "Colocation" y redes de microondas.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-100">
                            <h4 class="font-bold text-slate-800 mb-2">Ventaja de Información</h4>
                            <p class="text-sm text-slate-600">Ven los flujos de órdenes institucionales. Analizan millones de fuentes (noticias, sentimiento) en tiempo real con IA.</p>
                        </div>
                    </div>
                </section>
                
                <!-- NEW CHART: Eficiencia Selectiva (MEJORADO) -->
                <section id="eficiencia-selectiva" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="scaling" class="text-red-500 mr-3"></i> Simulador de Eficiencia Selectiva
                    </h2>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-2">Transferencia de Riqueza Interactiva</h3>
                        <p class="text-sm text-slate-500 mb-4">Selecciona un escenario de mercado para ver cómo fluye el capital entre manos débiles y fuertes:</p>
                        
                        <!-- Botones de Escenario -->
                        <div class="flex flex-wrap gap-3 mb-6">
                            <button onclick="updateEfficiencyScenario('normal')" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-bold rounded-lg transition-colors border border-slate-300">
                                Ciclo Estándar
                            </button>
                            <button onclick="updateEfficiencyScenario('trap')" class="px-4 py-2 bg-red-50 hover:bg-red-100 text-red-700 text-xs font-bold rounded-lg transition-colors border border-red-200">
                                Trampa de Liquidez
                            </button>
                            <button onclick="updateEfficiencyScenario('fomo')" class="px-4 py-2 bg-purple-50 hover:bg-purple-100 text-purple-700 text-xs font-bold rounded-lg transition-colors border border-purple-200">
                                Burbuja FOMO
                            </button>
                        </div>

                        <div class="relative h-72 w-full mb-4">
                            <canvas id="efficiencyChart"></canvas>
                        </div>

                        <!-- Explicación Dinámica -->
                        <div id="efficiency-explanation" class="p-4 bg-slate-50 rounded-lg border-l-4 border-kawn-base text-sm text-slate-700 transition-all duration-300">
                            <strong>Ciclo Estándar:</strong> El mercado transfiere riqueza de forma constante. Mientras el minorista opera con emociones y pierde gradualmente, el Smart Money acumula esas pérdidas como ganancias a través de spreads y contrapartida.
                        </div>
                    </div>
                </section>

                <!-- La Industria Minorista -->
                <section id="industria-minorista" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="trending-down" class="text-red-500 mr-3"></i> La industria minorista: Diseñada para el fracaso
                    </h2>
                    
                    <div class="prose max-w-none text-slate-600 mb-8">
                        <p>Aquí viene una verdad incómoda: <strong>la industria está estructurada para que pierdas</strong>. Los brokers ganan con spreads y, a menudo, son tu contraparte.</p>
                        <blockquote class="border-l-4 border-slate-300 pl-4 italic my-4 text-slate-700">
                            Estudios muestran que entre el 75% y el 90% de los traders minoristas pierden dinero a largo plazo. Solo el 1-2% de los day traders obtiene ganancias sostenidas.
                        </blockquote>
                        <p>El mercado minorista es el alimento del mercado institucional. Cada euro que pierde un inexperto termina en la cuenta del "dinero inteligente".</p>
                    </div>

                    <!-- Interactive Accordion: Falsas promesas -->
                    <div class="space-y-4 mb-8">
                        <h3 class="font-bold text-lg text-slate-900">Las herramientas que te venden (vs. Realidad)</h3>
                        
                        <div class="border border-slate-200 rounded-lg overflow-hidden">
                            <button class="w-full px-6 py-4 text-left bg-slate-50 hover:bg-slate-100 flex justify-between items-center transition-colors" onclick="toggleAccordion('acc1')">
                                <span class="font-semibold text-slate-700">Indicadores "Revolucionarios"</span>
                                <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                            </button>
                            <div id="acc1" class="hidden px-6 py-4 bg-white text-sm text-slate-600 border-t border-slate-100">
                                Te venden flechas verdes y rojas. La realidad: la mayoría son reciclajes. Si fueran infalibles, no los venderían por $50, los usarían en secreto.
                            </div>
                        </div>

                        <div class="border border-slate-200 rounded-lg overflow-hidden">
                            <button class="w-full px-6 py-4 text-left bg-slate-50 hover:bg-slate-100 flex justify-between items-center transition-colors" onclick="toggleAccordion('acc2')">
                                <span class="font-semibold text-slate-700">Robots Milagrosos</span>
                                <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                            </button>
                            <div id="acc2" class="hidden px-6 py-4 bg-white text-sm text-slate-600 border-t border-slate-100">
                                Ningún robot de $99 te pondrá por delante de Goldman Sachs. Funcionan brevemente en condiciones específicas y luego queman la cuenta.
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Smart Money: Arquitectos -->
                <section id="smart-money-arquitectos" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="briefcase" class="text-kawn-base mr-3"></i> Smart Money: Los arquitectos del precio
                    </h2>
                    
                    <p class="mb-6 leading-7">
                        No son solo "traders listos". Son entidades con poder de mover el mercado.
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <!-- Card 1 -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-kawn-deep hover:-translate-y-1 transition-transform duration-300">
                            <div class="flex items-center mb-3">
                                <div class="p-2 bg-kawn-light rounded-lg mr-3"><i data-lucide="landmark" class="text-kawn-deep w-5 h-5"></i></div>
                                <h3 class="font-bold text-slate-800">Bancos Centrales</h3>
                            </div>
                            <p class="text-sm text-slate-600">Controlan la política monetaria. Imprimen dinero. Son el jugador más poderoso ("No luches contra la Fed").</p>
                        </div>
                        <!-- Card 2 -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-kawn-dark hover:-translate-y-1 transition-transform duration-300">
                            <div class="flex items-center mb-3">
                                <div class="p-2 bg-kawn-light rounded-lg mr-3"><i data-lucide="building-2" class="text-kawn-dark w-5 h-5"></i></div>
                                <h3 class="font-bold text-slate-800">Grandes Bancos</h3>
                            </div>
                            <p class="text-sm text-slate-600">Goldman Sachs, JP Morgan. Manejan flujos gigantescos y tienen información privilegiada legal.</p>
                        </div>
                        <!-- Card 3 -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-kawn-base hover:-translate-y-1 transition-transform duration-300">
                            <div class="flex items-center mb-3">
                                <div class="p-2 bg-kawn-light rounded-lg mr-3"><i data-lucide="line-chart" class="text-kawn-base w-5 h-5"></i></div>
                                <h3 class="font-bold text-slate-800">Hedge Funds</h3>
                            </div>
                            <p class="text-sm text-slate-600">Capital masivo. Usan algoritmos sofisticados o trading fundamental profundo. Pueden doblar el mercado.</p>
                        </div>
                        <!-- Card 4 -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-kawn-light hover:-translate-y-1 transition-transform duration-300">
                            <div class="flex items-center mb-3">
                                <div class="p-2 bg-kawn-light rounded-lg mr-3"><i data-lucide="users" class="text-kawn-dark w-5 h-5"></i></div>
                                <h3 class="font-bold text-slate-800">Market Makers</h3>
                            </div>
                            <p class="text-sm text-slate-600">Proveen liquidez. Ven tu stop loss. Citadel Securities maneja el 40% del flujo minorista. Juegan viendo tus cartas.</p>
                        </div>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 p-6 rounded-xl mb-6">
                        <h4 class="font-bold text-blue-800 mb-2">Conexión Wyckoff y SMC</h4>
                        <p class="text-sm text-blue-900">
                            Históricamente, Richard Wyckoff llamó a esto el "Composite Man" (Hombre Compuesto). Hoy, ICT y SMC lo llaman Smart Money. La verdad fundamental es la misma: <strong>el mercado está orquestado</strong>.
                        </p>
                    </div>
                </section>

                <!-- Cómo opera: Acumulación y Distribución -->
                <section id="operativa-acumulacion" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="activity" class="text-kawn-base mr-3"></i> Acumulación y Distribución
                    </h2>

                    <p class="mb-6 leading-7">
                        Para mover miles de millones sin arruinar su propio precio de entrada, el SM necesita operar en fases.
                    </p>

                    <!-- COMPONENTE INTERACTIVO 2: Visualizador Wyckoff -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200 mb-8">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-800">Ciclo de Mercado Institucional</h3>
                            <div class="space-x-2 mt-2 sm:mt-0">
                                <button onclick="updateChart('accumulation')" class="px-3 py-1 text-xs font-semibold rounded bg-kawn-light text-kawn-dark hover:bg-kawn-base hover:text-white transition">Acumulación</button>
                                <button onclick="updateChart('distribution')" class="px-3 py-1 text-xs font-semibold rounded bg-slate-100 text-slate-600 hover:bg-slate-200 transition">Distribución</button>
                            </div>
                        </div>
                        <div class="relative h-64 w-full">
                            <canvas id="wyckoffChart"></canvas>
                        </div>
                        <div id="chart-description" class="mt-4 text-sm text-slate-600 bg-slate-50 p-4 rounded-lg">
                            <!-- Texto dinámico -->
                            <strong>Acumulación:</strong> El SM compra sin subir el precio. Crean un rango lateral aburrido, generan "Springs" (trampas bajistas) para absorber pánico, y luego disparan el precio.
                        </div>
                    </div>
                </section>

                <!-- Caza de Stops -->
                <section id="stop-hunting" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="crosshair" class="text-red-500 mr-3"></i> Ingeniería de Stop-Loss (Caza de Stops)
                    </h2>
                    
                    <p class="mb-6 leading-7">
                        Una de las tácticas más crueles. El SM ve el libro de órdenes. Saben dónde pones tu stop (bajo soportes obvios, números redondos). Empujan el precio para barrer esa liquidez y luego giran.
                    </p>

                    <!-- COMPONENTE INTERACTIVO 3: Simulador de Stop Hunt -->
                    <div class="bg-slate-900 rounded-xl p-6 shadow-2xl mb-10 border border-slate-700 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10">
                            <i data-lucide="trending-up" class="w-32 h-32 text-white"></i>
                        </div>

                        <h3 class="text-white font-bold text-lg mb-2 z-10 relative">Simulador: Coloca tu Stop Loss</h3>
                        <p class="text-slate-400 text-xs mb-6 z-10 relative">Eres un trader minorista. El mercado está subiendo. Elige dónde poner tu stop loss en este gráfico simulado.</p>
                        
                        <!-- Area Gráfica Simplificada -->
                        <div class="relative bg-slate-800 h-64 rounded-lg border border-slate-600 mb-4 overflow-hidden" id="chart-area">
                            <!-- Velas dibujadas con CSS -->
                            <div class="absolute bottom-10 left-10 w-4 h-20 bg-green-500"></div> <!-- Vela 1 -->
                            <div class="absolute bottom-32 left-20 w-4 h-12 bg-green-500"></div> <!-- Vela 2 -->
                            <div class="absolute bottom-40 left-30 w-4 h-8 bg-red-500"></div> <!-- Vela 3 -->
                            
                            <!-- Nivel de Soporte Obvio -->
                            <div class="absolute bottom-30 left-0 w-full h-0.5 bg-yellow-400 border-dashed border-t border-yellow-400 opacity-50 flex items-center">
                                <span class="text-yellow-400 text-[10px] ml-2 bg-slate-900 px-1">Soporte Obvio ($100)</span>
                            </div>

                            <!-- Botones de Stop -->
                            <button onclick="triggerStopHunt('safe')" class="absolute bottom-10 right-10 px-3 py-1 bg-slate-600 hover:bg-slate-500 text-white text-xs rounded z-20">Stop Holgado ($90)</button>
                            <button onclick="triggerStopHunt('obvious')" class="absolute bottom-28 right-20 px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white text-xs rounded z-20 animate-pulse">Stop Obvio ($99)</button>
                            
                            <!-- Elemento animado del precio -->
                            <div id="price-marker" class="absolute w-3 h-3 bg-white rounded-full shadow-glow transition-all duration-1000" style="bottom: 160px; left: 160px;"></div>
                            <div id="price-line" class="absolute w-0.5 bg-white opacity-50 h-0 transition-all duration-1000" style="bottom: 160px; left: 165px;"></div>
                        </div>

                        <div id="hunt-feedback" class="p-3 rounded-lg text-sm bg-slate-800 text-slate-300 min-h-[60px]">
                            Selecciona una opción arriba para ver qué hace el Algoritmo Institucional.
                        </div>
                    </div>
                </section>

                <!-- Mentalidad y Conclusión -->
                <section id="mentalidad-conclusiones" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="brain-circuit" class="text-kawn-base mr-3"></i> La Paradoja Liberadora
                    </h2>

                    <div class="bg-gradient-to-r from-kawn-light to-white p-6 rounded-xl border border-kawn-base/30 mb-6">
                        <p class="text-kawn-deep font-medium italic text-center text-lg">
                            "Aceptar que el mercado está manipulado no es una excusa para el fracaso, es la clave para el éxito."
                        </p>
                    </div>

                    <ul class="space-y-4 text-slate-600 mb-8">
                        <li class="flex items-start">
                            <i data-lucide="check-circle-2" class="text-kawn-base w-5 h-5 mr-3 mt-1 flex-shrink-0"></i>
                            <span><strong>De predicador a seguidor:</strong> No adivines. Sé el detective que busca huellas.</span>
                        </li>
                        <li class="flex items-start">
                            <i data-lucide="check-circle-2" class="text-kawn-base w-5 h-5 mr-3 mt-1 flex-shrink-0"></i>
                            <span><strong>De tiburón a rémora:</strong> No compitas. Aliméntate de las migajas de sus movimientos masivos.</span>
                        </li>
                        <li class="flex items-start">
                            <i data-lucide="check-circle-2" class="text-kawn-base w-5 h-5 mr-3 mt-1 flex-shrink-0"></i>
                            <span><strong>De cazador a oportunista:</strong> Solo opera cuando los intereses del smart money coincidan con los tuyos.</span>
                        </li>
                    </ul>
                </section>

                 <!-- Glosario -->
                 <section id="glosario" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6">Glosario Esencial</h2>
                    <div class="grid gap-3" id="glossary-container">
                        <!-- Llenado por JS -->
                    </div>
                </section>

                <!-- Ejercicios (NUEVO Simulador de Stop Loss Hunting con Plotly) -->
                <section id="ejercicios" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="line-chart" class="text-kawn-base mr-3"></i> Taller de Ingeniería de Stop Loss (Plotly)
                    </h2>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-4">Simulador: La Barrida de Liquidez</h3>
                        <p class="text-sm text-slate-600 mb-4">
                            Observa el gráfico de velas. La línea roja punteada marca un soporte clave donde los traders minoristas han colocado sus stops de compra. Pulsa "Iniciar Simulación" para ver la maniobra institucional.
                        </p>
                        
                        <!-- Contenedor del Gráfico Plotly -->
                        <div id="stopHuntChart" class="w-full h-96 mb-6"></div>

                        <div class="flex flex-col sm:flex-row gap-4">
                            <button id="startStopHuntBtn" class="flex-1 bg-kawn-base hover:bg-kawn-dark text-white font-semibold py-2 px-4 rounded-lg transition-colors shadow-md">
                                Iniciar Simulación de Barrida
                            </button>
                            <button id="resetStopHuntBtn" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg transition-colors shadow-md" disabled>
                                Resetear Gráfico
                            </button>
                        </div>

                        <div id="huntStatus" aria-live="polite" class="mt-4 p-3 rounded-lg text-sm bg-slate-50 text-slate-700 border border-slate-200">
                            Esperando...
                        </div>
                    </div>

                    <!-- NUEVA FUNCIÓN AI: SIMULADOR DE PSICOLOGÍA INVERSA -->
                    <div class="bg-kawn-deep p-6 rounded-xl shadow-lg border border-kawn-dark mt-8">
                        <h3 class="text-xl font-black text-white mb-4 flex items-center gap-2">
                            <i data-lucide="sparkles" class="w-5 h-5 text-yellow-300"></i> Diseñador de Trampas AI ✨
                        </h3>
                        <p class="text-slate-300 text-sm mb-4">
                            Genera escenarios de psicología inversa para practicar la mentalidad institucional. Elige una condición y la IA te dirá qué haría el *smart money* para manipular la liquidez.
                        </p>

                        <div class="mb-4">
                            <label for="psychologyScenario" class="block text-sm font-medium text-slate-200 mb-2">Escenario Actual del Mercado:</label>
                            <select id="psychologyScenario" class="w-full p-2 border border-slate-600 rounded-lg bg-slate-800 text-white focus:ring-kawn-base focus:border-kawn-base">
                                <option value="euforia_maximo">Euforia extrema tras nuevo máximo.</option>
                                <option value="panico_soporte">Pánico cerca de un soporte clave (miedo a la caída).</option>
                                <option value="rango_aburrido">Mercado en rango lateral y aburrido (poca liquidez).</option>
                                <option value="fomo_ruptura">Ruptura clara de resistencia, atrayendo compradores tardíos.</option>
                            </select>
                        </div>

                        <button id="generatePsychologyBtn" class="w-full bg-kawn-base hover:bg-kawn-light hover:text-kawn-deep text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md flex items-center justify-center gap-2">
                            <i data-lucide="cpu" class="w-4 h-4"></i> Generar Estrategia de Manipulación
                        </button>

                        <div id="psychologyOutput" aria-live="polite" class="mt-4 p-4 rounded-lg text-sm bg-kawn-light text-kawn-deep border border-kawn-base hidden min-h-[50px] transition-all duration-300">
                            <!-- Contenido generado por la IA -->
                        </div>
                        <div id="psychologyLoading" class="mt-4 p-4 rounded-lg text-sm bg-kawn-light text-kawn-deep border border-kawn-base hidden animate-pulse">
                            <i data-lucide="loader-2" class="w-4 h-4 inline mr-2 animate-spin"></i> Diseñando estrategia inversa...
                        </div>
                    </div>
                </section>

                <!-- NUEVA SECCIÓN: EVALUACIÓN (QUIZ) -->
                <section id="evaluacion" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i data-lucide="award" class="text-kawn-base mr-3"></i> Validación del Conocimiento
                    </h2>
                    
                    <div class="bg-white p-8 rounded-xl shadow-lg border border-slate-200">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-slate-800">Quiz del Capítulo 1: Smart Money</h3>
                            <span id="quiz-score" class="text-sm font-bold text-slate-500 bg-slate-100 px-3 py-1 rounded-full">Puntuación: 0/4</span>
                        </div>

                        <!-- Pregunta 1 -->
                        <div class="mb-8">
                            <p class="font-semibold text-slate-900 mb-3">1. ¿Qué es realmente el "Smart Money"?</p>
                            <div class="space-y-2" id="q1-options">
                                <div class="quiz-option border border-slate-300 rounded-lg p-3 text-sm text-slate-700" onclick="checkAnswer(1, 'a', this)">A. Traders minoristas muy inteligentes.</div>
                                <div class="quiz-option border border-slate-300 rounded-lg p-3 text-sm text-slate-700" onclick="checkAnswer(1, 'b', this)">B. Entidades con gran capital y ventajas estructurales (Bancos, Fondos, MM).</div>
                                <div class="quiz-option border border-slate-300 rounded-lg p-3 text-sm text-slate-700" onclick="checkAnswer(1, 'c', this)">C. Robots de trading que cuestan $99.</div>
                            </div>
                            <p id="q1-feedback" class="mt-2 text-xs hidden"></p>
                        </div>

                        <!-- Pregunta 2 -->
                        <div class="mb-8">
                            <p class="font-semibold text-slate-900 mb-3">2. ¿Qué ventaja principal tienen los algoritmos HFT?</p>
                            <div class="space-y-2" id="q2-options">
                                <div class="quiz-option border border-slate-300 rounded-lg p-3 text-sm text-slate-700" onclick="checkAnswer(2, 'a', this)">A. Velocidad de ejecución en microsegundos.</div>
                                <div class="quiz-option border border-slate-300 rounded-lg p-3 text-sm text-slate-700" onclick="checkAnswer(2, 'b', this)">B. Análisis fundamental de balances anuales.</div>
                                <div class="quiz-option border border-slate-300 rounded-lg p-3 text-sm text-slate-700" onclick="checkAnswer(2, 'c', this)">C. Uso de indicadores RSI y MACD estándar.</div>
                            </div>
                            <p id="q2-feedback" class="mt-2 text-xs hidden"></p>
                        </div>

                        <!-- Pregunta 3 -->
                        <div class="mb-8">
                            <p class="font-semibold text-slate-900 mb-3">3. En la fase de ACUMULACIÓN, ¿qué busca el Smart Money?</p>
                            <div class="space-y-2" id="q3-options">
                                <div class="quiz-option border border-slate-300 rounded-lg p-3 text-sm text-slate-700" onclick="checkAnswer(3, 'a', this)">A. Subir el precio rápidamente para ganar dinero ya.</div>
                                <div class="quiz-option border border-slate-300 rounded-lg p-3 text-sm text-slate-700" onclick="checkAnswer(3, 'b', this)">B. Comprar grandes cantidades sin subir el precio, creando rangos laterales.</div>
                                <div class="quiz-option border border-slate-300 rounded-lg p-3 text-sm text-slate-700" onclick="checkAnswer(3, 'c', this)">C. Vender todas sus posiciones a los minoristas.</div>
                            </div>
                            <p id="q3-feedback" class="mt-2 text-xs hidden"></p>
                        </div>

                        <!-- Pregunta 4 -->
                        <div class="mb-8">
                            <p class="font-semibold text-slate-900 mb-3">4. ¿Para qué se realiza una "Caza de Stops" (Stop Hunt)?</p>
                            <div class="space-y-2" id="q4-options">
                                <div class="quiz-option border border-slate-300 rounded-lg p-3 text-sm text-slate-700" onclick="checkAnswer(4, 'a', this)">A. Para fastidiar a los traders por diversión.</div>
                                <div class="quiz-option border border-slate-300 rounded-lg p-3 text-sm text-slate-700" onclick="checkAnswer(4, 'b', this)">B. Es un error del sistema informático.</div>
                                <div class="quiz-option border border-slate-300 rounded-lg p-3 text-sm text-slate-700" onclick="checkAnswer(4, 'c', this)">C. Para obtener la liquidez necesaria activando órdenes pendientes antes de un movimiento real.</div>
                            </div>
                            <p id="q4-feedback" class="mt-2 text-xs hidden"></p>
                        </div>

                    </div>
                </section>

                <!-- RECURSOS (Rediseño Completo y Función AI) -->
                <section id="recursos" class="mb-20 scroll-mt-28">
                    <h2 class="text-2xl font-bold text-slate-900 mb-8 flex items-center">
                        <i data-lucide="book-open" class="text-kawn-base mr-3"></i> Recursos Adicionales
                    </h2>
                    
                    <div class="space-y-12">

                        <!-- Bloque 1: Visión General del Capítulo -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                            <h3 class="text-xl font-black text-slate-900 mb-4 flex items-center gap-2">
                                <i data-lucide="library" class="w-5 h-5 text-kawn-dark"></i> Capítulo 1: Texto Integral
                            </h3>
                            <p class="text-sm text-slate-500 mb-6">Lectura profunda y contexto completo para consolidar tu conocimiento sobre la operativa institucional.</p>

                            <div class="space-y-6 text-sm leading-relaxed text-slate-700">
                                
                                <!-- Introducción -->
                                <div class="resource-card">
                                    <h4 class="font-bold text-kawn-dark mb-1">1. Cambiando tu perspectiva del mercado</h4>
                                    <p>Imagínate que estás jugando al póker en una mesa con desconocidos. Esta analogía captura perfectamente la realidad del trading moderno. En este capítulo exploraremos una perspectiva totalmente nueva del mercado, una que es esencial para tu evolución como trader.</p>
                                </div>

                                <!-- Nueva Realidad HFT -->
                                <div class="resource-card">
                                    <h4 class="font-bold text-kawn-dark mb-1">2. La nueva realidad: ordenadores y trading de alta frecuencia (HFT)</h4>
                                    <p>Las máquinas mandan. El mercado "clásico" en el que los traders humanos toman decisiones representa menos del 30% del volumen. La mayor parte proviene de algoritmos HFT que ejecutan miles de órdenes por segundo. Mientras tu ojo parpadea en 300 milisegundos, un algoritmo HFT puede lanzar más de 10.000 operaciones.</p>
                                    <p class="mt-2">El horizonte de inversión se ha acortado drásticamente (de 8 años en los '50 a menos de 6 meses hoy). La **colocation** y las redes de microondas otorgan ventajas de microsegundos que el cerebro humano no puede igualar.</p>
                                </div>

                                <!-- Ventaja Asimétrica -->
                                <div class="resource-card">
                                    <h4 class="font-bold text-kawn-dark mb-1">3. La ventaja informacional asimétrica</h4>
                                    <p>La velocidad es solo una parte. Las instituciones grandes tienen mejor información: acceden a flujos de órdenes, lo que les permite intuir hacia dónde va el "dinero grande" antes de que se refleje en el precio. Usan modelos predictivos avanzados e inteligencia artificial para anticipar movimientos. Las grandes firmas saben más que tú y actúan más rápido; muchas veces lo **crean**.</p>
                                </div>

                                <!-- Industria Minorista -->
                                <div class="resource-card">
                                    <h4 class="font-bold text-kawn-dark mb-1">4. La industria minorista: diseñada para el fracaso</h4>
                                    <p>La industria del trading minorista está estructurada para que la mayoría pierda dinero (75%-90% pierden). Los brokers ganan con spreads, comisiones y siendo tu contraparte. El mercado minorista es el alimento del mercado institucional.</p>
                                </div>

                                <!-- Eficiencia Selectiva -->
                                <div class="resource-card">
                                    <h4 class="font-bold text-kawn-dark mb-1">5. El paradigma: eficiencia selectiva</h4>
                                    <p>Los mercados sí son eficientes, pero en transferir riqueza de las manos débiles a las manos fuertes. Cada vez que compras en un máximo por FOMO o vendes en un mínimo presa del pánico, participas en esta transferencia. El precio refleja la información para quienes la crean, no para el público.</p>
                                </div>

                                <!-- Smart Money Arquitectos -->
                                <div class="resource-card">
                                    <h4 class="font-bold text-kawn-dark mb-1">6. smart money: los arquitectos del precio</h4>
                                    <p>Son las entidades con el poder de mover los mercados a voluntad: Bancos Centrales (fijan las reglas), Grandes Bancos (flujos gigantescos), Hedge Funds (capital para aguantar movimientos) y **Market Makers** (ven todas las cartas de los minoristas, gestionando el 90% de sus órdenes en EE.UU.). Ellos crean los patrones que tú ves.</p>
                                </div>

                                <!-- Mecanismos de Manipulación -->
                                <div class="resource-card">
                                    <h4 class="font-bold text-kawn-dark mb-1">7. Mecanismos de manipulación</h4>
                                    <ul class="list-disc pl-5 space-y-2 mt-2">
                                        <li><strong>Acumulación:</strong> Comprar sin que el precio suba. Crean rangos laterales y **springs** (caídas falsas) para absorber ventas de pánico.</li>
                                        <li><strong>Distribución:</strong> Vender caro sin que el precio caiga. Crean euforia (FOMO) y nuevos picos para liquidar posiciones a compradores tardíos.</li>
                                        <li><strong>Stop Hunting:</strong> Estrategia para mover el precio deliberadamente hasta niveles donde se concentran los stop-loss (stops "obvios"), activándolos para obtener liquidez y luego giran.</li>
                                    </ul>
                                </div>

                                <!-- Implicaciones Prácticas -->
                                <div class="resource-card">
                                    <h4 class="font-bold text-kawn-dark mb-1">8. Tu nueva mentalidad operativa</h4>
                                    <ul class="list-disc pl-5 space-y-2 mt-2">
                                        <li>De predicador a **seguidor**: No adivines, sé detective de huellas.</li>
                                        <li>De competidor a **parásito**: Sigue el movimiento institucional.</li>
                                        <li>Sé **oportunista**: Solo necesitas operaciones de alta probabilidad donde el smart money y tus intereses coincidan.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Bloque 3: LLM Driven Deep Dive Recommendation -->
                        <div class="bg-kawn-deep p-6 rounded-xl shadow-lg border border-kawn-dark">
                            <h3 class="text-xl font-black text-white mb-4 flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-5 h-5 text-yellow-300"></i> Lectura Profunda AI ✨
                            </h3>
                            <p class="text-slate-300 text-sm mb-4">
                                Usa la inteligencia artificial para generar un tema de reflexión avanzado, un concepto relacionado con la liquidez, o una analogía fresca para interiorizar mejor la mentalidad institucional.
                            </p>

                            <button id="generateDeepDiveBtn" class="w-full bg-kawn-base hover:bg-kawn-light hover:text-kawn-deep text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md flex items-center justify-center gap-2">
                                <i data-lucide="zap" class="w-4 h-4"></i> Generar Tema de Reflexión
                            </button>

                            <div id="deepDiveOutput" aria-live="polite" class="mt-4 p-4 rounded-lg text-sm bg-kawn-light text-kawn-deep border border-kawn-base hidden min-h-[50px] transition-all duration-300">
                                <!-- Contenido generado por la IA -->
                            </div>
                            <div id="deepDiveLoading" class="mt-4 p-4 rounded-lg text-sm bg-kawn-light text-kawn-deep border border-kawn-base hidden animate-pulse">
                                <i data-lucide="loader-2" class="w-4 h-4 inline mr-2 animate-spin"></i> Generando recomendación avanzada...
                            </div>
                        </div>

                        <!-- Bloque 2: Ejercicios de Aplicación -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                            <h3 class="text-xl font-black text-slate-900 mb-4 flex items-center gap-2">
                                <i data-lucide="target" class="w-5 h-5 text-kawn-dark"></i> Ejercicios de Aplicación
                            </h3>
                            <ol class="list-decimal pl-5 space-y-4 text-sm text-slate-700">
                                <li><strong>Identificar fases en un gráfico real:</strong> Busca rangos laterales extensos, springs y upthrusts. Marca las fases de Wyckoff y verifica si el movimiento posterior confirma tu hipótesis.</li>
                                <li><strong>Analizar una "caza de stops" personal:</strong> Revisa tu historial. ¿Tu stop estaba en un nivel "obvio"? ¿El precio revirtió rápidamente? Mide la distancia de la barrida para posicionar mejor en el futuro.</li>
                                <li><strong>Elaborar un plan de trading alineado con el smart money:</strong> Diseña un plan que incluya filtros para confirmar la presencia de mano fuerte antes de entrar y una estrategia para posicionar stops fuera de zonas de liquidez obvia.</li>
                                <li><strong>Simulación mental de psicología inversa:</strong> Imagina el sentimiento general del mercado (euforia, pánico) y pregúntate: si fueras el smart money, ¿qué movimiento provocarías para atrapar a la masa y obtener liquidez?</li>
                            </ol>
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <!-- AI Mentor Float -->
    <div class="fixed bottom-6 right-6 z-40">
        <button id="ai-toggle" aria-label="Abrir mentor virtual" class="bg-slate-900 text-white p-4 rounded-full shadow-2xl hover:bg-slate-800 transition-all hover:scale-105 flex items-center gap-2">
            <i data-lucide="bot" class="w-6 h-6 text-kawn-base"></i>
            <span class="font-bold hidden md:inline">Mentor KawnBit IA</span>
        </button>
    </div>

    <!-- AI Modal -->
    <div id="ai-modal" class="hidden fixed bottom-24 right-6 w-96 max-w-[90vw] bg-white rounded-xl shadow-2xl border border-slate-200 z-50 flex flex-col h-[500px]">
        <div class="p-4 bg-slate-900 text-white rounded-t-xl flex justify-between items-center">
            <h3 class="font-bold flex items-center gap-2"><i data-lucide="bot" class="text-kawn-base w-4 h-4"></i> Mentor IA</h3>
            <button id="close-ai" aria-label="Cerrar chat" class="hover:text-kawn-light"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div id="chat-history" aria-live="polite" class="flex-1 overflow-y-auto p-4 bg-slate-50 flex flex-col">
            <div class="ai-message chat-message shadow-sm">
                Hola. Soy tu mentor de Trading Institucional. Pregúntame sobre "Smart Money", "Accumulation" o cómo evitar trampas de liquidez.
            </div>
        </div>
        <div class="p-4 border-t border-slate-200 bg-white rounded-b-xl">
            <div class="flex gap-2">
                <input type="text" id="user-input" class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-kawn-base" placeholder="Escribe tu duda...">
                <button id="send-ai" aria-label="Enviar mensaje" class="bg-kawn-base text-white p-2 rounded-lg hover:bg-kawn-dark transition-colors">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-12 mt-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <!-- Logo Construct Footer (Unificado con Header) -->
            <div class="flex items-center gap-3">
                <div class="kawn-logo-icon"></div>
                <div class="flex flex-col">
                    <span class="text-2xl font-black text-white tracking-tight leading-none">KAWNBIT</span>
                    <span class="text-[0.6rem] font-bold text-kawn-base uppercase tracking-[0.2em] leading-none mt-1">Quantitative Trading Community</span>
                </div>
            </div>
            <p class="text-sm text-center md:text-right">
                © <span id="current-year"></span> KawnBit Quantitative Trading Community.<br>
                <span class="text-xs opacity-50">Material educativo. No constituye asesoramiento financiero.</span>
            </p>
        </div>
    </footer>

    <!-- SCRIPTS LÓGICOS -->
    <script>
        // Inicializar Iconos de forma segura
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        } else {
            console.warn("Lucide Icons no se pudo cargar.");
        }

        // ----------------------------------------------------
        // 0. AÑO DINÁMICO (Footer) & READING PROGRESS BAR
        // ----------------------------------------------------
        document.getElementById('current-year').textContent = new Date().getFullYear();

        window.onscroll = function() {
            let winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            let height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            let scrolled = (winScroll / height) * 100;
            document.getElementById("reading-progress-bar").style.width = scrolled + "%";
        };

        // ----------------------------------------------------
        // 1. LÓGICA TOC (Tabla de Contenidos Dinámica)
        // ----------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            const tocContainer = document.getElementById('toc-container');
            const headers = document.querySelectorAll('main h2, main h3');
            
            headers.forEach((header, index) => {
                const id = header.id || `section-${index}`;
                header.id = id;
                
                const link = document.createElement('a');
                link.href = `#${id}`;
                link.textContent = header.innerText;
                link.className = `toc-link block py-1 text-slate-500 hover:text-slate-800 ${header.tagName === 'H3' ? 'pl-4 text-xs' : 'font-medium'}`;
                
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
                });

                tocContainer.appendChild(link);
            });

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        document.querySelectorAll('.toc-link').forEach(link => link.classList.remove('active'));
                        const activeLink = document.querySelector(`.toc-link[href="#${entry.target.id}"]`);
                        if (activeLink) activeLink.classList.add('active');
                    }
                });
            }, { rootMargin: '-20% 0px -50% 0px' }); 

            headers.forEach(header => observer.observe(header));
        });

        // ----------------------------------------------------
        // 2. INTERACTIVO: Simulador de Velocidad (Reaction Test)
        // ----------------------------------------------------
        const reactionBox = document.getElementById('reaction-box');
        const reactionText = document.getElementById('reaction-text');
        const startBtn = document.getElementById('start-reaction-btn');
        const resultText = document.getElementById('reaction-result');
        const userBar = document.getElementById('user-bar');
        const userTimeDisplay = document.getElementById('user-time');

        let startTime, timeoutId;
        let isWaiting = false;

        startBtn.addEventListener('click', () => {
            clearTimeout(timeoutId); // Limpiar timeout anterior
            
            reactionBox.className = "w-full h-32 rounded-lg bg-red-500 flex items-center justify-center cursor-pointer shadow-glow mb-4";
            reactionText.textContent = "ESPERA...";
            resultText.classList.add('hidden');
            userBar.style.width = '0%';
            isWaiting = true;
            
            const randomDelay = Math.floor(Math.random() * 2000) + 1000;
            
            timeoutId = setTimeout(() => {
                reactionBox.className = "w-full h-32 rounded-lg bg-green-500 flex items-center justify-center cursor-pointer shadow-glow mb-4 transform scale-105 transition-transform";
                reactionText.textContent = "¡CLICK AHORA!";
                startTime = Date.now();
                
                reactionBox.onclick = () => {
                    if(!isWaiting) return;
                    const endTime = Date.now();
                    const reactionTime = endTime - startTime;
                    userTimeDisplay.textContent = `${reactionTime} ms`;
                    const percentage = Math.min((reactionTime / 500) * 100, 100); 
                    userBar.style.width = `${percentage}%`;
                    
                    resultText.classList.remove('hidden');
                    reactionBox.onclick = null;
                    isWaiting = false;
                };

            }, randomDelay);
        });

        // ----------------------------------------------------
        // 3. INTERACTIVO: Acumulación vs Distribución (Chart.js)
        // ----------------------------------------------------
        let wyckoffChartInstance = null; // Variable global para la instancia

        try {
            if (typeof Chart !== 'undefined') {
                const ctx = document.getElementById('wyckoffChart').getContext('2d');
                const accumulationData = [100, 95, 102, 94, 98, 92, 105, 115, 125, 140];
                const distributionData = [140, 145, 138, 148, 142, 150, 135, 120, 110, 90];
                const labels = ['Fase A', 'B', 'B', 'Spring/Test', 'Test', 'SOS', 'Markup', 'Markup', 'Markup', 'Markup'];

                function initChart() {
                    // Destruir instancia previa si existe para evitar superposiciones y fugas de memoria
                    if (wyckoffChartInstance) {
                        wyckoffChartInstance.destroy();
                    }

                    wyckoffChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Precio (Acción Institucional)',
                                data: accumulationData,
                                borderColor: '#14b8a6',
                                backgroundColor: 'rgba(20, 184, 166, 0.1)',
                                borderWidth: 3,
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: '#0f766e',
                                pointRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { callbacks: { label: (c) => `Precio: $${c.raw}` } }
                            },
                            scales: { y: { display: false }, x: { grid: { display: false } } }
                        }
                    });
                }

                // Función global expuesta
                window.updateChart = function(phase) {
                    if (!wyckoffChartInstance) return;
                    const desc = document.getElementById('chart-description');
                    if (phase === 'accumulation') {
                        wyckoffChartInstance.data.datasets[0].data = accumulationData;
                        wyckoffChartInstance.data.datasets[0].borderColor = '#14b8a6';
                        wyckoffChartInstance.data.datasets[0].backgroundColor = 'rgba(20, 184, 166, 0.1)';
                        desc.innerHTML = `<strong>Acumulación:</strong> El SM compra sin subir el precio. Crean un rango lateral aburrido, generan "Springs" (trampas bajistas) para absorber pánico, y luego disparan el precio.`;
                    } else {
                        wyckoffChartInstance.data.datasets[0].data = distributionData;
                        wyckoffChartInstance.data.datasets[0].borderColor = '#ef4444';
                        wyckoffChartInstance.data.datasets[0].backgroundColor = 'rgba(239, 68, 68, 0.1)';
                        desc.innerHTML = `<strong>Distribución:</strong> Euforia y noticias positivas. Crean nuevos máximos falsos (UTAD) para atraer compradores FOMO y venderles sus posiciones antes del colapso.`;
                    }
                    wyckoffChartInstance.update();
                }

                initChart();
            } else {
                console.warn('Chart.js no se cargó correctamente.');
            }
        } catch (e) { console.error("Error inicializando Chart.js (Wyckoff):", e); }
        
        // ----------------------------------------------------
        // 4. CHART: Eficiencia Selectiva (Chart.js - MEJORADO)
        // ----------------------------------------------------
        let efficiencyChartInstance = null; 

        try {
            if (typeof Chart !== 'undefined') {
                const effCtx = document.getElementById('efficiencyChart').getContext('2d');
                
                // Escenarios de Datos
                const scenarios = {
                    normal: {
                        sm: [20, 25, 30, 35, 40, 45, 50, 55, 60, 65],
                        retail: [80, 75, 70, 65, 60, 55, 50, 45, 40, 35],
                        text: "<strong>Ciclo Estándar:</strong> El mercado transfiere riqueza de forma constante. Mientras el minorista opera con emociones y pierde gradualmente, el Smart Money acumula esas pérdidas como ganancias a través de spreads y contrapartida."
                    },
                    trap: {
                        sm: [20, 22, 24, 25, 26, 60, 65, 70, 75, 80],
                        retail: [80, 78, 76, 75, 74, 40, 35, 30, 25, 20],
                        text: "<strong>Trampa de Liquidez:</strong> Observa el salto brusco en T6. El precio rompe un soporte falso, los minoristas venden en pánico (pérdida masiva inmediata), y el Smart Money absorbe todo ese volumen instantáneamente."
                    },
                    fomo: {
                        sm: [20, 15, 10, 5, 25, 45, 65, 80, 90, 95],
                        retail: [80, 85, 90, 95, 75, 55, 35, 20, 10, 5],
                        text: "<strong>Burbuja FOMO:</strong> Al principio (T1-T4), el minorista 'gana' en papel mientras el precio sube irracionalmente. Pero en T5, la burbuja estalla. El Smart Money vendió arriba y recompra en la caída, limpiando las cuentas minoristas."
                    }
                };

                const timeLabels = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10'];

                function initEfficiencyChart() {
                    if (efficiencyChartInstance) {
                        efficiencyChartInstance.destroy();
                    }

                    efficiencyChartInstance = new Chart(effCtx, {
                        type: 'line',
                        data: {
                            labels: timeLabels,
                            datasets: [
                                { label: 'Ganancia Neta SM', data: scenarios.normal.sm, borderColor: '#14b8a6', backgroundColor: 'rgba(20, 184, 166, 0.1)', borderWidth: 3, tension: 0.4, fill: false, pointRadius: 5 },
                                { label: 'Pérdida Neta Minorista', data: scenarios.normal.retail, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', borderWidth: 3, tension: 0.4, fill: false, pointRadius: 5 }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 1000,
                                easing: 'easeOutQuart'
                            },
                            plugins: {
                                legend: { position: 'top', labels: { usePointStyle: true, color: '#0f172a', font: { family: 'Inter' } } },
                                tooltip: { mode: 'index', intersect: false }
                            },
                            scales: {
                                y: { beginAtZero: true, max: 100, title: { display: true, text: 'Transferencia de Riqueza (%)' }, ticks: { callback: (v) => v + '%' } },
                                x: { title: { display: true, text: 'Periodo Operativo' } }
                            }
                        }
                    });
                }

                // Función global para actualizar el escenario
                window.updateEfficiencyScenario = function(type) {
                    if (!efficiencyChartInstance) return;
                    
                    const data = scenarios[type];
                    const explanationEl = document.getElementById('efficiency-explanation');
                    
                    // Actualizar datos
                    efficiencyChartInstance.data.datasets[0].data = data.sm;
                    efficiencyChartInstance.data.datasets[1].data = data.retail;
                    
                    // Actualizar gráfico
                    efficiencyChartInstance.update();
                    
                    // Actualizar texto explicativo con animación simple
                    explanationEl.style.opacity = 0;
                    setTimeout(() => {
                        explanationEl.innerHTML = data.text;
                        explanationEl.style.opacity = 1;
                    }, 300);
                };

                initEfficiencyChart();
            }
        } catch (e) { console.error("Error inicializando Efficiency Chart:", e); }
        
        // ----------------------------------------------------
        // 5. INTERACTIVO: Stop Hunt Simulator (CSS/JS - Legacy Visual)
        // ----------------------------------------------------
        window.triggerStopHunt = function(type) {
            const priceMarker = document.getElementById('price-marker');
            const feedback = document.getElementById('hunt-feedback');
            const priceLine = document.getElementById('price-line');

            priceMarker.style.transition = 'none';
            priceMarker.style.bottom = '160px';
            priceMarker.style.left = '160px';
            priceLine.style.height = '0';
            
            // Forzar reflow
            void priceMarker.offsetWidth;

            setTimeout(() => {
                priceMarker.style.transition = 'all 1.5s cubic-bezier(0.25, 0.1, 0.25, 1)';
                
                if (type === 'obvious') {
                    priceMarker.style.bottom = '110px';
                    priceMarker.style.backgroundColor = '#ef4444';
                    feedback.innerHTML = `<span class="text-red-400 font-bold">¡CAZADO!</span> Pusiste el stop en $99, justo bajo el soporte obvio. El market maker vio miles de órdenes ahí, empujó el precio para tomarlas (liquidez) y luego subirá sin ti.`;
                    setTimeout(() => {
                        priceMarker.style.bottom = '220px';
                        priceMarker.style.backgroundColor = '#14b8a6';
                    }, 1500);
                } else {
                    priceMarker.style.bottom = '130px'; 
                    priceMarker.style.backgroundColor = '#fbbf24';
                    feedback.innerHTML = `<span class="text-green-400 font-bold">¡SOBREVIVISTE!</span> Tu stop en $90 estaba protegido. El precio hizo un barrido del soporte ($100), sacó a los impacientes, pero tú mantuviste la posición para la subida.`;
                    setTimeout(() => {
                        priceMarker.style.bottom = '220px';
                        priceMarker.style.backgroundColor = '#14b8a6';
                    }, 1500);
                }
            }, 50);
        }

        // ----------------------------------------------------
        // 6. COMPONENTE: Acordeón Glosario
        // ----------------------------------------------------
        const glossaryTerms = [
            { term: "Smart Money", def: "Grandes participantes (Bancos, Fondos) que influyen en el precio con vastos recursos e información privilegiada." },
            { term: "Liquidez", def: "Puntos del gráfico donde se concentran órdenes (Stops). El SM busca estas zonas para ejecutar sus grandes volúmenes." },
            { term: "Spring (Muelle)", def: "Trampa bajista en Wyckoff. Rompe un soporte para barrer stops y generar pánico antes de subir." },
            { term: "FOMO", def: "Fear Of Missing Out. Miedo a perderse la oportunidad. El SM lo usa en Distribución para vender caro." }
        ];

        const glossaryContainer = document.getElementById('glossary-container');
        glossaryTerms.forEach((item, index) => {
            glossaryContainer.innerHTML += `
                <div class="border border-slate-200 rounded-lg bg-white overflow-hidden">
                    <button class="w-full px-4 py-3 text-left font-semibold text-slate-800 hover:bg-slate-50 flex justify-between items-center" onclick="toggleAccordion('glos-${index}')">
                        ${item.term}
                        <i data-lucide="plus" class="w-4 h-4 text-kawn-base"></i>
                    </button>
                    <div id="glos-${index}" class="hidden px-4 py-3 bg-slate-50 text-sm text-slate-600 border-t border-slate-100">
                        ${item.def}
                    </div>
                </div>
            `;
        });

        window.toggleAccordion = function(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
        }

        // ----------------------------------------------------
        // 7. INTEGRACIÓN AI (Helper Fetch con Timeout y AbortController)
        // ----------------------------------------------------
        async function fetchWithTimeout(resource, options = {}) {
            const { timeout = 15000 } = options; // Timeout por defecto de 15 segundos
            
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(resource, {
                    ...options,
                    signal: controller.signal  
                });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }

        const aiModal = document.getElementById('ai-modal');
        const aiToggle = document.getElementById('ai-toggle');
        const closeAi = document.getElementById('close-ai');
        const sendAi = document.getElementById('send-ai');
        const userInput = document.getElementById('user-input');
        const chatHistory = document.getElementById('chat-history');
        const generateDeepDiveBtn = document.getElementById('generateDeepDiveBtn');
        const deepDiveOutput = document.getElementById('deepDiveOutput');
        const deepDiveLoading = document.getElementById('deepDiveLoading');
        const psychologyScenario = document.getElementById('psychologyScenario');
        const generatePsychologyBtn = document.getElementById('generatePsychologyBtn');
        const psychologyOutput = document.getElementById('psychologyOutput');
        const psychologyLoading = document.getElementById('psychologyLoading');

        const gasEndpoint = "/.netlify/functions/gemini-proxy";

        aiToggle.addEventListener('click', () => aiModal.classList.remove('hidden'));
        closeAi.addEventListener('click', () => aiModal.classList.add('hidden'));

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;
            appendMessage(text, 'user');
            userInput.value = '';
            const loadingId = appendMessage('Analizando mercado...', 'ai', true);

            try {
                const response = await fetchWithTimeout(gasEndpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ prompt: `Eres un mentor experto en Trading Institucional (Smart Money Concepts). Responde brevemente: ${text}` })
                });
                const data = await response.json();
                document.getElementById(loadingId).remove();
                const reply = data.text || data.candidates?.[0]?.content?.parts?.[0]?.text || "Lo siento, hubo un error de conexión.";
                appendMessage(reply, 'ai');
            } catch (error) {
                document.getElementById(loadingId).remove();
                appendMessage(error.name === 'AbortError' ? "Tiempo de espera agotado." : "Error conectando con el mentor.", 'ai');
                console.error(error);
            }
        }
        
        generateDeepDiveBtn.addEventListener('click', async () => {
            deepDiveOutput.classList.add('hidden');
            deepDiveLoading.classList.remove('hidden');
            generateDeepDiveBtn.disabled = true;
            try {
                const response = await fetchWithTimeout(gasEndpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        prompt: "Genera un tema de estudio avanzado y su pregunta guía basándose en el Capítulo 1 sobre Smart Money.",
                        systemInstruction: "Genera UN tema de reflexión ORIGINAL en formato JSON estricto: { \"tema\": \"...\", \"analogia\": \"...\" }",
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const rawData = await response.json();
                const result = JSON.parse(rawData.text || rawData.candidates?.[0]?.content?.parts?.[0]?.text);
                deepDiveOutput.innerHTML = `<p class="font-bold text-lg text-kawn-deep mb-2">${result.tema}</p><p class="text-slate-700">${result.analogia}</p>`;
                deepDiveOutput.classList.remove('hidden');
            } catch (error) {
                deepDiveOutput.innerHTML = `<span class="text-red-700">Error al generar. Inténtalo de nuevo.</span>`;
                deepDiveOutput.classList.remove('hidden');
            } finally {
                deepDiveLoading.classList.add('hidden');
                generateDeepDiveBtn.disabled = false;
            }
        });
        
        generatePsychologyBtn.addEventListener('click', async () => {
            let scenarioText = "";
            switch(psychologyScenario.value) {
                case "euforia_maximo": scenarioText = "Euforia extrema tras nuevo máximo."; break;
                case "panico_soporte": scenarioText = "Pánico cerca de un soporte clave."; break;
                case "rango_aburrido": scenarioText = "Mercado en rango lateral aburrido."; break;
                case "fomo_ruptura": scenarioText = "Ruptura clara, FOMO compradores tardíos."; break;
            }
            
            psychologyOutput.classList.add('hidden');
            psychologyLoading.classList.remove('hidden');
            generatePsychologyBtn.disabled = true;

            try {
                const response = await fetchWithTimeout(gasEndpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ prompt: `Escenario: ${scenarioText}. Describe la estrategia de manipulación del smart money.`, systemInstruction: "Eres un diseñador de trampas de trading institucional. Breve estrategia de manipulación." })
                });
                const data = await response.json();
                const reply = data.text || data.candidates?.[0]?.content?.parts?.[0]?.text || "Error al obtener respuesta.";
                psychologyOutput.innerHTML = `<p class="font-bold text-lg text-kawn-deep mb-2">Estrategia Inversa:</p><p class="text-slate-700">${reply}</p>`;
                psychologyOutput.classList.remove('hidden');
            } catch (error) {
                psychologyOutput.innerHTML = `<span class="text-red-700">Error de conexión.</span>`;
                psychologyOutput.classList.remove('hidden');
            } finally {
                psychologyLoading.classList.add('hidden');
                generatePsychologyBtn.disabled = false;
            }
        });

        function appendMessage(text, sender, isLoading = false) {
            const div = document.createElement('div');
            div.id = `msg-${Date.now()}`;
            div.className = `${sender === 'user' ? 'user-message' : 'ai-message'} chat-message shadow-sm ${isLoading ? 'animate-pulse' : ''}`;
            div.innerText = text;
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return div.id;
        }

        sendAi.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            const toc = document.querySelector('aside');
            toc.classList.toggle('hidden');
            toc.classList.toggle('fixed');
            toc.classList.toggle('inset-0');
            toc.classList.toggle('bg-white');
            toc.classList.toggle('z-40');
            toc.classList.toggle('p-6');
        });

        // ----------------------------------------------------
        // 8. PLOTLY STOP HUNTING SIMULATOR (Robustez Mejorada con Limpieza de Timeouts y Debounce Resize)
        // ----------------------------------------------------
        if (typeof Plotly !== 'undefined') {
            const huntBtn = document.getElementById('startStopHuntBtn');
            const resetBtn = document.getElementById('resetStopHuntBtn');
            const huntStatus = document.getElementById('huntStatus');
            const plotContainer = 'stopHuntChart';
            let simTimeouts = []; // Array para guardar IDs de timeouts

            const x_data = [1, 2, 3, 4, 5, 6, 7, 8];
            const initial_open = [100, 101, 102, 103, 104, 105, 106, 105.5];
            const initial_high = [102, 103, 104, 105, 106, 107, 107, 106];
            const initial_low = [99, 100, 101, 102, 103, 104, 105, 104];
            const initial_close = [101, 102, 103, 104, 105, 106, 105.5, 105];
            const LIQUIDITY_LEVEL = 104.0;
            
            function getInitialTrace() {
                return {
                    x: x_data, open: initial_open, high: initial_high, low: initial_low, close: initial_close,
                    type: 'candlestick', name: 'Precio', increasing: { line: { color: 'green', width: 2.5 }, fillcolor: '#14b8a6' }, decreasing: { line: { color: 'red', width: 2.5 }, fillcolor: '#ef4444' }
                };
            }

            function plotChart(dataTrace) {
                const layout = {
                    dragmode: 'zoom', margin: { r: 10, t: 30, b: 40, l: 40 }, showlegend: false,
                    xaxis: { type: 'category', rangeslider: { visible: false }, showgrid: false, title: 'Barras (Tiempo)' },
                    yaxis: { autorange: true, title: 'Precio ($)', showgrid: true },
                    shapes: [{ type: 'line', xref: 'paper', x0: 0, x1: 1, yref: 'y', y0: LIQUIDITY_LEVEL, y1: LIQUIDITY_LEVEL, line: { color: 'rgb(239, 68, 68)', width: 2, dash: 'dot' } }],
                    annotations: [{ x: 8.5, y: LIQUIDITY_LEVEL, xref: 'x', yref: 'y', text: 'Stops Minoristas', showarrow: true, arrowhead: 0, ax: 0, ay: -40, font: { color: 'rgb(239, 68, 68)', size: 12 }, bgcolor: 'rgba(255, 255, 255, 0.7)', bordercolor: 'rgb(239, 68, 68)', borderwidth: 1, borderpad: 2 }],
                    plot_bgcolor: '#0f172a', paper_bgcolor: '#ffffff'
                };
                Plotly.newPlot(plotContainer, [dataTrace], layout, { responsive: true, displayModeBar: false });
            }

            // Limpiar timeouts activos para evitar solapamiento
            function clearSimulationTimeouts() {
                simTimeouts.forEach(id => clearTimeout(id));
                simTimeouts = [];
            }

            function startSimulation() {
                clearSimulationTimeouts(); // Seguridad extra
                huntBtn.disabled = true;
                resetBtn.disabled = false;
                huntStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-yellow-100 text-yellow-800 border border-yellow-400';
                huntStatus.textContent = 'INICIANDO SIMULACIÓN...';

                const new_x = [...x_data, 9];
                const new_open = [...initial_open, 105]; const new_high = [...initial_high, 105.5]; const new_low = [...initial_low, 103.5]; const new_close = [...initial_close, 104.5];

                simTimeouts.push(setTimeout(() => {
                    const sweep_low = [...new_low.slice(0, 8), 103.5]; 
                    const sweep_close = [...new_close.slice(0, 8), 104.0];
                    const sweep_high = [...new_high.slice(0, 8), 105.5];
                    const sweep_open = [...new_open.slice(0, 8), 105];
                    Plotly.restyle(plotContainer, { x: [new_x], open: [sweep_open], high: [sweep_high], low: [sweep_low], close: [sweep_close] }, [0]);
                    huntStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-red-100 text-red-800 border border-red-400';
                    huntStatus.textContent = 'BARRIDA: Precio empujado a 103.5 activando stops.';
                }, 1500));

                simTimeouts.push(setTimeout(() => {
                    const markup_x = [...new_x, 10]; const markup_open = [...new_open, 104.0]; const markup_high = [...new_high, 106.0]; const markup_low = [...new_low, 103.8]; const markup_close = [...new_close, 105.8];
                    Plotly.restyle(plotContainer, { x: [markup_x], open: [markup_open], high: [markup_high], low: [markup_low], close: [markup_close] }, [0]);
                    huntStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-kawn-light text-kawn-deep border border-kawn-base';
                    huntStatus.textContent = 'REVERSIÓN: Liquidez absorbida, comienza la subida real.';
                }, 3000));

                simTimeouts.push(setTimeout(() => {
                    const cont_x = [...new_x, 10, 11]; const cont_open = [...new_open, 104.0, 105.8]; const cont_high = [...new_high, 106.0, 108.0]; const cont_low = [...new_low, 103.8, 105.5]; const cont_close = [...new_close, 105.8, 107.8];
                    Plotly.restyle(plotContainer, { x: [cont_x], open: [cont_open], high: [cont_high], low: [cont_low], close: [cont_close] }, [0]);
                    huntStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-green-100 text-green-800 border border-green-400';
                    huntStatus.textContent = 'COMPLETADO: Movimiento institucional ejecutado.';
                }, 4500));
            }

            function resetChart() {
                clearSimulationTimeouts();
                plotChart(getInitialTrace());
                huntBtn.disabled = false;
                resetBtn.disabled = true;
                huntStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-slate-50 text-slate-700 border border-slate-200';
                huntStatus.textContent = 'Esperando...';
            }

            document.addEventListener('DOMContentLoaded', () => {
                plotChart(getInitialTrace());
                huntBtn.addEventListener('click', startSimulation);
                resetBtn.addEventListener('click', resetChart);
            });
            
            // Listener para redimensionar gráficos con Debounce para rendimiento
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    Plotly.Plots.resize(document.getElementById(plotContainer));
                }, 100);
            });
        }

        // ----------------------------------------------------
        // 9. LOGICA DEL QUIZ (NUEVO)
        // ----------------------------------------------------
        const correctAnswers = {
            1: 'b',
            2: 'a',
            3: 'b',
            4: 'c'
        };
        let userScore = 0;
        let answeredQuestions = new Set();

        window.checkAnswer = function(qNum, selectedOption, element) {
            // Evitar re-responder
            if (answeredQuestions.has(qNum)) return;
            
            const feedbackEl = document.getElementById(`q${qNum}-feedback`);
            const optionsContainer = document.getElementById(`q${qNum}-options`);
            const correct = correctAnswers[qNum];
            
            // Marcar como respondida
            answeredQuestions.add(qNum);

            // Estilizar opciones
            const allOptions = optionsContainer.children;
            for(let opt of allOptions) {
                opt.style.cursor = 'default';
                // Si es la correcta, la pintamos de verde siempre
                if (opt.getAttribute('onclick').includes(`'${correct}'`)) {
                    opt.classList.add('correct');
                }
            }

            if (selectedOption === correct) {
                userScore++;
                feedbackEl.innerHTML = `<span class="text-green-600 font-bold">¡Correcto!</span> Exacto.`;
            } else {
                element.classList.add('incorrect');
                feedbackEl.innerHTML = `<span class="text-red-500 font-bold">Incorrecto.</span> La respuesta correcta era la opción ${correct.toUpperCase()}.`;
            }
            
            feedbackEl.classList.remove('hidden');
            
            // Actualizar puntuación global
            document.getElementById('quiz-score').textContent = `Puntuación: ${userScore}/4`;
        }
    </script>
</body>
</html>