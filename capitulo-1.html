<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cap√≠tulo 1: El Mercado y el Dinero Inteligente | KawnBit</title>
    
    <!-- Fuentes Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" crossorigin="anonymous"></script>
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js" crossorigin="anonymous"></script>

    <!-- Configuraci√≥n Tailwind KawnBit -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kawn: {
                            light: '#ccfbf1', // Teal 100
                            base: '#14b8a6',  // Teal 500
                            dark: '#0f766e',  // Teal 700
                            deep: '#134e4a',  // Teal 900
                        },
                        slate: {
                            50: '#f8fafc',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                    },
                    boxShadow: {
                        'kawn': '0 4px 20px -2px rgba(20, 184, 166, 0.2)',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos personalizados */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .toc-link.active { color: #14b8a6; border-left-color: #14b8a6; background-color: #f0fdfa; font-weight: 600; }
        
        /* Logo Wave Animation */
        .wave-path { stroke-dasharray: 100; stroke-dashoffset: 100; animation: dash 2s ease-in-out forwards; }
        @keyframes dash { to { stroke-dashoffset: 0; } }

        /* Gradient Text */
        .text-gradient { background: linear-gradient(135deg, #14b8a6 0%, #0f766e 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* AI Loading Animation */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 antialiased font-sans leading-relaxed">

    <!-- Navbar Sticky -->
    <nav class="sticky top-0 z-50 w-full bg-white/90 backdrop-blur-md border-b border-slate-200 shadow-sm transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 relative flex items-center justify-center">
                    <svg viewBox="0 0 100 60" class="w-full h-full fill-none stroke-current text-kawn-base" stroke-width="8" stroke-linecap="round">
                        <path class="wave-path" d="M10,50 Q30,10 50,30 T90,10" style="animation-delay: 0.2s; opacity: 0.6;"/>
                        <path class="wave-path" d="M10,60 Q30,20 50,40 T90,20" style="animation-delay: 0s;"/>
                    </svg>
                </div>
                <div class="flex flex-col">
                    <span class="font-display font-black text-2xl tracking-tight text-slate-800">
                        Kawn<span class="text-gradient">Bit</span>
                    </span>
                    <span class="font-display text-[0.6rem] font-bold tracking-[0.2em] text-slate-500 uppercase">Quantitative Trading Community</span>
                </div>
            </div>
            <div class="hidden md:flex items-center gap-4 text-sm font-medium text-slate-500">
                <span>Cap√≠tulo 1</span>
                <div class="w-32 h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div id="readingProgress" class="h-full bg-kawn-base w-0 transition-all duration-300"></div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto flex flex-col lg:flex-row min-h-screen">
        
        <!-- Sidebar TOC (Desktop) -->
        <aside class="hidden lg:block w-64 xl:w-72 flex-shrink-0 relative">
            <div class="sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto pr-4 py-4">
                <h3 class="font-display font-bold text-slate-900 mb-4 px-4 uppercase text-xs tracking-wider">Tabla de Contenidos</h3>
                <nav id="toc-container" class="space-y-1">
                    <!-- Contenido generado din√°micamente -->
                </nav>
            </div>
        </aside>

        <!-- Contenido Principal -->
        <main class="flex-1 w-full max-w-4xl mx-auto px-4 sm:px-6 py-12 lg:px-12" id="chapter-content">
            
            <!-- Hero Section -->
            <header class="mb-16 text-center lg:text-left">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-kawn-light text-kawn-dark text-xs font-bold uppercase tracking-wider mb-6">M√≥dulo 1: Fundamentos</div>
                <h1 class="font-display font-black text-4xl sm:text-5xl lg:text-6xl text-slate-900 mb-6 leading-tight">El Mercado y el <br><span class="text-gradient">Dinero Inteligente</span></h1>
                <p class="text-xl text-slate-600 max-w-2xl font-light">Descubre qui√©n mueve realmente los hilos del mercado financiero y cambia tu mentalidad de "presa" a "depredador oportunista".</p>
            </header>

            <!-- CONTENIDO DEL CAP√çTULO -->
            
            <section id="introduccion" class="mb-16">
                <h2 class="font-display font-bold text-2xl text-slate-800 mb-6 flex items-center"><span class="w-8 h-1 bg-kawn-base mr-3 rounded-full"></span>Introducci√≥n: Cambiando tu perspectiva</h2>
                <div class="prose prose-lg prose-slate max-w-none text-slate-600">
                    <p class="mb-6">Imag√≠nate que est√°s jugando al p√≥ker en una mesa con desconocidos. Existe una regla no escrita que dice: <span class="font-bold text-slate-800">‚ÄúSi despu√©s de media hora no identificaste qui√©n es el pez en la mesa, entonces el pez eres t√∫‚Äù</span>.</p>
                    <div class="bg-white border-l-4 border-kawn-base p-6 shadow-kawn rounded-r-xl my-8">
                        <p class="italic text-slate-700 font-medium text-lg">"Muchos creen que los mercados financieros son un campo de juego nivelado, pero la verdad es otra. En este cap√≠tulo exploraremos una perspectiva totalmente nueva del mercado, esencial para tu evoluci√≥n como trader."</p>
                    </div>
                </div>
            </section>

            <section id="nueva-realidad" class="mb-16">
                <h2 class="font-display font-bold text-2xl text-slate-800 mb-6 flex items-center"><span class="w-8 h-1 bg-kawn-base mr-3 rounded-full"></span>La nueva realidad: Las m√°quinas mandan</h2>
                <div class="prose prose-lg prose-slate max-w-none text-slate-600 mb-8">
                    <p class="mb-4">Bienvenido al siglo XXI de los mercados. El mercado ‚Äúcl√°sico‚Äù representa <span class="text-red-500 font-bold">menos del 30%</span> del volumen total. La mayor parte proviene de algoritmos y trading de alta frecuencia (HFT).</p>
                    <p>Mientras tu ojo parpadea en 300 milisegundos, un algoritmo HFT puede lanzar m√°s de 10.000 operaciones. Est√°n f√≠sicamente ubicados lo m√°s cerca posible de los servidores de las bolsas (colocation) para ganar microsegundos.</p>
                </div>

                <!-- COMPONENTE INTERACTIVO 1: Visualizador de Volumen -->
                <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 md:p-8 mb-10">
                    <div class="flex flex-col md:flex-row items-center gap-8">
                        <div class="w-full md:w-1/2">
                            <h3 class="font-display font-bold text-lg text-slate-800 mb-2">Dominio del Mercado</h3>
                            <p class="text-sm text-slate-500 mb-6">Comparativa de volumen estimado en mercados modernos (Acciones/Forex).</p>
                            <!-- Contenedor con altura expl√≠cita para evitar saltos y errores de renderizado -->
                            <div class="relative h-64 w-full">
                                <canvas id="volumeChart"></canvas>
                            </div>
                        </div>
                        <div class="w-full md:w-1/2 space-y-4">
                            <div class="p-4 bg-kawn-light/30 rounded-lg border border-kawn-light">
                                <h4 class="font-bold text-kawn-dark mb-1">Trading de Alta Frecuencia (HFT)</h4>
                                <p class="text-sm text-slate-600">M√°s del 70% del volumen. Algoritmos que no duermen, no sienten y operan a la velocidad de la luz.</p>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
                                <h4 class="font-bold text-slate-700 mb-1">Humanos / Retail</h4>
                                <p class="text-sm text-slate-500">Menos del 30%. Operan con retraso, emociones y herramientas b√°sicas.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="industria-retail" class="mb-16">
                <h2 class="font-display font-bold text-2xl text-slate-800 mb-6 flex items-center"><span class="w-8 h-1 bg-kawn-base mr-3 rounded-full"></span>La industria retail: Dise√±ada para el fracaso</h2>
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-slate-800 text-white p-6 rounded-xl shadow-lg transform hover:-translate-y-1 transition-transform">
                        <div class="text-kawn-base text-4xl font-black font-display mb-2">90%</div>
                        <h4 class="font-bold text-lg mb-2">Tasa de P√©rdida</h4>
                        <p class="text-slate-300 text-sm">Estudios muestran que entre el 75% y el 90% de los traders minoristas pierden dinero consistentemente.</p>
                    </div>
                    <div class="bg-white border border-slate-200 p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                        <div class="text-red-500 text-4xl font-black font-display mb-2">1-2%</div>
                        <h4 class="font-bold text-slate-800 text-lg mb-2">Rentabilidad Neta</h4>
                        <p class="text-slate-500 text-sm">Solo un porcentaje min√∫sculo de day traders obtiene ganancias netas sostenidas a largo plazo.</p>
                    </div>
                </div>
                <div class="prose prose-lg prose-slate max-w-none text-slate-600">
                    <p>La industria te vende "soluciones m√°gicas": indicadores "revolucionarios", robots autom√°ticos y cursos de gur√∫s. Si todas estas herramientas funcionaran, ¬øpor qu√© las estad√≠sticas de fracaso siguen igual?</p>
                </div>
            </section>

            <!-- SECCI√ìN IA: DECODIFICADOR DE NOTICIAS -->
            <section id="decodificador-ia" class="mb-16">
                <div class="bg-gradient-to-r from-slate-900 to-kawn-deep p-1 rounded-2xl shadow-xl">
                    <div class="bg-white rounded-xl p-8">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="bg-kawn-light p-2 rounded-lg text-2xl">üì∞</span>
                            <h2 class="font-display font-bold text-2xl text-slate-800">Decodificador de Noticias Institucional ‚ú®</h2>
                        </div>
                        <p class="text-slate-600 mb-6">Los medios de comunicaci√≥n son herramientas de liquidez para el Smart Money. Pega un titular reciente y nuestra IA analizar√° si es una posible trampa de "Distribuci√≥n" o "Acumulaci√≥n".</p>
                        
                        <div class="flex flex-col md:flex-row gap-4 mb-6">
                            <input type="text" id="news-input" class="flex-1 border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-kawn-base outline-none text-slate-700" placeholder="Ej: 'Expertos dicen que Bitcoin llegar√° a $1M esta semana'...">
                            <button onclick="analyzeNews()" class="bg-kawn-base hover:bg-kawn-dark text-white font-bold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2 shadow-lg hover:shadow-kawn">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M13 5a3 3 0 11-6 0 3 3 0 016 0zm-9 8a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1v-2z" clip-rule="evenodd" /></svg>
                                Decodificar
                            </button>
                        </div>
                        
                        <div id="news-result" class="hidden animate-fade-in bg-slate-50 border-l-4 border-kawn-base p-6 rounded-r-lg"></div>
                    </div>
                </div>
            </section>

            <section id="smart-money-quienes" class="mb-16">
                <h2 class="font-display font-bold text-2xl text-slate-800 mb-6 flex items-center"><span class="w-8 h-1 bg-kawn-base mr-3 rounded-full"></span>¬øQui√©n es el Smart Money?</h2>
                <div class="grid gap-6 md:grid-cols-2">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:border-kawn-base/50 transition-colors">
                        <h3 class="font-display font-bold text-kawn-dark text-lg mb-2">Bancos Centrales</h3>
                        <p class="text-sm text-slate-600">Controlan la pol√≠tica monetaria y pueden inyectar liquidez ilimitada. "No luches contra la Fed".</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:border-kawn-base/50 transition-colors">
                        <h3 class="font-display font-bold text-kawn-dark text-lg mb-2">Grandes Bancos</h3>
                        <p class="text-sm text-slate-600">Goldman Sachs, JP Morgan. Ven el flujo de √≥rdenes y act√∫an como creadores de mercado.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:border-kawn-base/50 transition-colors">
                        <h3 class="font-display font-bold text-kawn-dark text-lg mb-2">Hedge Funds</h3>
                        <p class="text-sm text-slate-600">Equipos de analistas y cient√≠ficos de datos con capital para aguantar y "doblar" el mercado.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:border-kawn-base/50 transition-colors">
                        <h3 class="font-display font-bold text-kawn-dark text-lg mb-2">Market Makers</h3>
                        <p class="text-sm text-slate-600">Proveen liquidez y capturan el spread. Conocen d√≥nde est√°n los stops de los minoristas.</p>
                    </div>
                </div>
            </section>

            <section id="como-operan" class="mb-16">
                <h2 class="font-display font-bold text-2xl text-slate-800 mb-6 flex items-center"><span class="w-8 h-1 bg-kawn-base mr-3 rounded-full"></span>¬øC√≥mo opera el Smart Money?</h2>
                <!-- COMPONENTE INTERACTIVO 2: Comparador de Mentalidad -->
                <div class="bg-slate-900 rounded-2xl p-1 shadow-xl mb-10">
                    <div class="bg-slate-800 rounded-t-xl p-4 border-b border-slate-700 flex justify-between items-center">
                        <h3 class="text-white font-display font-bold">Mentalidad Operativa</h3>
                        <div class="flex space-x-2 bg-slate-900 rounded-lg p-1">
                            <button onclick="switchComparator('retail')" id="btn-retail" class="px-4 py-1 rounded text-sm font-medium transition-all bg-slate-700 text-slate-300 hover:text-white">Retail</button>
                            <button onclick="switchComparator('smart')" id="btn-smart" class="px-4 py-1 rounded text-sm font-medium transition-all bg-kawn-base text-white shadow-lg">Smart Money</button>
                        </div>
                    </div>
                    <div class="p-8">
                        <div id="comparator-content" class="transition-opacity duration-300"></div>
                    </div>
                </div>
            </section>

            <!-- NUEVA SECCI√ìN IA: GENERADOR DE ANALOG√çAS -->
            <section id="generador-analogias" class="mb-16">
                <div class="border-2 border-kawn-light bg-slate-50 p-8 rounded-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10"><svg class="w-32 h-32 text-kawn-base" fill="currentColor" viewBox="0 0 20 20"><path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.34.208-.646.477-.859a4 4 0 10-4.954 0c.27.213.462.519.476.859h4.002z"/></svg></div>
                    <h2 class="font-display font-bold text-2xl text-slate-800 mb-2 relative z-10">Generador de Analog√≠as ‚ú®</h2>
                    <p class="text-slate-600 mb-6 relative z-10">¬øUn concepto es muy complejo? Pide a la IA que te lo explique con una analog√≠a simple de la vida cotidiana.</p>
                    
                    <div class="flex flex-col gap-4 relative z-10">
                        <div class="flex gap-2">
                            <select id="analogy-topic" class="p-3 rounded-lg border border-slate-300 bg-white flex-1 focus:ring-2 focus:ring-kawn-base outline-none text-slate-700">
                                <option value="Liquidity Pool">Piscina de Liquidez</option>
                                <option value="Stop Hunt">Caza de Stops</option>
                                <option value="Order Block">Order Block</option>
                                <option value="Market Maker">Creador de Mercado</option>
                                <option value="Acumulaci√≥n">Fase de Acumulaci√≥n</option>
                            </select>
                            <button onclick="generateAnalogy()" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-md">
                                Generar
                            </button>
                        </div>
                        <div id="analogy-result" class="hidden bg-white p-6 rounded-lg border-l-4 border-yellow-400 shadow-sm animate-fade-in text-slate-700 italic"></div>
                    </div>
                </div>
            </section>

            <section id="stop-hunting" class="mb-16">
                <h2 class="font-display font-bold text-2xl text-slate-800 mb-6 flex items-center"><span class="w-8 h-1 bg-kawn-base mr-3 rounded-full"></span>La Ingenier√≠a de los Stop-Loss</h2>
                <div class="prose prose-lg prose-slate max-w-none text-slate-600 mb-6">
                    <p>El "Stop Hunting" consiste en forzar el precio a pasar por niveles donde se concentran los stops de los minoristas para obtener liquidez. Si pones tu stop bajo un soporte obvio, est√°s poniendo un blanco en tu espalda.</p>
                </div>
                <!-- COMPONENTE INTERACTIVO 3: Simulador Stop Hunt -->
                <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden mb-10">
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                        <div>
                            <h3 class="font-display font-bold text-lg text-slate-800">Simulador de Mercado</h3>
                            <p class="text-xs text-slate-500">Observa la mec√°nica de una trampa de liquidez.</p>
                        </div>
                        <button onclick="triggerStopHunt()" id="hunt-btn" class="bg-rose-500 hover:bg-rose-600 text-white px-5 py-2 rounded-lg font-bold text-sm shadow-md transition-all active:scale-95 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg> Ejecutar Stop Hunt
                        </button>
                    </div>
                    <div id="chart-container" class="w-full h-80 bg-white"></div>
                    <div class="p-4 bg-yellow-50 text-yellow-800 text-sm border-t border-yellow-100 flex gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                        <p id="sim-feedback">El mercado est√° en rango. Los traders minoristas colocan stops debajo del soporte ($100). Esperando acci√≥n...</p>
                    </div>
                </div>
            </section>

            <section id="nueva-mentalidad" class="mb-16">
                <h2 class="font-display font-bold text-2xl text-slate-800 mb-6 flex items-center"><span class="w-8 h-1 bg-kawn-base mr-3 rounded-full"></span>Tu Nueva Mentalidad</h2>
                <div class="bg-kawn-light/30 border border-kawn-base rounded-xl p-8 mb-8">
                    <ul class="space-y-4">
                        <li class="flex items-start"><span class="bg-kawn-base text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-1 text-xs font-bold">1</span><span class="text-slate-700"><strong>De Predicador a Seguidor:</strong> Deja de adivinar. S√© un detective que busca huellas del Smart Money.</span></li>
                        <li class="flex items-start"><span class="bg-kawn-base text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-1 text-xs font-bold">2</span><span class="text-slate-700"><strong>De Competidor a Par√°sito:</strong> No compitas con el tibur√≥n. S√© la r√©mora que se alimenta de las sobras.</span></li>
                    </ul>
                </div>
            </section>

            <!-- NUEVA SECCI√ìN IA: ESPEJO PSICOL√ìGICO -->
            <section id="analisis-psicologico" class="mb-16">
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="bg-slate-800 p-6 flex justify-between items-center">
                        <h2 class="font-display font-bold text-xl text-white flex items-center gap-2">
                            üß† El Espejo Psicol√≥gico ‚ú®
                        </h2>
                        <span class="bg-kawn-base text-white text-xs px-2 py-1 rounded font-bold">IA Powered</span>
                    </div>
                    <div class="p-8">
                        <p class="text-slate-600 mb-4">Escribe c√≥mo te sentiste en tu √∫ltima operaci√≥n perdedora (miedo, euforia, ganas de recuperar). La IA analizar√° si operaste con mentalidad "Retail" o "Institucional" y te dar√° consejos.</p>
                        <textarea id="psycho-input" class="w-full p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-kawn-base focus:border-transparent outline-none text-slate-700 mb-4" rows="3" placeholder="Ej: Me sent√≠ frustrado porque el precio toc√≥ mi stop y luego subi√≥ sin m√≠. Quise entrar de nuevo inmediatamente..."></textarea>
                        <button onclick="analyzePsychology()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-lg transition-colors">
                            Analizar mi Mentalidad
                        </button>
                        <div id="psycho-result" class="hidden mt-6 p-6 bg-slate-50 rounded-lg border border-slate-200 animate-fade-in"></div>
                    </div>
                </div>
            </section>

            <section id="glosario" class="mb-16">
                <h2 class="font-display font-bold text-2xl text-slate-800 mb-6 flex items-center"><span class="w-8 h-1 bg-kawn-base mr-3 rounded-full"></span>Glosario Esencial</h2>
                <div class="space-y-2" id="glossary-container"></div>
            </section>

            <!-- SECCI√ìN IA: QUIZ -->
            <section id="quiz-ia" class="mb-16">
                <div class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center bg-slate-50">
                    <h2 class="font-display font-bold text-2xl text-slate-800 mb-2">Quiz de Validaci√≥n ‚ú®</h2>
                    <p class="text-slate-500 mb-6 max-w-lg mx-auto">Pon a prueba lo que acabas de leer. Generaremos 3 preguntas √∫nicas usando IA basadas en el contenido.</p>
                    <button onclick="generateQuiz()" id="btn-quiz" class="bg-white border-2 border-kawn-base text-kawn-base hover:bg-kawn-base hover:text-white font-bold py-3 px-8 rounded-full transition-all shadow-md transform hover:-translate-y-1">Generar Quiz Ahora</button>
                    <div id="quiz-container" class="mt-8 text-left hidden space-y-6"></div>
                </div>
            </section>

            <!-- SECCI√ìN IA: MENTOR CHAT -->
            <section id="mentor-ai" class="mb-20">
                <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl p-8 text-white shadow-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-kawn-base opacity-10 rounded-full blur-3xl transform translate-x-1/2 -translate-y-1/2"></div>
                    <div class="relative z-10">
                        <h2 class="font-display font-bold text-2xl mb-2 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-kawn-base" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg> Mentor Virtual KawnBit ‚ú®</h2>
                        <p class="text-slate-400 mb-6 text-sm">IA Contextual: He le√≠do todo el cap√≠tulo y puedo responder tus dudas.</p>
                        <div id="chat-history" class="bg-slate-900/50 rounded-lg p-4 h-48 overflow-y-auto mb-4 border border-slate-700 text-sm space-y-3">
                            <div class="flex gap-3">
                                <div class="w-6 h-6 rounded-full bg-kawn-base flex items-center justify-center text-xs font-bold">AI</div>
                                <div class="bg-slate-800 p-2 rounded-lg rounded-tl-none text-slate-300">Hola, soy tu mentor. Conozco el concepto de acumulaci√≥n, distribuci√≥n y stop hunting. ¬øQu√© duda tienes?</div>
                            </div>
                        </div>
                        <form id="ai-form" class="flex gap-2">
                            <input type="text" id="ai-input" class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-kawn-base placeholder-slate-500" placeholder="Ej: ¬øPor qu√© las noticias buenas suelen indicar distribuci√≥n?">
                            <button type="submit" class="bg-kawn-base hover:bg-kawn-dark text-white px-6 py-2 rounded-lg font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Enviar</button>
                        </form>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <footer class="bg-slate-900 text-slate-400 py-12 border-t border-slate-800">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <div class="flex items-center justify-center gap-2 mb-4">
                <span class="font-display font-black text-2xl tracking-tight text-white">Kawn<span class="text-kawn-base">Bit</span></span>
            </div>
            <p class="text-sm mb-6">Quantitative Trading Community - Material Educativo Exclusivo</p>
            <p class="text-xs text-slate-600">¬© 2023 KawnBit. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- SCRIPTS DE FUNCIONALIDAD -->
    <script>
        // --- 0. CONFIGURACI√ìN GEMINI API (SIMULACI√ìN SEGURA) ---
        // Nota: Para usar una API real, descomenta el fetch y elimina el modo fallback.
        /*
         * Removed reference to a Netlify function endpoint. The site is deployed
         * statically and does not include serverless functions, so there is no
         * gemini-proxy endpoint available. The original simulation will be used
         * instead.
         */
        
        const getChapterContext = () => {
            const el = document.getElementById('chapter-content');
            return el ? el.innerText.substring(0, 10000) : "";
        };

        // Funci√≥n Gen√©rica para Llamar a la IA (MODO SIMULACI√ìN NATIVO)
        async function callGeminiAPI(userPrompt, systemInstruction) {
            
            // SIMULACI√ìN DE RETARDO DE RED (UX)
            await new Promise(r => setTimeout(r, 1200));

            const p = userPrompt ? userPrompt.toLowerCase() : "";
            
            // 1. Decodificador de Noticias
            if (p.includes("analiza este titular")) {
                if (p.includes("record") || p.includes("m√°ximo") || p.includes("sube") || p.includes("mill√≥n") || p.includes("luna")) {
                    return "ANALISIS: **Posible Trampa de Distribuci√≥n (Venta)**. \n\nRAZ√ìN: Las noticias extremadamente positivas y euf√≥ricas suelen ser fabricadas o amplificadas para atraer compradores 'retail' tard√≠os (FOMO), permitiendo a las instituciones vender sus posiciones acumuladas anteriormente a precios altos.\n\nACCI√ìN: Precauci√≥n. Esperar confirmaci√≥n de cambio de estructura.";
                } else {
                     return "ANALISIS: **Posible Fase de Acumulaci√≥n (Compra)**. \n\nRAZ√ìN: Las noticias negativas o de miedo ('crash', 'p√©rdidas', 'regulaci√≥n') suelen usarse para inducir p√°nico en el retail y que vendan barato. El Smart Money aprovecha para comprar (acumular) a precios de descuento.\n\nACCI√ìN: Buscar patrones de giro alcista.";
                }
            }
            // 2. Quiz Generator
            else if (p.includes("genera quiz")) {
                // Devolvemos el objeto directamente
                return [
                    {q: "¬øCu√°l es el objetivo principal del Smart Money en la fase de Acumulaci√≥n?", options: ["Subir el precio r√°pidamente", "Comprar grandes cantidades sin subir el precio", "Vender todas sus posiciones", "Crear noticias falsas en Twitter"], a: 1},
                    {q: "¬øQu√© porcentaje aproximado del volumen actual es HFT/Algor√≠tmico?", options: ["Menos del 30%", "50%", "M√°s del 60-70%", "10%"], a: 2},
                    {q: "¬øD√≥nde suelen colocar los Stop Loss los traders retail (la masa)?", options: ["En medio de la vela", "Justo debajo de soportes obvios", "No usan stops", "Aleatoriamente"], a: 1}
                ];
            }
            // 3. Generador de Analog√≠as
            else if (p.includes("analog√≠a")) {
                if (p.includes("liquidity") || p.includes("piscina")) return "Imagina una **Piscina de Liquidez** como una gasolinera en el desierto. El 'Smart Money' es un cami√≥n gigante que necesita much√≠simo combustible (√≥rdenes) para moverse. No puede llenar el tanque en cualquier lado; necesita ir a donde hay mucho combustible acumulado (tus Stop Loss) para poder seguir su viaje sin detenerse.";
                if (p.includes("stop hunt") || p.includes("caza")) return "El **Stop Hunt** es como sacudir un √°rbol de manzanas. El Smart Money sacude el √°rbol (mueve el precio bruscamente) para que caigan las manzanas flojas (manos d√©biles/stops). Una vez que est√°n en el suelo, ellos las recogen todas baratas.";
                if (p.includes("order block")) return "Un **Order Block** es como la huella de un gigante en la arena. Nos muestra d√≥nde pis√≥ fuerte el institucional antes de saltar. Sabemos que es probable que vuelva a poner el pie ah√≠ para impulsarse de nuevo.";
                return "Es como jugar al p√≥ker viendo las cartas de los dem√°s en un espejo. El Smart Money tiene esa ventaja de informaci√≥n.";
            }
            // 4. Espejo Psicol√≥gico
            else if (p.includes("analiza esta reflexi√≥n")) {
                if (p.includes("miedo") || p.includes("p√°nico")) {
                    return "üß† **Diagn√≥stico: Par√°lisis por Miedo**\n\nEl miedo te impidi√≥ actuar. El Smart Money huele este miedo para acumular.\n\nüí° **Consejo:** Si tu an√°lisis t√©cnico es bueno, conf√≠a en √©l. Usa un riesgo bajo para perder el miedo a la entrada.";
                } else if (p.includes("venganza") || p.includes("recuperar")) {
                    return "üß† **Diagn√≥stico: Trading de Venganza (Peligroso)**\n\nEst√°s operando desde el dolor del ego, no desde la l√≥gica.\n\nüí° **Consejo:** Cierra las pantallas. El mercado no te debe nada. Volver a entrar ahora es regalar tu dinero al institucional.";
                }
                return "üß† **Diagn√≥stico: Mentalidad Retail Reactiva**\n\nEst√°s reaccionando al precio en lugar de anticipar la zona.\n\nüí° **Consejo:** Define tu plan ANTES de que abra el mercado y ejec√∫talo como un robot.";
            }
            // 5. Chat General
            else {
                return "Como Mentor KawnBit, te recuerdo: El mercado es un mecanismo de transferencia de riqueza del impaciente al paciente. ¬øNecesitas aclarar conceptos sobre Liquidez o Estructura?";
            }
        }

        // --- FUNCIONALIDADES IA ---

        // A. Decodificador de Noticias
        async function analyzeNews() {
            const input = document.getElementById('news-input').value;
            const resultDiv = document.getElementById('news-result');
            if (!input) return;
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<div class="flex items-center gap-2 text-slate-500"><div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div> Analizando sentimiento institucional...</div>';
            
            const response = await callGeminiAPI(`Analiza este titular: "${input}"`);
            if (typeof response === 'string') {
                resultDiv.innerHTML = `<h4 class="font-bold text-kawn-dark mb-2">An√°lisis de IA:</h4><p class="text-slate-700 text-sm leading-relaxed">${response.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}</p>`;
            } else {
                resultDiv.innerHTML = `<p class="text-slate-700 text-sm">Error en el an√°lisis.</p>`;
            }
        }

        // B. Generador de Quiz (ROBUSTECIDO)
        async function generateQuiz() {
            const btn = document.getElementById('btn-quiz');
            const container = document.getElementById('quiz-container');
            btn.disabled = true; btn.innerHTML = `Generando preguntas... <span class="typing-dot inline-block">.</span>`;
            
            const response = await callGeminiAPI("Genera quiz del texto");
            
            // Verificaci√≥n de seguridad
            if (!Array.isArray(response)) {
                console.warn("Respuesta de quiz inv√°lida", response);
                btn.innerText = "Error - Reintentar";
                btn.disabled = false;
                return;
            }
            const questions = response;

            container.classList.remove('hidden'); container.innerHTML = '';
            questions.forEach((q, idx) => {
                const qDiv = document.createElement('div');
                qDiv.className = "bg-white p-6 rounded-lg shadow-sm border border-slate-200";
                qDiv.innerHTML = `<p class="font-bold text-slate-800 mb-4">${idx + 1}. ${q.q}</p><div class="space-y-2">${q.options.map((opt, optIdx) => `<button onclick="checkAnswer(this, ${optIdx === q.a})" class="w-full text-left px-4 py-2 rounded border border-slate-200 hover:bg-slate-50 transition-colors text-sm text-slate-600">${opt}</button>`).join('')}</div><div class="mt-3 hidden feedback text-sm font-bold"></div>`;
                container.appendChild(qDiv);
            });
            btn.innerHTML = "Generar Nuevas Preguntas ‚ú®"; btn.disabled = false;
        }

        function checkAnswer(btn, isCorrect) {
            const feedback = btn.parentElement.nextElementSibling;
            Array.from(btn.parentElement.children).forEach(b => { b.disabled = true; b.classList.add('opacity-50'); });
            btn.classList.remove('opacity-50');
            if (isCorrect) { btn.classList.add('bg-kawn-light', 'border-kawn-base', 'text-kawn-dark'); feedback.textContent = "¬°Correcto! Entiendes la l√≥gica institucional."; feedback.className = "mt-3 feedback text-sm font-bold text-kawn-base animate-pulse"; } 
            else { btn.classList.add('bg-red-50', 'border-red-200', 'text-red-600'); feedback.textContent = "Incorrecto. Repasa la secci√≥n."; feedback.className = "mt-3 feedback text-sm font-bold text-red-500"; }
            feedback.classList.remove('hidden');
        }

        // C. Generador de Analog√≠as
        async function generateAnalogy() {
            const topic = document.getElementById('analogy-topic').value;
            const resultDiv = document.getElementById('analogy-result');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<div class="flex items-center gap-2 text-slate-500"><div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div> Creando analog√≠a...</div>';
            
            const response = await callGeminiAPI(`Genera una analog√≠a simple para el concepto de trading: "${topic}"`);
            if (typeof response === 'string') {
                resultDiv.innerHTML = `<strong class="block text-slate-900 not-italic mb-2">Analog√≠a para ${topic}:</strong>${response.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}`;
            }
        }

        // D. Espejo Psicol√≥gico
        async function analyzePsychology() {
            const input = document.getElementById('psycho-input').value;
            const resultDiv = document.getElementById('psycho-result');
            if (!input) return;
            
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<div class="flex items-center gap-2 text-slate-500"><div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div> Analizando sesgos cognitivos...</div>';
            
            const response = await callGeminiAPI(`Analiza esta reflexi√≥n: "${input}"`);
            if (typeof response === 'string') {
                resultDiv.innerHTML = response.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            }
        }

        // E. Mentor Chat
        const aiForm = document.getElementById('ai-form');
        aiForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('ai-input');
            const prompt = input.value.trim();
            if (!prompt) return;
            addMessage('User', prompt);
            input.value = '';
            const loadingId = addMessage('AI', '', true);
            const response = await callGeminiAPI(prompt, `Contexto: ${getChapterContext()}`);
            updateMessage(loadingId, response);
        });

        function addMessage(sender, text, isLoading = false) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = 'flex gap-3 animate-fade-in';
            const isAI = sender === 'AI';
            div.innerHTML = `<div class="w-6 h-6 rounded-full ${isAI ? 'bg-kawn-base' : 'bg-slate-600'} flex-shrink-0 flex items-center justify-center text-xs font-bold text-white">${isAI ? 'AI' : 'T√ö'}</div><div class="${isAI ? 'bg-slate-800 text-slate-300' : 'bg-kawn-deep text-white'} p-2 rounded-lg ${isAI ? 'rounded-tl-none' : 'rounded-tr-none'} text-sm leading-relaxed max-w-[85%]">${isLoading ? '<div class="flex gap-1 items-center h-6"><div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div><div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div><div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div></div>' : text}</div>`;
            history.appendChild(div); history.scrollTop = history.scrollHeight;
            return div;
        }
        function updateMessage(el, text) { 
            const msgDiv = el.querySelector('div:last-child');
            if (msgDiv) msgDiv.innerText = text; 
        }


        // --- INICIALIZACI√ìN SEGURA DE LIBRER√çAS (WINDOW LOAD) ---
        // Se ejecuta solo cuando todo el DOM y scripts externos han cargado.
        window.addEventListener('load', function() {
            console.log("KawnBit App Loaded");

            // 1. CHART.JS: VOLUMEN
            try {
                const ctx = document.getElementById('volumeChart');
                if (ctx && typeof Chart !== 'undefined') {
                    new Chart(ctx.getContext('2d'), { 
                        type: 'doughnut', 
                        data: { labels: ['HFT / Algoritmos', 'Retail Humans'], datasets: [{ data: [75, 25], backgroundColor: ['#14b8a6', '#94a3b8'], borderWidth: 0 }] }, 
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '70%' } 
                    });
                }
            } catch (e) { console.warn("Chart.js failed to load", e); }

            // 2. PLOTLY: SIMULADOR
            try {
                if (typeof Plotly !== 'undefined') {
                    let candleData = { 
                        x: [1, 2, 3, 4, 5], 
                        open: [100, 101, 102, 100, 100], 
                        high: [102, 103, 103, 101, 100], 
                        low: [99, 100, 100, 99, 100], 
                        close: [101, 102, 100, 100, 100], 
                        type: 'candlestick', 
                        increasing: {line: {color: '#14b8a6'}}, 
                        decreasing: {line: {color: '#ef4444'}} 
                    };
                    
                    const layout = { 
                        dragmode: false, 
                        showlegend: false,
                        font: { family: 'Inter, sans-serif' }, // Fix global font missing error
                        xaxis: { visible: false, rangeslider: { visible: false } }, 
                        yaxis: { visible: true, gridcolor: '#f1f5f9', fixedrange: true }, 
                        margin: { t: 20, b: 20, l: 40, r: 20 }, 
                        shapes: [{
                            type: 'line', 
                            x0: 0.5, y0: 98, x1: 5.5, y1: 98, 
                            xref: 'x', yref: 'y',
                            line: { color: 'rgb(50,50,50)', width: 2, dash: 'dot' }
                        }],
                        annotations: [{ 
                            x: 3, y: 98, 
                            xref: 'x', yref: 'y', 
                            text: 'Nivel de Soporte / Stop Loss', 
                            showarrow: true, 
                            arrowhead: 2, 
                            ax: 0, ay: -30,
                            font: { color: '#64748b', size: 10 } 
                        }]
                    };
                    
                    Plotly.newPlot('chart-container', [candleData], layout, {
                        staticPlot: false, 
                        displayModeBar: false,
                        responsive: true
                    });
                }
            } catch (e) { console.warn("Plotly failed to load", e); }

            // 3. COMPARADOR INTERACTIVO
            switchComparator('smart');

            // 4. TOC DIN√ÅMICO
            const toc = document.getElementById('toc-container');
            document.querySelectorAll('main section[id]').forEach(sec => {
                const h2 = sec.querySelector('h2'); if(!h2) return;
                const a = document.createElement('a'); a.href = `#${sec.id}`; a.className = 'toc-link block py-2 px-4 text-sm text-slate-500 hover:text-slate-800 border-l-2 border-transparent transition-all truncate'; a.textContent = h2.innerText.replace('‚óè', '').trim();
                a.onclick = (e) => { e.preventDefault(); sec.scrollIntoView({behavior:'smooth'}); }; toc.appendChild(a);
            });
            const obs = new IntersectionObserver(ents => ents.forEach(e => { if(e.isIntersecting) { document.querySelectorAll('.toc-link').forEach(l => { l.classList.remove('active'); if(l.getAttribute('href')===`#${e.target.id}`) l.classList.add('active'); }); updateProgress(); } }), {threshold:0.2, rootMargin:"-20% 0px -50% 0px"});
            document.querySelectorAll('main section[id]').forEach(s => obs.observe(s));
            
            // 5. GLOSARIO
            const glossaryItems = [{t:"Smart Money",d:"Instituciones que mueven el mercado."},{t:"Liquidez",d:"Zonas con √≥rdenes pendientes (Stops)."},{t:"Stop Hunt",d:"Barrido de stops para capturar liquidez."}];
            const gCont = document.getElementById('glossary-container');
            glossaryItems.forEach((i,x) => { gCont.innerHTML += `<div class="border border-slate-200 rounded-lg overflow-hidden"><button class="w-full text-left px-6 py-4 bg-white hover:bg-slate-50 flex justify-between font-bold text-slate-700" onclick="document.getElementById('def-${x}').classList.toggle('hidden')">${i.t} <span>+</span></button><div id="def-${x}" class="hidden bg-slate-50 px-6 py-4 text-slate-600 text-sm border-t border-slate-100">${i.d}</div></div>`; });
        });

        // FUNCIONES AUXILIARES GLOBALES
        // Se ejecuta en scroll solo si el elemento existe
        window.onscroll = updateProgress;
        function updateProgress() { 
            const bar = document.getElementById("readingProgress");
            if(bar) {
                bar.style.width = ((document.documentElement.scrollTop / (document.documentElement.scrollHeight - document.documentElement.clientHeight)) * 100) + "%"; 
            }
        }
        
        const comparatorData = { retail: { title: "Retail (Masa)", desc: "Predice y reacciona.", points: ["üìâ Minutos", "üò∞ FOMO", "üîç Soportes Obvios", "üé≤ Apuesta"], color: "text-slate-400" }, smart: { title: "Smart Money", desc: "Crea y planifica.", points: ["üìà Semanas", "ü§ñ Ingenier√≠a", "üèóÔ∏è Trampas", "üíº Negocio"], color: "text-kawn-base" } };
        function switchComparator(t) { const c = document.getElementById('comparator-content'); const d = comparatorData[t]; c.innerHTML = `<div class="text-center mb-6"><h4 class="text-2xl font-bold ${d.color} mb-2">${d.title}</h4><p class="text-slate-400">${d.desc}</p></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${d.points.map(p => `<div class="bg-slate-900/50 p-3 rounded border border-slate-700 flex items-center text-slate-300">${p}</div>`).join('')}</div>`; }
        
        function triggerStopHunt() { 
            if (typeof Plotly === 'undefined') return;
            document.getElementById('hunt-btn').disabled = true;
            Plotly.restyle('chart-container', { x: [[1,2,3,4,5,6]], open: [[100,101,102,100,100,100]], high: [[102,103,103,101,100,100]], low: [[99,100,100,99,100,96]], close: [[101,102,100,100,100,97]] });
            document.getElementById('sim-feedback').innerHTML = "<span class='text-red-600 font-bold'>¬°BARRIDO!</span> Stops activados.";
            setTimeout(() => { 
                Plotly.restyle('chart-container', { x: [[1,2,3,4,5,6,7]], open: [[100,101,102,100,100,100,97]], high: [[102,103,103,101,100,100,105]], low: [[99,100,100,99,100,96,97]], close: [[101,102,100,100,100,97,104]] });
                document.getElementById('sim-feedback').innerHTML = "<span class='text-kawn-dark font-bold'>¬°V-SHAPE!</span> SM compr√≥ barato.";
                document.getElementById('hunt-btn').disabled = false;
            }, 1500); 
        }
    </script>
    <!-- La funci√≥n callGeminiAPI original permanece intacta para usar la simulaci√≥n local.
         Se elimin√≥ la anulaci√≥n que intentaba llamar a una funci√≥n de Netlify que no
         est√° disponible en un despliegue est√°tico. -->
    <!-- Anular callGeminiAPI para usar la funci√≥n de Netlify real -->
    <script>
        async function callGeminiAPI(userPrompt, systemInstruction) {
            try {
                // Build a request body for POST. Always include the userPrompt.
                const body = { userPrompt };
                if (systemInstruction) {
                    body.systemInstruction = systemInstruction;
                }
                // Send a POST request to the Netlify function. POST requests
                // are allowed by Netlify and simplify CORS handling.
                const resp = await fetch('/.netlify/functions/gemini-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await resp.json();
                let text = '';
                if (result.candidates && result.candidates.length > 0) {
                    const parts = result.candidates[0].content?.parts;
                    if (parts && parts.length > 0) {
                        text = parts.map(p => p.text).join('\n');
                    }
                }
                return text || JSON.stringify(result);
            } catch (e) {
                console.error('Error calling Gemini API', e);
                return 'Error al llamar a la API.';
            }
        }
    </script>
</body>
</html>