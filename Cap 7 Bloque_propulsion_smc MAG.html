<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KawnBit Magazine: Bloques de Propulsión</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* KawnBit Palette */
            --primary-teal: #4db6ac;
            --secondary-teal: #00897b;
            --dark-teal: #005b4f;
            --accent-dark: #263238;
            --text-grey: #455a64;
            --light-bg: #f4f7f6;
            --white: #ffffff;
            --danger: #e57373;
            --danger-dark: #c62828;
            --success: #66bb6a;
            --gradient-teal: linear-gradient(135deg, var(--primary-teal), var(--secondary-teal));
        }

        body {
            font-family: 'Open Sans', sans-serif;
            color: var(--text-grey);
            background-color: var(--light-bg);
            margin: 0;
            padding: 0;
            line-height: 1.8;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Montserrat', sans-serif;
            color: var(--accent-dark);
            font-weight: 700;
        }

        h1 {
            font-size: 2.5rem;
            text-transform: uppercase;
            letter-spacing: -1px;
            color: var(--secondary-teal);
            margin-bottom: 0.5em;
            text-align: center;
        }

        h2 {
            font-size: 1.8rem;
            border-bottom: 3px solid var(--primary-teal);
            padding-bottom: 10px;
            margin-top: 50px;
            color: var(--dark-teal);
        }

        h3 {
            font-size: 1.4rem;
            color: var(--secondary-teal);
            margin-top: 30px;
        }

        h4 {
            font-size: 1.1rem;
            color: var(--accent-dark);
        }

        strong {
            color: var(--secondary-teal);
            font-weight: 700;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: var(--white);
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        /* Header Section */
        .magazine-header {
            text-align: center;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--light-bg);
            margin-bottom: 40px;
        }

        .logo-placeholder {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 3rem;
            background: var(--gradient-teal);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
            margin-bottom: 10px;
        }

        .logo-tagline {
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--secondary-teal);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .intro-lead {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-dark);
            border-left: 5px solid var(--primary-teal);
            padding-left: 20px;
            margin-bottom: 30px;
            background: #e0f2f1;
            padding: 20px;
            border-radius: 0 8px 8px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        /* --- VISUALS & INTERACTIVE --- */

        .infographic-box {
            background: var(--white);
            border-radius: 16px;
            padding: 30px;
            margin: 40px 0;
            border: 1px solid #e0e0e0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .infographic-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08);
        }

        .infographic-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: var(--gradient-teal);
        }

        .infographic-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--dark-teal);
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            background: #e0f2f1;
            padding: 10px 20px;
            border-radius: 50px;
            width: fit-content;
        }

        .infographic-title i {
            margin-right: 10px;
            font-size: 1.2rem;
            color: var(--secondary-teal);
        }

        .btn-interact {
            background: var(--gradient-teal);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            margin-top: 15px;
            display: inline-block;
        }

        .btn-interact:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        .btn-interact:disabled {
            background: #cfd8dc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 1. Rocket Animation (SVG) */
        .rocket-stage {
            width: 100%;
            height: 300px;
            background: radial-gradient(circle at center, #eceff1 0%, #cfd8dc 100%);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            border: 1px solid #b0bec5;
        }

        /* 2. Schematic SVG & Tooltips */
        .schematic-container {
            position: relative;
        }

        .schematic-svg {
            width: 100%;
            height: 300px;
            background: #fff;
            border: 1px dashed var(--secondary-teal);
            border-radius: 8px;
            user-select: none;
        }

        .tooltip {
            position: absolute;
            background: rgba(38, 50, 56, 0.95);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 200px;
            z-index: 10;
        }

        /* SVG Interactive Classes */
        .interactive-element {
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .interactive-element:hover {
            opacity: 0.8;
        }

        .interactive-element:hover+text {
            font-weight: bold;
        }

        /* 3. Comparison Table */
        .comparison-table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: white;
        }

        .comparison-table th {
            background: var(--dark-teal);
            color: white;
            padding: 15px;
            text-align: left;
            white-space: nowrap;
        }

        .comparison-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
            transition: background 0.2s;
        }

        .comparison-table tr:hover td {
            background-color: #e0f2f1;
        }

        .highlight-cell {
            background-color: #b2dfdb !important;
            font-weight: bold;
            color: var(--dark-teal);
        }

        /* 4. Kill Zone Clock */
        .clock-wrapper {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .clock-card {
            text-align: center;
            background: #fafafa;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            width: 150px;
        }

        .canvas-clock {
            width: 120px;
            height: 120px;
            margin: 0 auto 10px;
        }

        /* 5. Simulators */
        .sim-container {
            position: relative;
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: crosshair;
            overflow: hidden;
            touch-action: none;
            height: 350px;
        }

        #simCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .sim-ui {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
        }

        .sim-status {
            font-weight: bold;
            color: var(--dark-teal);
        }

        .sim-step {
            font-size: 0.9rem;
            color: var(--text-grey);
        }

        /* 6. Fractality Viewer */
        .fractal-viewer {
            position: relative;
            height: 300px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .view-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .view-btn {
            padding: 8px 16px;
            border: 1px solid var(--primary-teal);
            background: white;
            color: var(--dark-teal);
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
        }

        .view-btn.active {
            background: var(--primary-teal);
            color: white;
        }

        .fractal-svg {
            width: 100%;
            height: 100%;
        }

        /* 7. Fib Projection */
        .fib-container {
            position: relative;
            height: 350px;
            background: #fafafa;
            border-radius: 8px;
            padding: 20px;
        }

        .slider-container {
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider-control {
            flex-grow: 1;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider-control::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--secondary-teal);
            border-radius: 50%;
            cursor: pointer;
        }


        /* Glossary */
        .glossary-item {
            margin-bottom: 20px;
            border-left: 3px solid var(--primary-teal);
            padding-left: 15px;
            background: #fafafa;
            padding: 10px 15px;
            border-radius: 0 8px 8px 0;
            transition: background 0.3s;
        }

        .glossary-item:hover {
            background: #e0f2f1;
        }

        .glossary-term {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: var(--dark-teal);
            display: block;
            margin-bottom: 5px;
            font-size: 1.05rem;
        }

        /* AI Section */
        .ai-section-wrapper {
            background: #e0f7fa;
            border-radius: 16px;
            padding: 30px;
            margin-top: 40px;
            border: 2px solid var(--primary-teal);
            position: relative;
        }

        .ai-section-wrapper::before {
            content: "POWERED BY GEMINI";
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 0.7rem;
            font-weight: 800;
            color: var(--secondary-teal);
            opacity: 0.6;
        }

        .chat-container {
            background: white;
            border-radius: 12px;
            height: 350px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            background: var(--dark-teal);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .message.ai {
            align-self: flex-start;
            background: #f1f3f4;
            color: var(--accent-dark);
            border-bottom-left-radius: 2px;
            border-left: 4px solid var(--secondary-teal);
        }

        .message.error {
            align-self: center;
            background: #ffebee;
            color: var(--danger-dark);
            border: 1px solid var(--danger);
        }

        .chat-input-area {
            display: flex;
            border-top: 1px solid #ddd;
            padding: 15px;
            background: #fff;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
            outline: none;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: var(--primary-teal);
        }

        .ai-loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid var(--secondary-teal);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .btn-ai-gen {
            background: linear-gradient(135deg, #7b1fa2, #4a148c);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(123, 31, 162, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 auto 20px auto;
            transition: all 0.3s;
        }

        .btn-ai-gen:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(123, 31, 162, 0.4);
        }

        /* New: Scenario Analyzer */
        .analyzer-box {
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }

        .analyzer-textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 10px;
        }

        .analyzer-result {
            margin-top: 15px;
            padding: 15px;
            background: #f1f8e9;
            border-radius: 8px;
            border-left: 4px solid #66bb6a;
            display: none;
            font-size: 0.9rem;
        }

        .analyzer-result.error {
            background: #ffebee;
            border-left-color: var(--danger);
            color: var(--danger-dark);
        }

        /* Footer */
        .main-footer {
            margin-top: 50px;
            padding: 40px 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            background-color: #f8f9fa;
            border-radius: 12px;
        }

        .copyright {
            color: var(--text-grey);
            font-size: 0.9rem;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8rem;
            }

            .comparison-table-wrapper {
                overflow-x: scroll;
            }

            .sim-container {
                height: 250px;
            }

            .clock-wrapper {
                justify-content: center;
            }

            .intro-lead {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="magazine-header">
            <div class="logo-placeholder">KawnBit</div>
            <div class="logo-tagline">Quantitative Trading Community</div>
        </header>

        <div class="chapter-title">
            <h1>Capítulo 7: Bloques de Propulsión (Propulsion Blocks - PB)</h1>
        </div>

        <section>
            <h2>Introducción al Propulsion Block</h2>
            <div class="intro-lead">
                <div>
                    Los <strong>Bloques de Propulsión (Propulsion Blocks)</strong> representan una de las herramientas
                    más refinadas dentro del arsenal de <strong>Smart Money Concepts (ICT)</strong> para capitalizar
                    tendencias ya establecidas.
                </div>
                <!-- AI TTS Button -->
                <button class="btn-interact" id="btnPodcast" onclick="playPodcastSummary()"
                    aria-label="Escuchar resumen del capítulo en audio"
                    style="background: var(--accent-dark); font-size: 0.8rem; padding: 8px 15px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-headphones"></i> <span>Escuchar Resumen</span>
                </button>
            </div>

            <p>Mientras que otras herramientas (como los <em>Order Blocks</em>) ayudan a identificar puntos de entrada
                al inicio de movimientos, los Propulsion Blocks ofrecen algo igualmente valioso: la capacidad de
                <strong>subirse a un tren en marcha con la misma precisión y control de riesgo</strong> que si se
                hubiera entrado desde el principio. En otras palabras, permiten unirse a una tendencia en curso de forma
                óptima, sin “perseguir” el precio.
            </p>

            <p>Imaginemos que el mercado es como una autopista: los Order Blocks serían las rampas de entrada
                principales, mientras que los Propulsion Blocks funcionan como <strong>incorporaciones
                    adicionales</strong> más adelante en el recorrido. Son puntos donde el <strong>Smart Money</strong>
                permite brevemente que nuevos participantes institucionales se unan al movimiento, o donde los ya
                posicionados pueden aumentar su exposición de manera segura, sin alertar al mercado de sus intenciones.
            </p>

            <p>Un Propulsion Block suele señalar el inicio de un movimiento de alto <em>momentum</em> impulsado por los
                institucionales. Cuando aparece un PB, indica que el dinero inteligente ha inyectado agresivamente
                liquidez en una dirección, dejando poco margen a los traders rezagados antes de que el movimiento
                acelere. En resumen, los PB combinan <strong>agresividad institucional</strong> con <strong>gestión de
                    riesgo superior</strong>.</p>
        </section>

        <section>
            <h2>La Naturaleza Dinámica del Propulsion Block</h2>
            <p>¿Por qué existen los Propulsion Blocks? Para comprenderlo, debemos entender la psicología institucional
                detrás de ellos. El Smart Money (grandes bancos, fondos, institucionales) no siempre puede –ni quiere–
                cargar toda su posición en una sola entrada. Las instituciones necesitan distribuir sus órdenes en el
                tiempo para <strong>no impactar excesivamente el precio ni revelar sus intenciones</strong> al mercado.
                Por ello, incluso dentro de tendencias fuertes, planifican puntos de reingreso donde añadir posiciones
                sin desestabilizar el mercado.</p>

            <p>Cuando una tendencia está en desarrollo, el precio inevitablemente realiza retrocesos hacia zonas donde
                previamente se tomaron decisiones importantes. Estos retrocesos no son aleatorios; suelen ser
                <strong>orquestados por las instituciones</strong> para completar posiciones pendientes o para permitir
                la entrada de nuevos participantes institucionales. El Propulsion Block marca justamente uno de esos
                puntos de <strong>reingreso institucional</strong> en la tendencia.
            </p>

            <h3>La Mecánica Profunda de un PB</h3>
            <p>Un Propulsion Block no es simplemente “una vela que penetra un Order Block antiguo”. Más bien, es la
                manifestación visual de un <strong>cambio en el equilibrio entre compradores y vendedores</strong> en un
                nivel clave del gráfico. Cuando vemos formarse un PB, estamos presenciando el momento exacto en que el
                Smart Money decide que es hora de <strong>acelerar el movimiento existente</strong>.</p>

            <div class="infographic-box" style="text-align: center;">
                <div class="infographic-title"><i class="fas fa-rocket"></i> Analogía Interactiva del Cohete</div>
                <p>El OB inicial es el motor de arranque. El <strong>Propulsion Block</strong> es la segunda etapa que
                    acelera el movimiento.</p>

                <div class="rocket-stage" id="rocketContainer">
                    <!-- SVG animado por JS se inyecta aquí -->
                </div>

                <div style="margin-top: 15px;">
                    <p>Haz clic para simular la inyección de liquidez institucional:</p>
                    <button class="btn-interact" id="btnLaunch" onclick="launchRocket()"
                        aria-label="Iniciar animación del cohete">Inyectar Liquidez (Activar PB)</button>
                    <button class="btn-interact" onclick="resetRocket()" aria-label="Reiniciar animación"
                        style="background: var(--text-grey); margin-left:10px;">Reset</button>
                </div>
            </div>

            <p>En términos de mercado, el OB inicia la tendencia y el PB la propulsa con renovada fuerza. De hecho, una
                vez el precio abandona un PB válido, tiende a continuar con poco retroceso inmediato, especialmente si
                ocurre durante períodos de alta liquidez. Es la confirmación de que, tras un retroceso planificado, las
                instituciones <strong>reanudaron sus compras/ventas con fuerza</strong>.</p>
        </section>

        <section>
            <h2>Identificación y Anatomía de un Propulsion Block</h2>
            <p>Reconocer un Propulsion Block en tiempo real requiere seguir <strong>criterios claros</strong>. Veamos
                primero la formación de un <strong>PB alcista</strong> paso a paso:</p>

            <div
                style="background: var(--white); border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 30px;">
                <ol style="padding-left: 20px;">
                    <li style="margin-bottom: 15px;">
                        <strong>Existencia de un Order Block (OB) previo:</strong> Antes de que pueda formarse un PB,
                        debe haber un Order Block importante y validado en niveles inferiores. Este OB identifica una
                        zona donde el Smart Money mostró interés comprando agresivamente.
                    </li>
                    <li style="margin-bottom: 15px;">
                        <strong>Retroceso penetrante en el OB:</strong> El precio inicia un retroceso y forma una vela
                        bajista que penetra dentro del cuerpo del Order Block antiguo. Esta penetración es crucial: debe
                        internarse lo suficiente para activar stop-losses (liquidez), <strong>pero idealmente sin
                            exceder el 50% del rango</strong> de dicho OB.
                    </li>
                    <li style="margin-bottom: 15px;">
                        <strong>Reacción violenta al alza:</strong> Inmediatamente después de la penetración, el precio
                        debe mostrar una reacción contundente (desplazamiento). Idealmente, velas alcistas rápidas que
                        superan el máximo de la vela de penetración.
                    </li>
                    <li>
                        <strong>Confirmación definitiva (Ruptura):</strong> La validación llega cuando el precio
                        <strong>rompe con autoridad el máximo del bloque de propulsión</strong> formado (el pico
                        alcanzado tras la reacción). Esto confirma que el PB está activo.
                    </li>
                </ol>
                <p><em>Nota: Un Propulsion Block bajista es el espejo exacto: una barra alcista ingresa en un OB bajista
                        previo, seguida de reacción bajista violenta.</em></p>
            </div>

            <div class="infographic-box">
                <div class="infographic-title"><i class="fas fa-search-plus"></i> Anatomía Interactiva: El Esquema PB
                </div>
                <p style="margin-bottom: 20px;">Mueve el mouse (o toca) sobre los elementos del gráfico para entender la
                    narrativa del precio.</p>

                <div class="schematic-container">
                    <div id="tooltip" class="tooltip"></div>
                    <!-- SVG Interactivo -->
                    <svg viewBox="0 0 500 300" class="schematic-svg" id="anatomySvg">
                        <defs>
                            <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                                <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#f0f0f0" stroke-width="1" />
                            </pattern>
                            <marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto"
                                markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L9,3 z" fill="#444" />
                            </marker>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#grid)" />

                        <!-- OB Previo -->
                        <g class="interactive-element" data-title="Order Block (OB)"
                            data-desc="Zona de demanda original. El precio regresa aquí para 'recargar' órdenes.">
                            <rect x="50" y="220" width="60" height="40" fill="#b2dfdb" stroke="#00897b"
                                stroke-width="1" />
                            <text x="80" y="275" text-anchor="middle" font-size="12" fill="#005b4f"
                                font-weight="bold">OB Inicial</text>
                            <!-- Linea proyeccion -->
                            <line x1="110" y1="220" x2="500" y2="220" stroke="#00897b" stroke-dasharray="4"
                                opacity="0.5" />
                        </g>

                        <!-- Price Action Path -->
                        <path d="M 20 250 L 50 220 L 80 230 L 80 150 L 150 150" fill="none" stroke="#cfd8dc"
                            stroke-width="2" />

                        <!-- Candle Down (Penetration) -->
                        <g class="interactive-element" data-title="Vela de Penetración (PB)"
                            data-desc="El precio cae dentro del OB antiguo para tomar liquidez, pero NO lo rompe (respeta el 50%).">
                            <line x1="180" y1="140" x2="180" y2="235" stroke="#333" stroke-width="1" /> <!-- Wick -->
                            <rect x="170" y="150" width="20" height="80" fill="#ef5350" stroke="#c62828" />
                            <!-- Body -->
                        </g>

                        <!-- Candle Up (Reaction) -->
                        <g class="interactive-element" data-title="Reacción Institucional"
                            data-desc="Inmediata y fuerte. El Smart Money compra agresivamente tras la toma de liquidez.">
                            <line x1="210" y1="140" x2="210" y2="230" stroke="#333" stroke-width="1" />
                            <rect x="200" y="140" width="20" height="85" fill="#66bb6a" stroke="#2e7d32" />
                        </g>

                        <!-- Breakout -->
                        <g class="interactive-element" data-title="Confirmación (BOS)"
                            data-desc="El precio rompe el máximo del PB. Aquí se confirma la continuación.">
                            <rect x="230" y="80" width="20" height="70" fill="#66bb6a" opacity="0.6" />
                            <path d="M 240 140 L 250 80 L 300 60" fill="none" stroke="#2e7d32" stroke-width="2"
                                marker-end="url(#arrow)" />
                        </g>

                        <!-- Labels -->
                        <text x="180" y="130" text-anchor="middle" font-size="12" fill="#c62828"
                            font-weight="bold">PB</text>
                        <line x1="140" y1="230" x2="250" y2="230" stroke="#c62828" stroke-dasharray="2" />
                        <text x="260" y="235" font-size="10" fill="#c62828">Penetración < 50%</text>

                    </svg>
                </div>
            </div>

            <h3>Checklist de Validación de un PB</h3>
            <p>Para verificar que efectivamente estamos ante un Propulsion Block válido, usa esta lista:</p>
            <ul style="list-style: none; padding: 0;">
                <li style="margin-bottom: 10px;"><i class="fas fa-check-circle" style="color: var(--success);"></i>
                    <strong>Order Block previo identificado:</strong> Sin OB institucional previo, no puede haber PB.
                </li>
                <li style="margin-bottom: 10px;"><i class="fas fa-check-circle" style="color: var(--success);"></i>
                    <strong>Penetración controlada:</strong> El retroceso ingresa en el OB pero <strong>sin superar
                        ~50%</strong> del mismo ni invalidarlo.
                </li>
                <li style="margin-bottom: 10px;"><i class="fas fa-check-circle" style="color: var(--success);"></i>
                    <strong>Rechazo con desplazamiento:</strong> Tras la penetración, el precio revierte con fuerza
                    rompiendo el extremo de la vela de penetración.
                </li>
                <li style="margin-bottom: 10px;"><i class="fas fa-check-circle" style="color: var(--success);"></i>
                    <strong>Ruptura confirmatoria:</strong> El precio rompe el máximo/mínimo del PB, confirmando
                    continuidad.
                </li>
                <li><i class="fas fa-check-circle" style="color: var(--success);"></i> <strong>Contexto
                        alineado:</strong> (Opcional) Coincide con Kill Zones, tendencia mayor o FVG.</li>
            </ul>
        </section>

        <section>
            <h2>Operativa de los Propulsion Blocks (PB)</h2>
            <p>Identificado y validado un Propulsion Block, ¿cómo operarlo estratégicamente? Abordamos la ejecución
                práctica.</p>

            <h3>Timing de Entrada: Precisión Quirúrgica</h3>
            <p>La belleza de los PBs radica en su precisión. Lo ideal es <strong>no entrar a mercado persiguiendo el
                    precio</strong>. Se colocan órdenes límite en el extremo del bloque de propulsión:</p>
            <ul>
                <li><strong>PB Alcista:</strong> Compra límite (Buy Limit) en el punto más bajo del bloque (mínimo de la
                    vela de penetración).</li>
                <li><strong>PB Bajista:</strong> Venta límite (Sell Limit) en el punto más alto del bloque.</li>
            </ul>
            <p>Entrar con límite significa que <strong>esperamos un pull-back</strong> hacia el PB. Operamos con la
                mentalidad del Smart Money: dejamos que el precio venga a nosotros. Si no retrocede, aceptamos la
                oportunidad perdida.</p>

            <h3>Gestión del Stop Loss: Precisión Milimétrica</h3>
            <p>Si el precio viola significativamente el PB tras nuestra entrada, la narrativa ha cambiado. La directriz
                general es colocar el <strong>Stop Loss justo por debajo de la mitad del PB</strong> (el <em>Mean
                    Threshold</em> o 50%).</p>
            <blockquote>
                <p><strong>Regla de Oro:</strong> El 50% del bloque actúa como la “línea de arena” institucional. Si el
                    precio cierra más allá de esa mitad, el bloque podría haber fallado. Esto permite ratios
                    Riesgo:Beneficio excepcionales (stops de 5-15 pips).</p>
            </blockquote>

            <div class="infographic-box" style="background: #f1f8e9;">
                <div class="infographic-title" style="background: #dcedc8; color: #33691e;"><i
                        class="fas fa-gamepad"></i> Simulador de Trading: Coloca tu Stop Loss</div>
                <p>A continuación verás un Propulsion Block formándose. Haz clic en el gráfico para colocar tu nivel de
                    <strong>Stop Loss</strong>. ¿Será seguro?
                </p>

                <div class="sim-container">
                    <canvas id="simCanvas"></canvas>
                </div>

                <div class="sim-ui">
                    <span class="sim-step" id="simInstruction">Instrucción: Haz clic en el gráfico para fijar tu Stop
                        Loss.</span>
                    <span class="sim-status" id="simResult">Esperando...</span>
                    <button class="btn-interact" style="margin-top:0; font-size: 0.8rem;" onclick="resetSimulation()"
                        aria-label="Reiniciar simulación">Reiniciar</button>
                </div>

                <p style="font-size: 0.9rem; margin-top: 10px;"><em>Recuerda: El Stop Loss (línea roja) debe proteger el
                        50% del cuerpo.</em></p>
            </div>

            <h3>Objetivos de Salida</h3>
            <p>En tendencias fuertes, el primer objetivo lógico es el <strong>máximo o mínimo anterior
                    significativo</strong> (liquidez). Dado que entramos en una tendencia ya en marcha, la gestión
                activa (trailing stop) es recomendable. En rangos, sé más conservador y apunta al extremo opuesto de la
                consolidación.</p>
        </section>

        <!-- NEW SECTION: PROYECCION ALGORITMICA -->
        <section>
            <h2>Proyección Algorítmica de Objetivos (Standard Deviations)</h2>
            <p>Una de las técnicas menos discutidas pero más poderosas para operar PBs es el uso de <strong>Desviaciones
                    Estándar (Standard Deviations - SD)</strong> para fijar Take Profits. Los algoritmos institucionales
                no adivinan; calculan proyecciones matemáticas basadas en el rango de manipulación.</p>
            <p>El rango que crea el Propulsion Block (desde el mínimo de la vela de penetración hasta el máximo de la
                reacción) actúa como el "vector" para proyectar objetivos. Las instituciones suelen liquidar posiciones
                en:</p>
            <ul>
                <li><strong>+2.0 SD:</strong> Primer objetivo parcial.</li>
                <li><strong>+2.5 SD:</strong> Objetivo clásico de reversión o pausa.</li>
                <li><strong>+4.0 SD:</strong> Objetivo final en tendencias eufóricas.</li>
            </ul>

            <div class="infographic-box">
                <div class="infographic-title"><i class="fas fa-ruler-combined"></i> Proyector de Objetivos Fibonacci
                </div>
                <p>Usa el control deslizante para simular la proyección del precio basada en el rango del PB.</p>

                <div class="fib-container">
                    <svg id="fibSvg" width="100%" height="100%" viewBox="0 0 400 300">
                        <!-- Base Structure -->
                        <line x1="50" y1="250" x2="350" y2="250" stroke="#ddd" stroke-width="1" />
                        <!-- PB Range Visualization -->
                        <rect x="100" y="200" width="30" height="50" fill="#263238" opacity="0.2" stroke="#263238"
                            stroke-dasharray="2" />
                        <text x="80" y="230" font-size="10" fill="#263238" text-anchor="end">Rango PB (1.0)</text>

                        <!-- Projection Lines (Dynamic) -->
                        <g id="fibLines" style="opacity: 0.5;">
                            <!-- 2.0 SD -->
                            <line x1="100" y1="150" x2="350" y2="150" stroke="var(--primary-teal)" stroke-width="2"
                                stroke-dasharray="4" />
                            <text x="360" y="155" font-size="12" fill="var(--primary-teal)" font-weight="bold">+2.0
                                SD</text>

                            <!-- 2.5 SD -->
                            <line x1="100" y1="125" x2="350" y2="125" stroke="var(--secondary-teal)" stroke-width="2"
                                stroke-dasharray="4" />
                            <text x="360" y="130" font-size="12" fill="var(--secondary-teal)" font-weight="bold">+2.5
                                SD</text>

                            <!-- Price Path -->
                            <path id="fibPricePath" d="M 115 225 L 140 200" fill="none" stroke="#263238"
                                stroke-width="2" />
                        </g>
                    </svg>
                </div>

                <div class="slider-container">
                    <span style="font-size:0.9rem; font-weight:bold;">Proyección:</span>
                    <input type="range" min="0" max="100" value="0" class="slider-control" id="fibSlider"
                        oninput="updateFibProjection(this.value)"
                        aria-label="Control deslizante de proyección Fibonacci">
                    <span id="fibValue"
                        style="min-width: 60px; text-align:right; font-weight:bold; color:var(--secondary-teal);">0%</span>
                </div>
            </div>
        </section>

        <section>
            <h2>Diferencias entre Propulsion Blocks y Otras Estructuras</h2>
            <p>Es vital no confundir conceptos. Aquí comparamos los PB con el Mitigation Block y el Breaker Block:</p>

            <div class="infographic-box">
                <div class="infographic-title"><i class="fas fa-table"></i> Comparativa Interactiva</div>
                <p>Haz clic en "Resaltar Diferencias" para ver las claves.</p>
                <button class="btn-interact" onclick="toggleTableHighlight()" style="margin-bottom: 15px;"
                    aria-label="Resaltar diferencias en la tabla">Resaltar Diferencias</button>

                <div class="comparison-table-wrapper">
                    <table class="comparison-table" id="compTable">
                        <thead>
                            <tr>
                                <th>Características</th>
                                <th>Order Block de Continuación</th>
                                <th>Propulsion Block (PB)</th>
                                <th>Breaker Block (BB)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Dirección</strong></td>
                                <td>Continúa tendencia.</td>
                                <td class="diff-target">Continúa con fuerza renovada.</td>
                                <td class="diff-target">Revierte tendencia (Giro).</td>
                            </tr>
                            <tr>
                                <td><strong>Formación</strong></td>
                                <td>Retroceso simple.</td>
                                <td class="diff-target">Penetra OB previo sin romperlo.</td>
                                <td class="diff-target">Rompe un OB anterior.</td>
                            </tr>
                            <tr>
                                <td><strong>Intención</strong></td>
                                <td>Moderada.</td>
                                <td class="diff-target">Alta: Momentum violento.</td>
                                <td>Alta: Manipulación.</td>
                            </tr>
                            <tr>
                                <td><strong>Contexto</strong></td>
                                <td>Mitigación (FVG).</td>
                                <td class="diff-target">Reingreso institucional.</td>
                                <td>Caza de stops.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <p>El <strong>Breaker Block</strong> señala un cambio de tendencia tras una manipulación, mientras que el
                <strong>Propulsion Block</strong> refuerza la tendencia existente. El PB <strong>no rompe
                    estructura</strong>, la respeta y potencia.
            </p>
        </section>

        <section>
            <h2>Contextos Ideales para Operar Propulsion Blocks</h2>
            <p>No todos los PB ofrecen la misma probabilidad. Existen condiciones que favorecen su éxito:</p>

            <h3>Sesiones de Alta Liquidez (Kill Zones)</h3>
            <p>Los PB funcionan excepcionalmente bien durante las <strong>Kill Zones</strong> de Londres y Nueva York.
                En estas franjas, el volumen permite que el Smart Money ejecute grandes órdenes. Si un PB surge justo en
                la apertura de NY tras un pullback, es señal potente.</p>

            <div class="infographic-box">
                <div class="infographic-title"><i class="far fa-clock"></i> Monitor de Kill Zones (Tiempo Real Simulado)
                </div>
                <p>Observa cómo se activan las zonas. (Velocidad acelerada x100 para demostración)</p>
                <div class="clock-wrapper">
                    <div class="clock-card">
                        <canvas id="clockLondon" class="canvas-clock" width="120" height="120"></canvas>
                        <strong>Londres</strong><br>07:00 - 10:00
                    </div>
                    <div class="clock-card">
                        <canvas id="clockNY" class="canvas-clock" width="120" height="120"></canvas>
                        <strong>Nueva York</strong><br>12:00 - 15:00
                    </div>
                </div>
                <p style="text-align:center; margin-top:10px; font-size:0.9rem;">Cuando la aguja entra en la zona verde,
                    la probabilidad de un PB exitoso aumenta drásticamente.</p>
            </div>

            <h3>Otros Contextos Clave</h3>
            <ul>
                <li><strong>Alineación con Temporalidades Superiores:</strong> Un PB en 15min respaldado por una
                    estructura alcista en 4H tiene "viento de cola".</li>
                <li><strong>Post-noticias de alto impacto:</strong> Tras la "sacudida" de una noticia, el mercado suele
                    retomar su tendencia dejando PBs claros una vez pasa la volatilidad inicial.</li>
            </ul>
        </section>

        <!-- NEW SECTION: FRACTALIDAD -->
        <section>
            <h2>Fractalidad: El "Microscopio Institucional"</h2>
            <p>Uno de los secretos mejor guardados para validar un PB es entender su <strong>fractalidad</strong>. Lo
                que en H1 parece una simple mecha rechazando un nivel, en M5 o M15 es una estructura completa de
                manipulación y distribución.</p>
            <p>Al hacer "zoom in" en la vela de penetración de un PB, a menudo encontramos:</p>
            <ol>
                <li>Un pequeño rango de acumulación.</li>
                <li>Un movimiento rápido (Judas Swing) que toma liquidez interna.</li>
                <li>Un cambio de estructura (Market Structure Shift - MSS) inmediato.</li>
            </ol>
            <p>Esta confirmación interna aumenta drásticamente la fiabilidad del setup.</p>

            <div class="infographic-box">
                <div class="infographic-title"><i class="fas fa-microscope"></i> Visor de Fractalidad</div>
                <p>Alterna la vista para entender qué ocurre dentro de la vela del PB.</p>

                <div class="view-controls">
                    <button class="view-btn active" onclick="setFractalView('macro')">Vista H1 (Macro)</button>
                    <button class="view-btn" onclick="setFractalView('micro')">Vista M5 (Micro)</button>
                </div>

                <div class="fractal-viewer">
                    <!-- SVG Content generated by JS -->
                    <div id="fractalSvgContainer" style="width:100%; height:100%;"></div>
                </div>
            </div>
        </section>

        <section>
            <h2>Errores Comunes y Cómo Evitarlos</h2>
            <div class="comparison-grid" style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                <div
                    style="border-left: 4px solid var(--danger); background: #fff; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <h4 style="color: var(--danger-dark);">1. Operar sin confirmación (Anticipación)</h4>
                    <p><strong>Error:</strong> Entrar antes de que el precio rompa el máximo/mínimo del PB.
                        <br><strong>Solución:</strong> Disciplina. Espera la ruptura del alto/bajo del bloque. Sin
                        ruptura, no hay validación.
                    </p>
                </div>
                <div
                    style="border-left: 4px solid var(--danger); background: #fff; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <h4 style="color: var(--danger-dark);">2. Ignorar liquidez circundante (Trampas)</h4>
                    <p><strong>Error:</strong> Operar un PB justo debajo de "dobles techos" (liquidez).
                        <br><strong>Solución:</strong> Si hay liquidez obvia muy cerca, el precio podría usar el PB solo
                        para cazarla y revertir. Espera a que se limpie esa zona.
                    </p>
                </div>
                <div
                    style="border-left: 4px solid var(--danger); background: #fff; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <h4 style="color: var(--danger-dark);">3. Stops demasiado holgados</h4>
                    <p><strong>Error:</strong> Poner el Stop debajo de todo el OB original "por seguridad".
                        <br><strong>Solución:</strong> Esto destruye el ratio Riesgo:Beneficio. Usa la regla del 50%. Si
                        no estás cómodo, reduce el lotaje, no amplíes el stop.
                    </p>
                </div>
            </div>
        </section>

        <section>
            <h2>Integración Avanzada con Otras Herramientas ICT</h2>
            <p>Para disparar la probabilidad de éxito, combina los PB con:</p>
            <ul>
                <li><strong>Fair Value Gaps (FVG):</strong> Si un PB coincide con un FVG (vacío de precio), es un "PB de
                    alta probabilidad". El precio corrige el desequilibrio y usa el PB para rebotar.</li>
                <li><strong>Divergencias SMT:</strong> Si el S&P500 hace un PB alcista mientras el NASDAQ muestra
                    debilidad relativa (o divergencia en mínimos), confirma la manipulación y la fuerza del movimiento.
                </li>
                <li><strong>Power of 3 (PO3):</strong> Los PBs suelen aparecer en la fase de
                    <strong>Distribución</strong> (Expansión) del día, justo después de la manipulación (Judas Swing).
                </li>
            </ul>
        </section>

        <section style="background: #e8eaf6; padding: 25px; border-radius: 12px; margin-top: 40px;">
            <h3><i class="fas fa-dumbbell"></i> Ejercicios Prácticos</h3>
            <ol>
                <li style="margin-bottom: 15px;"><strong>Identificación histórica:</strong> Retrocede 3 meses en H1.
                    Marca todos los PBs. Analiza cuáles funcionaron (¿tenían FVG? ¿estaban en tendencia?) y cuáles
                    fallaron.</li>
                <li style="margin-bottom: 15px;"><strong>Paper Trading en vivo:</strong> Durante la sesión de
                    Londres/NY, anota posibles PBs. No operes real. Verifica si se confirma la ruptura y si el retroceso
                    llega a tu orden límite. Entrena tu ojo.</li>
                <li><strong>Backtesting con Gestión:</strong> Simula 30 operaciones usando SOLO la regla del Stop al
                    50%. Calcula tu ratio de acierto y beneficio promedio. Esto te dará confianza estadística en el stop
                    ajustado.</li>
            </ol>
        </section>

        <section>
            <h3><i class="fas fa-book"></i> Glosario de Términos Clave</h3>
            <div class="glossary-item">
                <span class="glossary-term">Bloque de Órdenes (Order Block, OB)</span>
                Zona de acumulación institucional marcada por la última vela contraria antes de un movimiento fuerte.
                Actúa como soporte/resistencia institucional.
            </div>
            <div class="glossary-item">
                <span class="glossary-term">Bloque de Propulsión (Propulsion Block, PB)</span>
                Vela que penetra un OB previo sin invalidarlo, seguida de un rechazo violento. Es un punto de reingreso
                para acelerar la tendencia.
            </div>
            <div class="glossary-item">
                <span class="glossary-term">Bloque de Ruptura (Breaker Block, BB)</span>
                Resulta de un OB fallido que cambia de rol (soporte a resistencia) tras una manipulación de liquidez.
                Señala reversión.
            </div>
            <div class="glossary-item">
                <span class="glossary-term">Bloque Mitigador (Mitigation Block)</span>
                Zona de retroceso para equilibrar ineficiencias (FVG) sin necesariamente penetrar un OB previo.
            </div>
            <div class="glossary-item">
                <span class="glossary-term">Mean Threshold</span>
                El punto medio (50%) de un bloque de órdenes. En PBs, se usa como nivel de invalidación para el Stop
                Loss.
            </div>
            <div class="glossary-item">
                <span class="glossary-term">Kill Zones</span>
                Franjas horarias de alta volatilidad (Aperturas de Londres y NY) donde el Smart Money es más activo.
            </div>
            <div class="glossary-item">
                <span class="glossary-term">Power of Three (PO3)</span>
                Modelo diario de Acumulación, Manipulación y Distribución. Los PB suelen aparecer en la fase de
                Distribución.
            </div>
        </section>

        <section class="ai-section-wrapper">
            <div class="ai-header" style="display:flex; align-items:center; margin-bottom:20px;">
                <i class="fas fa-robot fa-2x" style="color: var(--secondary-teal);"></i>
                <h3 style="margin:0 0 0 10px; color: var(--dark-teal);">Mentor Virtual KawnBit</h3>
            </div>
            <p>¿Tienes dudas sobre los Propulsion Blocks? Pregunta a nuestra IA o ponte a prueba.</p>

            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="message ai">
                        ¡Hola! Soy tu experto en Propulsion Blocks impulsado por Gemini. Puedo explicarte conceptos o
                        evaluarte. ¿Por dónde empezamos?
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input" class="chat-input"
                        placeholder="Ej: ¿Cuál es la diferencia con un Breaker?" onkeypress="handleEnter(event)">
                    <button class="btn-interact"
                        style="margin-top:0; border-radius:50%; width:45px; height:45px; padding:0; display:flex; align-items:center; justify-content:center;"
                        onclick="sendMessage()" aria-label="Enviar mensaje al mentor virtual">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <div class="analyzer-box">
                <h4 style="color: var(--dark-teal); display: flex; align-items: center; gap:10px;"><i
                        class="fas fa-search-dollar"></i> Validar mi Setup</h4>
                <p style="font-size:0.9rem; margin-bottom:10px;">Describe tu escenario de mercado y te diré si cumple
                    las reglas de un PB.</p>
                <textarea id="analyzerInput" class="analyzer-textarea"
                    placeholder="Ej: El precio rompió un mínimo anterior en H1, regresó a un OB de 15m penetrándolo solo con la mecha y luego cerró con fuerza a la baja..."></textarea>
                <button class="btn-interact" onclick="analyzeSetup()"
                    aria-label="Analizar el escenario de trading">Analizar Setup con Gemini</button>
                <div id="analyzerResult" class="analyzer-result"></div>
            </div>

            <div class="quiz-container"
                style="background:white; padding:20px; border-radius:12px; text-align:center; margin-top:30px;">
                <h4 style="color: var(--dark-teal);">Desafío Rápido: Propulsion Blocks</h4>
                <button class="btn-ai-gen" onclick="generateAIQuiz()"
                    aria-label="Generar una nueva pregunta de examen con Inteligencia Artificial">✨ Generar Pregunta
                    Nueva con IA</button>
                <p id="quiz-question-text" style="font-weight:600; margin:20px 0;">¿Cuál es la regla general para el
                    Stop Loss en un Propulsion Block?</p>
                <div id="quiz-options" style="display:flex; flex-direction:column; gap:10px;">
                    <button class="quiz-option btn-interact" style="background:#f5f5f5; color:var(--text-grey);"
                        onclick="checkQuiz(this, false, 'Incorrecto. Ponerlo debajo de todo el OB destruye tu ventaja estadística.')">Debajo
                        del OB original completo</button>
                    <button class="quiz-option btn-interact" style="background:#f5f5f5; color:var(--text-grey);"
                        onclick="checkQuiz(this, true, '¡Correcto! El 50% es la línea de arena institucional.')">Justo
                        por debajo del 50% (Mean Threshold) del PB</button>
                    <button class="quiz-option btn-interact" style="background:#f5f5f5; color:var(--text-grey);"
                        onclick="checkQuiz(this, false, 'Incorrecto. Usar pips fijos ignora la estructura de mercado.')">10
                        pips fijos bajo la entrada</button>
                </div>
                <div id="quiz-feedback" style="margin-top:15px; display:none; font-weight:bold;"></div>
            </div>
        </section>

        <footer class="main-footer">
            <div class="footer-logo">
                <div class="logo-placeholder" style="font-size: 2rem;">KawnBit</div>
            </div>
            <p class="copyright">&copy; <span id="current-year"></span> KawnBit Magazine. Todos los derechos reservados.
            </p>
        </footer>

    </div>

    <script>
        /* ----------------------------------------------------------------
           GLOBAL: Gemini API Setup & Helpers (Robust Edition)
        ---------------------------------------------------------------- */
        const proxyUrl = "/.netlify/functions/gemini-proxy";

        // Robust JSON Parser (handles LLM preamble text)
        function extractAndParseJSON(text) {
            try {
                // 1. Try direct parse
                return JSON.parse(text);
            } catch (e) {
                try {
                    // 2. Extract JSON block using Regex (greedy matching between brackets)
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }
                    throw new Error("No valid JSON found");
                } catch (e2) {
                    console.error("JSON Parsing Error:", e2);
                    return null;
                }
            }
        }

        // Helper to Call Gemini Text Model
        async function callGemini(prompt, systemInstruction = "", retries = 3) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || data.result || "No se pudo generar una respuesta.";
                } catch (error) {
                    console.warn(`Intento ${i + 1} fallido:`, error);
                    if (i === retries - 1) return "Lo siento, hay problemas de conexión con el servicio de IA en este momento (Netlify Proxy).";
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i))); // Backoff
                }
            }
        }

        // Helper to Call Gemini TTS Model (Updated to use the same proxy if it supports it, or handle error)
        async function callGeminiTTS(textToSay) {
            // Nota: El proxy debe estar preparado para manejar la configuración de AUDIO
            const payload = {
                contents: [{ parts: [{ text: textToSay }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } }
                }
            };
            try {
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error("TTS Proxy Error");
                const data = await response.json();
                // Dependiendo de cómo el proxy devuelva el audio inline
                const base64Audio = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                return base64Audio;
            } catch (e) {
                console.error("TTS Fetch Error:", e);
                return null;
            }
        }

        // Helper: PCM to WAV converter
        function pcmToWav(base64PCM) {
            try {
                const raw = atob(base64PCM);
                const rawLength = raw.length;
                const array = new Uint8Array(new ArrayBuffer(rawLength));
                for (let i = 0; i < rawLength; i++) { array[i] = raw.charCodeAt(i); }

                const sampleRate = 24000;
                const numChannels = 1;
                const bitsPerSample = 16;

                const buffer = new ArrayBuffer(44 + array.length);
                const view = new DataView(buffer);

                writeString(view, 0, 'RIFF');
                view.setUint32(4, 36 + array.length, true);
                writeString(view, 8, 'WAVE');
                writeString(view, 12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, numChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * numChannels * 2, true);
                view.setUint16(32, numChannels * 2, true);
                view.setUint16(34, bitsPerSample, true);
                writeString(view, 36, 'data');
                view.setUint32(40, array.length, true);

                const wavBytes = new Uint8Array(buffer);
                wavBytes.set(array, 44);

                return new Blob([wavBytes], { type: 'audio/wav' });
            } catch (e) {
                console.error("WAV Encoding Error", e);
                return null;
            }
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) { view.setUint8(offset + i, string.charCodeAt(i)); }
        }

        document.getElementById('current-year').textContent = new Date().getFullYear();

        /* ----------------------------------------------------------------
           Rocket & Animation Logic
        ---------------------------------------------------------------- */
        const rocketContainer = document.getElementById('rocketContainer');
        const rocketSVG = `
        <svg viewBox="0 0 300 300" width="100%" height="100%" id="rocketScene">
            <defs>
                <linearGradient id="fireGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#ffeb3b;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#f44336;stop-opacity:1" />
                </linearGradient>
            </defs>
            <rect id="baseOB" x="100" y="250" width="100" height="20" fill="#4db6ac" rx="5" />
            <text x="150" y="285" text-anchor="middle" font-size="12" fill="#005b4f" font-weight="bold">ORDER BLOCK (OB)</text>
            <g id="stage1" transform="translate(130, 200)">
                <rect x="0" y="0" width="40" height="50" fill="#90a4ae" rx="2" />
                <path d="M 10 50 L 15 70 L 25 70 L 30 50 Z" fill="#546e7a" />
            </g>
            <g id="mainRocket" transform="translate(135, 150)">
                <path d="M 15 0 Q 30 0 30 20 L 30 50 L 0 50 L 0 20 Q 0 0 15 0" fill="#00897b" />
                <circle cx="15" cy="20" r="5" fill="#e0f2f1" />
                <path id="rocketFire" d="M 5 50 L 15 80 L 25 50 Z" fill="url(#fireGrad)" opacity="0" />
            </g>
            <text id="lblPB" x="200" y="160" opacity="0" fill="#005b4f" font-weight="bold">PB ACTIVADO</text>
        </svg>
    `;
        rocketContainer.innerHTML = rocketSVG;

        function launchRocket() {
            const rocket = document.getElementById('mainRocket');
            const stage1 = document.getElementById('stage1');
            const fire = document.getElementById('rocketFire');
            const lbl = document.getElementById('lblPB');
            const btn = document.getElementById('btnLaunch');
            btn.disabled = true; btn.innerText = "Propulsando...";
            rocket.style.transition = 'transform 1s ease-out';
            stage1.style.transition = 'transform 1s ease-out';
            rocket.setAttribute('transform', 'translate(135, 100)');
            stage1.setAttribute('transform', 'translate(130, 150)');
            setTimeout(() => {
                lbl.style.opacity = '1';
                setTimeout(() => {
                    fire.style.opacity = '1';
                    stage1.style.transition = 'transform 1s ease-in, opacity 1s';
                    stage1.setAttribute('transform', 'translate(130, 220)');
                    stage1.style.opacity = '0.5';
                    rocket.style.transition = 'transform 1.5s cubic-bezier(0.5, 0, 1, 1)';
                    rocket.setAttribute('transform', 'translate(135, -100)');
                    setTimeout(() => { btn.innerText = "Lanzamiento Completo"; }, 1500);
                }, 800);
            }, 1000);
        }

        function resetRocket() {
            const rocket = document.getElementById('mainRocket');
            const stage1 = document.getElementById('stage1');
            const fire = document.getElementById('rocketFire');
            const lbl = document.getElementById('lblPB');
            const btn = document.getElementById('btnLaunch');
            rocket.style.transition = 'none'; stage1.style.transition = 'none';
            rocket.setAttribute('transform', 'translate(135, 150)');
            stage1.setAttribute('transform', 'translate(130, 200)');
            stage1.style.opacity = '1'; fire.style.opacity = '0'; lbl.style.opacity = '0';
            btn.disabled = false; btn.innerText = "Inyectar Liquidez (Activar PB)";
        }

        /* ----------------------------------------------------------------
           Schematic Tooltips
        ---------------------------------------------------------------- */
        const tooltip = document.getElementById('tooltip');
        const interactiveElements = document.querySelectorAll('.interactive-element');
        interactiveElements.forEach(el => {
            el.addEventListener('mouseenter', (e) => {
                const title = el.getAttribute('data-title');
                const desc = el.getAttribute('data-desc');
                tooltip.innerHTML = `<strong>${title}</strong><br>${desc}`;
                tooltip.style.opacity = '1';
            });
            el.addEventListener('mousemove', (e) => {
                const container = document.querySelector('.schematic-container');
                if (container) {
                    const containerRect = container.getBoundingClientRect();
                    tooltip.style.left = (e.clientX - containerRect.left + 15) + 'px';
                    tooltip.style.top = (e.clientY - containerRect.top + 15) + 'px';
                }
            });
            el.addEventListener('mouseleave', () => { tooltip.style.opacity = '0'; });
        });

        function toggleTableHighlight() {
            const cells = document.querySelectorAll('.diff-target');
            cells.forEach(cell => { cell.classList.toggle('highlight-cell'); });
        }

        /* ----------------------------------------------------------------
           Clocks Animation (Optimized)
        ---------------------------------------------------------------- */
        function drawClock(canvasId, startHour, endHour, currentSimHour) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width; const h = canvas.height; const cx = w / 2; const cy = h / 2; const r = w / 2 - 5;
            ctx.clearRect(0, 0, w, h);
            ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.fillStyle = 'white'; ctx.fill(); ctx.lineWidth = 4; ctx.strokeStyle = '#455a64'; ctx.stroke();
            const startRad = ((startHour % 12) * 30 - 90) * (Math.PI / 180);
            const endRad = ((endHour % 12) * 30 - 90) * (Math.PI / 180);
            ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r - 4, startRad, endRad); ctx.moveTo(cx, cy); ctx.fillStyle = 'rgba(0, 137, 123, 0.3)'; ctx.fill();
            const handRad = ((currentSimHour % 12) * 30 - 90) * (Math.PI / 180);
            ctx.beginPath(); ctx.moveTo(cx, cy);
            const lx = cx + (r - 15) * Math.cos(handRad); const ly = cy + (r - 15) * Math.sin(handRad);
            ctx.lineTo(lx, ly); ctx.lineWidth = 4; ctx.strokeStyle = '#c62828'; ctx.stroke();
            ctx.beginPath(); ctx.arc(cx, cy, 5, 0, Math.PI * 2); ctx.fillStyle = '#263238'; ctx.fill();
        }

        let simHour = 6;
        let clockAnimationFrame;
        function animateClocks() {
            simHour += 0.05; if (simHour > 18) simHour = 6;
            drawClock('clockLondon', 7, 10, simHour);
            drawClock('clockNY', 7, 10, simHour - 5);
            clockAnimationFrame = requestAnimationFrame(animateClocks);
        }
        // Only start if canvas exists to avoid errors
        if (document.getElementById('clockLondon')) {
            animateClocks();
        }

        /* ----------------------------------------------------------------
           Simulator Logic
        ---------------------------------------------------------------- */
        const simCanvas = document.getElementById('simCanvas');
        const sCtx = simCanvas ? simCanvas.getContext('2d') : null;
        let simStep = 0; let candleTop, candleBottom;

        function resizeSim() {
            if (!simCanvas) return;
            simCanvas.width = simCanvas.parentElement.offsetWidth;
            simCanvas.height = simCanvas.parentElement.offsetHeight;
            drawSimScene();
        }
        window.addEventListener('resize', resizeSim);

        function drawSimScene() {
            if (!sCtx) return;
            const w = simCanvas.width; const h = simCanvas.height;
            sCtx.clearRect(0, 0, w, h);
            sCtx.strokeStyle = '#eee'; sCtx.lineWidth = 1;
            for (let i = 0; i < w; i += 20) { sCtx.beginPath(); sCtx.moveTo(i, 0); sCtx.lineTo(i, h); sCtx.stroke(); }
            for (let i = 0; i < h; i += 20) { sCtx.beginPath(); sCtx.moveTo(0, i); sCtx.lineTo(w, i); sCtx.stroke(); }
            const cx = w / 2; candleTop = h * 0.3; candleBottom = h * 0.7; const candleW = 40;
            sCtx.beginPath(); sCtx.moveTo(cx, h * 0.2); sCtx.lineTo(cx, h * 0.8); sCtx.strokeStyle = '#000'; sCtx.lineWidth = 2; sCtx.stroke();
            sCtx.fillStyle = '#e57373'; sCtx.strokeStyle = '#c62828'; sCtx.lineWidth = 2;
            sCtx.fillRect(cx - candleW / 2, candleTop, candleW, candleBottom - candleTop);
            sCtx.strokeRect(cx - candleW / 2, candleTop, candleW, candleBottom - candleTop);
            sCtx.fillStyle = '#333'; sCtx.font = '14px sans-serif'; sCtx.fillText("PB Candle", cx + 30, (candleTop + candleBottom) / 2);
        }

        if (simCanvas) {
            simCanvas.addEventListener('click', (e) => {
                if (simStep !== 0) return;
                const rect = simCanvas.getBoundingClientRect(); const y = e.clientY - rect.top; const w = simCanvas.width;
                const bodyHeight = candleBottom - candleTop; const thresholdY = candleTop + (bodyHeight * 0.5);
                sCtx.beginPath(); sCtx.moveTo(0, y); sCtx.lineTo(w, y); sCtx.strokeStyle = 'blue'; sCtx.setLineDash([5, 5]); sCtx.lineWidth = 2; sCtx.stroke(); sCtx.setLineDash([]);
                const resultText = document.getElementById('simResult');
                if (y > thresholdY) {
                    sCtx.fillStyle = 'rgba(102, 187, 106, 0.3)'; sCtx.fillRect(0, y, w, simCanvas.height - y);
                    resultText.style.color = 'var(--success)'; resultText.innerText = "¡Excelente! Protegido por el 50% (Mean Threshold).";
                } else {
                    resultText.style.color = 'var(--danger-dark)'; resultText.innerText = "¡Peligroso! Tu Stop está dentro de la zona de 'ruido'.";
                }
                sCtx.beginPath(); sCtx.moveTo(0, thresholdY); sCtx.lineTo(w, thresholdY); sCtx.strokeStyle = '#00897b'; sCtx.lineWidth = 3; sCtx.stroke();
                sCtx.fillStyle = '#00897b'; sCtx.fillText("50% Threshold", 10, thresholdY - 5);
                simStep = 1;
            });
            setTimeout(resizeSim, 500);
        }

        function resetSimulation() { simStep = 0; document.getElementById('simResult').innerText = "Esperando..."; document.getElementById('simResult').style.color = "var(--dark-teal)"; resizeSim(); }

        /* ----------------------------------------------------------------
           FEATURE 1: Podcast Mode (TTS) - Robust
        ---------------------------------------------------------------- */
        async function playPodcastSummary() {
            const btn = document.getElementById('btnPodcast');
            const icon = btn.querySelector('i');
            const span = btn.querySelector('span');

            if (btn.classList.contains('playing')) return;

            const originalText = span.innerText;
            const originalIcon = icon.className;

            span.innerText = "Generando audio...";
            icon.className = "fas fa-spinner fa-spin";
            btn.disabled = true;

            const summaryText = "Bienvenido a KawnBit Magazine. En este capítulo sobre Bloques de Propulsión, aprendemos que son estructuras clave para operar en tendencias establecidas. A diferencia de un Order Block normal, el Bloque de Propulsión actúa como una segunda etapa de aceleración. La clave es entrar en el retroceso y colocar el Stop Loss justo por debajo del 50% del cuerpo de la vela. Recuerda: no persigas el precio, deja que el precio venga a ti.";

            try {
                const wavBlob = await callGeminiTTS(summaryText);

                if (wavBlob) {
                    const audioUrl = URL.createObjectURL(wavBlob);
                    const audio = new Audio(audioUrl);

                    span.innerText = "Reproduciendo...";
                    icon.className = "fas fa-volume-up";
                    btn.classList.add('playing');
                    btn.disabled = false; // Enable stop interaction if needed, or keep disabled

                    audio.play().catch(e => console.error("Audio Play Error:", e));

                    audio.onended = () => {
                        span.innerText = originalText;
                        icon.className = originalIcon;
                        btn.classList.remove('playing');
                    };
                } else {
                    throw new Error("No audio data");
                }
            } catch (e) {
                span.innerText = "Error (Reintentar)";
                icon.className = "fas fa-exclamation-triangle";
                console.error(e);
                setTimeout(() => {
                    span.innerText = originalText;
                    icon.className = originalIcon;
                    btn.disabled = false;
                }, 3000);
            }
        }

        /* ----------------------------------------------------------------
           FEATURE 2: Scenario Analyzer (Text Gen) - Robust
        ---------------------------------------------------------------- */
        async function analyzeSetup() {
            const input = document.getElementById('analyzerInput');
            const resultBox = document.getElementById('analyzerResult');
            const text = input.value.trim();

            if (!text) {
                resultBox.style.display = 'block';
                resultBox.className = 'analyzer-result error';
                resultBox.innerText = "Por favor, escribe un escenario antes de analizar.";
                setTimeout(() => { resultBox.style.display = 'none'; resultBox.className = 'analyzer-result'; }, 3000);
                return;
            }

            resultBox.style.display = 'block';
            resultBox.className = 'analyzer-result';
            resultBox.innerHTML = '<div class="ai-loading"></div> Analizando estructura de mercado...';

            const prompt = `Analiza el siguiente escenario de trading descrito por un estudiante de ICT/Smart Money Concepts. Valida si cumple con las reglas de un PROPULSION BLOCK (PB). Sé crítico.
        
        Escenario: "${text}"
        
        Responde en formato HTML simple (párrafos <p>). Si es válido, felicítalo. Si es arriesgado, explica por qué (ej: stop loss, liquidez previa, hora del día).`;

            try {
                const response = await callGemini(prompt, "Eres un mentor senior de trading institucional.");
                resultBox.innerHTML = response;
            } catch (e) {
                resultBox.innerHTML = "Error al conectar con el mentor. Inténtalo de nuevo.";
            }
        }

        /* ----------------------------------------------------------------
           FEATURE 3: Fractal Viewer (Interactive)
        ---------------------------------------------------------------- */
        const svgMacro = `
        <svg viewBox="0 0 400 200" width="100%" height="100%">
            <defs>
                <marker id="arr" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#444" /></marker>
            </defs>
            <text x="200" y="30" text-anchor="middle" font-weight="bold" fill="#005b4f">Temporalidad H1</text>
            <rect x="180" y="60" width="40" height="100" fill="#ef5350" stroke="#c62828" stroke-width="2"/>
            <line x1="200" y1="40" x2="200" y2="180" stroke="#c62828" stroke-width="1"/>
            <path d="M 50 150 L 180 150 L 220 150 L 350 40" fill="none" stroke="#263238" stroke-width="2" marker-end="url(#arr)" />
            <text x="50" y="140" font-size="12">Precio llega</text>
            <text x="350" y="30" font-size="12">Expansión</text>
            <text x="230" y="110" font-size="12" fill="#c62828">Vela bajista (PB)</text>
        </svg>
    `;

        const svgMicro = `
        <svg viewBox="0 0 400 200" width="100%" height="100%">
            <defs>
                <marker id="arr2" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#444" /></marker>
            </defs>
            <text x="200" y="30" text-anchor="middle" font-weight="bold" fill="#005b4f">Temporalidad M5 (Estructura Interna)</text>
            
            <!-- Structure -->
            <path d="M 20 150 L 80 140 L 120 160 L 160 130 L 200 170 L 240 100 L 280 120 L 380 20" 
                  fill="none" stroke="#263238" stroke-width="2" stroke-linejoin="round" marker-end="url(#arr2)"/>
            
            <!-- Key Points -->
            <circle cx="200" cy="170" r="4" fill="#e57373" />
            <text x="200" y="190" font-size="10" text-anchor="middle" fill="#c62828">Toma de Liquidez (Judas)</text>
            
            <line x1="160" y1="130" x2="260" y2="130" stroke="var(--primary-teal)" stroke-dasharray="2" />
            <text x="260" y="125" font-size="10" fill="var(--secondary-teal)">MSS (Cambio Estructura)</text>
            
            <rect x="180" y="50" width="40" height="120" fill="none" stroke="#ccc" stroke-dasharray="5,5" />
            <text x="185" y="65" font-size="10" fill="#999">Rango H1</text>
        </svg>
    `;

        function setFractalView(view) {
            const container = document.getElementById('fractalSvgContainer');
            const btns = document.querySelectorAll('.view-btn');
            if (!container) return;

            btns.forEach(b => b.classList.remove('active'));

            if (view === 'macro') {
                container.innerHTML = svgMacro;
                btns[0].classList.add('active');
            } else {
                container.innerHTML = svgMicro;
                btns[1].classList.add('active');
            }
        }
        // Init
        setFractalView('macro');

        /* ----------------------------------------------------------------
           FEATURE 4: Fib Projection (Interactive)
        ---------------------------------------------------------------- */
        function updateFibProjection(val) {
            // val is 0 to 100.
            // We map 0 -> base state, 100 -> full projection

            const path = document.getElementById('fibPricePath');
            const lines = document.getElementById('fibLines');
            const label = document.getElementById('fibValue');

            if (!path || !lines || !label) return;

            label.innerText = val + "%";

            // 0% = y: 225 (start of candle)
            // 100% = y: 125 (target +2.5 approx visual)

            const startY = 225;
            const startX = 115;

            // Calculate target X,Y based on linear interpolation
            const targetY = 225 - (100 * (val / 100)); // Moves up
            const targetX = 115 + (200 * (val / 100)); // Moves right

            path.setAttribute('d', `M ${startX} ${startY} L ${targetX} ${targetY}`);

            // Opacity of lines increases as we get closer
            lines.style.opacity = 0.2 + (0.8 * (val / 100));
        }


        /* ----------------------------------------------------------------
           Chat & Quiz (Robust)
        ---------------------------------------------------------------- */
        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            addMessage(msg, 'user');
            input.value = '';

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message ai';
            loadingDiv.innerHTML = '<div class="ai-loading"></div> Pensando...';
            document.getElementById('chat-messages').appendChild(loadingDiv);

            const systemPrompt = "Eres KawnBit, un mentor experto en trading institucional y conceptos ICT. Responde brevemente.";

            try {
                const aiResponse = await callGemini(msg, systemPrompt);
                loadingDiv.remove();
                addMessage(aiResponse, 'ai');
            } catch (e) {
                loadingDiv.remove();
                addMessage("Error de conexión. Inténtalo más tarde.", "error");
            }
        }

        function addMessage(text, type) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerText = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function generateAIQuiz() {
            const btn = document.querySelector('.btn-ai-gen');
            const originalText = btn.innerText;
            btn.innerHTML = '<div class="ai-loading" style="border-color:white; border-top-color:transparent;"></div> Generando...';
            btn.disabled = true;

            const prompt = `Genera un objeto JSON válido con una pregunta test sobre 'Propulsion Blocks'. Estructura ESTRICTA: {"question": "...", "options": ["A", "B", "C"], "correctIndex": 0, "explanation": "..."}. NO uses markdown.`;

            try {
                const rawData = await callGemini(prompt, "Solo JSON válido.");
                const quizData = extractAndParseJSON(rawData);

                if (!quizData) throw new Error("Invalid JSON");

                document.getElementById('quiz-question-text').innerText = quizData.question;
                const optionsDiv = document.getElementById('quiz-options');
                optionsDiv.innerHTML = '';

                quizData.options.forEach((opt, index) => {
                    const isCorrect = (index === quizData.correctIndex);
                    const feedbackText = isCorrect ? `¡Correcto! ${quizData.explanation}` : `Incorrecto. ${quizData.explanation}`;
                    const btnOption = document.createElement('button');
                    btnOption.className = 'quiz-option btn-interact';
                    btnOption.style.background = '#f5f5f5';
                    btnOption.style.color = 'var(--text-grey)';
                    btnOption.innerText = opt;

                    const safeFeedback = feedbackText.replace(/'/g, "\\'");
                    btnOption.onclick = function () { checkQuiz(this, isCorrect, safeFeedback); };
                    optionsDiv.appendChild(btnOption);
                });
                document.getElementById('quiz-feedback').style.display = 'none';
            } catch (e) {
                console.error(e);
                document.getElementById('quiz-feedback').style.display = 'block';
                document.getElementById('quiz-feedback').innerText = "Error al generar la pregunta. Intenta de nuevo.";
                document.getElementById('quiz-feedback').style.color = 'var(--danger)';
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        function checkQuiz(btn, isCorrect, feedbackText) {
            const fb = document.getElementById('quiz-feedback');
            document.querySelectorAll('.quiz-option').forEach(b => { b.style.background = '#f5f5f5'; b.disabled = true; });
            if (isCorrect) { btn.style.background = '#66bb6a'; btn.style.color = 'white'; fb.style.color = '#2e7d32'; }
            else { btn.style.background = '#ef5350'; btn.style.color = 'white'; fb.style.color = '#c62828'; }
            fb.style.display = 'block'; fb.innerHTML = feedbackText;
        }
    </script>

</body>

</html>